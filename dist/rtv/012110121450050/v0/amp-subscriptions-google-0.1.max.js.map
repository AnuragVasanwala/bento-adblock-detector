{
  "version": 3,
  "sources": ["../../src/core/data-structures/promise.js", "../../node_modules/web-activities/activity-ports.js", "../../src/core/types/object/index.js", "../../src/core/types/string/url.js", "../../src/core/window/interface.js", "../../src/core/types/array.js", "../../src/core/types/string/index.js", "../../src/core/types/object/json.js", "../../src/core/error/message-helpers.js", "../../src/core/mode/prod.js", "../../src/core/mode/test.js", "../../src/core/mode/local-dev.js", "../../src/core/mode/minified.js", "../../src/core/mode/version.js", "../../src/core/mode/esm.js", "../../src/config.js", "../../src/mode.js", "../../src/utils/log.js", "../../src/service-helpers.js", "../../src/core/window/index.js", "../../src/experiments/index.js", "../../third_party/css-escape/css-escape.js", "../../src/core/dom/index.js", "../../src/service/extension-script.js", "../../src/element-service.js", "../../src/service/index.js", "../../src/utils/event-helper.js", "../../third_party/subscriptions-project/swg.js", "../../third_party/subscriptions-project/swg-gaa.js", "../../build/amp-subscriptions-google-0.1.css.js", "../../src/style-installer.js", "../../src/core/data-structures/lru-cache.js", "../../src/url.js", "../../extensions/amp-subscriptions/0.1/analytics.js", "../../extensions/amp-subscriptions/0.1/constants.js", "../../third_party/subscriptions-project/config.js", "../../extensions/amp-subscriptions/0.1/doc-impl.js", "../../extensions/amp-subscriptions/0.1/entitlement.js", "../../extensions/amp-subscriptions/0.1/url-builder.js", "../../extensions/amp-subscriptions-google/0.1/amp-subscriptions-google.js"],
  "sourcesContent": ["let resolved;\n\n/**\n * Returns a cached resolved promise.\n * Babel converts direct calls to Promise.resolve() (with no arguments) into\n * calls to this.\n *\n * @return {!Promise<undefined>}\n */\nexport function resolvedPromise() {\n  if (resolved) {\n    return resolved;\n  }\n\n  // It's important that we call with `undefined` here, to prevent a transform\n  // recursion. If we didn't pass an arg, then the transformer would replace\n  // this callsite with a call to `resolvedPromise()`.\n  resolved = Promise.resolve(undefined);\n  return resolved;\n}\n\n/**\n * Returns a Deferred struct, which holds a pending promise and its associated\n * resolve and reject functions.\n *\n * This is preferred instead of creating a Promise instance to extract the\n * resolve/reject functions yourself:\n *\n * ```\n * // Avoid doing\n * let resolve;\n * const promise = new Promise(res => {\n *   resolve = res;\n * });\n *\n * // Good\n * const deferred = new Deferred();\n * const { promise, resolve } = deferred;\n * ```\n *\n * @template T\n */\nexport class Deferred {\n  /** Constructor. */\n  constructor() {\n    /** @const {!Promise<T>} */\n    this.promise = new /*OK*/ Promise((res, rej) => {\n      /** @const {function(T=)} */\n      this.resolve = res;\n      /** @const {function(*=)} */\n      this.reject = rej;\n    });\n  }\n}\n\n/**\n * Creates a promise resolved to the return value of fn.\n * If fn sync throws, it will cause the promise to reject.\n *\n * @param {function():T} fn\n * @return {!Promise<T>}\n * @template T\n */\nexport function tryResolve(fn) {\n  return new Promise((resolve) => {\n    resolve(fn());\n  });\n}\n\n/**\n * Resolves with the result of the last promise added.\n * @implements {IThenable}\n */\nexport class LastAddedResolver {\n  /**\n   * @param {!Array<!IThenable>=} opt_promises\n   */\n  constructor(opt_promises) {\n    /** @private @const {!Deferred} */\n    this.deferred_ = new Deferred();\n\n    /** @private */\n    this.count_ = 0;\n\n    if (opt_promises) {\n      for (const promise of opt_promises) {\n        this.add(promise);\n      }\n    }\n  }\n\n  /**\n   * Add a promise to possibly be resolved.\n   * @param {!IThenable} promise\n   * @return {!Promise}\n   */\n  add(promise) {\n    const countAtAdd = ++this.count_;\n    promise.then(\n      (result) => {\n        if (this.count_ === countAtAdd) {\n          this.deferred_.resolve(result);\n        }\n      },\n      (error) => {\n        // Don't follow behavior of Promise.all and Promise.race error so that\n        // this will only reject when most recently added promise fails.\n        if (this.count_ === countAtAdd) {\n          this.deferred_.reject(error);\n        }\n      }\n    );\n    return this.deferred_.promise;\n  }\n\n  /** @override */\n  then(opt_resolve, opt_reject) {\n    return this.deferred_.promise.then(opt_resolve, opt_reject);\n  }\n}\n", "/**\n * @license\n * Copyright 2017 The Web Activities Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n /** Version: 1.24 */\n'use strict';\n\n/*eslint no-unused-vars: 0*/\n\n\n/**\n * @enum {string}\n */\nconst ActivityMode = {\n  IFRAME: 'iframe',\n  POPUP: 'popup',\n  REDIRECT: 'redirect',\n};\n\n\n/**\n * The result code used for `ActivityResult`.\n * @enum {string}\n */\nconst ActivityResultCode = {\n  OK: 'ok',\n  CANCELED: 'canceled',\n  FAILED: 'failed',\n};\n\n\n/**\n * The result of an activity. The activity implementation returns this object\n * for a successful result, a cancelation or a failure.\n * @struct\n */\nclass ActivityResult {\n  /**\n   * @param {!ActivityResultCode} code\n   * @param {*} data\n   * @param {!ActivityMode} mode\n   * @param {string} origin\n   * @param {boolean} originVerified\n   * @param {boolean} secureChannel\n   */\n  constructor(code, data, mode, origin, originVerified, secureChannel) {\n    /** @const {!ActivityResultCode} */\n    this.code = code;\n    /** @const {*} */\n    this.data = code == ActivityResultCode.OK ? data : null;\n    /** @const {!ActivityMode} */\n    this.mode = mode;\n    /** @const {string} */\n    this.origin = origin;\n    /** @const {boolean} */\n    this.originVerified = originVerified;\n    /** @const {boolean} */\n    this.secureChannel = secureChannel;\n    /** @const {boolean} */\n    this.ok = code == ActivityResultCode.OK;\n    /** @const {?Error} */\n    this.error = code == ActivityResultCode.FAILED ?\n        new Error(String(data) || '') :\n        null;\n  }\n}\n\n\n/**\n * The activity request that different types of hosts can be started with.\n * @typedef {{\n *   requestId: string,\n *   returnUrl: string,\n *   args: ?Object,\n *   origin: (string|undefined),\n *   originVerified: (boolean|undefined),\n * }}\n */\nlet ActivityRequest;\n\n\n/**\n * The activity \"open\" options used for popups and redirects.\n *\n * - returnUrl: override the return URL. By default, the current URL will be\n *   used.\n * - skipRequestInUrl: removes the activity request from the URL, in case\n *   redirect is used. By default, the activity request is appended to the\n *   activity URL. This option can be used if the activity request is passed\n *   to the activity by some alternative means.\n * - disableRedirectFallback: disallows popup fallback to redirect. By default\n *   the redirect fallback is allowed. This option has to be used very carefully\n *   because there are many user agents that may fail to open a popup and it\n *   won't be always possible for the opener window to even be aware of such\n *   failures.\n *\n * @typedef {{\n *   returnUrl: (string|undefined),\n *   skipRequestInUrl: (boolean|undefined),\n *   disableRedirectFallback: (boolean|undefined),\n *   width: (number|undefined),\n *   height: (number|undefined),\n * }}\n */\nlet ActivityOpenOptions;\n\n\n/**\n * Activity client-side binding. The port provides limited ways to communicate\n * with the activity and receive signals and results from it. Not every type\n * of activity exposes a port.\n *\n * @interface\n */\nclass ActivityPort {\n\n  /**\n   * Returns the mode of the activity: iframe, popup or redirect.\n   * @return {!ActivityMode}\n   */\n  getMode() {}\n\n  /**\n   * Accepts the result when ready. The client should verify the activity's\n   * mode, origin, verification and secure channel flags before deciding\n   * whether or not to trust the result.\n   *\n   * Returns the promise that yields when the activity has been completed and\n   * either a result, a cancelation or a failure has been returned.\n   *\n   * @return {!Promise<!ActivityResult>}\n   */\n  acceptResult() {}\n}\n\n\n/**\n * Activity client-side binding for messaging.\n *\n * Whether the host can or cannot receive a message depends on the type of\n * host and its state. Ensure that the code has an alternative path if\n * messaging is not available.\n *\n * @interface\n */\nclass ActivityMessagingPort {\n\n  /**\n   * Returns the target window where host is loaded. May be unavailable.\n   * @return {?Window}\n   */\n  getTargetWin() {}\n\n  /**\n   * Sends a message to the host.\n   * @param {!Object} payload\n   */\n  message(payload) {}\n\n  /**\n   * Registers a callback to receive messages from the host.\n   * @param {function(!Object)} callback\n   */\n  onMessage(callback) {}\n\n  /**\n   * Creates a new communication channel or returns an existing one.\n   * @param {string=} opt_name\n   * @return {!Promise<!MessagePort>}\n   */\n  messageChannel(opt_name) {}\n}\n\n\n\n/** DOMException.ABORT_ERR name */\nconst ABORT_ERR_NAME = 'AbortError';\n\n/** DOMException.ABORT_ERR = 20 */\nconst ABORT_ERR_CODE = 20;\n\n/** @type {?HTMLAnchorElement} */\nlet aResolver;\n\n\n/**\n * @param {string} urlString\n * @return {!HTMLAnchorElement}\n */\nfunction parseUrl(urlString) {\n  if (!aResolver) {\n    aResolver = /** @type {!HTMLAnchorElement} */ (document.createElement('a'));\n  }\n  aResolver.href = urlString;\n  return /** @type {!HTMLAnchorElement} */ (aResolver);\n}\n\n\n/**\n * @param {!Location|!URL|!HTMLAnchorElement} loc\n * @return {string}\n */\nfunction getOrigin(loc) {\n  if (loc.origin) {\n    return loc.origin;\n  }\n  // Make sure that the origin is normalized. Specifically on IE, host sometimes\n  // includes the default port, which is not per standard.\n  const protocol = loc.protocol;\n  let host = loc.host;\n  if (protocol == 'https:' && host.indexOf(':443') == host.length - 4) {\n    host = host.replace(':443', '');\n  } else if (protocol == 'http:' && host.indexOf(':80') == host.length - 3) {\n    host = host.replace(':80', '');\n  }\n  return protocol + '//' + host;\n}\n\n\n/**\n * @param {string} urlString\n * @return {string}\n */\nfunction getOriginFromUrl(urlString) {\n  return getOrigin(parseUrl(urlString));\n}\n\n\n/**\n * @param {string} urlString\n * @return {string}\n */\nfunction removeFragment(urlString) {\n  const index = urlString.indexOf('#');\n  if (index == -1) {\n    return urlString;\n  }\n  return urlString.substring(0, index);\n}\n\n\n/**\n * Parses and builds Object of URL query string.\n * @param {string} query The URL query string.\n * @return {!Object<string, string>}\n */\nfunction parseQueryString(query) {\n  if (!query) {\n    return {};\n  }\n  return (/^[?#]/.test(query) ? query.slice(1) : query)\n      .split('&')\n      .reduce((params, param) => {\n        const item = param.split('=');\n        const key = decodeURIComponent(item[0] || '');\n        const value = decodeURIComponent(item[1] || '');\n        if (key) {\n          params[key] = value;\n        }\n        return params;\n      }, {});\n}\n\n\n/**\n * @param {string} queryString  A query string in the form of \"a=b&c=d\". Could\n *   be optionally prefixed with \"?\" or \"#\".\n * @param {string} param The param to get from the query string.\n * @return {?string}\n */\nfunction getQueryParam(queryString, param) {\n  return parseQueryString(queryString)[param];\n}\n\n\n/**\n * Add a query-like parameter to the fragment string.\n * @param {string} url\n * @param {string} param\n * @param {string} value\n * @return {string}\n */\nfunction addFragmentParam(url, param, value) {\n  return url +\n      (url.indexOf('#') == -1 ? '#' : '&') +\n      encodeURIComponent(param) + '=' + encodeURIComponent(value);\n}\n\n\n/**\n * @param {string} queryString  A query string in the form of \"a=b&c=d\". Could\n *   be optionally prefixed with \"?\" or \"#\".\n * @param {string} param The param to remove from the query string.\n * @return {?string}\n */\nfunction removeQueryParam(queryString, param) {\n  if (!queryString) {\n    return queryString;\n  }\n  const search = encodeURIComponent(param) + '=';\n  let index = -1;\n  do {\n    index = queryString.indexOf(search, index);\n    if (index != -1) {\n      const prev = index > 0 ? queryString.substring(index - 1, index) : '';\n      if (prev == '' || prev == '?' || prev == '#' || prev == '&') {\n        let end = queryString.indexOf('&', index + 1);\n        if (end == -1) {\n          end = queryString.length;\n        }\n        queryString =\n            queryString.substring(0, index) +\n            queryString.substring(end + 1);\n      } else {\n        index++;\n      }\n    }\n  } while (index != -1 && index < queryString.length);\n  return queryString;\n}\n\n\n/**\n * @param {!ActivityRequest} request\n * @return {string}\n */\nfunction serializeRequest(request) {\n  const map = {\n    'requestId': request.requestId,\n    'returnUrl': request.returnUrl,\n    'args': request.args,\n  };\n  if (request.origin !== undefined) {\n    map['origin'] = request.origin;\n  }\n  if (request.originVerified !== undefined) {\n    map['originVerified'] = request.originVerified;\n  }\n  return JSON.stringify(map);\n}\n\n\n/**\n * @param {*} error\n * @return {boolean}\n */\nfunction isAbortError(error) {\n  if (!error || typeof error != 'object') {\n    return false;\n  }\n  return (error['name'] === ABORT_ERR_NAME);\n}\n\n\n/**\n * Creates or emulates a DOMException of AbortError type.\n * See https://heycam.github.io/webidl/#aborterror.\n * @param {!Window} win\n * @param {string=} opt_message\n * @return {!DOMException}\n */\nfunction createAbortError(win, opt_message) {\n  const message = 'AbortError' + (opt_message ? ': ' + opt_message : '');\n  let error = null;\n  if (typeof win['DOMException'] == 'function') {\n    // TODO(dvoytenko): remove typecast once externs are fixed.\n    const constr = /** @type {function(new:DOMException, string, string)} */ (\n        win['DOMException']);\n    try {\n      error = new constr(message, ABORT_ERR_NAME);\n    } catch (e) {\n      // Ignore. In particular, `new DOMException()` fails in Edge.\n    }\n  }\n  if (!error) {\n    // TODO(dvoytenko): remove typecast once externs are fixed.\n    const constr = /** @type {function(new:DOMException, string)} */ (\n        Error);\n    error = new constr(message);\n    error.name = ABORT_ERR_NAME;\n    error.code = ABORT_ERR_CODE;\n  }\n  return error;\n}\n\n\n/**\n * Resolves the activity result as a promise:\n *  - `OK` result is yielded as the promise's payload;\n *  - `CANCEL` result is rejected with the `AbortError`;\n *  - `FAILED` result is rejected with the embedded error.\n *\n * @param {!Window} win\n * @param {!ActivityResult} result\n * @param {function((!ActivityResult|!Promise))} resolver\n */\nfunction resolveResult(win, result, resolver) {\n  if (result.ok) {\n    resolver(result);\n  } else {\n    const error = result.error || createAbortError(win);\n    error.activityResult = result;\n    resolver(Promise.reject(error));\n  }\n}\n\n\n/**\n * @param {!Window} win\n * @return {boolean}\n */\nfunction isIeBrowser(win) {\n  // MSIE and Trident are typical user agents for IE browsers.\n  const nav = win.navigator;\n  return /Trident|MSIE|IEMobile/i.test(nav && nav.userAgent);\n}\n\n\n/**\n * @param {!Window} win\n * @return {boolean}\n */\nfunction isEdgeBrowser(win) {\n  const nav = win.navigator;\n  return /Edge/i.test(nav && nav.userAgent);\n}\n\n\n/**\n * @param {!Error} e\n */\nfunction throwAsync(e) {\n  setTimeout(() => {throw e;});\n}\n\n\n/**\n * Polyfill of the `Node.isConnected` API. See\n * https://developer.mozilla.org/en-US/docs/Web/API/Node/isConnected.\n * @param {!Node} node\n * @return {boolean}\n */\nfunction isNodeConnected(node) {\n  // Ensure that node is attached if specified. This check uses a new and\n  // fast `isConnected` API and thus only checked on platforms that have it.\n  // See https://www.chromestatus.com/feature/5676110549352448.\n  if ('isConnected' in node) {\n    return node['isConnected'];\n  }\n  // Polyfill.\n  const root = node.ownerDocument && node.ownerDocument.documentElement;\n  return (root && root.contains(node)) || false;\n}\n\n\n\nconst SENTINEL = '__ACTIVITIES__';\n\n\n/**\n * The messenger helper for activity's port and host.\n */\nclass Messenger {\n\n  /**\n   * @param {!Window} win\n   * @param {!Window|function():?Window} targetOrCallback\n   * @param {?string} targetOrigin\n   * @param {boolean} requireTarget\n   */\n  constructor(win, targetOrCallback, targetOrigin, requireTarget) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private @const {!Window|function():?Window} */\n    this.targetOrCallback_ = targetOrCallback;\n\n    /**\n     * May start as unknown (`null`) until received in the first message.\n     * @private {?string}\n     */\n    this.targetOrigin_ = targetOrigin;\n\n    /** @private @const {boolean} */\n    this.requireTarget_ = requireTarget;\n\n    /** @private {?Window} */\n    this.target_ = null;\n\n    /** @private {boolean} */\n    this.acceptsChannel_ = false;\n\n    /** @private {?MessagePort} */\n    this.port_ = null;\n\n    /** @private {?function(string, ?Object)} */\n    this.onCommand_ = null;\n\n    /** @private {?function(!Object)} */\n    this.onCustomMessage_ = null;\n\n    /**\n     * @private {?Object<string, !ChannelHolder>}\n     */\n    this.channels_ = null;\n\n    /** @private @const */\n    this.boundHandleEvent_ = this.handleEvent_.bind(this);\n  }\n\n  /**\n   * Connect the port to the host or vice versa.\n   * @param {function(string, ?Object)} onCommand\n   */\n  connect(onCommand) {\n    if (this.onCommand_) {\n      throw new Error('already connected');\n    }\n    this.onCommand_ = onCommand;\n    this.win_.addEventListener('message', this.boundHandleEvent_);\n  }\n\n  /**\n   * Disconnect messenger.\n   */\n  disconnect() {\n    if (this.onCommand_) {\n      this.onCommand_ = null;\n      if (this.port_) {\n        closePort(this.port_);\n        this.port_ = null;\n      }\n      this.win_.removeEventListener('message', this.boundHandleEvent_);\n      if (this.channels_) {\n        for (const k in this.channels_) {\n          const channelObj = this.channels_[k];\n          if (channelObj.port1) {\n            closePort(channelObj.port1);\n          }\n          if (channelObj.port2) {\n            closePort(channelObj.port2);\n          }\n        }\n        this.channels_ = null;\n      }\n    }\n  }\n\n  /**\n   * Returns whether the messenger has been connected already.\n   * @return {boolean}\n   */\n  isConnected() {\n    return this.targetOrigin_ != null;\n  }\n\n  /**\n   * Returns the messaging target. Only available when connection has been\n   * establihsed.\n   * @return {!Window}\n   */\n  getTarget() {\n    const target = this.getOptionalTarget_();\n    if (!target) {\n      throw new Error('not connected');\n    }\n    return target;\n  }\n\n  /**\n   * @return {?Window}\n   * @private\n   */\n  getOptionalTarget_() {\n    if (this.onCommand_ && !this.target_) {\n      if (typeof this.targetOrCallback_ == 'function') {\n        this.target_ = this.targetOrCallback_();\n      } else {\n        this.target_ = /** @type {!Window} */ (this.targetOrCallback_);\n      }\n    }\n    return this.target_;\n  }\n\n  /**\n   * Returns the messaging origin. Only available when connection has been\n   * establihsed.\n   * @return {string}\n   */\n  getTargetOrigin() {\n    if (this.targetOrigin_ == null) {\n      throw new Error('not connected');\n    }\n    return this.targetOrigin_;\n  }\n\n  /**\n   * The host sends this message to the client to indicate that it's ready to\n   * start communicating. The client is expected to respond back with the\n   * \"start\" command. See `sendStartCommand` method.\n   */\n  sendConnectCommand() {\n    // TODO(dvoytenko): MessageChannel is critically necessary for IE/Edge,\n    // since window messaging doesn't always work. It's also preferred as an API\n    // for other browsers: it's newer, cleaner and arguably more secure.\n    // Unfortunately, browsers currently do not propagate user gestures via\n    // MessageChannel, only via window messaging. This should be re-enabled\n    // once browsers fix user gesture propagation.\n    // See:\n    // Safari: https://bugs.webkit.org/show_bug.cgi?id=186593\n    // Chrome: https://bugs.chromium.org/p/chromium/issues/detail?id=851493\n    // Firefox: https://bugzilla.mozilla.org/show_bug.cgi?id=1469422\n    const acceptsChannel = isIeBrowser(this.win_) || isEdgeBrowser(this.win_);\n    this.sendCommand('connect', {'acceptsChannel': acceptsChannel});\n  }\n\n  /**\n   * The client sends this message to the host upon receiving the \"connect\"\n   * message to start the main communication channel. As a payload, the message\n   * will contain the provided start arguments.\n   * @param {?Object} args\n   */\n  sendStartCommand(args) {\n    let channel = null;\n    if (this.acceptsChannel_ && typeof this.win_.MessageChannel == 'function') {\n      channel = new this.win_.MessageChannel();\n    }\n    if (channel) {\n      this.sendCommand('start', args, [channel.port2]);\n      // It's critical to switch to port messaging only after \"start\" has been\n      // sent. Otherwise, it won't be delivered.\n      this.switchToChannel_(channel.port1);\n    } else {\n      this.sendCommand('start', args);\n    }\n  }\n\n  /**\n   * Sends the specified command from the port to the host or vice versa.\n   * @param {string} cmd\n   * @param {?Object=} opt_payload\n   * @param {?Array=} opt_transfer\n   */\n  sendCommand(cmd, opt_payload, opt_transfer) {\n    const data = {\n      'sentinel': SENTINEL,\n      'cmd': cmd,\n      'payload': opt_payload || null,\n    };\n    if (this.port_) {\n      this.port_.postMessage(data, opt_transfer || undefined);\n    } else {\n      const target = this.getTarget();\n      // Only \"connect\" command is allowed to use `targetOrigin == '*'`\n      const targetOrigin =\n          cmd == 'connect' ?\n          (this.targetOrigin_ != null ? this.targetOrigin_ : '*') :\n          this.getTargetOrigin();\n      target.postMessage(data, targetOrigin, opt_transfer || undefined);\n    }\n  }\n\n  /**\n   * Sends a message to the client.\n   * @param {!Object} payload\n   */\n  customMessage(payload) {\n    this.sendCommand('msg', payload);\n  }\n\n  /**\n   * Registers a callback to receive messages from the client.\n   * @param {function(!Object)} callback\n   */\n  onCustomMessage(callback) {\n    this.onCustomMessage_ = callback;\n  }\n\n  /**\n   * @param {string=} opt_name\n   * @return {!Promise<!MessagePort>}\n   */\n  startChannel(opt_name) {\n    const name = opt_name || '';\n    const channelObj = this.getChannelObj_(name);\n    if (!channelObj.port1) {\n      const channel = new this.win_.MessageChannel();\n      channelObj.port1 = channel.port1;\n      channelObj.port2 = channel.port2;\n      channelObj.resolver(channelObj.port1);\n    }\n    if (channelObj.port2) {\n      // Not yet sent.\n      this.sendCommand('cnset', {'name': name}, [channelObj.port2]);\n      channelObj.port2 = null;\n    }\n    return channelObj.promise;\n  }\n\n  /**\n   * @param {string=} opt_name\n   * @return {!Promise<!MessagePort>}\n   */\n  askChannel(opt_name) {\n    const name = opt_name || '';\n    const channelObj = this.getChannelObj_(name);\n    if (!channelObj.port1) {\n      this.sendCommand('cnget', {'name': name});\n    }\n    return channelObj.promise;\n  }\n\n  /**\n   * @param {string} name\n   * @param {!MessagePort} port\n   * @private\n   */\n  receiveChannel_(name, port) {\n    const channelObj = this.getChannelObj_(name);\n    channelObj.port1 = port;\n    channelObj.resolver(port);\n  }\n\n  /**\n   * @param {string} name\n   * @return {!ChannelHolder}\n   */\n  getChannelObj_(name) {\n    if (!this.channels_) {\n      this.channels_ = {};\n    }\n    let channelObj = this.channels_[name];\n    if (!channelObj) {\n      let resolver;\n      const promise = new Promise(resolve => {\n        resolver = resolve;\n      });\n      channelObj = {\n        port1: null,\n        port2: null,\n        resolver,\n        promise,\n      };\n      this.channels_[name] = channelObj;\n    }\n    return channelObj;\n  }\n\n  /**\n   * @param {!MessagePort} port\n   * @private\n   */\n  switchToChannel_(port) {\n    if (this.port_) {\n      closePort(this.port_);\n    }\n    this.port_ = port;\n    this.port_.onmessage = event => {\n      const data = event.data;\n      const cmd = data && data['cmd'];\n      const payload = data && data['payload'] || null;\n      if (cmd) {\n        this.handleCommand_(cmd, payload, event);\n      }\n    };\n    // Even though all messaging will switch to ports, the window-based message\n    // listener will be preserved just in case the host is refreshed and needs\n    // another connection.\n  }\n\n  /**\n   * @param {!MessageEvent} event\n   * @private\n   */\n  handleEvent_(event) {\n    if (this.requireTarget_ && this.getOptionalTarget_() != event.source) {\n      // When target is required, confirm it against the event.source. This\n      // is normally only needed for ports where a single window can include\n      // multiple iframes to match the event to a specific iframe. Otherwise,\n      // the origin checks below are sufficient.\n      return;\n    }\n    const data = event.data;\n    if (!data || data['sentinel'] != SENTINEL) {\n      return;\n    }\n    const cmd = data['cmd'];\n    if (this.port_ && cmd != 'connect' && cmd != 'start') {\n      // Messaging channel has already taken over. However, the \"connect\" and\n      // \"start\" commands are allowed to proceed in case re-connection is\n      // requested.\n      return;\n    }\n    const origin = /** @type {string} */ (event.origin);\n    const payload = data['payload'] || null;\n    if (this.targetOrigin_ == null && cmd == 'start') {\n      this.targetOrigin_ = origin;\n    }\n    if (this.targetOrigin_ == null && event.source) {\n      if (this.getOptionalTarget_() == event.source) {\n        this.targetOrigin_ = origin;\n      }\n    }\n    // Notice that event.source may differ from the target because of\n    // friendly-iframe intermediaries.\n    if (origin != this.targetOrigin_) {\n      return;\n    }\n    this.handleCommand_(cmd, payload, event);\n  }\n\n  /**\n   * @param {string} cmd\n   * @param {?Object} payload\n   * @param {!MessageEvent} event\n   * @private\n   */\n  handleCommand_(cmd, payload, event) {\n    if (cmd == 'connect') {\n      if (this.port_) {\n        // In case the port has already been open - close it to reopen it\n        // again later.\n        closePort(this.port_);\n        this.port_ = null;\n      }\n      this.acceptsChannel_ = payload && payload['acceptsChannel'] || false;\n      this.onCommand_(cmd, payload);\n    } else if (cmd == 'start') {\n      const port = event.ports && event.ports[0];\n      if (port) {\n        this.switchToChannel_(port);\n      }\n      this.onCommand_(cmd, payload);\n    } else if (cmd == 'msg') {\n      if (this.onCustomMessage_ != null && payload != null) {\n        this.onCustomMessage_(payload);\n      }\n    } else if (cmd == 'cnget') {\n      const name = payload['name'];\n      this.startChannel(name);\n    } else if (cmd == 'cnset') {\n      const name = payload['name'];\n      const port = event.ports[0];\n      this.receiveChannel_(name, /** @type {!MessagePort} */ (port));\n    } else {\n      this.onCommand_(cmd, payload);\n    }\n  }\n}\n\n\n/**\n * @param {!MessagePort} port\n */\nfunction closePort(port) {\n  try {\n    port.close();\n  } catch (e) {\n    // Ignore.\n  }\n}\n\n\n\n\n/**\n * The `ActivityPort` implementation for the iframe case. Unlike other types\n * of activities, iframe-based activities are always connected and can react\n * to size requests.\n *\n * @implements {ActivityPort}\n * @implements {ActivityMessagingPort}\n */\nclass ActivityIframePort {\n\n  /**\n   * @param {!HTMLIFrameElement} iframe\n   * @param {string} url\n   * @param {?Object=} opt_args\n   */\n  constructor(iframe, url, opt_args) {\n    /** @private @const {!HTMLIFrameElement} */\n    this.iframe_ = iframe;\n    /** @private @const {string} */\n    this.url_ = url;\n    /** @private @const {?Object} */\n    this.args_ = opt_args || null;\n\n    /** @private @const {!Window} */\n    this.win_ = /** @type {!Window} */ (this.iframe_.ownerDocument.defaultView);\n\n    /** @private @const {string} */\n    this.targetOrigin_ = getOriginFromUrl(url);\n\n    /** @private {boolean} */\n    this.connected_ = false;\n\n    /** @private {?function()} */\n    this.connectedResolver_ = null;\n\n    /** @private @const {!Promise} */\n    this.connectedPromise_ = new Promise(resolve => {\n      this.connectedResolver_ = resolve;\n    });\n\n    /** @private {?function()} */\n    this.readyResolver_ = null;\n\n    /** @private @const {!Promise} */\n    this.readyPromise_ = new Promise(resolve => {\n      this.readyResolver_ = resolve;\n    });\n\n    /** @private {?function((!ActivityResult|!Promise))} */\n    this.resultResolver_ = null;\n\n    /** @private @const {!Promise<!ActivityResult>} */\n    this.resultPromise_ = new Promise(resolve => {\n      this.resultResolver_ = resolve;\n    });\n\n    /** @private {?function(number)} */\n    this.onResizeRequest_ = null;\n\n    /** @private {?number} */\n    this.requestedHeight_ = null;\n\n    /** @private @const {!Messenger} */\n    this.messenger_ = new Messenger(\n        this.win_,\n        () => this.iframe_.contentWindow,\n        this.targetOrigin_,\n        /* requireTarget */ true);\n  }\n\n  /** @override */\n  getMode() {\n    return ActivityMode.IFRAME;\n  }\n\n  /**\n   * Waits until the activity port is connected to the host.\n   * @return {!Promise}\n   */\n  connect() {\n    if (!isNodeConnected(this.iframe_)) {\n      throw new Error('iframe must be in DOM');\n    }\n    this.messenger_.connect(this.handleCommand_.bind(this));\n    this.iframe_.src = this.url_;\n    return this.connectedPromise_;\n  }\n\n  /**\n   * Disconnect the activity binding and cleanup listeners.\n   */\n  disconnect() {\n    this.connected_ = false;\n    this.messenger_.disconnect();\n  }\n\n  /** @override */\n  acceptResult() {\n    return this.resultPromise_;\n  }\n\n  /** @override */\n  getTargetWin() {\n    return this.iframe_.contentWindow || null;\n  }\n\n  /** @override */\n  message(payload) {\n    this.messenger_.customMessage(payload);\n  }\n\n  /** @override */\n  onMessage(callback) {\n    this.messenger_.onCustomMessage(callback);\n  }\n\n  /** @override */\n  messageChannel(opt_name) {\n    return this.messenger_.askChannel(opt_name);\n  }\n\n  /**\n   * Returns a promise that yields when the iframe is ready to be interacted\n   * with.\n   * @return {!Promise}\n   */\n  whenReady() {\n    return this.readyPromise_;\n  }\n\n  /**\n   * Register a callback to handle resize requests. Once successfully resized,\n   * ensure to call `resized()` method.\n   * @param {function(number)} callback\n   */\n  onResizeRequest(callback) {\n    this.onResizeRequest_ = callback;\n    Promise.resolve().then(() => {\n      if (this.requestedHeight_ != null) {\n        callback(this.requestedHeight_);\n      }\n    });\n  }\n\n  /**\n   * Signals back to the activity implementation that the client has updated\n   * the activity's size.\n   */\n  resized() {\n    if (!this.connected_) {\n      return;\n    }\n    const height = this.iframe_.offsetHeight;\n    this.messenger_.sendCommand('resized', {'height': height});\n  }\n\n  /**\n   * @param {string} cmd\n   * @param {?Object} payload\n   * @private\n   */\n  handleCommand_(cmd, payload) {\n    if (cmd == 'connect') {\n      // First ever message. Indicates that the receiver is listening.\n      this.connected_ = true;\n      this.messenger_.sendStartCommand(this.args_);\n      this.connectedResolver_();\n    } else if (cmd == 'result') {\n      // The last message. Indicates that the result has been received.\n      if (this.resultResolver_) {\n        const code = /** @type {!ActivityResultCode} */ (payload['code']);\n        const data =\n            code == ActivityResultCode.FAILED ?\n            new Error(payload['data'] || '') :\n            payload['data'];\n        const result = new ActivityResult(\n            code,\n            data,\n            ActivityMode.IFRAME,\n            this.messenger_.getTargetOrigin(),\n            /* originVerified */ true,\n            /* secureChannel */ true);\n        resolveResult(this.win_, result, this.resultResolver_);\n        this.resultResolver_ = null;\n        this.messenger_.sendCommand('close');\n        this.disconnect();\n      }\n    } else if (cmd == 'ready') {\n      if (this.readyResolver_) {\n        this.readyResolver_();\n        this.readyResolver_ = null;\n      }\n    } else if (cmd == 'resize') {\n      this.requestedHeight_ = /** @type {number} */ (payload['height']);\n      if (this.onResizeRequest_) {\n        this.onResizeRequest_(this.requestedHeight_);\n      }\n    }\n  }\n}\n\n\n\n\n/**\n * The `ActivityPort` implementation for the standalone window activity\n * client executed as a popup.\n *\n * @implements {ActivityPort}\n * @implements {ActivityMessagingPort}\n */\nclass ActivityWindowPort {\n\n  /**\n   * @param {!Window} win\n   * @param {string} requestId\n   * @param {string} url\n   * @param {string} target\n   * @param {?Object=} opt_args\n   * @param {?ActivityOpenOptions=} opt_options\n   */\n  constructor(win, requestId, url, target, opt_args, opt_options) {\n    const isValidTarget =\n        target &&\n        (target == '_blank' || target == '_top' || target[0] != '_');\n    if (!isValidTarget) {\n      throw new Error('The only allowed targets are \"_blank\", \"_top\"' +\n          ' and name targets');\n    }\n\n    /** @private @const {!Window} */\n    this.win_ = win;\n    /** @private @const {string} */\n    this.requestId_ = requestId;\n    /** @private @const {string} */\n    this.url_ = url;\n    /** @private @const {string} */\n    this.openTarget_ = target;\n    /** @private @const {?Object} */\n    this.args_ = opt_args || null;\n    /** @private @const {!ActivityOpenOptions} */\n    this.options_ = opt_options || {};\n\n    /** @private {?function()} */\n    this.connectedResolver_ = null;\n\n    /** @private @const {!Promise} */\n    this.connectedPromise_ = new Promise(resolve => {\n      this.connectedResolver_ = resolve;\n    });\n\n    /** @private {?function((!ActivityResult|!Promise))} */\n    this.resultResolver_ = null;\n\n    /** @private @const {!Promise<!ActivityResult>} */\n    this.resultPromise_ = new Promise(resolve => {\n      this.resultResolver_ = resolve;\n    });\n\n    /** @private {?Window} */\n    this.targetWin_ = null;\n\n    /** @private {?number} */\n    this.heartbeatInterval_ = null;\n\n    /** @private {?Messenger} */\n    this.messenger_ = null;\n  }\n\n  /** @override */\n  getMode() {\n    return this.openTarget_ == '_top' ?\n        ActivityMode.REDIRECT :\n        ActivityMode.POPUP;\n  }\n\n  /**\n   * Opens the activity in a window, either as a popup or via redirect.\n   *\n   * Returns the promise that will yield when the window returns or closed.\n   * Notice, that this promise may never complete if \"redirect\" mode was used.\n   *\n   * @return {!Promise}\n   */\n  open() {\n    return this.openInternal_();\n  }\n\n  /**\n   * Waits until the activity port is connected to the host.\n   * @return {!Promise}\n   */\n  whenConnected() {\n    return this.connectedPromise_;\n  }\n\n  /**\n   * Disconnect the activity binding and cleanup listeners.\n   */\n  disconnect() {\n    if (this.heartbeatInterval_) {\n      this.win_.clearInterval(this.heartbeatInterval_);\n      this.heartbeatInterval_ = null;\n    }\n    if (this.messenger_) {\n      this.messenger_.disconnect();\n      this.messenger_ = null;\n    }\n    if (this.targetWin_) {\n      // Try to close the popup window. The host will also try to do the same.\n      try {\n        this.targetWin_.close();\n      } catch (e) {\n        // Ignore.\n      }\n      this.targetWin_ = null;\n    }\n    this.resultResolver_ = null;\n  }\n\n  /** @override */\n  getTargetWin() {\n    return this.targetWin_;\n  }\n\n  /** @override */\n  acceptResult() {\n    return this.resultPromise_;\n  }\n\n  /**\n   * Sends a message to the host.\n   * Whether the host can or cannot receive a message depends on the type of\n   * host and its state. Ensure that the code has an alternative path if\n   * messaging is not available.\n   * @override\n   */\n  message(payload) {\n    this.messenger_.customMessage(payload);\n  }\n\n  /**\n   * Registers a callback to receive messages from the host.\n   * Whether the host can or cannot receive a message depends on the type of\n   * host and its state. Ensure that the code has an alternative path if\n   * messaging is not available.\n   * @override\n   */\n  onMessage(callback) {\n    this.messenger_.onCustomMessage(callback);\n  }\n\n  /**\n   * Creates a new communication channel or returns an existing one.\n   * Whether the host can or cannot receive a message depends on the type of\n   * host and its state. Ensure that the code has an alternative path if\n   * messaging is not available.\n   * @override\n   */\n  messageChannel(opt_name) {\n    return this.messenger_.askChannel(opt_name);\n  }\n\n  /**\n   * This method wraps around window's open method. It first tries to execute\n   * `open` call with the provided target and if it fails, it retries the call\n   * with the `_top` target. This is necessary given that in some embedding\n   * scenarios, such as iOS' WKWebView, navigation to `_blank` and other targets\n   * is blocked by default.\n   * @return {!Promise}\n   * @private\n   */\n  openInternal_() {\n    const featuresStr = this.buildFeatures_();\n\n    // Protectively, the URL will contain the request payload, unless explicitly\n    // directed not to via `skipRequestInUrl` option.\n    let url = this.url_;\n    if (!this.options_.skipRequestInUrl) {\n      const returnUrl =\n          this.options_.returnUrl ||\n          removeFragment(this.win_.location.href);\n      const requestString = serializeRequest({\n        requestId: this.requestId_,\n        returnUrl,\n        args: this.args_,\n      });\n      url = addFragmentParam(url, '__WA__', requestString);\n    }\n\n    // Open the window.\n    let targetWin;\n    let openTarget = this.openTarget_;\n    // IE does not support CORS popups - the popup has to fallback to redirect\n    // mode.\n    if (openTarget != '_top') {\n      if (isIeBrowser(this.win_)) {\n        openTarget = '_top';\n      }\n    }\n    // Try first with the specified target. If we're inside the WKWebView or\n    // a similar environments, this method is expected to fail by default for\n    // all targets except `_top`.\n    try {\n      targetWin = this.win_.open(url, openTarget, featuresStr);\n    } catch (e) {\n      // Ignore.\n    }\n    // Then try with `_top` target.\n    if (!targetWin &&\n        openTarget != '_top' &&\n        !this.options_.disableRedirectFallback) {\n      openTarget = '_top';\n      try {\n        targetWin = this.win_.open(url, openTarget);\n      } catch (e) {\n        // Ignore.\n      }\n    }\n\n    // Setup the target window.\n    if (targetWin) {\n      this.targetWin_ = targetWin;\n      if (openTarget != '_top') {\n        this.setupPopup_();\n      }\n    } else {\n      this.disconnectWithError_(new Error('failed to open window'));\n    }\n\n    // Return result promise, even though it may never complete.\n    return this.resultPromise_.catch(() => {\n      // Ignore. Call to the `acceptResult()` should fail if needed.\n    });\n  }\n\n  /**\n   * @return {string}\n   * @private\n   */\n  buildFeatures_() {\n    // The max width and heights are calculated as following:\n    // MaxSize = AvailSize - ControlsSize\n    // ControlsSize = OuterSize - InnerSize\n    const screen = this.win_.screen;\n    const availWidth = screen.availWidth || screen.width;\n    const availHeight = screen.availHeight || screen.height;\n    const isTop = this.isTopWindow_();\n    const isEdge = isEdgeBrowser(this.win_);\n    // Limit controls to 100px width and height. Notice that it's only\n    // possible to calculate controls size in the top window, not in iframes.\n    // Notice that the Edge behavior is somewhat unique. If we can't find the\n    // right width/height, it will launch in the full-screen. Other browsers\n    // deal with such cases more gracefully.\n    const controlsWidth =\n        isTop && this.win_.outerWidth > this.win_.innerWidth ?\n        Math.min(100, this.win_.outerWidth - this.win_.innerWidth) :\n        (isEdge ? 100 : 0);\n    const controlsHeight =\n        isTop && this.win_.outerHeight > this.win_.innerHeight ?\n        Math.min(100, this.win_.outerHeight - this.win_.innerHeight) :\n        (isEdge ? 100 : 0);\n    // With all the adjustments, at least 50% of the available width/height\n    // should be made available to a popup.\n    const maxWidth = Math.max(availWidth - controlsWidth, availWidth * 0.5);\n    const maxHeight = Math.max(availHeight - controlsHeight, availHeight * 0.5);\n    let w = Math.floor(Math.min(600, maxWidth * 0.9));\n    let h = Math.floor(Math.min(600, maxHeight * 0.9));\n    if (this.options_.width) {\n      w = Math.min(this.options_.width, maxWidth);\n    }\n    if (this.options_.height) {\n      h = Math.min(this.options_.height, maxHeight);\n    }\n    const x = Math.floor((screen.width - w) / 2);\n    const y = Math.floor((screen.height - h) / 2);\n    const features = {\n      'height': h,\n      'width': w,\n      'resizable': 'yes',\n      'scrollbars': 'yes',\n    };\n    // Do not set left/top in Edge: it fails.\n    if (!isEdge) {\n      features['left'] = x;\n      features['top'] = y;\n    }\n    let featuresStr = '';\n    for (const f in features) {\n      if (featuresStr) {\n        featuresStr += ',';\n      }\n      featuresStr += `${f}=${features[f]}`;\n    }\n    return featuresStr;\n  }\n\n  /**\n   * This method only exists to make iframe/top emulation possible in tests.\n   * Otherwise `window.top` cannot be overridden.\n   * @return {boolean}\n   * @private\n   */\n  isTopWindow_() {\n    return this.win_ == this.win_.top;\n  }\n\n  /** @private */\n  setupPopup_() {\n    // Keep alive to catch the window closing, which would indicate\n    // \"cancel\" signal.\n    this.heartbeatInterval_ = this.win_.setInterval(() => {\n      this.check_(/* delayCancel */ true);\n    }, 500);\n\n    // Start up messaging. The messaging is explicitly allowed to proceed\n    // without origin check b/c all arguments have already been passed in\n    // the URL and special handling is enforced when result is delivered.\n    this.messenger_ = new Messenger(\n        this.win_,\n        /** @type {!Window} */ (this.targetWin_),\n        /* targetOrigin */ null,\n        /* requireTarget */ true);\n    this.messenger_.connect(this.handleCommand_.bind(this));\n  }\n\n  /**\n   * @param {boolean=} opt_delayCancel\n   * @private\n   */\n  check_(opt_delayCancel) {\n    if (!this.targetWin_ || this.targetWin_.closed) {\n      if (this.heartbeatInterval_) {\n        this.win_.clearInterval(this.heartbeatInterval_);\n        this.heartbeatInterval_ = null;\n      }\n      // Give a chance for the result to arrive, but otherwise consider the\n      // responce to be empty.\n      this.win_.setTimeout(() => {\n        try {\n          this.result_(ActivityResultCode.CANCELED, /* data */ null);\n        } catch (e) {\n          this.disconnectWithError_(e);\n        }\n      }, opt_delayCancel ? 3000 : 0);\n    }\n  }\n\n  /**\n   * @param {!Error} reason\n   * @private\n   */\n  disconnectWithError_(reason) {\n    if (this.resultResolver_) {\n      this.resultResolver_(Promise.reject(reason));\n    }\n    this.disconnect();\n  }\n\n  /**\n   * @param {!ActivityResultCode} code\n   * @param {*} data\n   * @private\n   */\n  result_(code, data) {\n    if (this.resultResolver_) {\n      const isConnected = this.messenger_.isConnected();\n      const result = new ActivityResult(\n          code,\n          data,\n          ActivityMode.POPUP,\n          isConnected ?\n              this.messenger_.getTargetOrigin() :\n              getOriginFromUrl(this.url_),\n          /* originVerified */ isConnected,\n          /* secureChannel */ isConnected);\n      resolveResult(this.win_, result, this.resultResolver_);\n      this.resultResolver_ = null;\n    }\n    if (this.messenger_) {\n      this.messenger_.sendCommand('close');\n    }\n    this.disconnect();\n  }\n\n  /**\n   * @param {string} cmd\n   * @param {?Object} payload\n   * @private\n   */\n  handleCommand_(cmd, payload) {\n    if (cmd == 'connect') {\n      // First ever message. Indicates that the receiver is listening.\n      this.messenger_.sendStartCommand(this.args_);\n      this.connectedResolver_();\n    } else if (cmd == 'result') {\n      // The last message. Indicates that the result has been received.\n      const code = /** @type {!ActivityResultCode} */ (payload['code']);\n      const data =\n          code == ActivityResultCode.FAILED ?\n          new Error(payload['data'] || '') :\n          payload['data'];\n      this.result_(code, data);\n    } else if (cmd == 'check') {\n      this.win_.setTimeout(() => this.check_(), 200);\n    }\n  }\n}\n\n\n/**\n * @param {!Window} win\n * @param {string} fragment\n * @param {string} requestId\n * @return {?ActivityPort}\n */\nfunction discoverRedirectPort(win, fragment, requestId) {\n  // Try to find the result in the fragment.\n  const paramName = '__WA_RES__';\n  const fragmentParam = getQueryParam(fragment, paramName);\n  if (!fragmentParam) {\n    return null;\n  }\n  const response = /** @type {?Object} */ (JSON.parse(fragmentParam));\n  if (!response || response['requestId'] != requestId) {\n    return null;\n  }\n\n  // Remove the found param from the fragment.\n  const cleanFragment = removeQueryParam(win.location.hash, paramName) || '';\n  if (cleanFragment != win.location.hash) {\n    if (win.history && win.history.replaceState) {\n      try {\n        win.history.replaceState(win.history.state, '', cleanFragment);\n      } catch (e) {\n        // Ignore.\n      }\n    }\n  }\n\n  const code = response['code'];\n  const data = response['data'];\n  const origin = response['origin'];\n  const referrerOrigin = win.document.referrer &&\n      getOriginFromUrl(win.document.referrer);\n  const originVerified = origin == referrerOrigin;\n  return new ActivityWindowRedirectPort(\n      win,\n      code,\n      data,\n      origin,\n      originVerified);\n}\n\n\n/**\n * The `ActivityPort` implementation for the standalone window activity\n * client executed as a popup.\n *\n * @implements {ActivityPort}\n */\nclass ActivityWindowRedirectPort {\n\n  /**\n   * @param {!Window} win\n   * @param {!ActivityResultCode} code\n   * @param {*} data\n   * @param {string} targetOrigin\n   * @param {boolean} targetOriginVerified\n   */\n  constructor(win, code, data, targetOrigin, targetOriginVerified) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n    /** @private @const {!ActivityResultCode} */\n    this.code_ = code;\n    /** @private @const {*} */\n    this.data_ = data;\n    /** @private {string} */\n    this.targetOrigin_ = targetOrigin;\n    /** @private {boolean} */\n    this.targetOriginVerified_ = targetOriginVerified;\n  }\n\n  /** @override */\n  getMode() {\n    return ActivityMode.REDIRECT;\n  }\n\n  /** @override */\n  acceptResult() {\n    const result = new ActivityResult(\n        this.code_,\n        this.data_,\n        ActivityMode.REDIRECT,\n        this.targetOrigin_,\n        this.targetOriginVerified_,\n        /* secureChannel */ false);\n    return new Promise(resolve => {\n      resolveResult(this.win_, result, resolve);\n    });\n  }\n}\n\n\n\n\n/**\n * The page-level activities manager ports. This class is intended to be used\n * as a singleton. It can start activities of all modes: iframe, popup, and\n * redirect.\n */\nclass ActivityPorts {\n\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {string} */\n    this.version = '1.24';\n\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private @const {string} */\n    this.fragment_ = win.location.hash;\n\n    /**\n     * @private @const {!Object<string, !Array<function(!ActivityPort)>>}\n     */\n    this.requestHandlers_ = {};\n\n    /**\n     * The result buffer is indexed by `requestId`.\n     * @private @const {!Object<string, !ActivityPort>}\n     */\n    this.resultBuffer_ = {};\n\n    /** @private {?function(!Error)} */\n    this.redirectErrorResolver_ = null;\n\n    /** @private {!Promise<!Error>} */\n    this.redirectErrorPromise_ = new Promise(resolve => {\n      this.redirectErrorResolver_ = resolve;\n    });\n  }\n\n  /**\n   * Start an activity within the specified iframe.\n   * @param {!HTMLIFrameElement} iframe\n   * @param {string} url\n   * @param {?Object=} opt_args\n   * @return {!Promise<!ActivityIframePort>}\n   */\n  openIframe(iframe, url, opt_args) {\n    const port = new ActivityIframePort(iframe, url, opt_args);\n    return port.connect().then(() => port);\n  }\n\n  /**\n   * Start an activity in a separate window. The result will be delivered\n   * to the `onResult` callback.\n   *\n   * The activity can be opened in two modes: \"popup\" and \"redirect\". This\n   * depends on the `target` value, but also on the browser/environment.\n   *\n   * The allowed `target` values are `_blank`, `_top` and name targets. The\n   * `_self`, `_parent` and similar targets are not allowed.\n   *\n   * The `_top` target indicates that the activity should be opened as a\n   * \"redirect\", while other targets indicate that the activity should be\n   * opened as a popup. The activity client will try to honor the requested\n   * target. However, it's not always possible. Some environments do not\n   * allow popups and they either force redirect or fail the window open\n   * request. In this case, the activity will try to fallback to the \"redirect\"\n   * mode.\n   *\n   * @param {string} requestId\n   * @param {string} url\n   * @param {string} target\n   * @param {?Object=} opt_args\n   * @param {?ActivityOpenOptions=} opt_options\n   * @return {{targetWin: ?Window}}\n   */\n  open(requestId, url, target, opt_args, opt_options) {\n    const port = this.openWin_(requestId, url, target, opt_args, opt_options);\n    return {targetWin: port.getTargetWin()};\n  }\n\n  /**\n   * Start an activity in a separate window and tries to setup messaging with\n   * this window.\n   *\n   * See `open()` method for more details, including `onResult` callback.\n   *\n   * @param {string} requestId\n   * @param {string} url\n   * @param {string} target\n   * @param {?Object=} opt_args\n   * @param {?ActivityOpenOptions=} opt_options\n   * @return {!Promise<!ActivityMessagingPort>}\n   */\n  openWithMessaging(requestId, url, target, opt_args, opt_options) {\n    const port = this.openWin_(requestId, url, target, opt_args, opt_options);\n    return port.whenConnected().then(() => port);\n  }\n\n  /**\n   * Registers the callback for the result of the activity opened with the\n   * specified `requestId` (see the `open()` method). The callback is a\n   * function that takes a single `ActivityPort` argument. The client\n   * can use this object to verify the port using it's origin, verified and\n   * secure channel flags. Then the client can call\n   * `ActivityPort.acceptResult()` method to accept the result.\n   *\n   * The activity result is handled via a separate callback because of a\n   * possible redirect. So use of direct callbacks and/or promises is not\n   * possible in that case.\n   *\n   * A typical implementation would look like:\n   * ```\n   * ports.onResult('request1', function(port) {\n   *   port.acceptResult().then(function(result) {\n   *     // Only verified origins are allowed.\n   *     if (result.origin == expectedOrigin &&\n   *         result.originVerified &&\n   *         result.secureChannel) {\n   *       handleResultForRequest1(result);\n   *     }\n   *   });\n   * })\n   *\n   * ports.open('request1', request1Url, '_blank');\n   * ```\n   *\n   * @param {string} requestId\n   * @param {function(!ActivityPort)} callback\n   */\n  onResult(requestId, callback) {\n    let handlers = this.requestHandlers_[requestId];\n    if (!handlers) {\n      handlers = [];\n      this.requestHandlers_[requestId] = handlers;\n    }\n    handlers.push(callback);\n\n    // Consume available result.\n    const availableResult = this.discoverResult_(requestId);\n    if (availableResult) {\n      this.consumeResult_(availableResult, callback);\n    }\n  }\n\n  /**\n   * @param {function(!Error)} handler\n   */\n  onRedirectError(handler) {\n    this.redirectErrorPromise_.then(handler);\n  }\n\n  /**\n   * @param {string} requestId\n   * @param {string} url\n   * @param {string} target\n   * @param {?Object=} opt_args\n   * @param {?ActivityOpenOptions=} opt_options\n   * @return {!ActivityWindowPort}\n   */\n  openWin_(requestId, url, target, opt_args, opt_options) {\n    const port = new ActivityWindowPort(\n        this.win_, requestId, url, target, opt_args, opt_options);\n    port.open().then(() => {\n      // Await result if possible. Notice that when falling back to \"redirect\",\n      // the result will never arrive through this port.\n      this.consumeResultAll_(requestId, port);\n    });\n    return port;\n  }\n\n  /**\n   * @param {string} requestId\n   * @return {?ActivityPort}\n   * @private\n   */\n  discoverResult_(requestId) {\n    let port = this.resultBuffer_[requestId];\n    if (!port && this.fragment_) {\n      try {\n        port = discoverRedirectPort(\n            this.win_, this.fragment_, requestId);\n      } catch (e) {\n        throwAsync(e);\n        this.redirectErrorResolver_(e);\n      }\n      if (port) {\n        this.resultBuffer_[requestId] = port;\n      }\n    }\n    return port;\n  }\n\n  /**\n   * @param {!ActivityPort} port\n   * @param {function(!ActivityPort)} callback\n   * @private\n   */\n  consumeResult_(port, callback) {\n    Promise.resolve().then(() => {\n      callback(port);\n    });\n  }\n\n  /**\n   * @param {string} requestId\n   * @param {!ActivityPort} port\n   * @private\n   */\n  consumeResultAll_(requestId, port) {\n    // Find and execute handlers.\n    const handlers = this.requestHandlers_[requestId];\n    if (handlers) {\n      handlers.forEach(handler => {\n        this.consumeResult_(port, handler);\n      });\n    }\n    // Buffer the result for callbacks that may arrive in the future.\n    this.resultBuffer_[requestId] = port;\n  }\n}\n\n\n\nmodule.exports = {\n  ActivityPorts,\n  ActivityIframePort,\n  ActivityMessagingPort,\n  ActivityMode,\n  ActivityOpenOptions,\n  ActivityPort,\n  ActivityRequest,\n  ActivityResult,\n  ActivityResultCode,\n  ActivityWindowPort,\n  createAbortError,\n  isAbortError,\n};\n", "/* @const */\nconst {hasOwnProperty: hasOwn_, toString: toString_} = Object.prototype;\n\n/**\n * Determines if value is actually an Object.\n * @param {*} value\n * @return {boolean}\n */\nexport function isObject(value) {\n  return toString_.call(value) === '[object Object]';\n}\n\n/**\n * Returns a map-like object.\n * If opt_initial is provided, copies its own properties into the\n * newly created object.\n * @param {T=} opt_initial This should typically be an object literal.\n * @return {T}\n * @template T\n */\nexport function map(opt_initial) {\n  const obj = Object.create(null);\n  if (opt_initial) {\n    Object.assign(obj, opt_initial);\n  }\n  return obj;\n}\n\n/**\n * Return an empty JsonObject or makes the passed in object literal\n * an JsonObject.\n * The JsonObject type is just a simple object that is at-dict.\n * See\n * https://github.com/google/closure-compiler/wiki/@struct-and-@dict-Annotations\n * for what a dict is type-wise.\n * The linter enforces that the argument is, in fact, at-dict like.\n * @param {!Object=} opt_initial\n * @return {!JsonObject}\n */\nexport function dict(opt_initial) {\n  // We do not copy. The linter enforces that the passed in object is a literal\n  // and thus the caller cannot have a reference to it.\n  return /** @type {!JsonObject} */ (opt_initial || {});\n}\n\n/**\n * Checks if the given key is a property in the map.\n *\n * @param {T}  obj a map like property.\n * @param {string}  key\n * @return {boolean}\n * @template T\n */\nexport function hasOwn(obj, key) {\n  return hasOwn_.call(obj, key);\n}\n\n/**\n * Returns obj[key] iff key is obj's own property (is not inherited).\n * Otherwise, returns undefined.\n *\n * @param {Object} obj\n * @param {string} key\n * @return {*}\n */\nexport function ownProperty(obj, key) {\n  if (hasOwn(obj, key)) {\n    return obj[key];\n  } else {\n    return undefined;\n  }\n}\n\n/**\n * Deep merges source into target.\n *\n * @param {!Object} target\n * @param {!Object} source\n * @param {number} depth The maximum merge depth. If exceeded, Object.assign\n *                       will be used instead.\n * @return {!Object}\n * @throws {Error} If source contains a circular reference.\n * Note: Only nested objects are deep-merged, primitives and arrays are not.\n */\nexport function deepMerge(target, source, depth = 10) {\n  // Keep track of seen objects to detect recursive references.\n  const seen = [];\n\n  /** @type {!Array<{t: !Object, s: !Object, d: number}>} */\n  const queue = [];\n  queue.push({t: target, s: source, d: 0});\n\n  // BFS to ensure objects don't have recursive references at shallower depths.\n  while (queue.length > 0) {\n    const {d, s, t} = queue.shift();\n    if (seen.includes(s)) {\n      throw new Error('Source object has a circular reference.');\n    }\n    seen.push(s);\n    if (t === s) {\n      continue;\n    }\n    if (d > depth) {\n      Object.assign(t, s);\n      continue;\n    }\n    for (const key of Object.keys(s)) {\n      const newValue = s[key];\n      // Perform a deep merge IFF both target and source have the same key\n      // whose corresponding values are objects.\n      if (hasOwn(t, key)) {\n        const oldValue = t[key];\n        if (isObject(newValue) && isObject(oldValue)) {\n          queue.push({t: oldValue, s: newValue, d: d + 1});\n          continue;\n        }\n      }\n      t[key] = newValue;\n    }\n  }\n  return target;\n}\n\n/**\n * @param {!Object} o An object to remove properties from\n * @param {!Array<string>} props A list of properties to remove from the Object\n * @return {!Object} An object with the given properties removed\n */\nexport function omit(o, props) {\n  return Object.keys(o).reduce((acc, key) => {\n    if (!props.includes(key)) {\n      acc[key] = o[key];\n    }\n    return acc;\n  }, {});\n}\n\n/**\n * @param {!Object|null|undefined} o1\n * @param {!Object|null|undefined} o2\n * @return {boolean}\n */\nexport function objectsEqualShallow(o1, o2) {\n  if (o1 == null || o2 == null) {\n    // Null is only equal to null, and undefined to undefined.\n    return o1 === o2;\n  }\n\n  for (const k in o1) {\n    if (o1[k] !== o2[k]) {\n      return false;\n    }\n  }\n  for (const k in o2) {\n    if (o2[k] !== o1[k]) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\n/**\n * @param {T} obj\n * @param {string} prop\n * @param {function(T, string):R} factory\n * @return {R}\n * @template T,R\n */\nexport function memo(obj, prop, factory) {\n  let result = /** @type {?R} */ (obj[prop]);\n  if (result === undefined) {\n    result = factory(obj, prop);\n    obj[prop] = result;\n  }\n  return result;\n}\n\n/**\n * Recreates objects with prototype-less copies.\n * @param {!JsonObject} obj\n * @return {!JsonObject}\n */\nexport function recreateNonProtoObject(obj) {\n  const copy = map();\n  for (const k in obj) {\n    if (!hasOwn(obj, k)) {\n      continue;\n    }\n    const v = obj[k];\n    copy[k] = isObject(v) ? recreateNonProtoObject(v) : v;\n  }\n  return /** @type {!JsonObject} */ (copy);\n}\n\n/**\n * Returns a value from an object for a field-based expression. The expression\n * is a simple nested dot-notation of fields, such as `field1.field2`. If any\n * field in a chain does not exist or is not an object or array, the returned\n * value will be `undefined`.\n *\n * @param {!JsonObject} obj\n * @param {string} expr\n * @return {*}\n */\nexport function getValueForExpr(obj, expr) {\n  // The `.` indicates \"the object itself\".\n  if (expr == '.') {\n    return obj;\n  }\n  // Otherwise, navigate via properties.\n  const parts = expr.split('.');\n  let value = obj;\n  for (const part of parts) {\n    if (\n      part &&\n      value &&\n      value[part] !== undefined &&\n      typeof value == 'object' &&\n      hasOwn(value, part)\n    ) {\n      value = value[part];\n      continue;\n    }\n    value = undefined;\n    break;\n  }\n  return value;\n}\n", "import {map} from '#core/types/object';\n\nconst QUERY_STRING_REGEX = /(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;\n\n/**\n * Tries to decode a URI component, falling back to opt_fallback (or an empty\n * string)\n *\n * @param {string} component\n * @param {string=} fallback\n * @return {string}\n */\nexport function tryDecodeUriComponent(component, fallback = '') {\n  try {\n    return decodeURIComponent(component);\n  } catch (e) {\n    return fallback;\n  }\n}\n\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n *\n * @param {string} queryString\n * @return {!JsonObject}\n */\nexport function parseQueryString(queryString) {\n  const params = map();\n  if (!queryString) {\n    return params;\n  }\n\n  let match;\n  while ((match = QUERY_STRING_REGEX.exec(queryString))) {\n    const name = tryDecodeUriComponent(match[1], match[1]);\n    const value = match[2]\n      ? tryDecodeUriComponent(match[2].replace(/\\+/g, ' '), match[2])\n      : '';\n    params[name] = value;\n  }\n  return params;\n}\n\n/**\n * Parses the query # params.\n * @param {!Window=} opt_win\n * @return {!JsonObject}\n */\nexport function getHashParams(opt_win) {\n  const {location} = opt_win || self;\n  // location.originalHash is set by the viewer when it removes the fragment\n  // from the URL.\n  return parseQueryString(location['originalHash'] || location.hash);\n}\n", "/**\n * An interface to interact with browser window object.\n * Mainly used to mock out read only APIs in test.\n * See test-helper.js#mockWindowInterface\n */\nexport class WindowInterface {\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {!Window}\n   */\n  static getTop(win) {\n    return win.top;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {!Location}\n   */\n  static getLocation(win) {\n    return win.location;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getDocumentReferrer(win) {\n    return win.document.referrer;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getHostname(win) {\n    return win.location.hostname;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getUserAgent(win) {\n    return win.navigator.userAgent;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getUserLanguage(win) {\n    // The `navigator.userLanguage` is only supported by IE. The standard is\n    // the `navigator.language`.\n    return win.navigator['userLanguage'] || win.navigator.language;\n  }\n\n  /**\n   * @static\n   * @return {number}\n   */\n  static getDevicePixelRatio() {\n    // No matter the window, the device-pixel-ratio is always one.\n    return self.devicePixelRatio || 1;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {function(string,(ArrayBufferView|Blob|FormData|null|string)=):boolean|undefined}\n   */\n  static getSendBeacon(win) {\n    if (!win.navigator.sendBeacon) {\n      return undefined;\n    }\n    return win.navigator.sendBeacon.bind(win.navigator);\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {typeof XMLHttpRequest}\n   */\n  static getXMLHttpRequest(win) {\n    return win.XMLHttpRequest;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {typeof Image}\n   */\n  static getImage(win) {\n    return win.Image;\n  }\n}\n", "/**\n * Converts an array-like object to an array.\n * @param {?IArrayLike<T>|string} arrayLike\n * @return {!Array<T>}\n * @template T\n */\nexport function toArray(arrayLike) {\n  return arrayLike ? Array.prototype.slice.call(arrayLike) : [];\n}\n\n/**\n * Determines if value is actually an Array.\n * @param {*} value\n * @return {boolean}\n */\nexport const {isArray} = Array;\n\n/**\n * If the specified argument is an array, it's returned as is. If it's a\n * single item, the array containing this item is created and returned.\n *\n * The double-template pattern here solves a bug where CC can be passed a value\n * with declared type {string|!Array<string>} and return a value with a type of\n * {!Array<string|Array<string>>}.\n *\n * @param {!Array<T>|S} arrayOrSingleItem\n * @return {!Array<T>|!Array<S>}\n * @template S\n * @template T\n */\nexport function arrayOrSingleItemToArray(arrayOrSingleItem) {\n  return isArray(arrayOrSingleItem)\n    ? /** @type {!Array<T>} */ (arrayOrSingleItem)\n    : [/** @type {!S} */ (arrayOrSingleItem)];\n}\n\n/**\n * Compares if two arrays contains exactly same elements of same number\n * of same order. Note that it does NOT handle NaN case as expected.\n *\n * @param {!Array<T>} arr1\n * @param {!Array<T>} arr2\n * @return {boolean}\n * @template T\n */\nexport function areEqualOrdered(arr1, arr2) {\n  if (arr1.length !== arr2.length) {\n    return false;\n  }\n  for (let i = 0; i < arr1.length; i++) {\n    if (arr1[i] !== arr2[i]) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Removes elements that shouldRemove returns true for from the array.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} shouldRemove\n * @return {!Array<T>}\n * @template T\n */\nexport function remove(array, shouldRemove) {\n  const removed = [];\n  let index = 0;\n  for (let i = 0; i < array.length; i++) {\n    const item = array[i];\n    if (shouldRemove(item, i, array)) {\n      removed.push(item);\n    } else {\n      if (index < i) {\n        array[index] = item;\n      }\n      index++;\n    }\n  }\n  if (index < array.length) {\n    array.length = index;\n  }\n  return removed;\n}\n\n/**\n * Returns the index of the first element matching the predicate.\n * Like Array#findIndex.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} predicate\n * @return {number}\n * @template T\n */\nexport function findIndex(array, predicate) {\n  for (let i = 0; i < array.length; i++) {\n    if (predicate(array[i], i, array)) {\n      return i;\n    }\n  }\n  return -1;\n}\n\n/**\n * Converts the given iterator to an array.\n *\n * @param {!Iterator<T>} iterator\n * @return {Array<T>}\n * @template T\n */\nexport function fromIterator(iterator) {\n  const array = [];\n  for (let e = iterator.next(); !e.done; e = iterator.next()) {\n    array.push(e.value);\n  }\n  return array;\n}\n\n/**\n * Adds item to array if it is not already present.\n *\n * @param {Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function pushIfNotExist(array, item) {\n  if (array.indexOf(item) < 0) {\n    array.push(item);\n    return true;\n  }\n  return false;\n}\n\n/**\n * Removes the first matching item in the array. Returns `true` if the array\n * has changed.\n *\n * @param {!Array<T>} array\n * @param {T} item\n * @return {boolean}\n * @template T\n */\nexport function removeItem(array, item) {\n  const index = array.indexOf(item);\n  if (index == -1) {\n    return false;\n  }\n  array.splice(index, 1);\n  return true;\n}\n\n/**\n * Returns the last item in an array.\n *\n * @param {Array<T>} array\n * @template T\n * @return {?T}\n */\nexport function lastItem(array) {\n  return array[array.length - 1];\n}\n", "/**\n * @param {string} _match\n * @param {string} character\n * @return {string}\n */\nfunction toUpperCase(_match, character) {\n  return character.toUpperCase();\n}\n\n/**\n * @param {string} match\n * @return {string}\n */\nfunction prependDashAndToLowerCase(match) {\n  return '-' + match.toLowerCase();\n}\n\n/**\n * @param {string} name Attribute name containing dashes.\n * @return {string} Dashes removed and successive character sent to upper case.\n * visibleForTesting\n */\nexport function dashToCamelCase(name) {\n  return name.replace(/-([a-z])/g, toUpperCase);\n}\n\n/**\n * Converts a string that is in camelCase to one that is in dash-case.\n *\n * @param {string} string The string to convert.\n * @return {string} The string in dash-case.\n */\nexport function camelCaseToDash(string) {\n  return string.replace(/(?!^)[A-Z]/g, prependDashAndToLowerCase);\n}\n\n/**\n * @param {string} name Attribute name with dashes\n * @return {string} Dashes replaced by underlines.\n */\nexport function dashToUnderline(name) {\n  return name.replace('-', '_');\n}\n\n/**\n * Polyfill for String.prototype.endsWith.\n * @param {string} string\n * @param {string} suffix\n * @return {boolean}\n */\nexport function endsWith(string, suffix) {\n  const index = string.length - suffix.length;\n  return index >= 0 && string.indexOf(suffix, index) == index;\n}\n\n/**\n * Polyfill for String.prototype.includes.\n * @param {string} string\n * @param {string} substring\n * @param {number=} start\n * @return {boolean}\n */\nexport function includes(string, substring, start) {\n  if (typeof start !== 'number') {\n    start = 0;\n  }\n  if (start + substring.length > string.length) {\n    return false;\n  }\n  return string.indexOf(substring, start) !== -1;\n}\n\n/**\n * Expands placeholders in a given template string with values.\n *\n * Placeholders use ${key-name} syntax and are replaced with the value\n * returned from the given getter function.\n *\n * @param {string} template The template string to expand.\n * @param {function(string):*} getter Function used to retrieve a value for a\n *   placeholder. Returns values will be coerced into strings.\n * @param {number=} opt_maxIterations Number of times to expand the template.\n *   Defaults to 1, but should be set to a larger value your placeholder tokens\n *   can be expanded to other placeholder tokens. Take caution with large values\n *   as recursively expanding a string can be exponentially expensive.\n * @return {string}\n */\nexport function expandTemplate(template, getter, opt_maxIterations) {\n  const maxIterations = opt_maxIterations || 1;\n  for (let i = 0; i < maxIterations; i++) {\n    let matches = 0;\n    template = template.replace(/\\${([^}]*)}/g, (_a, b) => {\n      matches++;\n      return getter(b);\n    });\n    if (!matches) {\n      break;\n    }\n  }\n  return template;\n}\n\n/**\n * Hash function djb2a\n * This is intended to be a simple, fast hashing function using minimal code.\n * It does *not* have good cryptographic properties.\n * @param {string} str\n * @return {string} 32-bit unsigned hash of the string\n */\nexport function stringHash32(str) {\n  const {length} = str;\n  let hash = 5381;\n  for (let i = 0; i < length; i++) {\n    hash = (hash * 33) ^ str.charCodeAt(i);\n  }\n  // Convert from 32-bit signed to unsigned.\n  return String(hash >>> 0);\n}\n\n/**\n * Trims a string on the end, removing whitespace characters.\n * @param {string} str  A string to trim.\n * @return {string} The string, with trailing whitespace removed.\n */\nexport function trimEnd(str) {\n  // TODO(sparhami) Does this get inlined for an ES2019 build?\n  if (str.trimEnd) {\n    return str.trimEnd();\n  }\n\n  return ('_' + str).trim().slice(1);\n}\n\n/**\n * Trims any leading whitespace from a string.\n * @param {string} str  A string to trim.\n * @return {string} The string, with leading whitespace removed.\n */\nexport function trimStart(str) {\n  if (str.trimStart) {\n    return str.trimStart();\n  }\n\n  return (str + '_').trim().slice(0, -1);\n}\n\n/**\n * Wrapper around String.replace that handles asynchronous resolution.\n * @param {string} str\n * @param {RegExp} regex\n * @param {Function|string} replacer\n * @return {!Promise<string>}\n */\nexport function asyncStringReplace(str, regex, replacer) {\n  if (isString(replacer)) {\n    return Promise.resolve(str.replace(regex, replacer));\n  }\n  const stringBuilder = [];\n  let lastIndex = 0;\n\n  str.replace(regex, function (match) {\n    // String.prototype.replace will pass 3 to n number of arguments to the\n    // callback function based on how many capture groups the regex may or may\n    // not contain. We know that the match will always be first, and the\n    // index will always be second to last.\n    const matchIndex = arguments[arguments.length - 2];\n    stringBuilder.push(str.slice(lastIndex, matchIndex));\n    lastIndex = matchIndex + match.length;\n\n    // Store the promise in it's eventual string position.\n    const replacementPromise = replacer.apply(null, arguments);\n    stringBuilder.push(replacementPromise);\n  });\n  stringBuilder.push(str.slice(lastIndex));\n\n  return Promise.all(stringBuilder).then((resolved) => resolved.join(''));\n}\n\n/**\n * Pads the beginning of a string with a substring to a target length.\n * @param {string} s\n * @param {number} targetLength\n * @param {string} padString\n * @return {string}\n */\nexport function padStart(s, targetLength, padString) {\n  if (s.length >= targetLength) {\n    return s;\n  }\n  targetLength = targetLength - s.length;\n  let padding = padString;\n  while (targetLength > padding.length) {\n    padding += padString;\n  }\n  return padding.slice(0, targetLength) + s;\n}\n\n/**\n * Tests if a value is a string.\n * @param {?} s\n * @return {boolean}\n */\nexport function isString(s) {\n  return typeof s == 'string';\n}\n", "import {isArray} from '#core/types/array';\n\n/**\n * @fileoverview This module declares JSON types as defined in the\n * {@link http://json.org/}.\n */\n\n// NOTE Type are changed to {*} because of\n// https://github.com/google/closure-compiler/issues/1999\n\n/**\n * JSON scalar. It's either string, number or boolean.\n * @typedef {string|number|boolean|null}\n */\nlet JSONScalarDef;\n\n/**\n * JSON object. It's a map with string keys and JSON values.\n * @typedef {!Object<string, ?*>} (* should be JSONValueDef)\n */\nlet JSONObjectDef;\n\n/**\n * JSON array. It's an array with JSON values.\n * @typedef {!Array<?*>} (* should be JSONValueDef)\n */\nlet JSONArrayDef;\n\n/**\n * JSON value. It's either a scalar, an object or an array.\n * @typedef {!JSONScalarDef|!JSONObjectDef|!JSONArrayDef}\n */\nlet JSONValueDef;\n\n/**\n * @typedef {{\n *   YOU_MUST_USE: string,\n *   jsonLiteral: function(),\n *   TO_MAKE_THIS_TYPE: string,\n * }}\n */\nlet InternalJsonLiteralTypeDef;\n\n/**\n * Simple wrapper around JSON.parse that casts the return value\n * to JsonObject.\n * Create a new wrapper if an array return value is desired.\n * @param {string} json JSON string to parse\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function parseJson(json) {\n  return /** @type {?JsonObject} */ (JSON.parse(json));\n}\n\n/**\n * Parses the given `json` string without throwing an exception if not valid.\n * Returns `undefined` if parsing fails.\n * Returns the `Object` corresponding to the JSON string when parsing succeeds.\n * @param {string} json JSON string to parse\n * @param {function(!Error)=} opt_onFailed Optional function that will be called\n *     with the error if parsing fails.\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function tryParseJson(json, opt_onFailed) {\n  try {\n    return parseJson(json);\n  } catch (e) {\n    opt_onFailed?.(e);\n    return null;\n  }\n}\n\n/**\n * Deeply checks strict equality of items in nested arrays and objects.\n *\n * @param {JSONValueDef} a\n * @param {JSONValueDef} b\n * @param {number} depth The maximum depth. Must be finite.\n * @return {boolean}\n * @throws {Error} If depth argument is not finite.\n */\nexport function deepEquals(a, b, depth = 5) {\n  if (!isFinite(depth) || depth < 0) {\n    throw new Error('Invalid depth: ' + depth);\n  }\n  if (a === b) {\n    return true;\n  }\n  /** @type {!Array<{a: JSONValueDef, b: JSONValueDef, depth: number}>} */\n  const queue = [{a, b, depth}];\n  while (queue.length > 0) {\n    const {a, b, depth} = queue.shift();\n    // Only check deep equality if depth > 0.\n    if (depth > 0) {\n      if (typeof a !== typeof b) {\n        return false;\n      } else if (isArray(a) && isArray(b)) {\n        if (a.length !== b.length) {\n          return false;\n        }\n        for (let i = 0; i < a.length; i++) {\n          queue.push({a: a[i], b: b[i], depth: depth - 1});\n        }\n        continue;\n      } else if (a && b && typeof a === 'object' && typeof b === 'object') {\n        const keysA = Object.keys(a);\n        const keysB = Object.keys(b);\n        if (keysA.length !== keysB.length) {\n          return false;\n        }\n        for (const k of keysA) {\n          queue.push({a: a[k], b: b[k], depth: depth - 1});\n        }\n        continue;\n      }\n    }\n    // If we get here, then depth == 0 or (a, b) are primitives.\n    if (a !== b) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * This helper function handles configurations specified in a JSON format.\n *\n * It allows the configuration is to be written in plain JS (which has better\n * dev ergonomics like comments and trailing commas), and allows the\n * configuration to be transformed into an efficient JSON-parsed representation\n * in the dist build. See https://v8.dev/blog/cost-of-javascript-2019#json\n *\n * @param {!Object} obj\n * @return {!JsonObject}\n */\nexport function jsonConfiguration(obj) {\n  return /** @type {!JsonObject} */ (obj);\n}\n\n/**\n * This converts an Object into a suitable type to be used in `includeJsonLiteral`.\n * This doesn't actually do any conversion, it only changes the closure type.\n *\n * @param {?JSONValueDef} value\n * @return {!InternalJsonLiteralTypeDef}\n */\nexport function jsonLiteral(value) {\n  return /** @type {!InternalJsonLiteralTypeDef} */ (value);\n}\n\n/**\n * Allows inclusion of a variable (that's wrapped in a jsonLiteral\n * call) to be included inside a jsonConfiguration.\n *\n * @param {!InternalJsonLiteralTypeDef} value\n * @return {*}\n */\nexport function includeJsonLiteral(value) {\n  return value;\n}\n", "import {isElement} from '#core/types';\n\n/**\n * Triple zero width space.\n *\n * This is added to user error messages, so that we can later identify\n * them, when the only thing that we have is the message. This is the\n * case in many browsers when the global exception handler is invoked.\n *\n * @const {string}\n */\nexport const USER_ERROR_SENTINEL = '\\u200B\\u200B\\u200B';\n/**\n * Four zero width space.\n *\n * @const {string}\n */\nexport const USER_ERROR_EMBED_SENTINEL = '\\u200B\\u200B\\u200B\\u200B';\n\n/**\n * Converts an element to a readable string; all other types are unchanged.\n * TODO(rcebulko): Unify with log.js\n * @param {*} val\n * @return {*}\n */\nexport function elementStringOrPassThru(val) {\n  // Do check equivalent to `val instanceof Element` without cross-window bug\n  if (isElement(val)) {\n    val = /** @type {Element} */ (val);\n    return val.tagName.toLowerCase() + (val.id ? `#${val.id}` : '');\n  }\n  return val;\n}\n\n/**\n * Tests if an error message contains the user sentinel.\n * @param {string} message\n * @return {boolean} Whether this message was a user error.\n */\nexport function isUserErrorMessage(message) {\n  return message.indexOf(USER_ERROR_SENTINEL) >= 0;\n}\n\n/**\n * @param {string} message\n * @return {boolean} Whether this message was a a user error from an iframe embed.\n */\nexport function isUserErrorEmbedMessage(message) {\n  return message.indexOf(USER_ERROR_EMBED_SENTINEL) >= 0;\n}\n\n/**\n * Strips the user error sentinel from an error message.\n * @param {string} message\n * @return {string} The new message without USER_ERROR_SENTINEL\n */\nexport function stripUserError(message) {\n  return message.replace(USER_ERROR_SENTINEL, '');\n}\n", "/**\n * Returns true when the build is meant for distribution.\n * This means `amp dist` was called _without_ the --fortesting flag.\n *\n * This is a magic constant replaced by babel.\n *\n * Calls are DCE'd when compiled.\n * @return {boolean}\n */\nexport function isProd() {\n  return IS_PROD;\n}\n", "import {isProd} from './prod';\n\n/**\n * Returns true if executing in a testing environment. Calls may be DCE'd when\n * compiled based on isForDistribution.\n * @param {!Window=} opt_win\n * @return {boolean}\n */\nexport function isTest(opt_win) {\n  if (isProd()) {\n    return false;\n  }\n  const win = opt_win || self;\n  return !!(win.AMP_CONFIG?.test || win.__AMP_TEST || win['__karma__']);\n}\n", "import {isProd} from './prod';\nimport {isTest} from './test';\n\n/**\n * Returns true if executing in a local development or testing environment.\n * Calls may be DCE'd when compiled based on isForDistribution and isTest.\n *\n * @param {!Window=} opt_win\n * @return {boolean}\n */\nexport function isLocalDev(opt_win) {\n  if (isProd()) {\n    return false;\n  }\n\n  return !!self.AMP_CONFIG?.localDev || isTest(opt_win);\n}\n", "/**\n * Returns true whenever closure compiler is used.\n * This is a magic constant that is replaced by babel.\n *\n * @return {boolean}\n */\nexport function isMinified() {\n  return IS_MINIFIED;\n}\n", "/**\n * Returns the internal AMP runtime version. Note that this is not the RTV,\n * which is a prefix and the runtime version.\n *\n * The call sites for this function are replaced with a compile time constant\n * string.\n *\n * @return {string}\n */\nexport function version() {\n  return INTERNAL_RUNTIME_VERSION;\n}\n", "/**\n * Copyright 2021 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isProd} from './prod';\n\n/**\n * Returns true when compiling an esm binary.\n * This is a magic constant that is replaced by babel.\n *\n * @return {boolean}\n */\nexport function isEsm() {\n  if (isProd()) {\n    return IS_ESM;\n  }\n\n  return self?.__AMP_MODE?.esm ?? IS_ESM;\n}\n", "/**\n * Allows for runtime configuration. Internally, the runtime should\n * use the src/config.js module for various constants. We can use the\n * AMP_CONFIG global to translate user-defined configurations to this\n * module.\n * @type {!Object<string, string>}\n */\nconst env = self.AMP_CONFIG || {};\n\nconst thirdPartyFrameRegex =\n  (typeof env['thirdPartyFrameRegex'] == 'string'\n    ? new RegExp(env['thirdPartyFrameRegex'])\n    : env['thirdPartyFrameRegex']) || /^d-\\d+\\.ampproject\\.net$/;\n\nconst cdnProxyRegex =\n  (typeof env['cdnProxyRegex'] == 'string'\n    ? new RegExp(env['cdnProxyRegex'])\n    : env['cdnProxyRegex']) ||\n  /^https:\\/\\/([a-zA-Z0-9_-]+\\.)?cdn\\.ampproject\\.org$/;\n\n/**\n * Check for a custom URL definition in special <meta> tags. Note that this does\n * not allow for distinct custom URLs in AmpDocShadow instances. The shell is\n * allowed to define one set of custom URLs via AMP_CONFIG (recommended) or by\n * including <meta> tags in the shell <head>. Those custom URLs then apply to\n * all AMP documents loaded in the shell.\n * @param {string} name\n * @return {?string}\n * @private\n */\nfunction getMetaUrl(name) {\n  // Avoid exceptions in unit tests\n  if (!self.document || !self.document.head) {\n    return null;\n  }\n\n  // Disallow on proxy origins\n  if (self.location && cdnProxyRegex.test(self.location.origin)) {\n    return null;\n  }\n\n  const metaEl = self.document.head./*OK*/ querySelector(\n    `meta[name=\"${name}\"]`\n  );\n  return (metaEl && metaEl.getAttribute('content')) || null;\n}\n\n/**\n * @typedef {{\n *   thirdParty: string,\n *   thirdPartyFrameHost: string,\n *   thirdPartyFrameRegex: !RegExp,\n *   cdn: string,\n *   cdnProxyRegex: !RegExp,\n *   localhostRegex: !RegExp,\n *   errorReporting: string,\n *   betaErrorReporting: string,\n *   localDev: boolean,\n *   trustedViewerHosts: !Array<!RegExp>,\n *   geoApi: ?string,\n * }}\n */\nexport const urls = {\n  thirdParty: env['thirdPartyUrl'] || 'https://3p.ampproject.net',\n  thirdPartyFrameHost: env['thirdPartyFrameHost'] || 'ampproject.net',\n  thirdPartyFrameRegex,\n  cdn:\n    env['cdnUrl'] || getMetaUrl('runtime-host') || 'https://cdn.ampproject.org',\n  /* Note that cdnProxyRegex is only ever checked against origins\n   * (proto://host[:port]) so does not need to consider path\n   */\n  cdnProxyRegex,\n  localhostRegex: /^https?:\\/\\/localhost(:\\d+)?$/,\n  errorReporting:\n    env['errorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r',\n  betaErrorReporting:\n    env['betaErrorReportingUrl'] ||\n    'https://us-central1-amp-error-reporting.cloudfunctions.net/r-beta',\n  localDev: env['localDev'] || false,\n  /**\n   * These domains are trusted with more sensitive viewer operations such as\n   * propagating the referrer. If you believe your domain should be here,\n   * file the issue on GitHub to discuss. The process will be similar\n   * (but somewhat more stringent) to the one described in the [3p/README.md](\n   * https://github.com/ampproject/amphtml/blob/main/3p/README.md)\n   *\n   * {!Array<!RegExp>}\n   */\n  trustedViewerHosts: [\n    /(^|\\.)google\\.(com?|[a-z]{2}|com?\\.[a-z]{2}|cat)$/,\n    /(^|\\.)gmail\\.(com|dev)$/,\n  ],\n  // Optional fallback API if amp-geo is left unpatched\n  geoApi: env['geoApiUrl'] || getMetaUrl('amp-geo-api'),\n};\n\nexport const config = {\n  urls,\n};\n", "import * as coreMode from '#core/mode';\nimport {getHashParams} from '#core/types/string/url';\n\n/**\n * @typedef {{\n *   localDev: boolean,\n *   development: boolean,\n *   esm: boolean,\n *   test: boolean,\n *   rtvVersion: string,\n *   runtime: (null|string|undefined),\n *   a4aId: (null|string|undefined)\n * }}\n */\nexport let ModeDef;\n\n/**\n * `rtvVersion` is the prefixed version we serve off of the cdn.\n * The prefix denotes canary(00) or prod(01) or an experiment version ( > 01).\n * @type {string}\n */\nlet rtvVersion = '';\n\n/**\n * Provides info about the current app.\n * @param {?Window=} opt_win\n * @return {!ModeDef}\n */\nexport function getMode(opt_win) {\n  const win = opt_win || self;\n  if (win.__AMP_MODE) {\n    return win.__AMP_MODE;\n  }\n  return (win.__AMP_MODE = getMode_(win));\n}\n\n/**\n * Provides info about the current app.\n * @param {!Window} win\n * @return {!ModeDef}\n */\nfunction getMode_(win) {\n  const hashParams = getHashParams(win);\n\n  // The `minified`, `test` and `localDev` properties are replaced\n  // as boolean literals when we run `amp dist` without the `--fortesting`\n  // flags. This improved DCE on the production file we deploy as the code\n  // paths for localhost/testing/development are eliminated.\n  return {\n    localDev: coreMode.isLocalDev(win),\n    development: isModeDevelopment(win, hashParams),\n    esm: coreMode.isEsm(),\n    test: coreMode.isTest(win),\n    rtvVersion: getRtvVersion(win),\n  };\n}\n\n/**\n * Retrieve the `rtvVersion` which will have a numeric prefix\n * denoting canary/prod/experiment (unless `isLocalDev` is true).\n *\n * @param {!Window} win\n * @return {string}\n */\nfunction getRtvVersion(win) {\n  // Ignore memoized copy during testing to allow override.\n  if (!rtvVersion || coreMode.isTest(win)) {\n    // Currently `internalRuntimeVersion` and thus `mode.version` contain only\n    // major version. The full version however must also carry the minor version.\n    // We will default to production default `01` minor version for now.\n    // TODO(erwinmombay): decide whether internalRuntimeVersion should contain\n    // minor version.\n    rtvVersion = win.AMP_CONFIG?.v || `01${coreMode.version()}`;\n  }\n  return rtvVersion;\n}\n\n/**\n * Triggers validation or enable pub level logging. Validation can be\n * bypassed via #validate=0.\n * Note that AMP_DEV_MODE flag is used for testing purposes.\n * @param {!Window} win\n * @param {!JsonObject=} opt_hashParams\n * @return {boolean}\n */\nexport function isModeDevelopment(win, opt_hashParams) {\n  const devModes = ['1', 'actions', 'amp', 'amp4ads', 'amp4email'];\n  const devParam = opt_hashParams || getHashParams(win);\n  return devModes.includes(devParam['development']) || !!win.AMP_DEV_MODE;\n}\n\n/**\n * @param {!Window} win\n * @return {string}\n * @visibleForTesting\n */\nexport function getRtvVersionForTesting(win) {\n  return getRtvVersion(win);\n}\n\n/** @visibleForTesting */\nexport function resetRtvVersionForTesting() {\n  rtvVersion = '';\n}\n", "import * as assertions from '#core/assert/base';\nimport {\n  createError,\n  createExpectedError,\n  duplicateErrorIfNecessary,\n} from '#core/error';\nimport {\n  USER_ERROR_EMBED_SENTINEL,\n  USER_ERROR_SENTINEL,\n  elementStringOrPassThru,\n  isUserErrorMessage,\n  stripUserError,\n} from '#core/error/message-helpers';\nimport * as mode from '#core/mode';\nimport {isArray, isString} from '#core/types';\nimport {once} from '#core/types/function';\nimport {getHashParams} from '#core/types/string/url';\n\nimport {urls} from '../config';\nimport {getMode} from '../mode';\n\nconst noop = () => {};\n\n// These are exported here despite being defined elswhere to avoid updating\n// imports across many files for now.\nexport {USER_ERROR_SENTINEL, isUserErrorMessage};\n\n/**\n * Sets reportError function. Called from error-reporting.js to break cyclic\n * dependency.\n * @param {function(this:Window, Error, (?Element)=): ?|undefined} fn\n */\nexport function setReportError(fn) {\n  self.__AMP_REPORT_ERROR = fn;\n}\n\n/**\n * @enum {number}\n */\nexport const LogLevel = {\n  OFF: 0,\n  ERROR: 1,\n  WARN: 2,\n  INFO: 3,\n  FINE: 4,\n};\n\n/**\n * @type {!LogLevel|undefined}\n * @private\n */\nlet levelOverride_ = undefined;\n\n/**\n * @param {!LogLevel} level\n */\nexport function overrideLogLevel(level) {\n  levelOverride_ = level;\n}\n\n/**\n * Prefixes `internalRuntimeVersion` with the `01` channel signifier (for prod.) for\n * extracted message URLs.\n * (Specific channel is irrelevant: message tables are invariant on internal version.)\n * @return {string}\n */\nconst messageUrlRtv = () => `01${mode.version()}`;\n\n/**\n * Gets a URL to display a message on amp.dev.\n * @param {string} id\n * @param {!Array} interpolatedParts\n * @return {string}\n */\nconst externalMessageUrl = (id, interpolatedParts) =>\n  interpolatedParts.reduce(\n    (prefix, arg) => `${prefix}&s[]=${messageArgToEncodedComponent(arg)}`,\n    `https://log.amp.dev/?v=${messageUrlRtv()}&id=${encodeURIComponent(id)}`\n  );\n\n/**\n * URL to simple log messages table JSON file, which contains an Object<string, string>\n * which maps message id to full message template.\n * @return {string}\n */\nconst externalMessagesSimpleTableUrl = () =>\n  `${urls.cdn}/rtv/${messageUrlRtv()}/log-messages.simple.json`;\n\n/**\n * @param {*} arg\n * @return {string}\n */\nconst messageArgToEncodedComponent = (arg) =>\n  encodeURIComponent(String(elementStringOrPassThru(arg)));\n\n/**\n * @param {!Window=} opt_win\n * @return {number}\n */\nexport const logHashParam = (opt_win) =>\n  parseInt(getHashParams(opt_win)['log'], 10);\n\n/**\n * Logging class. Use of sentinel string instead of a boolean to check user/dev\n * errors because errors could be rethrown by some native code as a new error,\n * and only a message would survive. Also, some browser don\u2019t support a 5th\n * error object argument in window.onerror. List of supporting browser can be\n * found here:\n * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n * @final\n * @private Visible for testing only.\n */\nexport class Log {\n  /**\n   * opt_suffix will be appended to error message to identify the type of the\n   * error message. We can't rely on the error object to pass along the type\n   * because some browsers do not have this param in its window.onerror API.\n   * See:\n   * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n   *\n   * @param {!Window} win\n   * @param {function(number, boolean):!LogLevel} levelFunc\n   * @param {string=} opt_suffix\n   */\n  constructor(win, levelFunc, opt_suffix = '') {\n    /**\n     * In tests we use the main test window instead of the iframe where\n     * the tests runs because only the former is relayed to the console.\n     * @const {!Window}\n     */\n    this.win = getMode().test && win.__AMP_TEST_IFRAME ? win.parent : win;\n\n    /** @private @const {function(number, boolean):!LogLevel} */\n    this.levelFunc_ = levelFunc;\n\n    /** @private @const {!LogLevel} */\n    this.level_ = this.defaultLevel_();\n\n    /** @private @const {string} */\n    this.suffix_ = opt_suffix;\n\n    /** @private {?JsonObject} */\n    this.messages_ = null;\n\n    this.fetchExternalMessagesOnce_ = once(() => {\n      win\n        .fetch(externalMessagesSimpleTableUrl())\n        .then((response) => response.json(), noop)\n        .then((opt_messages) => {\n          if (opt_messages) {\n            this.messages_ = /** @type {!JsonObject} */ (opt_messages);\n          }\n        });\n    });\n\n    // This bound assertion function is capable of handling the format used when\n    // error/assertion messages are extracted. This logic hasn't yet been\n    // migrated to an AMP-independent form for use in core. This binding allows\n    // Log assertion helpers to maintain message-extraction capabilities until\n    // that logic can be moved to core.\n    this.boundAssertFn_ = /** @type {!assertions.AssertionFunctionDef} */ (\n      this.assert.bind(this)\n    );\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevel_() {\n    const {win} = this;\n    // No console - can't enable logging.\n    if (\n      !win.console?.log ||\n      // Logging has been explicitly disabled.\n      logHashParam(win) == 0\n    ) {\n      return LogLevel.OFF;\n    }\n\n    // Logging is enabled for tests directly.\n    if (getMode().test && win.ENABLE_LOG) {\n      return LogLevel.FINE;\n    }\n\n    // LocalDev by default allows INFO level, unless overriden by `#log`.\n    if (getMode().localDev) {\n      return LogLevel.INFO;\n    }\n\n    return this.defaultLevelWithFunc_();\n  }\n\n  /**\n   * @param {!Window=} opt_win provided for testing\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevelWithFunc_(opt_win) {\n    // Delegate to the specific resolver.\n    return this.levelFunc_(logHashParam(opt_win), getMode().development);\n  }\n\n  /**\n   * @param {string} tag\n   * @param {!LogLevel} level\n   * @param {!Array} messages\n   * @return {boolean} true if a the message was logged\n   */\n  msg_(tag, level, messages) {\n    if (level > (levelOverride_ ?? this.level_)) {\n      return false;\n    }\n\n    const cs = this.win.console;\n    const fn =\n      {\n        [LogLevel.ERROR]: cs.error,\n        [LogLevel.INFO]: cs.info,\n        [LogLevel.WARN]: cs.warn,\n      }[level] ?? cs.log;\n\n    const args = this.maybeExpandMessageArgs_(messages);\n    // Prefix console message with \"[tag]\".\n    const prefix = `[${tag}]`;\n    if (isString(args[0])) {\n      // Prepend string to avoid breaking string substitutions e.g. %s.\n      args[0] = prefix + ' ' + args[0];\n    } else {\n      args.unshift(prefix);\n    }\n    fn.apply(cs, args);\n\n    return true;\n  }\n\n  /**\n   * Reports a fine-grained message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  fine(tag, ...args) {\n    this.msg_(tag, LogLevel.FINE, args);\n  }\n\n  /**\n   * Reports a informational message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  info(tag, ...args) {\n    this.msg_(tag, LogLevel.INFO, args);\n  }\n\n  /**\n   * Reports a warning message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  warn(tag, ...args) {\n    this.msg_(tag, LogLevel.WARN, args);\n  }\n\n  /**\n   * Reports an error message.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  error(tag, ...args) {\n    if (!this.msg_(tag, LogLevel.ERROR, args)) {\n      const error = this.createError.apply(this, args);\n      error.name = tag || error.name;\n      self.__AMP_REPORT_ERROR?.(error);\n    }\n  }\n\n  /**\n   * Reports an error message and marks with an expected property. If the\n   * logging is disabled, the error is rethrown asynchronously.\n   * @param {string} tag\n   * @param {...*} args\n   */\n  expectedError(tag, ...args) {\n    if (!this.msg_(tag, LogLevel.ERROR, args)) {\n      self.__AMP_REPORT_ERROR?.(this.createExpectedError.apply(this, args));\n    }\n  }\n\n  /**\n   * Creates an error object.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createError(var_args) {\n    return this.setErrorSuffix_(createError.apply(null, arguments));\n  }\n\n  /**\n   * Creates an error object with its expected property set to true.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createExpectedError(var_args) {\n    return this.setErrorSuffix_(createExpectedError.apply(null, arguments));\n  }\n\n  /**\n   * @param {!Error} error\n   * @return {!Error}\n   * @private\n   */\n  setErrorSuffix_(error) {\n    error = duplicateErrorIfNecessary(error);\n\n    if (this.suffix_) {\n      if (!error.message) {\n        error.message = this.suffix_;\n      } else if (error.message.indexOf(this.suffix_) == -1) {\n        error.message += this.suffix_;\n      }\n    } else if (isUserErrorMessage(error.message)) {\n      error.message = stripUserError(error.message);\n    }\n\n    return error;\n  }\n\n  /**\n   * @param {!Array} args\n   * @return {!Array}\n   * @private\n   */\n  maybeExpandMessageArgs_(args) {\n    return isArray(args[0])\n      ? this.expandMessageArgs_(/** @type {!Array} */ (args[0]))\n      : args;\n  }\n\n  /**\n   * Either redirects a pair of (errorId, ...args) to a URL where the full\n   * message is displayed, or displays it from a fetched table.\n   *\n   * This method is used by the output of the `transform-log-methods` babel\n   * plugin. It should not be used directly. Use the (*error|assert*|info|warn)\n   * methods instead.\n   *\n   * @param {!Array} parts\n   * @return {!Array}\n   * @private\n   */\n  expandMessageArgs_(parts) {\n    // First value should exist.\n    const id = parts.shift();\n    // Best effort fetch of message template table.\n    // Since this is async, the first few logs might be indirected to a URL even\n    // if in development mode. Message table is ~small so this should be a short\n    // gap.\n    if (getMode(this.win).development) {\n      this.fetchExternalMessagesOnce_();\n    }\n\n    return this.messages_?.[id]\n      ? [this.messages_[id]].concat(parts)\n      : [`More info at ${externalMessageUrl(id, parts)}`];\n  }\n\n  /**\n   * Throws an error if the first argument isn't trueish.\n   *\n   * Supports argument substitution into the message via %s placeholders.\n   *\n   * Throws an error object that has two extra properties:\n   * - associatedElement: This is the first element provided in the var args.\n   *   It can be used for improved display of error messages.\n   * - messageArray: The elements of the substituted message as non-stringified\n   *   elements in an array. When e.g. passed to console.error this yields\n   *   native displays of things like HTML elements.\n   *\n   * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n   *     not evaluate to true.\n   * @param {!Array|string=} opt_message The assertion message\n   * @param {...*} var_args Arguments substituted into %s in the message.\n   * @return {T} The value of shouldBeTrueish.\n   * @throws {!Error} When `value` is falsey.\n   * @template T\n   * @closurePrimitive {asserts.truthy}\n   */\n  assert(shouldBeTrueish, opt_message, var_args) {\n    if (isArray(opt_message)) {\n      return this.assert.apply(\n        this,\n        [shouldBeTrueish].concat(\n          this.expandMessageArgs_(/** @type {!Array} */ (opt_message))\n        )\n      );\n    }\n\n    return assertions.assert.apply(\n      null,\n      [this.suffix_].concat(Array.prototype.slice.call(arguments))\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't an Element\n   *\n   * Otherwise see `assert` for usage\n   *\n   * @param {*} shouldBeElement\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Element} The value of shouldBeTrueish.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertElement(shouldBeElement, opt_message) {\n    return assertions.assertElement(\n      this.boundAssertFn_,\n      shouldBeElement,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a string. The string can\n   * be empty.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeString\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {string} The string value. Can be an empty string.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertString(shouldBeString, opt_message) {\n    return assertions.assertString(\n      this.boundAssertFn_,\n      shouldBeString,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a number. The allowed values\n   * include `0` and `NaN`.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeNumber\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {number} The number value. The allowed values include `0`\n   *   and `NaN`.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertNumber(shouldBeNumber, opt_message) {\n    return assertions.assertNumber(\n      this.boundAssertFn_,\n      shouldBeNumber,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument is not an array.\n   * The array can be empty.\n   *\n   * @param {*} shouldBeArray\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Array} The array value\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertArray(shouldBeArray, opt_message) {\n    return assertions.assertArray(\n      this.boundAssertFn_,\n      shouldBeArray,\n      opt_message\n    );\n  }\n\n  /**\n   * Throws an error if the first argument isn't a boolean.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeBoolean\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {boolean} The boolean value.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertBoolean(shouldBeBoolean, opt_message) {\n    return assertions.assertBoolean(\n      this.boundAssertFn_,\n      shouldBeBoolean,\n      opt_message\n    );\n  }\n}\n\n/**\n * Cache for logs. We do not use a Service since the service module depends\n * on Log and closure literally can't even.\n * @type {{user: ?Log, dev: ?Log, userForEmbed: ?Log}}\n */\nself.__AMP_LOG = self.__AMP_LOG || {\n  user: null,\n  dev: null,\n  userForEmbed: null,\n};\n\nconst logs = self.__AMP_LOG;\n\n/**\n * Eventually holds a constructor for Log objects. Lazily initialized, so we\n * can avoid ever referencing the real constructor except in JS binaries\n * that actually want to include the implementation.\n * @type {?typeof Log}\n */\nlet logConstructor = null;\n\n/**\n * Initializes log constructor.\n */\nexport function initLogConstructor() {\n  logConstructor = Log;\n  // Initialize instances for use. If a binary (an extension for example) that\n  // does not call `initLogConstructor` invokes `dev()` or `user()` earlier than\n  // the binary that does call `initLogConstructor` (amp.js), the extension will\n  // throw an error as that extension will never be able to initialize the log\n  // instances and we also don't want it to call `initLogConstructor` either\n  // (since that will cause the Log implementation to be bundled into that\n  // binary). So we must initialize the instances eagerly so that they are ready\n  // for use (stored globally) after the main binary calls `initLogConstructor`.\n  dev();\n  user();\n}\n\n/**\n * Resets log constructor for testing.\n */\nexport function resetLogConstructorForTesting() {\n  logConstructor = null;\n}\n\n/**\n * Calls the log constructor with a given level function and suffix.\n * @param {function(number, boolean):!LogLevel} levelFunc\n * @param {string=} opt_suffix\n * @return {!Log}\n */\nfunction callLogConstructor(levelFunc, opt_suffix) {\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return new logConstructor(self, levelFunc, opt_suffix);\n}\n\n/**\n * Publisher level log.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Development mode is enabled via `#development=1` or logging is explicitly\n *     enabled via `#log=D` where D >= 1.\n *  3. AMP.setLogLevel(D) is called, where D >= 1.\n *\n * @param {!Element=} opt_element\n * @return {!Log}\n */\nexport function user(opt_element) {\n  // logs.user must exist first to perform the logs.user.win check below\n  if (!logs.user) {\n    logs.user = getUserLogger(USER_ERROR_SENTINEL);\n  }\n\n  if (isFromEmbed(logs.user.win, opt_element)) {\n    return (\n      logs.userForEmbed ||\n      (logs.userForEmbed = getUserLogger(USER_ERROR_EMBED_SENTINEL))\n    );\n  }\n  return logs.user;\n}\n\n/**\n * Getter for user logger\n * @param {string=} suffix\n * @return {!Log}\n */\nfunction getUserLogger(suffix) {\n  return callLogConstructor(\n    (logNum, development) =>\n      development || logNum >= 1 ? LogLevel.FINE : LogLevel.WARN,\n    suffix\n  );\n}\n\n/**\n * AMP development log. Calls to `devLog().assert` and `dev.fine` are stripped\n * in the PROD binary. However, `devLog().assert` result is preserved in either\n * case.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Logging is explicitly enabled via `#log=D`, where D >= 2.\n *  3. AMP.setLogLevel(D) is called, where D >= 2.\n *\n * @return {!Log}\n */\nexport function dev() {\n  return (\n    logs.dev ||\n    (logs.dev = callLogConstructor((logNum) =>\n      logNum >= 3 ? LogLevel.FINE : logNum >= 2 ? LogLevel.INFO : LogLevel.OFF\n    ))\n  );\n}\n\n/**\n * @param {!Window} win\n * @param {!Element=} opt_element\n * @return {boolean} isEmbed\n */\nfunction isFromEmbed(win, opt_element) {\n  return opt_element && opt_element.ownerDocument.defaultView != win;\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function devAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  if (mode.isMinified()) {\n    return shouldBeTrueish;\n  }\n  if (self.__AMP_ASSERTION_CHECK) {\n    // This will never execute regardless, but will be included on unminified\n    // builds. It will be DCE'd away from minified builds, and so can be used to\n    // validate that Babel is properly removing dev assertions in minified\n    // builds.\n    console /*OK*/\n      .log('__devAssert_sentinel__');\n  }\n\n  return dev()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {T} The value of shouldBeTrueish.\n * @throws {!Error} When `shouldBeTrueish` is falsey.\n * @template T\n * @closurePrimitive {asserts.truthy}\n */\nexport function userAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  return user()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n", "/**\n * @fileoverview Registration and getter functions for AMP services.\n *\n * Invariant: Service getters never return null for registered services.\n */\n\nimport {Deferred} from '#core/data-structures/promise';\nimport {getWin} from '#core/window';\n\nimport {dev, devAssert} from '#utils/log';\n\n/**\n * Holds info about a service.\n * - obj: Actual service implementation when available.\n * - promise: Promise for the obj.\n * - resolve: Function to resolve the promise with the object.\n * - context: Argument for ctor, either a window or an ampdoc.\n * - ctor: Function that constructs and returns the service.\n * @typedef {{\n *   obj: (?Object),\n *   promise: (?Promise),\n *   resolve: (?function(!Object)),\n *   reject: (?function((*))),\n *   context: (?Window|?./service/ampdoc-impl.AmpDoc),\n *   ctor: (function(new:Object, !Window)|\n *          function(new:Object, !./service/ampdoc-impl.AmpDoc)),\n * }}\n */\nlet ServiceHolderDef;\n\n/**\n * This interface provides a `dispose` method that will be called by\n * runtime when a service needs to be disposed of.\n * @interface\n */\nexport class Disposable {\n  /**\n   * Instructs the service to release any resources it might be holding. Can\n   * be called only once in the lifecycle of a service.\n   */\n  dispose() {}\n}\n\n/**\n * Installs a service override on amp-doc level.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n * @param {!Object} service The service.\n */\nexport function installServiceInEmbedDoc(ampdoc, id, service) {\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    function () {\n      return service;\n    },\n    /* override */ true\n  );\n}\n\n/**\n * Installs a service override in the scope of an embedded window.\n * @param {!Window} embedWin\n * @param {string} id\n * @param {function(new:Object, !Window)} constructor\n */\nexport function registerServiceBuilderInEmbedWin(embedWin, id, constructor) {\n  registerServiceInternal(\n    embedWin,\n    embedWin,\n    id,\n    constructor,\n    /* override */ true\n  );\n}\n\n/**\n * Registers a service given a class to be used as implementation.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {function(new:Object, !Window)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilder(win, id, constructor, opt_instantiate) {\n  win = getTopWindow(win);\n  registerServiceInternal(win, win, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(win, id);\n  }\n}\n\n/**\n * Returns a service and registers it given a class to be used as\n * implementation.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id of the service.\n * @param {function(new:Object, !./service/ampdoc-impl.AmpDoc)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilderForDoc(\n  nodeOrDoc,\n  id,\n  constructor,\n  opt_instantiate\n) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  registerServiceInternal(holder, ampdoc, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * Reject a service promise.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id\n * @param {*} error\n */\nexport function rejectServicePromiseForDoc(nodeOrDoc, id, error) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  rejectServicePromiseInternal(holder, id, error);\n}\n\n/**\n * Returns a service for the given id and window (a per-window singleton). Users\n * should typically wrap this as a special purpose function (e.g.\n * `Services.vsyncFor(win)`) for type safety and because the factory should not\n * be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\nexport function getService(win, id) {\n  win = getTopWindow(win);\n  return getServiceInternal(win, id);\n}\n\n/**\n * Returns a service for the given id and window (a per-window singleton). But\n * it looks in the immediate window scope, not the top-level window.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\nexport function getServiceInEmbedWin(win, id) {\n  return getServiceInternal(win, id);\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. `Services.vsyncFor(win)`) for type safety and because the\n * factory should not be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nexport function getServicePromise(win, id) {\n  return getServicePromiseInternal(win, id);\n}\n\n/**\n * Returns a service or null with the given id.\n * @param {!Window} win\n * @param {string} id\n * @return {?Object} The service.\n */\nexport function getExistingServiceOrNull(win, id) {\n  win = getTopWindow(win);\n  if (isServiceRegistered(win, id)) {\n    return getServiceInternal(win, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Like getServicePromise but returns null if the service was never registered.\n * @param {!Window} win\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNull(win, id) {\n  return getServicePromiseOrNullInternal(win, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * Expects service `id` to be registered.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {T}\n * @template T\n */\nexport function getServiceForDoc(elementOrAmpDoc, id) {\n  const ampdoc = getAmpdoc(elementOrAmpDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  return getServiceInternal(holder, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * If service `id` is not registered, returns null.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Object}\n */\nexport function getServiceForDocOrNull(elementOrAmpDoc, id) {\n  const ampdoc = getAmpdoc(elementOrAmpDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  if (isServiceRegistered(holder, id)) {\n    return getServiceInternal(holder, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Returns a promise for a service for the given id and ampdoc. Also expects\n * a service that has the actual implementation. The promise resolves when\n * the implementation loaded.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {!Promise<!Object>}\n */\nexport function getServicePromiseForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseInternal(getAmpdocServiceHolder(elementOrAmpDoc), id);\n}\n\n/**\n * Like getServicePromiseForDoc but returns null if the service was never\n * registered for this ampdoc.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNullForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseOrNullInternal(\n    getAmpdocServiceHolder(elementOrAmpDoc),\n    id\n  );\n}\n\n/**\n * Set the parent and top windows on a child window (friendly iframe).\n * @param {!Window} win\n * @param {!Window} parentWin\n */\nexport function setParentWindow(win, parentWin) {\n  win.__AMP_PARENT = parentWin;\n  win.__AMP_TOP = getTopWindow(parentWin);\n}\n\n/**\n * Returns the parent window for a child window (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getParentWindow(win) {\n  return win.__AMP_PARENT || win;\n}\n\n/**\n * Returns the top window where AMP Runtime is installed for a child window\n * (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getTopWindow(win) {\n  return win.__AMP_TOP || (win.__AMP_TOP = win);\n}\n\n/**\n * Returns the parent \"friendly\" iframe if the node belongs to a child window.\n * @param {!Node} node\n * @param {!Window=} opt_topWin\n * @return {?HTMLIFrameElement}\n */\nexport function getParentWindowFrameElement(node, opt_topWin) {\n  const childWin = (node.ownerDocument || node).defaultView;\n  const topWin = opt_topWin || getTopWindow(childWin);\n  if (childWin && childWin != topWin && getTopWindow(childWin) == topWin) {\n    try {\n      return /** @type {?HTMLIFrameElement} */ (childWin.frameElement);\n    } catch (e) {\n      // Ignore the error.\n    }\n  }\n  return null;\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc}\n */\nexport function getAmpdoc(nodeOrDoc) {\n  if (nodeOrDoc.nodeType) {\n    const win = getWin(nodeOrDoc);\n    return getAmpdocService(win).getAmpDoc(/** @type {!Node} */ (nodeOrDoc));\n  }\n  return /** @type {!./service/ampdoc-impl.AmpDoc} */ (nodeOrDoc);\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc|!Window}\n */\nfunction getAmpdocServiceHolder(nodeOrDoc) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  return ampdoc.isSingleDoc() ? ampdoc.win : ampdoc;\n}\n\n/**\n * This is essentially a duplicate of `ampdoc.js`, but necessary to avoid\n * circular dependencies.\n * @param {!Window} win\n * @return {!./service/ampdoc-impl.AmpDocService}\n */\nfunction getAmpdocService(win) {\n  return /** @type {!./service/ampdoc-impl.AmpDocService} */ (\n    getService(win, 'ampdoc')\n  );\n}\n\n/**\n * Get service `id` from `holder`. Assumes the service\n * has already been registered.\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {Object}\n */\nfunction getServiceInternal(holder, id) {\n  devAssert(\n    isServiceRegistered(holder, id),\n    `Expected service ${id} to be registered`\n  );\n  const services = getServices(holder);\n  const s = services[id];\n  if (!s.obj) {\n    devAssert(s.ctor, `Service ${id} registered without ctor nor impl.`);\n    devAssert(s.context, `Service ${id} registered without context.`);\n    s.obj = new s.ctor(s.context);\n    devAssert(s.obj, `Service ${id} constructed to null.`);\n    s.context = null;\n    // The service may have been requested already, in which case we have a\n    // pending promise we need to fulfill.\n    if (s.resolve) {\n      s.resolve(s.obj);\n    }\n  }\n  return s.obj;\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {!Window|!./service/ampdoc-impl.AmpDoc} context Win or AmpDoc.\n * @param {string} id of the service.\n * @param {?function(new:Object, !Window)|?function(new:Object, !./service/ampdoc-impl.AmpDoc)} ctor Constructor function to new the service. Called with context.\n * @param {boolean=} opt_override\n * @param {boolean=} opt_sharedInstance\n */\nfunction registerServiceInternal(\n  holder,\n  context,\n  id,\n  ctor,\n  opt_override,\n  opt_sharedInstance\n) {\n  const services = getServices(holder);\n  let s = services[id];\n\n  if (!s) {\n    s = services[id] = {\n      obj: null,\n      promise: null,\n      resolve: null,\n      reject: null,\n      context: null,\n      ctor: null,\n      sharedInstance: opt_sharedInstance || false,\n    };\n  }\n\n  if (!opt_override && s.ctor) {\n    // Service already registered.\n    return;\n  }\n\n  s.ctor = ctor;\n  s.context = context;\n  s.sharedInstance = opt_sharedInstance || false;\n\n  // The service may have been requested already, in which case there is a\n  // pending promise that needs to fulfilled.\n  if (s.resolve) {\n    // getServiceInternal will resolve the promise.\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nfunction getServicePromiseInternal(holder, id) {\n  const cached = getServicePromiseOrNullInternal(holder, id);\n  if (cached) {\n    return cached;\n  }\n  // Service is not registered.\n\n  // TODO(@cramforce): Add a check that if the element is eventually registered\n  // that the service is actually provided and this promise resolves.\n  const services = getServices(holder);\n  services[id] = emptyServiceHolderWithPromise();\n  return /** @type {!Promise<!Object>} */ (services[id].promise);\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @param {*} error\n */\nfunction rejectServicePromiseInternal(holder, id, error) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.reject) {\n      s.reject(error);\n    }\n    return;\n  }\n\n  services[id] = emptyServiceHolderWithPromise();\n  services[id].reject(error);\n}\n\n/**\n * Returns a promise for service `id` if the service has been registered\n * on `holder`.\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {?Promise<!Object>}\n */\nfunction getServicePromiseOrNullInternal(holder, id) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.promise) {\n      return s.promise;\n    } else {\n      // Instantiate service if not already instantiated.\n      getServiceInternal(holder, id);\n      return (s.promise = Promise.resolve(/** @type {!Object} */ (s.obj)));\n    }\n  }\n  return null;\n}\n\n/**\n * Returns the object that holds the services registered in a holder.\n * @param {!Object} holder\n * @return {!Object<string,!ServiceHolderDef>}\n */\nfunction getServices(holder) {\n  let services = holder.__AMP_SERVICES;\n  if (!services) {\n    services = holder.__AMP_SERVICES = {};\n  }\n  return services;\n}\n\n/**\n * Whether the specified service implements `Disposable` interface.\n * @param {!Object} service\n * @return {boolean}\n */\nexport function isDisposable(service) {\n  return typeof service.dispose == 'function';\n}\n\n/**\n * Asserts that the specified service implements `Disposable` interface and\n * typecasts the instance to `Disposable`.\n * @param {!Object} service\n * @return {!Disposable}\n */\nexport function assertDisposable(service) {\n  devAssert(isDisposable(service), 'required to implement Disposable');\n  return /** @type {!Disposable} */ (service);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * ampdoc scope.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function disposeServicesForDoc(ampdoc) {\n  disposeServicesInternal(ampdoc);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * embed scope.\n * @param {!Window} embedWin\n */\nexport function disposeServicesForEmbed(embedWin) {\n  disposeServicesInternal(embedWin);\n}\n\n/**\n * @param {!Object} holder Object holding the service instances.\n */\nfunction disposeServicesInternal(holder) {\n  const services = getServices(holder);\n  for (const id in services) {\n    if (!Object.prototype.hasOwnProperty.call(services, id)) {\n      continue;\n    }\n    const serviceHolder = services[id];\n    if (serviceHolder.sharedInstance) {\n      continue;\n    }\n    if (serviceHolder.obj) {\n      disposeServiceInternal(id, serviceHolder.obj);\n    } else if (serviceHolder.promise) {\n      serviceHolder.promise.then((instance) =>\n        disposeServiceInternal(id, instance)\n      );\n    }\n  }\n}\n\n/**\n * @param {string} id\n * @param {!Object} service\n */\nfunction disposeServiceInternal(id, service) {\n  if (!isDisposable(service)) {\n    return;\n  }\n  try {\n    assertDisposable(service).dispose();\n  } catch (e) {\n    // Ensure that a failure to dispose a service does not disrupt other\n    // services.\n    dev().error('SERVICE', 'failed to dispose service', id, e);\n  }\n}\n\n/**\n * This adopts the service **instance** from the parent.\n *\n * This function is dangerous! Sharing an instance means data can leak to and\n * from a child ampdoc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\nexport function adoptServiceForEmbedDoc(ampdoc, id) {\n  const service = getServiceInternal(\n    getAmpdocServiceHolder(devAssert(ampdoc.getParent())),\n    id\n  );\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    function () {\n      return service;\n    },\n    /* override */ false,\n    /* sharedInstance */ true\n  );\n}\n\n/**\n * This adopts the service **factory** from the parent.\n *\n * This function is safer than sharing the service instance, since each ampdoc\n * will create its own instance of the factory (and each instance will have its\n * own instance data). Note that static data is still shared, so it's not 100%\n * foolproof.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\nexport function adoptServiceFactoryForEmbedDoc(ampdoc, id) {\n  const parentHolder = getAmpdocServiceHolder(devAssert(ampdoc.getParent()));\n  devAssert(\n    isServiceRegistered(parentHolder, id),\n    `Expected service ${id} to be registered`\n  );\n  const service = getServices(parentHolder)[id];\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    devAssert(service.ctor)\n  );\n}\n\n/**\n * Resets a single service, so it gets recreated on next getService invocation.\n * @param {!Object} holder\n * @param {string} id of the service.\n */\nexport function resetServiceForTesting(holder, id) {\n  if (holder.__AMP_SERVICES) {\n    holder.__AMP_SERVICES[id] = null;\n  }\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {boolean}\n */\nfunction isServiceRegistered(holder, id) {\n  const service = holder.__AMP_SERVICES && holder.__AMP_SERVICES[id];\n  // All registered services must have a constructor.\n  return !!(service && service.ctor);\n}\n\n/** @return {!ServiceHolderDef} */\nfunction emptyServiceHolderWithPromise() {\n  const deferred = new Deferred();\n  const {promise, reject, resolve} = deferred;\n  promise.catch(() => {}); // avoid uncaught exception when service gets rejected\n  return {\n    obj: null,\n    promise,\n    resolve,\n    reject,\n    context: null,\n    ctor: null,\n  };\n}\n", "/**\n * Externs declare that access `defaultView` from `document` or\n * `ownerDocument` is of type `(Window|null)` but most of our parameter types\n * assume that it is never null. This is OK in practice as we ever only get\n * null on disconnected documents or old IE.\n * This helper function casts it into just a simple Window return type.\n *\n * @param {?Window} winOrNull\n * @return {!Window}\n */\nexport function toWin(winOrNull) {\n  return /** @type {!Window} */ (winOrNull);\n}\n\n/**\n * Returns the associated Window for a node.\n *\n * @param {!Node} node\n * @return {!Window}\n */\nexport function getWin(node) {\n  return toWin(\n    (node.ownerDocument || /** @type {!Document} */ (node)).defaultView\n  );\n}\n", "/**\n * @fileoverview Experiments system allows a developer to opt-in to test\n * features that are not yet fully tested.\n *\n * Experiments page: https://cdn.ampproject.org/experiments.html *\n */\n\nimport {isArray} from '#core/types';\nimport {hasOwn, map} from '#core/types/object';\nimport {parseJson} from '#core/types/object/json';\nimport {parseQueryString} from '#core/types/string/url';\n\nimport {dev, user} from '#utils/log';\n\nimport {ExperimentInfoDef} from './experiments.type';\n\nimport {getMode} from '../mode';\nimport {getTopWindow} from '../service-helpers';\n\n/** @const {string} */\nconst TAG = 'EXPERIMENTS';\n\n/** @const {string} */\nconst LOCAL_STORAGE_KEY = 'amp-experiment-toggles';\n\n/** @const {string} */\nconst TOGGLES_WINDOW_PROPERTY = '__AMP__EXPERIMENT_TOGGLES';\n\n/**\n * Whether we are in canary.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isCanary(win) {\n  return !!win.AMP_CONFIG?.canary;\n}\n\n/**\n * Returns binary type, e.g., canary, production, control, or rc.\n * @param {!Window} win\n * @return {string}\n */\nexport function getBinaryType(win) {\n  return win.AMP_CONFIG?.type || 'unknown';\n}\n\n/**\n * Whether the specified experiment is on or off.\n * @param {!Window} win\n * @param {string} experimentId\n * @return {boolean}\n */\nexport function isExperimentOn(win, experimentId) {\n  const toggles = experimentToggles(win);\n  return !!toggles[experimentId];\n}\n\n/**\n * Toggles the experiment on or off. Returns the actual value of the experiment\n * after toggling is done.\n * @param {!Window} win\n * @param {string} experimentId\n * @param {boolean=} opt_on\n * @param {boolean=} opt_transientExperiment  Whether to toggle the\n *     experiment state \"transiently\" (i.e., for this page load only) or\n *     durably (by saving the experiment IDs after toggling).\n *     Default: false (save durably).\n * @return {boolean} New state for experimentId.\n */\nexport function toggleExperiment(\n  win,\n  experimentId,\n  opt_on,\n  opt_transientExperiment\n) {\n  const currentlyOn = isExperimentOn(win, /*OK*/ experimentId);\n  const on = opt_on ?? !currentlyOn;\n  if (on != currentlyOn) {\n    const toggles = experimentToggles(win);\n    toggles[experimentId] = on;\n\n    if (!opt_transientExperiment) {\n      const storedToggles = getExperimentToggles(win);\n      storedToggles[experimentId] = on;\n      saveExperimentToggles(win, storedToggles);\n      // Avoid affecting tests that spy/stub warn().\n      if (!getMode().test) {\n        user().warn(\n          TAG,\n          '\"%s\" experiment %s for the domain \"%s\". See: https://amp.dev/documentation/guides-and-tutorials/learn/experimental',\n          experimentId,\n          on ? 'enabled' : 'disabled',\n          win.location.hostname\n        );\n      }\n    }\n  }\n  return on;\n}\n\n/**\n * Calculate whether the experiment is on or off based off of its default value,\n * stored overriden value, or the global config frequency given.\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n */\nexport function experimentToggles(win) {\n  if (win[TOGGLES_WINDOW_PROPERTY]) {\n    return win[TOGGLES_WINDOW_PROPERTY];\n  }\n  win[TOGGLES_WINDOW_PROPERTY] = map();\n  const toggles = win[TOGGLES_WINDOW_PROPERTY];\n\n  // Read default and injected configs of this build.\n  const buildExperimentConfigs = {\n    ...(win.AMP_CONFIG ?? {}),\n    ...(win.AMP_EXP ?? parseJson(win.__AMP_EXP?.textContent || '{}')),\n  };\n  for (const experimentId in buildExperimentConfigs) {\n    const frequency = buildExperimentConfigs[experimentId];\n    if (typeof frequency === 'number' && frequency >= 0 && frequency <= 1) {\n      toggles[experimentId] = Math.random() < frequency;\n    }\n  }\n  // Read document level override from meta tag.\n  const allowedDocOptIn = win.AMP_CONFIG?.['allow-doc-opt-in'];\n  if (isArray(allowedDocOptIn) && allowedDocOptIn.length) {\n    const meta = win.document.head.querySelector(\n      'meta[name=\"amp-experiments-opt-in\"]'\n    );\n    if (meta) {\n      const optedInExperiments = meta.getAttribute('content').split(',');\n      for (const experiment of optedInExperiments) {\n        if (dev().assertArray(allowedDocOptIn).includes(experiment)) {\n          toggles[experiment] = true;\n        }\n      }\n    }\n  }\n\n  Object.assign(toggles, getExperimentToggles(win));\n\n  const allowedUrlOptIn = win.AMP_CONFIG?.['allow-url-opt-in'];\n  if (isArray(allowedUrlOptIn) && allowedUrlOptIn.length) {\n    const hash = win.location['originalHash'] || win.location.hash;\n    const params = parseQueryString(hash);\n    for (const experiment of allowedUrlOptIn) {\n      const param = params[`e-${experiment}`];\n      if (param == '1') {\n        toggles[experiment] = true;\n      }\n      if (param == '0') {\n        toggles[experiment] = false;\n      }\n    }\n  }\n  return toggles;\n}\n\n/**\n * Returns the cached experiments toggles, or null if they have not been\n * computed yet.\n * @param {!Window} win\n * @return {?Object<string, boolean>}\n */\nexport function experimentTogglesOrNull(win) {\n  return win[TOGGLES_WINDOW_PROPERTY] || null;\n}\n\n/**\n * Returns a set of experiment IDs currently on.\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n */\nfunction getExperimentToggles(win) {\n  let experimentsString = '';\n  try {\n    if ('localStorage' in win) {\n      experimentsString = win.localStorage.getItem(LOCAL_STORAGE_KEY);\n    }\n  } catch {\n    dev().warn(TAG, 'Failed to retrieve experiments from localStorage.');\n  }\n  const tokens = experimentsString?.split(/\\s*,\\s*/g) || [];\n\n  const toggles = map();\n  for (const token of tokens) {\n    if (!token) {\n      continue;\n    }\n    if (token[0] == '-') {\n      toggles[token.substr(1)] = false;\n    } else {\n      toggles[token] = true;\n    }\n  }\n  return toggles;\n}\n\n/**\n * Saves a set of experiment IDs currently on.\n * @param {!Window} win\n * @param {!Object<string, boolean>} toggles\n */\nfunction saveExperimentToggles(win, toggles) {\n  const experimentIds = [];\n  for (const experiment in toggles) {\n    experimentIds.push((toggles[experiment] === false ? '-' : '') + experiment);\n  }\n  try {\n    win.localStorage?.setItem(LOCAL_STORAGE_KEY, experimentIds.join(','));\n  } catch (e) {\n    user().error(TAG, 'Failed to save experiments to localStorage.');\n  }\n}\n\n/**\n * See getExperimentToggles().\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n * @visibleForTesting\n */\nexport function getExperimentTogglesForTesting(win) {\n  return getExperimentToggles(win);\n}\n\n/**\n * Resets the experimentsToggle cache for testing purposes.\n * @param {!Window} win\n * @visibleForTesting\n */\nexport function resetExperimentTogglesForTesting(win) {\n  saveExperimentToggles(win, {});\n  win[TOGGLES_WINDOW_PROPERTY] = null;\n}\n\n/**\n * In some browser implementations of Math.random(), sequential calls of\n * Math.random() are correlated and can cause a bias.  In particular,\n * if the previous random() call was < 0.001 (as it will be if we select\n * into an experiment), the next value could be less than 0.5 more than\n * 50.7% of the time.  This provides an implementation that roots down into\n * the crypto API, when available, to produce less biased samples.\n *\n * @return {number} Pseudo-random floating-point value on the range [0, 1).\n */\nfunction slowButAccuratePrng() {\n  // TODO(tdrl): Implement.\n  return Math.random();\n}\n\n/**\n * Container for alternate random number generator implementations.  This\n * allows us to set an \"accurate\" PRNG for branch selection, but to mock it\n * out easily in tests.\n *\n * @visibleForTesting\n * @const {!{accuratePrng: function():number}}\n */\nexport const RANDOM_NUMBER_GENERATORS = {\n  accuratePrng: slowButAccuratePrng,\n};\n\n/**\n * Selects, uniformly at random, a single item from the array.\n * @param {!Array<string>} arr Object to select from.\n * @return {?string} Single item from arr or null if arr was empty.\n */\nfunction selectRandomItem(arr) {\n  const rn = RANDOM_NUMBER_GENERATORS.accuratePrng();\n  return dev().assertString(arr[Math.floor(rn * arr.length)]) || null;\n}\n\n/**\n * Selects which page-level experiment branches are enabled. If a given\n * experiment name is already set (including to the null / no branches selected\n * state), this won't alter its state.\n *\n * Check whether a given experiment is set using isExperimentOn(win,\n * experimentName) and, if it is on, look for which branch is selected in\n * win.__AMP_EXPERIMENT_BRANCHES[experimentName].\n *\n * @param {!Window} win Window context on which to save experiment\n *     selection state.\n * @param {!Array<!ExperimentInfoDef>} experiments  Set of experiments to\n *     configure for this page load.\n * @return {!Object<string, string>} Map of experiment names to selected\n *     branches.\n */\nexport function randomlySelectUnsetExperiments(win, experiments) {\n  win.__AMP_EXPERIMENT_BRANCHES = win.__AMP_EXPERIMENT_BRANCHES || {};\n  const selectedExperiments = {};\n  for (const experiment of experiments) {\n    const experimentName = experiment.experimentId;\n    if (hasOwn(win.__AMP_EXPERIMENT_BRANCHES, experimentName)) {\n      selectedExperiments[experimentName] =\n        win.__AMP_EXPERIMENT_BRANCHES[experimentName];\n      continue;\n    }\n\n    if (!experiment.isTrafficEligible?.(win)) {\n      win.__AMP_EXPERIMENT_BRANCHES[experimentName] = null;\n      continue;\n    }\n\n    // If we're in the experiment, but we haven't already forced a specific\n    // experiment branch (e.g., via a test setup), then randomize the branch\n    // choice.\n    if (\n      !win.__AMP_EXPERIMENT_BRANCHES[experimentName] &&\n      isExperimentOn(win, /*OK*/ experimentName)\n    ) {\n      win.__AMP_EXPERIMENT_BRANCHES[experimentName] = selectRandomItem(\n        experiment.branches\n      );\n      selectedExperiments[experimentName] =\n        win.__AMP_EXPERIMENT_BRANCHES[experimentName];\n    }\n  }\n  return selectedExperiments;\n}\n\n/**\n * Returns the experiment branch enabled for the given experiment ID.\n * For example, 'control' or 'experiment'.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @param {string} experimentName Name of the experiment to check.\n * @return {?string} Active experiment branch ID for experimentName (possibly\n *     null if experimentName has been tested but no branch was enabled).\n */\nexport function getExperimentBranch(win, experimentName) {\n  return win.__AMP_EXPERIMENT_BRANCHES\n    ? win.__AMP_EXPERIMENT_BRANCHES[experimentName]\n    : null;\n}\n\n/**\n * Returns an object containing all active experiment branches on the\n * top Window.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @return {!Object} contains all experiment branches and their ids.\n */\nexport function getActiveExperimentBranches(win) {\n  const topWin = getTopWindow(win);\n  if (!topWin.__AMP_EXPERIMENT_BRANCHES) {\n    topWin.__AMP_EXPERIMENT_BRANCHES = {};\n  }\n  return {...topWin.__AMP_EXPERIMENT_BRANCHES};\n}\n\n/**\n * Force enable (or disable) a specific branch of a given experiment name.\n * Disables the experiment name altogether if branchId is falseish.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @param {string} experimentName Name of the experiment to check.\n * @param {?string} branchId ID of branch to force or null to disable\n *     altogether.\n * @visibleForTesting\n */\nexport function forceExperimentBranch(win, experimentName, branchId) {\n  win.__AMP_EXPERIMENT_BRANCHES = win.__AMP_EXPERIMENT_BRANCHES || {};\n  toggleExperiment(win, experimentName, !!branchId, true);\n  win.__AMP_EXPERIMENT_BRANCHES[experimentName] = branchId;\n}\n", "/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */\n\n\n/**\n * This regex consists of 4 matching capture groups and one (non-matching) fallback:\n *\n * - (\\0), catch the null terminator character so it may be replaced by UTF\n *   Replacement Char\n * - ^(-)$, catch a solitary dash char, so that it may be backslash escaped.\n *   This is a separate capture group so that the legal-chars (group 4) doesn't\n *   capture it first, since that group doesn't need to escape its dash.\n * - ([\\x01-\\x1f\\x7f]|^-?[0-9]), catch a UTF control char, or any leading\n *   number (with an optional leading dash). The control or the number (but not\n *   the leading dash) must be hex-escaped,.\n * - ([\\x80-\\uffff0-9a-zA-Z_-]+), catch legal-chars, with the exception of a\n *   solitary dash, which will already have matched in group 1.\n * - [^], finally, a catch-all that allows us to backslash escape the char.\n *\n * Together, this matches everything necessary for CSS.escape.\n */\nvar regex = /(\\0)|^(-)$|([\\x01-\\x1f\\x7f]|^-?[0-9])|([\\x80-\\uffff0-9a-zA-Z_-]+)|[^]/g;\n\nfunction escaper(match, nil, dash, hexEscape, chars) {\n  // Chars is the legal-chars (group 4) capture\n  if (chars) {\n    return chars;\n  }\n  // Nil is the null terminator (group 1) capture\n  if (nil) {\n    return '\\uFFFD';\n  }\n  // Both UTF control chars, and leading numbers (with optional leading dash)\n  // (group 3) must be backslash escaped with a trailing space.  Funnily, the\n  // leading dash must not be escaped, but the number. :shrug:\n  if (hexEscape) {\n    return match.slice(0, -1) + '\\\\' + match.slice(-1).charCodeAt(0).toString(16) + ' '\n  }\n  // Finally, the solitary dash and the catch-all chars require backslash\n  // escaping.\n  return '\\\\' + match;\n}\n\n/**\n * https://drafts.csswg.org/cssom/#serialize-an-identifier\n * @param {string} value\n * @return {string}\n */\nexport function cssEscape(value) {\n  return String(value).replace(regex, escaper);\n}\n", "import * as mode from '#core/mode';\nimport {dict} from '#core/types/object';\nimport {parseJson} from '#core/types/object/json';\nimport {getWin} from '#core/window';\n\nimport {childElementsByTag, matches} from './query';\n\nconst HTML_ESCAPE_CHARS = {\n  '&': '&amp;',\n  '<': '&lt;',\n  '>': '&gt;',\n  '\"': '&quot;',\n  \"'\": '&#x27;',\n  '`': '&#x60;',\n};\nconst HTML_ESCAPE_REGEX = /(&|<|>|\"|'|`)/g;\n\n/**\n * @typedef {{\n *   bubbles: (boolean|undefined),\n *   cancelable: (boolean|undefined),\n * }}\n */\nexport let CustomEventOptionsDef;\n\n/** @const {!CustomEventOptionsDef} */\nconst DEFAULT_CUSTOM_EVENT_OPTIONS = {bubbles: true, cancelable: true};\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * callback is executed.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @param {function()} callback\n */\nexport function waitForChild(parent, checkFunc, callback) {\n  if (checkFunc(parent)) {\n    callback();\n    return;\n  }\n  const win = getWin(parent);\n  if (mode.isEsm() || win.MutationObserver) {\n    const observer = new win.MutationObserver(() => {\n      if (checkFunc(parent)) {\n        observer.disconnect();\n        callback();\n      }\n    });\n    observer.observe(parent, {childList: true});\n  } else {\n    const interval = win.setInterval(() => {\n      if (checkFunc(parent)) {\n        win.clearInterval(interval);\n        callback();\n      }\n    }, /* milliseconds */ 5);\n  }\n}\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * promise is resolved.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @return {!Promise}\n */\nexport function waitForChildPromise(parent, checkFunc) {\n  return new Promise((resolve) => {\n    waitForChild(parent, checkFunc, resolve);\n  });\n}\n\n/**\n * Waits for document's body to be available and ready.\n * @param {!Document} doc\n * @param {function()} callback\n */\nexport function waitForBodyOpen(doc, callback) {\n  waitForChild(doc.documentElement, () => !!doc.body, callback);\n}\n\n/**\n * Waits for document's body to be available.\n * @param {!Document} doc\n * @return {!Promise}\n */\nexport function waitForBodyOpenPromise(doc) {\n  return new Promise((resolve) => waitForBodyOpen(doc, resolve));\n}\n\n/**\n * Removes the element.\n * @param {!Element} element\n */\nexport function removeElement(element) {\n  element.parentElement?.removeChild(element);\n}\n\n/**\n * Removes all child nodes of the specified element.\n * @param {!Element|!DocumentFragment} parent\n */\nexport function removeChildren(parent) {\n  while (parent.firstChild) {\n    parent.removeChild(parent.firstChild);\n  }\n}\n\n/**\n * Copies all children nodes of element \"from\" to element \"to\". Child nodes\n * are deeply cloned. Notice, that this method should be used with care and\n * preferably on smaller subtrees.\n * @param {!Element} from\n * @param {!Element|!DocumentFragment} to\n */\nexport function copyChildren(from, to) {\n  const frag = to.ownerDocument.createDocumentFragment();\n  for (let n = from.firstChild; n; n = n.nextSibling) {\n    frag.appendChild(n.cloneNode(true));\n  }\n  to.appendChild(frag);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n * @param {?Node=} after\n */\nexport function insertAfterOrAtStart(root, element, after = null) {\n  if (!after) {\n    insertAtStart(root, element);\n    return;\n  }\n  const before = after.nextSibling;\n  root.insertBefore(element, before);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n */\nexport function insertAtStart(root, element) {\n  root.insertBefore(element, root.firstChild);\n}\n\n/**\n * Add attributes to an element.\n * @param {!Element} element\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function addAttributesToElement(element, attributes) {\n  for (const attr in attributes) {\n    element.setAttribute(attr, attributes[attr]);\n  }\n  return element;\n}\n\n/**\n * Create a new element on document with specified tagName and attributes.\n * @param {!Document} doc\n * @param {string} tagName\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function createElementWithAttributes(doc, tagName, attributes) {\n  const element = doc.createElement(tagName);\n  return addAttributesToElement(element, attributes);\n}\n\n/**\n * Returns true if node is connected (attached).\n * @param {!Node} node\n * @return {boolean}\n * @see https://dom.spec.whatwg.org/#connected\n */\nexport function isConnectedNode(node) {\n  const connected = node.isConnected;\n  if (connected !== undefined) {\n    return connected;\n  }\n\n  // \"An element is connected if its shadow-including root is a document.\"\n  let n = node;\n  do {\n    n = rootNodeFor(n);\n    if (n.host) {\n      n = n.host;\n    } else {\n      break;\n    }\n  } while (true);\n  return n.nodeType === Node.DOCUMENT_NODE;\n}\n\n/**\n * Returns the root for a given node. Does not cross shadow DOM boundary.\n * @param {!Node} node\n * @return {!Node}\n */\nexport function rootNodeFor(node) {\n  if (Node.prototype.getRootNode) {\n    // Type checker says `getRootNode` may return null.\n    return node.getRootNode() || node;\n  }\n  let n;\n  // Check isShadowRoot() is only needed for the polyfill case.\n  for (\n    n = node;\n    !!n.parentNode && !isShadowRoot(/** @type {HTMLElement} */ (n));\n    n = n.parentNode\n  ) {}\n  return n;\n}\n\n/**\n * Determines if value is actually a `ShadowRoot` node.\n * @param {?HTMLElement} value\n * @return {boolean}\n */\nexport function isShadowRoot(value) {\n  if (!value) {\n    return false;\n  }\n  // Node.nodeType == DOCUMENT_FRAGMENT to speed up the tests. Unfortunately,\n  // nodeType of DOCUMENT_FRAGMENT is used currently for ShadowRoot nodes.\n  if (value.tagName == 'I-AMPHTML-SHADOW-ROOT') {\n    return true;\n  }\n  return (\n    value.nodeType == /* DOCUMENT_FRAGMENT */ 11 &&\n    Object.prototype.toString.call(value) === '[object ShadowRoot]'\n  );\n}\n\n/**\n * Returns element data-param- attributes as url parameters key-value pairs.\n * e.g. data-param-some-attr=value -> {someAttr: value}.\n * @param {!HTMLElement} element\n * @param {function(string):string=} opt_computeParamNameFunc to compute the\n *    parameter name, get passed the camel-case parameter name.\n * @param {!RegExp=} opt_paramPattern Regex pattern to match data attributes.\n * @return {!JsonObject}\n */\nexport function getDataParamsFromAttributes(\n  element,\n  opt_computeParamNameFunc,\n  opt_paramPattern\n) {\n  const computeParamNameFunc = opt_computeParamNameFunc || ((key) => key);\n  const {dataset} = element;\n  const params = dict();\n  const paramPattern = opt_paramPattern || /^param(.+)/;\n  for (const key in dataset) {\n    const matches = key.match(paramPattern);\n    if (matches) {\n      const param = matches[1][0].toLowerCase() + matches[1].substr(1);\n      params[computeParamNameFunc(param)] = dataset[key];\n    }\n  }\n  return params;\n}\n\n/**\n * Whether the element have a next node in the document order.\n * This means either:\n *  a. The element itself has a nextSibling.\n *  b. Any of the element ancestors has a nextSibling.\n * @param {!Element} element\n * @param {?Node} opt_stopNode\n * @return {boolean}\n */\nexport function hasNextNodeInDocumentOrder(element, opt_stopNode) {\n  let currentElement = element;\n  do {\n    if (currentElement.nextSibling) {\n      return true;\n    }\n  } while (\n    (currentElement = currentElement.parentNode) &&\n    currentElement != opt_stopNode\n  );\n  return false;\n}\n\n/**\n * Returns a clone of the content of a template element.\n *\n * Polyfill to replace .content access for browsers that do not support\n * HTMLTemplateElements natively.\n *\n * @param {!HTMLTemplateElement|!Element} template\n * @return {!DocumentFragment}\n */\nexport function templateContentClone(template) {\n  if ('content' in template) {\n    return template.content.cloneNode(true);\n  } else {\n    const content = template.ownerDocument.createDocumentFragment();\n    copyChildren(template, content);\n    return content;\n  }\n}\n\n/**\n * Iterate over an array-like.\n * Test cases: https://jsbench.github.io/#f638cacc866a1b2d6e517e6cfa900d6b\n * @param {!IArrayLike<T>} iterable\n * @param {function(T, number)} cb\n * @template T\n */\nexport function iterateCursor(iterable, cb) {\n  const {length} = iterable;\n  for (let i = 0; i < length; i++) {\n    cb(iterable[i], i);\n  }\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.getAttribute('type')?.toUpperCase() == 'APPLICATION/JSON'\n  );\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonLdScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.getAttribute('type')?.toUpperCase() == 'APPLICATION/LD+JSON'\n  );\n}\n\n/**\n * Whether the page's direction is right to left or not.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isRTL(doc) {\n  const dir =\n    doc.body.getAttribute('dir') ||\n    doc.documentElement.getAttribute('dir') ||\n    'ltr';\n  return dir == 'rtl';\n}\n\n/**\n * Escapes `<`, `>` and other HTML charcaters with their escaped forms.\n * @param {string} text\n * @return {string}\n */\nexport function escapeHtml(text) {\n  if (!text) {\n    return text;\n  }\n  return text.replace(HTML_ESCAPE_REGEX, escapeHtmlChar);\n}\n\n/**\n * @param {string} c\n * @return {string}\n */\nfunction escapeHtmlChar(c) {\n  return HTML_ESCAPE_CHARS[c];\n}\n\n/**\n * Tries to focus on the given element; fails silently if browser throws an\n * exception.\n * @param {!Element} element\n */\nexport function tryFocus(element) {\n  try {\n    element./*OK*/ focus();\n  } catch (e) {\n    // IE <= 7 may throw exceptions when focusing on hidden items.\n  }\n}\n\n/**\n * Whether the given window is in an iframe or not.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isIframed(win) {\n  return win.parent && win.parent != win;\n}\n\n/**\n * Returns true if node is not disabled.\n *\n * IE8 can return false positives, see {@link matches}.\n * @param {!HTMLInputElement} element\n * @return {boolean}\n * @see https://www.w3.org/TR/html5/forms.html#concept-fe-disabled\n */\nexport function isEnabled(element) {\n  return !(element.disabled || matches(element, ':disabled'));\n}\n\n/**\n * A sorting comparator that sorts elements in DOM tree order.\n * A first sibling is sorted to be before its nextSibling.\n * A parent node is sorted to be before a child.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Node/compareDocumentPosition\n *\n * @param {!Element} element1\n * @param {!Element} element2\n * @return {number}\n */\nexport function domOrderComparator(element1, element2) {\n  if (element1 === element2) {\n    return 0;\n  }\n\n  const pos = element1.compareDocumentPosition(element2);\n  const precedingOrContains =\n    Node.DOCUMENT_POSITION_PRECEDING | Node.DOCUMENT_POSITION_CONTAINS;\n\n  // if fe2 is preceding or contains fe1 then, fe1 is after fe2\n  if (pos & precedingOrContains) {\n    return 1;\n  }\n\n  // if fe2 is following or contained by fe1, then fe1 is before fe2\n  return -1;\n}\n\n/**\n * Like `Element.prototype.toggleAttribute`. This either toggles an attribute\n * on by adding an attribute with an empty value, or toggles it off by removing\n * the attribute. This does not mutate the element if the new state matches\n * the existing state.\n * @param {!Element} element An element to toggle the attribute for.\n * @param {string} name The name of the attribute.\n * @param {boolean=} forced Whether the attribute should be forced on/off. If\n *    not specified, it will be toggled from the current state.\n * @return {boolean} Whether or not the element now has the attribute.\n */\nexport function toggleAttribute(element, name, forced) {\n  const hasAttribute = element.hasAttribute(name);\n  const enabled = forced !== undefined ? forced : !hasAttribute;\n\n  if (enabled !== hasAttribute) {\n    if (enabled) {\n      element.setAttribute(name, '');\n    } else {\n      element.removeAttribute(name);\n    }\n  }\n\n  return enabled;\n}\n\n/**\n * Parses a string as a boolean value using the expanded rules for DOM boolean\n * attributes:\n * - a `null` or `undefined` returns `null`;\n * - an empty string returns `true`;\n * - a \"false\" string returns `false`;\n * - otherwise, `true` is returned.\n *\n * @param {?string|undefined} s\n * @return {boolean|undefined}\n */\nexport function parseBooleanAttribute(s) {\n  return s == null ? undefined : s !== 'false';\n}\n\n/**\n * @param {!Window} win\n * @return {number} The width of the vertical scrollbar, in pixels.\n */\nexport function getVerticalScrollbarWidth(win) {\n  const {documentElement} = win.document;\n  const windowWidth = win./*OK*/ innerWidth;\n  const documentWidth = documentElement./*OK*/ clientWidth;\n  return windowWidth - documentWidth;\n}\n\n/**\n * Dispatches a custom event.\n *\n * @param {!Node} node\n * @param {string} name\n * @param {!Object=} opt_data Event data.\n * @param {!CustomEventOptionsDef=} opt_options\n */\nexport function dispatchCustomEvent(node, name, opt_data, opt_options) {\n  const data = opt_data || {};\n  // Constructors of events need to come from the correct window. Sigh.\n  const event = node.ownerDocument.createEvent('Event');\n\n  // Technically .data is not a property of Event.\n  event.data = data;\n\n  const {bubbles, cancelable} = opt_options || DEFAULT_CUSTOM_EVENT_OPTIONS;\n  event.initEvent(name, bubbles, cancelable);\n  node.dispatchEvent(event);\n}\n\n/**\n * Ensures the child is contained by the parent, but not the parent itself.\n *\n * @param {!Node} parent\n * @param {!Node} child\n * @return {boolean}\n */\nexport function containsNotSelf(parent, child) {\n  return child !== parent && parent.contains(child);\n}\n\n/**\n * Helper method to get the json config from an element <script> tag\n * @param {!Element} element\n * @return {?JsonObject}\n * @throws {!Error} If element does not have exactly one <script> child\n * with type=\"application/json\", or if the <script> contents are not valid JSON.\n */\nexport function getChildJsonConfig(element) {\n  const scripts = childElementsByTag(element, 'script');\n  const {length} = scripts;\n  if (length !== 1) {\n    throw new Error(`Found ${length} <script> children. Expected 1.`);\n  }\n\n  const script = scripts[0];\n  if (!isJsonScriptTag(script)) {\n    throw new Error('<script> child must have type=\"application/json\"');\n  }\n\n  try {\n    return parseJson(script.textContent);\n  } catch {\n    throw new Error('Failed to parse <script> contents. Is it valid JSON?');\n  }\n}\n", "import * as mode from '#core/mode';\n\nimport {urls} from '../config';\nimport {getMode} from '../mode';\n\nconst CUSTOM_TEMPLATES = ['amp-mustache'];\nconst LATEST_VERSION = 'latest';\n\n/**\n * Calculate the base url for any scripts.\n * @param {!Location} location The window's location\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateScriptBaseUrl(location, opt_isLocalDev) {\n  if (opt_isLocalDev) {\n    let prefix = `${location.protocol}//${location.host}`;\n    if (\n      location.protocol == 'about:' ||\n      location.protocol == 'blob:' ||\n      location.protocol == 'data:'\n    ) {\n      prefix = '';\n    }\n    return `${prefix}/dist`;\n  }\n  return urls.cdn;\n}\n\n/**\n * Calculate script url for an extension.\n * @param {!Location} location The window's location\n * @param {string} extensionId\n * @param {string} version\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateExtensionScriptUrl(\n  location,\n  extensionId,\n  version,\n  opt_isLocalDev\n) {\n  const fileExtension = mode.isEsm() ? '.mjs' : '.js';\n  const base = calculateScriptBaseUrl(location, opt_isLocalDev);\n  const rtv = getMode().rtvVersion;\n  const extensionVersion = version ? '-' + version : '';\n  return `${base}/rtv/${rtv}/v0/${extensionId}${extensionVersion}${fileExtension}`;\n}\n\n/**\n * Calculate script url for an entry point.\n * If `opt_rtv` is true, returns the URL matching the current RTV.\n * @param {!Location} location The window's location\n * @param {string} entryPoint\n * @param {boolean=} isLocalDev\n * @param {boolean=} opt_rtv\n * @return {string}\n */\nexport function calculateEntryPointScriptUrl(\n  location,\n  entryPoint,\n  isLocalDev,\n  opt_rtv\n) {\n  const fileExtension = mode.isEsm() ? '.mjs' : '.js';\n  const base = calculateScriptBaseUrl(location, isLocalDev);\n  if (isLocalDev) {\n    return `${base}/${entryPoint}${fileExtension}`;\n  }\n  if (opt_rtv) {\n    return `${base}/rtv/${getMode().rtvVersion}/${entryPoint}${fileExtension}`;\n  }\n  return `${base}/${entryPoint}${fileExtension}`;\n}\n\n/**\n * Parse the extension version from a given script URL.\n * @param {string} scriptUrl\n * @return {?{extensionId: string, extensionVersion: string}}\n */\nexport function parseExtensionUrl(scriptUrl) {\n  if (!scriptUrl) {\n    return null;\n  }\n  // Note that the \"(\\.max)?\" group only applies to local dev.\n  const matches = scriptUrl.match(\n    /^(.*)\\/(.*)-([0-9.]+|latest)(\\.max)?\\.(?:js|mjs)$/i\n  );\n  const extensionId = matches ? matches[2] : undefined;\n  const extensionVersion = matches ? matches[3] : undefined;\n  if (!extensionId || !extensionVersion) {\n    return null;\n  }\n  return {extensionId, extensionVersion};\n}\n\n/**\n * Create the missing amp extension HTML script element.\n * @param {!Window} win\n * @param {string} extensionId\n * @param {string} version\n * @return {!Element} Script object\n */\nexport function createExtensionScript(win, extensionId, version) {\n  const scriptElement = win.document.createElement('script');\n  scriptElement.async = true;\n  if (isIntermediateExtension(extensionId)) {\n    version = '';\n  } else {\n    scriptElement.setAttribute(\n      CUSTOM_TEMPLATES.indexOf(extensionId) >= 0\n        ? 'custom-template'\n        : 'custom-element',\n      extensionId\n    );\n  }\n  scriptElement.setAttribute('data-script', extensionId);\n  scriptElement.setAttribute('i-amphtml-inserted', '');\n  if (mode.isEsm()) {\n    scriptElement.setAttribute('type', 'module');\n  }\n\n  // Propagate nonce to all generated script tags.\n  const currentScript = win.document.head.querySelector('script[nonce]');\n  if (currentScript) {\n    scriptElement.setAttribute('nonce', currentScript.getAttribute('nonce'));\n  }\n\n  // Allow error information to be collected\n  // https://github.com/ampproject/amphtml/issues/7353\n  scriptElement.setAttribute('crossorigin', 'anonymous');\n  let loc = win.location;\n  if (getMode(win).test && win.testLocation) {\n    loc = win.testLocation;\n  }\n  const scriptSrc = calculateExtensionScriptUrl(\n    loc,\n    extensionId,\n    version,\n    getMode(win).localDev\n  );\n  scriptElement.src = scriptSrc;\n  return scriptElement;\n}\n\n/**\n * Returns the extension <script> element and attribute for the given\n * extension ID, if it exists. Otherwise, returns null.\n * @param {!Window} win\n * @param {string} extensionId\n * @param {string} version\n * @param {boolean} latest\n * @param {boolean=} includeInserted If true, includes script elements that\n *   are inserted by the runtime dynamically. Default is true.\n * @return {!Array<!Element>}\n */\nexport function getExtensionScripts(\n  win,\n  extensionId,\n  version,\n  latest,\n  includeInserted = true\n) {\n  // Always ignore <script> elements that have a mismatched RTV.\n  const modifier =\n    ':not([i-amphtml-loaded-new-version])' +\n    (includeInserted ? '' : ':not([i-amphtml-inserted])');\n  // We have to match against \"src\" because a few extensions, such as\n  // \"amp-viewer-integration\", do not have \"custom-element\" attribute.\n  const matches = win.document.head./*OK*/ querySelectorAll(\n    `script[src*=\"/${extensionId}-\"]${modifier}`\n  );\n  const filtered = [];\n  for (let i = 0; i < matches.length; i++) {\n    const match = matches[i];\n    const urlParts = parseExtensionUrl(match.src);\n    if (!urlParts) {\n      continue;\n    }\n    const {\n      extensionId: scriptExtensionId,\n      extensionVersion: scriptExtensionVersion,\n    } = urlParts;\n    if (\n      scriptExtensionId == extensionId &&\n      (isIntermediateExtension(extensionId) ||\n        scriptExtensionVersion == version ||\n        (scriptExtensionVersion == LATEST_VERSION && latest))\n    ) {\n      filtered.push(match);\n    }\n  }\n  return filtered;\n}\n\n/**\n * Get list of all the extension JS files.\n * @param {HTMLHeadElement|Element|ShadowRoot|Document} head\n * @return {!Array<{script: HTMLScriptElement, extensionId: string, extensionVersion: string}>}\n */\nexport function extensionScriptsInNode(head) {\n  // ampdoc.getHeadNode() can return null.\n  if (!head) {\n    return [];\n  }\n  // Note: Some extensions don't have [custom-element] or [custom-template]\n  // e.g. amp-viewer-integration.\n  const list = head.querySelectorAll(\n    'script[custom-element],script[custom-template]'\n  );\n  const scripts = [];\n  for (let i = 0; i < list.length; i++) {\n    const script = list[i];\n    const extensionId =\n      script.getAttribute('custom-element') ||\n      script.getAttribute('custom-template');\n    const urlParts = parseExtensionUrl(script.src);\n    if (extensionId && urlParts) {\n      scripts.push({\n        script,\n        extensionId,\n        extensionVersion: urlParts.extensionVersion,\n      });\n    }\n  }\n  return scripts;\n}\n\n/**\n * Verifies that an extension script is present in head for\n * installation.\n * @param {!Window} win\n * @param {string} id\n * @param {string} version\n * @return {boolean}\n */\nexport function extensionScriptInNode(win, id, version) {\n  return extensionScriptsInNode(win.document.head).some(\n    ({extensionId, extensionVersion}) =>\n      id == extensionId && version == extensionVersion\n  );\n}\n\n/**\n * @param {string} extensionId\n * @return {boolean}\n */\nfunction isIntermediateExtension(extensionId) {\n  return extensionId.startsWith('_');\n}\n", "import * as dom from '#core/dom';\n\nimport {extensionScriptInNode} from '#service/extension-script';\n\nimport {userAssert} from '#utils/log';\n\nimport {\n  getAmpdoc,\n  getService,\n  getServiceForDocOrNull,\n  getServicePromise,\n  getServicePromiseForDoc,\n  getServicePromiseOrNull,\n  getServicePromiseOrNullForDoc,\n} from './service-helpers';\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {string} version The extension version.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailable(\n  win,\n  id,\n  extension,\n  version,\n  opt_element\n) {\n  const s = getServicePromiseOrNull(win, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  return getElementServicePromiseOrNull(\n    win,\n    id,\n    extension,\n    version,\n    opt_element\n  );\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. Services.viewportForDoc(...)) for type safety and because the\n * factory should not be passed around.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an element,\n *     not the extension.\n * @return {!Promise<*>}\n */\nexport function getElementServiceForDoc(element, id, extension, opt_element) {\n  return getElementServiceIfAvailableForDoc(\n    element,\n    id,\n    extension,\n    opt_element\n  ).then((service) => assertService(service, id, extension));\n}\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDoc(\n  element,\n  id,\n  extension,\n  opt_element\n) {\n  const s = getServicePromiseOrNullForDoc(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  const ampdoc = getAmpdoc(element);\n  return ampdoc\n    .whenExtensionsKnown()\n    .then(() => {\n      const version = ampdoc.getExtensionVersion(extension);\n      if (!version) {\n        return null;\n      }\n      const extensions = getService(ampdoc.win, 'extensions');\n      return extensions.waitForExtension(extension, version);\n    })\n    .then((ext) => {\n      if (!ext) {\n        return null;\n      }\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNullForDoc(element, id);\n      }\n      return getServicePromiseForDoc(element, id);\n    });\n}\n\n/**\n * Returns a promise for service for the given id in the embed scope of\n * a given element, if it exists. Falls back to ampdoc scope if the element\n * is not embedded.\n *\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom element that provides\n *     the implementation of this service.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDocInEmbedScope(\n  element,\n  id,\n  extension\n) {\n  const s = getServiceForDocOrNull(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (Promise.resolve(s));\n  }\n  return getElementServiceIfAvailableForDoc(element, id, extension);\n}\n\n/**\n * Throws user error if `service` is null.\n * @param {Object} service\n * @param {string} id\n * @param {string} extension\n * @return {!Object}\n * @private\n * @closurePrimitive {asserts.matchesReturn}\n */\nfunction assertService(service, id, extension) {\n  return /** @type {!Object} */ (\n    userAssert(\n      service,\n      'Service %s was requested to be provided through %s, ' +\n        'but %s is not loaded in the current page. To fix this ' +\n        'problem load the JavaScript file for %s in this page.',\n      id,\n      extension,\n      extension,\n      extension\n    )\n  );\n}\n\n/**\n * Returns the promise for service with `id` on the given window if available.\n * Otherwise, resolves with null (service was not registered).\n * @param {!Window} win\n * @param {string} id\n * @param {string} extension\n * @param {string} version\n * @param {boolean=} opt_element\n * @return {!Promise<Object>}\n * @private\n */\nfunction getElementServicePromiseOrNull(\n  win,\n  id,\n  extension,\n  version,\n  opt_element\n) {\n  return dom\n    .waitForBodyOpenPromise(win.document)\n    .then(() => {\n      // If there is an extension script wait for it to load before trying\n      // to get the service. Prevents a race condition when everything but\n      // the extensions is in cache. If there is no script then it's either\n      // not present, or the service was defined by a test. In those cases\n      // we don't wait around for an extension that does not exist.\n      const extensions = getService(win, 'extensions');\n\n      // TODO(jpettitt) investigate registerExtension to short circuit\n      // the dom call in extensionScriptsInNode()\n      if (!extensionScriptInNode(extensions.win, extension, version)) {\n        return null;\n      }\n      return extensions.waitForExtension(extension, version);\n    })\n    .then((ext) => {\n      if (!ext) {\n        return null;\n      }\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNull(win, id);\n      }\n      return getServicePromise(win, id);\n    });\n}\n", "import {\n  getElementServiceForDoc,\n  getElementServiceIfAvailable,\n  getElementServiceIfAvailableForDoc,\n  getElementServiceIfAvailableForDocInEmbedScope,\n} from '../element-service';\nimport {\n  getAmpdoc,\n  getExistingServiceOrNull,\n  getService,\n  getServiceForDoc,\n  getServiceForDocOrNull,\n  getServiceInEmbedWin,\n  getServicePromiseForDoc,\n} from '../service-helpers';\n\n/** @typedef {!../extensions/amp-subscriptions/0.1/amp-subscriptions.SubscriptionService} */\nexport let SubscriptionService;\n\nexport class Services {\n  /**\n   * Hint: Add extensions folder path to compile.js with\n   * warnings cannot find modules.\n   */\n\n  /**\n   * Returns a promise for the Access service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>} */ (\n      getElementServiceForDoc(element, 'access', 'amp-access')\n    );\n  }\n\n  /**\n   * Returns a promise for the Access service or a promise for null if the\n   * service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>} */ (\n      getElementServiceIfAvailableForDoc(element, 'access', 'amp-access')\n    );\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!SubscriptionService>}\n   */\n  static subscriptionsServiceForDoc(element) {\n    return /** @type {!Promise<!SubscriptionService>} */ (\n      getElementServiceForDoc(element, 'subscriptions', 'amp-subscriptions')\n    );\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?SubscriptionService>}\n   */\n  static subscriptionsServiceForDocOrNull(element) {\n    return /** @type {!Promise<?SubscriptionService>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'subscriptions',\n        'amp-subscriptions'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/action-impl.ActionService}\n   */\n  static actionServiceForDoc(element) {\n    return /** @type {!./service/action-impl.ActionService} */ (\n      getServiceForDocOrNull(element, 'action')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/standard-actions-impl.StandardActions}\n   */\n  static standardActionsForDoc(element) {\n    return /** @type {!./service/standard-actions-impl.StandardActions} */ (\n      getServiceForDocOrNull(element, 'standard-actions')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>}\n   */\n  static activityForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>} */ (\n      getElementServiceForDoc(element, 'activity', 'amp-analytics')\n    );\n  }\n\n  /**\n   * Returns the global instance of the `AmpDocService` service that can be\n   * used to resolve an ampdoc for any node: either in the single-doc or\n   * shadow-doc environment.\n   * @param {!Window} window\n   * @return {!./service/ampdoc-impl.AmpDocService}\n   */\n  static ampdocServiceFor(window) {\n    return /** @type {!./service/ampdoc-impl.AmpDocService} */ (\n      getService(window, 'ampdoc')\n    );\n  }\n\n  /**\n   * Returns the AmpDoc for the specified context node.\n   * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrAmpDoc\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   */\n  static ampdoc(nodeOrAmpDoc) {\n    return getAmpdoc(nodeOrAmpDoc);\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @param {boolean=} loadAnalytics\n   * @return {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDoc(element, loadAnalytics = false) {\n    if (loadAnalytics) {\n      // Get Extensions service and force load analytics extension.\n      const ampdoc = getAmpdoc(element);\n      Services.extensionsFor(ampdoc.win)./*OK*/ installExtensionForDoc(\n        ampdoc,\n        'amp-analytics'\n      );\n    }\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (\n      getElementServiceForDoc(\n        element,\n        'amp-analytics-instrumentation',\n        'amp-analytics'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'amp-analytics-instrumentation',\n        'amp-analytics'\n      )\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/batched-xhr-impl.BatchedXhr}\n   */\n  static batchedXhrFor(window) {\n    return /** @type {!./service/batched-xhr-impl.BatchedXhr} */ (\n      getService(window, 'batched-xhr')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>}\n   */\n  static bindForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>} */ (\n      getElementServiceIfAvailableForDocInEmbedScope(\n        element,\n        'bind',\n        'amp-bind'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-script/0.1/amp-script.AmpScriptService>}\n   */\n  static scriptForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-script/0.1/amp-script.AmpScriptService>} */ (\n      getElementServiceIfAvailableForDocInEmbedScope(\n        element,\n        'amp-script',\n        'amp-script'\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/cid-impl.CidDef>}\n   */\n  static cidForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/cid-impl.CidDef>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'cid')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/navigation.Navigation}\n   */\n  static navigationForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/navigation.Navigation} */ (\n      getServiceForDoc(elementOrAmpDoc, 'navigation')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>}\n   */\n  static loaderServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>} */ (\n      getElementServiceForDoc(element, 'loader', 'amp-loader')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>}\n   */\n  static standaloneServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>} */ (\n      getElementServiceForDoc(element, 'standalone', 'amp-standalone')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/crypto-impl.Crypto}\n   */\n  static cryptoFor(window) {\n    return /** @type {!./service/crypto-impl.Crypto} */ (\n      getService(window, 'crypto')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/document-info-impl.DocumentInfoDef} Info about the doc\n   */\n  static documentInfoForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/document-info-impl.DocInfo} */ (\n      getServiceForDoc(elementOrAmpDoc, 'documentInfo')\n    ).get();\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/extensions-impl.Extensions}\n   */\n  static extensionsFor(window) {\n    return /** @type {!./service/extensions-impl.Extensions} */ (\n      getService(window, 'extensions')\n    );\n  }\n\n  /**\n   * Returns a service to register callbacks we wish to execute when an\n   * amp-form is submitted.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>}\n   */\n  static formSubmitForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'form-submit-service')\n    );\n  }\n\n  /**\n   * Returns service to listen for `hidden` attribute mutations.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/hidden-observer-impl.HiddenObserver}\n   */\n  static hiddenObserverForDoc(element) {\n    return /** @type {!./service/hidden-observer-impl.HiddenObserver} */ (\n      getServiceForDocOrNull(element, 'hidden-observer')\n    );\n  }\n\n  /**\n   * Returns service implemented in service/history-impl.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/history-impl.History}\n   */\n  static historyForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/history-impl.History} */ (\n      getServiceForDoc(elementOrAmpDoc, 'history')\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {!./input.Input}\n   */\n  static inputFor(win) {\n    return getService(win, 'input');\n  }\n\n  /**s\n   * Returns a promise for the Inputmask service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>}\n   */\n  static inputmaskServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>} */ (\n      getElementServiceIfAvailableForDoc(element, 'inputmask', 'amp-inputmask')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {?./service/loading-indicator.LoadingIndicatorImpl}\n   */\n  static loadingIndicatorOrNull(elementOrAmpDoc) {\n    return /** @type {?./service/loading-indicator.LoadingIndicatorImpl} */ (\n      getServiceForDocOrNull(elementOrAmpDoc, 'loadingIndicator')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!../extensions/amp-next-page/1.0/service.NextPageService}\n   */\n  static nextPageServiceForDoc(elementOrAmpDoc) {\n    return /** @type {!../extensions/amp-next-page/1.0/service.NextPageService} */ (\n      getServiceForDoc(elementOrAmpDoc, 'next-page')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/mutator-interface.MutatorInterface}\n   */\n  static mutatorForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/mutator-interface.MutatorInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'mutator')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/owners-interface.OwnersInterface}\n   */\n  static ownersForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/owners-interface.OwnersInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'owners')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceFor(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (\n      getService(window, 'performance')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceForOrNull(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (\n      getExistingServiceOrNull(window, 'performance')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/platform-impl.Platform}\n   */\n  static platformFor(window) {\n    return /** @type {!./service/platform-impl.Platform} */ (\n      getService(window, 'platform')\n    );\n  }\n\n  /**\n   * Not installed by default; must be installed in extension code before use.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/position-observer/position-observer-impl.PositionObserver}\n   * @throws If the service is not installed.\n   */\n  static positionObserverForDoc(element) {\n    return /** @type {!./service/position-observer/position-observer-impl.PositionObserver} */ (\n      getServiceForDoc(element, 'position-observer')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./preconnect.PreconnectService}\n   */\n  static preconnectFor(window) {\n    return getService(window, 'preconnect');\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/resources-interface.ResourcesInterface}\n   */\n  static resourcesForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/resources-interface.ResourcesInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'resources')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/resources-interface.ResourcesInterface>}\n   */\n  static resourcesPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/resources-interface.ResourcesInterface>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'resources')\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService>}\n   */\n  static storyVariableServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService>} */\n      (getElementServiceIfAvailable(win, 'story-variable', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService}\n   */\n  static storyVariableService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService} */\n      (getExistingServiceOrNull(win, 'story-variable'))\n    );\n  }\n\n  /**\n   * Version of the story store service depends on which version of amp-story\n   * the publisher is loading. They all have the same implementation.\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService>}\n   */\n  static storyStoreServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService>} */\n      (getElementServiceIfAvailable(win, 'story-store', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService}\n   */\n  static storyStoreService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService} */\n      (getExistingServiceOrNull(win, 'story-store'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService}\n   */\n  static storyMediaQueryService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService} */\n      (getExistingServiceOrNull(win, 'story-media-query'))\n    );\n  }\n\n  /**\n   * Get promise with story request service\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService>}\n   */\n  static storyRequestServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService>} */\n      (getElementServiceIfAvailable(win, 'story-request', 'amp-story', '1.0'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService}\n   */\n  static storyRequestService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService} */\n      (getExistingServiceOrNull(win, 'story-request'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService}\n   */\n  static mediaPerformanceMetricsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService} */\n      (getExistingServiceOrNull(win, 'media-performance-metrics'))\n    );\n  }\n\n  /**\n   * @param {!Element} el\n   * @return {!Promise<./service/localization.LocalizationService>}\n   */\n  static localizationServiceForOrNull(el) {\n    return /** @type {!Promise<?./service/localization.LocalizationService>} */ (\n      getServicePromiseForDoc(el, 'localization')\n    );\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {?./service/localization.LocalizationService}\n   */\n  static localizationForDoc(element) {\n    return /** @type {?./service/localization.LocalizationService} */ (\n      getServiceForDocOrNull(element, 'localization')\n    );\n  }\n\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>}\n   */\n  static storyAnalyticsServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>} */\n      (\n        getElementServiceIfAvailable(\n          win,\n          'story-analytics',\n          'amp-story',\n          '1.0',\n          true\n        )\n      )\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService}\n   */\n  static storyAnalyticsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService} */\n      (getExistingServiceOrNull(win, 'story-analytics'))\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>}\n   */\n  static webAnimationServiceFor(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>} */\n      (getElementServiceForDoc(element, 'web-animation', 'amp-animation'))\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/real-time-config/real-time-config-impl.RealTimeConfigManager>}\n   */\n  static realTimeConfigForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/real-time-config/real-time-config-impl.RealTimeConfigManager>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'real-time-config')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   */\n  static storageForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/storage-impl.Storage>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'storage')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   * TODO(dmanek): Add tests for this method.\n   */\n  static storageForTopLevelDoc(elementOrAmpDoc) {\n    const thisAmpdoc = Services.ampdoc(elementOrAmpDoc);\n    const ampdocService = Services.ampdocServiceFor(thisAmpdoc.win);\n    const topAmpdoc = ampdocService.isSingleDoc()\n      ? ampdocService.getSingleDoc()\n      : null;\n    // We need to verify that ampdocs are on the same origin, therefore\n    // we compare the windows of both.\n    const ampdoc =\n      topAmpdoc && topAmpdoc.win == thisAmpdoc.win ? topAmpdoc : thisAmpdoc;\n    return /** @type {!Promise<!./service/storage-impl.Storage>} */ (\n      getServicePromiseForDoc(ampdoc, 'storage')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/template-impl.Templates}\n   */\n  static templatesForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/template-impl.Templates} */ (\n      getServiceForDoc(elementOrAmpDoc, 'templates')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/timer-impl.Timer}\n   */\n  static timerFor(window) {\n    // TODO(alabiaga): This will always return the top window's Timer service.\n    return /** @type {!./service/timer-impl.Timer} */ (\n      getServiceInEmbedWin(window, 'timer')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-replacements-impl.UrlReplacements}\n   */\n  static urlReplacementsForDoc(element) {\n    return /** @type {!./service/url-replacements-impl.UrlReplacements} */ (\n      getServiceForDocOrNull(element, 'url-replace')\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>}\n   */\n  static userNotificationManagerForDoc(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>} */\n      (\n        getElementServiceForDoc(\n          element,\n          'userNotificationManager',\n          'amp-user-notification'\n        )\n      )\n    );\n  }\n\n  /**\n   * Returns a promise for the consentPolicy Service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>}\n   */\n  static consentPolicyServiceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>} */\n      (\n        getElementServiceIfAvailableForDoc(\n          element,\n          'consentPolicyManager',\n          'amp-consent'\n        )\n      )\n    );\n  }\n\n  /**\n   * Returns a promise for the geo service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>}\n   */\n  static geoForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>} */ (\n      getElementServiceIfAvailableForDoc(element, 'geo', 'amp-geo', true)\n    );\n  }\n\n  /**\n   * Unlike most service getters, passing `Node` is necessary for some FIE-scope\n   * services since sometimes we only have the FIE Document for context.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-impl.Url}\n   */\n  static urlForDoc(element) {\n    return /** @type {!./service/url-impl.Url} */ (\n      getServiceForDocOrNull(element, 'url')\n    );\n  }\n\n  /**\n   * Returns a promise for the experiment variants or a promise for null if it\n   * is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>}\n   */\n  static variantsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>} */ (\n      getElementServiceIfAvailableForDoc(\n        element,\n        'variant',\n        'amp-experiment',\n        true\n      )\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/video-manager-impl.VideoManager}\n   */\n  static videoManagerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/video-manager-impl.VideoManager} */ (\n      getServiceForDoc(elementOrAmpDoc, 'video-manager')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewer-interface.ViewerInterface}\n   */\n  static viewerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewer-interface.ViewerInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'viewer')\n    );\n  }\n\n  /**\n   * Returns promise for the viewer. This is an unusual case and necessary only\n   * for services that need reference to the viewer before it has been\n   * initialized. Most of the code, however, just should use `viewerForDoc`.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/viewer-interface.ViewerInterface>}\n   */\n  static viewerPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/viewer-interface.ViewerInterface>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'viewer')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/vsync-impl.Vsync}\n   */\n  static vsyncFor(window) {\n    return /** @type {!./service/vsync-impl.Vsync} */ (\n      getService(window, 'vsync')\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewport/viewport-interface.ViewportInterface}\n   */\n  static viewportForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewport/viewport-interface.ViewportInterface} */ (\n      getServiceForDoc(elementOrAmpDoc, 'viewport')\n    );\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/xhr-impl.Xhr}\n   */\n  static xhrFor(window) {\n    return /** @type {!./service/xhr-impl.Xhr} */ (getService(window, 'xhr'));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../amp-cache-url/amp-cache-url.AmpCacheUrlService>}\n   */\n  static cacheUrlServicePromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<?../amp-cache-url/amp-cache-url.AmpCacheUrlService>} */ (\n      getServicePromiseForDoc(elementOrAmpDoc, 'cache-url')\n    );\n  }\n}\n", "import {internalListenImplementation} from '#core/dom/event-helper-listen';\nimport {lastChildElement} from '#core/dom/query';\nimport * as mode from '#core/mode';\n\nimport {user} from '#utils/log';\n\n/** @const {string}  */\nconst LOAD_FAILURE_PREFIX = 'Failed to load:';\n\n/** @const {string} */\nexport const MEDIA_LOAD_FAILURE_SRC_PROPERTY = '__AMP_MEDIA_LOAD_FAILURE_SRC';\n\n/**\n * Returns a CustomEvent with a given type and detail; supports fallback for IE.\n * @param {!Window} win\n * @param {string} type\n * @param {!JsonObject|string|undefined|null} detail\n * @param {EventInit=} opt_eventInit\n * @return {!Event}\n */\nexport function createCustomEvent(win, type, detail, opt_eventInit) {\n  const eventInit = /** @type {!CustomEventInit} */ ({detail});\n  Object.assign(eventInit, opt_eventInit);\n  // win.CustomEvent is a function on Edge, Chrome, FF, Safari but\n  // is an object on IE 11.\n  if (mode.isEsm() || typeof win.CustomEvent == 'function') {\n    return new win.CustomEvent(type, eventInit);\n  } else {\n    // Deprecated fallback for IE.\n    const e = win.document.createEvent('CustomEvent');\n    e.initCustomEvent(\n      type,\n      !!eventInit.bubbles,\n      !!eventInit.cancelable,\n      detail\n    );\n    return e;\n  }\n}\n\n/**\n * Listens for the specified event on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listen(element, eventType, listener, opt_evtListenerOpts) {\n  return internalListenImplementation(\n    element,\n    eventType,\n    listener,\n    opt_evtListenerOpts\n  );\n}\n\n/**\n * Returns the data property of an event with the correct type.\n * @param {!Event|{data: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getData(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.data);\n}\n\n/**\n * Returns the detail property of an event with the correct type.\n * @param {!Event|{detail: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getDetail(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.detail);\n}\n\n/**\n * Listens for the specified event on the element and removes the listener\n * as soon as event has been received.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listenOnce(element, eventType, listener, opt_evtListenerOpts) {\n  let localListener = listener;\n  const unlisten = internalListenImplementation(\n    element,\n    eventType,\n    (event) => {\n      try {\n        localListener(event);\n      } finally {\n        // Ensure listener is GC'd\n        localListener = null;\n        unlisten();\n      }\n    },\n    opt_evtListenerOpts\n  );\n  return unlisten;\n}\n\n/**\n * Returns  a promise that will resolve as soon as the specified event has\n * fired on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {Object=} opt_evtListenerOpts\n * @param {function(!UnlistenDef)=} opt_cancel An optional function that, when\n *     provided, will be called with the unlistener. This gives the caller\n *     access to the unlistener, so it may be called manually when necessary.\n * @return {!Promise<!Event>}\n */\nexport function listenOncePromise(\n  element,\n  eventType,\n  opt_evtListenerOpts,\n  opt_cancel\n) {\n  let unlisten;\n  const eventPromise = new Promise((resolve) => {\n    unlisten = listenOnce(element, eventType, resolve, opt_evtListenerOpts);\n  });\n  eventPromise.then(unlisten, unlisten);\n  if (opt_cancel) {\n    opt_cancel(unlisten);\n  }\n  return eventPromise;\n}\n\n/**\n * Whether the specified element/window has been loaded already.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nexport function isLoaded(eleOrWindow) {\n  return !!(\n    eleOrWindow.complete ||\n    eleOrWindow.readyState == 'complete' ||\n    (isHTMLMediaElement(eleOrWindow) && eleOrWindow.readyState > 0) ||\n    // If the passed in thing is a Window, infer loaded state from\n    //\n    (eleOrWindow.document && eleOrWindow.document.readyState == 'complete')\n  );\n}\n\n/**\n * Returns a promise that will resolve or fail based on the eleOrWindow's 'load'\n * and 'error' events. Optionally this method takes a timeout, which will reject\n * the promise if the resource has not loaded by then.\n * @param {T} eleOrWindow Supports both Elements and as a special case Windows.\n * @return {!Promise<T>}\n * @template T\n */\nexport function loadPromise(eleOrWindow) {\n  let unlistenLoad;\n  let unlistenError;\n  if (isLoaded(eleOrWindow)) {\n    return Promise.resolve(eleOrWindow);\n  }\n  const isMediaElement = isHTMLMediaElement(eleOrWindow);\n  if (\n    isMediaElement &&\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] === eleOrWindow.currentSrc\n  ) {\n    return Promise.reject(eleOrWindow);\n  }\n  const loadingPromise = new Promise((resolve, reject) => {\n    // Listen once since IE 5/6/7 fire the onload event continuously for\n    // animated GIFs.\n    if (isMediaElement) {\n      // The following event can be triggered by the media or one of its\n      // sources. Using capture is required as the media events do not bubble.\n      unlistenLoad = listenOnce(eleOrWindow, 'loadedmetadata', resolve, {\n        capture: true,\n      });\n    } else {\n      unlistenLoad = listenOnce(eleOrWindow, 'load', resolve);\n    }\n    // Don't unlisten on error for Windows.\n    if (!eleOrWindow.tagName) {\n      return;\n    }\n    let errorTarget = eleOrWindow;\n    // If the media element has no `src`, it will try to load the sources in\n    // document order. If the last source errors, then the media element\n    // loading errored.\n    if (isMediaElement && !eleOrWindow.hasAttribute('src')) {\n      errorTarget = lastChildElement(\n        eleOrWindow,\n        (child) => child.tagName === 'SOURCE'\n      );\n      if (!errorTarget) {\n        return reject(new Error('Media has no source.'));\n      }\n    }\n    unlistenError = listenOnce(errorTarget, 'error', reject);\n  });\n\n  return loadingPromise.then(\n    () => {\n      if (unlistenError) {\n        unlistenError();\n      }\n      return eleOrWindow;\n    },\n    () => {\n      if (unlistenLoad) {\n        unlistenLoad();\n      }\n      failedToLoad(eleOrWindow);\n    }\n  );\n}\n\n/**\n * Emit error on load failure.\n * @param {!Element|!Window} eleOrWindow Supports both Elements and as a special\n *     case Windows.\n */\nfunction failedToLoad(eleOrWindow) {\n  // Mark the element as errored since some elements - like HTMLMediaElement\n  // using HTMLSourceElement - do not provide any synchronous way to verify if\n  // they already errored, even though the error event was already dispatched.\n  if (isHTMLMediaElement(eleOrWindow)) {\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] =\n      eleOrWindow.currentSrc || true;\n  }\n\n  // Report failed loads as user errors so that they automatically go\n  // into the \"document error\" bucket.\n  let target = eleOrWindow;\n  if (target && target.src) {\n    target = target.src;\n  }\n  throw user().createError(LOAD_FAILURE_PREFIX, target);\n}\n\n/**\n * Returns true if the parameter is a HTMLMediaElement.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nfunction isHTMLMediaElement(eleOrWindow) {\n  return eleOrWindow.tagName === 'AUDIO' || eleOrWindow.tagName === 'VIDEO';\n}\n\n/**\n * Returns true if this error message is was created for a load error.\n * @param {string} message An error message\n * @return {boolean}\n */\nexport function isLoadErrorMessage(message) {\n  return message.indexOf(LOAD_FAILURE_PREFIX) != -1;\n}\n", "/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/** Version: 0.1.22.190 */\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/** @enum {number} */\nconst AnalyticsEvent = {\n  UNKNOWN: 0,\n  IMPRESSION_PAYWALL: 1,\n  IMPRESSION_AD: 2,\n  IMPRESSION_OFFERS: 3,\n  IMPRESSION_SUBSCRIBE_BUTTON: 4,\n  IMPRESSION_SMARTBOX: 5,\n  IMPRESSION_SWG_BUTTON: 6,\n  IMPRESSION_CLICK_TO_SHOW_OFFERS: 7,\n  IMPRESSION_CLICK_TO_SHOW_OFFERS_OR_ALREADY_SUBSCRIBED: 8,\n  IMPRESSION_SUBSCRIPTION_COMPLETE: 9,\n  IMPRESSION_ACCOUNT_CHANGED: 10,\n  IMPRESSION_PAGE_LOAD: 11,\n  IMPRESSION_LINK: 12,\n  IMPRESSION_SAVE_SUBSCR_TO_GOOGLE: 13,\n  IMPRESSION_GOOGLE_UPDATED: 14,\n  IMPRESSION_SHOW_OFFERS_SMARTBOX: 15,\n  IMPRESSION_SHOW_OFFERS_SWG_BUTTON: 16,\n  IMPRESSION_SELECT_OFFER_SMARTBOX: 17,\n  IMPRESSION_SELECT_OFFER_SWG_BUTTON: 18,\n  IMPRESSION_SHOW_CONTRIBUTIONS_SWG_BUTTON: 19,\n  IMPRESSION_SELECT_CONTRIBUTION_SWG_BUTTON: 20,\n  IMPRESSION_METER_TOAST: 21,\n  IMPRESSION_REGWALL: 22,\n  IMPRESSION_SHOWCASE_REGWALL: 23,\n  IMPRESSION_SWG_SUBSCRIPTION_MINI_PROMPT: 24,\n  IMPRESSION_SWG_CONTRIBUTION_MINI_PROMPT: 25,\n  IMPRESSION_CONTRIBUTION_OFFERS: 26,\n  ACTION_SUBSCRIBE: 1000,\n  ACTION_PAYMENT_COMPLETE: 1001,\n  ACTION_ACCOUNT_CREATED: 1002,\n  ACTION_ACCOUNT_ACKNOWLEDGED: 1003,\n  ACTION_SUBSCRIPTIONS_LANDING_PAGE: 1004,\n  ACTION_PAYMENT_FLOW_STARTED: 1005,\n  ACTION_OFFER_SELECTED: 1006,\n  ACTION_SWG_BUTTON_CLICK: 1007,\n  ACTION_VIEW_OFFERS: 1008,\n  ACTION_ALREADY_SUBSCRIBED: 1009,\n  ACTION_NEW_DEFERRED_ACCOUNT: 1010,\n  ACTION_LINK_CONTINUE: 1011,\n  ACTION_LINK_CANCEL: 1012,\n  ACTION_GOOGLE_UPDATED_CLOSE: 1013,\n  ACTION_USER_CANCELED_PAYFLOW: 1014,\n  ACTION_SAVE_SUBSCR_TO_GOOGLE_CONTINUE: 1015,\n  ACTION_SAVE_SUBSCR_TO_GOOGLE_CANCEL: 1016,\n  ACTION_SWG_BUTTON_SHOW_OFFERS_CLICK: 1017,\n  ACTION_SWG_BUTTON_SELECT_OFFER_CLICK: 1018,\n  ACTION_SWG_BUTTON_SHOW_CONTRIBUTIONS_CLICK: 1019,\n  ACTION_SWG_BUTTON_SELECT_CONTRIBUTION_CLICK: 1020,\n  ACTION_USER_CONSENT_DEFERRED_ACCOUNT: 1021,\n  ACTION_USER_DENY_DEFERRED_ACCOUNT: 1022,\n  ACTION_DEFERRED_ACCOUNT_REDIRECT: 1023,\n  ACTION_GET_ENTITLEMENTS: 1024,\n  ACTION_METER_TOAST_SUBSCRIBE_CLICK: 1025,\n  ACTION_METER_TOAST_EXPANDED: 1026,\n  ACTION_METER_TOAST_CLOSED_BY_ARTICLE_INTERACTION: 1027,\n  ACTION_METER_TOAST_CLOSED_BY_SWIPE_DOWN: 1028,\n  ACTION_METER_TOAST_CLOSED_BY_X_CLICKED: 1029,\n  ACTION_SWG_SUBSCRIPTION_MINI_PROMPT_CLICK: 1030,\n  ACTION_SWG_CONTRIBUTION_MINI_PROMPT_CLICK: 1031,\n  ACTION_SWG_SUBSCRIPTION_MINI_PROMPT_CLOSE: 1032,\n  ACTION_SWG_CONTRIBUTION_MINI_PROMPT_CLOSE: 1033,\n  ACTION_CONTRIBUTION_OFFER_SELECTED: 1034,\n  ACTION_SHOWCASE_REGWALL_GSI_CLICK: 1035,\n  ACTION_SHOWCASE_REGWALL_EXISTING_ACCOUNT_CLICK: 1036,\n  EVENT_PAYMENT_FAILED: 2000,\n  EVENT_CUSTOM: 3000,\n  EVENT_CONFIRM_TX_ID: 3001,\n  EVENT_CHANGED_TX_ID: 3002,\n  EVENT_GPAY_NO_TX_ID: 3003,\n  EVENT_GPAY_CANNOT_CONFIRM_TX_ID: 3004,\n  EVENT_GOOGLE_UPDATED: 3005,\n  EVENT_NEW_TX_ID: 3006,\n  EVENT_UNLOCKED_BY_SUBSCRIPTION: 3007,\n  EVENT_UNLOCKED_BY_METER: 3008,\n  EVENT_NO_ENTITLEMENTS: 3009,\n  EVENT_HAS_METERING_ENTITLEMENTS: 3010,\n  EVENT_OFFERED_METER: 3011,\n  EVENT_UNLOCKED_FREE_PAGE: 3012,\n  EVENT_INELIGIBLE_PAYWALL: 3013,\n  EVENT_UNLOCKED_FOR_CRAWLER: 3014,\n  EVENT_SUBSCRIPTION_STATE: 4000,\n};\n/** @enum {number} */\nconst EntitlementResult = {\n  UNKNOWN_ENTITLEMENT_RESULT: 0,\n  UNLOCKED_SUBSCRIBER: 1001,\n  UNLOCKED_FREE: 1002,\n  UNLOCKED_METER: 1003,\n  LOCKED_REGWALL: 2001,\n  LOCKED_PAYWALL: 2002,\n  INELIGIBLE_PAYWALL: 2003,\n};\n/** @enum {number} */\nconst EntitlementSource = {\n  UNKNOWN_ENTITLEMENT_SOURCE: 0,\n  GOOGLE_SUBSCRIBER_ENTITLEMENT: 1001,\n  GOOGLE_SHOWCASE_METERING_SERVICE: 2001,\n  PUBLISHER_ENTITLEMENT: 3001,\n};\n/** @enum {number} */\nconst EventOriginator = {\n  UNKNOWN_CLIENT: 0,\n  SWG_CLIENT: 1,\n  AMP_CLIENT: 2,\n  PROPENSITY_CLIENT: 3,\n  SWG_SERVER: 4,\n  PUBLISHER_CLIENT: 5,\n  SHOWCASE_CLIENT: 6,\n};\n\n/**\n * @implements {Message}\n */\nclass AccountCreationRequest {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?boolean} */\n    this.complete_ = data[base] == null ? null : data[base];\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getComplete() {\n    return this.complete_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setComplete(value) {\n    this.complete_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.complete_, // field 1 - complete\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'AccountCreationRequest';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass AlreadySubscribedResponse {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?boolean} */\n    this.subscriberOrMember_ = data[base] == null ? null : data[base];\n\n    /** @private {?boolean} */\n    this.linkRequested_ = data[1 + base] == null ? null : data[1 + base];\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getSubscriberOrMember() {\n    return this.subscriberOrMember_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setSubscriberOrMember(value) {\n    this.subscriberOrMember_ = value;\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getLinkRequested() {\n    return this.linkRequested_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setLinkRequested(value) {\n    this.linkRequested_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.subscriberOrMember_, // field 1 - subscriber_or_member\n        this.linkRequested_, // field 2 - link_requested\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'AlreadySubscribedResponse';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass AnalyticsContext {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?string} */\n    this.embedderOrigin_ = data[base] == null ? null : data[base];\n\n    /** @private {?string} */\n    this.transactionId_ = data[1 + base] == null ? null : data[1 + base];\n\n    /** @private {?string} */\n    this.referringOrigin_ = data[2 + base] == null ? null : data[2 + base];\n\n    /** @private {?string} */\n    this.utmSource_ = data[3 + base] == null ? null : data[3 + base];\n\n    /** @private {?string} */\n    this.utmCampaign_ = data[4 + base] == null ? null : data[4 + base];\n\n    /** @private {?string} */\n    this.utmMedium_ = data[5 + base] == null ? null : data[5 + base];\n\n    /** @private {?string} */\n    this.sku_ = data[6 + base] == null ? null : data[6 + base];\n\n    /** @private {?boolean} */\n    this.readyToPay_ = data[7 + base] == null ? null : data[7 + base];\n\n    /** @private {!Array<string>} */\n    this.label_ = data[8 + base] || [];\n\n    /** @private {?string} */\n    this.clientVersion_ = data[9 + base] == null ? null : data[9 + base];\n\n    /** @private {?string} */\n    this.url_ = data[10 + base] == null ? null : data[10 + base];\n\n    /** @private {?Timestamp} */\n    this.clientTimestamp_ =\n      data[11 + base] == null || data[11 + base] == undefined\n        ? null\n        : new Timestamp(data[11 + base], includesLabel);\n  }\n\n  /**\n   * @return {?string}\n   */\n  getEmbedderOrigin() {\n    return this.embedderOrigin_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setEmbedderOrigin(value) {\n    this.embedderOrigin_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getTransactionId() {\n    return this.transactionId_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setTransactionId(value) {\n    this.transactionId_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getReferringOrigin() {\n    return this.referringOrigin_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setReferringOrigin(value) {\n    this.referringOrigin_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getUtmSource() {\n    return this.utmSource_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setUtmSource(value) {\n    this.utmSource_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getUtmCampaign() {\n    return this.utmCampaign_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setUtmCampaign(value) {\n    this.utmCampaign_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getUtmMedium() {\n    return this.utmMedium_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setUtmMedium(value) {\n    this.utmMedium_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getSku() {\n    return this.sku_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setSku(value) {\n    this.sku_ = value;\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getReadyToPay() {\n    return this.readyToPay_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setReadyToPay(value) {\n    this.readyToPay_ = value;\n  }\n\n  /**\n   * @return {!Array<string>}\n   */\n  getLabelList() {\n    return this.label_;\n  }\n\n  /**\n   * @param {!Array<string>} value\n   */\n  setLabelList(value) {\n    this.label_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getClientVersion() {\n    return this.clientVersion_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setClientVersion(value) {\n    this.clientVersion_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getUrl() {\n    return this.url_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setUrl(value) {\n    this.url_ = value;\n  }\n\n  /**\n   * @return {?Timestamp}\n   */\n  getClientTimestamp() {\n    return this.clientTimestamp_;\n  }\n\n  /**\n   * @param {!Timestamp} value\n   */\n  setClientTimestamp(value) {\n    this.clientTimestamp_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.embedderOrigin_, // field 1 - embedder_origin\n        this.transactionId_, // field 2 - transaction_id\n        this.referringOrigin_, // field 3 - referring_origin\n        this.utmSource_, // field 4 - utm_source\n        this.utmCampaign_, // field 5 - utm_campaign\n        this.utmMedium_, // field 6 - utm_medium\n        this.sku_, // field 7 - sku\n        this.readyToPay_, // field 8 - ready_to_pay\n        this.label_, // field 9 - label\n        this.clientVersion_, // field 10 - client_version\n        this.url_, // field 11 - url\n        this.clientTimestamp_ ? this.clientTimestamp_.toArray(includeLabel) : [], // field 12 - client_timestamp\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'AnalyticsContext';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass AnalyticsEventMeta {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?EventOriginator} */\n    this.eventOriginator_ = data[base] == null ? null : data[base];\n\n    /** @private {?boolean} */\n    this.isFromUserAction_ = data[1 + base] == null ? null : data[1 + base];\n  }\n\n  /**\n   * @return {?EventOriginator}\n   */\n  getEventOriginator() {\n    return this.eventOriginator_;\n  }\n\n  /**\n   * @param {!EventOriginator} value\n   */\n  setEventOriginator(value) {\n    this.eventOriginator_ = value;\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getIsFromUserAction() {\n    return this.isFromUserAction_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setIsFromUserAction(value) {\n    this.isFromUserAction_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.eventOriginator_, // field 1 - event_originator\n        this.isFromUserAction_, // field 2 - is_from_user_action\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'AnalyticsEventMeta';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass AnalyticsRequest {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?AnalyticsContext} */\n    this.context_ =\n      data[base] == null || data[base] == undefined\n        ? null\n        : new AnalyticsContext(data[base], includesLabel);\n\n    /** @private {?AnalyticsEvent} */\n    this.event_ = data[1 + base] == null ? null : data[1 + base];\n\n    /** @private {?AnalyticsEventMeta} */\n    this.meta_ =\n      data[2 + base] == null || data[2 + base] == undefined\n        ? null\n        : new AnalyticsEventMeta(data[2 + base], includesLabel);\n\n    /** @private {?EventParams} */\n    this.params_ =\n      data[3 + base] == null || data[3 + base] == undefined\n        ? null\n        : new EventParams(data[3 + base], includesLabel);\n  }\n\n  /**\n   * @return {?AnalyticsContext}\n   */\n  getContext() {\n    return this.context_;\n  }\n\n  /**\n   * @param {!AnalyticsContext} value\n   */\n  setContext(value) {\n    this.context_ = value;\n  }\n\n  /**\n   * @return {?AnalyticsEvent}\n   */\n  getEvent() {\n    return this.event_;\n  }\n\n  /**\n   * @param {!AnalyticsEvent} value\n   */\n  setEvent(value) {\n    this.event_ = value;\n  }\n\n  /**\n   * @return {?AnalyticsEventMeta}\n   */\n  getMeta() {\n    return this.meta_;\n  }\n\n  /**\n   * @param {!AnalyticsEventMeta} value\n   */\n  setMeta(value) {\n    this.meta_ = value;\n  }\n\n  /**\n   * @return {?EventParams}\n   */\n  getParams() {\n    return this.params_;\n  }\n\n  /**\n   * @param {!EventParams} value\n   */\n  setParams(value) {\n    this.params_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.context_ ? this.context_.toArray(includeLabel) : [], // field 1 - context\n        this.event_, // field 2 - event\n        this.meta_ ? this.meta_.toArray(includeLabel) : [], // field 3 - meta\n        this.params_ ? this.params_.toArray(includeLabel) : [], // field 4 - params\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'AnalyticsRequest';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass EntitlementJwt {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?string} */\n    this.jwt_ = data[base] == null ? null : data[base];\n\n    /** @private {?string} */\n    this.source_ = data[1 + base] == null ? null : data[1 + base];\n  }\n\n  /**\n   * @return {?string}\n   */\n  getJwt() {\n    return this.jwt_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setJwt(value) {\n    this.jwt_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getSource() {\n    return this.source_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setSource(value) {\n    this.source_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.jwt_, // field 1 - jwt\n        this.source_, // field 2 - source\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'EntitlementJwt';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass EntitlementsRequest {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?EntitlementJwt} */\n    this.usedEntitlement_ =\n      data[base] == null || data[base] == undefined\n        ? null\n        : new EntitlementJwt(data[base], includesLabel);\n\n    /** @private {?Timestamp} */\n    this.clientEventTime_ =\n      data[1 + base] == null || data[1 + base] == undefined\n        ? null\n        : new Timestamp(data[1 + base], includesLabel);\n\n    /** @private {?EntitlementSource} */\n    this.entitlementSource_ = data[2 + base] == null ? null : data[2 + base];\n\n    /** @private {?EntitlementResult} */\n    this.entitlementResult_ = data[3 + base] == null ? null : data[3 + base];\n\n    /** @private {?string} */\n    this.token_ = data[4 + base] == null ? null : data[4 + base];\n\n    /** @private {?boolean} */\n    this.isUserRegistered_ = data[5 + base] == null ? null : data[5 + base];\n  }\n\n  /**\n   * @return {?EntitlementJwt}\n   */\n  getUsedEntitlement() {\n    return this.usedEntitlement_;\n  }\n\n  /**\n   * @param {!EntitlementJwt} value\n   */\n  setUsedEntitlement(value) {\n    this.usedEntitlement_ = value;\n  }\n\n  /**\n   * @return {?Timestamp}\n   */\n  getClientEventTime() {\n    return this.clientEventTime_;\n  }\n\n  /**\n   * @param {!Timestamp} value\n   */\n  setClientEventTime(value) {\n    this.clientEventTime_ = value;\n  }\n\n  /**\n   * @return {?EntitlementSource}\n   */\n  getEntitlementSource() {\n    return this.entitlementSource_;\n  }\n\n  /**\n   * @param {!EntitlementSource} value\n   */\n  setEntitlementSource(value) {\n    this.entitlementSource_ = value;\n  }\n\n  /**\n   * @return {?EntitlementResult}\n   */\n  getEntitlementResult() {\n    return this.entitlementResult_;\n  }\n\n  /**\n   * @param {!EntitlementResult} value\n   */\n  setEntitlementResult(value) {\n    this.entitlementResult_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getToken() {\n    return this.token_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setToken(value) {\n    this.token_ = value;\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getIsUserRegistered() {\n    return this.isUserRegistered_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setIsUserRegistered(value) {\n    this.isUserRegistered_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.usedEntitlement_ ? this.usedEntitlement_.toArray(includeLabel) : [], // field 1 - used_entitlement\n        this.clientEventTime_ ? this.clientEventTime_.toArray(includeLabel) : [], // field 2 - client_event_time\n        this.entitlementSource_, // field 3 - entitlement_source\n        this.entitlementResult_, // field 4 - entitlement_result\n        this.token_, // field 5 - token\n        this.isUserRegistered_, // field 6 - is_user_registered\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'EntitlementsRequest';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass EntitlementsResponse {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?string} */\n    this.jwt_ = data[base] == null ? null : data[base];\n\n    /** @private {?string} */\n    this.swgUserToken_ = data[1 + base] == null ? null : data[1 + base];\n  }\n\n  /**\n   * @return {?string}\n   */\n  getJwt() {\n    return this.jwt_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setJwt(value) {\n    this.jwt_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getSwgUserToken() {\n    return this.swgUserToken_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setSwgUserToken(value) {\n    this.swgUserToken_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.jwt_, // field 1 - jwt\n        this.swgUserToken_, // field 2 - swg_user_token\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'EntitlementsResponse';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass EventParams {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?string} */\n    this.smartboxMessage_ = data[base] == null ? null : data[base];\n\n    /** @private {?string} */\n    this.gpayTransactionId_ = data[1 + base] == null ? null : data[1 + base];\n\n    /** @private {?boolean} */\n    this.hadLogged_ = data[2 + base] == null ? null : data[2 + base];\n\n    /** @private {?string} */\n    this.sku_ = data[3 + base] == null ? null : data[3 + base];\n\n    /** @private {?string} */\n    this.oldTransactionId_ = data[4 + base] == null ? null : data[4 + base];\n\n    /** @private {?boolean} */\n    this.isUserRegistered_ = data[5 + base] == null ? null : data[5 + base];\n\n    /** @private {?string} */\n    this.subscriptionFlow_ = data[6 + base] == null ? null : data[6 + base];\n  }\n\n  /**\n   * @return {?string}\n   */\n  getSmartboxMessage() {\n    return this.smartboxMessage_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setSmartboxMessage(value) {\n    this.smartboxMessage_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getGpayTransactionId() {\n    return this.gpayTransactionId_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setGpayTransactionId(value) {\n    this.gpayTransactionId_ = value;\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getHadLogged() {\n    return this.hadLogged_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setHadLogged(value) {\n    this.hadLogged_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getSku() {\n    return this.sku_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setSku(value) {\n    this.sku_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getOldTransactionId() {\n    return this.oldTransactionId_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setOldTransactionId(value) {\n    this.oldTransactionId_ = value;\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getIsUserRegistered() {\n    return this.isUserRegistered_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setIsUserRegistered(value) {\n    this.isUserRegistered_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getSubscriptionFlow() {\n    return this.subscriptionFlow_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setSubscriptionFlow(value) {\n    this.subscriptionFlow_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.smartboxMessage_, // field 1 - smartbox_message\n        this.gpayTransactionId_, // field 2 - gpay_transaction_id\n        this.hadLogged_, // field 3 - had_logged\n        this.sku_, // field 4 - sku\n        this.oldTransactionId_, // field 5 - old_transaction_id\n        this.isUserRegistered_, // field 6 - is_user_registered\n        this.subscriptionFlow_, // field 7 - subscription_flow\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'EventParams';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass FinishedLoggingResponse {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?boolean} */\n    this.complete_ = data[base] == null ? null : data[base];\n\n    /** @private {?string} */\n    this.error_ = data[1 + base] == null ? null : data[1 + base];\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getComplete() {\n    return this.complete_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setComplete(value) {\n    this.complete_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getError() {\n    return this.error_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setError(value) {\n    this.error_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.complete_, // field 1 - complete\n        this.error_, // field 2 - error\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'FinishedLoggingResponse';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass LinkSaveTokenRequest {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?string} */\n    this.authCode_ = data[base] == null ? null : data[base];\n\n    /** @private {?string} */\n    this.token_ = data[1 + base] == null ? null : data[1 + base];\n  }\n\n  /**\n   * @return {?string}\n   */\n  getAuthCode() {\n    return this.authCode_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setAuthCode(value) {\n    this.authCode_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getToken() {\n    return this.token_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setToken(value) {\n    this.token_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.authCode_, // field 1 - auth_code\n        this.token_, // field 2 - token\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'LinkSaveTokenRequest';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass LinkingInfoResponse {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?boolean} */\n    this.requested_ = data[base] == null ? null : data[base];\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getRequested() {\n    return this.requested_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setRequested(value) {\n    this.requested_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.requested_, // field 1 - requested\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'LinkingInfoResponse';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass OpenDialogRequest {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?string} */\n    this.urlPath_ = data[base] == null ? null : data[base];\n  }\n\n  /**\n   * @return {?string}\n   */\n  getUrlPath() {\n    return this.urlPath_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setUrlPath(value) {\n    this.urlPath_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.urlPath_, // field 1 - url_path\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'OpenDialogRequest';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass SkuSelectedResponse {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?string} */\n    this.sku_ = data[base] == null ? null : data[base];\n\n    /** @private {?string} */\n    this.oldSku_ = data[1 + base] == null ? null : data[1 + base];\n\n    /** @private {?boolean} */\n    this.oneTime_ = data[2 + base] == null ? null : data[2 + base];\n\n    /** @private {?string} */\n    this.playOffer_ = data[3 + base] == null ? null : data[3 + base];\n\n    /** @private {?string} */\n    this.oldPlayOffer_ = data[4 + base] == null ? null : data[4 + base];\n\n    /** @private {?string} */\n    this.customMessage_ = data[5 + base] == null ? null : data[5 + base];\n\n    /** @private {?boolean} */\n    this.anonymous_ = data[6 + base] == null ? null : data[6 + base];\n  }\n\n  /**\n   * @return {?string}\n   */\n  getSku() {\n    return this.sku_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setSku(value) {\n    this.sku_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getOldSku() {\n    return this.oldSku_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setOldSku(value) {\n    this.oldSku_ = value;\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getOneTime() {\n    return this.oneTime_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setOneTime(value) {\n    this.oneTime_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getPlayOffer() {\n    return this.playOffer_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setPlayOffer(value) {\n    this.playOffer_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getOldPlayOffer() {\n    return this.oldPlayOffer_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setOldPlayOffer(value) {\n    this.oldPlayOffer_ = value;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getCustomMessage() {\n    return this.customMessage_;\n  }\n\n  /**\n   * @param {string} value\n   */\n  setCustomMessage(value) {\n    this.customMessage_ = value;\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getAnonymous() {\n    return this.anonymous_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setAnonymous(value) {\n    this.anonymous_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.sku_, // field 1 - sku\n        this.oldSku_, // field 2 - old_sku\n        this.oneTime_, // field 3 - one_time\n        this.playOffer_, // field 4 - play_offer\n        this.oldPlayOffer_, // field 5 - old_play_offer\n        this.customMessage_, // field 6 - custom_message\n        this.anonymous_, // field 7 - anonymous\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'SkuSelectedResponse';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass SmartBoxMessage {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?boolean} */\n    this.isClicked_ = data[base] == null ? null : data[base];\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getIsClicked() {\n    return this.isClicked_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setIsClicked(value) {\n    this.isClicked_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.isClicked_, // field 1 - is_clicked\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'SmartBoxMessage';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass SubscribeResponse$1 {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?boolean} */\n    this.subscribe_ = data[base] == null ? null : data[base];\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getSubscribe() {\n    return this.subscribe_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setSubscribe(value) {\n    this.subscribe_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.subscribe_, // field 1 - subscribe\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'SubscribeResponse';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass Timestamp {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?number} */\n    this.seconds_ = data[base] == null ? null : data[base];\n\n    /** @private {?number} */\n    this.nanos_ = data[1 + base] == null ? null : data[1 + base];\n  }\n\n  /**\n   * @return {?number}\n   */\n  getSeconds() {\n    return this.seconds_;\n  }\n\n  /**\n   * @param {number} value\n   */\n  setSeconds(value) {\n    this.seconds_ = value;\n  }\n\n  /**\n   * @return {?number}\n   */\n  getNanos() {\n    return this.nanos_;\n  }\n\n  /**\n   * @param {number} value\n   */\n  setNanos(value) {\n    this.nanos_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.seconds_, // field 1 - seconds\n        this.nanos_, // field 2 - nanos\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'Timestamp';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass ToastCloseRequest {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?boolean} */\n    this.close_ = data[base] == null ? null : data[base];\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getClose() {\n    return this.close_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setClose(value) {\n    this.close_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.close_, // field 1 - close\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'ToastCloseRequest';\n  }\n}\n\n/**\n * @implements {Message}\n */\nclass ViewSubscriptionsResponse {\n  /**\n   * @param {!Array<*>=} data\n   * @param {boolean=} includesLabel\n   */\n  constructor(data = [], includesLabel = true) {\n    const base = includesLabel ? 1 : 0;\n\n    /** @private {?boolean} */\n    this.native_ = data[base] == null ? null : data[base];\n  }\n\n  /**\n   * @return {?boolean}\n   */\n  getNative() {\n    return this.native_;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setNative(value) {\n    this.native_ = value;\n  }\n\n  /**\n   * @param {boolean=} includeLabel\n   * @return {!Array<?>}\n   * @override\n   */\n  toArray(includeLabel = true) {\n    const arr = [\n        this.native_, // field 1 - native\n    ];\n    if (includeLabel) {\n      arr.unshift(this.label());\n    }\n    return arr;\n  }\n\n  /**\n   * @return {string}\n   * @override\n   */\n  label() {\n    return 'ViewSubscriptionsResponse';\n  }\n}\n\nconst PROTO_MAP = {\n  'AccountCreationRequest': AccountCreationRequest,\n  'AlreadySubscribedResponse': AlreadySubscribedResponse,\n  'AnalyticsContext': AnalyticsContext,\n  'AnalyticsEventMeta': AnalyticsEventMeta,\n  'AnalyticsRequest': AnalyticsRequest,\n  'EntitlementJwt': EntitlementJwt,\n  'EntitlementsRequest': EntitlementsRequest,\n  'EntitlementsResponse': EntitlementsResponse,\n  'EventParams': EventParams,\n  'FinishedLoggingResponse': FinishedLoggingResponse,\n  'LinkSaveTokenRequest': LinkSaveTokenRequest,\n  'LinkingInfoResponse': LinkingInfoResponse,\n  'OpenDialogRequest': OpenDialogRequest,\n  'SkuSelectedResponse': SkuSelectedResponse,\n  'SmartBoxMessage': SmartBoxMessage,\n  'SubscribeResponse': SubscribeResponse$1,\n  'Timestamp': Timestamp,\n  'ToastCloseRequest': ToastCloseRequest,\n  'ViewSubscriptionsResponse': ViewSubscriptionsResponse,\n};\n\n/**\n * Utility to deserialize a buffer\n * @param {!Array<*>} data\n * @return {!Message}\n */\nfunction deserialize(data) {\n  /** {?string} */\n  const key = data ? data[0] : null;\n  if (key) {\n    const ctor = PROTO_MAP[key];\n    if (ctor) {\n      return new ctor(data);\n    }\n  }\n  throw new Error('Deserialization failed for ' + data);\n}\n\n/**\n * @param {function(new: T)} messageType\n * @return {string}\n * @template T\n */\nfunction getLabel(messageType) {\n  const message = /** @type {!Message} */ (new messageType());\n  return message.label();\n}\n\n/**\n * Copyright 2019 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @enum {number}  */\nconst FilterResult = {\n  /** The event is allowed to proceed to the listeners. */\n  PROCESS_EVENT: 0,\n  /** The event is canceled and the listeners are not informed about it. */\n  CANCEL_EVENT: 1,\n};\n\n/**\n * Defines a client event in SwG\n * Properties:\n * - eventType: Required. The AnalyticsEvent type that occurred.\n * - eventOriginator: Required.  The codebase that initiated the event.\n * - isFromUserAction: Optional.  True if the user took an action to generate\n *   the event.\n * - additionalParameters: Optional.  A JSON object to store generic data.\n *\n *  @typedef {{\n *    eventType: ?AnalyticsEventDef,\n *    eventOriginator: !EventOriginatorDef,\n *    isFromUserAction: ?boolean,\n *    additionalParameters: ?Object,\n * }}\n */\nlet ClientEvent;\n\n/* eslint-disable no-unused-vars */\n/**\n * @interface\n */\nclass ClientEventManagerApi {\n  /**\n   * Call this function to log an event. The registered listeners will be\n   * invoked unless the event is filtered.\n   * @param {!function(!ClientEvent)} listener\n   */\n  registerEventListener(listener) {}\n\n  /**\n   * Register a filterer for events if you need to potentially prevent the\n   * listeners from hearing about it.  A filterer should return\n   * FilterResult.CANCEL_EVENT to prevent listeners from hearing about the\n   * event.\n   * @param {!function(!ClientEvent):FilterResult} filterer\n   */\n  registerEventFilterer(filterer) {}\n\n  /**\n   * Call this function to log an event.  It will immediately throw an error if\n   * the event is invalid.  It will then asynchronously call the filterers and\n   * stop the event if a filterer cancels it.  After that, it will call each\n   * listener asynchronously.\n   * @param {!ClientEvent} event\n   */\n  logEvent(event) {}\n}\n/* eslint-enable no-unused-vars */\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * abstract View Class. Used to render the content within the Dialog. The\n * extended class has actual content.\n * @abstract\n */\nclass View {\n  /**\n   * Empty constructor.\n   */\n  constructor() {}\n\n  /**\n   * Gets the iframe element.\n   * @return {!Element}\n   * @abstract\n   */\n  getElement() {}\n\n  /**\n   * @param {!./dialog.Dialog} unusedDialog\n   * @return {!Promise}\n   * @abstract\n   */\n  init(unusedDialog) {}\n\n  /**\n   * Resizes the content.\n   */\n  resized() {\n    // Do nothing by default. Override if needed.\n  }\n\n  /**\n   * Accept the result.\n   * @return {!Promise}\n   * @abstract\n   */\n  whenComplete() {}\n\n  /**\n   * @return {boolean}\n   * @abstract\n   */\n  shouldFadeBody() {}\n\n  /**\n   * @return {boolean}\n   * @abstract\n   */\n  hasLoadingIndicator() {}\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {!../components/activities.ActivityPortDef} port\n * @param {string} requireOrigin\n * @param {boolean} requireOriginVerified\n * @param {boolean} requireSecureChannel\n * @return {!Promise<!Object>}\n */\nfunction acceptPortResultData(\n  port,\n  requireOrigin,\n  requireOriginVerified,\n  requireSecureChannel\n) {\n  return port.acceptResult().then((result) => {\n    if (\n      result.origin != requireOrigin ||\n      (requireOriginVerified && !result.originVerified) ||\n      (requireSecureChannel && !result.secureChannel)\n    ) {\n      throw new Error('channel mismatch');\n    }\n    return result.data;\n  });\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Debug logger, only log message if #swg.log=1\n * @param {...*} var_args [decription]\n */\n\n/* eslint-disable */\n\nfunction debugLog(var_args) {\n  if (/swg.debug=1/.test(self.location.hash)) {\n    const logArgs = Array.prototype.slice.call(arguments, 0);\n    logArgs.unshift('[Subscriptions]');\n    log.apply(log, logArgs);\n  }\n}\n\n/**\n * @param  {...*} var_args [description]\n */\nfunction log(var_args) {\n  console.log.apply(console, arguments);\n}\n\n/**\n * @param  {...*} var_args [description]\n */\nfunction warn(var_args) {\n  console.warn.apply(console, arguments);\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {string=} message The assertion message\n * @param {...*} var_args Arguments substituted into %s in the message.\n * @return {T} The value of shouldBeTrueish.\n * @template T\n */\nfunction assert(shouldBeTrueish, message, var_args) {\n  let firstElement;\n  if (!shouldBeTrueish) {\n    message = message || 'Assertion failed';\n    const splitMessage = message.split('%s');\n    const first = splitMessage.shift();\n    let formatted = first;\n    const messageArray = [];\n    pushIfNonEmpty(messageArray, first);\n    for (let i = 2; i < arguments.length; i++) {\n      const val = arguments[i];\n      if (val && val.tagName) {\n        firstElement = val;\n      }\n      const nextConstant = splitMessage.shift();\n      messageArray.push(val);\n      pushIfNonEmpty(messageArray, nextConstant.trim());\n      formatted += toString(val) + nextConstant;\n    }\n    const e = new Error(formatted);\n    e.fromAssert = true;\n    e.associatedElement = firstElement;\n    e.messageArray = messageArray;\n    throw e;\n  }\n  return shouldBeTrueish;\n}\n\n/**\n * @param {!Array} array\n * @param {*} val\n */\nfunction pushIfNonEmpty(array, val) {\n  if (val != '') {\n    array.push(val);\n  }\n}\n\nfunction toString(val) {\n  // Do check equivalent to `val instanceof Element` without cross-window bug\n  if (val && val.nodeType == 1) {\n    return val.tagName.toLowerCase() + (val.id ? '#' + val.id : '');\n  }\n  return /** @type {string} */ (val);\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns a map-like object.\n * If initial is provided, copies its own properties into the\n * newly created object.\n * @param {Object=} initial This should typically be an object literal.\n * @return {!Object}\n * @template T\n */\nfunction map(initial) {\n  const obj = Object.create(null);\n  if (initial) {\n    Object.assign(obj, initial);\n  }\n  return obj;\n}\n\n/**\n * Implements `Array.find()` method that's not yet available in all browsers.\n *\n * @param {?Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} predicate\n * @return {?T}\n * @template T\n */\nfunction findInArray(array, predicate) {\n  if (!array) {\n    return null;\n  }\n  const len = array.length || 0;\n  if (len > 0) {\n    for (let i = 0; i < len; i++) {\n      const other = array[i];\n      if (predicate(other, i, array)) {\n        return other;\n      }\n    }\n  }\n  return null;\n}\n\n/**\n * Copyright 2019 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns an array of random values.  The length of the array is numInts.  Each\n * int will be >= 0 and < maxVal.\n * @param {!number} numInts\n * @param {!number} maxVal\n */\nfunction getRandomInts(numInts, maxVal) {\n  // Ensure array type is appropriate for the max value (performance)\n  const arr =\n    maxVal < 256\n      ? new Uint8Array(numInts)\n      : maxVal < 32768\n      ? new Uint16Array(numInts)\n      : new Uint32Array(numInts);\n\n  const isIE = !!self['msCrypto'];\n  const localCrypto = isIE ? self['msCrypto'] : self.crypto;\n  if (localCrypto && localCrypto.getRandomValues) {\n    localCrypto.getRandomValues(arr);\n    for (let i = arr.length - 1; i > -1; i--) {\n      arr[i] = arr[i] % maxVal;\n    }\n  } else {\n    // For older browsers\n    for (let i = arr.length - 1; i > -1; i--) {\n      arr[i] = Math.floor(Math.random() * maxVal);\n    }\n  }\n\n  return arr;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Character mapping from base64url to base64.\n * @const {!Object<string, string>}\n */\nconst base64UrlDecodeSubs = {'-': '+', '_': '/'};\n\n/**\n * Character mapping from base64 to base64url.\n * @const {!Object<string, string>}\n */\nconst base64UrlEncodeSubs = {'+': '-', '/': '_', '=': ''};\n\n/**\n * Converts a string which holds 8-bit code points, such as the result of atob,\n * into a Uint8Array with the corresponding bytes.\n * If you have a string of characters, you probably want to be using utf8Encode.\n * @param {string} str\n * @return {!Uint8Array}\n */\nfunction stringToBytes(str) {\n  const bytes = new Uint8Array(str.length);\n  for (let i = 0; i < str.length; i++) {\n    const charCode = str.charCodeAt(i);\n    assert(charCode <= 255, 'Characters must be in range [0,255]');\n    bytes[i] = charCode;\n  }\n  return bytes;\n}\n\n/**\n * Converts a 8-bit bytes array into a string\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nfunction bytesToString(bytes) {\n  // Intentionally avoids String.fromCharCode.apply so we don't suffer a\n  // stack overflow. #10495, https://jsperf.com/bytesToString-2\n  const array = new Array(bytes.length);\n  for (let i = 0; i < bytes.length; i++) {\n    array[i] = String.fromCharCode(bytes[i]);\n  }\n  return array.join('');\n}\n\n/**\n * Interpret a byte array as a UTF-8 string.\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nfunction utf8DecodeSync(bytes) {\n  if (typeof TextDecoder !== 'undefined') {\n    return new TextDecoder('utf-8').decode(bytes);\n  }\n  const asciiString = bytesToString(new Uint8Array(bytes));\n  return decodeURIComponent(escape(asciiString));\n}\n\n/**\n * Turn a string into UTF-8 bytes.\n * @param {string} string\n * @return {!Uint8Array}\n */\nfunction utf8EncodeSync(string) {\n  if (typeof TextEncoder !== 'undefined') {\n    return new TextEncoder('utf-8').encode(string);\n  }\n  return stringToBytes(unescape(encodeURIComponent(string)));\n}\n\n/**\n * Converts a string which is in base64url encoding into a Uint8Array\n * containing the decoded value.\n * @param {string} str\n * @return {!Uint8Array}\n */\nfunction base64UrlDecodeToBytes(str) {\n  const encoded = atob(str.replace(/[-_]/g, (ch) => base64UrlDecodeSubs[ch]));\n  return stringToBytes(encoded);\n}\n\n/**\n * Converts a bytes array into base64url encoded string.\n * base64url is defined in RFC 4648. It is sometimes referred to as \"web safe\".\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nfunction base64UrlEncodeFromBytes(bytes) {\n  const str = bytesToString(bytes);\n  return btoa(str).replace(/[+/=]/g, (ch) => base64UrlEncodeSubs[ch]);\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst CHARS$1 = '0123456789ABCDEF';\n\n/**\n * Polyfill for String.prototype.startsWith.\n * @param {string} string\n * @param {string} prefix\n * @return {boolean}\n */\nfunction startsWith(string, prefix) {\n  if (prefix.length > string.length) {\n    return false;\n  }\n  return string.lastIndexOf(prefix, 0) == 0;\n}\n\n/**\n * Ensures the passed value is safe to use for character 19 per rfc4122,\n * sec. 4.1.5.  \"Sets the high bits of clock sequence\".\n * @param {!number} v\n */\nfunction getChar19(v) {\n  return CHARS$1[(v & 0x3) | 0x8];\n}\n\n/**\n * The returned identifier will always be an 8 digit valid hexidecimal number\n * and will be unique for each MS within a given month.\n * @return {string}\n */\nfunction getMonthlyTimeIdentifier() {\n  const hexTime = Date.now().toString(16);\n  return hexTime.substring(hexTime.length - 8).toUpperCase();\n}\n\n/**\n * Generates a RFC 4122 V4 UUID. Ex: \"92329D39-6F5C-4520-ABFC-AAB64544E172\"\n * The first 8 digits are unique for the millisecond of the month.  The rest\n * are randomly generated.\n */\nfunction getUuid() {\n  let uuid = getMonthlyTimeIdentifier() + '-';\n  let rIndex = 0;\n  const rands = getRandomInts(23, 16);\n  for (let i = 9; i < 36; i++) {\n    switch (i) {\n      case 13:\n      case 18:\n      case 23:\n        uuid += '-';\n        break;\n      case 14:\n        uuid += '4';\n        break;\n      case 19:\n        uuid += getChar19(rands[rIndex++]);\n        break;\n      default:\n        uuid += CHARS$1[rands[rIndex++]];\n        break;\n    }\n  }\n  return uuid;\n}\n\nfunction getSwgTransactionId() {\n  return getUuid() + '.swg';\n}\n\n/**\n * Returns a string whose length matches the length of format.\n * @param {string} str\n * @param {string} format\n * @return {string}\n */\nfunction padString(str, format) {\n  return (format + str).slice(-format.length);\n}\n\nconst PADDING = '00000000';\nfunction toHex(buffer) {\n  const hexCodes = [];\n  const view = new DataView(buffer);\n  for (let i = 0; i < view.byteLength; i += 4) {\n    // toString(16) will give the hex representation of the number without padding\n    const stringValue = view.getUint32(i).toString(16);\n    hexCodes.push(padString(stringValue, PADDING));\n  }\n  return hexCodes.join('');\n}\n\n/**\n * Returns a hexadecimal 128 character string that is the\n * SHA-512 hash of the passed string.\n * @param {string} stringToHash\n * @return {!Promise<string>}\n */\nfunction hash(stringToHash) {\n  const crypto = self.crypto || self.msCrypto;\n  const subtle = crypto?.subtle;\n\n  if (!subtle) {\n    const message = 'Swgjs only works on secure (HTTPS or localhost) pages.';\n    warn(message);\n    return Promise.reject(message);\n  }\n\n  return subtle\n    .digest('SHA-512', utf8EncodeSync(stringToHash))\n    .then((digest) => toHex(digest));\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @type {Object<string, string>} */\nlet propertyNameCache;\n\n/** @const {!Array<string>} */\nconst vendorPrefixes = ['Webkit', 'webkit', 'Moz', 'moz', 'ms', 'O', 'o'];\n\n/**\n * Default styles to be set for top level friendly iframe.\n * Some attributes are not included such as height, left, margin-left; since\n * these attributes are updated by @media queries and having these values\n * defined here as !important does not work on IE/edge browsers.\n * @const {!Object<string, string|number>}\n */\nconst defaultStyles = {\n  'align-content': 'normal',\n  'animation': 'none',\n  'align-items': 'normal',\n  'align-self': 'auto',\n  'alignment-baseline': 'auto',\n  'backface-visibility': 'hidden',\n  'background-clip': 'border-box',\n  'background-image': 'none',\n  'baseline-shift': '0',\n  'block-size': 'auto',\n  'border': 'none',\n  'border-collapse': 'separate',\n  'bottom': '0',\n  'box-sizing': 'border-box',\n  'break-after': 'auto',\n  'break-before': 'auto',\n  'break-inside': 'auto',\n  'buffered-rendering': 'auto',\n  'caption-side': 'top',\n  'caret-color': 'rgb(51, 51, 51)',\n  'clear': 'none',\n  'color': 'rgb(51, 51, 51)',\n  'color-rendering': 'auto',\n  'column-count': 'auto',\n  'column-fill': 'balance',\n  'column-gap': 'normal',\n  'column-rule-color': 'rgb(51, 51, 51)',\n  'column-rule-style': 'none',\n  'column-rule-width': '0',\n  'column-span': 'none',\n  'column-width': 'auto',\n  'contain': 'none',\n  'counter-increment': 'none',\n  'counter-reset': 'none',\n  'cursor': 'auto',\n  'direction': 'inherit',\n  'display': 'block',\n  'empty-cells': 'show',\n  'filter': 'none',\n  'flex': 'none', // flex-grow, flex-shrink, and flex-basis.\n  'flex-flow': 'row nowrap', // flex-direction, flex-wrap.\n  'float': 'none',\n  'flood-color': 'rgb(0, 0, 0)',\n  'flood-opacity': '1',\n  'font': 'none',\n  'font-size': 'medium',\n  'font-family': '',\n  'height': 'auto',\n  'hyphens': 'manual',\n  'image-rendering': 'auto',\n  'inline-size': '', // Setting to 'auto' will not allow override.\n  'isolation': 'auto',\n  'justify-content': 'normal',\n  'justify-items': 'normal',\n  'justify-self': 'auto',\n  'letter-spacing': 'normal',\n  'lighting-color': 'rgb(255, 255, 255)',\n  'line-break': 'auto',\n  'line-height': 'normal',\n  'margin-bottom': '0',\n  'mask': 'none',\n  'max-block-size': 'none',\n  'max-height': 'none',\n  'max-inline-size': 'none',\n  'max-width': 'none',\n  'min-block-size': 'none',\n  'min-height': '0',\n  'min-inline-size': '0',\n  'min-width': '0',\n  'mix-blend-mode': 'normal',\n  'object-fit': 'fill', // Important for Safari browser.\n  'offset-distance': 'none', // Chrome only (Experimental).\n  'offset-path': 'none', // Chrome only (Experimental).\n  'offset-rotate': 'auto 0deg', // Chrome only (Experimental).\n  'opacity': '1',\n  'order': '0',\n  'orphans': '2',\n  'outline': 'none',\n  'overflow-anchor': 'auto',\n  'overflow-wrap': 'normal',\n  'overflow': 'visible',\n  'padding': '0',\n  'page': '',\n  'perspective': 'none',\n  'pointer-events': 'auto',\n  'position': 'static',\n  'quotes': '',\n  'resize': 'none',\n  'right': '0',\n  'scroll-behavior': 'auto',\n  'tab-size': '8', // Only Chrome, Safari (Experimental).\n  'table-layout': 'auto',\n  'text-align': 'start',\n  'text-align-last': 'auto',\n  'text-anchor': 'start',\n  'text-combine-upright': 'none',\n  'text-decoration': 'none',\n  'text-indent': '0',\n  'text-orientation': 'mixed',\n  'text-overflow': 'clip',\n  'text-rendering': 'auto',\n  'text-shadow': 'none',\n  'text-size-adjust': 'auto',\n  'text-transform': 'none',\n  'text-underline-position': 'auto',\n  'top': 'auto',\n  'touch-action': 'auto',\n  'transform': 'none',\n  'transition': 'none 0s ease 0s',\n  'unicode-bidi': 'normal',\n  'user-select': 'auto',\n  'vector-effect': 'none',\n  'vertical-align': 'baseline',\n  'visibility': 'visible',\n  'white-space': 'normal',\n  'widows': '2',\n  'word-break': 'normal',\n  'word-spacing': '0',\n  'word-wrap': 'normal',\n  'writing-mode': 'horizontal-tb',\n  'zoom': '1',\n  'z-index': 'auto',\n};\n\n/**\n * @param {string} camelCase camel cased string\n * @return {string} title cased string\n */\nfunction camelCaseToTitleCase(camelCase) {\n  return camelCase.charAt(0).toUpperCase() + camelCase.slice(1);\n}\n\n/**\n * Checks the style if a prefixed version of a property exists and returns\n * it or returns an empty string.\n * @private\n * @param {!Object} style\n * @param {string} titleCase the title case version of a css property name\n * @return {string} the prefixed property name or null.\n */\nfunction getVendorJsPropertyName_(style, titleCase) {\n  for (let i = 0; i < vendorPrefixes.length; i++) {\n    const propertyName = vendorPrefixes[i] + titleCase;\n    if (style[propertyName] !== undefined) {\n      return propertyName;\n    }\n  }\n  return '';\n}\n\n/**\n * Returns the possibly prefixed JavaScript property name of a style property\n * (ex. WebkitTransitionDuration) given a camelCase'd version of the property\n * (ex. transitionDuration).\n * @param {!Object} style\n * @param {string} camelCase the camel cased version of a css property name\n * @param {boolean=} bypassCache bypass the memoized cache of property\n *   mapping\n * @return {string}\n */\nfunction getVendorJsPropertyName(style, camelCase, bypassCache) {\n  if (startsWith(camelCase, '--')) {\n    // CSS vars are returned as is.\n    return camelCase;\n  }\n  if (!propertyNameCache) {\n    propertyNameCache = map();\n  }\n  let propertyName = propertyNameCache[camelCase];\n  if (!propertyName || bypassCache) {\n    propertyName = camelCase;\n    if (style[camelCase] === undefined) {\n      const titleCase = camelCaseToTitleCase(camelCase);\n      const prefixedPropertyName = getVendorJsPropertyName_(style, titleCase);\n\n      if (style[prefixedPropertyName] !== undefined) {\n        propertyName = prefixedPropertyName;\n      }\n    }\n    if (!bypassCache) {\n      propertyNameCache[camelCase] = propertyName;\n    }\n  }\n  return propertyName;\n}\n\n/**\n * Sets the CSS styles of the specified element with !important. The styles\n * are specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, string|number>} styles\n */\nfunction setImportantStyles$1(element, styles) {\n  for (const k in styles) {\n    element.style.setProperty(\n      getVendorJsPropertyName(styles, k),\n      styles[k].toString(),\n      'important'\n    );\n  }\n}\n\n/**\n * Sets the CSS style of the specified element with optional units, e.g. \"px\".\n * @param {Element} element\n * @param {string} property\n * @param {?string|number|boolean} value\n * @param {string=} units\n * @param {boolean=} bypassCache\n */\nfunction setStyle(element, property, value, units, bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    bypassCache\n  );\n  if (propertyName) {\n    element.style[propertyName] = /** @type {string} */ (\n      units ? value + units : value\n    );\n  }\n}\n\n/**\n * Sets the CSS styles of the specified element. The styles\n * a specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, ?string|number|boolean>} styles\n */\nfunction setStyles(element, styles) {\n  for (const k in styles) {\n    setStyle(element, k, styles[k]);\n  }\n}\n\n/**\n * Resets styles that were set dynamically (i.e. inline)\n * @param {!Element} element\n * @param {!Array<string>} properties\n */\nfunction resetStyles(element, properties) {\n  const styleObj = {};\n  properties.forEach((prop) => {\n    styleObj[prop] = null;\n  });\n  setStyles(element, styleObj);\n}\n\n/**\n * Resets all the styles of an element to a given value. Defaults to null.\n * The valid values are 'inherit', 'initial', 'unset' or null.\n * @param {!Element} element\n */\nfunction resetAllStyles(element) {\n  setImportantStyles$1(element, defaultStyles);\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {string} */\nconst styleType = 'text/css';\n\n/**\n * Add attributes to an element.\n * @param {!Element} element\n * @param {!Object<string, string|number|boolean|!Object<string, string|number|boolean>>} attributes\n * @return {!Element} updated element.\n */\nfunction addAttributesToElement(element, attributes) {\n  for (const attr in attributes) {\n    if (attr == 'style') {\n      setStyles(\n        element,\n        /** @type {!Object<string, string|boolean|number>} */\n        (attributes[attr])\n      );\n    } else {\n      element.setAttribute(\n        attr,\n        /** @type {string|boolean|number} */ (attributes[attr])\n      );\n    }\n  }\n  return element;\n}\n\n/**\n * Create a new element on document with specified tagName and attributes.\n * @param {!Document} doc\n * @param {string} tagName\n * @param {!Object<string, string>} attributes\n * @param {?(string|!Node|!ArrayLike<!Node>|!Array<!Node>)=} content\n * @return {!Element} created element.\n */\nfunction createElement(doc, tagName, attributes, content) {\n  const element = doc.createElement(tagName);\n  addAttributesToElement(element, attributes);\n  if (content != null) {\n    if (typeof content == 'string') {\n      element.textContent = content;\n    } else if (content.nodeType) {\n      element.appendChild(/** @type {!Node} */ (content));\n    } else if ('length' in content) {\n      for (let i = 0; i < content.length; i++) {\n        element.appendChild(content[i]);\n      }\n    } else {\n      assert(false, 'Unsupported content: %s', content);\n    }\n  }\n  return element;\n}\n\n/**\n * Removes the element.\n * @param {!Element} element\n */\nfunction removeElement(element) {\n  if (element.parentElement) {\n    element.parentElement.removeChild(element);\n  }\n}\n\n/**\n * Removes all children from the parent element.\n * @param {!Element} parent\n */\nfunction removeChildren(parent) {\n  parent.textContent = '';\n}\n\n/**\n * Injects the provided styles in the HEAD section of the document.\n * @param {!../model/doc.Doc} doc The document object.\n * @param {string} styleText The style string.\n * @return {!Element}\n */\nfunction injectStyleSheet(doc, styleText) {\n  const styleElement = createElement(doc.getWin().document, 'style', {\n    'type': styleType,\n  });\n  styleElement.textContent = styleText;\n  doc.getHead().appendChild(styleElement);\n  return styleElement;\n}\n\n/**\n * Polyfill of the `Node.isConnected` API. See\n * https://developer.mozilla.org/en-US/docs/Web/API/Node/isConnected.\n * @param {!Node} node\n * @return {boolean}\n */\nfunction isConnected(node) {\n  // Ensure that node is attached if specified. This check uses a new and\n  // fast `isConnected` API and thus only checked on platforms that have it.\n  // See https://www.chromestatus.com/feature/5676110549352448.\n  if ('isConnected' in node) {\n    return node['isConnected'];\n  }\n  // Polyfill.\n  const root = node.ownerDocument && node.ownerDocument.documentElement;\n  return (root && root.contains(node)) || false;\n}\n\n/**\n * Returns true if current browser is a legacy version of Edge.\n *\n * Starting in January 2020, new versions of Edge will use the Chromium engine.\n * These versions won't include the word \"Edge\" in their useragent.\n * Instead, they'll include the word \"Edg\".\n * So far, it seems safe to avoid detecting these new versions of Edge.\n * @param {!Window} win\n * @return {boolean}\n */\nfunction isLegacyEdgeBrowser(win) {\n  const nav = win.navigator;\n  return /Edge/i.test(nav && nav.userAgent);\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst {\n  createAbortError,\n  isAbortError,\n} = require('web-activities/activity-ports');\n\n/**\n * Whether the specified error is an AbortError type.\n * See https://heycam.github.io/webidl/#aborterror.\n * @param {*} error\n * @return {boolean}\n */\nfunction isCancelError(error) {\n  return isAbortError(error);\n}\n\n/**\n * Creates or emulates a DOMException of AbortError type.\n * See https://heycam.github.io/webidl/#aborterror.\n * @param {!Window} win\n * @param {string=} message\n * @return {!DOMException}\n */\nfunction createCancelError(win, message) {\n  return createAbortError(win, message);\n}\n\n/**\n * A set of error utilities combined in a class to allow easy stubbing in tests.\n */\nclass ErrorUtils {\n  /**\n   * @param {!Error} error\n   */\n  static throwAsync(error) {\n    setTimeout(() => {\n      throw error;\n    });\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {!Object<string, string>} */\nconst iframeAttributes$2 = {\n  'frameborder': '0',\n  'scrolling': 'no',\n};\n\n/**\n * Class to build and render Activity iframe view.\n */\nclass ActivityIframeView extends View {\n  /**\n   * @param {!Window} win\n   * @param {!../components/activities.ActivityPorts} activityPorts\n   * @param {string} src\n   * @param {!Object<string, ?>=} args\n   * @param {boolean=} shouldFadeBody\n   * @param {boolean=} hasLoadingIndicator\n   */\n  constructor(\n    win,\n    activityPorts,\n    src,\n    args,\n    shouldFadeBody = false,\n    hasLoadingIndicator = false\n  ) {\n    super();\n\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private @const {!Document} */\n    this.doc_ = this.win_.document;\n\n    /** @private @const {!HTMLIFrameElement} */\n    this.iframe_ = /** @type {!HTMLIFrameElement} */ (\n      createElement(this.doc_, 'iframe', iframeAttributes$2)\n    );\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = activityPorts;\n\n    /** @private @const {string} */\n    this.src_ = src;\n\n    /** @private @const {!Object<string, ?>} */\n    this.args_ = args || {};\n\n    /** @private @const {boolean} */\n    this.shouldFadeBody_ = shouldFadeBody;\n\n    /** @private @const {boolean} */\n    this.hasLoadingIndicator_ = hasLoadingIndicator;\n\n    /** @private {?../components/activities.ActivityIframePort} */\n    this.port_ = null;\n\n    /**\n     * @private\n     * {?function<!web-activities/activity-ports.ActivityIframePort|!Promise>}\n     */\n    this.portResolver_ = null;\n\n    /**\n     * @private @const\n     * {!Promise<!web-activities/activity-ports.ActivityIframePort>}\n     */\n    this.portPromise_ = new Promise((resolve) => {\n      this.portResolver_ = resolve;\n    });\n  }\n\n  /** @override */\n  getElement() {\n    return this.iframe_;\n  }\n\n  /** @override */\n  init(dialog) {\n    return this.activityPorts_\n      .openIframe(this.iframe_, this.src_, this.args_)\n      .then((port) => this.onOpenIframeResponse_(port, dialog));\n  }\n\n  /**\n   * Returns if document should fade for this view.\n   * @return {boolean}\n   */\n  shouldFadeBody() {\n    return this.shouldFadeBody_;\n  }\n\n  /**\n   * Returns if the view shows loading indicator.\n   * @return {boolean}\n   */\n  hasLoadingIndicator() {\n    return this.hasLoadingIndicator_;\n  }\n\n  /**\n   * @param {!../components/activities.ActivityIframePort} port\n   * @param {!../components/dialog.Dialog} dialog\n   * @return {!Promise}\n   */\n  onOpenIframeResponse_(port, dialog) {\n    this.port_ = port;\n    this.portResolver_(port);\n\n    this.port_.onResizeRequest((height) => {\n      dialog.resizeView(this, height);\n    });\n\n    return this.port_.whenReady();\n  }\n\n  /**\n   * @return {!Promise<!../components/activities.ActivityIframePort>}\n   * @private\n   */\n  getPortPromise_() {\n    return this.portPromise_;\n  }\n\n  /**\n   * @param {!function(new: T)}  message\n   * @param {function(?)} callback\n   * @template T\n   */\n  on(message, callback) {\n    this.getPortPromise_().then((port) => {\n      port.on(message, callback);\n    });\n  }\n\n  /**\n   * @param {!../proto/api_messages.Message} request\n   */\n  execute(request) {\n    this.getPortPromise_().then((port) => {\n      port.execute(request);\n    });\n  }\n\n  /**\n   * Accepts results from the caller.\n   * @return {!Promise<!web-activities/activity-ports.ActivityResult>}\n   */\n  acceptResult() {\n    return this.getPortPromise_().then((port) => port.acceptResult());\n  }\n\n  /**\n   * Accepts results from the caller and verifies origin.\n   * @param {string} requireOrigin\n   * @param {boolean} requireOriginVerified\n   * @param {boolean} requireSecureChannel\n   * @return {!Promise<!Object>}\n   */\n  acceptResultAndVerify(\n    requireOrigin,\n    requireOriginVerified,\n    requireSecureChannel\n  ) {\n    return this.getPortPromise_().then((port) => {\n      return acceptPortResultData(\n        port,\n        requireOrigin,\n        requireOriginVerified,\n        requireSecureChannel\n      );\n    });\n  }\n\n  /**\n   * Completes the flow.\n   * @return {!Promise}\n   */\n  whenComplete() {\n    return this.acceptResult();\n  }\n\n  /**\n   * @param {function()} callback\n   */\n  onCancel(callback) {\n    this.acceptResult().catch((reason) => {\n      if (isCancelError(reason)) {\n        callback();\n      }\n      throw reason;\n    });\n  }\n\n  /** @override */\n  resized() {\n    if (this.port_) {\n      this.port_.resized();\n    }\n  }\n}\n\n/**\n * Copyright 2021 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst Constants$1 = {};\n\n/**\n * Local storage key for swgUserToken.\n *\n * @const {string}\n */\nConstants$1.USER_TOKEN = 'USER_TOKEN';\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview This module declares JSON types as defined in the\n * {@link http://json.org/}.\n */\n\n/**\n * Simple wrapper around JSON.parse that casts the return value\n * to JsonObject.\n * Create a new wrapper if an array return value is desired.\n * @param {*} json JSON string to parse\n * @return {?JsonObject|undefined} May be extend to parse arrays.\n */\nfunction parseJson(json) {\n  return /** @type {?JsonObject} */ (JSON.parse(/** @type {string} */ (json)));\n}\n\n/**\n * Parses the given `json` string without throwing an exception if not valid.\n * Returns `undefined` if parsing fails.\n * Returns the `Object` corresponding to the JSON string when parsing succeeds.\n * @param {*} json JSON string to parse\n * @param {function(!Error)=} onFailed Optional function that will be called\n *     with the error if parsing fails.\n * @return {?JsonObject|undefined} May be extend to parse arrays.\n */\nfunction tryParseJson(json, onFailed) {\n  try {\n    return parseJson(json);\n  } catch (e) {\n    if (onFailed) {\n      onFailed(e);\n    }\n    return undefined;\n  }\n}\n\n/**\n * Converts the passed string into a JSON object (if possible) and returns the\n * value of the propertyName on that object.\n * @param {string} jsonString\n * @param {string} propertyName\n * @return {*}\n */\nfunction getPropertyFromJsonString(jsonString, propertyName) {\n  const json = tryParseJson(jsonString);\n  return (json && json[propertyName]) || null;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Provides helper methods to decode and verify JWT tokens.\n */\nclass JwtHelper {\n  constructor() {}\n\n  /**\n   * Decodes JWT token and returns its payload.\n   * @param {string} encodedToken\n   * @return {?JsonObject|undefined}\n   */\n  decode(encodedToken) {\n    return this.decodeInternal_(encodedToken).payload;\n  }\n\n  /**\n   * @param {string} encodedToken\n   * @return {!JwtTokenInternalDef}\n   * @private\n   */\n  decodeInternal_(encodedToken) {\n    // See https://jwt.io/introduction/\n    /**\n     * Throws error about invalid token.\n     */\n    function invalidToken() {\n      throw new Error(`Invalid token: \"${encodedToken}\"`);\n    }\n\n    // Encoded token has three parts: header.payload.sig\n    // Note! The padding is not allowed by JWT spec:\n    // http://self-issued.info/docs/draft-goland-json-web-token-00.html#rfc.section.5\n    const parts = encodedToken.split('.');\n    if (parts.length != 3) {\n      invalidToken();\n    }\n    const headerUtf8Bytes = base64UrlDecodeToBytes(parts[0]);\n    const payloadUtf8Bytes = base64UrlDecodeToBytes(parts[1]);\n    return {\n      header: tryParseJson(utf8DecodeSync(headerUtf8Bytes), invalidToken),\n      payload: tryParseJson(utf8DecodeSync(payloadUtf8Bytes), invalidToken),\n      verifiable: `${parts[0]}.${parts[1]}`,\n      sig: parts[2],\n    };\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** Source for Google-provided metering entitlements. */\nconst GOOGLE_METERING_SOURCE = 'google:metering';\n\n/** Source for privileged entitlements. */\nconst PRIVILEGED_SOURCE = 'privileged';\n\n/** Subscription token for dev mode entitlements. */\nconst DEV_MODE_TOKEN = 'GOOGLE_DEV_MODE_TOKEN';\n\n/**\n * The holder of the entitlements for a service.\n */\nclass Entitlements {\n  /**\n   * @param {string} service\n   * @param {string} raw\n   * @param {!Array<!Entitlement>} entitlements\n   * @param {?string} currentProduct\n   * @param {function(!Entitlements)} ackHandler\n   * @param {function(!Entitlements, ?Function=)} consumeHandler\n   * @param {?boolean|undefined} isReadyToPay\n   * @param {?string|undefined} decryptedDocumentKey\n   */\n  constructor(\n    service,\n    raw,\n    entitlements,\n    currentProduct,\n    ackHandler,\n    consumeHandler,\n    isReadyToPay,\n    decryptedDocumentKey\n  ) {\n    /** @const {string} */\n    this.service = service;\n    /** @const {string} */\n    this.raw = raw;\n    /** @const {!Array<!Entitlement>} */\n    this.entitlements = entitlements;\n    /** @const {boolean} */\n    this.isReadyToPay = isReadyToPay || false;\n    /** @const {?string} */\n    this.decryptedDocumentKey = decryptedDocumentKey || null;\n\n    /** @private @const {?string} */\n    this.product_ = currentProduct;\n    /** @private @const {function(!Entitlements)} */\n    this.ackHandler_ = ackHandler;\n    /** @private @const {function(!Entitlements, ?Function=)} */\n    this.consumeHandler_ = consumeHandler;\n  }\n\n  /**\n   * @return {!Entitlements}\n   */\n  clone() {\n    return new Entitlements(\n      this.service,\n      this.raw,\n      this.entitlements.map((ent) => ent.clone()),\n      this.product_,\n      this.ackHandler_,\n      this.consumeHandler_,\n      this.isReadyToPay,\n      this.decryptedDocumentKey\n    );\n  }\n\n  /**\n   * @return {!Object}\n   */\n  json() {\n    return {\n      'service': this.service,\n      'entitlements': this.entitlements.map((item) => item.json()),\n      'isReadyToPay': this.isReadyToPay,\n    };\n  }\n\n  /**\n   * Returns true if the current article is unlocked by a cacheable entitlement.\n   * Metering entitlements aren't cacheable, because each metering entitlement\n   * is meant to be used for one article. Subscription entitlements that are\n   * not returned by dev mode are cacheable, because subscription entitlements\n   * are meant to be used across multiple articles on a publication.\n   * @return {boolean}\n   */\n  enablesThisWithCacheableEntitlements() {\n    const entitlement = this.getEntitlementForThis();\n    return (\n      !!entitlement &&\n      entitlement.source !== GOOGLE_METERING_SOURCE &&\n      entitlement.subscriptionToken !== DEV_MODE_TOKEN\n    );\n  }\n\n  /**\n   * Returns true if the current article is unlocked by a\n   * Google metering entitlement. These entitlements come\n   * from Google News Intiative's licensing program to support news.\n   * https://www.blog.google/outreach-initiatives/google-news-initiative/licensing-program-support-news-industry-/\n   * @return {boolean}\n   */\n  enablesThisWithGoogleMetering() {\n    const entitlement = this.getEntitlementForThis();\n    return !!entitlement && entitlement.source === GOOGLE_METERING_SOURCE;\n  }\n\n  /**\n   * @param {string=} source\n   * @return {boolean}\n   */\n  enablesThis(source) {\n    return this.enables(this.product_, source);\n  }\n\n  /**\n   * @param {string=} source\n   * @return {boolean}\n   */\n  enablesAny(source) {\n    for (let i = 0; i < this.entitlements.length; i++) {\n      if (\n        this.entitlements[i].products.length > 0 &&\n        (!source || source == this.entitlements[i].source)\n      ) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Whether these entitlements enable the specified product, optionally also\n   * restricting the source.\n   * @param {?string} product\n   * @param {string=} source\n   * @return {boolean}\n   */\n  enables(product, source) {\n    if (!product) {\n      return false;\n    }\n    return !!this.getEntitlementFor(product, source);\n  }\n\n  /**\n   * Returns the first matching entitlement for the current product,\n   * optionally also matching the specified source.\n   * @param {string=} source\n   * @return {?Entitlement}\n   */\n  getEntitlementForThis(source) {\n    return this.getEntitlementFor(this.product_, source);\n  }\n\n  /**\n   * Returns the first matching entitlement for the specified product,\n   * optionally also matching the specified source.\n   *\n   * Returns non-metering entitlements if possible, to avoid consuming\n   * metered reads unnecessarily.\n   *\n   * @param {?string} product\n   * @param {string=} source\n   * @return {?Entitlement}\n   */\n  getEntitlementFor(product, source) {\n    if (!product) {\n      // Require a product ID.\n      warn(\n        'SwG needs this article to define a product ID (e.g. example.com:premium). Articles can define a product ID using JSON+LD. SwG can check entitlements after this article defines a product ID.'\n      );\n      return null;\n    }\n\n    // Prefer subscription entitlements over metering entitlements.\n    // Metering entitlements are a limited resource. When a metering entitlement\n    // unlocks an article, that depletes the user's remaining \"free reads\".\n    // Subscription entitlements are *not* depleted when they unlock articles.\n    // They are essentially unlimited if the subscription remains valid.\n    // For this reason, subscription entitlements are preferred.\n    const entitlementsThatUnlockArticle = this.entitlements.filter(\n      (entitlement) =>\n        entitlement.enables(product) &&\n        (!source || source === entitlement.source)\n    );\n\n    const subscriptionEntitlement = findInArray(\n      entitlementsThatUnlockArticle,\n      (entitlement) => entitlement.source !== GOOGLE_METERING_SOURCE\n    );\n\n    const meteringEntitlement = findInArray(\n      entitlementsThatUnlockArticle,\n      (entitlement) => entitlement.source === GOOGLE_METERING_SOURCE\n    );\n\n    return subscriptionEntitlement || meteringEntitlement || null;\n  }\n\n  /**\n   * Returns the first matching entitlement for the specified source w/o\n   * matching any specific products.\n   * @param {string} source\n   * @return {?Entitlement}\n   */\n  getEntitlementForSource(source) {\n    if (this.entitlements.length > 0) {\n      for (let i = 0; i < this.entitlements.length; i++) {\n        if (\n          this.entitlements[i].subscriptionToken &&\n          source == this.entitlements[i].source\n        ) {\n          return this.entitlements[i];\n        }\n      }\n    }\n    return null;\n  }\n\n  /**\n   * A 3p site should call this method to acknowledge that it \"saw\" and\n   * \"understood\" entitlements.\n   */\n  ack() {\n    this.ackHandler_(this);\n  }\n\n  /**\n   * A 3p site should call this method to consume a Google metering entitlement.\n   * When a metering entitlement is consumed, SwG shows the user a metering dialog.\n   * When the user closes the dialog, SwG depletes one of the user's remaining\n   * \"free reads\".\n   * @param {?Function=} onCloseDialog Called after the user closes the dialog.\n   */\n  consume(onCloseDialog) {\n    this.consumeHandler_(this, onCloseDialog);\n  }\n}\n\n/**\n * The single entitlement object.\n */\nclass Entitlement {\n  /**\n   * @param {string} source\n   * @param {!Array<string>} products\n   * @param {string} subscriptionToken\n   */\n  constructor(source, products, subscriptionToken) {\n    /** @const {string} */\n    this.source = source;\n    /** @const {!Array<string>} */\n    this.products = products;\n    /** @const {string} */\n    this.subscriptionToken = subscriptionToken;\n  }\n\n  /**\n   * @return {!Entitlement}\n   */\n  clone() {\n    return new Entitlement(\n      this.source,\n      this.products.slice(0),\n      this.subscriptionToken\n    );\n  }\n\n  /**\n   * @return {!Object}\n   */\n  json() {\n    return {\n      'source': this.source,\n      'products': this.products,\n      'subscriptionToken': this.subscriptionToken,\n    };\n  }\n\n  /**\n   * @param {?string} product\n   * @return {boolean}\n   */\n  enables(product) {\n    if (!product) {\n      return false;\n    }\n    const eq = product.indexOf(':');\n    // Handle wildcards\n    if (eq != -1) {\n      // Wildcard product (publication:*) unlocks on any entitlement matching publication\n      const publication = product.substring(0, eq + 1);\n      if (\n        publication + '*' == product &&\n        this.products.filter(\n          (candidate) => candidate.substring(0, eq + 1) == publication\n        ).length >= 1\n      ) {\n        debugLog('enabled with wildcard productId');\n        return true;\n      }\n      // Wildcard entitlement allows any product matching this publication\n      if (this.products.includes(publication + '*')) {\n        debugLog('enabled with wildcard entitlement');\n        return true;\n      }\n    }\n    return this.products.includes(product);\n  }\n\n  /**\n   * @param {?Object} json\n   * @return {!Entitlement}\n   */\n  static parseFromJson(json) {\n    if (!json) {\n      json = {};\n    }\n    const source = json['source'] || '';\n    const products = json['products'] || [];\n    const subscriptionToken = json['subscriptionToken'];\n    return new Entitlement(source, products, subscriptionToken);\n  }\n\n  /**\n   * The JSON is expected in one of the forms:\n   * - Single entitlement: `{products: [], ...}`.\n   * - A list of entitlements: `[{products: [], ...}, {...}]`.\n   * @param {!Object|!Array<!Object>} json\n   * @return {!Array<!Entitlement>}\n   */\n  static parseListFromJson(json) {\n    const jsonList = Array.isArray(json)\n      ? /** @type {!Array<Object>} */ (json)\n      : [json];\n    return jsonList.map((json) => Entitlement.parseFromJson(json));\n  }\n\n  /**\n   * Returns the SKU associated with this entitlement.\n   * @return {?string}\n   */\n  getSku() {\n    if (this.source !== 'google') {\n      return null;\n    }\n    const sku = /** @type {?string} */ (\n      getPropertyFromJsonString(this.subscriptionToken, 'productId') || null\n    );\n    if (!sku) {\n      warn('Unable to retrieve SKU from SwG subscription token');\n    }\n    return sku;\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n */\nclass UserData {\n  /**\n   * @param {string} idToken\n   * @param {!Object} data\n   */\n  constructor(idToken, data) {\n    /** @const {string} */\n    this.idToken = idToken;\n    /** @const {!Object} */\n    this.data = data;\n\n    /** @const {string} */\n    this.id = data['sub'];\n    /** @const {string} */\n    this.email = data['email'];\n    /** @const {boolean} */\n    this.emailVerified = data['email_verified'];\n    /** @const {string} */\n    this.name = data['name'];\n    /** @const {string} */\n    this.givenName = data['given_name'];\n    /** @const {string} */\n    this.familyName = data['family_name'];\n    /** @const {string} */\n    this.pictureUrl = data['picture'];\n  }\n\n  /**\n   * @return {!UserData}\n   */\n  clone() {\n    return new UserData(this.idToken, this.data);\n  }\n\n  /**\n   * @return {!Object}\n   */\n  json() {\n    return {\n      'id': this.id,\n      'email': this.email,\n      'emailVerified': this.emailVerified,\n      'name': this.name,\n      'givenName': this.givenName,\n      'familyName': this.familyName,\n      'pictureUrl': this.pictureUrl,\n    };\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n */\nclass SubscribeResponse {\n  /**\n   * @param {string} raw\n   * @param {!PurchaseData} purchaseData\n   * @param {?UserDataDef} userData\n   * @param {?EntitlementsDef} entitlements\n   * @param {!string} productType\n   * @param {function():!Promise} completeHandler\n   * @param {?string=} oldSku\n   * @param {?string=} swgUserToken\n   * @param {?number=} paymentRecurrence\n   * @param {?Object=} requestMetadata\n   */\n  constructor(\n    raw,\n    purchaseData,\n    userData,\n    entitlements,\n    productType,\n    completeHandler,\n    oldSku = null,\n    swgUserToken = null,\n    paymentRecurrence = null,\n    requestMetadata = null\n  ) {\n    /** @const {string} */\n    this.raw = raw;\n    /** @const {!PurchaseData} */\n    this.purchaseData = purchaseData;\n    /** @const {?UserDataDef} */\n    this.userData = userData;\n    /** @const {?EntitlementsDef} */\n    this.entitlements = entitlements;\n    /** @const {string} */\n    this.productType = productType;\n    /** @private @const {function():!Promise} */\n    this.completeHandler_ = completeHandler;\n    /** @const {?string} */\n    this.oldSku = oldSku;\n    /** @const {?string} */\n    this.swgUserToken = swgUserToken;\n    /** @const {?number} */\n    this.paymentRecurrence = paymentRecurrence;\n    /** @const {?Object} */\n    this.requestMetadata = requestMetadata;\n  }\n\n  /**\n   * @return {!SubscribeResponse}\n   */\n  clone() {\n    return new SubscribeResponse(\n      this.raw,\n      this.purchaseData,\n      this.userData,\n      this.entitlements,\n      this.productType,\n      this.completeHandler_,\n      this.oldSku,\n      this.swgUserToken\n    );\n  }\n\n  /**\n   * @return {!Object}\n   */\n  json() {\n    return {\n      'purchaseData': this.purchaseData.json(),\n      'userData': this.userData ? this.userData.json() : null,\n      'entitlements': this.entitlements ? this.entitlements.json() : null,\n      'oldSku': this.oldSku,\n      'productType': this.productType,\n      'swgUserToken': this.swgUserToken,\n    };\n  }\n\n  /**\n   * Allows the receiving site to complete/acknowledge that it registered\n   * the subscription purchase. The typical action would be to create an\n   * account (or match an existing one) and associated the purchase with\n   * that account.\n   *\n   * SwG will display progress indicator until this method is called and\n   * upon receiving this call will show the confirmation to the user.\n   * The promise returned by this method will yield once the user closes\n   * the confirmation.\n   *\n   * @return {!Promise}\n   */\n  complete() {\n    return this.completeHandler_();\n  }\n}\n\n/**\n */\nclass PurchaseData {\n  /**\n   * @param {string} raw\n   * @param {string} signature\n   */\n  constructor(raw, signature) {\n    /** @const {string} */\n    this.raw = raw;\n    /** @const {string} */\n    this.data = raw;\n    /** @const {string} */\n    this.signature = signature;\n  }\n\n  /**\n   * @return {!PurchaseData}\n   */\n  clone() {\n    return new PurchaseData(this.raw, this.signature);\n  }\n\n  /**\n   * @return {!Object}\n   */\n  json() {\n    return {\n      'data': this.raw,\n      'signature': this.signature,\n    };\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n */\nclass DeferredAccountCreationResponse {\n  /**\n   * @param {!EntitlementsDef} entitlements\n   * @param {!UserDataDef} userData\n   * @param {!Array<!PurchaseDataDef>} purchaseDataList\n   * @param {function():!Promise} completeHandler\n   */\n  constructor(entitlements, userData, purchaseDataList, completeHandler) {\n    /** @const {!EntitlementsDef} */\n    this.entitlements = entitlements;\n    /** @const {!UserDataDef} */\n    this.userData = userData;\n    /** @const {!Array<!PurchaseDataDef>} */\n    this.purchaseDataList = purchaseDataList;\n    // TODO(dvoytenko): deprecate.\n    /** @const {!PurchaseDataDef} */\n    this.purchaseData = purchaseDataList[0];\n    /** @private @const {function():!Promise} */\n    this.completeHandler_ = completeHandler;\n  }\n\n  /**\n   * @return {!DeferredAccountCreationResponse}\n   */\n  clone() {\n    return new DeferredAccountCreationResponse(\n      this.entitlements,\n      this.userData,\n      this.purchaseDataList,\n      this.completeHandler_\n    );\n  }\n\n  /**\n   * @return {!Object}\n   */\n  json() {\n    return {\n      'entitlements': this.entitlements.json(),\n      'userData': this.userData.json(),\n      'purchaseDataList': this.purchaseDataList.map((pd) => pd.json()),\n      // TODO(dvoytenko): deprecate.\n      'purchaseData': this.purchaseData.json(),\n    };\n  }\n\n  /**\n   * Allows the receiving site to complete/acknowledge that it registered\n   * the subscription info. The typical action would be to create an\n   * account (or match an existing one) and associated the subscription with\n   * that account.\n   *\n   * SwG will display progress indicator until this method is called and\n   * upon receiving this call will show the confirmation to the user.\n   * The promise returned by this method will yield once the user closes\n   * the confirmation.\n   *\n   * @return {!Promise}\n   */\n  complete() {\n    return this.completeHandler_();\n  }\n}\n\n/**\n * Copyright 2019 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @enum {string}\n */\nconst SubscriptionState = {\n  // user's subscription state not known.\n  UNKNOWN: 'unknown',\n  // user is not a subscriber.\n  NON_SUBSCRIBER: 'non_subscriber',\n  // user is a subscriber.\n  SUBSCRIBER: 'subscriber',\n  // user's subscription has expired.\n  PAST_SUBSCRIBER: 'past_subscriber',\n};\n\n/**\n * Subscription related events. Listed below are enum strings that\n * represent events related to Subscription flow. Event parameters\n * that provide more context about the event are sent as a JSON\n * block of depth 1 in the sendEvent() API call.\n * @enum {string}\n */\nconst Event = {\n  /**\n   * IMPRESSION_PAYWALL event.\n   * User hits a paywall.\n   * Every impression should be qualified as active or passive.\n   * The field 'active' of PropensityEvent, which carries this\n   * event, must be set to true or false to indicate this.\n   * If the user has run out of metering, and that\u2019s why was shown\n   * a paywall, that would be a passive impression of the paywall.\n   * For example:\n   * const propensityEvent = {\n   *  name: 'paywall',\n   *  active: false,\n   * }\n   */\n  IMPRESSION_PAYWALL: 'paywall',\n  /**\n   * IMPRESSION_AD event.\n   * User has been shown a subscription ad.\n   * Every impression should be qualified as active or passive.\n   * The field 'active' of PropensityEvent, which carries this\n   * event, must be set to true or false to indicate this.\n   * The JSON block can provide the name of the subscription ad\n   * creative or campaign. Ad impressions are usually passive.\n   * const propensityEvent = {\n   *   name: 'ad_shown',\n   *   active: false,\n   *   data: {'ad_name': 'fall_ad'}\n   * }\n   */\n  IMPRESSION_AD: 'ad_shown',\n  /**\n   * IMPRESSION_OFFERS event.\n   * User has been shown a list of available offers for subscription.\n   * Every impression should be qualified as active or passive.\n   * The field 'active' of PropensityEvent, which carries this\n   * event, must be set to true or false to indicate this.\n   * The JSON block can provide a list of products displayed,\n   * and the source to indicate why the user was shown the offer.\n   * Note: source is not the same as referrer.\n   * In the cases below, the user took action before seeing the offers,\n   * and therefore considered active impression.\n   * For example:\n   * const propensityEvent = {\n   *   name: 'offers_shown',\n   *   active: true,\n   *   data: {'offers': ['basic-monthly', 'premium-weekly'],\n   *           'source': 'ad-click'}\n   * }\n   * For example:\n   * const propensityEvent = {\n   *   name: 'offers_shown',\n   *   active: true,\n   *   data: {'offers': ['basic-monthly', 'premium-weekly'],\n   *           'source': \u2018navigate-to-offers-page\u2019}\n   * }\n   * If the user was shown the offers as a result of paywall metering\n   * expiration, it is considered a passive impression.\n   * For example:\n   * const propensityEvent = {\n   *   name: 'offers_shown',\n   *   active: false,\n   *   data: {'offers': ['basic-monthly', 'premium-weekly'],\n   *           'source': \u2018paywall-metering-expired\u2019}\n   * }\n   */\n  IMPRESSION_OFFERS: 'offers_shown',\n  /**\n   * ACTION_SUBSCRIPTIONS_LANDING_PAGE event.\n   * User has taken the action to arrive at a landing page of the\n   * subscription workflow. The landing page should satisfy one of\n   * the following conditions and hence be a part of the funnel to\n   * get the user to subscribe:\n   * - have a button to navigate the user to an offers page, (in\n   *   this case, the next event will be IMPRESSION_OFFERS, with\n   *   parameter 'source' as subscriptions-landing-page and\n   *   'is_active' set to true),\n   * - show offers the user can select, (in this case, the next\n   *   event will be IMPRESSION_OFFERS, with a parameter 'source'\n   *   as navigate-to-offers-page and 'is_active' set to true),\n   * - provide a way to start the payment flow for a specific offer.\n   *   (in this case, the next event will be ACTION_OFFER_SELECTED\n   *   or ACTION_PAYMENT_FLOW_STARTED depending on if that button\n   *   took the user to a checkout page on the publishers site or\n   *   directly started the payment flow).\n   * The field 'active' of PropensityEvent, which carries this\n   * event, must be set to true since this is a user action.\n   * The JSON block with this event can provide additional information\n   * such as the source, indicating what caused the user to navigate\n   * to this page.\n   * For example:\n   * const propensityEvent = {\n   *   name: 'subscriptions_landing_page',\n   *   active: true,\n   *   data: {'source': 'marketing_via_email'}\n   * }\n   */\n  ACTION_SUBSCRIPTIONS_LANDING_PAGE: 'subscriptions_landing_page',\n  /**\n   * ACTION_OFFER_SELECTED event.\n   * User has selected an offer.\n   * The field 'active' of PropensityEvent, which carries this\n   * event, must be set to true since this is a user action.\n   * The JSON block can provide the product selected.\n   * For example: {\n   *   name: 'offer_selected',\n   *   active: true,\n   *   data: {product': 'basic-monthly'}\n   * }\n   * When offer selection starts the payment flow directly,\n   * use the next event ACTION_PAYMENT_FLOW_STARTED instead.\n   */\n  ACTION_OFFER_SELECTED: 'offer_selected',\n  /**\n   * ACTION_PAYMENT_FLOW_STARTED event.\n   * User has started payment flow.\n   * The field 'active' of PropensityEvent, which carries this\n   * event, must be set to true since this is a user action.\n   * The JSON block can provide the product selected.\n   * For example:\n   * const propensityEvent = {\n   *   name: 'payment_flow_started',\n   *   active: true,\n   *   data: {product': 'basic-monthly'}\n   * }\n   */\n  ACTION_PAYMENT_FLOW_STARTED: 'payment_flow_start',\n  /**\n   * ACTION_PAYMENT_COMPLETED.\n   * User has made the payment for a subscription.\n   * The field 'active' of PropensityEvent, which carries this\n   * event, must be set to true since this is a user action.\n   * The JSON block can provide the product user paid for.\n   * For example:\n   * const propensityEvent = {\n   *   name: 'payment_complete',\n   *   active: true,\n   *   data: {product': 'basic-monthly'}\n   * }\n   */\n  ACTION_PAYMENT_COMPLETED: 'payment_complete',\n  /**\n   * EVENT_CUSTOM: custom publisher event.\n   * The field 'active' of PropensityEvent, which carries this\n   * event, must be set to true or false depending on if the event\n   * was generated as a result of a user action.\n   * The JSON block can provide the event name for the custom event.\n   * For example:\n   * const propensityEvent = {\n   *   name: 'custom',\n   *   active: true,\n   *   data: {\n   *     'event_name': 'social_share',\n   *     'platform_used': 'whatsapp'\n   *   }\n   *  }\n   */\n  EVENT_CUSTOM: 'custom',\n};\n/* eslint-enable no-unused-vars */\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @enum {string}\n */\nconst PropensityType = {\n  // Propensity score for a user to subscribe to a publication.\n  GENERAL: 'general',\n  // Propensity score when blocked access to content by paywall.\n  PAYWALL: 'paywall',\n};\n/* eslint-enable no-unused-vars */\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/* eslint-enable no-unused-vars */\n\n/** @enum {string} */\nconst ShowcaseEvent = {\n  // Events indicating content could potentially be unlocked\n  EVENT_SHOWCASE_METER_OFFERED: 'EVENT_SHOWCASE_METER_OFFERED', // This event is only required if the user can choose not to use a publisher meter\n\n  // Events indicating content was unlocked\n  EVENT_SHOWCASE_UNLOCKED_BY_SUBSCRIPTION:\n    'EVENT_SHOWCASE_UNLOCKED_BY_SUBSCRIPTION', // Publisher managed subscriptions only\n  EVENT_SHOWCASE_UNLOCKED_BY_METER: 'EVENT_SHOWCASE_UNLOCKED_BY_METER', // Publisher managed meters only\n  EVENT_SHOWCASE_UNLOCKED_FREE_PAGE: 'EVENT_SHOWCASE_UNLOCKED_FREE_PAGE', // When the article is free for any reason (lead article, etc)\n\n  // Events indicating the user must take action to view content\n  EVENT_SHOWCASE_NO_ENTITLEMENTS_REGWALL:\n    'EVENT_SHOWCASE_NO_ENTITLEMENTS_REGWALL', // When the user must register (or log in) to view the article\n\n  // Events indicating the user must subscribe to view content\n  EVENT_SHOWCASE_INELIGIBLE_PAYWALL: 'EVENT_SHOWCASE_INELIGIBLE_PAYWALL', // When the user is not eligible for showcase entitlements\n  EVENT_SHOWCASE_NO_ENTITLEMENTS_PAYWALL:\n    'EVENT_SHOWCASE_NO_ENTITLEMENTS_PAYWALL', // When the user has no remaining showcase entitlements\n};\n\n/** @enum {string} */\nconst SubscriptionFlows = {\n  SHOW_OFFERS: 'showOffers',\n  SHOW_SUBSCRIBE_OPTION: 'showSubscribeOption',\n  SHOW_ABBRV_OFFER: 'showAbbrvOffer',\n  SHOW_CONTRIBUTION_OPTIONS: 'showContributionOptions',\n  SUBSCRIBE: 'subscribe',\n  CONTRIBUTE: 'contribute',\n  COMPLETE_DEFERRED_ACCOUNT_CREATION: 'completeDeferredAccountCreation',\n  LINK_ACCOUNT: 'linkAccount',\n  SHOW_LOGIN_PROMPT: 'showLoginPrompt',\n  SHOW_LOGIN_NOTIFICATION: 'showLoginNotification',\n  SHOW_METER_TOAST: 'showMeterToast',\n};\n\n/**\n * @enum {number}\n */\nconst AnalyticsMode = {\n  DEFAULT: 0,\n  IMPRESSIONS: 1,\n};\n\n/**\n * @enum {string}\n */\nconst WindowOpenMode = {\n  AUTO: 'auto',\n  REDIRECT: 'redirect',\n};\n\n/**\n * The Offers/Contributions UI is rendered differently based on the\n * ProductType. The ProductType parameter is passed to the Payments flow, and\n * then passed back to the Payments confirmation page to render messages/text\n * based on the ProductType.\n * @enum {string}\n */\nconst ProductType = {\n  SUBSCRIPTION: 'SUBSCRIPTION',\n  UI_CONTRIBUTION: 'UI_CONTRIBUTION',\n  VIRTUAL_GIFT: 'VIRTUAL_GIFT',\n};\n\n/**\n * @return {!Config}\n */\nfunction defaultConfig() {\n  return {\n    windowOpenMode: WindowOpenMode.AUTO,\n    analyticsMode: AnalyticsMode.DEFAULT,\n    enableSwgAnalytics: false,\n    enablePropensity: false,\n  };\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// NOTE: This regex was copied from SwG's AMP extension. https://github.com/ampproject/amphtml/blob/c23bf281f817a2ee5df73f6fd45e9f4b71bb68b6/extensions/amp-subscriptions-google/0.1/amp-subscriptions-google.js#L56\nconst GOOGLE_DOMAIN_RE = /(^|\\.)google\\.(com?|[a-z]{2}|com?\\.[a-z]{2}|cat)$/;\n\n/**\n * Cached a-tag to avoid memory allocation during URL parsing.\n * @type {HTMLAnchorElement}\n */\nlet a;\n\n/**\n * We cached all parsed URLs. As of now there are no use cases\n * of AMP docs that would ever parse an actual large number of URLs,\n * but we often parse the same one over and over again.\n * @type {Object<string, !LocationDef>}\n */\nlet cache;\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {string} url\n * @return {!LocationDef}\n */\nfunction parseUrl(url) {\n  if (!a) {\n    a = /** @type {!HTMLAnchorElement} */ (self.document.createElement('a'));\n    cache = self.UrlCache || (self.UrlCache = Object.create(null));\n  }\n\n  const fromCache = cache[url];\n  if (fromCache) {\n    return fromCache;\n  }\n\n  const info = parseUrlWithA(a, url);\n\n  return (cache[url] = info);\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * @param {!HTMLAnchorElement} a\n * @param {string} url\n * @return {!LocationDef}\n */\nfunction parseUrlWithA(a, url) {\n  a.href = url;\n\n  // IE11 doesn't provide full URL components when parsing relative URLs.\n  // Assigning to itself again does the trick.\n  if (!a.protocol) {\n    a.href = a.href;\n  }\n\n  /** @type {!LocationDef} */\n  const info = {\n    href: a.href,\n    protocol: a.protocol,\n    host: a.host,\n    hostname: a.hostname,\n    port: a.port == '0' ? '' : a.port,\n    pathname: a.pathname,\n    search: a.search,\n    hash: a.hash,\n    origin: '', // Set below.\n  };\n\n  // Some IE11 specific polyfills.\n  // 1) IE11 strips out the leading '/' in the pathname.\n  if (info.pathname[0] !== '/') {\n    info.pathname = '/' + info.pathname;\n  }\n\n  // 2) For URLs with implicit ports, IE11 parses to default ports while\n  // other browsers leave the port field empty.\n  if (\n    (info.protocol == 'http:' && info.port == 80) ||\n    (info.protocol == 'https:' && info.port == 443)\n  ) {\n    info.port = '';\n    info.host = info.hostname;\n  }\n\n  // For data URI a.origin is equal to the string 'null' which is not useful.\n  // We instead return the actual origin which is the full URL.\n  if (a.origin && a.origin != 'null') {\n    info.origin = a.origin;\n  } else if (info.protocol == 'data:' || !info.host) {\n    info.origin = info.href;\n  } else {\n    info.origin = info.protocol + '//' + info.host;\n  }\n  return info;\n}\n\n/**\n * Parses and builds Object of URL query string.\n * @param {string} query The URL query string.\n * @return {!Object<string, string>}\n */\nfunction parseQueryString(query) {\n  if (!query) {\n    return {};\n  }\n  return (/^[?#]/.test(query) ? query.slice(1) : query)\n    .split('&')\n    .reduce((params, param) => {\n      const item = param.split('=');\n      try {\n        const key = decodeURIComponent(item[0] || '');\n        const value = decodeURIComponent(item[1] || '');\n        if (key) {\n          params[key] = value;\n        }\n      } catch (err) {\n        // eslint-disable-next-line no-console\n        warn(`SwG could not parse a URL query param: ${item[0]}`);\n      }\n      return params;\n    }, {});\n}\n\n/**\n * Adds a parameter to a query string.\n * @param {string} url\n * @param {string} param\n * @param {string} value\n * @return {string}\n */\nfunction addQueryParam(url, param, value) {\n  const queryIndex = url.indexOf('?');\n  const fragmentIndex = url.indexOf('#');\n  let fragment = '';\n  if (fragmentIndex != -1) {\n    fragment = url.substring(fragmentIndex);\n    url = url.substring(0, fragmentIndex);\n  }\n  if (queryIndex == -1) {\n    url += '?';\n  } else if (queryIndex < url.length - 1) {\n    url += '&';\n  }\n  url += encodeURIComponent(param) + '=' + encodeURIComponent(value);\n  return url + fragment;\n}\n\n/**\n * @param {!../proto/api_messages.Message} message\n * @return {string}\n */\nfunction serializeProtoMessageForUrl(message) {\n  return JSON.stringify(message.toArray(false));\n}\n\n/**\n * @param {!../model/doc.Doc} doc\n * @return {string}\n */\nfunction getCanonicalUrl(doc) {\n  const node = doc.getRootNode().querySelector(\"link[rel='canonical']\");\n  return (node && node.href) || '';\n}\n\nconst PARSED_URL = parseUrl(self.window.location.href);\nconst PARSED_REFERRER = parseUrl(self.document.referrer);\n\n/**\n * True for Google domains\n * @param {LocationDef=} parsedUrl Defaults to the current page's URL\n * @return {boolean}\n */\nfunction isGoogleDomain(parsedUrl) {\n  parsedUrl = parsedUrl || PARSED_URL;\n  return GOOGLE_DOMAIN_RE.test(parsedUrl.hostname);\n}\n\n/**\n * True for HTTPS URLs\n * @param {LocationDef=} parsedUrl Defaults to the current page's URL\n * @return {boolean}\n */\nfunction isSecure(parsedUrl) {\n  parsedUrl = parsedUrl || PARSED_URL;\n  return parsedUrl.protocol === 'https' || parsedUrl.protocol === 'https:';\n}\n\n/**\n * True when the page is rendered within a secure Google application or\n * was linked to from a secure Google domain.\n * @param {LocationDef=} parsedReferrer Defaults to the current page's referrer\n * @return {boolean}\n */\nfunction wasReferredByGoogle(parsedReferrer) {\n  parsedReferrer = parsedReferrer || PARSED_REFERRER;\n  return isSecure(parsedReferrer) && isGoogleDomain(parsedReferrer);\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Have to put these in the map to avoid compiler optimization. Due to\n * optimization issues, this map only allows property-style keys. E.g. \"hr1\",\n * as opposed to \"1hr\".\n * @type {!Object<string, number>}\n * @package Visible for testing only.\n */\nconst CACHE_KEYS = {\n  'zero': 0, //testing value\n  'nocache': 1,\n  'hr1': 3600000, // 1hr = 1000 * 60 * 60\n  'hr12': 43200000, // 12hr = 1000 * 60 * 60 * 12\n};\n\n/**\n * Default operating Mode\n */\nconst DEFAULT = {\n  frontEnd: 'https://news.google.com',\n  payEnv: 'PRODUCTION',\n  playEnv: 'PROD',\n  feCache: 'hr1',\n};\n\n/**\n * Default operating Mode\n */\nconst PROD = {\n  frontEnd: 'https://news.google.com',\n  payEnv: 'PRODUCTION',\n  playEnv: 'PROD',\n  feCache: CACHE_KEYS.hr1,\n};\n\n/**\n * Default operating Mode\n */\nconst AUTOPUSH = {\n  frontEnd: 'https://subscribe-autopush.sandbox.google.com',\n  payEnv: 'PRODUCTION',\n  playEnv: 'AUTOPUSH',\n  feCache: CACHE_KEYS.nocache,\n};\n\n/**\n * Default operating Mode\n */\nconst QUAL = {\n  frontEnd: 'https://subscribe-qual.sandbox.google.com',\n  payEnv: 'SANDBOX',\n  playEnv: 'STAGING',\n  feCache: CACHE_KEYS.hr1,\n};\n\n/**\n * Operating modes, only runtime switchgable modes are here\n * build time modes set the default and are configured in prepare.sh\n *\n * IMPORTANT: modes other than prod will only work on google internal networks!\n * @type {!Object<Object>}\n * @package Visible for testing only.\n */\nconst MODES = {\n  'default': DEFAULT,\n  'prod': PROD,\n  'autopush': AUTOPUSH,\n  'qual': QUAL,\n};\n\n/**\n * Check for swg.mode= in url fragemnet if it exists use it\n * otherwise use the default build mode.\n * @returns {Object}\n */\nfunction getSwgMode() {\n  const query = parseQueryString(self.location.hash);\n  const swgMode = query['swg.mode'];\n  if (swgMode && MODES[swgMode]) {\n    return MODES[swgMode];\n  }\n  return MODES['default'];\n}\n\n/**\n * @return {string}\n */\nfunction feOrigin() {\n  return parseUrl(getSwgMode().frontEnd).origin;\n}\n\n/**\n * @param {string} url Relative URL, e.g. \"/service1\".\n * @return {string} The complete URL.\n */\nfunction serviceUrl(url) {\n  return `${getSwgMode().frontEnd}/swg/_/api/v1` + url;\n}\n\n/**\n * @param {string} url  Relative URL, e.g. \"/service1\".\n * @return {string} The complete URL.\n */\nfunction adsUrl(url) {\n  return 'https://pubads.g.doubleclick.net' + url;\n}\n\n/**\n * @param {string} url Relative URL, e.g. \"/offersiframe\".\n * @param {string=} prefix\n * @param {Object<string, string>=} params List of extra params to append to the URL.\n * @return {string} The complete URL.\n */\nfunction feUrl(\n  url,\n  params = {},\n  usePrefixedHostPath = false,\n  prefix = ''\n) {\n  // Add cache param.\n  const prefixed = prefix\n    ? usePrefixedHostPath\n      ? `swg/${prefix}`\n      : `${prefix}/swg`\n    : 'swg';\n  url = feCached(`${getSwgMode().frontEnd}/${prefixed}/_/ui/v1${url}`);\n\n  // Optionally add jsmode param. This allows us to test against \"aggressively\" compiled Boq JS.\n  const query = parseQueryString(self.location.hash);\n  const boqJsMode = query['swg.boqjsmode'];\n  if (boqJsMode !== undefined) {\n    url = addQueryParam(url, 'jsmode', boqJsMode);\n  }\n\n  for (const param in params) {\n    url = addQueryParam(url, param, params[param]);\n  }\n\n  return url;\n}\n\n/**\n * @param {string} url FE URL.\n * @return {string} The complete URL including cache param.\n */\nfunction feCached(url) {\n  return addQueryParam(url, '_', cacheParam(getSwgMode().feCache));\n}\n\n/**\n * @param {!Object<string, ?>} args\n * @return {!Object<string, ?>}\n */\nfunction feArgs(args) {\n  return Object.assign(args, {\n    '_client': 'SwG 0.1.22.190',\n  });\n}\n\n/**\n * @param {string} cacheKey\n * @return {string}\n * @package Visible for testing only.\n */\nfunction cacheParam(cacheKey) {\n  let period = CACHE_KEYS[cacheKey];\n  if (period == null) {\n    period = 1;\n  }\n  if (period === 0) {\n    return '_';\n  }\n  const now = Date.now();\n  return String(period <= 1 ? now : Math.floor(now / period));\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n * The Flow goes like this:\n * a. Start Payments\n * b. Complete Payments\n * c. Create Account\n * d. Acknowledge Account\n *\n * In other words, Flow = Payments + Account Creation.\n */\n\n/**\n * String values input by the publisher are mapped to the number values.\n * @type {!Object<string, number>}\n */\nconst ReplaceSkuProrationModeMapping = {\n  // The replacement takes effect immediately, and the remaining time will\n  // be prorated and credited to the user. This is the current default\n  // behavior.\n  'IMMEDIATE_WITH_TIME_PRORATION': 1,\n};\n\nconst RecurrenceMapping = {\n  'AUTO': 1,\n  'ONE_TIME': 2,\n};\n\n/**\n * @param {string} sku\n * @param {?string=} subscriptionFlow\n * @return {!EventParams}\n */\nfunction getEventParams$1(sku, subscriptionFlow = null) {\n  return new EventParams([, , , , sku, , , subscriptionFlow]);\n}\n\n/**\n * The flow to initiate payment process.\n */\nclass PayStartFlow {\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {!../api/subscriptions.SubscriptionRequest} subscriptionRequest\n   * @param {!../api/subscriptions.ProductType} productType\n   */\n  constructor(\n    deps,\n    subscriptionRequest,\n    productType = ProductType.SUBSCRIPTION\n  ) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!./pay-client.PayClient} */\n    this.payClient_ = deps.payClient();\n\n    /** @private @const {!../model/page-config.PageConfig} */\n    this.pageConfig_ = deps.pageConfig();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    /** @private @const {!../api/subscriptions.SubscriptionRequest} */\n    this.subscriptionRequest_ = subscriptionRequest;\n\n    /**@private @const {!ProductType} */\n    this.productType_ = productType;\n\n    /** @private @const {!../runtime/analytics-service.AnalyticsService} */\n    this.analyticsService_ = deps.analytics();\n\n    /** @private @const {!../runtime/client-event-manager.ClientEventManager} */\n    this.eventManager_ = deps.eventManager();\n\n    /** @private @const {!../runtime/client-config-manager.ClientConfigManager} */\n    this.clientConfigManager_ = deps.clientConfigManager();\n  }\n\n  /**\n   * Starts the payments flow.\n   * @return {!Promise}\n   */\n  start() {\n    // Get the paySwgVersion for buyflow.\n    const promise = this.clientConfigManager_.getClientConfig();\n    return promise.then((clientConfig) => {\n      this.start_(clientConfig.paySwgVersion);\n    });\n  }\n\n  /**\n   * Starts the payments flow for the given version.\n   * @param {!string=} paySwgVersion\n   * @return {!Promise}\n   */\n  start_(paySwgVersion) {\n    const /** @type {SwgPaymentRequest} */ swgPaymentRequest = {\n        'skuId': this.subscriptionRequest_['skuId'],\n        'publicationId': this.pageConfig_.getPublicationId(),\n      };\n\n    if (paySwgVersion) {\n      swgPaymentRequest['swgVersion'] = paySwgVersion;\n    }\n\n    if (this.subscriptionRequest_['oldSku']) {\n      swgPaymentRequest['oldSku'] = this.subscriptionRequest_['oldSku'];\n      // Map the proration mode to the enum value (if proration exists).\n      const prorationMode =\n        this.subscriptionRequest_['replaceSkuProrationMode'];\n      if (prorationMode) {\n        swgPaymentRequest['replaceSkuProrationMode'] =\n          ReplaceSkuProrationModeMapping[prorationMode];\n      } else {\n        swgPaymentRequest['replaceSkuProrationMode'] =\n          ReplaceSkuProrationModeMapping['IMMEDIATE_WITH_TIME_PRORATION'];\n      }\n      this.analyticsService_.setSku(swgPaymentRequest['oldSku']);\n    }\n\n    // Assign one-time recurrence enum if applicable\n    if (this.subscriptionRequest_['oneTime']) {\n      swgPaymentRequest['paymentRecurrence'] = RecurrenceMapping['ONE_TIME'];\n    }\n\n    // Assign additional metadata if available.\n    if (this.subscriptionRequest_['metadata']) {\n      swgPaymentRequest['metadata'] = this.subscriptionRequest_['metadata'];\n    }\n\n    // Start/cancel events.\n    const flow =\n      this.productType_ == ProductType.UI_CONTRIBUTION\n        ? SubscriptionFlows.CONTRIBUTE\n        : SubscriptionFlows.SUBSCRIBE;\n\n    this.deps_.callbacks().triggerFlowStarted(flow, this.subscriptionRequest_);\n\n    this.eventManager_.logSwgEvent(\n      AnalyticsEvent.ACTION_PAYMENT_FLOW_STARTED,\n      true,\n      getEventParams$1(swgPaymentRequest['skuId'])\n    );\n    PayCompleteFlow.waitingForPayClient_ = true;\n    this.payClient_.start(\n      /** @type {!PaymentDataRequest} */\n      ({\n        'apiVersion': 1,\n        'allowedPaymentMethods': ['CARD'],\n        'environment': getSwgMode().payEnv,\n        'playEnvironment': getSwgMode().playEnv,\n        'swg': swgPaymentRequest,\n        'i': {\n          'startTimeMs': Date.now(),\n          'productType': this.productType_,\n        },\n      }),\n      {\n        forceRedirect:\n          this.deps_.config().windowOpenMode == WindowOpenMode.REDIRECT,\n        // basic flow does not support native.\n        forceDisableNative: paySwgVersion == '2',\n      }\n    );\n    return Promise.resolve();\n  }\n}\n\n/**\n * The flow for successful payments completion.\n */\nclass PayCompleteFlow {\n  /**\n   * @param {!./deps.DepsDef} deps\n   */\n  static configurePending(deps) {\n    /** @const @type {./client-event-manager.ClientEventManager} */\n    const eventManager = deps.eventManager();\n\n    deps.payClient().onResponse((payPromise) => {\n      deps.entitlementsManager().blockNextNotification();\n      const flow = new PayCompleteFlow(deps);\n      const promise = validatePayResponse(\n        deps,\n        payPromise,\n        flow.complete.bind(flow)\n      );\n      deps.callbacks().triggerPaymentResponse(promise);\n      return promise.then(\n        (response) => {\n          const sku = parseSkuFromPurchaseDataSafe(response.purchaseData);\n          deps.analytics().setSku(sku || '');\n          eventManager.logSwgEvent(\n            AnalyticsEvent.ACTION_PAYMENT_COMPLETE,\n            true,\n            getEventParams$1(\n              sku || '',\n              response.productType == ProductType.UI_CONTRIBUTION\n                ? SubscriptionFlows.CONTRIBUTE\n                : SubscriptionFlows.SUBSCRIBE\n            )\n          );\n          flow.start(response);\n        },\n        (reason) => {\n          if (isCancelError(reason)) {\n            const productType = /** @type {!Object} */ (reason)['productType'];\n            const flow =\n              productType == ProductType.UI_CONTRIBUTION\n                ? SubscriptionFlows.CONTRIBUTE\n                : SubscriptionFlows.SUBSCRIBE;\n            deps.callbacks().triggerFlowCanceled(flow);\n            deps\n              .eventManager()\n              .logSwgEvent(AnalyticsEvent.ACTION_USER_CANCELED_PAYFLOW, true);\n          } else {\n            deps\n              .eventManager()\n              .logSwgEvent(AnalyticsEvent.EVENT_PAYMENT_FAILED, false);\n            deps.jserror().error('Pay failed', reason);\n            throw reason;\n          }\n        }\n      );\n    });\n  }\n\n  /**\n   * @param {!./deps.DepsDef} deps\n   */\n  constructor(deps) {\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    /** @private {?Promise<!ActivityIframeView>} */\n    this.activityIframeViewPromise_ = null;\n\n    /** @private {?Promise} */\n    this.readyPromise_ = null;\n\n    /** @private @const {!../runtime/analytics-service.AnalyticsService} */\n    this.analyticsService_ = deps.analytics();\n\n    /** @private @const {!../runtime/client-event-manager.ClientEventManager} */\n    this.eventManager_ = deps.eventManager();\n\n    /** @private @const {!../runtime/client-config-manager.ClientConfigManager} */\n    this.clientConfigManager_ = deps.clientConfigManager();\n\n    /** @private {?string} */\n    this.sku_ = null;\n  }\n\n  /**\n   * Starts the payments completion flow.\n   * @param {{\n   *   productType: string,\n   *   oldSku: ?string,\n   *   paymentRecurrence: ?number,\n   * }} response\n   * @return {!Promise}\n   */\n  start(response) {\n    this.sku_ = parseSkuFromPurchaseDataSafe(response.purchaseData);\n    this.eventManager_.logSwgEvent(\n      AnalyticsEvent.IMPRESSION_ACCOUNT_CHANGED,\n      true,\n      getEventParams$1(this.sku_ || '')\n    );\n    this.deps_.entitlementsManager().reset(true);\n    // TODO(dianajing): future-proof isOneTime flag\n    const args = {\n      'publicationId': this.deps_.pageConfig().getPublicationId(),\n      'productType': response['productType'],\n      'isSubscriptionUpdate': !!response['oldSku'],\n      'isOneTime': !!response['paymentRecurrence'],\n    };\n\n    // TODO(dvoytenko, #400): cleanup once entitlements is launched everywhere.\n    if (response.userData && response.entitlements) {\n      args['idToken'] = response.userData.idToken;\n      this.deps_\n        .entitlementsManager()\n        .pushNextEntitlements(response.entitlements.raw);\n      // Persist swgUserToken in local storage\n      if (response.swgUserToken) {\n        this.deps_\n          .storage()\n          .set(Constants$1.USER_TOKEN, response.swgUserToken, true);\n      }\n    } else {\n      args['loginHint'] = response.userData && response.userData.email;\n    }\n\n    const /* {!Object<string, string>} */ urlParams = {};\n    if (args.productType === ProductType.VIRTUAL_GIFT) {\n      Object.assign(urlParams, {\n        productType: args.productType,\n        publicationId: args.publicationId,\n        offerId: this.sku_,\n        origin: parseUrl(this.win_.location.href).origin,\n      });\n      if (response.requestMetadata) {\n        urlParams.canonicalUrl = response.requestMetadata.contentId;\n        urlParams.isAnonymous = response.requestMetadata.anonymous;\n      }\n\n      // Add feArgs to be passed via activities.\n      if (response.swgUserToken) {\n        args.swgUserToken = response.swgUserToken;\n      }\n      const orderId = parseOrderIdFromPurchaseDataSafe(response.purchaseData);\n      if (orderId) {\n        args.orderId = orderId;\n      }\n    }\n    if (this.clientConfigManager_.shouldForceLangInIframes()) {\n      urlParams.hl = this.clientConfigManager_.getLanguage();\n    }\n    const confirmFeUrl = feUrl('/payconfirmiframe', urlParams);\n\n    return (this.activityIframeViewPromise_ = this.clientConfigManager_\n      .getClientConfig()\n      .then((clientConfig) => {\n        args['useUpdatedConfirmUi'] = clientConfig.useUpdatedOfferFlows;\n        return new ActivityIframeView(\n          this.win_,\n          this.activityPorts_,\n          confirmFeUrl,\n          feArgs(args),\n          /* shouldFadeBody */ true\n        );\n      })\n      .then((activityIframeView) => {\n        activityIframeView.on(\n          EntitlementsResponse,\n          this.handleEntitlementsResponse_.bind(this)\n        );\n\n        activityIframeView.acceptResult().then(() => {\n          // The flow is complete.\n          this.dialogManager_.completeView(activityIframeView);\n        });\n\n        this.readyPromise_ = this.dialogManager_.openView(activityIframeView);\n        return activityIframeView;\n      }));\n  }\n\n  /**\n   * @param {!EntitlementsResponse} response\n   * @private\n   */\n  handleEntitlementsResponse_(response) {\n    const jwt = response.getJwt();\n    if (jwt) {\n      this.deps_.entitlementsManager().pushNextEntitlements(jwt);\n    }\n  }\n\n  /**\n   * @return {!Promise}\n   */\n  complete() {\n    this.eventManager_.logSwgEvent(\n      AnalyticsEvent.ACTION_ACCOUNT_CREATED,\n      true,\n      getEventParams$1(this.sku_ || '')\n    );\n    this.deps_.entitlementsManager().unblockNextNotification();\n    return Promise.all([\n      this.activityIframeViewPromise_,\n      this.readyPromise_,\n    ]).then((values) => {\n      const activityIframeView = values[0];\n      const accountCompletionRequest = new AccountCreationRequest();\n      accountCompletionRequest.setComplete(true);\n      activityIframeView.execute(accountCompletionRequest);\n      return activityIframeView\n        .acceptResult()\n        .catch(() => {\n          // Ignore errors.\n        })\n        .then(() => {\n          this.eventManager_.logSwgEvent(\n            AnalyticsEvent.ACTION_ACCOUNT_ACKNOWLEDGED,\n            true,\n            getEventParams$1(this.sku_ || '')\n          );\n          this.deps_.entitlementsManager().setToastShown(true);\n        });\n    });\n  }\n}\n\n/** @private {boolean} */\nPayCompleteFlow.waitingForPayClient_ = false;\n\n/**\n * @param {!./deps.DepsDef} deps\n * @param {!Promise<!Object>} payPromise\n * @param {function():!Promise} completeHandler\n * @return {!Promise<!SubscribeResponse>}\n */\nfunction validatePayResponse(deps, payPromise, completeHandler) {\n  const wasRedirect = !PayCompleteFlow.waitingForPayClient_;\n  PayCompleteFlow.waitingForPayClient_ = false;\n  return payPromise.then((data) => {\n    // 1) We log against a random TX ID which is how we track a specific user\n    //    anonymously.\n    // 2) If there was a redirect to gPay, we may have lost our stored TX ID.\n    // 3) Pay service is supposed to give us the TX ID it logged against.\n    let eventType = AnalyticsEvent.UNKNOWN;\n    let eventParams = undefined;\n    if (typeof data !== 'object' || !data['googleTransactionId']) {\n      // If gPay doesn't give us a TX ID it means that something may\n      // be wrong.  If we previously logged then we are at least continuing to\n      // log against the same TX ID.  If we didn't previously log then we have\n      // lost all connection to the events that preceded the payment event and\n      // we at least want to know why that data was lost.\n      eventParams = new EventParams();\n      eventParams.setHadLogged(!wasRedirect);\n      eventType = AnalyticsEvent.EVENT_GPAY_NO_TX_ID;\n    } else {\n      const oldTxId = deps.analytics().getTransactionId();\n      const newTxId = data['googleTransactionId'];\n\n      if (wasRedirect) {\n        // This is the expected case for full redirects.  It may be happening\n        // unexpectedly at other times too though and we want to be aware of\n        // it if it does.\n        deps.analytics().setTransactionId(newTxId);\n        eventType = AnalyticsEvent.EVENT_GPAY_CANNOT_CONFIRM_TX_ID;\n      } else {\n        if (oldTxId === newTxId) {\n          // This is the expected case for non-redirect pay events\n          eventType = AnalyticsEvent.EVENT_CONFIRM_TX_ID;\n        } else {\n          // This is an unexpected case: gPay rejected our TX ID and created\n          // its own.  Log the gPay TX ID but keep our logging consistent.\n          eventParams = new EventParams();\n          eventParams.setGpayTransactionId(newTxId);\n          eventType = AnalyticsEvent.EVENT_CHANGED_TX_ID;\n        }\n      }\n    }\n    deps.eventManager().logSwgEvent(eventType, true, eventParams);\n    return parseSubscriptionResponse(deps, data, completeHandler);\n  });\n}\n\n/**\n * @param {!./deps.DepsDef} deps\n * @param {*} data\n * @param {function():!Promise} completeHandler\n * @return {!SubscribeResponse}\n */\nfunction parseSubscriptionResponse(deps, data, completeHandler) {\n  let swgData = null;\n  let raw = null;\n  let productType = ProductType.SUBSCRIPTION;\n  let oldSku = null;\n  let paymentRecurrence = null;\n  let requestMetadata = null;\n\n  if (data) {\n    if (typeof data == 'string') {\n      raw = /** @type {string} */ (data);\n    } else {\n      // Assume it's a json object in the format:\n      // `{integratorClientCallbackData: \"...\"}` or `{swgCallbackData: \"...\"}`.\n      const json = /** @type {!Object} */ (data);\n      if ('swgCallbackData' in json) {\n        swgData = /** @type {!Object} */ (json['swgCallbackData']);\n      } else if ('integratorClientCallbackData' in json) {\n        raw = json['integratorClientCallbackData'];\n      }\n      if ('paymentRequest' in data) {\n        const swgObj = data['paymentRequest']['swg'] || {};\n        oldSku = swgObj['oldSku'];\n        paymentRecurrence = swgObj['paymentRecurrence'];\n        requestMetadata = swgObj['metadata'];\n        productType =\n          (data['paymentRequest']['i'] || {})['productType'] ||\n          ProductType.SUBSCRIPTION;\n      }\n    }\n  }\n  if (raw && !swgData) {\n    raw = atob(raw);\n    if (raw) {\n      const parsed = parseJson(raw);\n      swgData = parsed['swgCallbackData'];\n    }\n  }\n  if (!swgData) {\n    throw new Error('unexpected payment response');\n  }\n  raw = JSON.stringify(/** @type {!JsonObject} */ (swgData));\n  return new SubscribeResponse(\n    raw,\n    parsePurchaseData(swgData),\n    parseUserData(swgData),\n    parseEntitlements(deps, swgData),\n    productType,\n    completeHandler,\n    oldSku,\n    swgData['swgUserToken'],\n    paymentRecurrence,\n    requestMetadata\n  );\n}\n\n/**\n * @param {!Object} swgData\n * @return {!PurchaseData}\n */\nfunction parsePurchaseData(swgData) {\n  const raw = swgData['purchaseData'];\n  const signature = swgData['purchaseDataSignature'];\n  return new PurchaseData(raw, signature);\n}\n\n/**\n * @param {!Object} swgData\n * @return {?UserData}\n * @package Visible for testing.\n */\nfunction parseUserData(swgData) {\n  const idToken = swgData['idToken'];\n  if (!idToken) {\n    return null;\n  }\n  const jwt = /** @type {!Object} */ (new JwtHelper().decode(idToken));\n  return new UserData(idToken, jwt);\n}\n\n/**\n * @param {!./deps.DepsDef} deps\n * @param {!Object} swgData\n * @return {?../api/entitlements.Entitlements}\n * @package Visible for testing.\n */\nfunction parseEntitlements(deps, swgData) {\n  if (swgData['signedEntitlements']) {\n    return deps.entitlementsManager().parseEntitlements(swgData);\n  }\n  return null;\n}\n\n/**\n * @param {!PurchaseData} purchaseData\n * @return {?string}\n */\nfunction parseSkuFromPurchaseDataSafe(purchaseData) {\n  return /** @type {?string} */ (\n    getPropertyFromJsonString(purchaseData.raw, 'productId') || null\n  );\n}\n\n/**\n * @param {!PurchaseData} purchaseData\n * @return {?string}\n */\nfunction parseOrderIdFromPurchaseDataSafe(purchaseData) {\n  return /** @type {?string} */ (\n    getPropertyFromJsonString(purchaseData.raw, 'orderId') || null\n  );\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {string} sku\n * @return {!EventParams}\n */\nfunction getEventParams(sku) {\n  return new EventParams([, , , , sku]);\n}\n\n/**\n * Offers view is closable when request was originated from 'AbbrvOfferFlow'\n * or from 'SubscribeOptionFlow'.\n */\nconst OFFERS_VIEW_CLOSABLE = true;\n\n// The value logged when the offers screen shows all available SKUs.\nconst ALL_SKUS = '*';\n\n/**\n * The class for Offers flow.\n */\nclass OffersFlow {\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {!../api/subscriptions.OffersRequest|undefined} options\n   */\n  constructor(deps, options) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    /** @private @const {!../runtime/client-event-manager.ClientEventManager} */\n    this.eventManager_ = deps.eventManager();\n\n    /** @private @const {!./client-config-manager.ClientConfigManager} */\n    this.clientConfigManager_ = deps.clientConfigManager();\n\n    this.activityIframeView_ = null;\n\n    // Default to hiding close button.\n    const isClosable = options?.isClosable ?? false;\n\n    const feArgsObj = deps.activities().addDefaultArguments({\n      'showNative': deps.callbacks().hasSubscribeRequestCallback(),\n      'productType': ProductType.SUBSCRIPTION,\n      'list': (options && options.list) || 'default',\n      'skus': (options && options.skus) || null,\n      'isClosable': isClosable,\n    });\n\n    if (options && options.oldSku) {\n      feArgsObj['oldSku'] = options.oldSku;\n      assert(feArgsObj['skus'], 'Need a sku list if old sku is provided!');\n\n      // Remove old sku from offers if in list.\n      let skuList = feArgsObj['skus'];\n      const /** @type {string} */ oldSku = feArgsObj['oldSku'];\n      skuList = skuList.filter((sku) => sku !== oldSku);\n\n      assert(\n        skuList.length > 0,\n        'Sku list only contained offer user already has'\n      );\n      feArgsObj['skus'] = skuList;\n    }\n\n    // Redirect to payments if only one upgrade option is passed.\n    if (feArgsObj['skus'] && feArgsObj['skus'].length === 1) {\n      const sku = feArgsObj['skus'][0];\n      const /** @type {string|undefined} */ oldSku = feArgsObj['oldSku'];\n      // Update subscription triggers experimental flag if oldSku is passed,\n      // so we need to check for oldSku to decide if it needs to be sent.\n      // Otherwise we might accidentally block a regular subscription request.\n      if (oldSku) {\n        const skuSelectedResponse = new SkuSelectedResponse();\n        skuSelectedResponse.setSku(sku);\n        skuSelectedResponse.setOldSku(oldSku);\n        this.startPayFlow_(skuSelectedResponse);\n        return;\n      }\n    }\n\n    /** @private  @const {!Array<!string>} */\n    this.skus_ = feArgsObj['skus'] || [ALL_SKUS];\n\n    /** @private @const {!Promise<!../model/client-config.ClientConfig>} */\n    this.clientConfig_ = this.clientConfigManager_.getClientConfig();\n\n    /** @private @const {!Promise<?ActivityIframeView>} */\n    this.activityIframeViewPromise_ = this.clientConfig_.then(\n      (clientConfig) => {\n        return this.shouldShow_(clientConfig)\n          ? new ActivityIframeView(\n              this.win_,\n              this.activityPorts_,\n              this.getUrl_(clientConfig),\n              feArgsObj,\n              /* shouldFadeBody */ true\n            )\n          : null;\n      }\n    );\n  }\n\n  /**\n   * @param {SkuSelectedResponse} response\n   * @private\n   */\n  startPayFlow_(response) {\n    const sku = response.getSku();\n    if (sku) {\n      const /** @type {../api/subscriptions.SubscriptionRequest} */ subscriptionRequest =\n          {\n            'skuId': sku,\n          };\n      const oldSku = response.getOldSku();\n      if (oldSku) {\n        subscriptionRequest['oldSku'] = oldSku;\n        this.deps_.analytics().setSku(oldSku);\n      }\n      this.eventManager_.logSwgEvent(\n        AnalyticsEvent.ACTION_OFFER_SELECTED,\n        true,\n        getEventParams(sku)\n      );\n      new PayStartFlow(this.deps_, subscriptionRequest).start();\n    }\n  }\n\n  /**\n   * @param {AlreadySubscribedResponse} response\n   * @private\n   */\n  handleLinkRequest_(response) {\n    if (response.getSubscriberOrMember()) {\n      this.eventManager_.logSwgEvent(\n        AnalyticsEvent.ACTION_ALREADY_SUBSCRIBED,\n        true\n      );\n      this.deps_.callbacks().triggerLoginRequest({\n        linkRequested: !!response.getLinkRequested(),\n      });\n    }\n  }\n\n  /**\n   * @param {ViewSubscriptionsResponse} response\n   * @private\n   */\n  startNativeFlow_(response) {\n    if (response.getNative()) {\n      this.deps_.callbacks().triggerSubscribeRequest();\n    }\n  }\n\n  /**\n   * Starts the offers flow or alreadySubscribed flow.\n   * @return {!Promise}\n   */\n  start() {\n    if (this.activityIframeViewPromise_) {\n      return this.activityIframeViewPromise_.then((activityIframeView) => {\n        if (!activityIframeView) {\n          return Promise.resolve();\n        }\n\n        // So no error if skipped to payment screen.\n        // Start/cancel events.\n        // The second parameter is required by Propensity in AMP.\n        this.deps_\n          .callbacks()\n          .triggerFlowStarted(SubscriptionFlows.SHOW_OFFERS, {\n            skus: this.skus_,\n            source: 'SwG',\n          });\n        activityIframeView.onCancel(() => {\n          this.deps_\n            .callbacks()\n            .triggerFlowCanceled(SubscriptionFlows.SHOW_OFFERS);\n        });\n        activityIframeView.on(\n          SkuSelectedResponse,\n          this.startPayFlow_.bind(this)\n        );\n        activityIframeView.on(\n          AlreadySubscribedResponse,\n          this.handleLinkRequest_.bind(this)\n        );\n        activityIframeView.on(\n          ViewSubscriptionsResponse,\n          this.startNativeFlow_.bind(this)\n        );\n        this.activityIframeView_ = activityIframeView;\n        return this.clientConfig_.then((clientConfig) => {\n          if (!this.activityIframeView_) {\n            return;\n          }\n          return this.dialogManager_.openView(\n            this.activityIframeView_,\n            /* hidden */ false,\n            this.getDialogConfig_(clientConfig)\n          );\n        });\n      });\n    }\n    return Promise.resolve();\n  }\n\n  /**\n   * Returns whether this flow is configured as enabled, not showing\n   * even on explicit start when flag is configured false.\n   *\n   * @param {!../model/client-config.ClientConfig} clientConfig\n   * @return {boolean}\n   */\n  shouldShow_(clientConfig) {\n    return clientConfig.uiPredicates?.canDisplayAutoPrompt !== false;\n  }\n\n  /**\n   * Gets display configuration options for the opened dialog. Uses the\n   * responsive desktop design properties if the updated offer flows UI (for\n   * SwG Basic) is enabled.\n   * @param {!../model/client-config.ClientConfig} clientConfig\n   * @return {!../components/dialog.DialogConfig}\n   */\n  getDialogConfig_(clientConfig) {\n    return clientConfig.useUpdatedOfferFlows\n      ? {desktopConfig: {isCenterPositioned: true, supportsWideScreen: true}}\n      : {};\n  }\n\n  /**\n   * Returns the full URL that should be used for the activity iFrame view.\n   * @param {!../model/client-config.ClientConfig} clientConfig\n   * @return {string}\n   */\n  getUrl_(clientConfig) {\n    if (!clientConfig.useUpdatedOfferFlows) {\n      return feUrl('/offersiframe');\n    }\n\n    if (this.clientConfigManager_.shouldForceLangInIframes()) {\n      return feUrl('/subscriptionoffersiframe', {\n        'hl': this.clientConfigManager_.getLanguage(),\n      });\n    }\n\n    return feUrl('/subscriptionoffersiframe');\n  }\n\n  /**\n   * Shows \"no subscription found\" on activity iFrame view.\n   */\n  showNoEntitlementFoundToast() {\n    if (this.activityIframeView_) {\n      this.activityIframeView_.execute(new EntitlementsResponse());\n    }\n  }\n}\n\n/**\n * The class for subscribe option flow.\n */\nclass SubscribeOptionFlow {\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {!../api/subscriptions.OffersRequest|undefined} options\n   */\n  constructor(deps, options) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!../api/subscriptions.OffersRequest|undefined} */\n    this.options_ = options;\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    /** @private @const {!../runtime/client-event-manager.ClientEventManager} */\n    this.eventManager_ = deps.eventManager();\n\n    /** @private @const {!ActivityIframeView} */\n    this.activityIframeView_ = new ActivityIframeView(\n      deps.win(),\n      this.activityPorts_,\n      feUrl('/optionsiframe'),\n      feArgs({\n        'publicationId': deps.pageConfig().getPublicationId(),\n        'productId': deps.pageConfig().getProductId(),\n        'list': (options && options.list) || 'default',\n        'skus': (options && options.skus) || null,\n        'isClosable': true,\n      }),\n      /* shouldFadeBody */ false\n    );\n  }\n\n  /**\n   * Starts the offers flow or alreadySubscribed flow.\n   * @return {!Promise}\n   */\n  start() {\n    // Start/cancel events.\n    this.deps_\n      .callbacks()\n      .triggerFlowStarted(SubscriptionFlows.SHOW_SUBSCRIBE_OPTION);\n    this.activityIframeView_.onCancel(() => {\n      this.deps_\n        .callbacks()\n        .triggerFlowCanceled(SubscriptionFlows.SHOW_SUBSCRIBE_OPTION);\n    });\n    this.activityIframeView_.on(\n      SubscribeResponse$1,\n      this.maybeOpenOffersFlow_.bind(this)\n    );\n\n    this.activityIframeView_.acceptResult().then(\n      (result) => {\n        const data = result.data;\n        const response = new SubscribeResponse$1();\n        if (data['subscribe']) {\n          response.setSubscribe(true);\n        }\n        this.maybeOpenOffersFlow_(response);\n      },\n      (reason) => {\n        this.dialogManager_.completeView(this.activityIframeView_);\n        throw reason;\n      }\n    );\n    this.eventManager_.logSwgEvent(\n      AnalyticsEvent.IMPRESSION_CLICK_TO_SHOW_OFFERS\n    );\n    return this.dialogManager_.openView(this.activityIframeView_);\n  }\n\n  /**\n   * @param {SubscribeResponse} response\n   * @private\n   */\n  maybeOpenOffersFlow_(response) {\n    if (response.getSubscribe()) {\n      const options = this.options_ || {};\n      if (options.isClosable == undefined) {\n        options.isClosable = OFFERS_VIEW_CLOSABLE;\n      }\n      this.eventManager_.logSwgEvent(AnalyticsEvent.ACTION_VIEW_OFFERS, true);\n      new OffersFlow(this.deps_, options).start();\n    }\n  }\n}\n\n/**\n * The class for Abbreviated Offer flow.\n *\n */\nclass AbbrvOfferFlow {\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {!../api/subscriptions.OffersRequest=} options\n   */\n  constructor(deps, options = {}) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!../api/subscriptions.OffersRequest|undefined} */\n    this.options_ = options;\n\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    /** @private @const {!../runtime/client-event-manager.ClientEventManager} */\n    this.eventManager_ = deps.eventManager();\n\n    /** @private @const {!ActivityIframeView} */\n    this.activityIframeView_ = new ActivityIframeView(\n      this.win_,\n      this.activityPorts_,\n      feUrl('/abbrvofferiframe'),\n      feArgs({\n        'publicationId': deps.pageConfig().getPublicationId(),\n        'productId': deps.pageConfig().getProductId(),\n        'showNative': deps.callbacks().hasSubscribeRequestCallback(),\n        'list': (options && options.list) || 'default',\n        'skus': (options && options.skus) || null,\n        'isClosable': true,\n      }),\n      /* shouldFadeBody */ false\n    );\n  }\n\n  /**\n   * @param {AlreadySubscribedResponse} response\n   * @private\n   */\n  handleLinkRequest_(response) {\n    if (response.getSubscriberOrMember()) {\n      this.eventManager_.logSwgEvent(\n        AnalyticsEvent.ACTION_ALREADY_SUBSCRIBED,\n        true\n      );\n      this.deps_.callbacks().triggerLoginRequest({\n        linkRequested: !!response.getLinkRequested(),\n      });\n    }\n  }\n\n  /**\n   * Starts the offers flow\n   * @return {!Promise}\n   */\n  start() {\n    // Start/cancel events.\n    this.deps_\n      .callbacks()\n      .triggerFlowStarted(SubscriptionFlows.SHOW_ABBRV_OFFER);\n    this.activityIframeView_.onCancel(() => {\n      this.deps_\n        .callbacks()\n        .triggerFlowCanceled(SubscriptionFlows.SHOW_ABBRV_OFFER);\n    });\n\n    // If the user is already subscribed, trigger login flow\n    this.activityIframeView_.on(\n      AlreadySubscribedResponse,\n      this.handleLinkRequest_.bind(this)\n    );\n\n    // If result is due to requesting offers, redirect to offers flow\n    this.activityIframeView_.acceptResult().then((result) => {\n      if (result.data['viewOffers']) {\n        const options = this.options_ || {};\n        if (options.isClosable == undefined) {\n          options.isClosable = OFFERS_VIEW_CLOSABLE;\n        }\n        this.eventManager_.logSwgEvent(AnalyticsEvent.ACTION_VIEW_OFFERS, true);\n        new OffersFlow(this.deps_, options).start();\n        return;\n      }\n      if (result.data['native']) {\n        this.deps_.callbacks().triggerSubscribeRequest();\n        // The flow is complete.\n        this.dialogManager_.completeView(this.activityIframeView_);\n        return;\n      }\n    });\n\n    this.eventManager_.logSwgEvent(\n      AnalyticsEvent.IMPRESSION_CLICK_TO_SHOW_OFFERS_OR_ALREADY_SUBSCRIBED\n    );\n\n    return this.dialogManager_.openView(this.activityIframeView_);\n  }\n}\n\n/**\n * Copyright 2019 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst {\n  ActivityIframePort: WebActivityIframePort,\n  ActivityPorts: WebActivityPorts,\n} = require('web-activities/activity-ports');\n/**\n * @implements {ActivityPortDef}\n */\nclass ActivityPortDeprecated {\n  /**\n   * @param {!web-activities/activity-ports.ActivityPort} port\n   */\n  constructor(port) {\n    /** @private @const {!web-activities/activity-ports.ActivityPort} */\n    this.port_ = port;\n  }\n\n  /**\n   * @return {!Promise<!web-activities/activity-ports.ActivityResult>}\n   */\n  acceptResult() {\n    return this.port_.acceptResult();\n  }\n}\n\n/**\n * @implements {ActivityPortDef}\n */\nclass ActivityIframePort$1 {\n  /**\n   * @param {!HTMLIFrameElement} iframe\n   * @param {string} url\n   * @param {!../runtime/deps.DepsDef} deps\n   * @param {?Object=} args\n   */\n  constructor(iframe, url, deps, args) {\n    /** @private @const {!web-activities/activity-ports.ActivityIframePort} */\n    this.iframePort_ = new WebActivityIframePort(iframe, url, args);\n    /** @private @const {!Object<string, function(!../proto/api_messages.Message)>} */\n    this.callbackMap_ = {};\n\n    /** @private @const {../runtime/deps.DepsDef} */\n    this.deps_ = deps;\n  }\n\n  /**\n   * Returns a promise that yields when the iframe is ready to be interacted\n   * with.\n   * @return {!Promise}\n   */\n  whenReady() {\n    return this.iframePort_.whenReady();\n  }\n\n  /**\n   * Waits until the activity port is connected to the host.\n   * @return {!Promise}\n   */\n  connect() {\n    return this.iframePort_.connect().then(() => {\n      // Attach a callback to receive messages after connection complete\n      this.iframePort_.onMessage((data) => {\n        const response = data && data['RESPONSE'];\n        if (!response) {\n          return;\n        }\n        const cb = this.callbackMap_[response[0]];\n        if (cb) {\n          cb(deserialize(response));\n        }\n      });\n\n      if (this.deps_ && this.deps_.eventManager()) {\n        this.on(AnalyticsRequest, (request) => {\n          const analyticsRequest = /** @type {AnalyticsRequest} */ (request);\n          this.deps_.eventManager().logEvent({\n            eventType: analyticsRequest.getEvent(),\n            eventOriginator: EventOriginator.SWG_SERVER,\n            isFromUserAction: analyticsRequest.getMeta().getIsFromUserAction(),\n            additionalParameters: analyticsRequest.getParams(),\n          });\n        });\n      }\n    });\n  }\n\n  /**\n   * Disconnect the activity binding and cleanup listeners.\n   */\n  disconnect() {\n    this.iframePort_.disconnect();\n  }\n\n  /**\n   * Returns the mode of the activity: iframe, popup or redirect.\n   * @return {!web-activities/activity-ports.ActivityMode}\n   */\n  getMode() {\n    return this.iframePort_.getMode();\n  }\n\n  /**\n   * Accepts the result when ready. The client should verify the activity's\n   * mode, origin, verification and secure channel flags before deciding\n   * whether or not to trust the result.\n   *\n   * Returns the promise that yields when the activity has been completed and\n   * either a result, a cancelation or a failure has been returned.\n   *\n   * @return {!Promise<!web-activities/activity-ports.ActivityResult>}\n   * @override\n   */\n  acceptResult() {\n    return this.iframePort_.acceptResult();\n  }\n\n  /**\n   * Register a callback to handle resize requests. Once successfully resized,\n   * ensure to call `resized()` method.\n   * @param {function(number)} callback\n   */\n  onResizeRequest(callback) {\n    return this.iframePort_.onResizeRequest(callback);\n  }\n\n  /**\n   * @param {!../proto/api_messages.Message} request\n   */\n  execute(request) {\n    this.iframePort_.message({'REQUEST': request.toArray()});\n  }\n\n  /**\n   * @param {!function(new: T)} message\n   * @param {function(?)} callback\n   * @template T\n   */\n  on(message, callback) {\n    let label = null;\n    try {\n      label = getLabel(message);\n    } catch (ex) {\n      // Thrown if message is not a proto object and has no label\n      label = null;\n    }\n    if (!label) {\n      throw new Error('Invalid data type');\n    } else if (this.callbackMap_[label]) {\n      throw new Error('Invalid type or duplicate callback for ', label);\n    }\n    this.callbackMap_[label] = callback;\n  }\n\n  /**\n   * Signals back to the activity implementation that the client has updated\n   * the activity's size.\n   */\n  resized() {\n    this.iframePort_.resized();\n  }\n}\n\nclass ActivityPorts$1 {\n  /**\n   * @param {!../runtime/deps.DepsDef} deps\n   */\n  constructor(deps) {\n    /** @private @const {!../runtime/deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!web-activities/activity-ports.ActivityPorts} */\n    this.activityPorts_ = new WebActivityPorts(deps.win());\n  }\n\n  /**\n   * Adds client version, publication, product and logging context information.\n   * @param {?Object=} args\n   * @return {!Object}\n   */\n  addDefaultArguments(args) {\n    const deps = this.deps_;\n    const pageConfig = deps.pageConfig();\n    const context = deps.analytics().getContext();\n    return Object.assign(\n      {\n        'analyticsContext': context.toArray(),\n        'publicationId': pageConfig.getPublicationId(),\n        'productId': pageConfig.getProductId(),\n        '_client': 'SwG 0.1.22.190',\n        'supportsEventManager': true,\n      },\n      args || {}\n    );\n  }\n\n  /*\n   * Start an activity within the specified iframe.\n   * @param {!HTMLIFrameElement} iframe\n   * @param {string} url\n   * @param {?Object=} args\n   * @return {!Promise<!ActivityIframePort>}\n   */\n  openActivityIframePort_(iframe, url, args) {\n    const activityPort = new ActivityIframePort$1(iframe, url, this.deps_, args);\n    return activityPort.connect().then(() => activityPort);\n  }\n\n  /**\n   * Start an activity within the specified iframe.\n   * @param {!HTMLIFrameElement} iframe\n   * @param {string} url\n   * @param {?Object=} args\n   * @param {boolean=} addDefaultArguments\n   * @return {!Promise<!ActivityIframePort>}\n   */\n  openIframe(iframe, url, args, addDefaultArguments = false) {\n    if (addDefaultArguments) {\n      args = this.addDefaultArguments(args);\n    }\n    return this.openActivityIframePort_(iframe, url, args);\n  }\n\n  /**\n   * Start an activity in a separate window. The result will be delivered\n   * to the `onResult` callback.\n   *\n   * The activity can be opened in two modes: \"popup\" and \"redirect\". This\n   * depends on the `target` value, but also on the browser/environment.\n   *\n   * The allowed `target` values are `_blank`, `_top` and name targets. The\n   * `_self`, `_parent` and similar targets are not allowed.\n   *\n   * The `_top` target indicates that the activity should be opened as a\n   * \"redirect\", while other targets indicate that the activity should be\n   * opened as a popup. The activity client will try to honor the requested\n   * target. However, it's not always possible. Some environments do not\n   * allow popups and they either force redirect or fail the window open\n   * request. In this case, the activity will try to fallback to the \"redirect\"\n   * mode.\n   *\n   * @param {string} requestId\n   * @param {string} url\n   * @param {string} target\n   * @param {?Object=} args\n   * @param {?web-activities/activity-ports.ActivityOpenOptions=} options\n   * @param {boolean=} addDefaultArguments\n   * @return {{targetWin: ?Window}}\n   */\n  open(requestId, url, target, args, options, addDefaultArguments = false) {\n    if (addDefaultArguments) {\n      args = this.addDefaultArguments(args);\n    }\n    return this.activityPorts_.open(requestId, url, target, args, options);\n  }\n\n  /**\n   * Registers the callback for the result of the activity opened with the\n   * specified `requestId` (see the `open()` method). The callback is a\n   * function that takes a single `ActivityPort` argument. The client\n   * can use this object to verify the port using it's origin, verified and\n   * secure channel flags. Then the client can call\n   * `ActivityPort.acceptResult()` method to accept the result.\n   *\n   * The activity result is handled via a separate callback because of a\n   * possible redirect. So use of direct callbacks and/or promises is not\n   * possible in that case.\n   *\n   * A typical implementation would look like:\n   * ```\n   * ports.onResult('request1', function(port) {\n   *   port.acceptResult().then(function(result) {\n   *     // Only verified origins are allowed.\n   *     if (result.origin == expectedOrigin &&\n   *         result.originVerified &&\n   *         result.secureChannel) {\n   *       handleResultForRequest1(result);\n   *     }\n   *   });\n   * })\n   *\n   * ports.open('request1', request1Url, '_blank');\n   * ```\n   *\n   * @param {string} requestId\n   * @param {function(!ActivityPortDef)} callback\n   */\n  onResult(requestId, callback) {\n    this.activityPorts_.onResult(requestId, (port) => {\n      callback(new ActivityPortDeprecated(port));\n    });\n  }\n\n  /**\n   * @param {function(!Error)} handler\n   */\n  onRedirectError(handler) {\n    this.activityPorts_.onRedirectError(handler);\n  }\n\n  /**\n   * @return {!web-activities/activity-ports.ActivityPorts}\n   */\n  getOriginalWebActivityPorts() {\n    return this.activityPorts_;\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Determines if value is actually an Object.\n * @param {*} value\n * @return {boolean}\n */\nfunction isObject(value) {\n  const str = Object.prototype.toString.call(value);\n  return str === '[object Object]';\n}\n\n/**\n * Checks whether `s` is a valid value of `enumObj`.\n *\n * @param {!Object<T>} enumObj\n * @param {T} s\n * @return {boolean}\n * @template T\n */\nfunction isEnumValue(enumObj, s) {\n  for (const k in enumObj) {\n    if (enumObj[k] === s) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * True if the value is a function.\n * @param {*} value\n * @return {boolean}\n */\nfunction isFunction(value) {\n  return typeof value === 'function';\n}\n\n/**\n * True if the value is either true or false.\n * @param {?*} value\n * @return {boolean}\n */\nfunction isBoolean(value) {\n  return typeof value === 'boolean';\n}\n\n/**\n * Copyright 2019 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Helper function to describe an issue with an event object\n * @param {!string} valueName\n * @param {?*} value\n * @returns {!string}\n */\nfunction createEventErrorMessage(valueName, value) {\n  return 'Event has an invalid ' + valueName + '(' + value + ')';\n}\n\n/**\n * Throws an error if the event is invalid.\n * @param {!../api/client-event-manager-api.ClientEvent} event\n */\nfunction validateEvent(event) {\n  if (!isObject(event)) {\n    throw new Error('Event must be a valid object');\n  }\n\n  if (!isEnumValue(AnalyticsEvent, event.eventType)) {\n    throw new Error(createEventErrorMessage('eventType', event.eventType));\n  }\n\n  if (!isEnumValue(EventOriginator, event.eventOriginator)) {\n    throw new Error(\n      createEventErrorMessage('eventOriginator', event.eventOriginator)\n    );\n  }\n\n  if (\n    !isObject(event.additionalParameters) &&\n    event.additionalParameters != null\n  ) {\n    throw new Error(\n      createEventErrorMessage(\n        'additionalParameters',\n        event.additionalParameters\n      )\n    );\n  }\n\n  if (event.isFromUserAction != null && !isBoolean(event.isFromUserAction)) {\n    throw new Error(\n      createEventErrorMessage('isFromUserAction', event.isFromUserAction)\n    );\n  }\n}\n\n/** @implements {../api/client-event-manager-api.ClientEventManagerApi} */\nclass ClientEventManager {\n  /**\n   * @param {!../api/client-event-manager-api.ClientEvent} event\n   * @return {boolean}\n   */\n  static isPublisherEvent(event) {\n    return (\n      event.eventOriginator === EventOriginator.PROPENSITY_CLIENT ||\n      event.eventOriginator === EventOriginator.PUBLISHER_CLIENT ||\n      event.eventOriginator === EventOriginator.AMP_CLIENT\n    );\n  }\n\n  /**\n   *\n   * @param {!Promise} configuredPromise\n   */\n  constructor(configuredPromise) {\n    /** @private {!Array<function(!../api/client-event-manager-api.ClientEvent)>} */\n    this.listeners_ = [];\n\n    /** @private {!Array<function(!../api/client-event-manager-api.ClientEvent):!FilterResult>} */\n    this.filterers_ = [];\n\n    /** @private {?Promise} */\n    this.lastAction_ = null;\n\n    /** @private @const {!Promise} */\n    this.isReadyPromise_ = configuredPromise;\n  }\n\n  /**\n   * @overrides\n   */\n  registerEventListener(listener) {\n    if (!isFunction(listener)) {\n      throw new Error('Event manager listeners must be a function');\n    }\n    this.listeners_.push(listener);\n  }\n\n  /**\n   * @overrides\n   */\n  registerEventFilterer(filterer) {\n    if (!isFunction(filterer)) {\n      throw new Error('Event manager filterers must be a function');\n    }\n    this.filterers_.push(filterer);\n  }\n\n  /**\n   * @overrides\n   * @param {!../api/client-event-manager-api.ClientEvent} event\n   */\n  logEvent(event) {\n    validateEvent(event);\n    this.lastAction_ = this.isReadyPromise_.then(() => {\n      for (let filterer = 0; filterer < this.filterers_.length; filterer++) {\n        try {\n          if (this.filterers_[filterer](event) === FilterResult.CANCEL_EVENT) {\n            return Promise.resolve();\n          }\n        } catch (e) {\n          log(e);\n        }\n      }\n      for (let listener = 0; listener < this.listeners_.length; listener++) {\n        try {\n          this.listeners_[listener](event);\n        } catch (e) {\n          log(e);\n        }\n      }\n      return Promise.resolve();\n    });\n  }\n\n  /**\n   * Creates an event with the arguments provided and calls logEvent.\n   * @param {!AnalyticsEvent} eventType\n   * @param {?boolean=} isFromUserAction\n   * @param {../proto/api_messages.EventParams=} eventParams\n   */\n  logSwgEvent(eventType, isFromUserAction = false, eventParams = null) {\n    this.logEvent({\n      eventType,\n      eventOriginator: EventOriginator.SWG_CLIENT,\n      isFromUserAction,\n      additionalParameters: eventParams,\n    });\n  }\n\n  /** @return {!Promise<null>} */\n  getReadyPromise() {\n    return this.isReadyPromise_;\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @enum {string}\n */\nconst ExperimentFlags = {\n  /**\n   * Enables the feature that allows you to replace one subscription\n   * for another in the subscribe() API.\n   */\n  REPLACE_SUBSCRIPTION: 'replace-subscription',\n\n  /**\n   * Enables the contributions feature.\n   * DEPRECATED. This flag can be removed once not used by anyone.\n   */\n  CONTRIBUTIONS: 'contributions',\n\n  /**\n   * Enables the Propensity feature\n   */\n  PROPENSITY: 'propensity',\n\n  /**\n   * Enables the Smartbox feature.\n   */\n  SMARTBOX: 'smartbox',\n\n  /**\n   * Enables using new Activities APIs\n   */\n  HEJIRA: 'hejira',\n\n  /** Enables logging to both the new SwG Clearcut service and the pre-existing\n   *  Clearcut iframe while we verify the new logging system works.\n   *  Publishers should not activate this experiment.\n   */\n  LOGGING_BEACON: 'logging-beacon',\n\n  /** Enables googleTransactionID change. With the experiment on the ID is\n   *  changed from '<uuid>' to '<uuid>.swg'.\n   */\n  UPDATE_GOOGLE_TRANSACTION_ID: 'update-google-transaction-id',\n\n  /**\n   * Experiment flag for guarding changes to fix PayClient redirect flow.\n   */\n  PAY_CLIENT_REDIRECT: 'pay-client-redirect',\n};\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview\n *\n * Client-side experiments in SwG.\n *\n * The experiments can be set in a few different ways:\n *  1. By gulp build rules using `--experiments=${experimentsString}` argument.\n *  2. By `#swg.experiments=${experimentsString}` parameter in the URL's\n *     fragment.\n *  3. By `swg.configure({experiments: [array]})` call.\n *\n * The `${experimentsString}` is defined as following:\n *  - experimentString = (experimentSpec,)*\n *  - experimentSpec = experimentId | experimentId '=' num100 ('c')?\n *\n * Some examples:\n *  - `A,B` - defines two experiments \"A\" and \"B\" that will be turned on.\n *  - `A:100,B:100` - the same: \"A\" and \"B\" will be turned on.\n *  - `A:0` - the experiment \"A\" will be disabled.\n *  - `A:1` - enable the experiment \"A\" in 1% of impressions.\n *  - `A:10c` - enable the experiment \"A\" in 10% of impressions with 10%\n *    control. In this case, 20% of the impressions will be split into two\n *    categories: experiment and control. Notice, a control can be requested\n *    only for the fraction under 20%.\n */\n\n/**\n * @enum {string}\n */\nconst Selection = {\n  EXPERIMENT: 'e',\n  CONTROL: 'c',\n};\n\n/**\n * A comma-separated set of experiments.\n * @type {string}\n */\nlet experimentsString = '';\n\n/**\n * A parsed map of experiments.\n * @type {?Object<string, boolean>}\n */\nlet experimentMap = null;\n\n/**\n * Ensures that the experiments have been initialized and returns them.\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n */\nfunction getExperiments(win) {\n  if (!experimentMap) {\n    experimentMap = {};\n    let combinedExperimentString = experimentsString;\n    try {\n      const query = parseQueryString(win.location.hash);\n      const experimentStringFromHash = query['swg.experiments'];\n      if (experimentStringFromHash) {\n        combinedExperimentString += ',' + experimentStringFromHash;\n      }\n    } catch (e) {\n      // Ignore: experiment parsing cannot block runtime.\n      ErrorUtils.throwAsync(e);\n    }\n\n    // Format:\n    // - experimentString = (experimentSpec,)*\n    combinedExperimentString.split(',').forEach((s) => {\n      s = s.trim();\n      if (!s) {\n        return;\n      }\n      try {\n        parseSetExperiment(win, experimentMap, s);\n      } catch (e) {\n        // Ignore: experiment parsing cannot block runtime.\n        ErrorUtils.throwAsync(e);\n      }\n    });\n  }\n  return experimentMap;\n}\n\n/**\n * @param {!Window} win\n * @param {?Object<string, boolean>} experimentMap\n * @param {string} spec\n */\nfunction parseSetExperiment(win, experimentMap, spec) {\n  // Format:\n  // - experimentSpec = experimentId | experimentId '=' num100 ('c')?\n  let experimentId;\n  let fraction;\n  let control = false;\n  const eq = spec.indexOf(':');\n  if (eq == -1) {\n    experimentId = spec;\n    fraction = 100;\n    control = false;\n  } else {\n    experimentId = spec.substring(0, eq).trim();\n    spec = spec.substring(eq + 1);\n    if (spec.substring(spec.length - 1) == Selection.CONTROL) {\n      control = true;\n      spec = spec.substring(0, spec.length - 1);\n    }\n    fraction = parseInt(spec, 10);\n  }\n  if (isNaN(fraction)) {\n    throw new Error('invalid fraction');\n  }\n\n  // Calculate \"on\"/\"off\".\n  let on;\n  if (fraction > 99) {\n    // Explicitly \"on\".\n    on = true;\n  } else if (fraction < 1) {\n    // Explicitly \"off\".\n    on = false;\n  } else if (win.sessionStorage) {\n    // Fractional and possibly with the control.\n    // Note that:\n    // a. We can't do persistent experiments if storage is not available.\n    // b. We can't run control on more than 20%.\n    control = control && fraction <= 20;\n    try {\n      // Set fraction in the experiment to make it unlaunchable.\n      const storageKey =\n        'subscribe.google.com:e:' +\n        experimentId +\n        ':' +\n        fraction +\n        (control ? 'c' : '');\n      let selection = parseSelection(win.sessionStorage.getItem(storageKey));\n      if (!selection) {\n        // Is experiment/control range?\n        if (win.Math.random() * 100 <= fraction * (control ? 2 : 1)) {\n          const inExperiment = control ? win.Math.random() <= 0.5 : true;\n          selection = inExperiment ? Selection.EXPERIMENT : Selection.CONTROL;\n          win.sessionStorage.setItem(storageKey, selection);\n        }\n      }\n      on = !!selection;\n      if (selection == Selection.CONTROL) {\n        experimentId = 'c-' + experimentId;\n      }\n    } catch (e) {\n      // Ignore: experiment parsing cannot block runtime.\n      on = false;\n      ErrorUtils.throwAsync(e);\n    }\n  } else {\n    on = false;\n  }\n\n  experimentMap[experimentId] = on;\n}\n\n/**\n * @param {?string} s\n * @return {?Selection}\n */\nfunction parseSelection(s) {\n  // Do a simple if-then to inline the whole Selection enum.\n  return s == Selection.EXPERIMENT\n    ? Selection.EXPERIMENT\n    : s == Selection.CONTROL\n    ? Selection.CONTROL\n    : null;\n}\n\n/**\n * Whether the specified experiment is on or off.\n * @param {!Window} win\n * @param {string} experimentId\n * @return {boolean}\n */\nfunction isExperimentOn(win, experimentId) {\n  return getExperiments(win)[experimentId] || false;\n}\n\n/**\n * Toggles the experiment on or off. Returns the actual value of the experiment\n * after toggling is done.\n * @param {!Window} win\n * @param {string} experimentId\n * @param {boolean} on\n */\nfunction setExperiment(win, experimentId, on) {\n  getExperiments(win)[experimentId] = on;\n}\n\n/**\n * @return {!Array<string>}\n */\nfunction getOnExperiments(win) {\n  const experimentMap = getExperiments(win);\n  const experiments = [];\n  for (const experiment in experimentMap) {\n    if (experimentMap[experiment]) {\n      experiments.push(experiment);\n    }\n  }\n  return experiments;\n}\n\n/**\n * Copyright 2020 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {!number} millis\n * @return {!Timestamp}\n */\nfunction toTimestamp(millis) {\n  return new Timestamp(\n    [Math.floor(millis / 1000), (millis % 1000) * 1000000],\n    false\n  );\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {!Object<string, string>} */\nconst iframeStyles = {\n  opacity: '0',\n  position: 'absolute',\n  top: '-10px',\n  left: '-10px',\n  height: '1px',\n  width: '1px',\n};\n\n// The initial iframe load takes ~500 ms.  We will wait at least that long\n// before a page redirect.  Subsequent logs are much faster.  We will wait at\n// most 100 ms.\nconst MAX_FIRST_WAIT = 500;\nconst MAX_WAIT = 200;\n// If we logged and rapidly redirected, we will add a short delay in case\n// a message hasn't been transmitted yet.\nconst TIMEOUT_ERROR = 'AnalyticsService timed out waiting for a response';\n\n/**\n *\n * @param {!string} error\n */\nfunction createErrorResponse(error) {\n  const response = new FinishedLoggingResponse();\n  response.setComplete(false);\n  response.setError(error);\n  return response;\n}\n\nclass AnalyticsService {\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {!./fetcher.Fetcher} fetcher\n   */\n  constructor(deps, fetcher) {\n    /** @private @const {!./fetcher.Fetcher} */\n    this.fetcher_ = fetcher;\n\n    /** @private @const {!../model/doc.Doc} */\n    this.doc_ = deps.doc();\n\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!HTMLIFrameElement} */\n    this.iframe_ = /** @type {!HTMLIFrameElement} */ (\n      createElement(this.doc_.getWin().document, 'iframe', {})\n    );\n    setImportantStyles$1(this.iframe_, iframeStyles);\n    this.doc_.getBody().appendChild(this.getElement());\n\n    /** @private @type {!boolean} */\n    this.everFinishedLog_ = false;\n\n    /**\n     * @private @const {!AnalyticsContext}\n     */\n    this.context_ = new AnalyticsContext();\n    this.setStaticContext_();\n\n    /** @private {?Promise<!web-activities/activity-ports.ActivityIframePort>} */\n    this.serviceReady_ = null;\n\n    /** @private {?Promise} */\n    this.lastAction_ = null;\n\n    /** @private @const {!ClientEventManager} */\n    this.eventManager_ = deps.eventManager();\n    this.eventManager_.registerEventListener(\n      this.handleClientEvent_.bind(this)\n    );\n\n    // This code creates a 'promise to log' that we can use to ensure all\n    // logging is finished prior to redirecting the page.\n    /** @private {!number} */\n    this.unfinishedLogs_ = 0;\n\n    /** @private {?function(boolean)} */\n    this.loggingResolver_ = null;\n\n    /** @private {?Promise} */\n    this.promiseToLog_ = null;\n\n    // If logging doesn't work don't force the user to wait\n    /** @private {!boolean} */\n    this.loggingBroken_ = false;\n\n    // If logging exceeds the timeouts (see const comments above) don't make\n    // the user wait too long.\n    /** @private {?number} */\n    this.timeout_ = null;\n\n    // A callback for setting the client timestamp before sending requests.\n    /** @private {function():!../proto/api_messages.Timestamp} */\n    this.getTimestamp_ = () => {\n      return toTimestamp(Date.now());\n    };\n  }\n\n  /**\n   * @param {string} transactionId\n   */\n  setTransactionId(transactionId) {\n    const oldTransactionId = this.context_.getTransactionId();\n    this.context_.setTransactionId(transactionId);\n    if (oldTransactionId != null && oldTransactionId != transactionId) {\n      const eventType = AnalyticsEvent.EVENT_NEW_TX_ID;\n      const eventParams = new EventParams();\n      eventParams.setOldTransactionId(oldTransactionId);\n      this.eventManager_.logSwgEvent(\n        eventType,\n        /* isFromUserAction= */ true,\n        eventParams\n      );\n    }\n  }\n\n  /**\n   * @return {string}\n   */\n  getTransactionId() {\n    return /** @type {string} */ (this.context_.getTransactionId());\n  }\n\n  /**\n   * @return {?string}\n   */\n  getSku() {\n    return this.context_.getSku();\n  }\n\n  /**\n   * @param {string} sku\n   */\n  setSku(sku) {\n    this.context_.setSku(sku);\n  }\n\n  /**\n   * @param {string} url\n   */\n  setUrl(url) {\n    this.context_.setUrl(url);\n  }\n\n  /**\n   * @param {!Array<string>} labels\n   */\n  addLabels(labels) {\n    if (labels && labels.length > 0) {\n      const newLabels = [].concat(this.context_.getLabelList());\n      labels.forEach((label) => {\n        if (newLabels.indexOf(label) == -1) {\n          newLabels.push(label);\n        }\n      });\n      this.context_.setLabelList(newLabels);\n    }\n  }\n\n  /**\n   * @return {!HTMLIFrameElement}\n   */\n  getElement() {\n    return this.iframe_;\n  }\n\n  /**\n   * @return {string}\n   * @private\n   */\n  getQueryString_() {\n    return this.doc_.getWin().location.search;\n  }\n\n  /**\n   * @return {string}\n   * @private\n   */\n  getReferrer_() {\n    return this.doc_.getWin().document.referrer;\n  }\n\n  /**\n   * @private\n   */\n  setStaticContext_() {\n    const context = this.context_;\n    // These values should all be available during page load.\n    if (\n      isExperimentOn(\n        this.doc_.getWin(),\n        ExperimentFlags.UPDATE_GOOGLE_TRANSACTION_ID\n      )\n    ) {\n      context.setTransactionId(getSwgTransactionId());\n    } else {\n      context.setTransactionId(getUuid());\n    }\n    context.setReferringOrigin(parseUrl(this.getReferrer_()).origin);\n    context.setClientVersion('SwG 0.1.22.190');\n    context.setUrl(getCanonicalUrl(this.doc_));\n\n    const utmParams = parseQueryString(this.getQueryString_());\n    const campaign = utmParams['utm_campaign'];\n    const medium = utmParams['utm_medium'];\n    const source = utmParams['utm_source'];\n    if (campaign) {\n      context.setUtmCampaign(campaign);\n    }\n    if (medium) {\n      context.setUtmMedium(medium);\n    }\n    if (source) {\n      context.setUtmSource(source);\n    }\n  }\n\n  /**\n   * @return {!Promise<!../components/activities.ActivityIframePort>}\n   */\n  start() {\n    if (!this.serviceReady_) {\n      // Please note that currently openIframe reads the current analytics\n      // context and that it may not contain experiments activated late during\n      // the publishers code lifecycle.\n      this.addLabels(getOnExperiments(this.doc_.getWin()));\n      this.serviceReady_ = this.activityPorts_\n        .openIframe(this.iframe_, feUrl('/serviceiframe'), null, true)\n        .then(\n          (port) => {\n            // Register a listener for the logging to code indicate it is\n            // finished logging.\n            port.on(FinishedLoggingResponse, this.afterLogging_.bind(this));\n            return port.whenReady().then(() => {\n              // The publisher should be done setting experiments but runtime\n              // will forward them here if they aren't.\n              this.addLabels(getOnExperiments(this.doc_.getWin()));\n              return port;\n            });\n          },\n          (message) => {\n            // If the port doesn't open register that logging is broken so\n            // nothing is just waiting.\n            this.loggingBroken_ = true;\n            this.afterLogging_(\n              createErrorResponse('Could not connect [' + message + ']')\n            );\n          }\n        );\n    }\n    return this.serviceReady_;\n  }\n\n  /**\n   * @param {boolean} isReadyToPay\n   */\n  setReadyToPay(isReadyToPay) {\n    this.context_.setReadyToPay(isReadyToPay);\n  }\n\n  /**\n   */\n  close() {\n    this.doc_.getBody().removeChild(this.getElement());\n  }\n\n  /**\n   * @return {!AnalyticsContext}\n   */\n  getContext() {\n    return this.context_;\n  }\n\n  /**\n   * @param {!../api/client-event-manager-api.ClientEvent} event\n   * @return {!AnalyticsRequest}\n   */\n  createLogRequest_(event) {\n    const meta = new AnalyticsEventMeta();\n    meta.setEventOriginator(event.eventOriginator);\n    meta.setIsFromUserAction(!!event.isFromUserAction);\n    // Update the of the analytics context to the current time.\n    // This needs to be current for log analysis.\n    this.context_.setClientTimestamp(this.getTimestamp_());\n    const request = new AnalyticsRequest();\n    request.setEvent(/** @type {!AnalyticsEvent} */ (event.eventType));\n    request.setContext(this.context_);\n    request.setMeta(meta);\n    if (event.additionalParameters instanceof EventParams) {\n      request.setParams(event.additionalParameters);\n    } // Ignore event.additionalParameters.  It may have data we shouldn't log.\n    return request;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  shouldLogPublisherEvents_() {\n    return this.deps_.config().enableSwgAnalytics === true;\n  }\n\n  /**\n   * @param {!../api/client-event-manager-api.ClientEvent} event\n   * @return {boolean}\n   */\n  shouldAlwaysLogEvent_(event) {\n    /* AMP_CLIENT events are considered publisher events and we generally only\n     * log those if the publisher decided to enable publisher event logging for\n     * privacy purposes.  The page load event is not private and is necessary\n     * just so we know the user is in AMP, so we will log it regardless of\n     * configuration.\n     */\n    return (\n      event.eventType === AnalyticsEvent.IMPRESSION_PAGE_LOAD &&\n      event.eventOriginator === EventOriginator.AMP_CLIENT\n    );\n  }\n\n  /**\n   *  Listens for new events from the events manager and handles logging\n   * @param {!../api/client-event-manager-api.ClientEvent} event\n   */\n  handleClientEvent_(event) {\n    //this event is just used to communicate information internally.  It should\n    //not be reported to the SwG analytics service.\n    if (event.eventType === AnalyticsEvent.EVENT_SUBSCRIPTION_STATE) {\n      return;\n    }\n\n    // Permission should be asked from a privacy workgroup before this originator\n    // can be submitted to the analytics service.  It should most likely be treated\n    // as another kind of publisher event here though.\n    if (event.eventOriginator === EventOriginator.SHOWCASE_CLIENT) {\n      return;\n    }\n\n    if (\n      ClientEventManager.isPublisherEvent(event) &&\n      !this.shouldLogPublisherEvents_() &&\n      !this.shouldAlwaysLogEvent_(event)\n    ) {\n      return;\n    }\n    // Register we sent a log, the port will call this.afterLogging_ when done.\n    this.unfinishedLogs_++;\n    this.lastAction_ = this.start().then((port) => {\n      const analyticsRequest = this.createLogRequest_(event);\n      port.execute(analyticsRequest);\n      if (isExperimentOn(this.doc_.getWin(), ExperimentFlags.LOGGING_BEACON)) {\n        this.sendBeacon_(analyticsRequest);\n      }\n    });\n  }\n\n  /**\n   * This function is called by the iframe after it sends the log to the server.\n   * @param {../proto/api_messages.Message=} message\n   */\n  afterLogging_(message) {\n    const response = /** @type {!FinishedLoggingResponse} */ (message);\n    const success = (response && response.getComplete()) || false;\n    const error = (response && response.getError()) || 'Unknown logging Error';\n    const isTimeout = error === TIMEOUT_ERROR;\n\n    if (!success) {\n      log('Error when logging: ' + error);\n    }\n\n    this.unfinishedLogs_--;\n    if (!isTimeout) {\n      this.everFinishedLog_ = true;\n    }\n\n    // Nothing is waiting\n    if (this.loggingResolver_ === null) {\n      return;\n    }\n\n    if (this.unfinishedLogs_ === 0 || this.loggingBroken_ || isTimeout) {\n      if (this.timeout_ !== null) {\n        clearTimeout(this.timeout_);\n        this.timeout_ = null;\n      }\n      this.loggingResolver_(success);\n      this.promiseToLog_ = null;\n      this.loggingResolver_ = null;\n    }\n  }\n\n  /**\n   * Please note that logs sent after getLoggingPromise is called are not\n   * guaranteed to be finished when the promise is resolved.  You should call\n   * this function just prior to redirecting the page after SwG is finished\n   * logging.\n   * @return {!Promise}\n   */\n  getLoggingPromise() {\n    if (this.unfinishedLogs_ === 0 || this.loggingBroken_) {\n      return Promise.resolve(true);\n    }\n    if (this.promiseToLog_ === null) {\n      this.promiseToLog_ = new Promise((resolve) => {\n        this.loggingResolver_ = resolve;\n      });\n\n      // The promise above should not wait forever if things go wrong.  Let\n      // the user proceed!\n      const whenDone = this.afterLogging_.bind(this);\n      this.timeout_ = setTimeout(\n        () => {\n          this.timeout_ = null;\n          whenDone(createErrorResponse(TIMEOUT_ERROR));\n        },\n        this.everFinishedLog_ ? MAX_WAIT : MAX_FIRST_WAIT\n      );\n    }\n\n    return this.promiseToLog_;\n  }\n\n  /**\n   * A beacon is a rapid fire browser request that does not wait for a response\n   * from the server.  It is guaranteed to go out before the page redirects.\n   * @param {!AnalyticsRequest} analyticsRequest\n   */\n  sendBeacon_(analyticsRequest) {\n    const pubId = encodeURIComponent(\n      this.deps_.pageConfig().getPublicationId()\n    );\n    const url = serviceUrl('/publication/' + pubId + '/clientlogs');\n    this.fetcher_.sendBeacon(url, analyticsRequest);\n  }\n}\n\n/**\n * Copyright 2021 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Why is there a strings.js and a swg-strings.js, you ask? strings.js is a\n// generated file, currently used for gaa builds. This file is used for swg and\n// swg-basic builds, and is currently manually updated.\n// TODO(stellachui): Figure out if they should be merged without a large impact\n//   on binary size.\n\nconst SWG_I18N_STRINGS = {\n  'SUBSCRIPTION_TITLE_LANG_MAP': {\n    'en': 'Subscribe with Google',\n    'ar': 'Google \u0627\u0634\u062A\u0631\u0643\u00A0\u0645\u0639',\n    'de': 'Abonnieren mit Google',\n    'en-au': 'Subscribe with Google',\n    'en-ca': 'Subscribe with Google',\n    'en-gb': 'Subscribe with Google',\n    'en-us': 'Subscribe with Google',\n    'es': 'Suscr\u00EDbete con Google',\n    'es-419': 'Suscr\u00EDbete con Google',\n    'es-latam': 'Suscr\u00EDbete con Google',\n    'es-latn': 'Suscr\u00EDbete con Google',\n    'fr': \"S'abonner avec Google\",\n    'fr-ca': \"S'abonner avec Google\",\n    'hi': 'Google \u0915\u0947 \u095B\u0930\u093F\u092F\u0947 \u0938\u0926\u0938\u094D\u092F\u0924\u093E',\n    'id': 'Berlangganan dengan Google',\n    'it': 'Abbonati con Google',\n    'jp': 'Google \u3067\u8CFC\u8AAD',\n    'ko': 'Google \uC744 \uD1B5\uD55C\uAD6C\uB3C5',\n    'ms': 'Langgan dengan Google',\n    'nl': 'Abonneren via Google',\n    'no': 'Abonner med Google',\n    'pl': 'Subskrybuj z Google',\n    'pt': 'Subscrever com o Google',\n    'pt-br': 'Assine com o Google',\n    'ru': '\u041F\u043E\u0434\u043F\u0438c\u043A\u0430 \u0447\u0435\u0440\u0435\u0437 Google',\n    'se': 'Prenumerera med Google',\n    'th': '\u0E2A\u0E21\u0E31\u0E04\u0E23\u0E1F\u0E32\u0E19 Google',\n    'tr': 'Google ile Abone Ol',\n    'uk': '\u041F\u0456\u0434\u043F\u0438\u0441\u0430\u0442\u0438\u0441\u044F \u0447\u0435\u0440\u0435\u0437 Google',\n    'zh-tw': '\u900F\u904E Google \u8A02\u95B1',\n  },\n  'CONTRIBUTION_TITLE_LANG_MAP': {\n    'en': 'Contribute with Google',\n    'ar': '\u0627\u0644\u0645\u0633\u0627\u0647\u0645\u0629 \u0628\u0627\u0633\u062A\u062E\u062F\u0627\u0645 Google',\n    'de': 'Mit Google beitragen',\n    'en-au': 'Contribute with Google',\n    'en-ca': 'Contribute with Google',\n    'en-gb': 'Contribute with Google',\n    'en-us': 'Contribute with Google',\n    'es': '\tContribuye con Google',\n    'es-419': 'Contribuir con Google',\n    'es-latam': 'Contribuir con Google',\n    'es-latn': 'Contribuye con Google',\n    'fr': 'Contribuer avec Google',\n    'fr-ca': 'Contribuer avec Google',\n    'hi': 'Google \u0916\u093E\u0924\u0947 \u0915\u0940 \u092E\u0926\u0926 \u0938\u0947 \u092F\u094B\u0917\u0926\u093E\u0928 \u0915\u0930\u0947\u0902',\n    'id': 'Berkontribusi dengan Google',\n    'it': 'Contribuisci con Google',\n    'jp': 'Google \u3067\u5BC4\u4ED8',\n    'ko': 'Google\uC744 \uD1B5\uD574 \uCC38\uC5EC\uD558\uAE30',\n    'ms': 'Sumbangkan dengan Google',\n    'nl': 'Bijdragen met Google',\n    'no': 'Bidra med Google',\n    'pl': 'Wesprzyj publikacj\u0119 przez Google',\n    'pt': 'Contribuir com o Google',\n    'pt-br': 'Contribua com o Google',\n    'ru': '\u0412\u043D\u0435\u0441\u0442\u0438 \u0441\u0440\u0435\u0434\u0441\u0442\u0432\u0430 \u0447\u0435\u0440\u0435\u0437 Google',\n    'se': 'Bidra med Google',\n    'th': '\u0E21\u0E35\u0E2A\u0E48\u0E27\u0E19\u0E23\u0E48\u0E27\u0E21\u0E1C\u0E48\u0E32\u0E19 Google',\n    'tr': 'Google ile Katk\u0131da Bulun',\n    'uk': '\u0417\u0440\u043E\u0431\u0438\u0442\u0438 \u0432\u043D\u0435\u0441\u043E\u043A \u0447\u0435\u0440\u0435\u0437 Google',\n    'zh-tw': '\u900F\u904E Google \u6350\u6B3E',\n  },\n};\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {!Object<string, string>} */\nconst iframeAttributes$1 = {\n  'frameborder': '0',\n  'scrolling': 'no',\n};\n\n/**\n * @enum {string}\n */\nconst Theme = {\n  LIGHT: 'light',\n  DARK: 'dark',\n};\n\n/**\n * The class for Smart button Api.\n */\nclass SmartSubscriptionButtonApi {\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {!Element} button\n   * @param {!../api/subscriptions.SmartButtonOptions} options\n   * @param {function(!Event=)=} callback\n   */\n  constructor(deps, button, options, callback) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!Document} */\n    this.doc_ = this.win_.document;\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!HTMLIFrameElement} */\n    this.iframe_ = /** @type {!HTMLIFrameElement} */ (\n      createElement(this.doc_, 'iframe', iframeAttributes$1)\n    );\n\n    /** @private @const {!Element} */\n    this.button_ = button;\n\n    /** @private {!../api/subscriptions.SmartButtonOptions} */\n    this.options_ = options;\n\n    /** @private @const */\n    this.callback_ = callback;\n\n    /** @private @const {string} */\n    this.src_ = feUrl('/smartboxiframe');\n\n    const frontendArguments = {\n      'productId': this.deps_.pageConfig().getProductId(),\n      'publicationId': this.deps_.pageConfig().getPublicationId(),\n      'theme': (this.options_ && this.options_.theme) || 'light',\n      'lang': (this.options_ && this.options_.lang) || 'en',\n    };\n    const messageTextColor = this.options_ && this.options_.messageTextColor;\n    if (messageTextColor) {\n      frontendArguments['messageTextColor'] = messageTextColor;\n    }\n\n    /** @private @const {!Object} */\n    this.args_ = feArgs(frontendArguments);\n  }\n\n  /**\n   * @param {SmartBoxMessage} smartBoxMessage\n   */\n  handleSmartBoxClick_(smartBoxMessage) {\n    if (smartBoxMessage && smartBoxMessage.getIsClicked()) {\n      if (!this.callback_) {\n        throw new Error('No callback!');\n      }\n      this.callback_();\n\n      return;\n    }\n  }\n\n  /**\n   * Make a call to build button content and listens for the 'click' message.\n   * @return {!Element}\n   */\n  start() {\n    setImportantStyles$1(this.iframe_, {\n      'opacity': 1,\n      'position': 'absolute',\n      'top': 0,\n      'bottom': 0,\n      'left': 0,\n      'height': '100%',\n      'right': 0,\n      'width': '100%',\n    });\n    this.button_.appendChild(this.iframe_);\n    const args = this.activityPorts_.addDefaultArguments(this.args_);\n    this.activityPorts_\n      .openIframe(this.iframe_, this.src_, args)\n      .then((port) => {\n        port.on(SmartBoxMessage, this.handleSmartBoxClick_.bind(this));\n      });\n    return this.iframe_;\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** English is the default language. */\nconst DEFAULT_LANGUAGE_CODE = 'en';\n\n/**\n * Gets a message for a given language code, from a map of messages.\n * @param {!Object<string, string>} map\n * @param {?string|?Element} languageCodeOrElement\n * @return {?string}\n */\nfunction msg(map, languageCodeOrElement) {\n  const defaultMsg = map[DEFAULT_LANGUAGE_CODE];\n\n  // Verify params.\n  if (typeof map !== 'object' || !languageCodeOrElement) {\n    return defaultMsg;\n  }\n\n  // Get language code.\n  let languageCode =\n    typeof languageCodeOrElement === 'string'\n      ? languageCodeOrElement\n      : getLanguageCodeFromElement(languageCodeOrElement);\n\n  // Normalize language code.\n  languageCode = languageCode.toLowerCase();\n  languageCode = languageCode.replace(/_/g, '-');\n\n  // Search for a message matching the language code.\n  // If a message can't be found, try again with a less specific language code.\n  const languageCodeSegments = languageCode.split('-');\n  while (languageCodeSegments.length) {\n    const key = languageCodeSegments.join('-');\n    if (key in map) {\n      return map[key];\n    }\n\n    // Simplify language code.\n    // Ex: \"en-US-SF\" => \"en-US\"\n    languageCodeSegments.pop();\n  }\n\n  // There was an attempt.\n  return defaultMsg;\n}\n\n/**\n * Gets a language code (ex: \"en-US\") from a given Element.\n * @param {!Element} element\n * @return {string}\n */\nfunction getLanguageCodeFromElement(element) {\n  if (element.lang) {\n    // Get language from element itself.\n    return element.lang;\n  }\n\n  if (element.ownerDocument && element.ownerDocument.documentElement.lang) {\n    // Get language from element's document.\n    return element.ownerDocument.documentElement.lang;\n  }\n\n  // There was an attempt.\n  return DEFAULT_LANGUAGE_CODE;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @enum {string} */\nconst ButtonAttributeValues = {\n  SUBSCRIPTION: 'subscription',\n  CONTRIBUTION: 'contribution',\n};\n\nconst BUTTON_INNER_HTML = `<div class=\"swg-button-v2-icon-$theme$\"></div>$textContent$`;\n\n/**\n * The button stylesheet can be found in the `/assets/swg-button.css`.\n * It's produced by the `gulp assets` task and deployed to\n * `https://news.google.com/swg/js/v1/swg-button.css`.\n */\nclass ButtonApi {\n  /**\n   * @param {!../model/doc.Doc} doc\n   * @param {!Promise<!./runtime.ConfiguredRuntime>} configuredRuntimePromise\n   */\n  constructor(doc, configuredRuntimePromise) {\n    /** @private @const {!../model/doc.Doc} */\n    this.doc_ = doc;\n\n    /** @private @const {!Promise<!./runtime.ConfiguredRuntime>} */\n    this.configuredRuntimePromise_ = configuredRuntimePromise;\n  }\n\n  /**\n   */\n  init() {\n    const head = this.doc_.getHead();\n    if (!head) {\n      return;\n    }\n\n    const url = 'https://news.google.com/swg/js/v1/swg-button.css';\n    const existing = head.querySelector(`link[href=\"${url}\"]`);\n    if (existing) {\n      return;\n    }\n\n    // <link rel=\"stylesheet\" href=\"...\" type=\"text/css\">\n    head.appendChild(\n      createElement(this.doc_.getWin().document, 'link', {\n        'rel': 'stylesheet',\n        'type': 'text/css',\n        'href': url,\n      })\n    );\n  }\n\n  /**\n   * @param {!../api/subscriptions.ButtonOptions|function()} optionsOrCallback\n   * @param {function()=} callback\n   * @return {!Element}\n   */\n  create(optionsOrCallback, callback) {\n    const button = createElement(this.doc_.getWin().document, 'button', {});\n    return this.attach(button, optionsOrCallback, callback);\n  }\n\n  /**\n   * Attaches the Classic 'Subscribe With Google' button.\n   * @param {!Element} button\n   * @param {../api/subscriptions.ButtonOptions|function()} optionsOrCallback\n   * @param {function()=} callback\n   * @return {!Element}\n   */\n  attach(button, optionsOrCallback, callback) {\n    const options = this.setupButtonAndGetParams_(\n      button,\n      AnalyticsEvent.ACTION_SWG_BUTTON_CLICK,\n      optionsOrCallback,\n      callback\n    ).options;\n\n    const theme = options['theme'];\n    button.classList.add(`swg-button-${theme}`);\n    button.setAttribute('role', 'button');\n    if (options['lang']) {\n      button.setAttribute('lang', options['lang']);\n    }\n    button.setAttribute(\n      'title',\n      msg(SWG_I18N_STRINGS.SUBSCRIPTION_TITLE_LANG_MAP, button) || ''\n    );\n    this.logSwgEvent_(AnalyticsEvent.IMPRESSION_SWG_BUTTON);\n\n    return button;\n  }\n\n  /**\n   * Attaches the new subscribe button, for subscription product types.\n   * @param {!Element} button\n   * @param {../api/subscriptions.ButtonOptions|function()} optionsOrCallback\n   * @param {function()=} callback\n   * @return {!Element}\n   */\n  attachSubscribeButton(button, optionsOrCallback, callback) {\n    const options = this.setupButtonAndGetParams_(\n      button,\n      AnalyticsEvent.ACTION_SWG_BUTTON_SHOW_OFFERS_CLICK,\n      optionsOrCallback,\n      callback\n    ).options;\n\n    const theme = options['theme'];\n    button.classList.add(`swg-button-v2-${theme}`);\n    button.setAttribute('role', 'button');\n    if (options['lang']) {\n      button.setAttribute('lang', options['lang']);\n    }\n    if (!options['enable']) {\n      button.setAttribute('disabled', 'disabled');\n    }\n    button./*OK*/ innerHTML = BUTTON_INNER_HTML.replace(\n      '$theme$',\n      theme\n    ).replace(\n      '$textContent$',\n      msg(SWG_I18N_STRINGS.SUBSCRIPTION_TITLE_LANG_MAP, button) || ''\n    );\n    this.logSwgEvent_(AnalyticsEvent.IMPRESSION_SHOW_OFFERS_SWG_BUTTON);\n\n    return button;\n  }\n\n  /**\n   * Attaches the new contribute button, for contribution product types.\n   * @param {!Element} button\n   * @param {../api/subscriptions.ButtonOptions|function()} optionsOrCallback\n   * @param {function()=} callback\n   * @return {!Element}\n   */\n  attachContributeButton(button, optionsOrCallback, callback) {\n    const options = this.setupButtonAndGetParams_(\n      button,\n      AnalyticsEvent.ACTION_SWG_BUTTON_SHOW_CONTRIBUTIONS_CLICK,\n      optionsOrCallback,\n      callback\n    ).options;\n\n    const theme = options['theme'];\n    button.classList.add(`swg-button-v2-${theme}`);\n    button.setAttribute('role', 'button');\n    if (options['lang']) {\n      button.setAttribute('lang', options['lang']);\n    }\n    if (!options['enable']) {\n      button.setAttribute('disabled', 'disabled');\n    }\n    button./*OK*/ innerHTML = BUTTON_INNER_HTML.replace(\n      '$theme$',\n      theme\n    ).replace(\n      '$textContent$',\n      msg(SWG_I18N_STRINGS.CONTRIBUTION_TITLE_LANG_MAP, button) || ''\n    );\n    this.logSwgEvent_(AnalyticsEvent.IMPRESSION_SHOW_CONTRIBUTIONS_SWG_BUTTON);\n\n    return button;\n  }\n\n  /**\n   * Attaches all buttons with the specified attribute set to any of the\n   * attribute values.\n   * @param {string} attribute\n   * @param {!Array<string>} attributeValues\n   * @param {../api/subscriptions.ButtonOptions} options\n   * @param {!Object<string, function()>} attributeValueToCallback\n   */\n  attachButtonsWithAttribute(\n    attribute,\n    attributeValues,\n    options,\n    attributeValueToCallback\n  ) {\n    attributeValues.forEach((attributeValue) => {\n      const elements = this.doc_\n        .getRootNode()\n        .querySelectorAll(`[${attribute}=\"${attributeValue}\"]`);\n      for (let i = 0; i < elements.length; i++) {\n        if (attributeValue === ButtonAttributeValues.SUBSCRIPTION) {\n          this.attachSubscribeButton(\n            elements[i],\n            options,\n            attributeValueToCallback[attributeValue]\n          );\n        } else if (attributeValue === ButtonAttributeValues.CONTRIBUTION) {\n          this.attachContributeButton(\n            elements[i],\n            options,\n            attributeValueToCallback[attributeValue]\n          );\n        }\n      }\n    });\n  }\n\n  /**\n   * @param {!AnalyticsEvent} eventType\n   * @param {boolean=} isFromUserAction\n   */\n  logSwgEvent_(eventType, isFromUserAction) {\n    this.configuredRuntimePromise_.then((configuredRuntime) => {\n      configuredRuntime.eventManager().logSwgEvent(eventType, isFromUserAction);\n    });\n  }\n\n  /**\n   *\n   * @param {../api/subscriptions.ButtonOptions|../api/subscriptions.SmartButtonOptions|function()} optionsOrCallback\n   * @return {!../api/subscriptions.ButtonOptions|!../api/subscriptions.SmartButtonOptions}\n   * @private\n   */\n  getOptions_(optionsOrCallback) {\n    const options =\n      /** @type {!../api/subscriptions.ButtonOptions|!../api/subscriptions.SmartButtonOptions} */ (\n        optionsOrCallback && typeof optionsOrCallback != 'function'\n          ? optionsOrCallback\n          : {'theme': Theme.LIGHT}\n      );\n\n    const theme = options['theme'];\n    if (theme !== Theme.LIGHT && theme !== Theme.DARK) {\n      options['theme'] = Theme.LIGHT;\n    }\n    return options;\n  }\n\n  /**\n   *\n   * @param {?../api/subscriptions.ButtonOptions|?../api/subscriptions.SmartButtonOptions|function()} optionsOrCallback\n   * @param {function()=} callback\n   * @return {function()|function(Event):boolean}\n   * @private\n   */\n  getCallback_(optionsOrCallback, callback) {\n    return /** @type {function()|function(Event):boolean} */ (\n      (typeof optionsOrCallback == 'function' ? optionsOrCallback : null) ||\n        callback\n    );\n  }\n\n  /**\n   * @param {!Element} button\n   * @param {AnalyticsEvent} clickEvent\n   * @param {../api/subscriptions.SmartButtonOptions|function()|../api/subscriptions.ButtonOptions} optionsOrCallback\n   * @param {function()=} callbackFun\n   * @return {ButtonParams}\n   */\n  setupButtonAndGetParams_(button, clickEvent, optionsOrCallback, callbackFun) {\n    const options = this.getOptions_(optionsOrCallback);\n    const callback = this.getCallback_(optionsOrCallback, callbackFun);\n    const clickFun = (event) => {\n      this.logSwgEvent_(clickEvent, true);\n      if (typeof callback === 'function') {\n        callback(event);\n      }\n    };\n    button.addEventListener('click', clickFun);\n    return {options, clickFun};\n  }\n\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {!Element} button\n   * @param {../api/subscriptions.SmartButtonOptions|function()} optionsOrCallback\n   * @param {function()=} callback\n   * @return {!Element}\n   */\n  attachSmartButton(deps, button, optionsOrCallback, callback) {\n    const params = this.setupButtonAndGetParams_(\n      button,\n      AnalyticsEvent.ACTION_SWG_BUTTON_CLICK,\n      optionsOrCallback,\n      callback\n    );\n    // Add required CSS class, if missing.\n    button.classList.add('swg-smart-button');\n    return new SmartSubscriptionButtonApi(\n      deps,\n      button,\n      params.options,\n      params.clickFun\n    ).start();\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @enum {number} */\nconst CallbackId = {\n  ENTITLEMENTS: 1,\n  SUBSCRIBE_REQUEST: 2,\n  PAYMENT_RESPONSE: 3,\n  LOGIN_REQUEST: 4,\n  LINK_PROGRESS: 5,\n  LINK_COMPLETE: 6,\n  FLOW_STARTED: 7,\n  FLOW_CANCELED: 8,\n};\n\n/**\n */\nclass Callbacks {\n  /**\n   */\n  constructor() {\n    /** @private @const {!Object<CallbackId, function(*)>} */\n    this.callbacks_ = {};\n    /** @private @const {!Object<CallbackId, *>} */\n    this.resultBuffer_ = {};\n    /** @private {?Promise} */\n    this.paymentResponsePromise_ = null;\n  }\n\n  /**\n   * @param {function(!Promise<!../api/entitlements.Entitlements>)} callback\n   */\n  setOnEntitlementsResponse(callback) {\n    this.setCallback_(CallbackId.ENTITLEMENTS, callback);\n  }\n\n  /**\n   * @param {!Promise<!../api/entitlements.Entitlements>} promise\n   */\n  triggerEntitlementsResponse(promise) {\n    return this.trigger_(\n      CallbackId.ENTITLEMENTS,\n      promise.then((res) => res.clone())\n    );\n  }\n\n  /**\n   * @return {boolean}\n   */\n  hasEntitlementsResponsePending() {\n    return !!this.resultBuffer_[CallbackId.ENTITLEMENTS];\n  }\n\n  /**\n   * @param {function(!../api/subscriptions.LoginRequest)} callback\n   */\n  setOnLoginRequest(callback) {\n    this.setCallback_(CallbackId.LOGIN_REQUEST, callback);\n  }\n\n  /**\n   * @param {!../api/subscriptions.LoginRequest} request\n   * @return {boolean} Whether the callback has been found.\n   */\n  triggerLoginRequest(request) {\n    return this.trigger_(CallbackId.LOGIN_REQUEST, request);\n  }\n\n  /**\n   * @param {function()} callback\n   */\n  setOnLinkProgress(callback) {\n    this.setCallback_(CallbackId.LINK_PROGRESS, callback);\n  }\n\n  /**\n   * @return {boolean} Whether the callback has been found.\n   */\n  triggerLinkProgress() {\n    return this.trigger_(CallbackId.LINK_PROGRESS, true);\n  }\n\n  /**\n   */\n  resetLinkProgress() {\n    this.resetCallback_(CallbackId.LINK_PROGRESS);\n  }\n\n  /**\n   * @param {function()} callback\n   */\n  setOnLinkComplete(callback) {\n    this.setCallback_(CallbackId.LINK_COMPLETE, callback);\n  }\n\n  /**\n   * @return {boolean} Whether the callback has been found.\n   */\n  triggerLinkComplete() {\n    return this.trigger_(CallbackId.LINK_COMPLETE, true);\n  }\n\n  /**\n   * @return {boolean}\n   */\n  hasLinkCompletePending() {\n    return !!this.resultBuffer_[CallbackId.LINK_COMPLETE];\n  }\n\n  /**\n   * @param {function()} callback\n   */\n  setOnSubscribeRequest(callback) {\n    this.setCallback_(CallbackId.SUBSCRIBE_REQUEST, callback);\n  }\n\n  /**\n   * @return {boolean} Whether the callback has been found.\n   */\n  triggerSubscribeRequest() {\n    return this.trigger_(CallbackId.SUBSCRIBE_REQUEST, true);\n  }\n\n  /**\n   * @return {boolean}\n   */\n  hasSubscribeRequestCallback() {\n    return !!this.callbacks_[CallbackId.SUBSCRIBE_REQUEST];\n  }\n\n  /**\n   * @param {function(!Promise<!../api/subscribe-response.SubscribeResponse>)} callback\n   */\n  setOnSubscribeResponse(callback) {\n    warn(\n      `[swg.js:setOnSubscribeResponse]: This method has been deprecated, please switch usages to 'setOnPaymentResponse'`\n    );\n    this.setCallback_(CallbackId.PAYMENT_RESPONSE, callback);\n  }\n\n  /**\n   * @param {function(!Promise<!../api/subscribe-response.SubscribeResponse>)} callback\n   */\n  setOnContributionResponse(callback) {\n    warn(\n      `[swg.js:setOnContributionResponse]: This method has been deprecated, please switch usages to 'setOnPaymentResponse'`\n    );\n    this.setCallback_(CallbackId.PAYMENT_RESPONSE, callback);\n  }\n\n  /**\n   * @param {function(!Promise<!../api/subscribe-response.SubscribeResponse>)} callback\n   */\n  setOnPaymentResponse(callback) {\n    this.setCallback_(CallbackId.PAYMENT_RESPONSE, callback);\n  }\n\n  /**\n   * @param {!Promise<!../api/subscribe-response.SubscribeResponse>} responsePromise\n   * @return {boolean} Whether the callback has been found.\n   */\n  triggerPaymentResponse(responsePromise) {\n    this.paymentResponsePromise_ = responsePromise.then(\n      (res) => {\n        this.trigger_(\n          CallbackId.PAYMENT_RESPONSE,\n          Promise.resolve(res.clone())\n        );\n      },\n      (reason) => {\n        if (isCancelError(reason)) {\n          return;\n        }\n        throw reason;\n      }\n    );\n    return !!this.callbacks_[CallbackId.PAYMENT_RESPONSE];\n  }\n\n  /**\n   * @return {boolean}\n   */\n  hasPaymentResponsePending() {\n    return !!this.resultBuffer_[CallbackId.PAYMENT_RESPONSE];\n  }\n\n  /**\n   * @param {function({flow: string, data: !Object})} callback\n   */\n  setOnFlowStarted(callback) {\n    this.setCallback_(CallbackId.FLOW_STARTED, callback);\n  }\n\n  /**\n   * @param {string} flow\n   * @param {!Object=} data\n   * @return {boolean} Whether the callback has been found.\n   */\n  triggerFlowStarted(flow, data = {}) {\n    return this.trigger_(CallbackId.FLOW_STARTED, {\n      flow,\n      data,\n    });\n  }\n\n  /**\n   * @param {function({flow: string, data: !Object})} callback\n   */\n  setOnFlowCanceled(callback) {\n    this.setCallback_(CallbackId.FLOW_CANCELED, callback);\n  }\n\n  /**\n   * @param {string} flow\n   * @param {!Object=} data\n   * @return {boolean} Whether the callback has been found.\n   */\n  triggerFlowCanceled(flow, data = {}) {\n    return this.trigger_(CallbackId.FLOW_CANCELED, {\n      flow,\n      data,\n    });\n  }\n\n  /**\n   * @param {!CallbackId} id\n   * @param {function(?)} callback\n   * @private\n   */\n  setCallback_(id, callback) {\n    if (this.callbacks_[id]) {\n      warn(\n        `[swg.js]: You have registered multiple callbacks for the same response.`\n      );\n    }\n    this.callbacks_[id] = callback;\n    // If result already exist, execute the callback right away.\n    if (id in this.resultBuffer_) {\n      this.executeCallback_(id, callback, this.resultBuffer_[id]);\n    }\n  }\n\n  /**\n   * @param {!CallbackId} id\n   * @param {*} data\n   * @return {boolean}\n   * @private\n   */\n  trigger_(id, data) {\n    this.resultBuffer_[id] = data;\n    const callback = this.callbacks_[id];\n    if (callback) {\n      this.executeCallback_(id, callback, data);\n    }\n    return !!callback;\n  }\n\n  /**\n   * @param {!CallbackId} id\n   * @private\n   */\n  resetCallback_(id) {\n    if (id in this.resultBuffer_) {\n      delete this.resultBuffer_[id];\n    }\n  }\n\n  /**\n   * @param {!CallbackId} id\n   * @param {function(*)} callback\n   * @param {*} data\n   * @private\n   */\n  executeCallback_(id, callback, data) {\n    // Always execute callbacks in a microtask.\n    Promise.resolve().then(() => {\n      callback(data);\n      this.resetCallback_(id);\n    });\n  }\n}\n\n/**\n * Copyright 2021 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Container for attribution details for the publisher / creator.\n */\nclass AttributionParams {\n  /**\n   * @param {string} displayName\n   * @param {string} avatarUrl\n   */\n  constructor(displayName, avatarUrl) {\n    /** @const {string} */\n    this.displayName = displayName;\n\n    /** @const {string} */\n    this.avatarUrl = avatarUrl;\n  }\n}\n\n/**\n * Copyright 2021 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Container for the auto prompt configuation details.\n */\nclass AutoPromptConfig {\n  /**\n   * @param {number|undefined} maxImpressionsPerWeek\n   */\n  constructor(\n    maxImpressionsPerWeek,\n    displayDelaySeconds,\n    backoffSeconds,\n    maxDismissalsPerWeek,\n    maxDismissalsResultingHideSeconds\n  ) {\n    /** @const {number|undefined} */\n    this.maxImpressionsPerWeek = maxImpressionsPerWeek;\n\n    /** @const {!ClientDisplayTrigger} */\n    this.clientDisplayTrigger = new ClientDisplayTrigger(displayDelaySeconds);\n\n    /** @const {!ExplicitDismissalConfig} */\n    this.explicitDismissalConfig = new ExplicitDismissalConfig(\n      backoffSeconds,\n      maxDismissalsPerWeek,\n      maxDismissalsResultingHideSeconds\n    );\n  }\n}\n\n/**\n * Client side conditions to trigger the display of the auto prompt.\n */\nclass ClientDisplayTrigger {\n  /**\n   * @param {number|undefined} displayDelaySeconds\n   */\n  constructor(displayDelaySeconds) {\n    /** @const {number|undefined} */\n    this.displayDelaySeconds = displayDelaySeconds;\n  }\n}\n\n/**\n * Configuration of explicit dismissal behavior and its effects.\n */\nclass ExplicitDismissalConfig {\n  /**\n   * @param {number|undefined} backoffSeconds\n   * @param {number|undefined} maxDismissalsPerWeek\n   * @param {number|undefined} maxDismissalsResultingHideSeconds\n   */\n  constructor(\n    backoffSeconds,\n    maxDismissalsPerWeek,\n    maxDismissalsResultingHideSeconds\n  ) {\n    /** @const {number|undefined} */\n    this.backoffSeconds = backoffSeconds;\n\n    /** @const {number|undefined} */\n    this.maxDismissalsPerWeek = maxDismissalsPerWeek;\n\n    /** @const {number|undefined} */\n    this.maxDismissalsResultingHideSeconds = maxDismissalsResultingHideSeconds;\n  }\n}\n\n/**\n * Predicates of whether or not to show button and prompt.\n */\nclass UiPredicates {\n  /**\n   * @param {boolean|undefined} canDisplayAutoPrompt\n   * @param {boolean|undefined} canDisplayButton\n   */\n  constructor(canDisplayAutoPrompt, canDisplayButton) {\n    /** @const {boolean|undefined} */\n    this.canDisplayAutoPrompt = canDisplayAutoPrompt;\n\n    /** @const {boolean|undefined} */\n    this.canDisplayButton = canDisplayButton;\n  }\n}\n\n/**\n * Copyright 2021 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Container for the details relating to how the client should be configured.\n */\nclass ClientConfig {\n  /**\n   * @param {ClientConfigOptions} options\n   */\n  constructor({\n    attributionParams,\n    autoPromptConfig,\n    paySwgVersion,\n    uiPredicates,\n    usePrefixedHostPath,\n    useUpdatedOfferFlows,\n  } = {}) {\n    /** @const {./auto-prompt-config.AutoPromptConfig|undefined} */\n    this.autoPromptConfig = autoPromptConfig;\n\n    /** @const {string|undefined} */\n    this.paySwgVersion = paySwgVersion;\n\n    /** @const {boolean} */\n    this.usePrefixedHostPath = usePrefixedHostPath || false;\n\n    /** @const {boolean} */\n    this.useUpdatedOfferFlows = useUpdatedOfferFlows || false;\n\n    /** @const {./auto-prompt-config.UiPredicates|undefined} */\n    this.uiPredicates = uiPredicates;\n\n    /** @const {./attribution-params.AttributionParams|undefined} */\n    this.attributionParams = attributionParams;\n  }\n}\n\n/**\n * Copyright 2020 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @enum {string} */\nconst ClientTheme = {\n  LIGHT: 'light',\n  DARK: 'dark',\n};\n\n/**\n * Copyright 2021 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Manager of how the client should be configured. Fetches and stores\n * configuration details from the server.\n */\nclass ClientConfigManager {\n  /**\n   * @param {string} publicationId\n   * @param {!./fetcher.Fetcher} fetcher\n   * @param {!../api/basic-subscriptions.ClientOptions=} clientOptions\n   */\n  constructor(publicationId, fetcher, clientOptions) {\n    /** @private @const {!../api/basic-subscriptions.ClientOptions} */\n    this.clientOptions_ = clientOptions || {};\n\n    /** @private @const {string} */\n    this.publicationId_ = publicationId;\n\n    /** @private @const {!./fetcher.Fetcher} */\n    this.fetcher_ = fetcher;\n\n    /** @private {?Promise<!ClientConfig>} */\n    this.responsePromise_ = null;\n  }\n\n  /**\n   * Fetches the client config from the server.\n   * @return {!Promise<!ClientConfig>}\n   */\n  fetchClientConfig() {\n    if (!this.publicationId_) {\n      throw new Error('fetchClientConfig requires publicationId');\n    }\n    if (!this.responsePromise_) {\n      this.responsePromise_ = this.fetch_();\n    }\n    return this.responsePromise_;\n  }\n\n  /**\n   * Gets the client config, if already requested. Otherwise returns a Promise\n   * with an empty ClientConfig.\n   * @return {!Promise<!ClientConfig>}\n   */\n  getClientConfig() {\n    return this.responsePromise_ || Promise.resolve(new ClientConfig());\n  }\n\n  /**\n   * Convenience method for retrieving the auto prompt portion of the client\n   * configuration.\n   * @return {!Promise<!../model/auto-prompt-config.AutoPromptConfig|undefined>}\n   */\n  getAutoPromptConfig() {\n    if (!this.responsePromise_) {\n      this.fetchClientConfig();\n    }\n    return this.responsePromise_.then(\n      (clientConfig) => clientConfig.autoPromptConfig\n    );\n  }\n\n  /**\n   * Gets the language the UI should be displayed in. See\n   * src/api/basic-subscriptions.ClientOptions.lang.\n   * @return {string}\n   */\n  getLanguage() {\n    return this.clientOptions_.lang || 'en';\n  }\n\n  /**\n   * Gets the theme the UI should be displayed in. See\n   * src/api/basic-subscriptions.ClientOptions.theme.\n   * @return {!../api/basic-subscriptions.ClientTheme}\n   */\n  getTheme() {\n    return this.clientOptions_.theme || ClientTheme.LIGHT;\n  }\n\n  /**\n   * Returns whether iframes should also use the language specified in the\n   * client options, rather than the default of letting the iframes decide the\n   * display language. Note that this will return false if the lang option is\n   * not set, even if forceLangInIframes was set.\n   * @return {boolean}\n   */\n  shouldForceLangInIframes() {\n    return (\n      !!this.clientOptions_.forceLangInIframes && !!this.clientOptions_.lang\n    );\n  }\n\n  /**\n   * Determines whether a subscription or contribution button should be disabled.\n   * @returns {!Promise<boolean|undefined>}\n   */\n  shouldEnableButton() {\n    // Disable button if disableButton is set to be true in clientOptions.\n    // If disableButton is set to be false or not set, then always enable button.\n    // This is for testing purpose.\n    if (this.clientOptions_.disableButton) {\n      return Promise.resolve(false);\n    }\n\n    if (!this.responsePromise_) {\n      this.fetchClientConfig();\n    }\n    // UI predicates decides whether to enable button.\n    return this.responsePromise_.then((clientConfig) => {\n      if (clientConfig.uiPredicates?.canDisplayButton) {\n        return true;\n      } else {\n        return false;\n      }\n    });\n  }\n\n  /**\n   * Fetches the client config from the server.\n   * @return {!Promise<!ClientConfig>}\n   */\n  fetch_() {\n    const url = serviceUrl(\n      '/publication/' +\n        encodeURIComponent(this.publicationId_) +\n        '/clientconfiguration'\n    );\n    return this.fetcher_.fetchCredentialedJson(url).then((json) => {\n      if (json.errorMessages && json.errorMessages.length > 0) {\n        json.errorMessages.forEach((errorMessage) => {\n          warn('SwG ClientConfigManager: ' + errorMessage);\n        });\n      }\n      return this.parseClientConfig_(json);\n    });\n  }\n\n  /**\n   * Parses the fetched config into the ClientConfig container object.\n   * @param {!Object} json\n   * @return {!ClientConfig}\n   */\n  parseClientConfig_(json) {\n    const paySwgVersion = json['paySwgVersion'];\n    const autoPromptConfigJson = json['autoPromptConfig'];\n    let autoPromptConfig = undefined;\n    if (autoPromptConfigJson) {\n      autoPromptConfig = new AutoPromptConfig(\n        autoPromptConfigJson.maxImpressionsPerWeek,\n        autoPromptConfigJson.clientDisplayTrigger?.displayDelaySeconds,\n        autoPromptConfigJson.explicitDismissalConfig?.backoffSeconds,\n        autoPromptConfigJson.explicitDismissalConfig?.maxDismissalsPerWeek,\n        autoPromptConfigJson.explicitDismissalConfig?.maxDismissalsResultingHideSeconds\n      );\n    }\n\n    const uiPredicatesJson = json['uiPredicates'];\n    let uiPredicates = undefined;\n    if (uiPredicatesJson) {\n      uiPredicates = new UiPredicates(\n        uiPredicatesJson.canDisplayAutoPrompt,\n        uiPredicatesJson.canDisplayButton\n      );\n    }\n\n    const attributionParamsJson = json['attributionParams'];\n    let attributionParams;\n    if (attributionParamsJson) {\n      attributionParams = new AttributionParams(\n        attributionParamsJson.displayName,\n        attributionParamsJson.avatarUrl\n      );\n    }\n\n    return new ClientConfig({\n      autoPromptConfig,\n      paySwgVersion,\n      usePrefixedHostPath: json['usePrefixedHostPath'],\n      useUpdatedOfferFlows: json['useUpdatedOfferFlows'],\n      uiPredicates,\n      attributionParams,\n    });\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * The class for Contributions flow.\n */\nclass ContributionsFlow {\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {!../api/subscriptions.OffersRequest|undefined} options\n   */\n  constructor(deps, options) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!../api/subscriptions.OffersRequest|undefined} */\n    this.options_ = options;\n\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!./client-config-manager.ClientConfigManager} */\n    this.clientConfigManager_ = deps.clientConfigManager();\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    this.activityIframeView_ = null;\n\n    // Default to showing close button.\n    const isClosable = options?.isClosable ?? true;\n\n    /** @private @const {!Promise<!ActivityIframeView>} */\n    this.activityIframeViewPromise_ = this.clientConfigManager_\n      .getClientConfig()\n      .then((clientConfig) => {\n        return this.shouldShow_(clientConfig)\n          ? new ActivityIframeView(\n              this.win_,\n              this.activityPorts_,\n              this.getUrl_(clientConfig),\n              feArgs({\n                'productId': deps.pageConfig().getProductId(),\n                'publicationId': deps.pageConfig().getPublicationId(),\n                'productType': ProductType.UI_CONTRIBUTION,\n                'list': (options && options.list) || 'default',\n                'skus': (options && options.skus) || null,\n                'isClosable': isClosable,\n                'supportsEventManager': true,\n              }),\n              /* shouldFadeBody */ true\n            )\n          : null;\n      });\n  }\n\n  /**\n   * @param {AlreadySubscribedResponse} response\n   */\n  handleLinkRequest_(response) {\n    if (response.getSubscriberOrMember()) {\n      this.deps_.callbacks().triggerLoginRequest({\n        linkRequested: !!response.getLinkRequested(),\n      });\n    }\n  }\n\n  /**\n   * @param {SkuSelectedResponse} response\n   */\n  startPayFlow_(response) {\n    const sku = response.getSku();\n    const isOneTime = response.getOneTime();\n    if (sku) {\n      const /** @type {../api/subscriptions.SubscriptionRequest} */ contributionRequest =\n          {\n            'skuId': sku,\n          };\n      if (isOneTime) {\n        contributionRequest['oneTime'] = isOneTime;\n      }\n      new PayStartFlow(\n        this.deps_,\n        contributionRequest,\n        ProductType.UI_CONTRIBUTION\n      ).start();\n    }\n  }\n\n  /**\n   * Starts the contributions flow or alreadyMember flow.\n   * @return {!Promise}\n   */\n  start() {\n    return this.activityIframeViewPromise_.then((activityIframeView) => {\n      if (!activityIframeView) {\n        return Promise.resolve();\n      }\n\n      // Start/cancel events.\n      this.deps_\n        .callbacks()\n        .triggerFlowStarted(SubscriptionFlows.SHOW_CONTRIBUTION_OPTIONS);\n      activityIframeView.onCancel(() => {\n        this.deps_\n          .callbacks()\n          .triggerFlowCanceled(SubscriptionFlows.SHOW_CONTRIBUTION_OPTIONS);\n      });\n      activityIframeView.on(\n        AlreadySubscribedResponse,\n        this.handleLinkRequest_.bind(this)\n      );\n      activityIframeView.on(SkuSelectedResponse, this.startPayFlow_.bind(this));\n      this.activityIframeView_ = activityIframeView;\n      return this.dialogManager_.openView(this.activityIframeView_);\n    });\n  }\n\n  /**\n   * Returns whether this flow is configured as enabled, not showing\n   * even on explicit start when flag is configured false.\n   *\n   * @param {!../model/client-config.ClientConfig} clientConfig\n   * @return {boolean}\n   */\n  shouldShow_(clientConfig) {\n    return clientConfig.uiPredicates?.canDisplayAutoPrompt !== false;\n  }\n\n  /**\n   * Gets the complete URL that should be used for the activity iFrame view.\n   * @param {!../model/client-config.ClientConfig} clientConfig\n   * @return {string}\n   */\n  getUrl_(clientConfig) {\n    if (!clientConfig.useUpdatedOfferFlows) {\n      return feUrl('/contributionsiframe');\n    }\n\n    if (this.clientConfigManager_.shouldForceLangInIframes()) {\n      return feUrl('/contributionoffersiframe', {\n        'hl': this.clientConfigManager_.getLanguage(),\n      });\n    }\n\n    return feUrl('/contributionoffersiframe');\n  }\n\n  /**\n   * Shows \"no contribution found\" on activity iFrame view.\n   */\n  showNoEntitlementFoundToast() {\n    if (this.activityIframeView_) {\n      this.activityIframeView_.execute(new EntitlementsResponse());\n    }\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * The flow to initiate deferred account process.\n * See `Subscriptions.completeDeferredAccountCreation` API.\n */\nclass DeferredAccountFlow {\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {?../api/deferred-account-creation.DeferredAccountCreationRequest} options\n   */\n  constructor(deps, options) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    /** @private {?ActivityIframeView} */\n    this.activityIframeView_ = null;\n\n    /** @private {?Promise} */\n    this.openPromise_ = null;\n\n    /** @type {!../api/deferred-account-creation.DeferredAccountCreationRequest} */\n    const defaultOptions = {\n      entitlements: null,\n      consent: true,\n    };\n    /** @private @const {!../api/deferred-account-creation.DeferredAccountCreationRequest} */\n    this.options_ = Object.assign(defaultOptions, options || {});\n  }\n\n  /**\n   * Starts the deferred account flow.\n   * @return {!Promise<!DeferredAccountCreationResponse>}\n   */\n  start() {\n    const entitlements = this.options_.entitlements;\n\n    // For now, entitlements are required to be present and have the Google\n    // token. This is strictly not required for the implementation. But it's\n    // preferrable API-wise at this time.\n    if (!entitlements || !entitlements.getEntitlementForSource('google')) {\n      throw new Error('No entitlements with \"google\" source');\n    }\n\n    // Start/cancel events.\n    this.deps_\n      .callbacks()\n      .triggerFlowStarted(SubscriptionFlows.COMPLETE_DEFERRED_ACCOUNT_CREATION);\n\n    this.activityIframeView_ = new ActivityIframeView(\n      this.win_,\n      this.activityPorts_,\n      feUrl('/recoveriframe'),\n      feArgs({\n        'publicationId': this.deps_.pageConfig().getPublicationId(),\n        'productId': this.deps_.pageConfig().getProductId(),\n        'entitlements': (entitlements && entitlements.raw) || null,\n        'consent': this.options_.consent,\n      }),\n      /* shouldFadeBody */ true\n    );\n\n    this.openPromise_ = this.dialogManager_.openView(this.activityIframeView_);\n    return this.activityIframeView_.acceptResult().then(\n      (result) => {\n        // The consent part is complete.\n        return this.handleConsentResponse_(\n          /** @type {!Object} */ (result.data)\n        );\n      },\n      (reason) => {\n        if (isCancelError(reason)) {\n          this.deps_\n            .callbacks()\n            .triggerFlowCanceled(\n              SubscriptionFlows.COMPLETE_DEFERRED_ACCOUNT_CREATION\n            );\n        } else {\n          this.dialogManager_.completeView(this.activityIframeView_);\n        }\n        throw reason;\n      }\n    );\n  }\n\n  /**\n   * @param {!Object} data\n   * @return {!DeferredAccountCreationResponse}\n   * @private\n   */\n  handleConsentResponse_(data) {\n    this.deps_.entitlementsManager().blockNextNotification();\n\n    // Parse the response.\n    const entitlementsJwt = data['entitlements'];\n    const idToken = data['idToken'];\n    const productType = data['productType'];\n    const entitlements = this.deps_\n      .entitlementsManager()\n      .parseEntitlements({'signedEntitlements': entitlementsJwt});\n    const userData = new UserData(\n      idToken,\n      /** @type {!Object} */ (new JwtHelper().decode(idToken))\n    );\n    const purchaseDataList = data['purchaseDataList']\n      ? data['purchaseDataList'].map(\n          (pd) => new PurchaseData(pd['data'], pd['signature'])\n        )\n      : [\n          // TODO(dvoytenko): cleanup/deprecate.\n          new PurchaseData(\n            data['purchaseData']['data'],\n            data['purchaseData']['signature']\n          ),\n        ];\n\n    // For now, we'll use the `PayCompleteFlow` as a \"creating account\" flow.\n    // But this can be eventually implemented by the same iframe.\n    const creatingFlow = new PayCompleteFlow(this.deps_);\n    const completeHandler = creatingFlow.complete.bind(creatingFlow);\n\n    const response = new DeferredAccountCreationResponse(\n      entitlements,\n      userData,\n      purchaseDataList,\n      completeHandler\n    );\n\n    this.deps_\n      .eventManager()\n      .logSwgEvent(AnalyticsEvent.ACTION_NEW_DEFERRED_ACCOUNT, true);\n\n    // Start the \"sync\" flow.\n    creatingFlow.start(\n      new SubscribeResponse(\n        '', // raw field doesn't matter in this case\n        purchaseDataList[0],\n        userData,\n        entitlements,\n        productType,\n        () => Promise.resolve() // completeHandler doesn't matter in this case\n      )\n    );\n    return response;\n  }\n}\n\nconst CSS$1 = \"body{margin:0;padding:0}swg-container,swg-loading,swg-loading-animate,swg-loading-image{display:block}swg-loading-container{-ms-flex-align:center!important;-ms-flex-pack:center!important;align-items:center!important;bottom:0!important;display:-ms-flexbox!important;display:flex!important;height:100%!important;justify-content:center!important;margin-top:5px!important;min-height:148px!important;width:100%!important;z-index:2147483647!important}@media (min-height:630px),(min-width:630px){swg-loading-container{background-color:#fff!important;border-top-left-radius:8px!important;border-top-right-radius:8px!important;box-shadow:0 1px 1px rgba(60,64,67,.3),0 1px 4px 1px rgba(60,64,67,.15)!important;margin-left:auto!important;margin-right:auto!important;width:560px!important}swg-loading-container.centered-on-desktop{border-radius:8px!important;height:120px!important;min-height:120px!important}}swg-loading{animation:mspin-rotate 1568.63ms linear infinite;height:36px;overflow:hidden;width:36px;z-index:2147483647!important}swg-loading-animate{animation:mspin-revrot 5332ms steps(4) infinite}swg-loading-image{animation:swg-loading-film 5332ms steps(324) infinite;background-image:url(https://news.google.com/swg/js/v1/loader.svg);background-size:100%;height:36px;width:11664px}@keyframes swg-loading-film{0%{transform:translateX(0)}to{transform:translateX(-11664px)}}@keyframes mspin-rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}@keyframes mspin-revrot{0%{transform:rotate(0deg)}to{transform:rotate(-1turn)}}\\n/*# sourceURL=/./src/ui/ui.css*/\";\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {!Object<string|number>} */\nconst friendlyIframeAttributes = {\n  'frameborder': 0,\n  'scrolling': 'no',\n  'src': 'about:blank',\n};\n\n/**\n * The class for building friendly iframe.\n */\nclass FriendlyIframe {\n  /**\n   * @param {!Document} doc\n   * @param {!Object<string, string|number>=} attrs\n   */\n  constructor(doc, attrs = {}) {\n    const mergedAttrs = Object.assign({}, friendlyIframeAttributes, attrs);\n\n    /** @private @const {!HTMLIFrameElement} */\n    this.iframe_ = /** @type {!HTMLIFrameElement} */ (\n      createElement(doc, 'iframe', mergedAttrs)\n    );\n\n    // Ensure that the new iframe does not inherit any CSS styles.\n    resetAllStyles(this.iframe_);\n\n    /** @private @const {!Promise} */\n    this.ready_ = new Promise((resolve) => {\n      this.iframe_.onload = resolve;\n    });\n  }\n\n  /**\n   * When promise is resolved.\n   * @return {!Promise}\n   */\n  whenReady() {\n    return this.ready_;\n  }\n\n  /**\n   * Gets the iframe element.\n   * @return {!HTMLIFrameElement}\n   */\n  getElement() {\n    return this.iframe_;\n  }\n\n  /**\n   * Gets the document object of the iframe element.\n   * @return {!Document}\n   */\n  getDocument() {\n    const doc =\n      this.getElement().contentDocument ||\n      (this.getElement().contentWindow &&\n        this.getElement().contentWindow.document);\n\n    if (!doc) {\n      throw new Error('not loaded');\n    }\n    return doc;\n  }\n\n  /**\n   * Gets the body of the iframe.\n   * @return {!Element}\n   */\n  getBody() {\n    return /** @type {!Element} */ (this.getDocument().body);\n  }\n\n  /**\n   * Whether the iframe is connected.\n   * @return {boolean}\n   */\n  isConnected() {\n    return isConnected(this.getElement());\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns a promise which is resolved after the given duration of animation\n * @param {!Element} el - Element to be observed.\n * @param {!Object<string, string|number>} props - properties to be animated.\n * @param {number} durationMillis - duration of animation.\n * @param {string} curve - transition function for the animation.\n * @return {!Promise} Promise which resolves once the animation is done playing.\n */\nfunction transition$1(el, props, durationMillis, curve) {\n  const win = el.ownerDocument.defaultView;\n  const previousTransitionValue = el.style.transition || '';\n  return new Promise((resolve) => {\n    win.setTimeout(() => {\n      win.setTimeout(resolve, durationMillis);\n      const tr = `${durationMillis}ms ${curve}`;\n      setImportantStyles$1(\n        el,\n        Object.assign(\n          {\n            'transition': `transform ${tr}, opacity ${tr}`,\n          },\n          props\n        )\n      );\n    });\n  }).then(() => {\n    setImportantStyles$1(el, {\n      'transition': previousTransitionValue,\n    });\n  });\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nclass Graypane$1 {\n  /**\n   * @param {!../model/doc.Doc} doc\n   * @param {number} zIndex\n   */\n  constructor(doc, zIndex) {\n    /** @private @const {!../model/doc.Doc} */\n    this.doc_ = doc;\n\n    /** @private @const {!Element} */\n    this.fadeBackground_ = this.doc_\n      .getWin()\n      .document.createElement('swg-popup-background');\n    setImportantStyles$1(this.fadeBackground_, {\n      'z-index': zIndex,\n      'display': 'none',\n      'pointer-events': 'none',\n      'position': 'fixed',\n      'top': 0,\n      'right': 0,\n      'bottom': 0,\n      'left': 0,\n      'background-color': 'rgba(32, 33, 36, .6)',\n    });\n  }\n\n  /**\n   * @return {!Element}\n   */\n  getElement() {\n    return this.fadeBackground_;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isAttached() {\n    return !!this.fadeBackground_.parentNode;\n  }\n\n  /**\n   * Attaches the graypane to the document.\n   */\n  attach() {\n    this.doc_.getBody().appendChild(this.fadeBackground_);\n  }\n\n  /**\n   * Detaches the graypane to the document.\n   */\n  destroy() {\n    this.doc_.getBody().removeChild(this.fadeBackground_);\n  }\n\n  /**\n   * Shows the graypane.\n   * @param {boolean=} animated\n   * @return {!Promise|undefined}\n   */\n  show(animated = true) {\n    setImportantStyles$1(this.fadeBackground_, {\n      'display': 'block',\n      'opacity': animated ? 0 : 1,\n    });\n    if (animated) {\n      return transition$1(\n        this.fadeBackground_,\n        {\n          'opacity': 1,\n        },\n        300,\n        'ease-out'\n      );\n    }\n  }\n\n  /**\n   * Hides the graypane.\n   * @param {boolean=} animated\n   * @return {!Promise|undefined}\n   */\n  hide(animated = true) {\n    if (animated) {\n      return transition$1(\n        this.fadeBackground_,\n        {\n          'opacity': 0,\n        },\n        300,\n        'ease-out'\n      ).then(() => {\n        setImportantStyles$1(this.fadeBackground_, {'display': 'none'});\n      });\n    }\n    setImportantStyles$1(this.fadeBackground_, {'display': 'none'});\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Loading indicator class. Builds the loading indicator view to be injected in\n * parent element <iframe class=\"swg-dialog\"> element. Provides methods to\n * show/hide loading indicator.\n */\nclass LoadingView {\n  /**\n   * @param {!Document} doc\n   * @param {!LoadingViewConfig=} config\n   */\n  constructor(doc, config = {}) {\n    /** @private @const {!Document} */\n    this.doc_ = doc;\n\n    /** @private @const {!Element} */\n    this.loadingContainer_ = createElement(\n      this.doc_,\n      'swg-loading-container',\n      {}\n    );\n    if (config.additionalClasses) {\n      config.additionalClasses.forEach((additionalClass) => {\n        this.loadingContainer_.classList.add(additionalClass);\n      });\n    }\n\n    /** @private @const {!Element} */\n    this.loading_ = createElement(this.doc_, 'swg-loading', {});\n    this.loadingContainer_.appendChild(this.loading_);\n\n    this.loadingContainer_.style.setProperty('display', 'none', 'important');\n\n    // Build the animated loading indicator.\n    this.buildLoadingIndicator_();\n  }\n\n  /**\n   * Gets the populated loading container.\n   * @return {!Element}\n   */\n  getElement() {\n    return this.loadingContainer_;\n  }\n\n  /**\n   * Shows the loading indicator within the container element.\n   */\n  show() {\n    this.loadingContainer_.style.removeProperty('display');\n  }\n\n  /**\n   * Hides the loading indicator within the container element.\n   */\n  hide() {\n    this.loadingContainer_.style.setProperty('display', 'none', 'important');\n  }\n\n  /**\n   * Populates the loading indivicator. The populated element\n   * can be added in any view, when required.\n   * @private\n   */\n  buildLoadingIndicator_() {\n    const loadingContainer = this.loading_;\n\n    const loadingIndicatorTopContainer = createElement(\n      this.doc_,\n      'swg-loading-animate',\n      {}\n    );\n    loadingContainer.appendChild(loadingIndicatorTopContainer);\n\n    const loadingIndicatorChildContainer = createElement(\n      this.doc_,\n      'swg-loading-image',\n      {}\n    );\n    loadingIndicatorTopContainer.appendChild(loadingIndicatorChildContainer);\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {!Document} doc\n * @return {string}\n */\nfunction getReadyState(doc) {\n  return /** @type {string} */ (doc['readyState']);\n}\n\n/**\n * Whether the document is ready.\n * @param {!Document} doc\n * @return {boolean}\n */\nfunction isDocumentReady(doc) {\n  const readyState = getReadyState(doc);\n  return readyState != 'loading' && readyState != 'uninitialized';\n}\n\n/**\n * Calls the callback when document is ready.\n * @param {!Document} doc\n * @param {function(!Document)} callback\n */\nfunction onDocumentReady(doc, callback) {\n  onDocumentState(doc, isDocumentReady, callback);\n}\n\n/**\n * Calls the callback once when document's state satisfies the condition.\n * @param {!Document} doc\n * @param {function(!Document):boolean} condition\n * @param {function(!Document)} callback\n */\nfunction onDocumentState(doc, condition, callback) {\n  if (condition(doc)) {\n    // Execute callback right now.\n    callback(doc);\n    return;\n  }\n\n  // Execute callback (once!) after condition is satisfied.\n  let callbackHasExecuted = false;\n  const readyListener = () => {\n    if (condition(doc) && !callbackHasExecuted) {\n      callback(doc);\n      callbackHasExecuted = true;\n      doc.removeEventListener('readystatechange', readyListener);\n    }\n  };\n  doc.addEventListener('readystatechange', readyListener);\n}\n\n/**\n * Returns a promise that is resolved when document is ready.\n * @param {!Document} doc\n * @return {!Promise<!Document>}\n */\nfunction whenDocumentReady(doc) {\n  return new Promise((resolve) => {\n    onDocumentReady(doc, resolve);\n  });\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @implements {Doc} */\nclass GlobalDoc {\n  /**\n   * @param {!Window|!Document} winOrDoc\n   */\n  constructor(winOrDoc) {\n    const isWin = !!winOrDoc.document;\n    /** @private @const {!Window} */\n    this.win_ = /** @type {!Window} */ (\n      isWin\n        ? /** @type {!Window} */ (winOrDoc)\n        : /** @type {!Document} */ (winOrDoc).defaultView\n    );\n    /** @private @const {!Document} */\n    this.doc_ = isWin\n      ? /** @type {!Window} */ (winOrDoc).document\n      : /** @type {!Document} */ (winOrDoc);\n  }\n\n  /** @override */\n  getWin() {\n    return this.win_;\n  }\n\n  /** @override */\n  getRootNode() {\n    return this.doc_;\n  }\n\n  /** @override */\n  getRootElement() {\n    return this.doc_.documentElement;\n  }\n\n  /** @override */\n  getHead() {\n    // `document.head` always has a chance to be parsed, at least partially.\n    return /** @type {!Element} */ (this.doc_.head);\n  }\n\n  /** @override */\n  getBody() {\n    return this.doc_.body;\n  }\n\n  /** @override */\n  isReady() {\n    return isDocumentReady(this.doc_);\n  }\n\n  /** @override */\n  whenReady() {\n    return whenDocumentReady(this.doc_);\n  }\n\n  /** @override */\n  addToFixedLayer(unusedElement) {\n    return Promise.resolve();\n  }\n}\n\n/**\n * @param {!Document|!Window|!Doc} input\n * @return {!Doc}\n */\nfunction resolveDoc(input) {\n  // Is it a `Document`\n  if (/** @type {!Document} */ (input).nodeType === /* DOCUMENT */ 9) {\n    return new GlobalDoc(/** @type {!Document} */ (input));\n  }\n  // Is it a `Window`?\n  if (/** @type {!Window} */ (input).document) {\n    return new GlobalDoc(/** @type {!Window} */ (input));\n  }\n  return /** @type {!Doc} */ (input);\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst Z_INDEX = 2147483647;\n\n/**\n * Default iframe important styles.\n * Note: The iframe responsiveness media query style is injected in the\n * publisher's page since style attribute can not include media query.\n * @const {!Object<string, string|number>}\n */\nconst rootElementImportantStyles = {\n  'min-height': '50px',\n  'border': 'none',\n  'display': 'block',\n  'position': 'fixed',\n  'z-index': Z_INDEX,\n  'box-sizing': 'border-box',\n};\n\n/**\n * Reset view styles.\n * @const {!Object<string, string|number>}\n */\nconst resetViewStyles = {\n  'position': 'absolute',\n  'top': '0',\n  'left': '0',\n  'right': '0',\n  'bottom': '0',\n  'opacity': 0,\n  /* These lines are a work around to this issue in iOS:     */\n  /* https://bugs.webkit.org/show_bug.cgi?id=155198          */\n  'height': 0,\n  'max-height': '100%',\n  'max-width': '100%',\n  'min-height': '100%',\n  'min-width': '100%',\n  'width': 0,\n};\n\n/**\n * The class for the top level dialog.\n * @final\n */\nclass Dialog {\n  /**\n   * Create a dialog for the provided doc.\n   * @param {!../model/doc.Doc} doc\n   * @param {!Object<string, string|number>=} importantStyles\n   * @param {!Object<string, string|number>=} styles\n   * @param {!DialogConfig=} dialogConfig Configuration options for the dialog.\n   */\n  constructor(doc, importantStyles = {}, styles = {}, dialogConfig = {}) {\n    /** @private @const {!../model/doc.Doc} */\n    this.doc_ = doc;\n\n    const desktopDialogConfig = dialogConfig.desktopConfig || {};\n    const supportsWideScreen = !!desktopDialogConfig.supportsWideScreen;\n\n    const defaultIframeCssClass = `swg-dialog ${\n      supportsWideScreen ? 'swg-wide-dialog' : ''\n    }`;\n    const iframeCssClass =\n      dialogConfig.iframeCssClassOverride || defaultIframeCssClass;\n\n    /** @private @const {!FriendlyIframe} */\n    this.iframe_ = new FriendlyIframe(doc.getWin().document, {\n      'class': iframeCssClass,\n    });\n\n    /** @private @const {!Graypane} */\n    this.graypane_ = new Graypane$1(doc, Z_INDEX - 1);\n\n    const modifiedImportantStyles = Object.assign(\n      {},\n      rootElementImportantStyles,\n      importantStyles\n    );\n    setImportantStyles$1(this.iframe_.getElement(), modifiedImportantStyles);\n\n    setStyles(this.iframe_.getElement(), styles);\n\n    /** @private {LoadingView} */\n    this.loadingView_ = null;\n\n    /** @private {?Element} */\n    this.container_ = null; // Depends on constructed document inside iframe.\n\n    /** @private {?./view.View} */\n    this.view_ = null;\n\n    /** @private {?Promise} */\n    this.animating_ = null;\n\n    /**\n     * Helps identify stale animations.\n     * @private {number}\n     */\n    this.animationNumber_ = 0;\n\n    /** @private {boolean} */\n    this.hidden_ = false;\n\n    /** @private {?./view.View} */\n    this.previousProgressView_ = null;\n\n    /** @const @private {number} */\n    this.maxAllowedHeightRatio_ =\n      dialogConfig.maxAllowedHeightRatio !== undefined\n        ? dialogConfig.maxAllowedHeightRatio\n        : 0.9;\n\n    /** @const @private {boolean} */\n    this.positionCenterOnDesktop_ = !!desktopDialogConfig.isCenterPositioned;\n\n    /** @const @private {!MediaQueryList} */\n    this.desktopMediaQuery_ = this.doc_\n      .getWin()\n      .matchMedia('(min-width: 641px)');\n\n    /**\n     * Reference to the listener that acts on changes to desktopMediaQuery.\n     * @private {?function()}\n     */\n    this.desktopMediaQueryListener_ = null;\n  }\n\n  /**\n   * Opens the dialog and builds the iframe container.\n   * @param {boolean=} hidden\n   * @return {!Promise<!Dialog>}\n   */\n  open(hidden = false) {\n    const iframe = this.iframe_;\n    if (iframe.isConnected()) {\n      throw new Error('already opened');\n    }\n\n    // Attach.\n    this.doc_.getBody().appendChild(iframe.getElement()); // Fires onload.\n\n    this.graypane_.attach();\n\n    if (hidden) {\n      setImportantStyles$1(iframe.getElement(), {\n        'visibility': 'hidden',\n        'opacity': 0,\n      });\n      this.hidden_ = hidden;\n    } else {\n      this.show_();\n    }\n\n    return iframe.whenReady().then(() => {\n      this.buildIframe_();\n      return this;\n    });\n  }\n\n  /**\n   * Opens the iframe embedded in the given container element.\n   * @param {!Element} containerEl\n   */\n  openInContainer(containerEl) {\n    const iframe = this.iframe_;\n    if (iframe.isConnected()) {\n      throw new Error('already opened');\n    }\n\n    containerEl.appendChild(iframe.getElement());\n\n    return iframe.whenReady().then(() => {\n      this.buildIframe_();\n      return this;\n    });\n  }\n\n  /**\n   * Build the iframe with the styling after iframe is loaded.\n   * @private\n   */\n  buildIframe_() {\n    const iframe = this.iframe_;\n    const iframeBody = iframe.getBody();\n    const iframeDoc = /** @type {!HTMLDocument} */ (this.iframe_.getDocument());\n\n    // Inject Google fonts in <HEAD> section of the iframe.\n    injectStyleSheet(resolveDoc(iframeDoc), CSS$1);\n\n    // Add Loading indicator.\n    const loadingViewClasses = [];\n    if (this.isPositionCenterOnDesktop()) {\n      loadingViewClasses.push('centered-on-desktop');\n    }\n    this.loadingView_ = new LoadingView(iframeDoc, {\n      additionalClasses: loadingViewClasses,\n    });\n    iframeBody.appendChild(this.loadingView_.getElement());\n\n    // Container for all dynamic content, including 3P iframe.\n    this.container_ = createElement(iframeDoc, 'swg-container', {});\n    iframeBody.appendChild(this.container_);\n    this.setPosition_();\n\n    // Add listener to adjust position when crossing a media query breakpoint.\n    if (this.positionCenterOnDesktop_) {\n      this.desktopMediaQueryListener_ = () => {\n        this.setPosition_();\n      };\n      this.desktopMediaQuery_.addListener(this.desktopMediaQueryListener_);\n    }\n  }\n\n  /**\n   * Closes the dialog.\n   * @param {boolean=} animated\n   * @return {!Promise}\n   */\n  close(animated = true) {\n    let animating;\n    if (animated) {\n      animating = this.animate_(() => {\n        this.graypane_.hide(/* animate */ true);\n        return transition$1(\n          this.getElement(),\n          {\n            'transform': 'translateY(100%)',\n          },\n          300,\n          'ease-out'\n        );\n      });\n    } else {\n      animating = Promise.resolve();\n    }\n    return animating.then(() => {\n      const iframeEl = this.iframe_.getElement();\n      iframeEl.parentNode.removeChild(iframeEl);\n\n      this.removePaddingToHtml_();\n      this.graypane_.destroy();\n      if (this.desktopMediaQueryListener_) {\n        this.desktopMediaQuery_.removeListener(this.desktopMediaQueryListener_);\n      }\n    });\n  }\n\n  /**\n   * Gets the container within the dialog.\n   * @return {!Element}\n   */\n  getContainer() {\n    if (!this.container_) {\n      throw new Error('not opened yet');\n    }\n    return this.container_;\n  }\n\n  /**\n   * Gets the attached iframe instance.\n   * @return {!FriendlyIframe}\n   */\n  getIframe() {\n    return this.iframe_;\n  }\n\n  /**\n   * Gets the Iframe element.\n   * @return {!HTMLIFrameElement}\n   */\n  getElement() {\n    return this.iframe_.getElement();\n  }\n\n  /**\n   * Gets the LoadingView for this dialog.\n   * @return {LoadingView}\n   */\n  getLoadingView() {\n    return this.loadingView_;\n  }\n\n  /**\n   * Returns the max allowed height of the view as a ratio of viewport height.\n   * @return {number}\n   */\n  getMaxAllowedHeightRatio() {\n    return this.maxAllowedHeightRatio_;\n  }\n\n  /**\n   * Returns whether the dialog is center-positioned on desktop screens.\n   * @return {boolean}\n   */\n  isPositionCenterOnDesktop() {\n    return this.positionCenterOnDesktop_;\n  }\n\n  /**\n   * Transitions to the next view.\n   * @private\n   */\n  entryTransitionToNextView_() {\n    if (this.view_ && this.view_.hasLoadingIndicator()) {\n      // Temporarily cache the old view.\n      this.previousProgressView_ = this.view_;\n    } else {\n      // Since loading indicator will be shown, remove contents of old view.\n      removeChildren(this.getContainer());\n      // When loading indicator was not displayed in the previous view,\n      // loading indicator must be displayed while transitioning to new view.\n      this.loadingView_.show();\n    }\n  }\n\n  /**\n   * Transition out of an old view.\n   * @private\n   */\n  exitTransitionFromOldView_() {\n    // If previous view is still around, remove it.\n    if (this.previousProgressView_) {\n      removeElement(this.previousProgressView_.getElement());\n      this.previousProgressView_ = null;\n    } else {\n      this.loadingView_.hide();\n    }\n  }\n\n  /** @return {?./view.View} */\n  getCurrentView() {\n    return this.view_;\n  }\n\n  /**\n   * Opens the given view and removes existing view from the DOM if any.\n   * @param {!./view.View} view\n   * @return {!Promise}\n   */\n  openView(view) {\n    setImportantStyles$1(view.getElement(), resetViewStyles);\n    this.entryTransitionToNextView_();\n\n    this.view_ = view;\n    this.getContainer().appendChild(view.getElement());\n\n    // If the current view should fade the parent document.\n    if (view.shouldFadeBody() && !this.hidden_) {\n      this.graypane_.show(/* animate */ true);\n    }\n\n    return view.init(this).then(() => {\n      setImportantStyles$1(view.getElement(), {\n        'opacity': 1,\n      });\n      if (this.hidden_) {\n        if (view.shouldFadeBody()) {\n          this.graypane_.show(/* animated */ true);\n        }\n        this.show_();\n      }\n      this.exitTransitionFromOldView_();\n    });\n  }\n\n  /**\n   * Show the iframe.\n   * @private\n   */\n  show_() {\n    this.animate_(() => {\n      setImportantStyles$1(this.getElement(), {\n        'transform': 'translateY(100%)',\n        'opactiy': 1,\n        'visibility': 'visible',\n      });\n      return transition$1(\n        this.getElement(),\n        {\n          'transform': this.getDefaultTranslateY_(),\n          'opacity': 1,\n          'visibility': 'visible',\n        },\n        300,\n        'ease-out'\n      );\n    });\n    this.hidden_ = false;\n  }\n\n  /**\n   * Resizes the dialog container.\n   * @param {!./view.View} view\n   * @param {number} height\n   * @param {boolean=} animated\n   * @return {?Promise}\n   */\n  resizeView(view, height, animated = true) {\n    if (this.view_ != view) {\n      return null;\n    }\n    const newHeight = this.getMaxAllowedHeight_(height);\n\n    // Uniquely identify this animation.\n    // This lets callbacks abandon stale animations.\n    const animationNumber = ++this.animationNumber_;\n    const isStale = () => {\n      return animationNumber !== this.animationNumber_;\n    };\n\n    let animating;\n    if (animated) {\n      const oldHeight = this.getElement().offsetHeight;\n      if (newHeight >= oldHeight) {\n        // Expand.\n        animating = this.animate_(() => {\n          if (isStale()) {\n            return Promise.resolve();\n          }\n\n          setImportantStyles$1(this.getElement(), {\n            'height': `${newHeight}px`,\n            'transform': `translateY(${newHeight - oldHeight}px)`,\n          });\n          return transition$1(\n            this.getElement(),\n            {\n              'transform': this.getDefaultTranslateY_(),\n            },\n            300,\n            'ease-out'\n          );\n        });\n      } else {\n        // Collapse.\n        animating = this.animate_(() => {\n          const transitionPromise = isStale()\n            ? Promise.resolve()\n            : transition$1(\n                this.getElement(),\n                {\n                  'transform': `translateY(${oldHeight - newHeight}px)`,\n                },\n                300,\n                'ease-out'\n              );\n          return transitionPromise.then(() => {\n            if (isStale()) {\n              return;\n            }\n\n            setImportantStyles$1(this.getElement(), {\n              'height': `${newHeight}px`,\n              'transform': this.getDefaultTranslateY_(),\n            });\n          });\n        });\n      }\n    } else {\n      setImportantStyles$1(this.getElement(), {\n        'height': `${newHeight}px`,\n      });\n      animating = Promise.resolve();\n    }\n    return animating.then(() => {\n      if (isStale()) {\n        return;\n      }\n\n      this.updatePaddingToHtml_(height);\n      view.resized();\n    });\n  }\n\n  /**\n   * @param {function():!Promise} callback\n   * @return {!Promise}\n   * @private\n   */\n  animate_(callback) {\n    const wait = this.animating_ || Promise.resolve();\n    return (this.animating_ = wait\n      .then(\n        () => {\n          return callback();\n        },\n        () => {\n          // Ignore errors to make sure animations don't get stuck.\n        }\n      )\n      .then(() => {\n        this.animating_ = null;\n      }));\n  }\n\n  /**\n   * Returns maximum allowed height for current viewport.\n   * @param {number} height\n   * @return {number}\n   * @private\n   */\n  getMaxAllowedHeight_(height) {\n    return Math.min(\n      height,\n      this.doc_.getWin()./*OK*/ innerHeight * this.maxAllowedHeightRatio_\n    );\n  }\n\n  /**\n   * Update padding-bottom on the containing page to not hide any content\n   * behind the popup, if rendered at the bottom. For centered dialogs, there\n   * should be no added padding.\n   * @param {number} newHeight\n   * @private\n   */\n  updatePaddingToHtml_(newHeight) {\n    if (this.positionCenterOnDesktop_ && this.desktopMediaQuery_.matches) {\n      // For centered dialogs, there should be no bottom padding.\n      this.removePaddingToHtml_();\n      return;\n    }\n    const bottomPadding = newHeight + 20; // Add some extra padding.\n    const htmlElement = this.doc_.getRootElement();\n    setImportantStyles$1(htmlElement, {\n      'padding-bottom': `${bottomPadding}px`,\n    });\n  }\n\n  /**\n   * Removes previouly added bottom padding from the document.\n   * @private\n   */\n  removePaddingToHtml_() {\n    this.doc_.getRootElement().style.removeProperty('padding-bottom');\n  }\n\n  /**\n   * Sets the position of the dialog. Currently only supports 'BOTTOM', with\n   * an option of switching to 'CENTER' on desktop screens.\n   */\n  setPosition_() {\n    setImportantStyles$1(this.getElement(), this.getPositionStyle_());\n  }\n\n  /**\n   * Returns the styles required to postion the dialog.\n   * @return {!Object<string, string|number>}\n   * @private\n   */\n  getPositionStyle_() {\n    if (this.positionCenterOnDesktop_ && this.desktopMediaQuery_.matches) {\n      return {\n        'top': '50%',\n        'bottom': 0,\n        'transform': this.getDefaultTranslateY_(),\n      };\n    }\n    return {\n      'top': 'auto',\n      'bottom': 0,\n      'transform': this.getDefaultTranslateY_(),\n    };\n  }\n\n  /**\n   * Returns default translateY style for the dialog.\n   * @return {string}\n   * @private\n   */\n  getDefaultTranslateY_() {\n    if (this.positionCenterOnDesktop_ && this.desktopMediaQuery_.matches) {\n      return 'translateY(-50%)';\n    }\n    return 'translateY(0px)';\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst POPUP_Z_INDEX = 2147483647;\n\n/**\n * The class for the top level dialog.\n * @final\n */\nclass DialogManager {\n  /**\n   * @param {!../model/doc.Doc} doc\n   */\n  constructor(doc) {\n    /** @private @const {!../model/doc.Doc} */\n    this.doc_ = doc;\n\n    /** @private {?Dialog} */\n    this.dialog_ = null;\n\n    /** @private {?Promise<!Dialog>} */\n    this.openPromise_ = null;\n\n    /** @private @const {!Graypane} */\n    this.popupGraypane_ = new Graypane$1(doc, POPUP_Z_INDEX);\n\n    /** @private {?Window} */\n    this.popupWin_ = null;\n\n    this.popupGraypane_.getElement().addEventListener('click', () => {\n      if (this.popupWin_) {\n        try {\n          this.popupWin_.focus();\n        } catch (e) {\n          // Ignore error.\n        }\n      }\n    });\n  }\n\n  /**\n   * @param {boolean=} hidden\n   * @param {!./dialog.DialogConfig=} dialogConfig Configuration options for the\n   *     dialog.\n   * @return {!Promise<!Dialog>}\n   */\n  openDialog(hidden = false, dialogConfig = {}) {\n    if (!this.openPromise_) {\n      this.dialog_ = new Dialog(\n        this.doc_,\n        /* importantStyles */ {},\n        /* styles */ {},\n        dialogConfig\n      );\n      this.openPromise_ = this.dialog_.open(hidden);\n    }\n    return this.openPromise_;\n  }\n\n  /**\n   * @param {!./view.View} view\n   * @param {boolean=} hidden\n   * @param {!./dialog.DialogConfig=} dialogConfig Configuration options for the\n   *    dialog.\n   * @return {!Promise}\n   */\n  openView(view, hidden = false, dialogConfig = {}) {\n    this.handleCancellations(view);\n    return this.openDialog(hidden, dialogConfig).then((dialog) => {\n      return dialog.openView(view);\n    });\n  }\n\n  /**\n   * Handles cancellations (ex: user clicks close button on dialog).\n   * @param {!./view.View} view\n   * @return {!Promise}\n   */\n  handleCancellations(view) {\n    return view.whenComplete().catch((reason) => {\n      if (isCancelError(reason)) {\n        this.completeView(view);\n      }\n      throw reason;\n    });\n  }\n\n  /**\n   * @param {?./view.View} view\n   */\n  completeView(view) {\n    // Give a small amount of time for another view to take over the dialog.\n    setTimeout(() => {\n      if (this.dialog_ && this.dialog_.getCurrentView() == view) {\n        this.close_();\n      }\n    }, 100);\n  }\n\n  /**\n   */\n  completeAll() {\n    if (this.dialog_) {\n      this.close_();\n    }\n    if (this.popupGraypane_.isAttached()) {\n      this.popupGraypane_.destroy();\n    }\n  }\n\n  /**\n   * @returns {?Dialog}\n   */\n  getDialog() {\n    return this.dialog_;\n  }\n\n  /** @private */\n  close_() {\n    this.dialog_.close();\n    this.dialog_ = null;\n    this.openPromise_ = null;\n  }\n\n  /**\n   * @param {?Window|undefined} targetWin\n   */\n  popupOpened(targetWin) {\n    this.popupWin_ = targetWin || null;\n    if (!this.popupGraypane_.isAttached()) {\n      this.popupGraypane_.attach();\n    }\n    this.popupGraypane_.show();\n  }\n\n  /**\n   */\n  popupClosed() {\n    this.popupWin_ = null;\n    try {\n      this.popupGraypane_.hide();\n    } catch (e) {\n      // Ignore.\n    }\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @enum {number}  */\nconst MeterClientTypes = {\n  /** Meter client type for content licensed by Google. */\n  LICENSED_BY_GOOGLE: 1,\n};\n\n/**\n * Copyright 2020 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst IFRAME_BOX_SHADOW =\n  'rgba(60, 64, 67, 0.3) 0px -2px 5px, rgba(60, 64, 67, 0.15) 0px -5px 5px';\nconst MINIMIZED_IFRAME_SIZE = '420px';\n\nclass MeterToastApi {\n  /**\n   * @param {!./deps.DepsDef} deps\n   */\n  constructor(deps) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    const iframeArgs = this.activityPorts_.addDefaultArguments({\n      isClosable: true,\n      hasSubscriptionCallback: deps.callbacks().hasSubscribeRequestCallback(),\n    });\n    /** @private @const {!ActivityIframeView} */\n    this.activityIframeView_ = new ActivityIframeView(\n      this.win_,\n      this.activityPorts_,\n      feUrl('/metertoastiframe'),\n      iframeArgs,\n      /* shouldFadeBody */ false\n    );\n\n    /**\n     * Function this class calls when a user dismisses the toast to consume a free read.\n     * @private {?function()}\n     */\n    this.onConsumeCallback_ = null;\n\n    /**\n     * Boolean indicating whether or not the onConsumeCallback_ has been handled\n     * (either called or ignored). This is used to protect against unexpected\n     * cancellations not consuming a meter.\n     * @private {!boolean}\n     */\n    this.onConsumeCallbackHandled_ = false;\n\n    /** @private @const {!function()} */\n    this.sendCloseRequestFunction_ = () => {\n      const closeRequest = new ToastCloseRequest();\n      closeRequest.setClose(true);\n      this.activityIframeView_.execute(closeRequest);\n      this.removeCloseEventListener();\n\n      this.deps_\n        .eventManager()\n        .logSwgEvent(\n          AnalyticsEvent.ACTION_METER_TOAST_CLOSED_BY_ARTICLE_INTERACTION,\n          true\n        );\n\n      if (this.onConsumeCallback_ && !this.onConsumeCallbackHandled_) {\n        this.onConsumeCallbackHandled_ = true;\n        this.onConsumeCallback_();\n      }\n    };\n\n    /** @private {?function()} */\n    this.scrollEventListener_ = null;\n  }\n\n  /**\n   * Shows the user the metering toast.\n   * @return {!Promise}\n   */\n  start() {\n    this.deps_\n      .callbacks()\n      .triggerFlowStarted(SubscriptionFlows.SHOW_METER_TOAST);\n    this.activityIframeView_.on(\n      ViewSubscriptionsResponse,\n      this.startNativeFlow_.bind(this)\n    );\n    if (!this.deps_.callbacks().hasSubscribeRequestCallback()) {\n      const errorMessage =\n        '[swg.js]: `setOnNativeSubscribeRequest` has not been ' +\n        'set before starting the metering flow, so users will not be able to ' +\n        'subscribe from the metering dialog directly. Please call ' +\n        '`setOnNativeSubscribeRequest` with a subscription flow callback before ' +\n        'starting metering.';\n      warn(errorMessage);\n    }\n\n    this.dialogManager_\n      .handleCancellations(this.activityIframeView_)\n      .catch((reason) => {\n        // Possibly call onConsumeCallback on all dialog cancellations to ensure unexpected\n        // dialog closures don't give access without a meter consumed.\n        if (this.onConsumeCallback_ && !this.onConsumeCallbackHandled_) {\n          this.onConsumeCallbackHandled_ = true;\n          this.onConsumeCallback_();\n        }\n        // Don't throw on cancel errors since they happen when a user closes the toast,\n        // which is expected.\n        if (!isCancelError(reason)) {\n          // eslint-disable-next-line no-console\n          console /*OK*/\n            .error(\n              '[swg.js]: Error occurred during meter toast handling: ' + reason\n            );\n          throw reason;\n        }\n      });\n    return this.dialogManager_.openDialog().then((dialog) => {\n      this.setDialogBoxShadow_();\n      this.setLoadingViewWidth_();\n      return dialog.openView(this.activityIframeView_).then(() => {\n        // Allow closing of the iframe with any scroll or click event.\n        this.win_.addEventListener('click', this.sendCloseRequestFunction_);\n        this.win_.addEventListener(\n          'touchstart',\n          this.sendCloseRequestFunction_\n        );\n        this.win_.addEventListener('mousedown', this.sendCloseRequestFunction_);\n        // Making body's overflow property 'hidden' to prevent scrolling\n        // while swiping on the iframe only on mobile.\n        if (this.isMobile_()) {\n          const $body = this.win_.document.body;\n          setStyle($body, 'overflow', 'hidden');\n        } else {\n          let start, scrollTimeout;\n          this.scrollEventListener_ = () => {\n            start = start || this.win_./*REVIEW*/ pageYOffset;\n            this.win_.clearTimeout(scrollTimeout);\n            scrollTimeout = this.win_.setTimeout(() => {\n              // If the scroll is longer than 100, close the toast.\n              if (Math.abs(this.win_./*REVIEW*/ pageYOffset - start) > 100) {\n                this.sendCloseRequestFunction_();\n              }\n            }, 100);\n          };\n          this.win_.addEventListener('scroll', this.scrollEventListener_);\n        }\n        this.deps_\n          .eventManager()\n          .logSwgEvent(AnalyticsEvent.IMPRESSION_METER_TOAST);\n        this.deps_\n          .eventManager()\n          .logSwgEvent(AnalyticsEvent.EVENT_OFFERED_METER);\n      });\n    });\n  }\n\n  /**\n   * Sets a callback function this class calls when a user dismisses the toast to consume a free read.\n   * @param {function()} onConsumeCallback\n   */\n  setOnConsumeCallback(onConsumeCallback) {\n    this.onConsumeCallback_ = onConsumeCallback;\n  }\n\n  /**\n   * Removes the event listeners that close the iframe and make the body visible.\n   */\n  removeCloseEventListener() {\n    this.win_.removeEventListener('click', this.sendCloseRequestFunction_);\n    this.win_.removeEventListener('touchstart', this.sendCloseRequestFunction_);\n    this.win_.removeEventListener('mousedown', this.sendCloseRequestFunction_);\n    if (this.isMobile_()) {\n      const $body = this.win_.document.body;\n      setStyle($body, 'overflow', 'visible');\n    } else {\n      this.win_.removeEventListener('scroll', this.scrollEventListener_);\n    }\n  }\n\n  /**\n   * Changes the iframe box shadow to match desired specifications on mobile.\n   */\n  setDialogBoxShadow_() {\n    const mobileMediaQuery = this.win_.matchMedia(\n      '(max-width: 640px), (max-height: 640px)'\n    );\n    const element = this.dialogManager_.getDialog().getElement();\n    if (mobileMediaQuery.matches) {\n      setImportantStyles$1(element, {'box-shadow': IFRAME_BOX_SHADOW});\n    }\n    mobileMediaQuery.addListener((changed) => {\n      if (changed.matches) {\n        setImportantStyles$1(element, {'box-shadow': IFRAME_BOX_SHADOW});\n      } else {\n        setImportantStyles$1(element, {'box-shadow': ''});\n      }\n    });\n  }\n\n  /**\n   * Changes the size of the loading iframe on desktop to match the size of\n   * the meter toast iframe.\n   */\n  setLoadingViewWidth_() {\n    const desktopMediaQuery = this.win_.matchMedia(\n      '(min-width: 640px) and (min-height: 640px)'\n    );\n    if (desktopMediaQuery.matches) {\n      const element = this.dialogManager_\n        .getDialog()\n        .getLoadingView()\n        .getElement();\n      setImportantStyles$1(element, {\n        'width': MINIMIZED_IFRAME_SIZE,\n        'margin': 'auto',\n      });\n    }\n  }\n\n  /**\n   * @param {ViewSubscriptionsResponse} response\n   * @private\n   */\n  startNativeFlow_(response) {\n    if (response.getNative()) {\n      this.removeCloseEventListener();\n      // We shouldn't decrement the meter on redirects, so don't call onConsumeCallback.\n      this.onConsumeCallbackHandled_ = true;\n      this.deps_.callbacks().triggerSubscribeRequest();\n    }\n  }\n\n  /**\n   * Returns true if the window userAgent is a mobile platform.\n   * @private\n   */\n  isMobile_() {\n    return !!this.win_.navigator.userAgent.match(\n      /Android|iPhone|iPad|iPod|BlackBerry|IEMobile/i\n    );\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {!Object<string, string|number>} */\nconst toastImportantStyles = {\n  'height': 0,\n};\n\n/** @const {!Object<string, string>} */\nconst iframeAttributes = {\n  'frameborder': '0',\n  'scrolling': 'no',\n  'class': 'swg-toast',\n};\n\n/**\n * The class Notification toast.\n */\nclass Toast {\n  /**\n   * @param {!../runtime/deps.DepsDef} deps\n   * @param {string} src\n   * @param {?Object<string, ?>=} args\n   */\n  constructor(deps, src, args) {\n    /** @private @const {!../model/doc.Doc} */\n    this.doc_ = deps.doc();\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {string} */\n    this.src_ = src;\n\n    /** @private {?Object<string, ?>} */\n    this.args_ = args || {};\n\n    /** @private {?Promise} */\n    this.animating_ = null;\n\n    /** @private @const {!HTMLIFrameElement} */\n    this.iframe_ = /** @type {!HTMLIFrameElement} */ (\n      createElement(this.doc_.getWin().document, 'iframe', iframeAttributes)\n    );\n\n    setImportantStyles$1(this.iframe_, toastImportantStyles);\n\n    /** @private @const {!Promise} */\n    this.ready_ = new Promise((resolve) => {\n      this.iframe_.onload = resolve;\n    });\n  }\n\n  /**\n   * Returns the iframe element.\n   * @return {!HTMLIFrameElement}\n   */\n  getElement() {\n    return this.iframe_;\n  }\n\n  /**\n   * Opens the notification toast.\n   * @return {!Promise}\n   */\n  open() {\n    this.doc_.getBody().appendChild(this.iframe_); // Fires onload.\n    return this.buildToast_();\n  }\n\n  /**\n   * Builds the content of the iframe. On load, animates the toast.\n   */\n  buildToast_() {\n    const toastDurationSeconds = 7;\n    return this.activityPorts_\n      .openIframe(this.iframe_, this.src_, this.args_)\n      .then((port) => {\n        return port.whenReady();\n      })\n      .then(() => {\n        resetStyles(this.iframe_, ['height']);\n\n        this.animate_(() => {\n          setImportantStyles$1(this.iframe_, {\n            'transform': 'translateY(100%)',\n            'opactiy': 1,\n            'visibility': 'visible',\n          });\n          return transition$1(\n            this.iframe_,\n            {\n              'transform': 'translateY(0)',\n              'opacity': 1,\n              'visibility': 'visible',\n            },\n            400,\n            'ease-out'\n          );\n        });\n\n        // Close the Toast after the specified duration.\n        this.doc_.getWin().setTimeout(() => {\n          this.close();\n        }, (toastDurationSeconds + 1) * 1000);\n      });\n  }\n\n  /**\n   * @param {function():!Promise} callback\n   * @return {!Promise}\n   * @private\n   */\n  animate_(callback) {\n    const wait = this.animating_ || Promise.resolve();\n    return (this.animating_ = wait\n      .then(() => callback())\n      // Ignore errors to make sure animations don't get stuck.\n      .catch(() => {})\n      .then(() => {\n        this.animating_ = null;\n      }));\n  }\n\n  /**\n   * Closes the toast.\n   * @return {!Promise}\n   */\n  close() {\n    return this.animate_(() => {\n      // Remove the toast from the DOM after animation is complete.\n      this.doc_.getWin().setTimeout(() => {\n        this.doc_.getBody().removeChild(this.iframe_);\n        return Promise.resolve();\n      }, 500);\n\n      return transition$1(\n        this.iframe_,\n        {\n          'transform': 'translateY(100%)',\n          'opacity': 1,\n          'visibility': 'visible',\n        },\n        400,\n        'ease-out'\n      );\n    });\n  }\n}\n\n/**\n * Copyright 2019 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {!Object<string,AnalyticsEvent>} */\nconst PublisherEventToAnalyticsEvent = {\n  [Event.IMPRESSION_PAYWALL]: AnalyticsEvent.IMPRESSION_PAYWALL,\n  [Event.IMPRESSION_AD]: AnalyticsEvent.IMPRESSION_AD,\n  [Event.IMPRESSION_OFFERS]: AnalyticsEvent.IMPRESSION_OFFERS,\n  [Event.ACTION_SUBSCRIPTIONS_LANDING_PAGE]:\n    AnalyticsEvent.ACTION_SUBSCRIPTIONS_LANDING_PAGE,\n  [Event.ACTION_OFFER_SELECTED]: AnalyticsEvent.ACTION_OFFER_SELECTED,\n  [Event.ACTION_PAYMENT_FLOW_STARTED]:\n    AnalyticsEvent.ACTION_PAYMENT_FLOW_STARTED,\n  [Event.ACTION_PAYMENT_COMPLETED]: AnalyticsEvent.ACTION_PAYMENT_COMPLETE,\n  [Event.EVENT_CUSTOM]: AnalyticsEvent.EVENT_CUSTOM,\n};\n\n/** @const {!Object<?AnalyticsEvent,?Event>} */\nconst AnalyticsEventToPublisherEvent = {\n  [AnalyticsEvent.UNKNOWN]: null,\n  [AnalyticsEvent.IMPRESSION_PAYWALL]: Event.IMPRESSION_PAYWALL,\n  [AnalyticsEvent.IMPRESSION_AD]: Event.IMPRESSION_AD,\n  [AnalyticsEvent.IMPRESSION_OFFERS]: Event.IMPRESSION_OFFERS,\n  [AnalyticsEvent.IMPRESSION_SUBSCRIBE_BUTTON]: null,\n  [AnalyticsEvent.IMPRESSION_SMARTBOX]: null,\n  [AnalyticsEvent.ACTION_SUBSCRIBE]: null,\n  [AnalyticsEvent.ACTION_PAYMENT_COMPLETE]: Event.ACTION_PAYMENT_COMPLETED,\n  [AnalyticsEvent.ACTION_ACCOUNT_CREATED]: null,\n  [AnalyticsEvent.ACTION_ACCOUNT_ACKNOWLEDGED]: null,\n  [AnalyticsEvent.ACTION_SUBSCRIPTIONS_LANDING_PAGE]:\n    Event.ACTION_SUBSCRIPTIONS_LANDING_PAGE,\n  [AnalyticsEvent.ACTION_PAYMENT_FLOW_STARTED]:\n    Event.ACTION_PAYMENT_FLOW_STARTED,\n  [AnalyticsEvent.ACTION_OFFER_SELECTED]: Event.ACTION_OFFER_SELECTED,\n  [AnalyticsEvent.EVENT_PAYMENT_FAILED]: null,\n  [AnalyticsEvent.EVENT_CUSTOM]: Event.EVENT_CUSTOM,\n};\n\n/** @const {!Object<string,?Array<AnalyticsEvent>>} */\nconst ShowcaseEvents = {\n  // Events related to content being potentially unlockable\n  [ShowcaseEvent.EVENT_SHOWCASE_METER_OFFERED]: [\n    AnalyticsEvent.EVENT_HAS_METERING_ENTITLEMENTS,\n    AnalyticsEvent.EVENT_OFFERED_METER,\n  ],\n\n  // Events related to content being unlocked\n  [ShowcaseEvent.EVENT_SHOWCASE_UNLOCKED_BY_SUBSCRIPTION]: [\n    AnalyticsEvent.EVENT_UNLOCKED_BY_SUBSCRIPTION,\n  ],\n  [ShowcaseEvent.EVENT_SHOWCASE_UNLOCKED_BY_METER]: [\n    AnalyticsEvent.EVENT_HAS_METERING_ENTITLEMENTS,\n    AnalyticsEvent.EVENT_UNLOCKED_BY_METER,\n  ],\n  [ShowcaseEvent.EVENT_SHOWCASE_UNLOCKED_FREE_PAGE]: [\n    AnalyticsEvent.EVENT_UNLOCKED_FREE_PAGE,\n  ],\n\n  // Events requiring user action to unlock content\n  [ShowcaseEvent.EVENT_SHOWCASE_NO_ENTITLEMENTS_REGWALL]: [\n    AnalyticsEvent.EVENT_NO_ENTITLEMENTS,\n    AnalyticsEvent.IMPRESSION_REGWALL,\n    AnalyticsEvent.IMPRESSION_SHOWCASE_REGWALL,\n  ],\n\n  // Events requiring subscription to unlock content\n  [ShowcaseEvent.EVENT_SHOWCASE_NO_ENTITLEMENTS_PAYWALL]: [\n    AnalyticsEvent.EVENT_NO_ENTITLEMENTS,\n    AnalyticsEvent.IMPRESSION_PAYWALL,\n  ],\n  [ShowcaseEvent.EVENT_SHOWCASE_INELIGIBLE_PAYWALL]: [\n    AnalyticsEvent.EVENT_INELIGIBLE_PAYWALL,\n    AnalyticsEvent.EVENT_NO_ENTITLEMENTS,\n  ],\n};\n\n/** @const {!Object<?AnalyticsEvent,?Event>} */\nconst AnalyticsEventToEntitlementResult = {\n  [AnalyticsEvent.IMPRESSION_REGWALL]: EntitlementResult.LOCKED_REGWALL,\n  [AnalyticsEvent.EVENT_UNLOCKED_BY_METER]: EntitlementResult.UNLOCKED_METER,\n  [AnalyticsEvent.EVENT_UNLOCKED_BY_SUBSCRIPTION]:\n    EntitlementResult.UNLOCKED_SUBSCRIBER,\n  [AnalyticsEvent.EVENT_UNLOCKED_FREE_PAGE]: EntitlementResult.UNLOCKED_FREE,\n  [AnalyticsEvent.IMPRESSION_PAYWALL]: EntitlementResult.LOCKED_PAYWALL,\n  [AnalyticsEvent.EVENT_INELIGIBLE_PAYWALL]:\n    EntitlementResult.INELIGIBLE_PAYWALL,\n};\n\n/**\n * @param {!string} eventCategory\n * @param {!string} eventAction\n * @param {!string} eventLabel\n * @param {!boolean} nonInteraction\n * @returns {!Object}\n */\nconst createGoogleAnalyticsEvent = (\n  eventCategory,\n  eventAction,\n  eventLabel,\n  nonInteraction\n) => ({\n  eventCategory,\n  eventAction,\n  eventLabel,\n  nonInteraction,\n});\n\n/** @const {!Object<?AnalyticsEvent,?Object>} */\nconst AnalyticsEventToGoogleAnalyticsEvent = {\n  [AnalyticsEvent.IMPRESSION_OFFERS]: createGoogleAnalyticsEvent(\n    'NTG paywall',\n    'paywall modal impression',\n    '',\n    true\n  ),\n  [AnalyticsEvent.IMPRESSION_CONTRIBUTION_OFFERS]: createGoogleAnalyticsEvent(\n    'NTG membership',\n    'offer impressions',\n    '',\n    true\n  ),\n\n  [AnalyticsEvent.ACTION_OFFER_SELECTED]: createGoogleAnalyticsEvent(\n    'NTG paywall',\n    'click',\n    '',\n    false\n  ),\n  [AnalyticsEvent.ACTION_SWG_SUBSCRIPTION_MINI_PROMPT_CLICK]:\n    createGoogleAnalyticsEvent(\n      'NTG subscription',\n      'marketing modal click',\n      '',\n      false\n    ),\n  [AnalyticsEvent.IMPRESSION_SWG_SUBSCRIPTION_MINI_PROMPT]:\n    createGoogleAnalyticsEvent(\n      'NTG subscription',\n      'marketing modal impression',\n      '',\n      true\n    ),\n  [AnalyticsEvent.ACTION_SWG_CONTRIBUTION_MINI_PROMPT_CLICK]:\n    createGoogleAnalyticsEvent(\n      'NTG membership',\n      'marketing modal click',\n      '',\n      false\n    ),\n  [AnalyticsEvent.IMPRESSION_SWG_CONTRIBUTION_MINI_PROMPT]:\n    createGoogleAnalyticsEvent(\n      'NTG membership',\n      'membership modal impression',\n      '',\n      true\n    ),\n};\n\n/** @const {!Object<?AnalyticsEvent,?Object>} */\nconst SubscriptionSpecificAnalyticsEventToGoogleAnalyticsEvent = {\n  [AnalyticsEvent.ACTION_PAYMENT_COMPLETE]: createGoogleAnalyticsEvent(\n    'NTG subscription',\n    'submit',\n    'success',\n    false\n  ),\n};\n\n/** @const {!Object<?AnalyticsEvent,?Object>} */\nconst ContributionSpecificAnalyticsEventToGoogleAnalyticsEvent = {\n  [AnalyticsEvent.ACTION_PAYMENT_COMPLETE]: createGoogleAnalyticsEvent(\n    'NTG membership',\n    'submit',\n    'success',\n    false\n  ),\n};\n\n/**\n * Converts a propensity event enum into an analytics event enum.\n * @param {!Event|string} propensityEvent\n * @returns {!AnalyticsEvent}\n */\nfunction publisherEventToAnalyticsEvent(propensityEvent) {\n  return PublisherEventToAnalyticsEvent[propensityEvent];\n}\n\n/**\n * Converts an analytics event enum into a propensity event enum.\n * @param {?AnalyticsEvent} analyticsEvent\n * @returns {?Event}\n */\nfunction analyticsEventToPublisherEvent(analyticsEvent) {\n  return AnalyticsEventToPublisherEvent[analyticsEvent];\n}\n\n/**\n * Converts a publisher entitlement event enum into an array analytics events.\n * @param {!ShowcaseEvent} event\n * @returns {!Array<AnalyticsEvent>}\n */\nfunction showcaseEventToAnalyticsEvents(event) {\n  return ShowcaseEvents[event] || [];\n}\n\nfunction analyticsEventToEntitlementResult(event) {\n  return AnalyticsEventToEntitlementResult[event];\n}\n\n/**\n * Converts an analytics event enum into a Google Analytics event object.\n * @param {?AnalyticsEvent} event\n * @param {string} subscriptionFlow\n * @returns {?Object}\n */\nfunction analyticsEventToGoogleAnalyticsEvent(event, subscriptionFlow) {\n  let gaEvent = null;\n  if (subscriptionFlow) {\n    if (subscriptionFlow == SubscriptionFlows.SUBSCRIBE) {\n      gaEvent = SubscriptionSpecificAnalyticsEventToGoogleAnalyticsEvent[event];\n    } else if (subscriptionFlow == SubscriptionFlows.CONTRIBUTE) {\n      gaEvent = ContributionSpecificAnalyticsEventToGoogleAnalyticsEvent[event];\n    }\n  }\n  return gaEvent || AnalyticsEventToGoogleAnalyticsEvent[event];\n}\n\n/**\n * Copyright 2020 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns true if the query string contains fresh Google Article Access (GAA) params.\n * @param {string} queryString\n * @param {boolean} allowAllAccessTypes\n * @return {boolean}\n */\nfunction queryStringHasFreshGaaParams(\n  queryString,\n  allowAllAccessTypes = false\n) {\n  const params = parseQueryString(queryString);\n\n  // Verify GAA params exist.\n  if (\n    !params['gaa_at'] ||\n    !params['gaa_n'] ||\n    !params['gaa_sig'] ||\n    !params['gaa_ts']\n  ) {\n    return false;\n  }\n\n  if (!allowAllAccessTypes) {\n    // Verify access type.\n    const noAccess = params['gaa_at'] === 'na';\n    if (noAccess) {\n      return false;\n    }\n  }\n\n  // Verify timestamp isn't stale.\n  const expirationTimestamp = parseInt(params['gaa_ts'], 16);\n  const currentTimestamp = Date.now() / 1000;\n  if (expirationTimestamp < currentTimestamp) {\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst SERVICE_ID = 'subscribe.google.com';\nconst TOAST_STORAGE_KEY = 'toast';\nconst ENTS_STORAGE_KEY = 'ents';\nconst IS_READY_TO_PAY_STORAGE_KEY = 'isreadytopay';\n\n/**\n */\nclass EntitlementsManager {\n  /**\n   * @param {!Window} win\n   * @param {!../model/page-config.PageConfig} pageConfig\n   * @param {!./fetcher.Fetcher} fetcher\n   * @param {!./deps.DepsDef} deps\n   */\n  constructor(win, pageConfig, fetcher, deps) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private @const {!../model/page-config.PageConfig} */\n    this.pageConfig_ = pageConfig;\n\n    /** @private @const {string} */\n    this.publicationId_ = this.pageConfig_.getPublicationId();\n\n    /** @private @const {!./fetcher.Fetcher} */\n    this.fetcher_ = fetcher;\n\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!JwtHelper} */\n    this.jwtHelper_ = new JwtHelper();\n\n    /** @private {?Promise<!Entitlements>} */\n    this.responsePromise_ = null;\n\n    /** @private {number} */\n    this.positiveRetries_ = 0;\n\n    /** @private {boolean} */\n    this.blockNextNotification_ = false;\n\n    /**\n     * String containing encoded metering parameters currently.\n     * We may expand this to contain more information in the future.\n     * @private {?string}\n     */\n    this.encodedParams_ = null;\n\n    /** @private @const {!./storage.Storage} */\n    this.storage_ = deps.storage();\n\n    /** @private @const {!../runtime/analytics-service.AnalyticsService} */\n    this.analyticsService_ = deps.analytics();\n\n    /** @private @const {!../api/subscriptions.Config} */\n    this.config_ = deps.config();\n\n    /**\n     * Tests can use this promise to wait for POST requests to finish.\n     * @visibleForTesting\n     */\n    this.entitlementsPostPromise = null;\n\n    this.deps_\n      .eventManager()\n      .registerEventListener(this.possiblyPingbackOnClientEvent_.bind(this));\n  }\n\n  /**\n   * @param {boolean=} expectPositive\n   */\n  reset(expectPositive) {\n    this.responsePromise_ = null;\n    this.positiveRetries_ = Math.max(\n      this.positiveRetries_,\n      expectPositive ? 3 : 0\n    );\n    if (expectPositive) {\n      this.storage_.remove(ENTS_STORAGE_KEY);\n      this.storage_.remove(IS_READY_TO_PAY_STORAGE_KEY);\n    }\n  }\n\n  /**\n   * Clears all of the entitlements state and cache.\n   */\n  clear() {\n    this.responsePromise_ = null;\n    this.positiveRetries_ = 0;\n    this.unblockNextNotification();\n    this.storage_.remove(ENTS_STORAGE_KEY);\n    this.storage_.remove(TOAST_STORAGE_KEY);\n    this.storage_.remove(IS_READY_TO_PAY_STORAGE_KEY);\n  }\n\n  /**\n   * @param {!GetEntitlementsParamsExternalDef=} params\n   * @return {!Promise<!Entitlements>}\n   */\n  getEntitlements(params) {\n    // Remain backwards compatible by accepting\n    // `encryptedDocumentKey` string as a first param.\n    if (typeof params === 'string') {\n      // TODO: Delete the fallback if nobody needs it. Use a log to verify.\n      if (Date.now() > 1600289016959) {\n        // TODO: Remove the conditional check for this warning\n        // after the AMP extension is updated to pass an object.\n        warn(\n          `[swg.js:getEntitlements]: If present, the first param of getEntitlements() should be an object of type GetEntitlementsParamsExternalDef.`\n        );\n      }\n\n      params = {\n        encryption: {encryptedDocumentKey: /**@type {string} */ (params)},\n      };\n    }\n\n    if (!this.responsePromise_) {\n      this.responsePromise_ = this.getEntitlementsFlow_(params);\n    }\n    return this.responsePromise_.then((response) => {\n      if (response.isReadyToPay != null) {\n        this.analyticsService_.setReadyToPay(response.isReadyToPay);\n      }\n      return response;\n    });\n  }\n\n  /**\n   * @param {string} raw\n   * @param {boolean=} isReadyToPay\n   * @return {boolean}\n   */\n  pushNextEntitlements(raw, isReadyToPay) {\n    const entitlements = this.getValidJwtEntitlements_(\n      raw,\n      /* requireNonExpired */ true,\n      isReadyToPay\n    );\n    if (entitlements && entitlements.enablesThis()) {\n      this.storage_.set(ENTS_STORAGE_KEY, raw);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Retrieves the 'gaa_n' parameter from the query string.\n   */\n  getGaaToken_() {\n    return parseQueryString(this.win_.location.search)['gaa_n'];\n  }\n\n  /**\n   * Sends a pingback that marks a metering entitlement as used.\n   * @param {!Entitlements} entitlements\n   */\n  consumeMeter_(entitlements) {\n    const entitlement = entitlements.getEntitlementForThis();\n    if (!entitlement || entitlement.source !== GOOGLE_METERING_SOURCE) {\n      return;\n    }\n    // Verify GAA params are present, otherwise bail since the pingback\n    // shouldn't happen on non-metering requests.\n    if (!queryStringHasFreshGaaParams(this.win_.location.search)) {\n      return;\n    }\n\n    this.deps_\n      .eventManager()\n      .logSwgEvent(AnalyticsEvent.EVENT_UNLOCKED_BY_METER, false);\n\n    const token = this.getGaaToken_();\n\n    const jwt = new EntitlementJwt();\n    jwt.setSource(entitlement.source);\n    jwt.setJwt(entitlement.subscriptionToken);\n    return this.postEntitlementsRequest_(\n      jwt,\n      EntitlementResult.UNLOCKED_METER,\n      EntitlementSource.GOOGLE_SHOWCASE_METERING_SERVICE,\n      token\n    );\n  }\n\n  /**\n   * Listens for events from the event manager and informs the server\n   * about publisher entitlements and non-consumable Google entitlements.\n   * @param {!../api/client-event-manager-api.ClientEvent} event\n   */\n  possiblyPingbackOnClientEvent_(event) {\n    // Verify GAA params are present, otherwise bail since the pingback\n    // shouldn't happen on non-metering requests.\n    // We don't validate access type since we want to pingback on all access types.\n    if (\n      !queryStringHasFreshGaaParams(\n        this.win_.location.search,\n        /*allowAllAccessTypes=*/ true\n      )\n    ) {\n      return;\n    }\n\n    // A subset of analytics events are also an entitlement result\n    const result = analyticsEventToEntitlementResult(event.eventType);\n    if (!result) {\n      return;\n    }\n    let source = null;\n\n    switch (event.eventOriginator) {\n      // Publisher JS logged this event.\n      case EventOriginator.SHOWCASE_CLIENT:\n        source = EntitlementSource.PUBLISHER_ENTITLEMENT;\n        break;\n      // Swgjs logged this event.\n      case EventOriginator.SWG_CLIENT:\n        if (result == EntitlementResult.UNLOCKED_METER) {\n          // The `consumeMeter_` method already tracks this.\n          return;\n        }\n\n        source = EntitlementSource.GOOGLE_SUBSCRIBER_ENTITLEMENT;\n        break;\n      default:\n        return;\n    }\n    const token = this.getGaaToken_();\n    const isUserRegistered =\n      event?.additionalParameters?.getIsUserRegistered?.();\n    this.postEntitlementsRequest_(\n      new EntitlementJwt(),\n      result,\n      source,\n      token,\n      isUserRegistered\n    );\n  }\n\n  // Informs the Entitlements server about the entitlement used\n  // to unlock the page.\n  postEntitlementsRequest_(\n    usedEntitlement,\n    entitlementResult,\n    entitlementSource,\n    optionalToken = '',\n    optionalIsUserRegistered = null\n  ) {\n    const message = new EntitlementsRequest();\n    message.setUsedEntitlement(usedEntitlement);\n    message.setClientEventTime(toTimestamp(Date.now()));\n    message.setEntitlementResult(entitlementResult);\n    message.setEntitlementSource(entitlementSource);\n    message.setToken(optionalToken);\n    if (typeof optionalIsUserRegistered === 'boolean') {\n      message.setIsUserRegistered(optionalIsUserRegistered);\n    }\n\n    let url =\n      '/publication/' +\n      encodeURIComponent(this.publicationId_) +\n      '/entitlements';\n    url = addDevModeParamsToUrl(this.win_.location, url);\n\n    // Promise that sets this.encodedParams_ when it resolves.\n    const encodedParamsPromise = this.encodedParams_\n      ? Promise.resolve()\n      : hash(getCanonicalUrl(this.deps_.doc())).then((hashedCanonicalUrl) => {\n          /** @type {!GetEntitlementsParamsInternalDef} */\n          const encodableParams = {\n            metering: {\n              resource: {\n                hashedCanonicalUrl,\n              },\n            },\n          };\n          this.encodedParams_ = base64UrlEncodeFromBytes(\n            utf8EncodeSync(JSON.stringify(encodableParams))\n          );\n        });\n\n    this.entitlementsPostPromise = encodedParamsPromise.then(() => {\n      url = addQueryParam(\n        url,\n        'encodedParams',\n        /** @type {!string} */ (this.encodedParams_)\n      );\n\n      return this.fetcher_.sendPost(serviceUrl(url), message);\n    });\n  }\n\n  /**\n   * @param {!GetEntitlementsParamsExternalDef=} params\n   * @return {!Promise<!Entitlements>}\n   * @private\n   */\n  getEntitlementsFlow_(params) {\n    return this.fetchEntitlementsWithCaching_(params).then((entitlements) => {\n      this.onEntitlementsFetched_(entitlements);\n      return entitlements;\n    });\n  }\n\n  /**\n   * @param {!GetEntitlementsParamsExternalDef=} params\n   * @return {!Promise<!Entitlements>}\n   * @private\n   */\n  fetchEntitlementsWithCaching_(params) {\n    return Promise.all([\n      this.storage_.get(ENTS_STORAGE_KEY),\n      this.storage_.get(IS_READY_TO_PAY_STORAGE_KEY),\n    ]).then((cachedValues) => {\n      const raw = cachedValues[0];\n      const irtp = cachedValues[1];\n      // Try cache first.\n      const needsDecryption = !!(params && params.encryption);\n      if (raw && !needsDecryption) {\n        const cached = this.getValidJwtEntitlements_(\n          raw,\n          /* requireNonExpired */ true,\n          irtpStringToBoolean(irtp)\n        );\n        if (cached && cached.enablesThis()) {\n          // Already have a positive response.\n          this.positiveRetries_ = 0;\n          return cached;\n        }\n      }\n      // If cache didn't match, perform fetch.\n      return this.fetchEntitlements_(params).then((ents) => {\n        // If the product is enabled by cacheable entitlements, store them in cache.\n        if (ents && ents.enablesThisWithCacheableEntitlements() && ents.raw) {\n          this.storage_.set(ENTS_STORAGE_KEY, ents.raw);\n        }\n        return ents;\n      });\n    });\n  }\n\n  /**\n   * @param {!GetEntitlementsParamsExternalDef=} params\n   * @return {!Promise<!Entitlements>}\n   * @private\n   */\n  fetchEntitlements_(params) {\n    // TODO(dvoytenko): Replace retries with consistent fetch.\n    let positiveRetries = this.positiveRetries_;\n    this.positiveRetries_ = 0;\n    const attempt = () => {\n      positiveRetries--;\n      return this.fetch_(params).then((entitlements) => {\n        if (entitlements.enablesThis() || positiveRetries <= 0) {\n          return entitlements;\n        }\n        return new Promise((resolve) => {\n          this.win_.setTimeout(() => {\n            resolve(attempt());\n          }, 550);\n        });\n      });\n    };\n    return attempt();\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setToastShown(value) {\n    this.storage_.set(TOAST_STORAGE_KEY, value ? '1' : '0');\n  }\n\n  /**\n   */\n  blockNextNotification() {\n    this.blockNextNotification_ = true;\n  }\n\n  /**\n   */\n  unblockNextNotification() {\n    this.blockNextNotification_ = false;\n  }\n\n  /**\n   * The JSON must either contain a \"signedEntitlements\" with JWT, or\n   * \"entitlements\" field with plain JSON object.\n   * @param {!Object} json\n   * @return {!Entitlements}\n   */\n  parseEntitlements(json) {\n    const isReadyToPay = json['isReadyToPay'];\n    if (isReadyToPay == null) {\n      this.storage_.remove(IS_READY_TO_PAY_STORAGE_KEY);\n    } else {\n      this.storage_.set(IS_READY_TO_PAY_STORAGE_KEY, String(isReadyToPay));\n    }\n    const signedData = json['signedEntitlements'];\n    const decryptedDocumentKey = json['decryptedDocumentKey'];\n    const swgUserToken = json['swgUserToken'];\n    if (signedData) {\n      const entitlements = this.getValidJwtEntitlements_(\n        signedData,\n        /* requireNonExpired */ false,\n        isReadyToPay,\n        decryptedDocumentKey\n      );\n      if (entitlements) {\n        this.saveSwgUserToken_(swgUserToken);\n        return entitlements;\n      }\n    } else {\n      const plainEntitlements = json['entitlements'];\n      if (plainEntitlements) {\n        this.saveSwgUserToken_(swgUserToken);\n        return this.createEntitlements_(\n          '',\n          plainEntitlements,\n          isReadyToPay,\n          decryptedDocumentKey\n        );\n      }\n    }\n    // Empty response.\n    return this.createEntitlements_('', [], isReadyToPay);\n  }\n\n  /**\n   * Persist swgUserToken in local storage if entitlements and swgUserToken exist\n   * @param {?string|undefined} swgUserToken\n   * @private\n   */\n  saveSwgUserToken_(swgUserToken) {\n    if (swgUserToken) {\n      this.storage_.set(Constants$1.USER_TOKEN, swgUserToken, true);\n    }\n  }\n\n  /**\n   * @param {string} raw\n   * @param {boolean} requireNonExpired\n   * @param {boolean=} isReadyToPay\n   * @param {?string=} decryptedDocumentKey\n   * @return {?Entitlements}\n   * @private\n   */\n  getValidJwtEntitlements_(\n    raw,\n    requireNonExpired,\n    isReadyToPay,\n    decryptedDocumentKey\n  ) {\n    try {\n      const jwt = this.jwtHelper_.decode(raw);\n      if (requireNonExpired) {\n        const now = Date.now();\n        const exp = jwt['exp'];\n        if (parseFloat(exp) * 1000 < now) {\n          return null;\n        }\n      }\n      const entitlementsClaim = jwt['entitlements'];\n      return (\n        (entitlementsClaim &&\n          this.createEntitlements_(\n            raw,\n            entitlementsClaim,\n            isReadyToPay,\n            decryptedDocumentKey\n          )) ||\n        null\n      );\n    } catch (e) {\n      // Ignore the error.\n      this.win_.setTimeout(() => {\n        throw e;\n      });\n    }\n    return null;\n  }\n\n  /**\n   * @param {string} raw\n   * @param {!Object|!Array<!Object>} json\n   * @param {boolean=} isReadyToPay\n   * @param {?string=} decryptedDocumentKey\n   * @return {!Entitlements}\n   * @private\n   */\n  createEntitlements_(raw, json, isReadyToPay, decryptedDocumentKey) {\n    return new Entitlements(\n      SERVICE_ID,\n      raw,\n      Entitlement.parseListFromJson(json),\n      this.pageConfig_.getProductId(),\n      this.ack_.bind(this),\n      this.consume_.bind(this),\n      isReadyToPay,\n      decryptedDocumentKey\n    );\n  }\n\n  /**\n   * @param {!Entitlements} entitlements\n   * @private\n   */\n  onEntitlementsFetched_(entitlements) {\n    // Skip any notifications and toast if other flows are ongoing.\n    // TODO(dvoytenko): what's the right action when pay flow was canceled?\n    const blockNotification = this.blockNextNotification_;\n    this.blockNextNotification_ = false;\n    if (blockNotification) {\n      return;\n    }\n\n    // Notify on the received entitlements.\n    this.deps_\n      .callbacks()\n      .triggerEntitlementsResponse(Promise.resolve(entitlements));\n\n    const entitlement = entitlements.getEntitlementForThis();\n    if (!entitlement) {\n      this.deps_\n        .eventManager()\n        .logSwgEvent(AnalyticsEvent.EVENT_NO_ENTITLEMENTS, false);\n      return;\n    }\n    this.maybeShowToast_(entitlement);\n  }\n\n  /**\n   * @param {!Entitlement} entitlement\n   * @return {!Promise}\n   * @private\n   */\n  maybeShowToast_(entitlement) {\n    // Don't show toast for metering entitlements.\n    if (entitlement.source === GOOGLE_METERING_SOURCE) {\n      this.deps_\n        .eventManager()\n        .logSwgEvent(AnalyticsEvent.EVENT_HAS_METERING_ENTITLEMENTS, false);\n      return Promise.resolve();\n    }\n\n    const params = new EventParams();\n    params.setIsUserRegistered(true);\n\n    // Log unlock event.\n    const eventType =\n      entitlement.source === PRIVILEGED_SOURCE\n        ? AnalyticsEvent.EVENT_UNLOCKED_FOR_CRAWLER\n        : AnalyticsEvent.EVENT_UNLOCKED_BY_SUBSCRIPTION;\n    this.deps_.eventManager().logSwgEvent(eventType, false, params);\n\n    // Check if storage bit is set. It's only set by the `Entitlements.ack` method.\n    return this.storage_.get(TOAST_STORAGE_KEY).then((value) => {\n      const toastWasShown = value === '1';\n      if (toastWasShown) {\n        return;\n      }\n\n      // Show toast.\n      const source = entitlement.source || GOOGLE_METERING_SOURCE;\n      return new Toast(\n        this.deps_,\n        feUrl('/toastiframe'),\n        feArgs({\n          'publicationId': this.publicationId_,\n          'source': source,\n        })\n      ).open();\n    });\n  }\n\n  /**\n   * @param {!Entitlements} entitlements\n   * @private\n   */\n  ack_(entitlements) {\n    if (entitlements.getEntitlementForThis()) {\n      this.setToastShown(true);\n    }\n  }\n\n  /**\n   * @param {!Entitlements} entitlements\n   * @param {?Function=} onCloseDialog Called after the user closes the dialog.\n   * @private\n   */\n  consume_(entitlements, onCloseDialog) {\n    if (entitlements.enablesThisWithGoogleMetering()) {\n      const onConsumeCallback = () => {\n        if (onCloseDialog) {\n          onCloseDialog();\n        }\n        this.consumeMeter_(entitlements);\n      };\n      const showToast = this.getShowToastFromEntitlements_(entitlements);\n      if (showToast === false) {\n        // If showToast is explicitly false, call onConsumeCallback directly.\n        return onConsumeCallback();\n      }\n      const meterToastApi = new MeterToastApi(this.deps_);\n      meterToastApi.setOnConsumeCallback(onConsumeCallback);\n      return meterToastApi.start();\n    }\n  }\n\n  /**\n   * Gets the `showToast` value (or null/undefined if unavailable) from\n   * the Google metering entitlement details in the input entitlements.\n   * @param {!Entitlements} entitlements\n   * @return {boolean|undefined}\n   * @private\n   */\n  getShowToastFromEntitlements_(entitlements) {\n    const entitlement = entitlements.getEntitlementForThis();\n    if (!entitlement || entitlement.source !== GOOGLE_METERING_SOURCE) {\n      return;\n    }\n    try {\n      const meteringJwt = this.jwtHelper_.decode(entitlement.subscriptionToken);\n      return meteringJwt['metering'] && meteringJwt['metering']['showToast'];\n    } catch (e) {\n      // Ignore decoding errors.\n      return;\n    }\n  }\n\n  /**\n   * @param {!GetEntitlementsParamsExternalDef=} params\n   * @return {!Promise<!Entitlements>}\n   * @private\n   */\n  fetch_(params) {\n    // Get swgUserToken from getEntitlements params\n    const swgUserTokenParam = params?.encryption?.swgUserToken;\n    // Get swgUserToken from local storage if it is not in getEntitlements params\n    const swgUserTokenPromise = swgUserTokenParam\n      ? Promise.resolve(swgUserTokenParam)\n      : this.storage_.get(Constants$1.USER_TOKEN, true);\n\n    let url =\n      '/publication/' +\n      encodeURIComponent(this.publicationId_) +\n      '/entitlements';\n\n    return Promise.all([\n      hash(getCanonicalUrl(this.deps_.doc())),\n      swgUserTokenPromise,\n    ])\n      .then((values) => {\n        const hashedCanonicalUrl = values[0];\n        const swgUserToken = values[1];\n\n        url = addDevModeParamsToUrl(this.win_.location, url);\n\n        // Add encryption param.\n        if (params?.encryption) {\n          url = addQueryParam(\n            url,\n            'crypt',\n            params.encryption.encryptedDocumentKey\n          );\n        }\n\n        // Add swgUserToken param.\n        if (swgUserToken) {\n          url = addQueryParam(url, 'sut', swgUserToken);\n        }\n\n        // Add metering params.\n        if (\n          this.publicationId_ &&\n          params?.metering?.state &&\n          queryStringHasFreshGaaParams(this.win_.location.search)\n        ) {\n          const meteringStateId = params.metering.state.id;\n          if (\n            typeof meteringStateId === 'string' &&\n            meteringStateId.length > 0\n          ) {\n            /** @type {!GetEntitlementsParamsInternalDef} */\n            const encodableParams = {\n              metering: {\n                clientTypes: [MeterClientTypes.LICENSED_BY_GOOGLE],\n                owner: this.publicationId_,\n                resource: {\n                  hashedCanonicalUrl,\n                },\n                // Publisher provided state.\n                state: {\n                  id: meteringStateId,\n                  attributes: [],\n                },\n                token: this.getGaaToken_(),\n              },\n            };\n\n            // Collect attributes.\n            function collectAttributes({attributes, category}) {\n              if (!attributes) {\n                return;\n              }\n\n              const attributeNames = Object.keys(attributes);\n              attributeNames.forEach((attributeName) => {\n                const name = `${category}_${attributeName}`;\n                const timestamp = Number(attributes[attributeName].timestamp);\n\n                // Validate timestamp.\n                const timestampIsTooFarInTheFuture =\n                  timestamp > (Date.now() / 1000) * 2;\n                if (!timestamp || timestampIsTooFarInTheFuture) {\n                  warn(\n                    `SwG Entitlements: Please specify a Unix timestamp, in seconds, for the \"${attributeName}\" ${category} attribute. The timestamp you passed (${attributes[attributeName].timestamp}) looks invalid.`\n                  );\n                }\n\n                // Collect attribute.\n                encodableParams.metering.state.attributes.push({\n                  name,\n                  timestamp,\n                });\n              });\n            }\n            collectAttributes({\n              attributes: params.metering.state.standardAttributes,\n              category: 'standard',\n            });\n            collectAttributes({\n              attributes: params.metering.state.customAttributes,\n              category: 'custom',\n            });\n\n            // Encode params.\n            this.encodedParams_ = base64UrlEncodeFromBytes(\n              utf8EncodeSync(JSON.stringify(encodableParams))\n            );\n            url = addQueryParam(url, 'encodedParams', this.encodedParams_);\n          } else {\n            warn(\n              `SwG Entitlements: Please specify a metering state ID string, ideally a hash to avoid PII.`\n            );\n          }\n        }\n\n        // Build URL.\n        return serviceUrl(url);\n      })\n      .then((url) => {\n        this.deps_\n          .eventManager()\n          .logSwgEvent(AnalyticsEvent.ACTION_GET_ENTITLEMENTS, false);\n        return this.fetcher_.fetchCredentialedJson(url);\n      })\n      .then((json) => {\n        if (json.errorMessages && json.errorMessages.length > 0) {\n          json.errorMessages.forEach((errorMessage) => {\n            warn('SwG Entitlements: ' + errorMessage);\n          });\n        }\n        return this.parseEntitlements(json);\n      });\n  }\n}\n\n/**\n * Parses entitlement dev mode params from the given hash fragment and adds it\n * to the given URL.\n * @param {!Location} location\n * @param {string} url\n * @return {string}\n */\nfunction addDevModeParamsToUrl(location, url) {\n  const hashParams = parseQueryString(location.hash);\n  const devModeScenario = hashParams['swg.deventitlement'];\n  if (devModeScenario === undefined) {\n    return url;\n  }\n  return addQueryParam(url, 'devEnt', devModeScenario);\n}\n\n/**\n * Convert String value of isReadyToPay\n * (from JSON or Cache) to a boolean value.\n * @param {string} value\n * @return {boolean|undefined}\n * @private\n */\nfunction irtpStringToBoolean(value) {\n  switch (value) {\n    case 'true':\n      return true;\n    case 'false':\n      return false;\n    default:\n      return undefined;\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @private @const {!Array<string>} */\nconst allowedMethods_ = ['GET', 'POST'];\n\n/** @private @enum {number} Allowed fetch responses. */\nconst allowedFetchTypes_ = {\n  document: 1,\n  text: 2,\n};\n\n/**\n * A class that polyfills Fetch API.\n */\nclass Xhr {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n  }\n\n  /**\n   * We want to call `fetch_` unbound from any context since it could\n   * be either the native fetch or our polyfill.\n   *\n   * @param {string} input\n   * @param {!FetchInitDef} init\n   * @return {!Promise<!FetchResponse>|!Promise<!Response>}\n   * @private\n   */\n  fetch_(input, init) {\n    // TODO(avimehta): Should the requests go through when page is not visible?\n    assert(typeof input == 'string', 'Only URL supported: %s', input);\n    // In particular, Firefox does not tolerate `null` values for\n    // `credentials`.\n    const creds = init.credentials;\n    assert(\n      creds === undefined || creds == 'include' || creds == 'omit',\n      'Only credentials=include|omit support: %s',\n      creds\n    );\n    // Fallback to xhr polyfill since `fetch` api does not support\n    // responseType = 'document'. We do this so we don't have to do any parsing\n    // and document construction on the UI thread which would be expensive.\n    if (init.responseType == 'document') {\n      return fetchPolyfill(input, init);\n    }\n    return (this.win.fetch || fetchPolyfill).apply(null, arguments);\n  }\n\n  /**\n   * @param {string} input URL\n   * @param {?FetchInitDef} init Fetch options object.\n   * @return {!Promise<!FetchResponse>}\n   */\n  fetch(input, init) {\n    init = setupInit(init);\n    return this.fetch_(input, init)\n      .catch((reason) => {\n        /*\n         * If the domain is not valid for SwG we return 404 without\n         * CORS headers and the browser throws a CORS error.\n         * We include some helpful text in the message to point the\n         * publisher towards the real problem.\n         */\n        const targetOrigin = parseUrl(input).origin;\n        throw new Error(\n          `XHR Failed fetching (${targetOrigin}/...): (Note: a CORS error above may indicate that this domain is not configured for Subscribe with Google)`,\n          reason && reason.message\n        );\n      })\n      .then((response) => assertSuccess(response));\n  }\n}\n\n/**\n * Normalized method name by uppercasing.\n * @param {string|undefined} method\n * @return {string}\n * @private\n */\nfunction normalizeMethod_(method) {\n  if (method === undefined) {\n    return 'GET';\n  }\n  method = method.toUpperCase();\n\n  assert(\n    allowedMethods_.includes(method),\n    'Only one of %s is currently allowed. Got %s',\n    allowedMethods_.join(', '),\n    method\n  );\n\n  return method;\n}\n\n/**\n * Sets up and normalizes the FetchInitDef\n *\n * @param {?FetchInitDef=} init Fetch options object.\n * @param {string=} accept The HTTP Accept header value.\n * @return {!FetchInitDef}\n */\nfunction setupInit(init, accept) {\n  init = init || /** @type {FetchInitDef} */ ({});\n  init.method = normalizeMethod_(init.method);\n  init.headers = init.headers || {};\n  if (accept) {\n    init.headers['Accept'] = accept;\n  }\n  return init;\n}\n\n/**\n * A minimal polyfill of Fetch API. It only polyfills what we currently use.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n *\n * Notice that the \"fetch\" method itself is not exported as that would require\n * us to immediately support a much wide API.\n *\n * @param {string} input\n * @param {!FetchInitDef} init\n * @return {!Promise<!FetchResponse>}\n * @private Visible for testing\n */\nfunction fetchPolyfill(input, init) {\n  return new Promise(function (resolve, reject) {\n    const xhr = createXhrRequest(init.method || 'GET', input);\n\n    if (init.credentials == 'include') {\n      xhr.withCredentials = true;\n    }\n\n    if (init.responseType in allowedFetchTypes_) {\n      xhr.responseType = init.responseType;\n    }\n\n    if (init.headers) {\n      Object.keys(init.headers).forEach(function (header) {\n        xhr.setRequestHeader(header, init.headers[header]);\n      });\n    }\n\n    xhr.onreadystatechange = () => {\n      if (xhr.readyState < /* STATUS_RECEIVED */ 2) {\n        return;\n      }\n      if (xhr.status < 100 || xhr.status > 599) {\n        xhr.onreadystatechange = null;\n        reject(new Error(`Unknown HTTP status ${xhr.status}`));\n        return;\n      }\n\n      // TODO(dvoytenko): This is currently simplified: we will wait for the\n      // whole document loading to complete. This is fine for the use cases\n      // we have now, but may need to be reimplemented later.\n      if (xhr.readyState == /* COMPLETE */ 4) {\n        resolve(new FetchResponse(xhr));\n      }\n    };\n    xhr.onerror = () => {\n      reject(new Error('Network failure'));\n    };\n    xhr.onabort = () => {\n      reject(new Error('Request aborted'));\n    };\n\n    if (init.method == 'POST') {\n      xhr.send(init.body);\n    } else {\n      xhr.send();\n    }\n  });\n}\n\n/**\n * @param {string} method\n * @param {string} url\n * @return {!XMLHttpRequest}\n * @private\n */\nfunction createXhrRequest(method, url) {\n  const xhr = new XMLHttpRequest();\n  if ('withCredentials' in xhr) {\n    xhr.open(method, url, true);\n  } else {\n    throw new Error('CORS is not supported');\n  }\n  return xhr;\n}\n\n/**\n * If 415 or in the 5xx range.\n * @param {number} status\n */\nfunction isRetriable(status) {\n  return status == 415 || (status >= 500 && status < 600);\n}\n\n/**\n * Returns the response if successful or otherwise throws an error.\n * @param {!FetchResponse} response\n * @return {!Promise<!FetchResponse>}\n * @private Visible for testing\n */\nfunction assertSuccess(response) {\n  return new Promise((resolve) => {\n    if (response.ok) {\n      return resolve(response);\n    }\n\n    const {status} = response;\n    const err = new Error(`HTTP error ${status}`);\n    err.retriable = isRetriable(status);\n    // TODO(@jridgewell, #9448): Callers who need the response should\n    // skip processing.\n    err.response = response;\n    throw err;\n  });\n}\n\n/**\n * Response object in the Fetch API.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n */\nclass FetchResponse {\n  /**\n   * @param {!XMLHttpRequest} xhr\n   */\n  constructor(xhr) {\n    /** @private @const {!XMLHttpRequest} */\n    this.xhr_ = xhr;\n\n    /** @const {number} */\n    this.status = this.xhr_.status;\n\n    /** @const {boolean} */\n    this.ok = this.status >= 200 && this.status < 300;\n\n    /** @const {!FetchResponseHeaders} */\n    this.headers = new FetchResponseHeaders(xhr);\n\n    /** @type {boolean} */\n    this.bodyUsed = false;\n\n    /** @type {?ReadableStream} */\n    this.body = null;\n  }\n\n  /**\n   * Create a copy of the response and return it.\n   * @return {!FetchResponse}\n   */\n  clone() {\n    assert(!this.bodyUsed, 'Body already used');\n    return new FetchResponse(this.xhr_);\n  }\n\n  /**\n   * Drains the response and returns the text.\n   * @return {!Promise<string>}\n   * @private\n   */\n  drainText_() {\n    assert(!this.bodyUsed, 'Body already used');\n    this.bodyUsed = true;\n    return Promise.resolve(this.xhr_.responseText);\n  }\n\n  /**\n   * Drains the response and returns a promise that resolves with the response\n   * text.\n   * @return {!Promise<string>}\n   */\n  text() {\n    return this.drainText_();\n  }\n\n  /**\n   * Drains the response and returns the JSON object.\n   * @return {!Promise<!JsonObject>}\n   */\n  json() {\n    return /** @type {!Promise<!JsonObject>} */ (\n      this.drainText_().then(parseJson)\n    );\n  }\n\n  /**\n   * Drains the response and returns a promise that resolves with the response\n   * ArrayBuffer.\n   * @return {!Promise<!ArrayBuffer>}\n   */\n  arrayBuffer() {\n    return /** @type {!Promise<!ArrayBuffer>} */ (\n      this.drainText_().then(utf8EncodeSync)\n    );\n  }\n}\n\n/**\n * Provides access to the response headers as defined in the Fetch API.\n * @private Visible for testing.\n */\nclass FetchResponseHeaders {\n  /**\n   * @param {!XMLHttpRequest} xhr\n   */\n  constructor(xhr) {\n    /** @private @const {!XMLHttpRequest} */\n    this.xhr_ = xhr;\n  }\n\n  /**\n   * @param {string} name\n   * @return {?string}\n   */\n  get(name) {\n    return this.xhr_.getResponseHeader(name);\n  }\n\n  /**\n   * @param {string} name\n   * @return {boolean}\n   */\n  has(name) {\n    return this.xhr_.getResponseHeader(name) != null;\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @interface\n */\nclass Fetcher {\n  /**\n   * @param {string} unusedUrl\n   * @return {!Promise<!Object>}\n   */\n  fetchCredentialedJson(unusedUrl) {}\n\n  /**\n   * @param {string} unusedUrl\n   * @param {!../utils/xhr.FetchInitDef} unusedInit\n   * @return {!Promise<!../utils/xhr.FetchResponse>}\n   */\n  fetch(unusedUrl, unusedInit) {}\n\n  /**\n   * POST data to a URL endpoint, do not wait for a response.\n   * @param {!string} unusedUrl\n   * @param {!../proto/api_messages.Message} unusedData\n   */\n  sendBeacon(unusedUrl, unusedData) {}\n\n  /**\n   * POST data to a URL endpoint, get a Promise for a response\n   * @param {!string} unusedUrl\n   * @param {!../proto/api_messages.Message} unusedMessage\n   * @return {!Promise<!../utils/xhr.FetchResponse>}\n   */\n  sendPost(unusedUrl, unusedMessage) {}\n}\n\n/**\n * @implements {Fetcher}\n */\nclass XhrFetcher {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Xhr} */\n    this.xhr_ = new Xhr(win);\n  }\n\n  /** @override */\n  fetchCredentialedJson(url) {\n    const init = /** @type {!../utils/xhr.FetchInitDef} */ ({\n      method: 'GET',\n      headers: {'Accept': 'text/plain, application/json'},\n      credentials: 'include',\n    });\n    return this.fetch(url, init).then((response) => {\n      return response.text().then((text) => {\n        // Remove \"\")]}'\\n\" XSSI prevention prefix in safe responses.\n        const cleanedText = text.replace(/^(\\)\\]\\}'\\n)/, '');\n        return parseJson(cleanedText);\n      });\n    });\n  }\n\n  /** @override */\n  sendPost(url, message) {\n    const init = /** @type {!../utils/xhr.FetchInitDef} */ ({\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',\n      },\n      credentials: 'include',\n      body: 'f.req=' + serializeProtoMessageForUrl(message),\n    });\n    return this.fetch(url, init).then(\n      (response) => (response && response.json()) || {}\n    );\n  }\n\n  /** @override */\n  fetch(url, init) {\n    return this.xhr_.fetch(url, init);\n  }\n\n  /** @override */\n  sendBeacon(url, data) {\n    if (navigator.sendBeacon) {\n      const headers = {type: 'application/x-www-form-urlencoded;charset=UTF-8'};\n      const blob = new Blob(\n        ['f.req=' + serializeProtoMessageForUrl(data)],\n        headers\n      );\n      navigator.sendBeacon(url, blob);\n      return;\n    }\n    // Only newer browsers support beacon.  Fallback to standard XHR POST.\n    this.sendPost(url, data);\n  }\n}\n\n/**\n * Copyright 2021 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nclass GoogleAnalyticsEventListener {\n  /**\n   * @param {!./deps.DepsDef} deps\n   */\n  constructor(deps) {\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!./client-event-manager.ClientEventManager} */\n    this.eventManager_ = deps.eventManager();\n  }\n\n  /**\n   * Start listening to client events\n   */\n  start() {\n    this.eventManager_.registerEventListener(\n      this.handleClientEvent_.bind(this)\n    );\n  }\n\n  /**\n   *  Listens for new events from the events manager and logs appropriate events to Google Analytics.\n   * @param {!../api/client-event-manager-api.ClientEvent} event\n   */\n  handleClientEvent_(event) {\n    // Bail immediately if ga function doesn't exist in Window.\n    if (typeof this.win_.ga != 'function') {\n      return;\n    }\n    let subscriptionFlow = '';\n    if (event.additionalParameters) {\n      // additionalParameters isn't strongly typed so checking for both object and class notation.\n      subscriptionFlow =\n        event.additionalParameters.subscriptionFlow ||\n        event.additionalParameters.getSubscriptionFlow();\n    }\n    const gaEvent = analyticsEventToGoogleAnalyticsEvent(\n      event.eventType,\n      subscriptionFlow\n    );\n    if (gaEvent) {\n      this.win_.ga('send', 'event', gaEvent);\n    }\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n */\nclass JsError {\n  /**\n   * @param {!../model/doc.Doc} doc\n   */\n  constructor(doc) {\n    /** @private @const {!../model/doc.Doc} */\n    this.doc_ = doc;\n\n    /** @private @const {!Promise} */\n    this.microTask_ = Promise.resolve();\n  }\n\n  /**\n   * @param {...*} var_args\n   * @return {!Promise}\n   */\n  error(var_args) {\n    const args = Array.prototype.slice.call(arguments, 0);\n    return this.microTask_.then(() => {\n      const error = createErrorVargs.apply(null, args);\n      if (error.reported) {\n        return;\n      }\n      const img = this.doc_.getWin().document.createElement('img');\n      img.src =\n        'https://news.google.com/_/SubscribewithgoogleClientUi/jserror' +\n        '?error=' +\n        encodeURIComponent(String(error)) +\n        '&script=' +\n        encodeURIComponent('https://news.google.com/swg/js/v1/swg.js') +\n        '&line=' +\n        (error.lineNumber || 1) +\n        '&trace=' +\n        encodeURIComponent(error.stack);\n      // Appending this image to DOM is not necessary.\n      error.reported = true;\n    });\n  }\n}\n\n/**\n * @param {...*} var_args\n * @return {!Error}\n */\nfunction createErrorVargs(var_args) {\n  let error = null;\n  let message = '';\n  for (let i = 0; i < arguments.length; i++) {\n    const arg = arguments[i];\n    if (arg instanceof Error && !error) {\n      error = duplicateErrorIfNecessary(arg);\n    } else {\n      if (message) {\n        message += ' ';\n      }\n      message += arg;\n    }\n  }\n\n  if (!error) {\n    error = new Error(message);\n  } else if (message) {\n    error.message = message + ': ' + error.message;\n  }\n  return error;\n}\n\n/**\n * Some exceptions (DOMException, namely) have read-only message.\n * @param {!Error} error\n * @return {!Error}\n */\nfunction duplicateErrorIfNecessary(error) {\n  const messageProperty = Object.getOwnPropertyDescriptor(error, 'message');\n  if (messageProperty && messageProperty.writable) {\n    return error;\n  }\n\n  const {message, stack} = error;\n  const e = new Error(message);\n  // Copy all the extraneous things we attach.\n  for (const prop in error) {\n    e[prop] = error[prop];\n  }\n  // Ensure these are copied.\n  e.stack = stack;\n  return e;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst LINK_REQUEST_ID = 'swg-link';\n\n/**\n * The flow to link an existing publisher account to an existing google account.\n */\nclass LinkbackFlow {\n  /**\n   * @param {!./deps.DepsDef} deps\n   */\n  constructor(deps) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../model/page-config.PageConfig} */\n    this.pageConfig_ = deps.pageConfig();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n  }\n\n  /**\n   * Starts the Link account flow.\n   * @param {{ampReaderId: (string|undefined)}=} params\n   * @return {!Promise}\n   */\n  start(params = {}) {\n    this.deps_.callbacks().triggerFlowStarted(SubscriptionFlows.LINK_ACCOUNT);\n    const forceRedirect =\n      this.deps_.config().windowOpenMode == WindowOpenMode.REDIRECT;\n    const args = params.ampReaderId\n      ? feArgs({\n          'publicationId': this.pageConfig_.getPublicationId(),\n          'ampReaderId': params.ampReaderId,\n        })\n      : feArgs({\n          'publicationId': this.pageConfig_.getPublicationId(),\n        });\n    const opener = this.activityPorts_.open(\n      LINK_REQUEST_ID,\n      feUrl('/linkbackstart'),\n      forceRedirect ? '_top' : '_blank',\n      args,\n      {}\n    );\n    this.deps_.eventManager().logSwgEvent(AnalyticsEvent.IMPRESSION_LINK);\n    this.dialogManager_.popupOpened(opener && opener.targetWin);\n    return Promise.resolve();\n  }\n}\n\n/**\n * The class for Link accounts flow.\n */\nclass LinkCompleteFlow {\n  /**\n   * @param {!./deps.DepsDef} deps\n   */\n  static configurePending(deps) {\n    /**\n     * Handler function.\n     * @param {!../components/activities.ActivityPortDef} port\n     */\n    function handler(port) {\n      deps.entitlementsManager().blockNextNotification();\n      deps.callbacks().triggerLinkProgress();\n      deps.dialogManager().popupClosed();\n      const promise = acceptPortResultData(\n        port,\n        feOrigin(),\n        /* requireOriginVerified */ false,\n        /* requireSecureChannel */ false\n      );\n      return promise.then(\n        (response) => {\n          deps\n            .eventManager()\n            .logSwgEvent(AnalyticsEvent.ACTION_LINK_CONTINUE, true);\n          const flow = new LinkCompleteFlow(deps, response);\n          flow.start();\n        },\n        (reason) => {\n          if (isCancelError(reason)) {\n            deps\n              .eventManager()\n              .logSwgEvent(AnalyticsEvent.ACTION_LINK_CANCEL, true);\n            deps\n              .callbacks()\n              .triggerFlowCanceled(SubscriptionFlows.LINK_ACCOUNT);\n          } else {\n            // The user chose to continue but there was an error.\n            deps\n              .eventManager()\n              .logSwgEvent(AnalyticsEvent.ACTION_LINK_CONTINUE, true);\n          }\n        }\n      );\n    }\n    deps.activities().onResult(LINK_REQUEST_ID, handler);\n  }\n\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {?Object} response\n   */\n  constructor(deps, response) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!./client-config-manager.ClientConfigManager} */\n    this.clientConfigManager_ = deps.clientConfigManager();\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    /** @private @const {!./entitlements-manager.EntitlementsManager} */\n    this.entitlementsManager_ = deps.entitlementsManager();\n\n    /** @private @const {!./callbacks.Callbacks} */\n    this.callbacks_ = deps.callbacks();\n\n    const index = (response && response['index']) || '0';\n\n    /** @private {?ActivityIframeView} */\n    this.activityIframeView_ = null;\n\n    /** @private @const {!Promise<!ActivityIframeView>} */\n    this.activityIframeViewPromise_ = this.clientConfigManager_\n      .getClientConfig()\n      .then(\n        (clientConfig) =>\n          new ActivityIframeView(\n            this.win_,\n            this.activityPorts_,\n            feUrl(\n              '/linkconfirmiframe',\n              {},\n              clientConfig.usePrefixedHostPath,\n              'u/' + index\n            ),\n            feArgs({\n              'productId': deps.pageConfig().getProductId(),\n              'publicationId': deps.pageConfig().getPublicationId(),\n            }),\n            /* shouldFadeBody */ true\n          )\n      );\n\n    /** @private {?function()} */\n    this.completeResolver_ = null;\n\n    /** @private @const {!Promise} */\n    this.completePromise_ = new Promise((resolve) => {\n      this.completeResolver_ = resolve;\n    });\n  }\n\n  /**\n   * Starts the Link account flow.\n   * @return {!Promise}\n   */\n  start() {\n    return this.activityIframeViewPromise_.then((activityIframeView) => {\n      this.activityIframeView_ = activityIframeView;\n\n      const promise = this.activityIframeView_.acceptResultAndVerify(\n        feOrigin(),\n        /* requireOriginVerified */ true,\n        /* requireSecureChannel */ true\n      );\n      promise\n        .then((response) => {\n          this.complete_(response);\n        })\n        .catch((reason) => {\n          // Rethrow async.\n          setTimeout(() => {\n            throw reason;\n          });\n        })\n        .then(() => {\n          // The flow is complete.\n          this.dialogManager_.completeView(this.activityIframeView_);\n        });\n      this.deps_\n        .eventManager()\n        .logSwgEvent(AnalyticsEvent.EVENT_GOOGLE_UPDATED, true);\n      this.deps_\n        .eventManager()\n        .logSwgEvent(AnalyticsEvent.IMPRESSION_GOOGLE_UPDATED, true);\n      return this.dialogManager_.openView(this.activityIframeView_);\n    });\n  }\n\n  /**\n   * @param {?Object} response\n   * @private\n   */\n  complete_(response) {\n    this.deps_\n      .eventManager()\n      .logSwgEvent(AnalyticsEvent.ACTION_GOOGLE_UPDATED_CLOSE, true);\n    this.callbacks_.triggerLinkComplete();\n    this.callbacks_.resetLinkProgress();\n    this.entitlementsManager_.setToastShown(true);\n    this.entitlementsManager_.unblockNextNotification();\n    this.entitlementsManager_.reset((response && response['success']) || false);\n    if (response && response['entitlements']) {\n      this.entitlementsManager_.pushNextEntitlements(response['entitlements']);\n    }\n    this.completeResolver_();\n  }\n\n  /** @return {!Promise} */\n  whenComplete() {\n    return this.completePromise_;\n  }\n}\n\n/**\n * The flow to save subscription information from an existing publisher account\n * to an existing google account.  The accounts may or may not already be\n * linked.\n */\nclass LinkSaveFlow {\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {!../api/subscriptions.SaveSubscriptionRequestCallback} callback\n   */\n  constructor(deps, callback) {\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    /** @private {!../api/subscriptions.SaveSubscriptionRequestCallback} */\n    this.callback_ = callback;\n\n    /** @private {?Promise<!../api/subscriptions.SaveSubscriptionRequest>} */\n    this.requestPromise_ = null;\n\n    /** @private {?Promise} */\n    this.openPromise_ = null;\n\n    /** @private {?ActivityIframeView} */\n    this.activityIframeView_ = null;\n  }\n\n  /**\n   * @return {?Promise<!../api/subscriptions.SaveSubscriptionRequest>}\n   * @package Visible for testing.\n   */\n  getRequestPromise() {\n    return this.requestPromise_;\n  }\n\n  /**\n   * @private\n   */\n  complete_() {\n    this.dialogManager_.completeView(this.activityIframeView_);\n  }\n\n  /**\n   * @param {!Object} result\n   * @return {!Promise<boolean>}\n   * @private\n   */\n  handleLinkSaveResponse_(result) {\n    // This flow is complete\n    this.complete_();\n    let startPromise;\n    let linkConfirm = null;\n    if (result['linked']) {\n      // When linking succeeds, start link confirmation flow\n      this.dialogManager_.popupClosed();\n      this.deps_.callbacks().triggerFlowStarted(SubscriptionFlows.LINK_ACCOUNT);\n      linkConfirm = new LinkCompleteFlow(this.deps_, result);\n      startPromise = linkConfirm.start();\n    } else {\n      startPromise = Promise.reject(createCancelError(this.win_, 'not linked'));\n    }\n    const completePromise = startPromise.then(() => {\n      this.deps_.callbacks().triggerLinkProgress();\n      return linkConfirm.whenComplete();\n    });\n\n    return completePromise.then(() => {\n      return true;\n    });\n  }\n\n  /**\n   * @param {LinkingInfoResponse} response\n   * @private\n   */\n  sendLinkSaveToken_(response) {\n    if (!response || !response.getRequested()) {\n      return;\n    }\n    this.requestPromise_ = new Promise((resolve) => resolve(this.callback_()))\n      .then((request) => {\n        const saveRequest = new LinkSaveTokenRequest();\n        if (request && request.token) {\n          if (request.authCode) {\n            throw new Error('Both authCode and token are available');\n          } else {\n            saveRequest.setToken(request.token);\n          }\n        } else if (request && request.authCode) {\n          saveRequest.setAuthCode(request.authCode);\n        } else {\n          throw new Error('Neither token or authCode is available');\n        }\n        this.activityIframeView_.execute(saveRequest);\n        return request;\n      })\n      .catch((reason) => {\n        // The flow is complete.\n        this.complete_();\n        throw reason;\n      });\n  }\n\n  /**\n   * @return {?Promise}\n   */\n  /**\n   * Starts the save subscription\n   * @return {!Promise}\n   */\n  start() {\n    const iframeArgs = this.activityPorts_.addDefaultArguments({\n      'isClosable': true,\n    });\n    this.activityIframeView_ = new ActivityIframeView(\n      this.win_,\n      this.activityPorts_,\n      feUrl('/linksaveiframe'),\n      iframeArgs,\n      /* shouldFadeBody */ false,\n      /* hasLoadingIndicator */ true\n    );\n    this.activityIframeView_.on(\n      LinkingInfoResponse,\n      this.sendLinkSaveToken_.bind(this)\n    );\n\n    this.openPromise_ = this.dialogManager_.openView(\n      this.activityIframeView_,\n      /* hidden */ true\n    );\n    this.deps_\n      .eventManager()\n      .logSwgEvent(AnalyticsEvent.IMPRESSION_SAVE_SUBSCR_TO_GOOGLE);\n    /** {!Promise<boolean>} */\n    return this.activityIframeView_\n      .acceptResultAndVerify(\n        feOrigin(),\n        /* requireOriginVerified */ true,\n        /* requireSecureChannel */ true\n      )\n      .then((result) => {\n        return this.handleLinkSaveResponse_(result);\n      })\n      .catch((reason) => {\n        // In case this flow wasn't complete, complete it here\n        this.complete_();\n        // Handle cancellation from user, link confirm start or completion here\n        if (isCancelError(reason)) {\n          this.deps_\n            .eventManager()\n            .logSwgEvent(\n              AnalyticsEvent.ACTION_SAVE_SUBSCR_TO_GOOGLE_CANCEL,\n              true\n            );\n          this.deps_\n            .callbacks()\n            .triggerFlowCanceled(SubscriptionFlows.LINK_ACCOUNT);\n          return false;\n        }\n        throw reason;\n      });\n  }\n}\n\n/**\n * Copyright 2019 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @implements {../api/logger-api.LoggerApi}\n */\nclass Logger {\n  /**\n   * @param {!./deps.DepsDef} deps\n   */\n  constructor(deps) {\n    /** @private @const {!../api/client-event-manager-api.ClientEventManagerApi} */\n    this.eventManager_ = deps.eventManager();\n  }\n\n  /** @override */\n  sendSubscriptionState(state, jsonProducts) {\n    if (!isEnumValue(SubscriptionState, state)) {\n      throw new Error('Invalid subscription state provided');\n    }\n    if (\n      (SubscriptionState.SUBSCRIBER == state ||\n        SubscriptionState.PAST_SUBSCRIBER == state) &&\n      !jsonProducts\n    ) {\n      throw new Error(\n        'Entitlements must be provided for users with' +\n          ' active or expired subscriptions'\n      );\n    }\n    if (jsonProducts && !isObject(jsonProducts)) {\n      throw new Error('Entitlements must be an Object');\n    }\n    let productsOrSkus = null;\n    if (jsonProducts) {\n      productsOrSkus = JSON.stringify(jsonProducts);\n    }\n    this.eventManager_.logEvent({\n      eventType: AnalyticsEvent.EVENT_SUBSCRIPTION_STATE,\n      eventOriginator: EventOriginator.PUBLISHER_CLIENT,\n      isFromUserAction: null,\n      additionalParameters: {\n        state,\n        productsOrSkus,\n      },\n    });\n  }\n\n  /** @override */\n  sendEvent(userEvent) {\n    let data = null;\n    if (\n      !isEnumValue(Event, userEvent.name) ||\n      !publisherEventToAnalyticsEvent(userEvent.name)\n    ) {\n      throw new Error('Invalid user event provided(' + userEvent.name + ')');\n    }\n\n    if (userEvent.data) {\n      if (!isObject(userEvent.data)) {\n        throw new Error('Event data must be an Object(' + userEvent.data + ')');\n      } else {\n        data = Object.assign({}, data, userEvent.data);\n      }\n    }\n\n    if (isBoolean(userEvent.active)) {\n      if (!data) {\n        data = {};\n      }\n      Object.assign(data, {'is_active': userEvent.active});\n    } else if (userEvent.active != null) {\n      throw new Error('Event active must be a boolean');\n    }\n    this.eventManager_.logEvent({\n      eventType: publisherEventToAnalyticsEvent(userEvent.name),\n      eventOriginator: EventOriginator.PUBLISHER_CLIENT,\n      isFromUserAction: userEvent.active,\n      additionalParameters: data,\n    });\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nclass LoginNotificationApi {\n  /**\n   * @param {!./deps.DepsDef} deps\n   */\n  constructor(deps) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    /** @private {?Promise} */\n    this.openViewPromise_ = null;\n\n    /** @private @const {!ActivityIframeView} */\n    this.activityIframeView_ = new ActivityIframeView(\n      this.win_,\n      this.activityPorts_,\n      feUrl('/loginiframe'),\n      feArgs({\n        publicationId: deps.pageConfig().getPublicationId(),\n        productId: deps.pageConfig().getProductId(),\n        // No need to ask the user. Just tell them you're logging them in.\n        userConsent: false,\n      }),\n      /* shouldFadeBody */ true\n    );\n  }\n\n  /**\n   * Continues the Login flow (after waiting).\n   * @return {!Promise}\n   */\n  start() {\n    this.deps_\n      .callbacks()\n      .triggerFlowStarted(SubscriptionFlows.SHOW_LOGIN_NOTIFICATION);\n\n    this.openViewPromise_ = this.dialogManager_.openView(\n      this.activityIframeView_\n    );\n\n    return this.activityIframeView_.acceptResult().then(\n      () => {\n        // The consent part is complete.\n        this.dialogManager_.completeView(this.activityIframeView_);\n      },\n      (reason) => {\n        this.dialogManager_.completeView(this.activityIframeView_);\n        throw reason;\n      }\n    );\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nclass LoginPromptApi {\n  /**\n   * @param {!./deps.DepsDef} deps\n   */\n  constructor(deps) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    /** @private {?Promise} */\n    this.openViewPromise_ = null;\n\n    /** @private @const {!ActivityIframeView} */\n    this.activityIframeView_ = new ActivityIframeView(\n      this.win_,\n      this.activityPorts_,\n      feUrl('/loginiframe'),\n      feArgs({\n        publicationId: deps.pageConfig().getPublicationId(),\n        productId: deps.pageConfig().getProductId(),\n        // First ask the user if they want us to log them in.\n        userConsent: true,\n      }),\n      /* shouldFadeBody */ true\n    );\n  }\n\n  /**\n   * Prompts the user to login.\n   * @return {!Promise}\n   */\n  start() {\n    this.deps_\n      .callbacks()\n      .triggerFlowStarted(SubscriptionFlows.SHOW_LOGIN_PROMPT);\n\n    this.openViewPromise_ = this.dialogManager_.openView(\n      this.activityIframeView_\n    );\n\n    return this.activityIframeView_.acceptResult().then(\n      () => {\n        // The consent part is complete.\n        this.dialogManager_.completeView(this.activityIframeView_);\n      },\n      (reason) => {\n        if (isCancelError(reason)) {\n          this.deps_\n            .callbacks()\n            .triggerFlowCanceled(SubscriptionFlows.SHOW_LOGIN_PROMPT);\n        } else {\n          this.dialogManager_.completeView(this.activityIframeView_);\n        }\n        throw reason;\n      }\n    );\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nclass OffersApi {\n  /**\n   * @param {!../model/page-config.PageConfig} config\n   * @param {!./fetcher.Fetcher} fetcher\n   */\n  constructor(config, fetcher) {\n    /** @private @const {!../model/page-config.PageConfig} */\n    this.config_ = config;\n\n    /** @private @const {!./fetcher.Fetcher} */\n    this.fetcher_ = fetcher;\n  }\n\n  /**\n   * @param {?string=} productId\n   * @return {!Promise<!Array<!../api/offer.Offer>>}\n   */\n  getOffers(productId = this.config_.getProductId()) {\n    if (!productId) {\n      throw new Error('getOffers requires productId in config or arguments');\n    }\n    return this.fetch_(productId);\n  }\n\n  /**\n   * @param {string} productId\n   * @return {!Promise<!Array<!../api/offer.Offer>>}\n   * @private\n   */\n  fetch_(productId) {\n    const url = serviceUrl(\n      '/publication/' +\n        encodeURIComponent(this.config_.getPublicationId()) +\n        '/offers' +\n        '?label=' +\n        encodeURIComponent(productId)\n    );\n    // TODO(dvoytenko): switch to a non-credentialed request after launch.\n    return this.fetcher_.fetchCredentialedJson(url).then((json) => {\n      return json['offers'] || [];\n    });\n  }\n}\n\n/**\n * @license\n * Copyright 2018 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst MAX_Z_INDEX$1 = 2147483647;\n\nconst Constants = {};\n\n/**\n * Supported environments.\n *\n * @enum {string}\n */\nConstants.Environment = {\n  LOCAL: 'LOCAL',\n  PREPROD: 'PREPROD',\n  PRODUCTION: 'PRODUCTION',\n  SANDBOX: 'SANDBOX',\n  TEST: 'TEST',\n  TIN: 'TIN',\n};\n\n/**\n * Supported payment methods.\n *\n * @enum {string}\n */\nConstants.PaymentMethod = {\n  CARD: 'CARD',\n  TOKENIZED_CARD: 'TOKENIZED_CARD',\n  UPI: 'UPI',\n};\n\n/**\n * Auth methods.\n *\n * @enum {string}\n */\nConstants.AuthMethod = {\n  CRYPTOGRAM_3DS: 'CRYPTOGRAM_3DS',\n  PAN_ONLY: 'PAN_ONLY',\n};\n\n/**\n * Returned result status.\n *\n * @enum {string}\n */\nConstants.ResponseStatus = {\n  CANCELED: 'CANCELED',\n  DEVELOPER_ERROR: 'DEVELOPER_ERROR',\n};\n\n/**\n * Supported total price status.\n *\n * @enum {string}\n */\nConstants.TotalPriceStatus = {\n  ESTIMATED: 'ESTIMATED',\n  FINAL: 'FINAL',\n  NOT_CURRENTLY_KNOWN: 'NOT_CURRENTLY_KNOWN',\n};\n\n/**\n * Supported Google Pay payment button type.\n *\n * @enum {string}\n */\nConstants.ButtonType = {\n  SHORT: 'short',\n  LONG: 'long',\n};\n\n/**\n * Supported button colors.\n *\n * @enum {string}\n */\nConstants.ButtonColor = {\n  DEFAULT: 'default',  // Currently defaults to black.\n  BLACK: 'black',\n  WHITE: 'white',\n};\n\n/**\n * Id attributes.\n *\n * @enum {string}\n */\nConstants.Id = {\n  POPUP_WINDOW_CONTAINER: 'popup-window-container',\n};\n\n/** @const {string} */\nConstants.STORAGE_KEY_PREFIX = 'google.payments.api.storage';\n\n/** @const {string} */\nConstants.IS_READY_TO_PAY_RESULT_KEY =\n    Constants.STORAGE_KEY_PREFIX + '.isreadytopay.result';\n\n/** @const {string} */\nConstants.UPI_CAN_MAKE_PAYMENT_CACHE_KEY =\n    Constants.STORAGE_KEY_PREFIX + '.upi.canMakePaymentCache';\n\n\nConstants.CLASS_PREFIX = 'google-payments-';\nConstants.IFRAME_ACTIVE_CONTAINER_CLASS =\n    `${Constants.CLASS_PREFIX}activeContainer`;\nConstants.IFRAME_CONTAINER_CLASS = `${Constants.CLASS_PREFIX}dialogContainer`;\nConstants.IFRAME_STYLE_CENTER_CLASS = `${Constants.CLASS_PREFIX}dialogCenter`;\nConstants.IFRAME_STYLE_CLASS = `${Constants.CLASS_PREFIX}dialog`;\n\nConstants.IFRAME_STYLE = `\n.${Constants.IFRAME_STYLE_CLASS} {\n    animation: none 0s ease 0s 1 normal none running;\n    background: none 0 0 / auto repeat scroll padding-box border-box #fff;\n    background-blend-mode: normal;\n    border: 0 none #333;\n    border-radius: 8px 8px 0 0;\n    border-collapse: separate;\n    bottom: 0;\n    box-shadow: #808080 0 3px 0 0, #808080 0 0 22px;\n    box-sizing: border-box;\n    letter-spacing: normal;\n    max-height: 100%;\n    overflow: visible;\n    position: fixed;\n    width: 100%;\n    z-index: ${MAX_Z_INDEX$1};\n    -webkit-appearance: none;\n    left: 0;\n}\n@media (min-width: 480px) {\n  .${Constants.IFRAME_STYLE_CLASS} {\n    width: 480px !important;\n    left: -240px !important;\n    margin-left: calc(100vw - 100vw / 2) !important;\n  }\n}\n.${Constants.IFRAME_CONTAINER_CLASS} {\n  background-color: rgba(0,0,0,0.26);\n  bottom: 0;\n  height: 100%;\n  left: 0;\n  position: absolute;\n  right: 0;\n}\n.iframeContainer {\n  -webkit-overflow-scrolling: touch;\n}\n`;\n\nConstants.IFRAME_STYLE_CENTER = `\n.${Constants.IFRAME_STYLE_CENTER_CLASS} {\n  animation: none 0s ease 0s 1 normal none running;\n  background-blend-mode: normal;\n  background: none 0 0 / auto repeat scroll padding-box border-box #fff;\n  border-collapse: separate;\n  border-radius: 8px;\n  border: 0px none #333;\n  bottom: auto;\n  box-shadow: #808080 0 0 22px;\n  box-sizing: border-box;\n  left: -240px;\n  letter-spacing: normal;\n  margin-left: calc(100vw - 100vw / 2) !important;\n  max-height: 90%;\n  overflow: visible;\n  position: absolute;\n  top: 100%;\n  transform: scale(0.8);\n  width: 480px;\n  z-index: ${MAX_Z_INDEX$1};\n  -webkit-appearance: none;\n}\n@media (min-height: 667px) {\n  .${Constants.IFRAME_STYLE_CENTER_CLASS} {\n    max-height: 600px;\n  }\n}\n.${Constants.IFRAME_ACTIVE_CONTAINER_CLASS} {\n  top: 50%;\n  transform: scale(1.0) translateY(-50%);\n}\n`;\n\nConstants.GPAY_BUTTON_WITH_CARD_INFO_IMAGE =\n    'background-image: url(https://pay.google.com/gp/p/generate_gpay_btn_img);';\n\nConstants.BUTTON_LOCALE_TO_MIN_WIDTH = {\n  'en': 152,\n  'bg': 163,\n  'cs': 192,\n  'de': 183,\n  'es': 183,\n  'fr': 183,\n  'hr': 157,\n  'id': 186,\n  'ja': 148,\n  'ko': 137,\n  'ms': 186,\n  'nl': 167,\n  'pl': 182,\n  'pt': 193,\n  'ru': 206,\n  'sk': 157,\n  'sl': 211,\n  'sr': 146,\n  'tr': 161,\n  'uk': 207,\n  'zh': 156,\n};\n\n/**\n * Name of the graypane.\n *\n * @const {string}\n */\nConstants.GPAY_GRAYPANE = 'gpay-graypane';\n\n/**\n * Class used for the gpay button.\n *\n * @const {string}\n */\nConstants.GPAY_BUTTON_CLASS = 'gpay-button';\n\nConstants.BUTTON_STYLE = `\n.${Constants.GPAY_BUTTON_CLASS} {\n  background-origin: content-box;\n  background-position: center center;\n  background-repeat: no-repeat;\n  background-size: contain;\n  border: 0px;\n  border-radius: 4px;\n  box-shadow: rgba(60, 64, 67, 0.3) 0px 1px 1px 0px, rgba(60, 64, 67, 0.15) 0px 1px 3px 1px;\n  cursor: pointer;\n  height: 40px;\n  min-height: 40px;\n  padding: 11px 24px;\n}\n\n.${Constants.GPAY_BUTTON_CLASS}.black {\n  background-color: #000;\n  box-shadow: none;\n  padding: 12px 24px 10px;\n}\n\n.${Constants.GPAY_BUTTON_CLASS}.white {\n  background-color: #fff;\n}\n\n.${Constants.GPAY_BUTTON_CLASS}.short {\n  min-width: 90px;\n  width: 160px;\n}\n\n.${Constants.GPAY_BUTTON_CLASS}.black.short {\n  background-image: url(https://www.gstatic.com/instantbuy/svg/dark_gpay.svg);\n}\n\n.${Constants.GPAY_BUTTON_CLASS}.white.short {\n  background-image: url(https://www.gstatic.com/instantbuy/svg/light_gpay.svg);\n}\n\n.${Constants.GPAY_BUTTON_CLASS}.black.active {\n  background-color: #5f6368;\n}\n\n.${Constants.GPAY_BUTTON_CLASS}.black.hover {\n  background-color: #3c4043;\n}\n\n.${Constants.GPAY_BUTTON_CLASS}.white.active {\n  background-color: #fff;\n}\n\n.${Constants.GPAY_BUTTON_CLASS}.white.focus {\n  box-shadow: #e8e8e8 0 1px 1px 0, #e8e8e8 0 1px 3px;\n}\n\n.${Constants.GPAY_BUTTON_CLASS}.white.hover {\n  background-color: #f8f8f8;\n}\n`;\n\nConstants.GPAY_BUTTON_WITH_OFFER_ICON_ADDITIONAL_STYLE = 'position: relative;';\n\nConstants.GPAY_OFFER_ICON_CLASS = 'gpay-offer-icon';\n\nConstants.GPAY_OFFER_ICON_SVG =\n    \"<svg width=\\\"20px\\\" height=\\\"20px\\\" viewBox=\\\"0 0 20 20\\\" \" +\n    \"version=\\\"1.1\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\" xmlns:xlink=\" +\n    \"\\\"http://www.w3.org/1999/xlink\\\" class=\\\"gpay-offer-icon\\\"><defs><path d=\\\"M19.41,9.58 L10.41,0.58 \" +\n    \"C10.05,0.22 9.55,0 9,0 L2,0 C0.9,0 0,0.9 0,2 L0,9 C0,9.55 0.22,10.05 \" +\n    \"0.59,10.42 L9.59,19.42 C9.95,19.78 10.45,20 11,20 C11.55,20 12.05,19.78 \" +\n    \"12.41,19.41 L19.41,12.41 C19.78,12.05 20,11.55 20,11 C20,10.45 19.77,\" +\n    \"9.94 19.41,9.58 Z\\\" id=\\\"path-1\\\"></path></defs><g id=\\\"buttons_10.05\\\"\" +\n    \" stroke=\\\"none\\\" stroke-width=\\\"1\\\" fill=\\\"none\\\" fill-rule=\\\"evenodd\\\">\" +\n    \"<g id=\\\"Artboard\\\" transform=\\\"translate(-40.000000, -43.000000)\\\">\" +\n    \"<g id=\\\"Group-3\\\" transform=\\\"translate(40.000000, 43.000000)\\\">\" +\n    \"<g id=\\\"Group-2-Copy-2\\\"><g id=\\\"Group-Copy\\\"><g id=\\\"ic_loyalty_24px\\\">\" +\n    \"<mask id=\\\"mask-2\\\" fill=\\\"white\\\"><use xlink:href=\\\"#path-1\\\"></use>\" +\n    \"</mask><use id=\\\"gpay-Shape\\\" fill=\\\"#FF6100\\\" fill-rule=\\\"nonzero\\\" \" +\n    \"xlink:href=\\\"#path-1\\\"></use><path d=\\\"M3.5,5 C2.67,5 2,4.33 2,3.5 C2,\" +\n    \"2.67 2.67,2 3.5,2 C4.33,2 5,2.67 5,3.5 C5,4.33 4.33,5 3.5,5 Z\\\" \" +\n    \"id=\\\"Path\\\" fill=\\\"#FFFFFF\\\" fill-rule=\\\"nonzero\\\" mask=\\\"url(#mask-2)\\\">\" +\n    \"</path></g></g></g><g id=\\\"Group-13-Copy-7\\\" transform=\\\"translate\" +\n    \"(6.000000, 6.000000)\\\" fill=\\\"#FFFFFF\\\" fill-rule=\\\"nonzero\\\">\" +\n    \"<g id=\\\"Group-13-Copy-2\\\"><path d=\\\"M2.15217391,4.55172414 C0.963561082,\" +\n    \"4.55172414 1.99840144e-14,3.53278598 1.99840144e-14,2.27586207 \" +\n    \"C1.99840144e-14,1.01893816 0.963561082,6.30606678e-14 2.15217391,6.\" +\n    \"30606678e-14 C3.34078674,6.30606678e-14 4.30434783,1.01893816 4.30434783,\" +\n    \"2.27586207 C4.30434783,3.53278598 3.34078674,4.55172414 2.15217391,\" +\n    \"4.55172414 Z M2.15217391,3.31034483 C2.69245247,3.31034483 3.13043478,2.\" +\n    \"84719112 3.13043478,2.27586207 C3.13043478,1.70453302 2.69245247,\" +\n    \"1.24137931 2.15217391,1.24137931 C1.61189535,1.24137931 1.17391304,1\" +\n    \".70453302 1.17391304,2.27586207 C1.17391304,2.84719112 1.61189535,3.\" +\n    \"31034483 2.15217391,3.31034483 Z\\\" id=\\\"Combined-Shape\\\"></path>\" +\n    \"<path d=\\\"M6.84782609,9 C5.65921326,9 4.69565217,7.98106184 4.69565217,\" +\n    \"6.72413793 C4.69565217,5.46721402 5.65921326,4.44827586 6.84782609,\" +\n    \"4.44827586 C8.03643892,4.44827586 9,5.46721402 9,6.72413793 C9,7.98106184\" +\n    \" 8.03643892,9 6.84782609,9 Z M6.84782609,7.75862069 C7.38810465,\" +\n    \"7.75862069 7.82608696,7.29546698 7.82608696,6.72413793 C7.82608696\" +\n    \",6.15280888 7.38810465,5.68965517 6.84782609,5.68965517 C6.30754753,\" +\n    \"5.68965517 5.86956522,6.15280888 5.86956522,6.72413793 C5.86956522,\" +\n    \"7.29546698 6.30754753,7.75862069 6.84782609,7.75862069 Z\\\" \" +\n    \"id=\\\"Combined-Shape\\\"></path><polygon id=\\\"Rectangle\\\" \" +\n    \"transform=\\\"translate(4.497720, 4.541938) rotate(34.000000) \" +\n    \"translate(-4.497720, -4.541938) \\\" points=\\\"3.77901778 -0.202295978 \" +\n    \"4.9740273 -0.171019161 5.21642263 9.28617278 4.02141311 9.25489596\\\">\" +\n    \"</polygon></g></g></g></g></g></svg>\";\n\nConstants.GPAY_OFFER_ICON_STYLE = `\n.${Constants.GPAY_OFFER_ICON_CLASS} {\n  position: absolute;\n  right: -5px;\n  top: -5px;\n}\n\n#ic_loyalty_24px use.hover {\n  fill: #FC853B;\n}\n`;\n\nConstants.GPAY_OFFER_DESCRIPTION_CLASS = 'gpay-offer-description';\n\nConstants.GPAY_OFFER_DESCRIPTION_STYLE = `\n@import url(//fonts.googleapis.com/css?family=Google+Sans:500);\n.${Constants.GPAY_OFFER_DESCRIPTION_CLASS} {\n  text-align: center;\n  font: 10px 'Google Sans';\n  margin-top: 2px;\n  margin-bottom: 0px;\n}\n\n.${Constants.GPAY_OFFER_DESCRIPTION_CLASS}.gpay-btn-clicked {\n  color: #3C4043;\n}\n\n.${Constants.GPAY_OFFER_DESCRIPTION_CLASS}.short {\n  min-width: 90px;\n  width: 160px;\n}\n\n.${Constants.GPAY_OFFER_DESCRIPTION_CLASS}.long {\n  min-width: 152px;\n  width: 240px;\n}\n`;\n\n/**\n * Class used for the new gpay button with card info (last 4 digits, card net).\n *\n * @const {string}\n */\nConstants.GPAY_BUTTON_CARD_INFO_CLASS = 'gpay-card-info-btn';\n\nConstants.GPAY_BUTTON_CARD_INFO_BUTTON_STYLE = `\n  .${Constants.GPAY_BUTTON_CARD_INFO_CLASS} {\n    background-origin: content-box;\n    background-position: center center;\n    background-repeat: no-repeat;\n    background-size: contain;\n    border: 0px;\n    border-radius: 4px;\n    box-shadow: rgba(60, 64, 67, 0.3) 0px 1px 1px 0px, rgba(60, 64, 67, 0.15) 0px 1px 3px 1px;\n    cursor: pointer;\n    height: 40px;\n    min-height: 40px;\n    padding: 11px 24px;\n    background-color: #000;\n    box-shadow: none;\n    padding: 9px 24px 10px;\n    min-width: 190px;\n    width: 240px;\n  }\n\n  .${Constants.GPAY_BUTTON_CARD_INFO_CLASS}.active {\n    background-color: #5f6368;\n  }\n\n  .${Constants.GPAY_BUTTON_CARD_INFO_CLASS}.hover {\n    background-color: #3c4043;\n  }\n  `;\n\n\n/**\n * Trusted domain for secure context validation\n *\n * @const {string}\n */\nConstants.TRUSTED_DOMAIN = '.google.com';\n\n/**\n * @license\n * Copyright 2018 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Service wrapping window.parent.postMessage. This enables\n * window.postMessage to be swapped out in unit tests.\n */\nclass PostMessageService {\n  constructor(window) {\n    /** @private @const {!Window} */\n    this.window_ = window;\n  }\n\n  /**\n   * Passthrough to Window#postMessage. See Window#postMessage DOM API\n   * documentation for more information about arguments.\n   *\n   * @param {!Object} message\n   * @param {string} targetOrigin\n   */\n  postMessage(message, targetOrigin) {\n    this.window_.postMessage(message, targetOrigin);\n  }\n}\n\n/**\n * @license\n * Copyright 2018 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Supported interactions between iframe and merchant page.\n *\n * @enum {number}\n */\n// Next Id: 10\nconst PostMessageEventType = {\n  IS_READY_TO_PAY: 6,\n  LOG_BUTTON_CLICK: 5,\n  LOG_IS_READY_TO_PAY_API: 0,\n  LOG_LOAD_PAYMENT_DATA_API: 1,\n  LOG_RENDER_BUTTON: 2,\n  LOG_INITIALIZE_PAYMENTS_CLIENT: 9,\n  LOG_PAY_FRAME_REQUESTED: 15,\n  LOG_PAY_FRAME_LOADED: 16,\n  LOG_PAY_FRAME_LOADED_WITH_ALL_JS: 17,\n  LOG_INLINE_PAYMENT_WIDGET_INITIALIZE: 4,\n  LOG_INLINE_PAYMENT_WIDGET_SUBMIT: 3,\n  LOG_INLINE_PAYMENT_WIDGET_DISPLAYED: 7,\n  LOG_INLINE_PAYMENT_WIDGET_HIDDEN: 8,\n};\n\n/**\n * Types of buy flow activity modes.\n *\n * @enum {number}\n */\nconst BuyFlowActivityMode = {\n  UNKNOWN_MODE: 0,\n  IFRAME: 1,\n  POPUP: 2,\n  REDIRECT: 3,\n  ANDROID_NATIVE: 4,\n  PAYMENT_HANDLER: 5,\n};\n\n/**\n * Types of buy flow activity modes.\n *\n * @enum {number}\n */\nconst PublicErrorCode = {\n  UNKNOWN_ERROR_TYPE: 0,\n  INTERNAL_ERROR: 1,\n  DEVELOPER_ERROR: 2,\n  BUYER_ACCOUNT_ERROR: 3,\n  MERCHANT_ACCOUNT_ERROR: 4,\n  UNSUPPORTED_API_VERSION: 5,\n  BUYER_CANCEL: 6,\n};\n\n/**\n * The presentation mode of the buy flow\n *\n * @enum {number}\n */\nconst BuyFlowMode = {\n  PAY_WITH_GOOGLE: 5,\n  SUBSCRIBE_WITH_GOOGLE: 6,\n};\n\n/**\n * Iframe used for logging and prefetching.\n *\n * @type {?Element}\n */\nlet iframe = null;\n\n/** @type {?PostMessageService} */\nlet postMessageService = null;\n\n/** @type {?string} */\nlet environment = null;\n\n/** @type {?string} */\nlet googleTransactionId = null;\n\n/** @type {number} */\nlet originTimeMs = Date.now();\n\n/** @type {?BuyFlowActivityMode} */\nlet buyFlowActivityMode = null;\n\n/** @type {boolean} */\nlet iframeLoaded = false;\n\n/** @type {!Array<!Object>} */\nlet buffer = [];\n\nclass PayFrameHelper {\n  /**\n   * Creates a hidden iframe for logging and appends it to the top level\n   * document.\n   */\n  static load() {\n    if (iframe) {\n      return;\n    }\n    const initOptions =\n        /** @type {!PaymentOptions} */ (window['gpayInitParams']) || {};\n    environment = initOptions.environment || Constants.Environment.PRODUCTION;\n    iframe = document.createElement('iframe');\n    // Pass in origin because document.referrer inside iframe is empty in\n    // certain cases\n    // Can be replaced by iframe.src=... in non Google context.\n    iframe.src = PayFrameHelper.getIframeUrl_(\n            window.location.origin,\n            initOptions.merchantInfo && initOptions.merchantInfo.merchantId);\n    PayFrameHelper.postMessage({\n      'eventType': PostMessageEventType.LOG_PAY_FRAME_REQUESTED,\n      'clientLatencyStartMs': Date.now(),\n    });\n    iframe.height = '0';\n    iframe.width = '0';\n    iframe.style.display = 'none';\n    iframe.style.visibility = 'hidden';\n    iframe.onload = function() {\n      PayFrameHelper.postMessage({\n        'eventType': PostMessageEventType.LOG_PAY_FRAME_LOADED_WITH_ALL_JS,\n        'clientLatencyStartMs': Date.now(),\n      });\n      PayFrameHelper.iframeLoaded();\n    };\n    // If the body is already loaded, just append the iframe. Otherwise, we wait\n    // until the DOM has loaded to append the iframe, otherwise document.body is\n    // null.\n    if (document.body) {\n      PayFrameHelper.initialize_();\n    } else {\n      document.addEventListener(\n          'DOMContentLoaded', () => PayFrameHelper.initialize_());\n    }\n  }\n\n  /**\n   * Appends the iframe to the DOM and updates the post message service.\n   * @private\n   */\n  static initialize_() {\n    document.body.appendChild(iframe);\n    postMessageService = new PostMessageService(iframe.contentWindow);\n  }\n\n  /**\n   * Sends a message to the iframe and wait for a response.\n   * Uses the responseHandler specified only if the responseType is a match.\n   *\n   * @param {!Object} data\n   * @param {!PostMessageEventType} eventType\n   * @param {string} responseType\n   * @param {function(!Event)} responseHandler\n   */\n  static sendAndWaitForResponse(\n      data, eventType, responseType, responseHandler) {\n    function callback(event) {\n      if (event.data[responseType]) {\n        responseHandler(event);\n        // We only want to process the response from the payframe once.\n        // so stop listening to the event once processed.\n        PayFrameHelper.removeMessageEventListener_(callback);\n      }\n    }\n\n    PayFrameHelper.addMessageEventListener_(callback);\n\n    const postMessageData = Object.assign({'eventType': eventType}, data);\n    PayFrameHelper.postMessage(postMessageData);\n  }\n\n  /**\n   * Add an event listener for listening to messages received.\n   *\n   * @param {function(!Event)} callback\n   * @private\n   */\n  static addMessageEventListener_(callback) {\n    window.addEventListener('message', callback);\n  }\n\n  /**\n   * Remove the event listener for listening to messages.\n   *\n   * @param {function(!Event)} callback\n   * @private\n   */\n  static removeMessageEventListener_(callback) {\n    window.removeEventListener('message', callback);\n  }\n\n  /**\n   * Posts a message to the iframe with the given data.\n   *\n   * @param {!Object} data\n   */\n  static postMessage(data) {\n    if (!iframeLoaded) {\n      buffer.push(data);\n      return;\n    }\n    const postMessageData = Object.assign(\n        {\n          'buyFlowActivityMode': buyFlowActivityMode,\n          'googleTransactionId': googleTransactionId,\n          'originTimeMs': originTimeMs,\n        },\n        data);\n    postMessageService.postMessage(\n        postMessageData, PayFrameHelper.getIframeOrigin_());\n  }\n\n  /**\n   * Sets the activity mode.\n   *\n   * @param {!BuyFlowActivityMode} mode\n   */\n  static setBuyFlowActivityMode(mode) {\n    buyFlowActivityMode = mode;\n  }\n\n  /**\n   * Sets the google transaction id.\n   *\n   * @param {string} txnId\n   */\n  static setGoogleTransactionId(txnId) {\n    googleTransactionId = txnId;\n  }\n\n  /**\n   * Sets the originTimeMs. To be used only for tests.\n   *\n   * @param {number} originTimeMsTemp\n   */\n  static setOriginTimeMs(originTimeMsTemp) {\n    originTimeMs = originTimeMsTemp;\n  }\n\n  /**\n   * Override postMessageService for testing.\n   *\n   * @param {!PostMessageService} messageService\n   */\n  static setPostMessageService(messageService) {\n    postMessageService = messageService;\n  }\n\n  /**\n   * Clears the singleton variables.\n   */\n  static reset() {\n    iframe = null;\n    buffer.length = 0;\n    iframeLoaded = false;\n    buyFlowActivityMode = null;\n  }\n\n  /**\n   * Sets whether the iframe has been loaded or not.\n   *\n   * @param {boolean} loaded\n   */\n  static setIframeLoaded(loaded) {\n    iframeLoaded = loaded;\n  }\n\n  /**\n   * Called whenever the iframe is loaded.\n   */\n  static iframeLoaded() {\n    iframeLoaded = true;\n    buffer.forEach(function(data) {\n      PayFrameHelper.postMessage(data);\n    });\n    buffer.length = 0;\n  }\n\n  /**\n   * Returns the events that have been buffered.\n   *\n   * @return {!Array<!Object>}\n   */\n  static getBuffer() {\n    return buffer;\n  }\n\n  /**\n   * Mocks the iframe as an arbitrary html element instead of actually injecting\n   * it for testing.\n   */\n  static injectIframeForTesting() {\n    PayFrameHelper.reset();\n    iframe = document.createElement('p');\n    PayFrameHelper.iframeLoaded();\n  }\n\n  /**\n   * Returns the payframe origin based on the environment.\n   *\n   * @return {string}\n   * @private\n   */\n  static getIframeOrigin_() {\n    let iframeUrl = 'https://pay';\n    if (environment == Constants.Environment.SANDBOX) {\n      iframeUrl += '.sandbox';\n    } else if (environment == Constants.Environment.PREPROD) {\n      iframeUrl += '-preprod.sandbox';\n    }\n    return iframeUrl + '.google.com';\n  }\n\n  /**\n   * Returns the payframe URL based on the environment.\n   *\n   * @param {string} origin The origin that is opening the payframe.\n   * @param {string|null=} merchantId The merchant id.\n   * @return {string}\n   * @private\n   */\n  static getIframeUrl_(origin, merchantId) {\n    // TrustedResourceUrl header needs to start with https or '//'.\n    const iframeUrl = `https://pay${environment == Constants.Environment.PREPROD ?\n             '-preprod.sandbox' :\n             environment == Constants.Environment.SANDBOX ? '.sandbox' : ''}.google.com/gp/p/ui/payframe?origin=${origin}&mid=%{merchantId}`;\n    return iframeUrl;\n  }\n}\n\n/**\n * @license\n * Copyright 2018 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * An implementation of PaymentsClientDelegateInterface that leverages payment\n * request.\n * @implements {PaymentsClientDelegateInterface}\n */\nclass PaymentsRequestDelegate {\n  /**\n   * @param {string} environment\n   */\n  constructor(environment) {\n    this.environment_ = environment;\n\n    /** @private {?function(!Promise<!PaymentData>)} */\n    this.callback_ = null;\n  }\n\n  /** @override */\n  onResult(callback) {\n    this.callback_ = callback;\n  }\n\n  /** @override */\n  isReadyToPay(isReadyToPayRequest) {\n    /** @type{!PaymentRequest} */\n    const paymentRequest = this.createPaymentRequest_(isReadyToPayRequest);\n    return new Promise((resolve, reject) => {\n      paymentRequest.canMakePayment()\n          .then(result => {\n            window.sessionStorage.setItem(\n                Constants.IS_READY_TO_PAY_RESULT_KEY, result.toString());\n            const response = {'result': result};\n            if (isReadyToPayRequest.apiVersion >= 2 &&\n                isReadyToPayRequest.existingPaymentMethodRequired) {\n              // For apiVersion 2, we always use native to only check for\n              // tokenized cards.\n              // For tokenized cards native always does a presence check so\n              // we can say that if canMakePayment is true for native for\n              // tokenizedCards then the user has a payment method which is\n              // present.\n              response['paymentMethodPresent'] = result;\n            }\n            resolve(response);\n          })\n          .catch(function(err) {\n            if (window.sessionStorage.getItem(\n                    Constants.IS_READY_TO_PAY_RESULT_KEY)) {\n              resolve({\n                'result': window.sessionStorage.getItem(\n                              Constants.IS_READY_TO_PAY_RESULT_KEY) == 'true'\n              });\n            } else {\n              resolve({'result': false});\n            }\n          });\n    });\n  }\n\n  /** @override */\n  prefetchPaymentData(paymentDataRequest) {\n    // Creating PaymentRequest instance will call\n    // Gcore isReadyToPay internally which will prefetch tempaltes.\n    this.createPaymentRequest_(\n        paymentDataRequest, this.environment_,\n        paymentDataRequest.transactionInfo.currencyCode,\n        paymentDataRequest.transactionInfo.totalPrice);\n  }\n\n  /** @override */\n  loadPaymentData(paymentDataRequest) {\n    this.loadPaymentDataThroughPaymentRequest_(paymentDataRequest);\n  }\n\n  /**\n   * Create PaymentRequest instance.\n   *\n   * @param {!IsReadyToPayRequest|!PaymentDataRequest} request The necessary information to check if user is\n   *     ready to pay or to support a payment from merchants.\n   * @param {?string=} environment (optional)\n   * @param {?string=} currencyCode (optional)\n   * @param {?string=} totalPrice (optional)\n   * @return {!PaymentRequest} PaymentRequest instance.\n   * @private\n   */\n  createPaymentRequest_(request, environment, currencyCode, totalPrice) {\n    let data = {};\n    if (request) {\n      data = JSON.parse(JSON.stringify(request));\n    }\n\n    // Only set the apiVersion if the merchant doesn't set it.\n    if (!data['apiVersion']) {\n      data['apiVersion'] = 1;\n    }\n\n    // Add allowedPaymentMethods for swg to get through gms core validation.\n    if (data['swg']) {\n      data['allowedPaymentMethods'] = [Constants.PaymentMethod.CARD];\n    }\n\n    if (environment && environment == Constants.Environment.TEST) {\n      data['environment'] = environment;\n    }\n\n    const supportedInstruments = [{\n      'supportedMethods': ['https://google.com/pay'],\n      'data': data,\n    }];\n\n    const details = {\n      'total': {\n        'label': 'Estimated Total Price',\n        'amount': {\n          // currency and value are required fields in PaymentRequest, but these\n          // fields will never be used since PaymentRequest UI is skipped when\n          // we're the only payment method, so default to some value to by pass\n          // this requirement.\n          'currency': currencyCode || 'USD',\n          'value': totalPrice || '0',\n        }\n      }\n    };\n\n    return new PaymentRequest(supportedInstruments, details);\n  }\n\n  /**\n   * @param {!PaymentDataRequest} paymentDataRequest Provides necessary\n   *     information to support a payment.\n   * @private\n   */\n  loadPaymentDataThroughPaymentRequest_(paymentDataRequest) {\n    const currencyCode = (paymentDataRequest.transactionInfo &&\n                          paymentDataRequest.transactionInfo.currencyCode) ||\n        undefined;\n    const totalPrice = (paymentDataRequest.transactionInfo &&\n                        paymentDataRequest.transactionInfo.totalPrice) ||\n        undefined;\n    const paymentRequest = this.createPaymentRequest_(\n        paymentDataRequest, this.environment_, currencyCode, totalPrice);\n    this.callback_(\n        /** @type{!Promise<!PaymentData>} */\n        (paymentRequest.show()\n             .then(\n                 /**\n                  * @param {!PaymentResponse} paymentResponse\n                  * @return {!PaymentData}\n                  */\n                 (paymentResponse) => {\n                   // Should be called to dismiss any remaining UI\n                   paymentResponse.complete('success');\n                   return paymentResponse.details;\n                 })\n             .catch(function(err) {\n               err['statusCode'] = Constants.ResponseStatus.CANCELED;\n               throw err;\n             })));\n  }\n}\n\n/**\n * @license\n * Copyright 2018 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst MAX_Z_INDEX = 2147483647;\n\n\nclass Graypane {\n\n  /**\n   * @param {!Document} doc\n   */\n  constructor(doc) {\n    /** @private @const {!Document} */\n    this.doc_ = doc;\n\n    /** @private @const {!Element} */\n    this.element_ = doc.createElement(Constants.GPAY_GRAYPANE);\n    setImportantStyles(this.element_, {\n      'z-index': MAX_Z_INDEX,\n      'display': 'none',\n      'position': 'fixed',\n      'top': 0,\n      'right': 0,\n      'bottom': 0,\n      'left': 0,\n      'background-color': 'rgba(32, 33, 36, .6)',\n    });\n\n    /** @private {?Window} */\n    this.popupWindow_ = null;\n\n    this.element_.addEventListener('click', () => {\n      if (this.popupWindow_) {\n        try {\n          this.popupWindow_.focus();\n        } catch (e) {\n          // Ignore error.\n        }\n      }\n    });\n  }\n\n  /**\n   * Shows the graypane.\n   * @param {?Window|undefined} popupWindow\n   * @return {!Promise}\n   */\n  show(popupWindow) {\n    this.popupWindow_ = popupWindow || null;\n    this.doc_.body.appendChild(this.element_);\n    setImportantStyles(this.element_, {\n      'display': 'block',\n      'opacity': 0,\n    });\n    return transition(this.element_, {\n      'opacity': 1,\n    }, 300, 'ease-out');\n  }\n\n  /**\n   * Hides the graypane.\n   * @return {!Promise|undefined}\n   */\n  hide() {\n    this.popupWindow_ = null;\n    if (!this.element_.parentElement) {\n      // Has already been removed or haven't been even added to DOM.\n      // This could be possible after redirect.\n      return;\n    }\n    return transition(this.element_, {\n      'opacity': 0,\n    }, 300, 'ease-out').then(() => {\n      setImportantStyles(this.element_, {'display': 'none'});\n      this.doc_.body.removeChild(this.element_);\n    });\n  }\n}\n\n\n/**\n * Sets the CSS styles of the specified element with !important. The styles\n * are specified as a map from CSS property names to their values.\n *\n * The `!important` styles are used to avoid accidental specificity overrides\n * from the 3p page's stylesheet.\n *\n * @param {!Element} element\n * @param {!Object<string, string|number>} styles\n */\nfunction setImportantStyles(element, styles) {\n  for (const k in styles) {\n    element.style.setProperty(k, styles[k].toString(), 'important');\n  }\n}\n\n\n/**\n * Returns a promise which is resolved after the given duration of animation\n * @param {!Element} el - Element to be observed.\n * @param {!Object<string, string|number>} props - properties to be animated.\n * @param {number} durationMillis - duration of animation.\n * @param {string} curve - transition function for the animation.\n * @return {!Promise} Promise which resolves once the animation is done playing.\n */\nfunction transition(el, props, durationMillis, curve) {\n  const win = el.ownerDocument.defaultView;\n  const previousTransitionValue = el.style.transition || '';\n  return new Promise(resolve => {\n    win.setTimeout(() => {\n      win.setTimeout(resolve, durationMillis);\n      const tr = `${durationMillis}ms ${curve}`;\n      setImportantStyles(el, Object.assign({\n        'transition': `transform ${tr}, opacity ${tr}`,\n      }, props));\n    });\n  }).then(() => {\n    // Stop transition and make sure that the final properties get set.\n    setImportantStyles(el, Object.assign({\n      'transition': previousTransitionValue,\n    }, props));\n  });\n}\n\n/**\n * @license\n * Copyright 2018 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @return {boolean} true if this version of Chrome supports PaymentHandler.\n */\nfunction chromeSupportsPaymentHandler() {\n  // Check if feature is enabled for user\n  if (typeof google == 'undefined' ||\n      !null) {\n    return false;\n  }\n\n  // Payment handler isn't supported on mobile\n  const mobilePlatform = window.navigator.userAgent.match(\n      /Android|iPhone|iPad|iPod|BlackBerry|IEMobile/i);\n  if (mobilePlatform != null) {\n    return false;\n  }\n\n  const chromeVersion = window.navigator.userAgent.match(/Chrome\\/([0-9]+)\\./i);\n  return 'PaymentRequest' in window && chromeVersion != null &&\n      Number(chromeVersion[1]) >= 68 &&\n      window.navigator.vendor == 'Google Inc.';\n}\n\n/**\n * @return {boolean} true if this version of Chrome supports PaymentRequest.\n */\nfunction chromeSupportsPaymentRequest() {\n  // Opera uses chrome as rendering engine and sends almost the exact same\n  // user agent as chrome thereby fooling us on android.\n  const isOpera = window.navigator.userAgent.indexOf('OPR/') != -1;\n  if (isOpera) {\n    return false;\n  }\n  if (chromeSupportsPaymentHandler()) {\n    return true;\n  }\n\n  const androidPlatform = window.navigator.userAgent.match(/Android/i);\n  const chromeVersion = window.navigator.userAgent.match(/Chrome\\/([0-9]+)\\./i);\n  return androidPlatform != null && 'PaymentRequest' in window &&\n      // Make sure skipping PaymentRequest UI when only one PaymentMethod is\n      // supported (starts on Google Chrome 59).\n      window.navigator.vendor == 'Google Inc.' && chromeVersion != null &&\n      Number(chromeVersion[1]) >= 59;\n}\n\n/**\n * @param {!IsReadyToPayRequest} isReadyToPayRequest\n *\n * @return {boolean} true if the merchant only supports tokenized cards.\n */\nfunction doesMerchantSupportOnlyTokenizedCards(isReadyToPayRequest) {\n  if (isReadyToPayRequest.apiVersion >= 2) {\n    const allowedAuthMethods =\n        extractAllowedAuthMethodsForCards_(isReadyToPayRequest);\n    if (allowedAuthMethods && allowedAuthMethods.length == 1 &&\n        allowedAuthMethods[0] == Constants.AuthMethod.CRYPTOGRAM_3DS) {\n      return true;\n    }\n  }\n  return isReadyToPayRequest.allowedPaymentMethods.length == 1 &&\n      isReadyToPayRequest.allowedPaymentMethods[0] ==\n      Constants.PaymentMethod.TOKENIZED_CARD;\n}\n\n/**\n * @param {!IsReadyToPayRequest} isReadyToPayRequest\n * @param {Constants.AuthMethod} apiV2AuthMethod\n *\n * @return {boolean} true if the merchant supports pan cards.\n */\nfunction apiV2DoesMerchantSupportSpecifiedCardType(\n    isReadyToPayRequest, apiV2AuthMethod) {\n  if (isReadyToPayRequest.apiVersion >= 2) {\n    const allowedAuthMethods =\n        extractAllowedAuthMethodsForCards_(isReadyToPayRequest);\n    if (allowedAuthMethods && allowedAuthMethods.includes(apiV2AuthMethod)) {\n      return true;\n    }\n    return false;\n  }\n  return false;\n}\n\n/**\n * Validate if is secure context. Returns null if context is secure, otherwise\n * return error message.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts\n *\n * @return {?string} null if current context is secure, otherwise return error\n * message.\n */\nfunction validateSecureContext() {\n  if (window.location.hostname.endsWith(Constants.TRUSTED_DOMAIN)) {\n    // This is for local development.\n    return null;\n  }\n  if (window.isSecureContext === undefined) {\n    // Browser not support isSecureContext, figure out a way to validate this\n    // for the unsupported browser.\n    return null;\n  }\n  return window.isSecureContext ?\n      null :\n      'Google Pay APIs should be called in secure context!';\n}\n\n/**\n * Validate PaymentOptions.\n *\n * @param {!PaymentOptions} paymentOptions\n */\nfunction validatePaymentOptions(paymentOptions) {\n  if (paymentOptions.environment &&\n      !Object.values(Constants.Environment)\n           .includes(paymentOptions.environment)) {\n    throw new Error(\n        'Parameter environment in PaymentOptions can optionally be set to ' +\n        'PRODUCTION, otherwise it defaults to TEST. ' + paymentOptions.environment);\n  }\n}\n\n/**\n * Validate IsReadyToPayRequest.\n *\n * @param {!IsReadyToPayRequest} isReadyToPayRequest\n * @return {?string} errorMessage if the request is invalid.\n */\nfunction validateIsReadyToPayRequest(isReadyToPayRequest) {\n  if (!isReadyToPayRequest) {\n    return 'isReadyToPayRequest must be set!';\n  } else if (isReadyToPayRequest.apiVersion >= 2) {\n    if (!('apiVersionMinor' in isReadyToPayRequest)) {\n      return 'apiVersionMinor must be set!';\n    }\n    if (!isReadyToPayRequest.allowedPaymentMethods ||\n        !Array.isArray(isReadyToPayRequest.allowedPaymentMethods) ||\n        isReadyToPayRequest.allowedPaymentMethods.length == 0) {\n      return 'for v2 allowedPaymentMethods must be set to an array containing a list of accepted payment methods';\n    }\n    for (var i = 0; i < isReadyToPayRequest.allowedPaymentMethods.length; i++) {\n      let allowedPaymentMethod = isReadyToPayRequest.allowedPaymentMethods[i];\n      if (allowedPaymentMethod['type'] == Constants.PaymentMethod.CARD) {\n        if (!allowedPaymentMethod['parameters']) {\n          return 'Field parameters must be setup in each allowedPaymentMethod';\n        }\n        var allowedCardNetworks =\n            allowedPaymentMethod['parameters']['allowedCardNetworks'];\n        if (!allowedCardNetworks || !Array.isArray(allowedCardNetworks) ||\n            allowedCardNetworks.length == 0) {\n          return 'allowedCardNetworks must be setup in parameters for type CARD';\n        }\n        var allowedAuthMethods =\n            allowedPaymentMethod['parameters']['allowedAuthMethods'];\n        if (!allowedAuthMethods || !Array.isArray(allowedAuthMethods) ||\n            allowedAuthMethods.length == 0 ||\n            !allowedAuthMethods.every(isAuthMethodValid)) {\n          return 'allowedAuthMethods must be setup in parameters for type \\'CARD\\' ' +\n              ' and must contain \\'CRYPTOGRAM_3DS\\' and/or \\'PAN_ONLY\\'';\n        }\n      }\n    }\n    return null;\n  } else if (\n      !isReadyToPayRequest.allowedPaymentMethods ||\n      !Array.isArray(isReadyToPayRequest.allowedPaymentMethods) ||\n      isReadyToPayRequest.allowedPaymentMethods.length == 0 ||\n      !isReadyToPayRequest.allowedPaymentMethods.every(isPaymentMethodValid)) {\n    return 'allowedPaymentMethods must be set to an array containing \\'CARD\\' ' +\n        'and/or \\'TOKENIZED_CARD\\'!';\n  }\n  return null;\n}\n\n/**\n * Validate the payment method.\n *\n * @param {string} paymentMethod\n * @return {boolean} if the current payment method is valid.\n */\nfunction isPaymentMethodValid(paymentMethod) {\n  return Object.values(Constants.PaymentMethod).includes(paymentMethod);\n}\n\n/**\n * Validate the auth method.\n *\n * @param {string} authMethod\n * @return {boolean} if the current auth method is valid.\n */\nfunction isAuthMethodValid(authMethod) {\n  return Object.values(Constants.AuthMethod).includes(authMethod);\n}\n\n/**\n * Validate PaymentDataRequest.\n *\n * @param {!PaymentDataRequest} paymentDataRequest\n * @return {?string} errorMessage if the request is invalid.\n */\nfunction validatePaymentDataRequest(paymentDataRequest) {\n  if (!paymentDataRequest) {\n    return 'paymentDataRequest must be set!';\n  }\n  if (paymentDataRequest.swg) {\n    return validatePaymentDataRequestForSwg(paymentDataRequest.swg);\n  } else if (!paymentDataRequest.transactionInfo) {\n    return 'transactionInfo must be set!';\n  } else if (!paymentDataRequest.transactionInfo.currencyCode) {\n    return 'currencyCode in transactionInfo must be set!';\n  } else if (\n      !paymentDataRequest.transactionInfo.totalPriceStatus ||\n      !Object.values(Constants.TotalPriceStatus)\n           .includes(paymentDataRequest.transactionInfo.totalPriceStatus)) {\n    return 'totalPriceStatus in transactionInfo must be set to one of' +\n        ' NOT_CURRENTLY_KNOWN, ESTIMATED or FINAL!';\n  } else if (\n      paymentDataRequest.transactionInfo.totalPriceStatus !==\n          'NOT_CURRENTLY_KNOWN' &&\n      !paymentDataRequest.transactionInfo.totalPrice) {\n    return 'totalPrice in transactionInfo must be set when' +\n        ' totalPriceStatus is ESTIMATED or FINAL!';\n  }\n\n  // Validate payment data request for UPI payment method\n  const allowedPaymentMethod = getUpiPaymentMethod(paymentDataRequest);\n  if (allowedPaymentMethod) {\n    if (!allowedPaymentMethod['parameters']) {\n      return 'parameters must be set in allowedPaymentMethod!';\n    }\n\n    var parameters = allowedPaymentMethod['parameters'];\n    if (!parameters['payeeVpa']) {\n      return 'payeeVpa in allowedPaymentMethod parameters must be set!';\n    } else if (!parameters['payeeName']) {\n      return 'payeeName in allowedPaymentMethod parameters must be set!';\n    } else if (!parameters['referenceUrl']) {\n      return 'referenceUrl in allowedPaymentMethod parameters must be set!';\n    } else if (!parameters['mcc']) {\n      return 'mcc in allowedPaymentMethod parameters must be set!';\n    } else if (!parameters['transactionReferenceId']) {\n      return 'transactionReferenceId in allowedPaymentMethod parameters' +\n          ' must be set!';\n    }\n\n    if (paymentDataRequest['transactionInfo']['currencyCode'] !== 'INR') {\n      return 'currencyCode in transactionInfo must be set to INR!';\n    } else if (\n        paymentDataRequest['transactionInfo']['totalPriceStatus'] !== 'FINAL') {\n      return 'totalPriceStatus in transactionInfo must be set to FINAL!';\n    } else if (!paymentDataRequest['transactionInfo']['transactionNote']) {\n      return 'transactionNote in transactionInfo must be set!';\n    }\n  }\n  return null;\n}\n\n/**\n * Returns upi payment method object if it exists in allowed payment methods\n * or null if it doesn't\n *\n * @param {!IsReadyToPayRequest|!PaymentDataRequest} request\n * @return {?Object}\n */\nfunction getUpiPaymentMethod(request) {\n  if (!chromeSupportsPaymentRequest() || request.apiVersion < 2 ||\n      !request.allowedPaymentMethods) {\n    return null;\n  }\n  return getAllowedPaymentMethodForType_(request, Constants.PaymentMethod.UPI);\n}\n\n/**\n * Validate parameters for swg.\n *\n * @param {?SwgParameters} swgParameters\n * @return {?string} errorMessage if the request is invalid.\n */\nfunction validatePaymentDataRequestForSwg(swgParameters) {\n  if (!swgParameters) {\n    return 'Swg parameters must be provided';\n  }\n  if (!swgParameters.skuId || !swgParameters.publicationId) {\n    return 'Both skuId and publicationId must be provided';\n  }\n  return null;\n}\n\n/**\n * Returns the allowedAuthMethods for a card from the request.\n *\n * @param {!IsReadyToPayRequest} isReadyToPayRequest\n * @return {?Array<string>}\n * @private\n */\nfunction extractAllowedAuthMethodsForCards_(isReadyToPayRequest) {\n  if (isReadyToPayRequest.allowedPaymentMethods) {\n    const allowedPaymentMethod = getAllowedPaymentMethodForType_(\n        isReadyToPayRequest, Constants.PaymentMethod.CARD);\n    if (allowedPaymentMethod && allowedPaymentMethod.parameters) {\n      return allowedPaymentMethod.parameters['allowedAuthMethods'];\n    }\n  }\n  return null;\n}\n\n/**\n * @param {!IsReadyToPayRequest} isReadyToPayRequest\n * @param {string} paymentMethodType\n * @return {?PaymentMethod} Return first payment method for the given type,\n *     return null if not found.\n * @private\n */\nfunction getAllowedPaymentMethodForType_(\n    isReadyToPayRequest, paymentMethodType) {\n  for (var i = 0; i < isReadyToPayRequest.allowedPaymentMethods.length; i++) {\n    const allowedPaymentMethod = isReadyToPayRequest.allowedPaymentMethods[i];\n    if (allowedPaymentMethod.type == paymentMethodType) {\n      return allowedPaymentMethod;\n    }\n  }\n  return null;\n}\n\n/**\n * @license\n * Copyright 2018 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Injects the pay with google iframe.\n * @param {string} iframeClassName The classname of the iFrame wrapper.\n * @return {!{container: !Element, iframe:!HTMLIFrameElement}}\n */\nfunction injectIframe(iframeClassName) {\n  const container = document.createElement('div');\n  container.classList.add(Constants.IFRAME_CONTAINER_CLASS);\n  const iframeContainer = document.createElement('div');\n  iframeContainer.classList.add('iframeContainer');\n  /** @private @const {!HTMLIFrameElement} */\n  const iframe =\n      /** @type {!HTMLIFrameElement} */ (document.createElement('iframe'));\n  iframe.classList.add(iframeClassName);\n  iframe.setAttribute('frameborder', '0');\n  iframe.setAttribute('scrolling', 'no');\n  iframeContainer.appendChild(iframe);\n  container.appendChild(iframeContainer);\n  document.body.appendChild(container);\n  return {'container': container, 'iframe': iframe};\n}\n\n/**\n * @license\n * Copyright 2018 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst {\n  ActivityPort,\n  ActivityPorts,\n  ActivityIframePort,\n} = require('web-activities/activity-ports');\n\nconst GPAY_ACTIVITY_REQUEST = 'GPAY';\nconst IFRAME_CLOSE_DURATION_IN_MS = 250;\nconst IFRAME_SHOW_UP_DURATION_IN_MS = 250;\nconst IFRAME_SMOOTH_HEIGHT_TRANSITION = `height ${IFRAME_SHOW_UP_DURATION_IN_MS}ms`;\nconst ERROR_PREFIX = 'Error: ';\n\n/**\n * Supported browser user agent keys.\n *\n * @enum {string}\n */\nconst BrowserUserAgent = {\n  CHROME: 'Chrome',\n  FIREFOX: 'Firefox',\n  SAFARI: 'Safari',\n};\n\n/**\n * An implementation of PaymentsClientDelegateInterface that uses the custom\n * hosting page along with web activities to actually get to the hosting page.\n * @implements {PaymentsClientDelegateInterface}\n */\nclass PaymentsWebActivityDelegate {\n  /**\n   * @param {string} environment\n   * @param {string} googleTransactionId\n   * @param {boolean=} useIframe\n   * @param {!ActivityPorts=} activities Can be used to provide a shared\n   *   activities manager. By default, the new manager is created.\n   * @param {?string=} redirectKey The redirect key used for redirect mode.\n   */\n  constructor(\n    environment,\n    googleTransactionId,\n    useIframe,\n    activities,\n    redirectKey\n  ) {\n    this.environment_ = environment;\n    /** @private @const {boolean} */\n\n    /** @const {!ActivityPorts} */\n    this.activities = activities || new ActivityPorts(window);\n    /** @const @private {!Graypane} */\n    this.graypane_ = new Graypane(window.document);\n    /** @private {?function(!Promise<!PaymentData>)} */\n    this.callback_ = null;\n    /**\n     * @private {?{\n     *             container: !Element,\n     *             iframe:!HTMLIFrameElement,\n     *             request:!PaymentDataRequest,\n     *             dataPromise:?Promise<!PaymentData>}}\n     */\n    this.prefetchedObjects_ = null;\n    /** @private {boolean} */\n    this.shouldHandleResizing_ = false;\n    /** @private {?ActivityIframePort} */\n    this.port_ = null;\n    /** @private {?function(!Promise<void>)} */\n    this.dismissPromiseResolver_ = null;\n    /** @const @private {string} */\n    this.googleTransactionId_ = googleTransactionId;\n    /** @const @private {?string} */\n    this.redirectKey_ = redirectKey || null;\n\n    /**\n     * @private {?ResizePayload}\n     */\n    this.savedResizePayload_ = null;\n  }\n\n  /** @override */\n  onResult(callback) {\n    if (this.callback_) {\n      return;\n    }\n    this.callback_ = callback;\n    this.activities.onResult(\n      GPAY_ACTIVITY_REQUEST,\n      this.onActivityResult_.bind(this)\n    );\n  }\n\n  /**\n   * @param {!ActivityPort} port\n   * @private\n   */\n  onActivityResult_(port) {\n    // Hide the graypane.\n    this.graypane_.hide();\n    // Only verified origins are allowed.\n    this.callback_(\n      port.acceptResult().then(\n        (result) => {\n          // Origin must always match: popup, iframe or redirect.\n          if (result.origin != this.getOrigin_()) {\n            throw new Error('channel mismatch');\n          }\n          const data = /** @type {!PaymentData} */ (result.data);\n          if (data['redirectEncryptedCallbackData']) {\n            PayFrameHelper.setBuyFlowActivityMode(BuyFlowActivityMode.REDIRECT);\n            return this.fetchRedirectResponse_(\n              data['redirectEncryptedCallbackData']\n            ).then((decrypedJson) => {\n              // Merge other non-encrypted fields into the final response.\n              const clone = Object.assign({}, data);\n              delete clone['redirectEncryptedCallbackData'];\n              return Object.assign(clone, decrypedJson);\n            });\n          }\n          // Unencrypted data supplied: must be a verified and secure channel.\n          if (!result.originVerified || !result.secureChannel) {\n            throw new Error('channel mismatch');\n          }\n          return data;\n        },\n        (error) => {\n          // TODO: Log the original and the inferred error to eye3.\n          const originalError = error['message'];\n          let inferredError = error['message'];\n          try {\n            // Try to parse the error message to a structured error, if it's\n            // not possible, fallback to use the error message string.\n            inferredError = JSON.parse(\n              originalError.substring(ERROR_PREFIX.length)\n            );\n          } catch (e) {}\n          if (\n            inferredError['statusCode'] &&\n            ['DEVELOPER_ERROR', 'MERCHANT_ACCOUNT_ERROR'].indexOf(\n              inferredError['statusCode']\n            ) == -1\n          ) {\n            inferredError = {\n              'statusCode': 'CANCELED',\n            };\n          }\n          if (inferredError == 'AbortError') {\n            inferredError = {\n              'statusCode': 'CANCELED',\n            };\n          }\n          return Promise.reject(inferredError);\n        }\n      )\n    );\n  }\n\n  /**\n   * @param {string} redirectEncryptedCallbackData\n   * @return {!PaymentData}\n   * @private\n   */\n  fetchRedirectResponse_(redirectEncryptedCallbackData) {\n    // This method has to rely on the legacy XHR API because the redirect\n    // functionality is, in part, aimed at older browsers.\n    return new Promise((resolve, reject) => {\n      const url = this.getDecryptionUrl_();\n      const xhr = new XMLHttpRequest();\n      xhr.open('POST', url, true);\n      if ('withCredentials' in xhr) {\n        // It's fine to proceed in a non-redirect mode because redirectVerifier\n        // plays the part of CORS propagation.\n        xhr.withCredentials = true;\n      }\n\n      xhr.onreadystatechange = () => {\n        if (xhr.readyState < /* STATUS_RECEIVED */ 2) {\n          return;\n        }\n        if (xhr.status < 100 || xhr.status > 599) {\n          xhr.onreadystatechange = null;\n          reject(new Error(`Unknown HTTP status ${xhr.status}`));\n          return;\n        }\n        if (xhr.readyState == /* COMPLETE */ 4) {\n          try {\n            resolve(JSON.parse(xhr.responseText));\n          } catch (e) {\n            // JSON parsing error is expected here.\n            reject(e);\n          }\n        }\n      };\n      xhr.onerror = () => {\n        reject(new Error('Network failure'));\n      };\n      xhr.onabort = () => {\n        reject(new Error('Request aborted'));\n      };\n\n      // Send POST.\n      xhr.send(redirectEncryptedCallbackData);\n    });\n  }\n\n  /** @override */\n  isReadyToPay(isReadyToPayRequest) {\n    return new Promise((resolve, reject) => {\n      if (doesMerchantSupportOnlyTokenizedCards(isReadyToPayRequest)) {\n        resolve({'result': false});\n        return;\n      }\n      const userAgent = window.navigator.userAgent;\n      const isIosGsa =\n        userAgent.indexOf('GSA/') > 0 &&\n        userAgent.indexOf(BrowserUserAgent.SAFARI) > 0;\n      // pop up in IGSA doesn't work.\n      if (isIosGsa && !null) {\n        resolve({'result': false});\n        return;\n      }\n      const isFirefoxIos = userAgent.indexOf('FxiOS') > 0;\n      if (isFirefoxIos) {\n        resolve({'result': false});\n        return;\n      }\n      const isSupported =\n        userAgent.indexOf(BrowserUserAgent.CHROME) > 0 ||\n        userAgent.indexOf(BrowserUserAgent.FIREFOX) > 0 ||\n        userAgent.indexOf(BrowserUserAgent.SAFARI) > 0;\n      if (\n        isSupported &&\n        isReadyToPayRequest.apiVersion >= 2 &&\n        isReadyToPayRequest.existingPaymentMethodRequired\n      ) {\n        isReadyToPayRequest.environment = this.environment_;\n        PayFrameHelper.sendAndWaitForResponse(\n          isReadyToPayRequest,\n          PostMessageEventType.IS_READY_TO_PAY,\n          'isReadyToPayResponse',\n          function (event) {\n            const response = {\n              'result': isSupported,\n            };\n            if (isReadyToPayRequest.existingPaymentMethodRequired) {\n              response['paymentMethodPresent'] =\n                event.data['isReadyToPayResponse'] == 'READY_TO_PAY';\n            }\n            resolve(response);\n          }\n        );\n      } else {\n        resolve({'result': isSupported});\n      }\n    });\n  }\n\n  /** @override */\n  prefetchPaymentData(paymentDataRequest) {\n    // Only handles prefetch for iframe for now.\n    {\n      return;\n    }\n  }\n\n  /** @override */\n  loadPaymentData(paymentDataRequest) {\n    if (!paymentDataRequest.swg) {\n      // Only set the apiVersion if the merchant is not setting it.\n      if (!paymentDataRequest.apiVersion) {\n        paymentDataRequest.apiVersion = 1;\n      }\n    }\n    paymentDataRequest.environment = this.environment_;\n    PayFrameHelper.setBuyFlowActivityMode(\n      paymentDataRequest['forceRedirect']\n        ? BuyFlowActivityMode.REDIRECT\n        : BuyFlowActivityMode.POPUP\n    );\n    const opener = this.activities.open(\n      GPAY_ACTIVITY_REQUEST,\n      this.getHostingPageUrl_(),\n      this.getRenderMode_(paymentDataRequest),\n      paymentDataRequest,\n      {'width': 600, 'height': 600}\n    );\n    this.graypane_.show(opener && opener.targetWin);\n  }\n\n  /**\n   * Returns the render mode whether need to force redirect.\n   *\n   * @param {!PaymentDataRequest} paymentDataRequest\n   * @return {string}\n   * @private\n   */\n  getRenderMode_(paymentDataRequest) {\n    return paymentDataRequest['forceRedirect'] ? '_top' : 'gp-js-popup';\n  }\n\n  /**\n   * Returns the server origin based on the environment.\n   *\n   * @private\n   * @return {string}\n   */\n  getOrigin_() {\n    if (this.environment_ == Constants.Environment.LOCAL) {\n      return '';\n    }\n\n    let baseDomain;\n    if (this.environment_ == Constants.Environment.PREPROD) {\n      baseDomain = 'pay-preprod.sandbox';\n    } else if (this.environment_ == Constants.Environment.SANDBOX) {\n      baseDomain = 'pay.sandbox';\n    } else {\n      baseDomain = 'pay';\n    }\n    return 'https://' + baseDomain + '.google.com';\n  }\n\n  /**\n   * Returns the base path based on the environment.\n   *\n   * @private\n   * @return {string} The base path\n   */\n  getBasePath_() {\n    return this.getOrigin_() + '/gp/p';\n  }\n\n  /**\n   * Returns the decryption url to be used to decrypt the encrypted payload.\n   *\n   * @private\n   * @return {string} The decryption url\n   */\n  getDecryptionUrl_() {\n    let url = this.getBasePath_() + '/apis/buyflow/process';\n    if (this.redirectKey_) {\n      url += '?rk=' + encodeURIComponent(this.redirectKey_);\n    }\n    return url;\n  }\n\n  /**\n   * Returns the hosting page url.\n   *\n   * @private\n   * @return {string} The hosting page url\n   */\n  getHostingPageUrl_() {\n    // In Tin tests, the hosting page is requested from\n    // /testing/buyflow/merchantdemo.html and is accessed relatively since the\n    // base path is unknown ahead of time.\n    if (this.environment_ == Constants.Environment.TIN) {\n      // There is no /gp/p prefix since multilogin prefixes is broken in Tin:\n      // http://yaqs/4912322941550592\n      return '/ui/pay';\n    }\n    return this.getBasePath_() + '/ui/pay';\n  }\n\n  /**\n   * Returns the iframe pwg url to be used to be used for amp.\n   *\n   * @param {string} environment\n   * @param {string} origin\n   * @return {string} The iframe url\n   */\n  getIframeUrl(environment, origin) {\n    // TODO: These should be compile time constants and not dependent\n    // on the environment.\n    let iframeUrl = `https://pay.google.com/gp/p/ui/pay?origin=${origin}`;\n    if (\n      environment == Constants.Environment.SANDBOX ||\n      environment == Constants.Environment.PREPROD\n    ) {\n      iframeUrl = `https://pay'+  (environment == Constants.Environment.PREPROD ? '-preprod' : '')+  '.sandbox.google.com/gp/p/ui/pay?origin=${origin}`;\n    }\n    return iframeUrl;\n  }\n\n  /**\n   * Close iframe with animation.\n   *\n   * @param {!Element} container\n   * @param {!HTMLIFrameElement} iframe\n   * @private\n   */\n  removeIframeAndContainer_(container, iframe) {\n    const transitionStyle = 'all ' + IFRAME_CLOSE_DURATION_IN_MS + 'ms ease 0s';\n    this.setTransition_(iframe, transitionStyle);\n    iframe.height = '0px';\n    // TODO: This should be replaced by listening to TransitionEnd event\n    setTimeout(() => {\n      if (container.parentNode) {\n        container.parentNode.removeChild(container);\n      }\n    }, IFRAME_CLOSE_DURATION_IN_MS);\n  }\n\n  /**\n   * @param {!PaymentDataRequest} paymentDataRequest\n   * @return {{container: !Element, iframe:!HTMLIFrameElement}}\n   * @private\n   */\n  injectIframe_(paymentDataRequest) {\n    const containerAndFrame = injectIframe(\n      this.isVerticalCenterExperimentEnabled_(paymentDataRequest)\n        ? Constants.IFRAME_STYLE_CENTER_CLASS\n        : Constants.IFRAME_STYLE_CLASS\n    );\n    const iframe = containerAndFrame['iframe'];\n    const container = containerAndFrame['container'];\n    container.addEventListener(\n      'click',\n      this.closeActionHandler_.bind(this, containerAndFrame)\n    );\n    // Hide iframe and disable resize at initialize.\n    container.style.display = 'none';\n    iframe.style.display = 'none';\n    iframe.height = '0px';\n    const transitionStyle =\n      'all ' + IFRAME_SHOW_UP_DURATION_IN_MS + 'ms ease 0s';\n    this.setTransition_(iframe, transitionStyle);\n    this.shouldHandleResizing_ = false;\n    return containerAndFrame;\n  }\n\n  /**\n   * Handler when back button is triggered, should dismiss iframe if present.\n   * @param {{container: !Element, iframe:!HTMLIFrameElement}} containerAndFrame\n   * @private\n   */\n  backButtonHandler_(containerAndFrame) {\n    this.dismissIframe_(containerAndFrame);\n  }\n\n  /**\n   * Handler when close action is triggered, will pop history state to close\n   * the iframe.\n   * @param {{container: !Element, iframe:!HTMLIFrameElement}} containerAndFrame\n   * @private\n   */\n  closeActionHandler_(containerAndFrame) {\n    if (containerAndFrame['container'].parentNode) {\n      // Close action only when container is still attached to the page.\n      history.back();\n    }\n  }\n\n  /**\n   * @param {{container: !Element, iframe:!HTMLIFrameElement}} containerAndFrame\n   * @private\n   */\n  dismissIframe_(containerAndFrame) {\n    // Dismiss iframe only when container is still attached in the page.\n    if (containerAndFrame['container'].parentNode) {\n      // TODO: Think about whether this could be just hide instead of\n      // disconnect and remove, the tricky part is how to handle the case where\n      // payment data request is not the same.\n      this.dismissPromiseResolver_(Promise.reject({'errorCode': 'CANCELED'}));\n      this.removeIframeAndContainer_(\n        containerAndFrame['container'],\n        containerAndFrame['iframe']\n      );\n      this.port_ && this.port_.disconnect();\n    }\n  }\n\n  /**\n   * @param {!PaymentDataRequest} paymentDataRequest\n   * @return {boolean}\n   * @private\n   */\n  isVerticalCenterExperimentEnabled_(paymentDataRequest) {\n    return (\n      null  \n    );\n  }\n\n  /**\n   * @param {!Element} container\n   * @param {!HTMLIFrameElement} iframe\n   * @param {!PaymentDataRequest} paymentDataRequest\n   * @private\n   */\n  showContainerAndIframeWithAnimation_(container, iframe, paymentDataRequest) {\n    container.style.display = 'block';\n    iframe.style.display = 'block';\n    setTimeout(() => {\n      // Hard code the apprx height here, it will be resize to expected height\n      // later.\n      iframe.height = '280px';\n      if (this.isVerticalCenterExperimentEnabled_(paymentDataRequest)) {\n        iframe.classList.add(Constants.IFRAME_ACTIVE_CONTAINER_CLASS);\n      }\n      // TODO: This should be handles properly by listening to\n      // TransitionEnd event.\n      setTimeout(() => {\n        this.shouldHandleResizing_ = true;\n        // TODO: Add browser test that catches this.\n        if (this.savedResizePayload_) {\n          this.setTransition_(iframe, this.savedResizePayload_['transition']);\n          iframe.height = this.savedResizePayload_['height'];\n          this.savedResizePayload_ = null;\n        }\n      }, IFRAME_SHOW_UP_DURATION_IN_MS);\n    }, 1);\n  }\n\n  /**\n   * @param {!HTMLIFrameElement} iframe\n   * @param {string} transitionStyle\n   * @private\n   */\n  setTransition_(iframe, transitionStyle) {\n    iframe.style.setProperty('transition', transitionStyle);\n    // For safari.\n    iframe.style.setProperty('-webkit-transition', transitionStyle);\n  }\n\n  /**\n   * Use WebActivitiy to open iframe that's in given container.\n   *\n   * @param {!Element} container\n   * @param {!HTMLIFrameElement} iframe\n   * @param {!PaymentDataRequest} paymentDataRequest\n   * @return {!Promise<!PaymentData>}\n   * @private\n   */\n  openIframe_(container, iframe, paymentDataRequest) {\n    if (!paymentDataRequest.swg) {\n      if (!paymentDataRequest.apiVersion) {\n        paymentDataRequest.apiVersion = 1;\n      }\n    }\n    paymentDataRequest.environment = this.environment_;\n    let iframeLoadStartTime;\n    const trustedUrl = this.getIframeUrl(\n      this.environment_,\n      window.location.origin\n    );\n    return this.activities\n      .openIframe(iframe, trustedUrl, paymentDataRequest)\n      .then((port) => {\n        // Handle custom resize message.\n        this.port_ = port;\n        port.onMessage((payload) => {\n          if (payload['type'] !== 'resize' || !this.shouldHandleResizing_) {\n            // Save the resize event later after initial animation is finished\n            this.savedResizePayload_ = {\n              'height': payload['height'],\n              'transition': payload['transition'],\n            };\n            return;\n          }\n          // b/111310899: Smooth out initial iFrame loading\n          if (!iframeLoadStartTime) {\n            iframeLoadStartTime = Date.now();\n          }\n          if (\n            Date.now() <\n            iframeLoadStartTime + IFRAME_SHOW_UP_DURATION_IN_MS\n          ) {\n            this.setTransition_(\n              iframe,\n              payload['transition'] + ', ' + IFRAME_SMOOTH_HEIGHT_TRANSITION\n            );\n          } else {\n            this.setTransition_(iframe, payload['transition']);\n          }\n          iframe.height = payload['height'];\n        });\n        return /** @type {!Promise<!Object>} */ (port.acceptResult());\n      })\n      .then(\n        /**\n         * @param {!Object} result\n         * @return {!PaymentData}\n         */\n        (result) => {\n          this.removeIframeAndContainer_(container, iframe);\n          // This is only for popping the state we pushed earlier.\n          history.back();\n          const data = /** @type {!PaymentData} */ (result['data']);\n          return data;\n        },\n        (error) => {\n          this.removeIframeAndContainer_(container, iframe);\n          // This is only for popping the state we pushed earlier.\n          history.back();\n          return Promise.reject(error);\n        }\n      );\n  }\n}\n\n/**\n * @license\n * Copyright 2018 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nclass UpiHandler {\n  constructor() {}\n\n  /**\n   * Returns upi payment method object if it exists in allowed payment methods\n   * or null if it doesn't\n   *\n   * @param {!IsReadyToPayRequest|!PaymentDataRequest} request\n   * @return {boolean}\n   */\n  isUpiRequest(request) {\n    return !!getUpiPaymentMethod(request);\n  }\n\n  /**\n   * Returns upi payment method object if it exists in allowed payment methods\n   * or null if it doesn't\n   *\n   * @param {!IsReadyToPayRequest|!PaymentDataRequest} request\n   * @return {!Promise} The promise will contain the boolean result and error\n   *     message when possible.\n   */\n  isReadyToPay(request) {\n    // Always return true for UPI if api version is 2 and chrome supports\n    // payment request\n    if (getUpiPaymentMethod(request)) {\n      if (request.existingPaymentMethodRequired) {\n        return Promise.resolve({'result': true, 'paymentMethodPresent': true});\n      } else {\n        return Promise.resolve({'result': true});\n      }\n    }\n    throw new Error('No Upi payment method found in handler');\n  }\n\n  /**\n   * Request payment data when payment method is UPI\n   *\n   * @param {!PaymentDataRequest} paymentDataRequest Provides necessary\n   *     information to support a payment.\n   * @param {!Object} upiPaymentMethod UPI paymentmethod in\n   *     allowedPaymentMethods array.\n   * @param {!Function} onResultCallback Function to call when everything is\n   *     done.\n   */\n  loadPaymentData(paymentDataRequest, upiPaymentMethod, onResultCallback) {\n    const parameters = upiPaymentMethod['parameters'];\n    const transactionInfo = paymentDataRequest['transactionInfo'];\n    const supportedInstruments = [{\n          'supportedMethods': ['https://tez.google.com/pay'],\n          'data': {\n            'pa': parameters['payeeVpa'],\n            'pn': parameters['payeeName'],\n            'tr': parameters['transactionReferenceId'],\n            'url': parameters['referenceUrl'],\n            'mc': parameters['mcc'],\n            'tn': transactionInfo['transactionNote'],\n          },\n        }];\n\n    if (parameters['transactionId']) {\n      supportedInstruments[0]['data']['tid'] = parameters['transactionId'];\n    }\n\n    const details = {\n      'total': {\n        'label': 'Total',\n        'amount': {\n          'currency': transactionInfo['currencyCode'],\n          'value': transactionInfo['totalPrice'],\n        },\n      },\n      'displayItems': [{\n        'label': 'Original Amount',\n        'amount': {\n          'currency': transactionInfo['currencyCode'],\n          'value': transactionInfo['totalPrice'],\n        },\n      }],\n    };\n\n    let request = new PaymentRequest(supportedInstruments, details);\n\n    onResultCallback(\n        this.checkCanMakePayment_(request)\n            .then(result => {\n              if (result) {\n                return this.showUi_(request);\n              } else {\n                return this.redirectToGooglePlay_();\n              }\n            })\n            .then(paymentData => {\n              return this.processData_(\n                  paymentData, paymentDataRequest, upiPaymentMethod);\n            })\n            .catch(error => {\n              error['statusCode'] = Constants.ResponseStatus.CANCELED;\n              return Promise.reject(error);\n            }));\n  }\n\n  /**\n   * Show the Tez payment request UI.\n   *\n   * @private\n   * @param {!PaymentRequest} request The payment request object.\n   * @return {!Promise<!PaymentData>} A promise containing payment response.\n   */\n  showUi_(request) {\n    return request.show().then(paymentResponse => {\n      paymentResponse.complete('success');\n      return paymentResponse.details;\n    });\n  }\n\n  /**\n   * Checks whether can make a payment with Tez on this device.\n   *\n   * @private\n   * @param {!PaymentRequest} request The payment request object.\n   * @return {!Promise<boolean>} a promise containing the result of whether can\n   *     make payment.\n   */\n  checkCanMakePayment_(request) {\n    // Checks canMakePayment cache, and use the cache result if it exists.\n    const cacheResult =\n        window.sessionStorage.getItem(Constants.UPI_CAN_MAKE_PAYMENT_CACHE_KEY);\n    if (cacheResult) {\n      return Promise.resolve(cacheResult === 'true');\n    }\n\n    // Feature detect canMakePayment().\n    if (!request.canMakePayment) {\n      return Promise.resolve(true);\n    }\n\n    let canMakePaymentPromise = request.canMakePayment();\n\n    return canMakePaymentPromise.then(result => {\n      // Store the result in cache if the result is true to avoid quota error\n      // caused by querying multiple times with different data.\n      // Doesn't store false because if we do so, user will be redirected to\n      // Google Play again after installing Google Pay if Chrome is not closed.\n      if (result) {\n        window.sessionStorage.setItem(\n            Constants.UPI_CAN_MAKE_PAYMENT_CACHE_KEY, result.toString());\n      }\n      return result;\n    });\n  }\n\n  /**\n   * Redirect user to Google Pay app in Google Play store\n   *\n   * @private\n   * @returns {!Promise<!Object>} Rejected promise with error message\n   */\n  redirectToGooglePlay_() {\n    window.location.replace(\n        // NOLINT\n            'https://play.google.com/store/apps/details?id=com.google.android.apps.nbu.paisa.user');  // NOLINT\n    return Promise.reject(\n        {'errorMessage': 'Cannot redirect to Tez page in Google Play.'});\n  }\n\n  /**\n   * Convert Tez payment data to GPay payment data if payment succeeded, or\n   * reject if payment failed\n   *\n   * @private\n   * @param {!PaymentData} tezPaymentData The payment data object from Tez.\n   * @param {!PaymentDataRequest} paymentDataRequest The payment data request.\n   * @param {!Object} upiPaymentMethod UPI paymentmethod in\n   * allowedPaymentMethods array\n   * @returns {!Promise<PaymentData>} A promise containing payment data or\n   *     error message.\n   */\n  processData_(tezPaymentData, paymentDataRequest, upiPaymentMethod) {\n    const tezResponse = JSON.parse(tezPaymentData['tezResponse']);\n    if (tezResponse['Status'] === 'FAILURE') {\n      let error;\n      switch (tezResponse['responseCode']) {\n        case 'ZM':\n          // payment failure due to invalid MPIN\n          error = {\n            'errorCode': PublicErrorCode.BUYER_ACCOUNT_ERROR,\n            'errorMessage': 'Payment failure due to invalid MPIN.'\n          };\n          break;\n        case 'Z9':\n          // payment failure due to insufficient funds\n          error = {\n            'errorCode': PublicErrorCode.BUYER_ACCOUNT_ERROR,\n            'errorMessage': 'Payment failure due to insufficient funds.'\n          };\n          break;\n        case '91':\n          // payment failure due to transaction timeout or connection issue\n          error = {\n            'errorCode': PublicErrorCode.INTERNAL_ERROR,\n            'errorMessage':\n                'Payment failure due to transaction timeout or connection' +\n                ' issue.'\n          };\n          break;\n        default:\n          // payment failure due to user cancel or other issues\n          error = {'errorMessage': 'Payment cancelled.'};\n      }\n      return Promise.reject(error);\n    }\n\n    const signedMessage = {\n      'paymentMethodType': 'UPI',\n      'payeeVpa': upiPaymentMethod['parameters']['payeeVpa'],\n      'status': tezResponse['Status'],\n      'transactionReferenceId':\n          upiPaymentMethod['parameters']['transactionReferenceId'],\n      'transactionId': upiPaymentMethod['parameters']['transactionId'] ?\n          upiPaymentMethod['parameters']['transactionId'] :\n          tezResponse['txnId'],\n      'transactionInfo': paymentDataRequest['transactionInfo'],\n    };\n\n    let paymentData = {\n      'apiVersion': paymentDataRequest['apiVersion'],\n      'apiVersionMinor': paymentDataRequest['apiVersionMinor'],\n      'paymentMethodData': {\n        'type': upiPaymentMethod['type'],\n        'tokenizationData': {\n          'type': 'DIRECT',\n          'token': {\n            'protocolVersion': 'ECv1',\n            // TODO: Verify that response comes from tez and\n            // add signature and encrypt signed message here\n            'signature': '',\n            'signedMessage': signedMessage\n          }\n        }\n      }\n    };\n    return Promise.resolve(paymentData);\n  }\n}\n\n/** @license\nMath.uuid.js (v1.4)\nhttp://www.broofa.com\nmailto:robert@broofa.com\nCopyright (c) 2010 Robert Kieffer\nDual licensed under the MIT and GPL licenses.\n*/\n\n/*\n * Generate a random uuid.\n *\n * USAGE: Math.uuid(length, radix)\n *   length - the desired number of characters\n *   radix  - the number of allowable values for each character.\n *\n * EXAMPLES:\n *   // No arguments  - returns RFC4122, version 4 ID\n *   >>> Math.uuid()\n *   \"92329D39-6F5C-4520-ABFC-AAB64544E172\"\n *\n *   // One argument - returns ID of the specified length\n *   >>> Math.uuid(15)     // 15 character ID (default base=62)\n *   \"VcydxgltxrVZSTV\"\n *\n *   // Two arguments - returns ID of the specified length, and radix. (Radix must be <= 62)\n *   >>> Math.uuid(8, 2)  // 8 character ID (base=2)\n *   \"01001010\"\n *   >>> Math.uuid(8, 10) // 8 character ID (base=10)\n *   \"47473046\"\n *   >>> Math.uuid(8, 16) // 8 character ID (base=16)\n *   \"098F4D35\"\n */\n\nclass Random_uuid {}  // Private array of chars to use\n  var CHARS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');\n\n  Random_uuid.uuid = function (len, radix) {\n    var chars = CHARS, uuid = [], i;\n    radix = radix || chars.length;\n\n    if (len) {\n      // Compact form\n      for (i = 0; i < len; i++) uuid[i] = chars[0 | Math.random()*radix];\n    } else {\n      // rfc4122, version 4 form\n      var r;\n\n      // rfc4122 requires these characters\n      uuid[8] = uuid[13] = uuid[18] = uuid[23] = '-';\n      uuid[14] = '4';\n\n      // Fill in random data.  At i==19 set the high bits of clock sequence as\n      // per rfc4122, sec. 4.1.5\n      for (i = 0; i < 36; i++) {\n        if (!uuid[i]) {\n          r = 0 | Math.random()*16;\n          uuid[i] = chars[(i == 19) ? (r & 0x3) | 0x8 : r];\n        }\n      }\n    }\n\n    return uuid.join('');\n  };\n\n  // A more performant, but slightly bulkier, RFC4122v4 solution.  We boost performance\n  // by minimizing calls to random()\n  Random_uuid.uuidFast = function() {\n    var chars = CHARS, uuid = new Array(36), rnd=0, r;\n    for (var i = 0; i < 36; i++) {\n      if (i==8 || i==13 ||  i==18 || i==23) {\n        uuid[i] = '-';\n      } else if (i==14) {\n        uuid[i] = '4';\n      } else {\n        if (rnd <= 0x02) rnd = 0x2000000 + (Math.random()*0x1000000)|0;\n        r = rnd & 0xf;\n        rnd = rnd >> 4;\n        uuid[i] = chars[(i == 19) ? (r & 0x3) | 0x8 : r];\n      }\n    }\n    return uuid.join('');\n  };\n\n  // A more compact, but less performant, RFC4122v4 solution:\n  Random_uuid.uuidCompact = function() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n      var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);\n      return v.toString(16);\n    });\n  };\n\n/**\n * @license\n * Copyright 2018 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns a google transaction id.\n *\n * @param {string} environment\n * @return {string}\n */\nfunction createGoogleTransactionId(environment) {\n  return Random_uuid.uuidFast() + '.' + environment;\n}\n\n/**\n * @license\n * Copyright 2018 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nrequire('web-activities/activity-ports');\n\nconst TRUSTED_DOMAINS = [\n  'actions.google.com',\n  'amp-actions.sandbox.google.com',\n  'amp-actions-staging.sandbox.google.com',\n  'amp-actions-autopush.sandbox.google.com',\n  'payments.developers.google.com',\n  'payments.google.com',\n];\n\n/**\n * The client for interacting with the Google Payment APIs.\n * <p>\n * The async refers to the fact that this client supports redirects\n * when using webactivties.\n * <p>\n * If you are using this be sure that this is what you want.\n * <p>\n * In almost all cases PaymentsClient is the better client to use because\n * it exposes a promises based api which is easier to deal with.\n * @final\n */\nclass PaymentsAsyncClient {\n  /**\n   * @param {!PaymentOptions} paymentOptions\n   * @param {function(!Promise<!PaymentData>)} onPaymentResponse\n   * @param {boolean=} useIframe\n   * @param {!ActivityPorts=} activities Can be used to provide a shared\n   *   activities manager. By default, the new manager is created.\n   */\n  constructor(paymentOptions, onPaymentResponse, useIframe, activities) {\n    this.onPaymentResponse_ = onPaymentResponse;\n\n    validatePaymentOptions(paymentOptions);\n\n    /** @private {?number} */\n    this.loadPaymentDataApiStartTimeMs_ = null;\n\n    /** @private @const {string} */\n    this.environment_ =\n      paymentOptions.environment || Constants.Environment.TEST;\n    if (!PaymentsAsyncClient.googleTransactionId_) {\n      PaymentsAsyncClient.googleTransactionId_ = /** @type {string} */ (this.isInTrustedDomain_() &&\n      paymentOptions['i'] &&\n      paymentOptions['i']['googleTransactionId']\n        ? paymentOptions['i']['googleTransactionId']\n        : createGoogleTransactionId(this.environment_));\n    }\n\n    /** @private @const {!PaymentOptions} */\n    this.paymentOptions_ = paymentOptions;\n\n    /** @private @const {!PaymentsClientDelegateInterface} */\n    this.webActivityDelegate_ = new PaymentsWebActivityDelegate(\n      this.environment_,\n      PaymentsAsyncClient.googleTransactionId_,\n      useIframe,\n      activities,\n      paymentOptions['i'] && paymentOptions['i']['redirectKey']\n    );\n\n    /** @private {number} */\n    this.buyFlowMode_ = BuyFlowMode.PAY_WITH_GOOGLE;\n\n    const paymentRequestSupported = chromeSupportsPaymentRequest();\n    // TODO: Remove the temporary hack that disable payments\n    // request for inline flow.\n    /** @private @const {?PaymentsClientDelegateInterface} */\n    this.delegate_ =\n      paymentRequestSupported && !useIframe\n        ? new PaymentsRequestDelegate(this.environment_)\n        : this.webActivityDelegate_;\n\n    this.upiHandler_ = new UpiHandler();\n\n    this.webActivityDelegate_.onResult(this.onResult_.bind(this));\n    this.delegate_.onResult(this.onResult_.bind(this));\n\n    // Load PayFrameHelper upon client construction.\n    PayFrameHelper.load();\n\n    // If web delegate is used anyway then this is overridden in the web\n    // activity delegate when load payment data is called.\n    if (chromeSupportsPaymentHandler()) {\n      PayFrameHelper.setBuyFlowActivityMode(\n        BuyFlowActivityMode.PAYMENT_HANDLER\n      );\n    } else if (paymentRequestSupported) {\n      PayFrameHelper.setBuyFlowActivityMode(BuyFlowActivityMode.ANDROID_NATIVE);\n    }\n\n    PayFrameHelper.setGoogleTransactionId(\n      PaymentsAsyncClient.googleTransactionId_\n    );\n    PayFrameHelper.postMessage({\n      'eventType': PostMessageEventType.LOG_INITIALIZE_PAYMENTS_CLIENT,\n      'clientLatencyStartMs': Date.now(),\n    });\n\n    window.addEventListener('message', (event) =>\n      this.handleMessageEvent_(event)\n    );\n  }\n\n  /**\n   * Check whether the user can make payments using the Payment API.\n   *\n   * @param {!IsReadyToPayRequest} isReadyToPayRequest\n   * @return {!Promise} The promise will contain the boolean result and error\n   *     message when possible.\n   */\n  isReadyToPay(isReadyToPayRequest) {\n    // Merge with paymentOptions, preferring values from isReadyToPayRequest\n    if (isReadyToPayRequest) {\n      isReadyToPayRequest = Object.assign(\n        {},\n        this.paymentOptions_,\n        isReadyToPayRequest\n      );\n    }\n    const startTimeMs = Date.now();\n    /** @type {?string} */\n    const errorMessage =\n      validateSecureContext() ||\n      validateIsReadyToPayRequest(isReadyToPayRequest);\n    if (errorMessage) {\n      return new Promise((resolve, reject) => {\n        PaymentsAsyncClient.logDevErrorToConsole_('isReadyToPay', errorMessage);\n        PayFrameHelper.postMessage({\n          'eventType': PostMessageEventType.LOG_IS_READY_TO_PAY_API,\n          'error': PublicErrorCode.DEVELOPER_ERROR,\n        });\n        reject({\n          'statusCode': Constants.ResponseStatus.DEVELOPER_ERROR,\n          'statusMessage': errorMessage,\n        });\n      });\n    }\n\n    const isReadyToPayPromise = this.isReadyToPay_(isReadyToPayRequest);\n\n    isReadyToPayPromise.then((response) => {\n      PayFrameHelper.postMessage({\n        'eventType': PostMessageEventType.LOG_IS_READY_TO_PAY_API,\n        'clientLatencyStartMs': startTimeMs,\n        'isReadyToPayApiResponse': response,\n      });\n      return response;\n    });\n    return isReadyToPayPromise;\n  }\n\n  /**\n   * Actual implementation of isReadyToPay in a private method so that\n   * we can add callbacks to the promise to measure latencies.\n   *\n   * @param {!IsReadyToPayRequest} isReadyToPayRequest\n   * @return {!Promise} The promise will contain the boolean result and error\n   *     message when possible.\n   * @private\n   */\n  isReadyToPay_(isReadyToPayRequest) {\n    if (this.upiHandler_.isUpiRequest(isReadyToPayRequest)) {\n      return this.upiHandler_.isReadyToPay(isReadyToPayRequest);\n    }\n    if (\n      chromeSupportsPaymentRequest() &&\n      !isNativeDisabledInRequest(isReadyToPayRequest)\n    ) {\n      if (isReadyToPayRequest.apiVersion >= 2) {\n        return this.isReadyToPayApiV2ForChromePaymentRequest_(\n          isReadyToPayRequest\n        );\n      } else {\n        // This is the apiVersion 1 branch.\n        // If the merchant supports only Tokenized cards then just rely on\n        // delegate to give us the result.\n        // This will need to change once b/78519188 is fixed.\n        const webPromise = this.webActivityDelegate_.isReadyToPay(\n          isReadyToPayRequest\n        );\n        const nativePromise = this.delegate_.isReadyToPay(isReadyToPayRequest);\n        if (\n          doesMerchantSupportOnlyTokenizedCards(isReadyToPayRequest) &&\n          !chromeSupportsPaymentHandler()\n        ) {\n          return nativePromise;\n        }\n        // Return webIsReadyToPay only if delegateIsReadyToPay has been\n        // executed.\n        return nativePromise.then(() => webPromise);\n      }\n    }\n    const webPromise = this.webActivityDelegate_.isReadyToPay(\n      isReadyToPayRequest\n    );\n    return webPromise;\n  }\n\n  /**\n   * Handle is ready to pay for api v2.\n   *\n   * @param {!IsReadyToPayRequest} isReadyToPayRequest\n   * @return {!Promise} The promise will contain the boolean result and error\n   *     message when possible.\n   * @private\n   */\n  isReadyToPayApiV2ForChromePaymentRequest_(isReadyToPayRequest) {\n    let defaultPromise = Promise.resolve({'result': false});\n    if (isReadyToPayRequest.existingPaymentMethodRequired) {\n      defaultPromise = Promise.resolve({\n        'result': false,\n        'paymentMethodPresent': false,\n      });\n    }\n\n    let nativePromise = defaultPromise;\n    if (\n      apiV2DoesMerchantSupportSpecifiedCardType(\n        isReadyToPayRequest,\n        Constants.AuthMethod.CRYPTOGRAM_3DS\n      )\n    ) {\n      // If the merchant supports tokenized cards.\n      // Make a separate call to gms core to check if the user isReadyToPay\n      // with just tokenized cards. We can't pass in PAN_ONLY here\n      // because gms core always returns true for PAN_ONLY.\n      // Leave other payment methods as is.\n      const nativeRtpRequest /** @type {!IsReadyToPayRequest} */ = JSON.parse(\n        JSON.stringify(isReadyToPayRequest)\n      );\n      for (let i = 0; i < nativeRtpRequest.allowedPaymentMethods.length; i++) {\n        if (\n          nativeRtpRequest.allowedPaymentMethods[i].type ==\n          Constants.PaymentMethod.CARD\n        ) {\n          nativeRtpRequest.allowedPaymentMethods[i].parameters[\n            'allowedAuthMethods'\n          ] = [Constants.AuthMethod.CRYPTOGRAM_3DS];\n        }\n      }\n\n      nativePromise = this.delegate_.isReadyToPay(nativeRtpRequest);\n    }\n\n    let webPromise = defaultPromise;\n    if (\n      apiV2DoesMerchantSupportSpecifiedCardType(\n        isReadyToPayRequest,\n        Constants.AuthMethod.PAN_ONLY\n      )\n    ) {\n      webPromise = this.webActivityDelegate_.isReadyToPay(isReadyToPayRequest);\n    }\n\n    // Update session storage with payment handler canMakePayment result but\n    // rely on web delegate for actual response\n    if (chromeSupportsPaymentHandler()) {\n      return nativePromise.then(() => webPromise);\n    }\n\n    return nativePromise.then((nativeResult) => {\n      if ((nativeResult && nativeResult['result']) == true) {\n        return nativeResult;\n      }\n      return webPromise;\n    });\n  }\n\n  /**\n   * Prefetch paymentData to speed up loadPaymentData call. Note the provided\n   * paymentDataRequest should exactly be the same as provided in\n   * loadPaymentData to make the loadPaymentData call fast since current\n   * web flow prefetching is based on the full request parameters.\n   *\n   * @param {!PaymentDataRequest} paymentDataRequest Provides necessary\n   *     information to support a payment.\n   */\n  prefetchPaymentData(paymentDataRequest) {\n    /** @type {?string} */\n    const errorMessage =\n      validateSecureContext() || validatePaymentDataRequest(paymentDataRequest);\n    if (errorMessage) {\n      PaymentsAsyncClient.logDevErrorToConsole_(\n        'prefetchPaymentData',\n        errorMessage\n      );\n      return;\n    }\n    this.assignInternalParams_(paymentDataRequest);\n    if (\n      chromeSupportsPaymentRequest() &&\n      !isNativeDisabledInRequest(paymentDataRequest)\n    ) {\n      this.delegate_.prefetchPaymentData(paymentDataRequest);\n    } else {\n      // For non chrome supports always use the hosting page.\n      this.webActivityDelegate_.prefetchPaymentData(paymentDataRequest);\n    }\n  }\n\n  /**\n   * Request PaymentData, which contains necessary infomartion to complete a\n   * payment.\n   *\n   * @param {!PaymentDataRequest} paymentDataRequest Provides necessary\n   *     information to support a payment.\n   */\n  loadPaymentData(paymentDataRequest) {\n    PayFrameHelper.postMessage({\n      'eventType': PostMessageEventType.LOG_BUTTON_CLICK,\n    });\n    const errorMessage =\n      validateSecureContext() || validatePaymentDataRequest(paymentDataRequest);\n    this.buyFlowMode_ =\n      paymentDataRequest && paymentDataRequest.swg\n        ? BuyFlowMode.SUBSCRIBE_WITH_GOOGLE\n        : BuyFlowMode.PAY_WITH_GOOGLE;\n    if (errorMessage) {\n      this.onPaymentResponse_(\n        new Promise((resolve, reject) => {\n          PayFrameHelper.postMessage({\n            'eventType': PostMessageEventType.LOG_LOAD_PAYMENT_DATA_API,\n            'error': PublicErrorCode.DEVELOPER_ERROR,\n            'buyFlowMode': this.buyFlowMode_,\n          });\n          PaymentsAsyncClient.logDevErrorToConsole_(\n            'loadPaymentData',\n            errorMessage\n          );\n          reject({\n            'statusCode': Constants.ResponseStatus.DEVELOPER_ERROR,\n            'statusMessage': errorMessage,\n          });\n        })\n      );\n      return;\n    }\n\n    // Handler for UPI PaymentMethod\n    // Currently we don't support UPI along with other payment methods, if\n    // UPI is in payment methods then we assume it is UPI only.\n    const upiPaymentMethod = getUpiPaymentMethod(paymentDataRequest);\n    if (upiPaymentMethod) {\n      this.upiHandler_.loadPaymentData(\n        paymentDataRequest,\n        upiPaymentMethod,\n        this.onResult_.bind(this)\n      );\n      return;\n    }\n\n    this.loadPaymentDataApiStartTimeMs_ = Date.now();\n    this.assignInternalParams_(paymentDataRequest);\n    // We want to fall back to the web delegate if payment handler is supported\n    // and isReadyToPay bit is not explicitly set to true (fallback to web if\n    // isReadyToPay wasn't called for PH)\n    if (\n      chromeSupportsPaymentHandler() ||\n      isNativeDisabledInRequest(paymentDataRequest)\n    ) {\n      this.webActivityDelegate_.loadPaymentData(paymentDataRequest);\n    } else {\n      this.delegate_.loadPaymentData(paymentDataRequest);\n    }\n  }\n\n  /**\n   * Log developer error to console.\n   *\n   * @param {string} apiName\n   * @param {?string} errorMessage\n   * @private\n   */\n  static logDevErrorToConsole_(apiName, errorMessage) {\n    console.error('DEVELOPER_ERROR in ' + apiName + ' : ' + errorMessage);\n  }\n\n  /**\n   * Return a <div> element containing a Google Pay payment button.\n   *\n   * @param {!ButtonOptions=} options\n   * @return {!Element}\n   */\n  createButton(options = {}) {\n    const button = null;\n    // Only log if button was created successfully\n    const startTimeMs = Date.now();\n    PayFrameHelper.postMessage({\n      'eventType': PostMessageEventType.LOG_RENDER_BUTTON,\n      'clientLatencyStartMs': startTimeMs,\n    });\n    return button;\n  }\n\n  /**\n   * @param {!Event} e postMessage event from the AMP page.\n   * @private\n   */\n  handleMessageEvent_(e) {\n    if (this.isInTrustedDomain_()) {\n      // Only handles the event right now if loaded in trusted domain.\n      if (e.data['name'] === 'logPaymentData') {\n        PayFrameHelper.postMessage(e.data['data']);\n      }\n    }\n  }\n\n  /**\n   * @private\n   * @return {boolean}\n   */\n  isInTrustedDomain_() {\n    return TRUSTED_DOMAINS.indexOf(window.location.hostname) != -1;\n  }\n\n  /**\n   * Called when load payment data result is returned. This triggers the payment\n   * response callback passed to the client.\n   *\n   * @private\n   */\n  onResult_(response) {\n    response\n      .then((result) => {\n        PayFrameHelper.postMessage({\n          'eventType': PostMessageEventType.LOG_LOAD_PAYMENT_DATA_API,\n          'clientLatencyStartMs': this.loadPaymentDataApiStartTimeMs_,\n          'buyFlowMode': this.buyFlowMode_,\n        });\n      })\n      .catch((result) => {\n        if (result['errorCode']) {\n          PayFrameHelper.postMessage({\n            'eventType': PostMessageEventType.LOG_LOAD_PAYMENT_DATA_API,\n            'error': /** @type {!PublicErrorCode} */ (result['errorCode']),\n            'buyFlowMode': this.buyFlowMode_,\n          });\n        } else {\n          // If user closes window we don't get a error code\n          PayFrameHelper.postMessage({\n            'eventType': PostMessageEventType.LOG_LOAD_PAYMENT_DATA_API,\n            'error': PublicErrorCode.BUYER_CANCEL,\n            'buyFlowMode': this.buyFlowMode_,\n          });\n        }\n      });\n    this.onPaymentResponse_(response);\n  }\n\n  /**\n   * @param {!PaymentDataRequest} paymentDataRequest\n   * @return {!PaymentDataRequest}\n   * @private\n   */\n  assignInternalParams_(paymentDataRequest) {\n    const internalParam = {\n      'startTimeMs': Date.now(),\n      'googleTransactionId': PaymentsAsyncClient.googleTransactionId_,\n    };\n    paymentDataRequest['i'] = paymentDataRequest['i']\n      ? Object.assign(internalParam, paymentDataRequest['i'])\n      : internalParam;\n    return paymentDataRequest;\n  }\n}\n\n/**\n * Whether the request specifies that the native support has to be disabled.\n *\n * @param {!IsReadyToPayRequest|!PaymentDataRequest} request\n * @return {boolean}\n */\nfunction isNativeDisabledInRequest(request) {\n  return (request['i'] && request['i']['disableNative']) === true;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nclass Preconnect {\n  /**\n   * @param {!Document} doc\n   */\n  constructor(doc) {\n    /** @private @const {!Document} */\n    this.doc_ = doc;\n  }\n\n  /**\n   * @param {string} url\n   */\n  preconnect(url) {\n    this.pre_(url, 'preconnect');\n  }\n\n  /**\n   * @param {string} url\n   */\n  dnsPrefetch(url) {\n    this.pre_(url, 'dns-prefetch');\n  }\n\n  /**\n   * @param {string} url\n   */\n  prefetch(url) {\n    this.pre_(url, 'preconnect prefetch');\n  }\n\n  /**\n   * @param {string} url\n   * @param {string} as\n   */\n  preload(url, as) {\n    this.pre_(url, 'preconnect preload', as);\n  }\n\n  /**\n   * @param {string} url\n   * @param {string} rel\n   * @param {?string=} as\n   * @private\n   */\n  pre_(url, rel, as) {\n    // <link rel=\"prefetch\" href=\"...\" as=\"\">\n    const linkEl = createElement(this.doc_, 'link', {\n      'rel': rel,\n      'href': url,\n    });\n    if (as) {\n      linkEl.setAttribute('as', as);\n    }\n    this.doc_.head.appendChild(linkEl);\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst REDIRECT_STORAGE_KEY = 'subscribe.google.com:rk';\n\n/**\n * @const {!Object<string, string>}\n * @package Visible for testing only.\n */\nconst PAY_ORIGIN = {\n  'PRODUCTION': 'https://pay.google.com',\n  'SANDBOX': 'https://pay.sandbox.google.com',\n};\n\n/** @return {string} */\nfunction payUrl() {\n  return feCached(PAY_ORIGIN[getSwgMode().payEnv] + '/gp/p/ui/pay');\n}\n\n/**\n */\nclass PayClient {\n  /**\n   * @param {!./deps.DepsDef} deps\n   */\n  constructor(deps) {\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private {?function(!Promise<!PaymentData>)} */\n    this.responseCallback_ = null;\n\n    /** @private {?PaymentDataRequest} */\n    this.request_ = null;\n\n    /** @private {?Promise<!PaymentData>} */\n    this.response_ = null;\n\n    /** @private @const {!./analytics-service.AnalyticsService} */\n    this.analytics_ = deps.analytics();\n\n    /** @private @const {!RedirectVerifierHelper} */\n    this.redirectVerifierHelper_ = new RedirectVerifierHelper(this.win_);\n\n    /** @private {?PaymentsAsyncClient} */\n    this.client_ = null;\n\n    /** @private @const {!Preconnect} */\n    this.preconnect_ = new Preconnect(this.win_.document);\n\n    // If the page is started from a redirect, immediately initialize\n    // client to avoid dropping user state.\n    if (\n      isExperimentOn(this.win_, ExperimentFlags.PAY_CLIENT_REDIRECT) &&\n      this.pageIsInitializedFromPayRedirect_()\n    ) {\n      this.preconnect(this.preconnect_);\n      this.initializePaymentsClient_();\n    }\n\n    // Prepare new verifier pair.\n    this.redirectVerifierHelper_.prepare();\n\n    /** @private @const {!./client-event-manager.ClientEventManager} */\n    this.eventManager_ = deps.eventManager();\n  }\n\n  /**\n   * @param {!PaymentOptions} options\n   * @param {string} googleTransactionId\n   * @param {function(!Promise<!PaymentData>)} handler\n   * @return {!PaymentsAsyncClient}\n   * @private\n   */\n  createClient_(options, googleTransactionId, handler) {\n    // Assign Google Transaction ID to PaymentsAsyncClient.googleTransactionId_\n    // so it can be passed to gpay_async.js and stored in payment clearcut log.\n    PaymentsAsyncClient.googleTransactionId_ = googleTransactionId;\n    return new PaymentsAsyncClient(\n      options,\n      handler,\n      /* useIframe */ false,\n      this.activityPorts_.getOriginalWebActivityPorts()\n    );\n  }\n\n  /**\n   * @param {!../utils/preconnect.Preconnect} pre\n   */\n  preconnect(pre) {\n    pre.prefetch(payUrl());\n    pre.prefetch(\n      'https://payments.google.com/payments/v4/js/integrator.js?ss=md'\n    );\n    pre.prefetch('https://clients2.google.com/gr/gr_full_2.0.6.js');\n  }\n\n  /**\n   * Initializes Payments client.\n   */\n  initializePaymentsClient_() {\n    this.client_ = this.createClient_(\n      /** @type {!PaymentOptions} */\n      ({\n        environment: getSwgMode().payEnv,\n        'i': {\n          'redirectKey': this.redirectVerifierHelper_.restoreKey(),\n        },\n      }),\n      this.analytics_.getTransactionId(),\n      this.handleResponse_.bind(this)\n    );\n  }\n\n  /**\n   * Detects if the window is started from a Pay redirect by\n   * checking window's hash for Web Activities information.\n   */\n  pageIsInitializedFromPayRedirect_() {\n    const hash = this.win_.location.hash;\n    const hasRedirectEncryptedCallbackData =\n      /redirectEncryptedCallbackData/.test(hash);\n    const hasSwgRequest = /swgRequest/.test(hash);\n    return hasRedirectEncryptedCallbackData && hasSwgRequest;\n  }\n\n  /**\n   * @return {string}\n   */\n  getType() {\n    // TODO(alin04): remove once all references removed.\n    return 'PAYJS';\n  }\n\n  /**\n   * @param {!PaymentDataRequest} paymentRequest\n   * @param {!PayOptionsDef=} options\n   */\n  start(paymentRequest, options = {}) {\n    this.request_ = paymentRequest;\n\n    if (!this.client_) {\n      this.preconnect(this.preconnect_);\n      this.initializePaymentsClient_();\n    }\n    if (options.forceRedirect) {\n      paymentRequest = Object.assign(paymentRequest, {\n        'forceRedirect': options.forceRedirect || false,\n      });\n    }\n    setInternalParam(\n      paymentRequest,\n      'disableNative',\n      // The page cannot be iframed at this time. May be relaxed later\n      // for AMP and similar contexts.\n      options.forceDisableNative || this.win_ != this.top_()\n    );\n    let resolver = null;\n    const promise = new Promise((resolve) => (resolver = resolve));\n    // Notice that the callback for verifier may execute asynchronously.\n    this.redirectVerifierHelper_.useVerifier((verifier) => {\n      if (verifier) {\n        setInternalParam(paymentRequest, 'redirectVerifier', verifier);\n      }\n      if (options.forceRedirect) {\n        const client = this.client_;\n        this.eventManager_.getReadyPromise().then(() => {\n          this.analytics_.getLoggingPromise().then(() => {\n            client.loadPaymentData(paymentRequest);\n            resolver(true);\n          });\n        });\n      } else {\n        this.client_.loadPaymentData(paymentRequest);\n        resolver(true);\n      }\n    });\n    return promise;\n  }\n\n  /**\n   * @param {function(!Promise<!PaymentData>)} callback\n   */\n  onResponse(callback) {\n    this.responseCallback_ = callback;\n    const response = this.response_;\n    if (response) {\n      Promise.resolve().then(() => {\n        if (response) {\n          callback(this.convertResponse_(response, this.request_));\n        }\n      });\n    }\n  }\n\n  /**\n   * @param {!Promise<!PaymentData>} responsePromise\n   * @private\n   */\n  handleResponse_(responsePromise) {\n    this.response_ = responsePromise;\n    if (this.responseCallback_) {\n      this.responseCallback_(\n        this.convertResponse_(this.response_, this.request_)\n      );\n    }\n  }\n\n  /**\n   * @param {!Promise<!PaymentData>} response\n   * @param {?PaymentDataRequest} request\n   * @return {!Promise<!PaymentData>}\n   * @private\n   */\n  convertResponse_(response, request) {\n    return response\n      .then(\n        // Temporary client side solution to remember the\n        // input params. TODO: Remove this once server-side\n        // input preservation is done and is part of the response.\n        (res) => {\n          if (request) {\n            res['paymentRequest'] = request;\n          }\n          return res;\n        }\n      )\n      .catch((reason) => {\n        if (typeof reason == 'object' && reason['statusCode'] == 'CANCELED') {\n          const error = createCancelError(this.win_);\n          if (request) {\n            error['productType'] = /** @type {!PaymentDataRequest} */ (request)[\n              'i'\n            ]['productType'];\n          } else {\n            error['productType'] = null;\n          }\n          return Promise.reject(error);\n        }\n        return Promise.reject(reason);\n      });\n  }\n\n  /**\n   * @return {!Window}\n   * @private\n   */\n  top_() {\n    // Only exists for testing since it's not possible to override `window.top`.\n    return this.win_.top;\n  }\n}\n\n/**\n * This helper generates key/verifier pair for the redirect mode. When the\n * redirect mode is used, the encrypted payload is returned via nivigation URL.\n * This payload need to be decrypted and to avoid session fixation attacks, a\n * verifier has to be used. This redirect verifier is not the only session\n * verifier in use: we also use GAIA. However, we have to fallback to this\n * verifier when GAIA is not available.\n *\n * @package Visible for testing only.\n */\nclass RedirectVerifierHelper {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {boolean} */\n    this.pairCreated_ = false;\n\n    /** @private {?RedirectVerifierPairDef} */\n    this.pair_ = null;\n\n    /** @private {?Promise<?RedirectVerifierPairDef>} */\n    this.pairPromise_ = null;\n  }\n\n  /**\n   * To avoid popup blockers, the key/verifier pair is created as soon as\n   * possible.\n   * @return {?Promise}\n   */\n  prepare() {\n    return this.getOrCreatePair_(() => {});\n  }\n\n  /**\n   * Calls the provided callback with the generated redirect verifier. This\n   * API is sync/async, which is a big anti-pattern. However, it's necessary\n   * to reduce the risk of popup blockers. If the verifier is already available\n   * (see `prepare` method), the callback will be called immediately and thus\n   * in the same event loop as the user action.\n   *\n   * The return verifier could be `null`. This could mean either that its\n   * generation failed, or if the platform doesn't support necessary APIs, such\n   * as Web Crypto. The redirect can still proceed and try to fallback on GAIA\n   * as a redirect verifier. The set of platforms where GAIA is not available\n   * and the redirect verifier cannot be created is negligible.\n   *\n   * The key corresponding to the returned verifier is stored in the session\n   * storage and can be later restored using `restoreKey` method.\n   *\n   * @param {function(?string)} callback\n   */\n  useVerifier(callback) {\n    this.getOrCreatePair_((pair) => {\n      if (pair) {\n        try {\n          this.win_.localStorage.setItem(REDIRECT_STORAGE_KEY, pair.key);\n        } catch (e) {\n          // If storage has failed, there's no point in using the verifer.\n          // However, there are other ways to recover the redirect, so it's\n          // not necessarily a fatal condition.\n          pair = null;\n        }\n      }\n      callback((pair && pair.verifier) || null);\n    });\n  }\n\n  /**\n   * Restores the redirect key from the session storage. The key may be null.\n   * @return {?string}\n   */\n  restoreKey() {\n    try {\n      return (\n        (this.win_.localStorage &&\n          this.win_.localStorage.getItem(REDIRECT_STORAGE_KEY)) ||\n        null\n      );\n    } catch (e) {\n      return null;\n    }\n  }\n\n  /**\n   * @param {function(?RedirectVerifierPairDef)} callback\n   * @return {?Promise}\n   * @private\n   */\n  getOrCreatePair_(callback) {\n    this.createPair_();\n    if (this.pairCreated_) {\n      // Already created.\n      callback(this.pair_);\n    } else if (this.pairPromise_) {\n      // Otherwise wait for it to be created.\n      this.pairPromise_.then((pair) => callback(pair));\n    }\n    return this.pairPromise_;\n  }\n\n  /**\n   * @private\n   */\n  createPair_() {\n    // Either already created or already started.\n    if (this.pairCreated_ || this.pairPromise_) {\n      return;\n    }\n\n    // Check that the platform can fully support verification. That means\n    // that it's expected to implement the following APIs:\n    // a. Local storage (localStorage);\n    // b. WebCrypto (crypto.subtle);\n    // c. Crypto random (crypto.getRandomValues);\n    // d. SHA284 (crypto.subtle.digest).\n    let supportsLocalStorage;\n    try {\n      supportsLocalStorage = !!this.win_.localStorage;\n    } catch (e) {\n      // Note: This can happen when cookies are disabled.\n      supportsLocalStorage = false;\n    }\n    const crypto = this.win_.crypto;\n    if (\n      supportsLocalStorage &&\n      crypto &&\n      crypto.getRandomValues &&\n      crypto.subtle &&\n      crypto.subtle.digest\n    ) {\n      this.pairPromise_ = new Promise((resolve, reject) => {\n        // 1. Use crypto random to create a 128-bit (16 byte) redirect key.\n        const keyBytes = new Uint8Array(16);\n        crypto.getRandomValues(keyBytes);\n\n        // 2. Encode key as base64.\n        const key = btoa(bytesToString(keyBytes));\n\n        // 3. Create a hash.\n        crypto.subtle.digest({name: 'SHA-384'}, stringToBytes(key)).then(\n          (buffer) => {\n            const verifier = btoa(\n              bytesToString(\n                new Uint8Array(/** @type {!ArrayBuffer} */ (buffer))\n              )\n            );\n            resolve({key, verifier});\n          },\n          (reason) => {\n            reject(reason);\n          }\n        );\n      })\n        .catch(() => {\n          // Ignore failures. A failure to create a redirect verifier is often\n          // recoverable.\n          return null;\n        })\n        .then((pair) => {\n          this.pairCreated_ = true;\n          this.pair_ = pair;\n          return pair;\n        });\n    } else {\n      // Not supported.\n      this.pairCreated_ = true;\n      this.pair_ = null;\n    }\n  }\n}\n\n/**\n * @param {!PaymentDataRequest} paymentRequest\n * @param {string} param\n * @param {*} value\n */\nfunction setInternalParam(paymentRequest, param, value) {\n  paymentRequest['i'] = Object.assign(paymentRequest['i'] || {}, {\n    [param]: value,\n  });\n}\n\n/**\n * Copyright 2019 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Implements interface to Propensity server\n */\nclass PropensityServer {\n  /**\n   * Page configuration is known when Propensity API\n   * is available, publication ID is therefore used\n   * in constructor for the server interface.\n   * @param {!Window} win\n   * @param {!./deps.DepsDef} deps\n   * @param {!./fetcher.Fetcher} fetcher\n   */\n  constructor(win, deps, fetcher) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n    /** @private @const {string} */\n    this.publicationId_ = this.deps_.pageConfig().getPublicationId();\n    /** @private {?string} */\n    this.clientId_ = null;\n    /** @private @const {!./fetcher.Fetcher} */\n    this.fetcher_ = fetcher;\n    /** @private @const {number} */\n    this.version_ = 1;\n\n    this.deps_\n      .eventManager()\n      .registerEventListener(this.handleClientEvent_.bind(this));\n  }\n\n  /**\n   * @private\n   * @return {string}\n   */\n  getDocumentCookie_() {\n    return this.win_.document.cookie;\n  }\n\n  /**\n   * Returns the client ID to be used.\n   * @return {?string}\n   * @private\n   */\n  getClientId_() {\n    if (!this.clientId_) {\n      // Match '__gads' (name of the cookie) dropped by Ads Tag.\n      const gadsmatch = this.getDocumentCookie_().match(\n        '(^|;)\\\\s*__gads\\\\s*=\\\\s*([^;]+)'\n      );\n      // Since the cookie will be consumed using decodeURIComponent(),\n      // use encodeURIComponent() here to match.\n      this.clientId_ = gadsmatch && encodeURIComponent(gadsmatch.pop());\n    }\n    return this.clientId_;\n  }\n\n  /**\n   * @private\n   * @param {string} url\n   * @return {string}\n   */\n  propensityUrl_(url) {\n    url = addQueryParam(url, 'u_tz', '240');\n    url = addQueryParam(url, 'v', String(this.version_));\n    const clientId = this.getClientId_();\n    if (clientId) {\n      url = addQueryParam(url, 'cookie', clientId);\n    }\n    url = addQueryParam(url, 'cdm', this.win_.location.hostname);\n    return url;\n  }\n\n  /**\n   * @param {string} state\n   * @param {?string} productsOrSkus\n   */\n  sendSubscriptionState(state, productsOrSkus) {\n    const init = /** @type {!../utils/xhr.FetchInitDef} */ ({\n      method: 'GET',\n      credentials: 'include',\n    });\n    let url = adsUrl('/subopt/data');\n    url = addQueryParam(url, 'states', this.publicationId_ + ':' + state);\n    if (productsOrSkus) {\n      url = addQueryParam(url, 'extrainfo', productsOrSkus);\n    }\n    return this.fetcher_.fetch(this.propensityUrl_(url), init);\n  }\n\n  /**\n   * @param {string} event\n   * @param {?string} context\n   * @private\n   */\n  sendEvent_(event, context) {\n    const init = /** @type {!../utils/xhr.FetchInitDef} */ ({\n      method: 'GET',\n      credentials: 'include',\n    });\n    let url = adsUrl('/subopt/data');\n    url = addQueryParam(url, 'events', this.publicationId_ + ':' + event);\n    if (context) {\n      url = addQueryParam(url, 'extrainfo', context);\n    }\n    return this.fetcher_.fetch(this.propensityUrl_(url), init);\n  }\n\n  /**\n   *\n   * @param {!../api/client-event-manager-api.ClientEvent} event\n   */\n  handleClientEvent_(event) {\n    // Propensity does not need this data and does not have the right to\n    // it at this time.  We can consider this if necessary in the future.\n    if (event.eventOriginator === EventOriginator.SHOWCASE_CLIENT) {\n      return;\n    }\n\n    /**\n     * Does a live check of the config because we don't know when publisher\n     * called to enable (it may be after a consent dialog).\n     */\n    if (\n      !this.deps_.config().enablePropensity &&\n      event.eventOriginator !== EventOriginator.PROPENSITY_CLIENT\n    ) {\n      return;\n    }\n\n    if (event.eventType === AnalyticsEvent.EVENT_SUBSCRIPTION_STATE) {\n      this.sendSubscriptionState(\n        event.additionalParameters['state'],\n        event.additionalParameters['productsOrSkus']\n      );\n      return;\n    }\n    const propEvent = analyticsEventToPublisherEvent(event.eventType);\n    if (propEvent == null) {\n      return;\n    }\n    let additionalParameters = event.additionalParameters;\n    // The EventParams object is private to SwG analytics.  Do not send.\n    if (additionalParameters instanceof EventParams) {\n      additionalParameters = undefined;\n    }\n    if (isBoolean(event.isFromUserAction)) {\n      if (!isObject(additionalParameters)) {\n        additionalParameters = {};\n      }\n      additionalParameters['is_active'] = event.isFromUserAction;\n    }\n    this.sendEvent_(\n      propEvent,\n      JSON.stringify(/** @type {?JsonObject} */ (additionalParameters))\n    );\n  }\n\n  /**\n   * @param {JsonObject} response\n   * @return {!../api/propensity-api.PropensityScore}\n   */\n  parsePropensityResponse_(response) {\n    let defaultScore =\n      /** @type {!../api/propensity-api.PropensityScore} */ ({});\n    if (!response['header']) {\n      defaultScore = /** @type {!../api/propensity-api.PropensityScore} */ ({\n        header: {ok: false},\n        body: {error: 'No valid response'},\n      });\n      return defaultScore;\n    }\n    const status = response['header'];\n    let scoreDetails = undefined;\n    if (status['ok']) {\n      const scores = response['scores'];\n      scoreDetails = [];\n      for (let i = 0; i < scores.length; i++) {\n        const result = scores[i];\n        const scoreStatus = !!result['score'];\n        let scoreDetail;\n        if (scoreStatus) {\n          const value = /** @type {!../api/propensity-api.Score} */ ({\n            value: result['score'],\n            bucketed: result['score_type'] == 2,\n          });\n          scoreDetail = /** @type {!../api/propensity-api.Body} */ ({\n            product: result['product'],\n            score: value,\n          });\n        } else {\n          scoreDetail = /** @type {!../api/propensity-api.Body} */ ({\n            product: result['product'],\n            error: result['error_message'],\n          });\n        }\n        scoreDetails.push(scoreDetail);\n      }\n      if (scoreDetails) {\n        defaultScore = /** @type {!../api/propensity-api.PropensityScore} */ ({\n          header: {ok: true},\n          body: {scores: scoreDetails},\n        });\n      }\n      return defaultScore;\n    }\n    defaultScore = /** @type {!../api/propensity-api.PropensityScore} */ ({\n      header: {ok: false},\n      body: {error: response['error']},\n    });\n    return defaultScore;\n  }\n  /**\n   * @param {string} referrer\n   * @param {string} type\n   * @return {?Promise<../api/propensity-api.PropensityScore>}\n   */\n  getPropensity(referrer, type) {\n    const init = /** @type {!../utils/xhr.FetchInitDef} */ ({\n      method: 'GET',\n      credentials: 'include',\n    });\n    const url =\n      adsUrl('/subopt/pts?products=') +\n      this.publicationId_ +\n      '&type=' +\n      type +\n      '&ref=' +\n      referrer;\n    return this.fetcher_\n      .fetch(this.propensityUrl_(url), init)\n      .then((result) => result.json())\n      .then((response) => {\n        return this.parsePropensityResponse_(response);\n      });\n  }\n}\n\n/**\n * Copyright 2019 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @implements {PropensityApi.PropensityApi}\n */\nclass Propensity {\n  /**\n   * @param {!Window} win\n   * @param {!./deps.DepsDef} deps\n   * @param {!./fetcher.Fetcher} fetcher\n   *\n   * IMPORTANT: deps may not be full initialized config and pageConfig are\n   * available immediately, other function should be gated on a ready promise.\n   * #TODO(jpettitt) switch refactor to take out the win and use deps to get win\n   */\n  constructor(win, deps, fetcher) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n    /** @private {PropensityServer} */\n    this.propensityServer_ = new PropensityServer(win, deps, fetcher);\n\n    /** @private @const {!../api/client-event-manager-api.ClientEventManagerApi} */\n    this.eventManager_ = deps.eventManager();\n  }\n\n  /** @override */\n  sendSubscriptionState(state, jsonProducts) {\n    if (!Object.values(SubscriptionState).includes(state)) {\n      throw new Error('Invalid subscription state provided');\n    }\n    if (\n      (SubscriptionState.SUBSCRIBER == state ||\n        SubscriptionState.PAST_SUBSCRIBER == state) &&\n      !jsonProducts\n    ) {\n      throw new Error(\n        'Entitlements must be provided for users with' +\n          ' active or expired subscriptions'\n      );\n    }\n    if (jsonProducts && !isObject(jsonProducts)) {\n      throw new Error('Entitlements must be an Object');\n    }\n    let productsOrSkus = null;\n    if (jsonProducts) {\n      productsOrSkus = JSON.stringify(jsonProducts);\n    }\n    this.propensityServer_.sendSubscriptionState(state, productsOrSkus);\n  }\n\n  /** @override */\n  getPropensity(type) {\n    if (type && !Object.values(PropensityType).includes(type)) {\n      throw new Error('Invalid propensity type requested');\n    }\n    if (!type) {\n      type = PropensityType.GENERAL;\n    }\n    return this.propensityServer_.getPropensity(\n      this.win_.document.referrer,\n      type\n    );\n  }\n\n  /** @override */\n  sendEvent(userEvent) {\n    const analyticsEvent = publisherEventToAnalyticsEvent(userEvent.name);\n    let data = null;\n    if (!isEnumValue(Event, userEvent.name) || !analyticsEvent) {\n      throw new Error('Invalid user event provided(' + userEvent.name + ')');\n    }\n\n    if (userEvent.data) {\n      if (!isObject(userEvent.data)) {\n        throw new Error('Event data must be an Object(' + userEvent.data + ')');\n      } else {\n        data = {};\n        Object.assign(data, userEvent.data);\n      }\n    }\n\n    if (isBoolean(userEvent.active)) {\n      if (!data) {\n        data = {};\n      }\n      Object.assign(data, {'is_active': userEvent.active});\n    } else if (userEvent.active != null) {\n      throw new Error('Event active must be a boolean');\n    }\n\n    this.eventManager_.logEvent({\n      eventType: analyticsEvent,\n      eventOriginator: EventOriginator.PROPENSITY_CLIENT,\n      isFromUserAction: userEvent.active,\n      additionalParameters: data,\n    });\n  }\n}\n\nconst CSS = \".swg-dialog,.swg-toast{background-color:#fff!important;box-sizing:border-box}.swg-toast{border:none!important;bottom:0!important;max-height:46px!important;position:fixed!important;z-index:2147483647!important}@media (min-width:871px) and (min-height:641px){.swg-dialog.swg-wide-dialog{left:-435px!important;width:870px!important}}@media (max-height:640px),(max-width:640px){.swg-dialog,.swg-toast{border-top-left-radius:8px!important;border-top-right-radius:8px!important;box-shadow:0 1px 1px rgba(60,64,67,.3),0 1px 4px 1px rgba(60,64,67,.15)!important;left:-240px!important;margin-left:50vw!important;width:480px!important}}@media (min-width:641px) and (min-height:641px){.swg-dialog{background-color:transparent!important;border:none!important;left:-315px!important;margin-left:50vw!important;width:630px!important}.swg-toast{border-radius:4px!important;bottom:8px!important;box-shadow:0 3px 1px -2px rgb(0 0 0/20%),0 2px 2px 0 rgb(0 0 0/14%),0 1px 5px 0 rgb(0 0 0/12%)!important;left:8px!important}}@media (max-width:480px){.swg-dialog,.swg-toast{left:0!important;margin-left:0!important;right:0!important;width:100%!important}}\\n/*# sourceURL=/./src/components/dialog.css*/\";\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst PREFIX = 'subscribe.google.com';\n\n/**\n * This class is responsible for the storage of data in session storage. If\n * you're looking to store data in local storage, see\n * src/runtime/local-storage.LocalStorage.\n */\nclass Storage {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private @const {!Object<string, !Promise<?string>>} */\n    this.values_ = {};\n  }\n\n  /**\n   * @param {string} key\n   * @param {boolean=} useLocalStorage\n   * @return {!Promise<?string>}\n   */\n  get(key, useLocalStorage = false) {\n    if (!this.values_[key]) {\n      this.values_[key] = new Promise((resolve) => {\n        const storage = useLocalStorage\n          ? this.win_.localStorage\n          : this.win_.sessionStorage;\n        if (storage) {\n          try {\n            resolve(storage.getItem(storageKey(key)));\n          } catch (e) {\n            // Ignore error.\n            resolve(null);\n          }\n        } else {\n          resolve(null);\n        }\n      });\n    }\n    return this.values_[key];\n  }\n\n  /**\n   * @param {string} key\n   * @param {string} value\n   * @param {boolean=} useLocalStorage\n   * @return {!Promise}\n   */\n  set(key, value, useLocalStorage = false) {\n    this.values_[key] = Promise.resolve(value);\n    return new Promise((resolve) => {\n      const storage = useLocalStorage\n        ? this.win_.localStorage\n        : this.win_.sessionStorage;\n      if (storage) {\n        try {\n          storage.setItem(storageKey(key), value);\n        } catch (e) {\n          // Ignore error.\n        }\n      }\n      resolve();\n    });\n  }\n\n  /**\n   * @param {string} key\n   * @param {boolean=} useLocalStorage\n   * @return {!Promise}\n   */\n  remove(key, useLocalStorage = false) {\n    delete this.values_[key];\n    return new Promise((resolve) => {\n      const storage = useLocalStorage\n        ? this.win_.localStorage\n        : this.win_.sessionStorage;\n      if (storage) {\n        try {\n          storage.removeItem(storageKey(key));\n        } catch (e) {\n          // Ignore error.\n        }\n      }\n      resolve();\n    });\n  }\n}\n\n/**\n * @param {string} key\n * @return {string}\n */\nfunction storageKey(key) {\n  return PREFIX + ':' + key;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst NO_PROMISE_ERR = 'No account promise provided';\n\nclass WaitForSubscriptionLookupApi {\n  /**\n   * @param {!./deps.DepsDef} deps\n   * @param {?Promise} accountPromise\n   */\n  constructor(deps, accountPromise) {\n    /** @private @const {!./deps.DepsDef} */\n    this.deps_ = deps;\n\n    /** @private @const {!Window} */\n    this.win_ = deps.win();\n\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = deps.activities();\n\n    /** @private @const {!../components/dialog-manager.DialogManager} */\n    this.dialogManager_ = deps.dialogManager();\n\n    /** @private {?Promise} */\n    this.openViewPromise_ = null;\n\n    /** @private {!Promise} */\n    this.accountPromise_ = accountPromise || Promise.reject(NO_PROMISE_ERR);\n\n    /** @private @const {!ActivityIframeView} */\n    this.activityIframeView_ = new ActivityIframeView(\n      this.win_,\n      this.activityPorts_,\n      feUrl('/waitforsubscriptionlookupiframe'),\n      feArgs({\n        publicationId: deps.pageConfig().getPublicationId(),\n        productId: deps.pageConfig().getProductId(),\n      }),\n      /* shouldFadeBody */ true,\n      /* hasLoadingIndicator */ true\n    );\n  }\n\n  /**\n   * Starts the Login Flow.\n   * @return {!Promise}\n   */\n  start() {\n    this.openViewPromise_ = this.dialogManager_.openView(\n      this.activityIframeView_\n    );\n\n    return this.accountPromise_.then(\n      (account) => {\n        // Account was found.\n        this.dialogManager_.completeView(this.activityIframeView_);\n        return account;\n      },\n      (reason) => {\n        this.dialogManager_.completeView(this.activityIframeView_);\n        throw reason;\n      }\n    );\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @implements {DepsDef}\n * @implements {Subscriptions}\n */\nclass ConfiguredRuntime {\n  /**\n   * @param {!Window|!Document|!Doc} winOrDoc\n   * @param {!../model/page-config.PageConfig} pageConfig\n   * @param {{\n   *     fetcher: (!Fetcher|undefined),\n   *     configPromise: (!Promise|undefined),\n   *     enableGoogleAnalytics: (boolean|undefined),\n   *   }=} integr\n   * @param {!../api/subscriptions.Config=} config\n   * @param {!{\n   *   lang: (string|undefined),\n   *   theme: (!../api/basic-subscriptions.ClientTheme|undefined),\n   *   }=} clientOptions\n   */\n  constructor(winOrDoc, pageConfig, integr, config, clientOptions) {\n    integr = integr || {};\n    integr.configPromise = integr.configPromise || Promise.resolve();\n\n    /** @private @const {!ClientEventManager} */\n    this.eventManager_ = new ClientEventManager(integr.configPromise);\n\n    /** @private @const {!Doc} */\n    this.doc_ = resolveDoc(winOrDoc);\n\n    /** @private @const {!Window} */\n    this.win_ = this.doc_.getWin();\n\n    /** @private @const {!../api/subscriptions.Config} */\n    this.config_ = defaultConfig();\n\n    if (isLegacyEdgeBrowser(this.win_)) {\n      // TODO(dvoytenko, b/120607343): Find a way to remove this restriction\n      // or move it to Web Activities.\n      this.config_.windowOpenMode = WindowOpenMode.REDIRECT;\n    }\n    if (config) {\n      this.configure_(config);\n    }\n\n    /** @private @const {!../model/page-config.PageConfig} */\n    this.pageConfig_ = pageConfig;\n\n    /** @private @const {!Promise} */\n    this.documentParsed_ = this.doc_.whenReady();\n\n    /** @private @const {!JsError} */\n    this.jserror_ = new JsError(this.doc_);\n\n    /** @private @const {!Fetcher} */\n    this.fetcher_ = integr.fetcher || new XhrFetcher(this.win_);\n\n    /** @private @const {!Storage} */\n    this.storage_ = new Storage(this.win_);\n\n    /** @private @const {!DialogManager} */\n    this.dialogManager_ = new DialogManager(this.doc_);\n\n    /** @private @const {!Callbacks} */\n    this.callbacks_ = new Callbacks();\n\n    /** @private {?OffersFlow} */\n    this.lastOffersFlow_ = null;\n\n    /** @private {?ContributionsFlow} */\n    this.lastContributionsFlow_ = null;\n\n    // Start listening to Google Analytics events, if applicable.\n    if (integr.enableGoogleAnalytics) {\n      /** @private @const {!GoogleAnalyticsEventListener} */\n      this.googleAnalyticsEventListener_ = new GoogleAnalyticsEventListener(\n        this\n      );\n      this.googleAnalyticsEventListener_.start();\n    }\n\n    // WARNING: DepsDef ('this') is being progressively defined below.\n    // Constructors will crash if they rely on something that doesn't exist yet.\n    /** @private @const {!../components/activities.ActivityPorts} */\n    this.activityPorts_ = new ActivityPorts$1(this);\n\n    /** @private @const {!AnalyticsService} */\n    this.analyticsService_ = new AnalyticsService(this, this.fetcher_);\n    this.analyticsService_.start();\n\n    /** @private @const {!PayClient} */\n    this.payClient_ = new PayClient(this);\n\n    /** @private @const {!Logger} */\n    this.logger_ = new Logger(this);\n\n    /** @private @const {!EntitlementsManager} */\n    this.entitlementsManager_ = new EntitlementsManager(\n      this.win_,\n      this.pageConfig_,\n      this.fetcher_,\n      this // See note about 'this' above\n    );\n\n    /** @private @const {!ClientConfigManager} */\n    this.clientConfigManager_ = new ClientConfigManager(\n      pageConfig.getPublicationId(),\n      this.fetcher_,\n      clientOptions\n    );\n\n    /** @private @const {!Propensity} */\n    this.propensityModule_ = new Propensity(\n      this.win_,\n      this, // See note about 'this' above\n      this.fetcher_\n    );\n\n    // ALL CLEAR: DepsDef definition now complete.\n    this.eventManager_.logSwgEvent(AnalyticsEvent.IMPRESSION_PAGE_LOAD, false);\n\n    /** @private @const {!OffersApi} */\n    this.offersApi_ = new OffersApi(this.pageConfig_, this.fetcher_);\n\n    /** @private @const {!ButtonApi} */\n    this.buttonApi_ = new ButtonApi(this.doc_, Promise.resolve(this));\n\n    const preconnect = new Preconnect(this.win_.document);\n\n    preconnect.prefetch('https://news.google.com/swg/js/v1/loader.svg');\n    preconnect.preconnect('https://www.gstatic.com/');\n    preconnect.preconnect('https://fonts.googleapis.com/');\n    preconnect.preconnect('https://www.google.com/');\n    LinkCompleteFlow.configurePending(this);\n    PayCompleteFlow.configurePending(this);\n\n    injectStyleSheet(this.doc_, CSS);\n\n    // Report redirect errors if any.\n    this.activityPorts_.onRedirectError((error) => {\n      this.analyticsService_.addLabels(['redirect']);\n      this.eventManager_.logSwgEvent(\n        AnalyticsEvent.EVENT_PAYMENT_FAILED,\n        false\n      );\n      this.jserror_.error('Redirect error', error);\n    });\n  }\n\n  /** @override */\n  doc() {\n    return this.doc_;\n  }\n\n  /** @override */\n  win() {\n    return this.win_;\n  }\n\n  /** @override */\n  pageConfig() {\n    return this.pageConfig_;\n  }\n\n  /** @override */\n  jserror() {\n    return this.jserror_;\n  }\n\n  /** @override */\n  activities() {\n    return this.activityPorts_;\n  }\n\n  /** @override */\n  payClient() {\n    return this.payClient_;\n  }\n\n  /** @override */\n  dialogManager() {\n    return this.dialogManager_;\n  }\n\n  /** @override */\n  entitlementsManager() {\n    return this.entitlementsManager_;\n  }\n\n  /** @override */\n  callbacks() {\n    return this.callbacks_;\n  }\n\n  /** @override */\n  storage() {\n    return this.storage_;\n  }\n\n  /** @override */\n  clientConfigManager() {\n    return this.clientConfigManager_;\n  }\n\n  /** @override */\n  analytics() {\n    return this.analyticsService_;\n  }\n\n  /** @override */\n  init() {\n    // Implemented by the `Runtime` class.\n  }\n\n  /** @override */\n  configure(config) {\n    // Indirected for constructor testing.\n    this.configure_(config);\n  }\n\n  /**\n   * @param {!../api/subscriptions.Config} config\n   * @private\n   */\n  configure_(config) {\n    // Validate first.\n    let error = '';\n    for (const k in config) {\n      const v = config[k];\n      switch (k) {\n        case 'windowOpenMode':\n          if (v != WindowOpenMode.AUTO && v != WindowOpenMode.REDIRECT) {\n            error = 'Unknown windowOpenMode: ' + v;\n          }\n          break;\n        case 'experiments':\n          v.forEach((experiment) => setExperiment(this.win_, experiment, true));\n          if (this.analytics()) {\n            // If analytics service isn't set up yet, then it will get the\n            // experiments later.\n            this.analytics().addLabels(v);\n          }\n          break;\n        case 'analyticsMode':\n          if (v != AnalyticsMode.DEFAULT && v != AnalyticsMode.IMPRESSIONS) {\n            error = 'Unknown analytics mode: ' + v;\n          }\n          break;\n        case 'enableSwgAnalytics':\n          if (!isBoolean(v)) {\n            error = 'Unknown enableSwgAnalytics value: ' + v;\n          }\n          break;\n        case 'enablePropensity':\n          if (!isBoolean(v)) {\n            error = 'Unknown enablePropensity value: ' + v;\n          }\n          break;\n        default:\n          error = 'Unknown config property: ' + k;\n      }\n    }\n    // Throw error string if it's not null\n    assert(!error, error || undefined);\n    // Assign.\n    Object.assign(this.config_, config);\n  }\n\n  /** @override */\n  config() {\n    return this.config_;\n  }\n\n  /** @override */\n  reset() {\n    this.entitlementsManager_.reset();\n    this.closeDialog();\n  }\n\n  /** @override */\n  clear() {\n    this.entitlementsManager_.clear();\n    this.closeDialog();\n  }\n\n  /** Close dialog. */\n  closeDialog() {\n    this.dialogManager_.completeAll();\n  }\n\n  /** @override */\n  start() {\n    // No need to run entitlements without a product or for an unlocked page.\n    if (!this.pageConfig_.getProductId() || !this.pageConfig_.isLocked()) {\n      return Promise.resolve();\n    }\n    this.getEntitlements();\n  }\n\n  /** @override */\n  getEntitlements(params) {\n    return this.entitlementsManager_\n      .getEntitlements(params)\n      .then((entitlements) => {\n        // Auto update internal things tracking the user's current SKU.\n        if (entitlements) {\n          try {\n            const skus = entitlements.entitlements.map(\n              (entitlement) =>\n                entitlement.getSku() || 'unknown subscriptionToken'\n            );\n            if (skus.length > 0) {\n              this.analyticsService_.setSku(skus.join(','));\n            }\n          } catch (ex) {}\n        }\n        return entitlements.clone();\n      });\n  }\n\n  /** @override */\n  setOnEntitlementsResponse(callback) {\n    this.callbacks_.setOnEntitlementsResponse(callback);\n  }\n\n  /** @override */\n  getOffers(options) {\n    return this.offersApi_.getOffers(options && options.productId);\n  }\n\n  /** @override */\n  showOffers(options) {\n    return this.documentParsed_.then(() => {\n      const errorMessage =\n        'The showOffers() method cannot be used to update a subscription. ' +\n        'Use the showUpdateOffers() method instead.';\n      assert(options ? !options['oldSku'] : true, errorMessage);\n      this.lastOffersFlow_ = new OffersFlow(this, options);\n      return this.lastOffersFlow_.start();\n    });\n  }\n\n  /** @override */\n  showUpdateOffers(options) {\n    assert(\n      isExperimentOn(this.win_, ExperimentFlags.REPLACE_SUBSCRIPTION),\n      'Not yet launched!'\n    );\n    return this.documentParsed_.then(() => {\n      const errorMessage =\n        'The showUpdateOffers() method cannot be used for new subscribers. ' +\n        'Use the showOffers() method instead.';\n      assert(options ? !!options['oldSku'] : false, errorMessage);\n      const flow = new OffersFlow(this, options);\n      return flow.start();\n    });\n  }\n\n  /** @override */\n  showSubscribeOption(options) {\n    return this.documentParsed_.then(() => {\n      const flow = new SubscribeOptionFlow(this, options);\n      return flow.start();\n    });\n  }\n\n  /** @override */\n  showAbbrvOffer(options) {\n    return this.documentParsed_.then(() => {\n      const flow = new AbbrvOfferFlow(this, options);\n      return flow.start();\n    });\n  }\n\n  /** @override */\n  showContributionOptions(options) {\n    return this.documentParsed_.then(() => {\n      this.lastContributionsFlow_ = new ContributionsFlow(this, options);\n      return this.lastContributionsFlow_.start();\n    });\n  }\n\n  /**\n   * Get the last contribution offers flow.\n   * @return {?ContributionsFlow}\n   */\n  getLastContributionsFlow() {\n    return this.lastContributionsFlow_;\n  }\n\n  /** @override */\n  waitForSubscriptionLookup(accountPromise) {\n    return this.documentParsed_.then(() => {\n      const wait = new WaitForSubscriptionLookupApi(this, accountPromise);\n      return wait.start();\n    });\n  }\n\n  /** @override */\n  setOnLoginRequest(callback) {\n    this.callbacks_.setOnLoginRequest(callback);\n  }\n\n  /** @override */\n  triggerLoginRequest(request) {\n    this.callbacks_.triggerLoginRequest(request);\n  }\n\n  /** @override */\n  setOnLinkComplete(callback) {\n    this.callbacks_.setOnLinkComplete(callback);\n  }\n\n  /** @override */\n  linkAccount(params = {}) {\n    return this.documentParsed_.then(() => {\n      return new LinkbackFlow(this).start(params);\n    });\n  }\n\n  /** @override */\n  saveSubscription(saveSubscriptionRequestCallback) {\n    return this.documentParsed_.then(() => {\n      return new LinkSaveFlow(this, saveSubscriptionRequestCallback).start();\n    });\n  }\n\n  /** @override */\n  showLoginPrompt() {\n    return this.documentParsed_.then(() => {\n      return new LoginPromptApi(this).start();\n    });\n  }\n\n  /** @override */\n  showLoginNotification() {\n    return this.documentParsed_.then(() => {\n      return new LoginNotificationApi(this).start();\n    });\n  }\n\n  /** @override */\n  setOnNativeSubscribeRequest(callback) {\n    this.callbacks_.setOnSubscribeRequest(callback);\n  }\n\n  /** @override */\n  setOnSubscribeResponse(callback) {\n    this.callbacks_.setOnSubscribeResponse(callback);\n  }\n\n  /** @override */\n  setOnPaymentResponse(callback) {\n    this.callbacks_.setOnPaymentResponse(callback);\n  }\n\n  /** @override */\n  subscribe(sku) {\n    const errorMessage =\n      'The subscribe() method can only take a sku as its parameter; ' +\n      'for subscription updates please use the updateSubscription() method';\n    assert(typeof sku === 'string', errorMessage);\n    return this.documentParsed_.then(() => {\n      return new PayStartFlow(this, {'skuId': sku}).start();\n    });\n  }\n\n  /** @override */\n  updateSubscription(subscriptionRequest) {\n    assert(\n      isExperimentOn(this.win_, ExperimentFlags.REPLACE_SUBSCRIPTION),\n      'Not yet launched!'\n    );\n    const errorMessage =\n      'The updateSubscription() method should be used for subscription ' +\n      'updates; for new subscriptions please use the subscribe() method';\n    assert(\n      subscriptionRequest ? subscriptionRequest['oldSku'] : false,\n      errorMessage\n    );\n    return this.documentParsed_.then(() => {\n      return new PayStartFlow(this, subscriptionRequest).start();\n    });\n  }\n\n  /** @override */\n  setOnContributionResponse(callback) {\n    this.callbacks_.setOnContributionResponse(callback);\n  }\n\n  /** @override */\n  contribute(skuOrSubscriptionRequest) {\n    /** @type {!../api/subscriptions.SubscriptionRequest} */\n    const request =\n      typeof skuOrSubscriptionRequest == 'string'\n        ? {'skuId': skuOrSubscriptionRequest}\n        : skuOrSubscriptionRequest;\n    return this.documentParsed_.then(() => {\n      return new PayStartFlow(\n        this,\n        request,\n        ProductType.UI_CONTRIBUTION\n      ).start();\n    });\n  }\n\n  /** @override */\n  completeDeferredAccountCreation(options) {\n    return this.documentParsed_.then(() => {\n      return new DeferredAccountFlow(this, options || null).start();\n    });\n  }\n\n  /** @override */\n  setOnFlowStarted(callback) {\n    this.callbacks_.setOnFlowStarted(callback);\n  }\n\n  /** @override */\n  setOnFlowCanceled(callback) {\n    this.callbacks_.setOnFlowCanceled(callback);\n  }\n\n  /** @override */\n  createButton(optionsOrCallback, callback) {\n    // This is a minor duplication to allow this code to be sync.\n    return this.buttonApi_.create(optionsOrCallback, callback);\n  }\n\n  /** @override */\n  attachButton(button, optionsOrCallback, callback) {\n    // This is a minor duplication to allow this code to be sync.\n    this.buttonApi_.attach(button, optionsOrCallback, callback);\n  }\n\n  /** @override */\n  attachSmartButton(button, optionsOrCallback, callback) {\n    assert(\n      isExperimentOn(this.win_, ExperimentFlags.SMARTBOX),\n      'Not yet launched!'\n    );\n    this.buttonApi_.attachSmartButton(\n      this,\n      button,\n      optionsOrCallback,\n      callback\n    );\n  }\n\n  /** @override */\n  getPropensityModule() {\n    return Promise.resolve(this.propensityModule_);\n  }\n\n  /**\n   * This one exists as an internal helper so SwG logging doesn't require a promise.\n   * @return {!ClientEventManager}\n   */\n  eventManager() {\n    return this.eventManager_;\n  }\n\n  /**\n   * Get the last subscription offers flow.\n   * @return {?OffersFlow}\n   */\n  getLastOffersFlow() {\n    return this.lastOffersFlow_;\n  }\n\n  /**\n   * This one exists as a public API so publishers can subscribe to SwG events.\n   * @override */\n  getEventManager() {\n    return Promise.resolve(this.eventManager_);\n  }\n\n  /** @override */\n  getLogger() {\n    return Promise.resolve(this.logger_);\n  }\n\n  /** @override */\n  setShowcaseEntitlement(entitlement) {\n    if (\n      !entitlement ||\n      !isSecure(this.win().location) ||\n      !wasReferredByGoogle(parseUrl(this.win().document.referrer)) ||\n      !queryStringHasFreshGaaParams(\n        this.win().location.search,\n        /*allowAllAccessTypes=*/ true\n      )\n    ) {\n      return Promise.resolve();\n    }\n\n    const eventsToLog =\n      showcaseEventToAnalyticsEvents(entitlement.entitlement) || [];\n    const params = new EventParams();\n    params.setIsUserRegistered(entitlement.isUserRegistered);\n\n    for (let i = 0; i < eventsToLog.length; i++) {\n      this.eventManager().logEvent({\n        eventType: eventsToLog[i],\n        eventOriginator: EventOriginator.SHOWCASE_CLIENT,\n        isFromUserAction: false,\n        additionalParameters: params,\n      });\n    }\n\n    return Promise.resolve();\n  }\n\n  /** @override */\n  consumeShowcaseEntitlementJwt(showcaseEntitlementJwt, onCloseDialog) {\n    const entitlements = this.entitlementsManager().parseEntitlements({\n      signedEntitlements: showcaseEntitlementJwt,\n    });\n    entitlements.consume(onCloseDialog);\n  }\n\n  /** @override */\n  showBestAudienceAction() {\n    warn('Not implemented yet');\n  }\n}\n\nexport { AnalyticsEvent, ClientEvent, ClientEventManagerApi, ConfiguredRuntime, DeferredAccountCreationResponse, Entitlement, Entitlements, EventOriginator, Fetcher, FilterResult, PurchaseData, SubscribeResponse, UserData };\n", "/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/** Version: 0.1.22.190 */\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// NOTE: Please don't edit this file directly!\n//   This document describes how to change i18n strings in swg-js: https://docs.google.com/document/d/1FMEKJ_TmjHhqON0krE4xhDbTEj0I0DnvzxMzB2cWUWA/edit?resourcekey=0-TQ7hPOzAD4hX8x9PfweGSg#heading=h.q9gi7t4h1tyj\n\nconst I18N_STRINGS = {\n  'SHOWCASE_REGWALL_TITLE': {\n    'bn': 'Google-\u098F \u0986\u09B0\u0993 \u0985\u09A8\u09C7\u0995 \u0995\u09BF\u099B\u09C1\u09B0 \u09B8\u09C1\u09AC\u09BF\u09A7\u09BE \u09AA\u09BE\u09A8',\n    'cs': 'Z\u00EDskejte s&nbsp;Googlem v\u00EDc',\n    'de': 'Immer gut informiert mit Google',\n    'en': 'Get more with Google',\n    'es': 'Disfruta de m\u00E1s art\u00EDculos con Google',\n    'es-ar': 'Disfruta m\u00E1s art\u00EDculos con Google',\n    'fr': 'Plus de contenus avec Google',\n    'fr-ca': 'Aller plus loin avec Google',\n    'hi': 'Google \u0915\u0940 \u092E\u0926\u0926 \u0938\u0947 \u095B\u094D\u092F\u093E\u0926\u093E \u092E\u0941\u092B\u093C\u094D\u0924 \u0932\u0947\u0916 \u092A\u093E\u090F\u0902',\n    'it': 'Con Google puoi avere di pi\u00F9',\n    'ja': 'Google \u304B\u3089\u306E\u30D7\u30EC\u30BC\u30F3\u30C8',\n    'kn': 'Google \u0CA8\u0CBF\u0C82\u0CA6 \u0CB9\u0CC6\u0C9A\u0CCD\u0C9A\u0CBF\u0CA8 \u0CAA\u0CCD\u0CB0\u0CAF\u0CCB\u0C9C\u0CA8 \u0CAA\u0CA1\u0CC6\u0CAF\u0CBF\u0CB0\u0CBF',\n    'ml': 'Google \u0D09\u0D2A\u0D2F\u0D47\u0D3E\u0D17\u0D3F\u0D1A\u0D4D\u0D1A\u0D4D \u0D15\u0D42\u0D1F\u0D41\u0D24\u0D7D \u0D2A\u0D4D\u0D30\u0D2F\u0D47\u0D3E\u0D1C\u0D28\u0D19\u0D4D\u0D19\u0D7E \u0D28\u0D47\u0D1F\u0D42',\n    'mr': 'Google \u0935\u093E\u092A\u0930\u0942\u0928 \u092C\u0930\u0947\u091A \u0915\u093E\u0939\u0940 \u092E\u093F\u0933\u0935\u093E',\n    'nl': 'Krijg meer met Google',\n    'pt-br': 'Veja mais com o Google',\n    'pt-pt': 'Obtenha mais com a Google',\n    'ta': 'Google \u0BAE\u0BC2\u0BB2\u0BAE\u0BCD \u0BAE\u0BC7\u0BB2\u0BC1\u0BAE\u0BCD \u0BAA\u0BB2 \u0B95\u0B9F\u0BCD\u0B9F\u0BC1\u0BB0\u0BC8\u0B95\u0BB3\u0BC8\u0BAA\u0BCD \u0BAA\u0B9F\u0BBF\u0BAF\u0BC1\u0B99\u0BCD\u0B95\u0BB3\u0BCD',\n    'te': 'Google\u0C24\u0C4B \u0C2E\u0C30\u0C3F\u0C28\u0C4D\u0C28\u0C3F \u0C2A\u0C4D\u0C30\u0C2F\u0C4B\u0C1C\u0C28\u0C3E\u0C32\u0C28\u0C41 \u0C2A\u0C4A\u0C02\u0C26\u0C02\u0C21\u0C3F',\n  },\n  'SHOWCASE_REGWALL_DESCRIPTION': {\n    'bn': '<strong></strong>\u098F\u0987 \u0995\u09A8\u09CD\u099F\u09C7\u09A8\u09CD\u099F \u0985\u09CD\u09AF\u09BE\u0995\u09CD\u09B8\u09C7\u09B8 \u0995\u09B0\u09BE\u09B0 \u099C\u09A8\u09CD\u09AF \u09B8\u09BE\u09A7\u09BE\u09B0\u09A3\u09A4 \u09AA\u09C7\u09AE\u09C7\u09A8\u09CD\u099F \u0995\u09B0\u09A4\u09C7 \u09B9\u09DF \u0995\u09BF\u09A8\u09CD\u09A4\u09C1 Google \u0986\u09AA\u09A8\u09BE\u0995\u09C7 \u098F\u0987 \u09A8\u09BF\u09AC\u09A8\u09CD\u09A7 \u09AB\u09CD\u09B0\u09BF\u09A4\u09C7 \u0985\u09CD\u09AF\u09BE\u0995\u09CD\u09B8\u09C7\u09B8 \u0995\u09B0\u09A4\u09C7 \u098F\u09AC\u0982 \u09B8\u09C7\u0987\u09B8\u09BE\u09A5\u09C7 \u0985\u09A8\u09C7\u0995 \u0995\u09BF\u099B\u09C1 \u09AA\u09C7\u09A4\u09C7 \u09B8\u09BE\u09B9\u09BE\u09AF\u09CD\u09AF \u0995\u09B0\u099B\u09C7\u0964 \u098F\u0987 \u09B8\u09C1\u09AC\u09BF\u09A7\u09BE \u09AA\u09BE\u0993\u09DF\u09BE\u09B0 \u099C\u09A8\u09CD\u09AF Google \u0985\u09CD\u09AF\u09BE\u0995\u09BE\u0989\u09A8\u09CD\u099F \u09AC\u09CD\u09AF\u09AC\u09B9\u09BE\u09B0 \u0995\u09B0\u09C7 \u0986\u09AA\u09A8\u09BE\u0995\u09C7 <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>-\u098F \u09B0\u09C7\u099C\u09BF\u09B8\u09CD\u099F\u09BE\u09B0 \u0995\u09B0\u09A4\u09C7 \u09B9\u09AC\u09C7\u0964',\n    'cs': '<strong></strong>Tento obsah je obvykle zpoplatn\u011Bn, ale pokud se do publikace <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> zaregistrujete pomoc\u00ED \u00FA\u010Dtu Google, z\u00EDsk\u00E1te od Googlu p\u0159\u00EDstup zdarma.',\n    'de': '<strong></strong>Dieser Inhalt ist normalerweise kostenpflichtig. Google gew\u00E4hrt dir jedoch kostenlos Zugriff auf diesen Artikel und andere Inhalte, wenn du dich mit deinem Google-Konto bei <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> registrierst.',\n    'en': '<strong></strong>This content usually requires payment, but Google is giving you free access to this article and more when you register with <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> using your Google Account.',\n    'es': '<strong></strong>Normalmente, es necesario pagar para ver este contenido, pero Google te ofrece acceso gratuito a este y otros art\u00EDculos si te registras en <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> con tu cuenta de Google.',\n    'es-ar':\n      '<strong></strong>Normalmente, es necesario pagar para ver este contenido, pero Google te ofrece acceso gratuito a este y otros art\u00EDculos si te registras en <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> con tu Cuenta&nbsp;de&nbsp;Google.',\n    'fr': '<strong></strong>Ce contenu est g\u00E9n\u00E9ralement payant, mais vous pouvez lire cet article et d\\'autres contenus gratuitement gr\u00E2ce \u00E0 Google en vous inscrivant sur <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> avec votre compte Google.',\n    'fr-ca':\n      '<strong></strong>Ce contenu est g\u00E9n\u00E9ralement payant, mais Google vous offre un acc\u00E8s gratuit \u00E0 cet article et \u00E0 d\\'autres si vous vous inscrivez \u00E0 <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> \u00E0 l\\'aide de votre compte Google.',\n    'hi': '<strong></strong>\u0907\u0938 \u0915\u0949\u0928\u094D\u091F\u0947\u0902\u091F \u0915\u094B \u092A\u0922\u093C\u0928\u0947 \u0915\u0947 \u0932\u093F\u090F \u092A\u0948\u0938\u0947 \u091A\u0941\u0915\u093E\u0928\u0947 \u092A\u0921\u093C\u0924\u0947 \u0939\u0948\u0902, \u0932\u0947\u0915\u093F\u0928 \u0906\u092A Google \u0915\u0940 \u092E\u0926\u0926 \u0938\u0947 \u0907\u0938 \u0932\u0947\u0916 \u0914\u0930 \u0905\u0928\u094D\u092F \u0915\u0949\u0928\u094D\u091F\u0947\u0902\u091F \u0915\u094B \u092E\u0941\u092B\u094D\u093C\u0924 \u092E\u0947\u0902 \u092A\u0922\u093C \u0938\u0915\u0924\u0947 \u0939\u0948\u0902. \u0907\u0938\u0915\u0947 \u0932\u093F\u090F, \u0906\u092A\u0915\u094B Google \u0916\u093E\u0924\u0947 \u0915\u093E \u0907\u0938\u094D\u0924\u0947\u092E\u093E\u0932 \u0915\u0930\u0915\u0947, <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> \u092E\u0947\u0902 \u0930\u091C\u093F\u0938\u094D\u091F\u0930 \u0915\u0930\u0928\u093E \u0939\u094B\u0917\u093E.',\n    'it': '<strong></strong>Generalmente questi contenuti sono a pagamento, ma Google ti offre accesso gratuito a questo articolo e ad altri articoli se ti registri a <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> usando il tuo Account Google.',\n    'ja': '<strong></strong>\u901A\u5E38\u3001\u3053\u306E\u8A18\u4E8B\u3092\u304A\u8AAD\u307F\u3044\u305F\u3060\u304F\u306B\u306F\u304A\u652F\u6255\u3044\u304C\u5FC5\u8981\u3067\u3059\u304C\u3001\u304A\u4F7F\u3044\u306E Google \u30A2\u30AB\u30A6\u30F3\u30C8\u3067 <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> \u306B\u767B\u9332\u3059\u308B\u3068\u3001\u3053\u306E\u8A18\u4E8B\u3092\u7121\u6599\u3067\u304A\u8AAD\u307F\u3044\u305F\u3060\u3051\u307E\u3059\u3002',\n    'kn': '<strong></strong>\u0CB8\u0CBE\u0CAE\u0CBE\u0CA8\u0CCD\u0CAF\u0CB5\u0CBE\u0C97\u0CBF \u0C88 \u0CB5\u0CBF\u0CB7\u0CAF\u0C95\u0CCD\u0C95\u0CBE\u0C97\u0CBF \u0CB9\u0CA3 \u0CAA\u0CBE\u0CB5\u0CA4\u0CBF\u0CB8\u0CAC\u0CC7\u0C95\u0CBE\u0C97\u0CC1\u0CA4\u0CCD\u0CA4\u0CA6\u0CC6, \u0C86\u0CA6\u0CB0\u0CC6 \u0CA8\u0CC0\u0CB5\u0CC1 <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> \u0C97\u0CC6 \u0CA8\u0CBF\u0CAE\u0CCD\u0CAE Google \u0C96\u0CBE\u0CA4\u0CC6\u0CAF \u0CAE\u0CC2\u0CB2\u0C95 \u0CA8\u0CCB\u0C82\u0CA6\u0CBE\u0CAF\u0CBF\u0CB8\u0CBF\u0C95\u0CCA\u0C82\u0CA1\u0CBE\u0C97 Google \u0C88 \u0CB2\u0CC7\u0C96\u0CA8 \u0CAE\u0CA4\u0CCD\u0CA4\u0CC1 \u0C87\u0CA8\u0CCD\u0CA8\u0CB7\u0CCD\u0C9F\u0CC1 \u0CB5\u0CBF\u0CB7\u0CAF\u0C97\u0CB3\u0CBF\u0C97\u0CC6 \u0CA8\u0CBF\u0CAE\u0C97\u0CC6 \u0C89\u0C9A\u0CBF\u0CA4\u0CB5\u0CBE\u0CA6 \u0CAA\u0CCD\u0CB0\u0CB5\u0CC7\u0CB6\u0CB5\u0CA8\u0CCD\u0CA8\u0CC1 \u0CA8\u0CC0\u0CA1\u0CC1\u0CA4\u0CCD\u0CA4\u0CA6\u0CC6.',\n    'ml': '<strong></strong>\u0D38\u0D3E\u0D27\u0D3E\u0D30\u0D23 \u0D08 \u0D09\u0D33\u0D4D\u0D33\u0D1F\u0D15\u0D4D\u0D15\u0D24\u0D4D\u0D24\u0D3F\u0D28\u0D4D \u0D2A\u0D23\u0D02 \u0D28\u0D7D\u0D15\u0D47\u0D23\u0D4D\u0D1F\u0D24\u0D41\u0D23\u0D4D\u0D1F\u0D4D, \u0D0E\u0D28\u0D4D\u0D28\u0D3E\u0D7D Google \u0D05\u0D15\u0D4D\u0D15\u0D57\u0D23\u0D4D\u0D1F\u0D4D \u0D09\u0D2A\u0D2F\u0D47\u0D3E\u0D17\u0D3F\u0D1A\u0D4D\u0D1A\u0D4D <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> \u0D0E\u0D28\u0D4D\u0D28\u0D24\u0D3F\u0D7D \u0D30\u0D1C\u0D3F\u0D38\u0D4D\u200C\u0D31\u0D4D\u0D31\u0D7C \u0D1A\u0D46\u0D2F\u0D4D\u0D2F\u0D41\u0D2E\u0D4D\u0D2A\u0D47\u0D3E\u0D7E, \u0D08 \u0D32\u0D47\u0D16\u0D28\u0D24\u0D4D\u0D24\u0D3F\u0D32\u0D47\u0D15\u0D4D\u0D15\u0D41\u0D02 \u0D2E\u0D31\u0D4D\u0D31\u0D41\u0D02 Google \u0D28\u0D3F\u0D19\u0D4D\u0D19\u0D7E\u0D15\u0D4D\u0D15\u0D4D \u0D38\u0D57\u0D1C\u0D28\u0D4D\u0D2F \u0D06\u0D15\u0D4D\u200C\u0D38\u0D38\u0D4D \u0D28\u0D7D\u0D15\u0D41\u0D28\u0D4D\u0D28\u0D41.',\n    'mr': '<strong></strong>\u092F\u093E \u0906\u0936\u092F\u093E\u0938\u093E\u0920\u0940 \u0938\u093E\u092E\u093E\u0928\u094D\u092F\u0924\u0903 \u092A\u0947\u092E\u0947\u0902\u091F \u0906\u0935\u0936\u094D\u092F\u0915 \u0905\u0938\u0924\u0947 \u092A\u0923 \u0924\u0941\u092E\u094D\u0939\u0940 \u0924\u0941\u092E\u091A\u0947 Google \u0916\u093E\u0924\u0947 \u0935\u093E\u092A\u0930\u0942\u0928 <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> \u092E\u0927\u094D\u092F\u0947 \u0928\u094B\u0902\u0926\u0923\u0940 \u0915\u0930\u0924\u093E \u0924\u0947\u0935\u094D\u0939\u093E, Google \u0924\u0941\u092E\u094D\u0939\u093E\u0932\u093E \u092F\u093E \u0932\u0947\u0916\u093E\u091A\u093E \u0906\u0923\u093F \u0906\u0923\u0916\u0940 \u092C\u0931\u094D\u092F\u093E\u091A \u0906\u0936\u092F\u093E\u091A\u093E \u0935\u093F\u0928\u093E\u092E\u0942\u0932\u094D\u092F \u0972\u0915\u094D\u0938\u0947\u0938 \u0926\u0947\u0924\u0947.',\n    'nl': '<strong></strong>Voor deze content moet je eigenlijk betalen. Maar Google geeft je kosteloos toegang tot dit artikel en andere content als je je registreert bij <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> via je Google-account.',\n    'pt-br':\n      '<strong></strong>Normalmente, \u00E9 preciso pagar por este conte\u00FAdo. Por\u00E9m, basta voc\u00EA se registrar na publica\u00E7\u00E3o <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> usando sua Conta do Google para ter acesso gratuito a esta mat\u00E9ria e muito mais.',\n    'pt-pt':\n      '<strong></strong>Geralmente, este conte\u00FAdo requer um pagamento, mas a Google concede-lhe acesso gratuito a este artigo e muito mais ao registar-se na publica\u00E7\u00E3o <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> com a sua Conta Google.',\n    'ta': '<strong></strong>\u0BB5\u0BB4\u0B95\u0BCD\u0B95\u0BAE\u0BBE\u0B95 \u0B87\u0BA8\u0BCD\u0BA4 \u0B89\u0BB3\u0BCD\u0BB3\u0B9F\u0B95\u0BCD\u0B95\u0BA4\u0BCD\u0BA4\u0BC8 \u0BB5\u0BBE\u0B9A\u0BBF\u0B95\u0BCD\u0B95 \u0B95\u0B9F\u0BCD\u0B9F\u0BA3\u0BAE\u0BCD \u0B9A\u0BC6\u0BB2\u0BC1\u0BA4\u0BCD\u0BA4 \u0BB5\u0BC7\u0BA3\u0BCD\u0B9F\u0BBF\u0BAF\u0BBF\u0BB0\u0BC1\u0B95\u0BCD\u0B95\u0BC1\u0BAE\u0BCD. \u0B86\u0BA9\u0BBE\u0BB2\u0BCD <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> \u0B87\u0BB2\u0BCD \u0B89\u0B99\u0BCD\u0B95\u0BB3\u0BCD Google \u0B95\u0BA3\u0B95\u0BCD\u0B95\u0BC8\u0BAA\u0BCD \u0BAA\u0BAF\u0BA9\u0BCD\u0BAA\u0B9F\u0BC1\u0BA4\u0BCD\u0BA4\u0BBF\u0BAA\u0BCD \u0BAA\u0BA4\u0BBF\u0BB5\u0BC1\u0B9A\u0BC6\u0BAF\u0BCD\u0BAF\u0BC1\u0BAE\u0BCD\u0BAA\u0BCB\u0BA4\u0BC1 \u0B87\u0BA8\u0BCD\u0BA4\u0B95\u0BCD \u0B95\u0B9F\u0BCD\u0B9F\u0BC1\u0BB0\u0BC8\u0B95\u0BCD\u0B95\u0BC1\u0BAE\u0BCD \u0BAE\u0BC7\u0BB2\u0BC1\u0BAE\u0BCD \u0BAA\u0BB2\u0BB5\u0BB1\u0BCD\u0BB1\u0BC1\u0B95\u0BCD\u0B95\u0BC1\u0BAE\u0BCD Google \u0B87\u0BB2\u0BB5\u0B9A \u0B85\u0BA3\u0BC1\u0B95\u0BB2\u0BC8 \u0BB5\u0BB4\u0B99\u0BCD\u0B95\u0BC1\u0B95\u0BBF\u0BB1\u0BA4\u0BC1.',\n    'te': '<strong></strong>\u0C08 \u0C15\u0C02\u0C1F\u0C46\u0C02\u0C1F\u0C4D\u200C\u0C15\u0C41 \u0C2E\u0C40\u0C30\u0C41 \u0C38\u0C3E\u0C27\u0C3E\u0C30\u0C23\u0C02\u0C17\u0C3E \u0C2A\u0C47\u0C2E\u0C46\u0C02\u0C1F\u0C4D \u0C1A\u0C47\u0C2F\u0C3E\u0C32\u0C4D\u0C38\u0C3F \u0C09\u0C02\u0C1F\u0C41\u0C02\u0C26\u0C3F, \u0C15\u0C3E\u0C28\u0C40 \u0C2E\u0C40\u0C30\u0C41 Google \u0C16\u0C3E\u0C24\u0C3E\u0C28\u0C41 \u0C09\u0C2A\u0C2F\u0C4B\u0C17\u0C3F\u0C02\u0C1A\u0C3F <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>\u0C24\u0C4B \u0C30\u0C3F\u0C1C\u0C3F\u0C38\u0C4D\u0C1F\u0C30\u0C4D \u0C1A\u0C47\u0C38\u0C41\u0C15\u0C41\u0C28\u0C4D\u0C28\u0C2A\u0C4D\u0C2A\u0C41\u0C21\u0C41, \u0C08 \u0C35\u0C3E\u0C30\u0C4D\u0C24\u0C3E \u0C15\u0C25\u0C28\u0C3E\u0C28\u0C3F\u0C15\u0C3F \u0C07\u0C02\u0C15\u0C3E \u0C2E\u0C30\u0C46\u0C28\u0C4D\u0C28\u0C4B \u0C35\u0C3E\u0C1F\u0C3F\u0C15\u0C3F Google, \u0C09\u0C1A\u0C3F\u0C24 \u0C2F\u0C3E\u0C15\u0C4D\u0C38\u0C46\u0C38\u0C4D\u200C\u0C28\u0C41 \u0C07\u0C38\u0C4D\u0C24\u0C41\u0C02\u0C26\u0C3F.',\n  },\n  'SHOWCASE_REGWALL_PUBLISHER_SIGN_IN_BUTTON': {\n    'bn': '\u0986\u09AA\u09A8\u09BE\u09B0 \u0995\u09BF \u0986\u0997\u09C7 \u09A5\u09C7\u0995\u09C7\u0987 \u0985\u09CD\u09AF\u09BE\u0995\u09BE\u0989\u09A8\u09CD\u099F \u0986\u099B\u09C7?',\n    'cs': 'U\u017E m\u00E1te \u00FA\u010Det?',\n    'de': 'Du hast bereits ein Konto?',\n    'en': 'Already have an account?',\n    'es': '\u00BFYa tienes una cuenta?',\n    'es-ar': '\u00BFYa tienes una cuenta?',\n    'fr': 'Vous avez d\u00E9j\u00E0 un compte&nbsp;?',\n    'fr-ca': 'Vous avez d\u00E9j\u00E0 un compte?',\n    'hi': '\u0915\u094D\u092F\u093E \u0906\u092A\u0915\u0947 \u092A\u093E\u0938 \u092A\u0939\u0932\u0947 \u0938\u0947 \u0915\u094B\u0908 \u092A\u094D\u0930\u0915\u093E\u0936\u0915 \u0916\u093E\u0924\u093E \u0939\u0948?',\n    'it': 'Hai gi\u00E0 un account?',\n    'ja': '\u3059\u3067\u306B\u30A2\u30AB\u30A6\u30F3\u30C8\u3092\u304A\u6301\u3061\u3067\u3059\u304B\uFF1F',\n    'kn': '\u0C88\u0C97\u0CBE\u0C97\u0CB2\u0CC7 \u0C96\u0CBE\u0CA4\u0CC6\u0CAF\u0CCA\u0C82\u0CA6\u0CA8\u0CCD\u0CA8\u0CC1 \u0CB9\u0CCA\u0C82\u0CA6\u0CBF\u0CA6\u0CCD\u0CA6\u0CC0\u0CB0\u0CBE?',\n    'ml': '\u0D2E\u0D41\u0D2E\u0D4D\u0D2A\u0D47 \u0D05\u0D15\u0D4D\u0D15\u0D57\u0D23\u0D4D\u0D1F\u0D41\u0D23\u0D4D\u0D1F\u0D4B?',\n    'mr': '\u0906\u0927\u0940\u092A\u093E\u0938\u0942\u0928 \u0916\u093E\u0924\u0947 \u0906\u0939\u0947?',\n    'nl': 'Heb je al een account?',\n    'pt-br': 'J\u00E1 tem uma conta?',\n    'pt-pt': 'J\u00E1 tem uma conta?',\n    'ta': '\u0B8F\u0BB1\u0BCD\u0B95\u0BC6\u0BA9\u0BB5\u0BC7 \u0B95\u0BA3\u0B95\u0BCD\u0B95\u0BC1 \u0B89\u0BB3\u0BCD\u0BB3\u0BA4\u0BBE?',\n    'te': '\u0C07\u0C2A\u0C4D\u0C2A\u0C1F\u0C3F\u0C15\u0C47 \u0C16\u0C3E\u0C24\u0C3E \u0C09\u0C02\u0C26\u0C3E?',\n  },\n  'SHOWCASE_REGWALL_GOOGLE_SIGN_IN_BUTTON': {\n    'bn': 'Google \u09A6\u09BF\u09DF\u09C7 \u09B8\u09BE\u0987\u09A8-\u0987\u09A8 \u0995\u09B0\u09C1\u09A8',\n    'cs': 'P\u0159ihl\u00E1sit se p\u0159es Google',\n    'de': '\u00DCber Google anmelden',\n    'en': 'Sign in with Google',\n    'es': 'Iniciar sesi\u00F3n con Google',\n    'es-ar': 'Acceder con Google',\n    'fr': 'Se connecter avec Google',\n    'fr-ca': 'Se connecter avec Google',\n    'hi': 'Google \u0938\u0947 \u0938\u093E\u0907\u0928 \u0907\u0928 \u0915\u0930\u0947\u0902',\n    'it': 'Accedi con Google',\n    'ja': 'Google \u3067\u30ED\u30B0\u30A4\u30F3',\n    'kn': 'Google \u0C96\u0CBE\u0CA4\u0CC6 \u0CAC\u0CB3\u0CB8\u0CBF\u0C95\u0CCA\u0C82\u0CA1\u0CC1 \u0CB8\u0CC8\u0CA8\u0CCD \u0C87\u0CA8\u0CCD \u0CAE\u0CBE\u0CA1\u0CBF',\n    'ml': 'Google \u0D09\u0D2A\u0D2F\u0D4B\u0D17\u0D3F\u0D1A\u0D4D\u0D1A\u0D4D \u0D38\u0D48\u0D7B \u0D07\u0D7B \u0D1A\u0D46\u0D2F\u0D4D\u0D2F\u0D41\u0D15',\n    'mr': 'Google \u0935\u093E\u092A\u0930\u0942\u0928 \u0938\u093E\u0907\u0928 \u0907\u0928 \u0915\u0930\u093E',\n    'nl': 'Inloggen met Google',\n    'pt-br': 'Fazer login com o Google',\n    'pt-pt': 'Iniciar sess\u00E3o com o Google',\n    'ta': 'Google \u0BAE\u0BC2\u0BB2\u0BAE\u0BCD \u0B89\u0BB3\u0BCD\u0BA8\u0BC1\u0BB4\u0BC8\u0B95',\n    'te': 'Google\u0C24\u0C4B \u0C38\u0C48\u0C28\u0C4D \u0C07\u0C28\u0C4D \u0C1A\u0C47\u0C2F\u0C02\u0C21\u0C3F',\n  },\n  'SHOWCASE_REGWALL_CASL': {\n    'bn': 'Review <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>\\'s <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>CASL terms<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph>',\n    'cs': 'Prostudujte si <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>podm\u00EDnky CASL<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph> publikace <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>',\n    'de': '<ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>CASL-Bedingungen<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph> von <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> ansehen',\n    'en': 'Review <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>\\'s <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>CASL terms<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph>',\n    'es': 'Review <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>\\'s <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>CASL terms<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph>',\n    'fr': 'Consultez les <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>Conditions d\\'utilisation LCAP (Loi canadienne anti-pourriel)<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph> de <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>',\n    'fr-ca':\n      'Consulter les <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>conditions d\\'utilisation relatives \u00E0 la Loi canadienne antipourriel (LCAP)<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph> de la publication <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>',\n    'hi': '<ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> \u0915\u0940 <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>\u0938\u0940\u090F\u090F\u0938\u090F\u0932 (\u0915\u0948\u0928\u0947\u0921\u093F\u092F\u0928 \u090F\u0902\u091F\u0940-\u0938\u094D\u092A\u0948\u092E \u0932\u0947\u091C\u093F\u0938\u094D\u0932\u0947\u0936\u0928) \u0938\u0947 \u091C\u0941\u095C\u0940 \u0936\u0930\u094D\u0924\u094B\u0902<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph> \u0915\u0947 \u092C\u093E\u0930\u0947 \u092E\u0947\u0902 \u092A\u0922\u093C\u0947\u0902',\n    'it': 'Rileggi i <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>termini della legge CASL<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph> di <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>',\n    'ja': '<ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> \u306E <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>CASL \u898F\u7D04<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph>\u3092\u898B\u308B',\n    'kn': 'Review <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>\\'s <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>CASL terms<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph>',\n    'ml': 'Review <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>\\'s <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>CASL terms<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph>',\n    'mr': 'Review <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>\\'s <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>CASL terms<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph>',\n    'nl': 'Bekijk de <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>CASL-voorwaarden<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph> van <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>',\n    'pt-br':\n      'Confira os <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>termos da CASL<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph> da publica\u00E7\u00E3o <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>',\n    'pt-pt':\n      'Analise os <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>termos da CASL<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph> da publica\u00E7\u00E3o <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>',\n    'ta': '<ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph> \u0B87\u0BA9\u0BCD <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>CASL \u0BB5\u0BBF\u0BA4\u0BBF\u0BAE\u0BC1\u0BB1\u0BC8\u0B95\u0BB3\u0BC8\u0BAA\u0BCD<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph> \u0BAA\u0BBE\u0BB0\u0BC1\u0B99\u0BCD\u0B95\u0BB3\u0BCD',\n    'te': 'Review <ph name=\"PUBLICATION\"><ex>AP News</ex>{publication}</ph>\\'s <ph name=\"LINK_START\"><ex>&lt;a&gt;</ex></ph>CASL terms<ph name=\"LINK_END\"><ex>&lt;/a&gt;</ex></ph>',\n  },\n};\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/** @enum {number} */\nconst AnalyticsEvent = {\n  UNKNOWN: 0,\n  IMPRESSION_PAYWALL: 1,\n  IMPRESSION_AD: 2,\n  IMPRESSION_OFFERS: 3,\n  IMPRESSION_SUBSCRIBE_BUTTON: 4,\n  IMPRESSION_SMARTBOX: 5,\n  IMPRESSION_SWG_BUTTON: 6,\n  IMPRESSION_CLICK_TO_SHOW_OFFERS: 7,\n  IMPRESSION_CLICK_TO_SHOW_OFFERS_OR_ALREADY_SUBSCRIBED: 8,\n  IMPRESSION_SUBSCRIPTION_COMPLETE: 9,\n  IMPRESSION_ACCOUNT_CHANGED: 10,\n  IMPRESSION_PAGE_LOAD: 11,\n  IMPRESSION_LINK: 12,\n  IMPRESSION_SAVE_SUBSCR_TO_GOOGLE: 13,\n  IMPRESSION_GOOGLE_UPDATED: 14,\n  IMPRESSION_SHOW_OFFERS_SMARTBOX: 15,\n  IMPRESSION_SHOW_OFFERS_SWG_BUTTON: 16,\n  IMPRESSION_SELECT_OFFER_SMARTBOX: 17,\n  IMPRESSION_SELECT_OFFER_SWG_BUTTON: 18,\n  IMPRESSION_SHOW_CONTRIBUTIONS_SWG_BUTTON: 19,\n  IMPRESSION_SELECT_CONTRIBUTION_SWG_BUTTON: 20,\n  IMPRESSION_METER_TOAST: 21,\n  IMPRESSION_REGWALL: 22,\n  IMPRESSION_SHOWCASE_REGWALL: 23,\n  IMPRESSION_SWG_SUBSCRIPTION_MINI_PROMPT: 24,\n  IMPRESSION_SWG_CONTRIBUTION_MINI_PROMPT: 25,\n  IMPRESSION_CONTRIBUTION_OFFERS: 26,\n  ACTION_SUBSCRIBE: 1000,\n  ACTION_PAYMENT_COMPLETE: 1001,\n  ACTION_ACCOUNT_CREATED: 1002,\n  ACTION_ACCOUNT_ACKNOWLEDGED: 1003,\n  ACTION_SUBSCRIPTIONS_LANDING_PAGE: 1004,\n  ACTION_PAYMENT_FLOW_STARTED: 1005,\n  ACTION_OFFER_SELECTED: 1006,\n  ACTION_SWG_BUTTON_CLICK: 1007,\n  ACTION_VIEW_OFFERS: 1008,\n  ACTION_ALREADY_SUBSCRIBED: 1009,\n  ACTION_NEW_DEFERRED_ACCOUNT: 1010,\n  ACTION_LINK_CONTINUE: 1011,\n  ACTION_LINK_CANCEL: 1012,\n  ACTION_GOOGLE_UPDATED_CLOSE: 1013,\n  ACTION_USER_CANCELED_PAYFLOW: 1014,\n  ACTION_SAVE_SUBSCR_TO_GOOGLE_CONTINUE: 1015,\n  ACTION_SAVE_SUBSCR_TO_GOOGLE_CANCEL: 1016,\n  ACTION_SWG_BUTTON_SHOW_OFFERS_CLICK: 1017,\n  ACTION_SWG_BUTTON_SELECT_OFFER_CLICK: 1018,\n  ACTION_SWG_BUTTON_SHOW_CONTRIBUTIONS_CLICK: 1019,\n  ACTION_SWG_BUTTON_SELECT_CONTRIBUTION_CLICK: 1020,\n  ACTION_USER_CONSENT_DEFERRED_ACCOUNT: 1021,\n  ACTION_USER_DENY_DEFERRED_ACCOUNT: 1022,\n  ACTION_DEFERRED_ACCOUNT_REDIRECT: 1023,\n  ACTION_GET_ENTITLEMENTS: 1024,\n  ACTION_METER_TOAST_SUBSCRIBE_CLICK: 1025,\n  ACTION_METER_TOAST_EXPANDED: 1026,\n  ACTION_METER_TOAST_CLOSED_BY_ARTICLE_INTERACTION: 1027,\n  ACTION_METER_TOAST_CLOSED_BY_SWIPE_DOWN: 1028,\n  ACTION_METER_TOAST_CLOSED_BY_X_CLICKED: 1029,\n  ACTION_SWG_SUBSCRIPTION_MINI_PROMPT_CLICK: 1030,\n  ACTION_SWG_CONTRIBUTION_MINI_PROMPT_CLICK: 1031,\n  ACTION_SWG_SUBSCRIPTION_MINI_PROMPT_CLOSE: 1032,\n  ACTION_SWG_CONTRIBUTION_MINI_PROMPT_CLOSE: 1033,\n  ACTION_CONTRIBUTION_OFFER_SELECTED: 1034,\n  ACTION_SHOWCASE_REGWALL_GSI_CLICK: 1035,\n  ACTION_SHOWCASE_REGWALL_EXISTING_ACCOUNT_CLICK: 1036,\n  EVENT_PAYMENT_FAILED: 2000,\n  EVENT_CUSTOM: 3000,\n  EVENT_CONFIRM_TX_ID: 3001,\n  EVENT_CHANGED_TX_ID: 3002,\n  EVENT_GPAY_NO_TX_ID: 3003,\n  EVENT_GPAY_CANNOT_CONFIRM_TX_ID: 3004,\n  EVENT_GOOGLE_UPDATED: 3005,\n  EVENT_NEW_TX_ID: 3006,\n  EVENT_UNLOCKED_BY_SUBSCRIPTION: 3007,\n  EVENT_UNLOCKED_BY_METER: 3008,\n  EVENT_NO_ENTITLEMENTS: 3009,\n  EVENT_HAS_METERING_ENTITLEMENTS: 3010,\n  EVENT_OFFERED_METER: 3011,\n  EVENT_UNLOCKED_FREE_PAGE: 3012,\n  EVENT_INELIGIBLE_PAYWALL: 3013,\n  EVENT_UNLOCKED_FOR_CRAWLER: 3014,\n  EVENT_SUBSCRIPTION_STATE: 4000,\n};\n/** @enum {number} */\nconst EventOriginator = {\n  UNKNOWN_CLIENT: 0,\n  SWG_CLIENT: 1,\n  AMP_CLIENT: 2,\n  PROPENSITY_CLIENT: 3,\n  SWG_SERVER: 4,\n  PUBLISHER_CLIENT: 5,\n  SHOWCASE_CLIENT: 6,\n};\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param  {...*} var_args [description]\n */\nfunction warn(var_args) {\n  console.warn.apply(console, arguments);\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns a map-like object.\n * If initial is provided, copies its own properties into the\n * newly created object.\n * @param {Object=} initial This should typically be an object literal.\n * @return {!Object}\n * @template T\n */\nfunction map(initial) {\n  const obj = Object.create(null);\n  if (initial) {\n    Object.assign(obj, initial);\n  }\n  return obj;\n}\n\n/**\n * Implements `Array.find()` method that's not yet available in all browsers.\n *\n * @param {?Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} predicate\n * @return {?T}\n * @template T\n */\nfunction findInArray(array, predicate) {\n  if (!array) {\n    return null;\n  }\n  const len = array.length || 0;\n  if (len > 0) {\n    for (let i = 0; i < len; i++) {\n      const other = array[i];\n      if (predicate(other, i, array)) {\n        return other;\n      }\n    }\n  }\n  return null;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview This module declares JSON types as defined in the\n * {@link http://json.org/}.\n */\n\n/**\n * Simple wrapper around JSON.parse that casts the return value\n * to JsonObject.\n * Create a new wrapper if an array return value is desired.\n * @param {*} json JSON string to parse\n * @return {?JsonObject|undefined} May be extend to parse arrays.\n */\nfunction parseJson(json) {\n  return /** @type {?JsonObject} */ (JSON.parse(/** @type {string} */ (json)));\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/* eslint-enable no-unused-vars */\n\n/** @enum {string} */\nconst ShowcaseEvent = {\n  // Events indicating content could potentially be unlocked\n  EVENT_SHOWCASE_METER_OFFERED: 'EVENT_SHOWCASE_METER_OFFERED', // This event is only required if the user can choose not to use a publisher meter\n\n  // Events indicating content was unlocked\n  EVENT_SHOWCASE_UNLOCKED_BY_SUBSCRIPTION:\n    'EVENT_SHOWCASE_UNLOCKED_BY_SUBSCRIPTION', // Publisher managed subscriptions only\n  EVENT_SHOWCASE_UNLOCKED_BY_METER: 'EVENT_SHOWCASE_UNLOCKED_BY_METER', // Publisher managed meters only\n  EVENT_SHOWCASE_UNLOCKED_FREE_PAGE: 'EVENT_SHOWCASE_UNLOCKED_FREE_PAGE', // When the article is free for any reason (lead article, etc)\n\n  // Events indicating the user must take action to view content\n  EVENT_SHOWCASE_NO_ENTITLEMENTS_REGWALL:\n    'EVENT_SHOWCASE_NO_ENTITLEMENTS_REGWALL', // When the user must register (or log in) to view the article\n\n  // Events indicating the user must subscribe to view content\n  EVENT_SHOWCASE_INELIGIBLE_PAYWALL: 'EVENT_SHOWCASE_INELIGIBLE_PAYWALL', // When the user is not eligible for showcase entitlements\n  EVENT_SHOWCASE_NO_ENTITLEMENTS_PAYWALL:\n    'EVENT_SHOWCASE_NO_ENTITLEMENTS_PAYWALL', // When the user has no remaining showcase entitlements\n};\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Cached a-tag to avoid memory allocation during URL parsing.\n * @type {HTMLAnchorElement}\n */\nlet a;\n\n/**\n * We cached all parsed URLs. As of now there are no use cases\n * of AMP docs that would ever parse an actual large number of URLs,\n * but we often parse the same one over and over again.\n * @type {Object<string, !LocationDef>}\n */\nlet cache;\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {string} url\n * @return {!LocationDef}\n */\nfunction parseUrl(url) {\n  if (!a) {\n    a = /** @type {!HTMLAnchorElement} */ (self.document.createElement('a'));\n    cache = self.UrlCache || (self.UrlCache = Object.create(null));\n  }\n\n  const fromCache = cache[url];\n  if (fromCache) {\n    return fromCache;\n  }\n\n  const info = parseUrlWithA(a, url);\n\n  return (cache[url] = info);\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * @param {!HTMLAnchorElement} a\n * @param {string} url\n * @return {!LocationDef}\n */\nfunction parseUrlWithA(a, url) {\n  a.href = url;\n\n  // IE11 doesn't provide full URL components when parsing relative URLs.\n  // Assigning to itself again does the trick.\n  if (!a.protocol) {\n    a.href = a.href;\n  }\n\n  /** @type {!LocationDef} */\n  const info = {\n    href: a.href,\n    protocol: a.protocol,\n    host: a.host,\n    hostname: a.hostname,\n    port: a.port == '0' ? '' : a.port,\n    pathname: a.pathname,\n    search: a.search,\n    hash: a.hash,\n    origin: '', // Set below.\n  };\n\n  // Some IE11 specific polyfills.\n  // 1) IE11 strips out the leading '/' in the pathname.\n  if (info.pathname[0] !== '/') {\n    info.pathname = '/' + info.pathname;\n  }\n\n  // 2) For URLs with implicit ports, IE11 parses to default ports while\n  // other browsers leave the port field empty.\n  if (\n    (info.protocol == 'http:' && info.port == 80) ||\n    (info.protocol == 'https:' && info.port == 443)\n  ) {\n    info.port = '';\n    info.host = info.hostname;\n  }\n\n  // For data URI a.origin is equal to the string 'null' which is not useful.\n  // We instead return the actual origin which is the full URL.\n  if (a.origin && a.origin != 'null') {\n    info.origin = a.origin;\n  } else if (info.protocol == 'data:' || !info.host) {\n    info.origin = info.href;\n  } else {\n    info.origin = info.protocol + '//' + info.host;\n  }\n  return info;\n}\n\n/**\n * Parses and builds Object of URL query string.\n * @param {string} query The URL query string.\n * @return {!Object<string, string>}\n */\nfunction parseQueryString(query) {\n  if (!query) {\n    return {};\n  }\n  return (/^[?#]/.test(query) ? query.slice(1) : query)\n    .split('&')\n    .reduce((params, param) => {\n      const item = param.split('=');\n      try {\n        const key = decodeURIComponent(item[0] || '');\n        const value = decodeURIComponent(item[1] || '');\n        if (key) {\n          params[key] = value;\n        }\n      } catch (err) {\n        // eslint-disable-next-line no-console\n        warn(`SwG could not parse a URL query param: ${item[0]}`);\n      }\n      return params;\n    }, {});\n}\n\n/**\n * Adds a parameter to a query string.\n * @param {string} url\n * @param {string} param\n * @param {string} value\n * @return {string}\n */\nfunction addQueryParam(url, param, value) {\n  const queryIndex = url.indexOf('?');\n  const fragmentIndex = url.indexOf('#');\n  let fragment = '';\n  if (fragmentIndex != -1) {\n    fragment = url.substring(fragmentIndex);\n    url = url.substring(0, fragmentIndex);\n  }\n  if (queryIndex == -1) {\n    url += '?';\n  } else if (queryIndex < url.length - 1) {\n    url += '&';\n  }\n  url += encodeURIComponent(param) + '=' + encodeURIComponent(value);\n  return url + fragment;\n}\n\nparseUrl(self.window.location.href);\nparseUrl(self.document.referrer);\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** English is the default language. */\nconst DEFAULT_LANGUAGE_CODE = 'en';\n\n/**\n * Gets a message for a given language code, from a map of messages.\n * @param {!Object<string, string>} map\n * @param {?string|?Element} languageCodeOrElement\n * @return {?string}\n */\nfunction msg(map, languageCodeOrElement) {\n  const defaultMsg = map[DEFAULT_LANGUAGE_CODE];\n\n  // Verify params.\n  if (typeof map !== 'object' || !languageCodeOrElement) {\n    return defaultMsg;\n  }\n\n  // Get language code.\n  let languageCode =\n    typeof languageCodeOrElement === 'string'\n      ? languageCodeOrElement\n      : getLanguageCodeFromElement(languageCodeOrElement);\n\n  // Normalize language code.\n  languageCode = languageCode.toLowerCase();\n  languageCode = languageCode.replace(/_/g, '-');\n\n  // Search for a message matching the language code.\n  // If a message can't be found, try again with a less specific language code.\n  const languageCodeSegments = languageCode.split('-');\n  while (languageCodeSegments.length) {\n    const key = languageCodeSegments.join('-');\n    if (key in map) {\n      return map[key];\n    }\n\n    // Simplify language code.\n    // Ex: \"en-US-SF\" => \"en-US\"\n    languageCodeSegments.pop();\n  }\n\n  // There was an attempt.\n  return defaultMsg;\n}\n\n/**\n * Gets a language code (ex: \"en-US\") from a given Element.\n * @param {!Element} element\n * @return {string}\n */\nfunction getLanguageCodeFromElement(element) {\n  if (element.lang) {\n    // Get language from element itself.\n    return element.lang;\n  }\n\n  if (element.ownerDocument && element.ownerDocument.documentElement.lang) {\n    // Get language from element's document.\n    return element.ownerDocument.documentElement.lang;\n  }\n\n  // There was an attempt.\n  return DEFAULT_LANGUAGE_CODE;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Polyfill for String.prototype.startsWith.\n * @param {string} string\n * @param {string} prefix\n * @return {boolean}\n */\nfunction startsWith(string, prefix) {\n  if (prefix.length > string.length) {\n    return false;\n  }\n  return string.lastIndexOf(prefix, 0) == 0;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @type {Object<string, string>} */\nlet propertyNameCache;\n\n/** @const {!Array<string>} */\nconst vendorPrefixes = ['Webkit', 'webkit', 'Moz', 'moz', 'ms', 'O', 'o'];\n\n/**\n * @param {string} camelCase camel cased string\n * @return {string} title cased string\n */\nfunction camelCaseToTitleCase(camelCase) {\n  return camelCase.charAt(0).toUpperCase() + camelCase.slice(1);\n}\n\n/**\n * Checks the style if a prefixed version of a property exists and returns\n * it or returns an empty string.\n * @private\n * @param {!Object} style\n * @param {string} titleCase the title case version of a css property name\n * @return {string} the prefixed property name or null.\n */\nfunction getVendorJsPropertyName_(style, titleCase) {\n  for (let i = 0; i < vendorPrefixes.length; i++) {\n    const propertyName = vendorPrefixes[i] + titleCase;\n    if (style[propertyName] !== undefined) {\n      return propertyName;\n    }\n  }\n  return '';\n}\n\n/**\n * Returns the possibly prefixed JavaScript property name of a style property\n * (ex. WebkitTransitionDuration) given a camelCase'd version of the property\n * (ex. transitionDuration).\n * @param {!Object} style\n * @param {string} camelCase the camel cased version of a css property name\n * @param {boolean=} bypassCache bypass the memoized cache of property\n *   mapping\n * @return {string}\n */\nfunction getVendorJsPropertyName(style, camelCase, bypassCache) {\n  if (startsWith(camelCase, '--')) {\n    // CSS vars are returned as is.\n    return camelCase;\n  }\n  if (!propertyNameCache) {\n    propertyNameCache = map();\n  }\n  let propertyName = propertyNameCache[camelCase];\n  if (!propertyName || bypassCache) {\n    propertyName = camelCase;\n    if (style[camelCase] === undefined) {\n      const titleCase = camelCaseToTitleCase(camelCase);\n      const prefixedPropertyName = getVendorJsPropertyName_(style, titleCase);\n\n      if (style[prefixedPropertyName] !== undefined) {\n        propertyName = prefixedPropertyName;\n      }\n    }\n    if (!bypassCache) {\n      propertyNameCache[camelCase] = propertyName;\n    }\n  }\n  return propertyName;\n}\n\n/**\n * Sets the CSS styles of the specified element with !important. The styles\n * are specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, string|number>} styles\n */\nfunction setImportantStyles(element, styles) {\n  for (const k in styles) {\n    element.style.setProperty(\n      getVendorJsPropertyName(styles, k),\n      styles[k].toString(),\n      'important'\n    );\n  }\n}\n\n/**\n * Copyright 2019 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {!Object<string,?Array<AnalyticsEvent>>} */\nconst ShowcaseEvents = {\n  // Events related to content being potentially unlockable\n  [ShowcaseEvent.EVENT_SHOWCASE_METER_OFFERED]: [\n    AnalyticsEvent.EVENT_HAS_METERING_ENTITLEMENTS,\n    AnalyticsEvent.EVENT_OFFERED_METER,\n  ],\n\n  // Events related to content being unlocked\n  [ShowcaseEvent.EVENT_SHOWCASE_UNLOCKED_BY_SUBSCRIPTION]: [\n    AnalyticsEvent.EVENT_UNLOCKED_BY_SUBSCRIPTION,\n  ],\n  [ShowcaseEvent.EVENT_SHOWCASE_UNLOCKED_BY_METER]: [\n    AnalyticsEvent.EVENT_HAS_METERING_ENTITLEMENTS,\n    AnalyticsEvent.EVENT_UNLOCKED_BY_METER,\n  ],\n  [ShowcaseEvent.EVENT_SHOWCASE_UNLOCKED_FREE_PAGE]: [\n    AnalyticsEvent.EVENT_UNLOCKED_FREE_PAGE,\n  ],\n\n  // Events requiring user action to unlock content\n  [ShowcaseEvent.EVENT_SHOWCASE_NO_ENTITLEMENTS_REGWALL]: [\n    AnalyticsEvent.EVENT_NO_ENTITLEMENTS,\n    AnalyticsEvent.IMPRESSION_REGWALL,\n    AnalyticsEvent.IMPRESSION_SHOWCASE_REGWALL,\n  ],\n\n  // Events requiring subscription to unlock content\n  [ShowcaseEvent.EVENT_SHOWCASE_NO_ENTITLEMENTS_PAYWALL]: [\n    AnalyticsEvent.EVENT_NO_ENTITLEMENTS,\n    AnalyticsEvent.IMPRESSION_PAYWALL,\n  ],\n  [ShowcaseEvent.EVENT_SHOWCASE_INELIGIBLE_PAYWALL]: [\n    AnalyticsEvent.EVENT_INELIGIBLE_PAYWALL,\n    AnalyticsEvent.EVENT_NO_ENTITLEMENTS,\n  ],\n};\n\n/**\n * Converts a publisher entitlement event enum into an array analytics events.\n * @param {!ShowcaseEvent} event\n * @returns {!Array<AnalyticsEvent>}\n */\nfunction showcaseEventToAnalyticsEvents(event) {\n  return ShowcaseEvents[event] || [];\n}\n\n/**\n * Copyright 2020 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** Stamp for post messages. */\nconst POST_MESSAGE_STAMP = 'swg-gaa-post-message-stamp';\n\n/** Introduction command for post messages. */\nconst POST_MESSAGE_COMMAND_INTRODUCTION = 'introduction';\n\n/** User command for post messages. */\nconst POST_MESSAGE_COMMAND_USER = 'user';\n\n/** Error command for post messages. */\nconst POST_MESSAGE_COMMAND_ERROR = 'error';\n\n/** Button click command for post messages. */\nconst POST_MESSAGE_COMMAND_BUTTON_CLICK = 'button-click';\n\n/** ID for the Google Sign-In iframe element. */\nconst GOOGLE_SIGN_IN_IFRAME_ID = 'swg-google-sign-in-iframe';\n\n/** ID for the Google Sign-In button element. */\nconst GOOGLE_SIGN_IN_BUTTON_ID = 'swg-google-sign-in-button';\n\n/** ID for the third party Google Sign-In button element.  */\nconst GOOGLE_3P_SIGN_IN_BUTTON_ID = 'swg-google-3p-sign-in-button';\n\n/** ID for the Google Sign-In button element. */\nconst SIGN_IN_WITH_GOOGLE_BUTTON_ID = 'swg-sign-in-with-google-button';\n\n/** ID for the Publisher sign-in button element. */\nconst PUBLISHER_SIGN_IN_BUTTON_ID = 'swg-publisher-sign-in-button';\n\n/** ID for the Regwall container element. */\nconst REGWALL_CONTAINER_ID = 'swg-regwall-container';\n\n/** ID for the Regwall dialog element. */\nconst REGWALL_DIALOG_ID = 'swg-regwall-dialog';\n\n/** ID for the Regwall title element. */\nconst REGWALL_TITLE_ID = 'swg-regwall-title';\n\n/**\n * HTML for the metering regwall dialog, where users can sign in with Google.\n * The script creates a dialog based on this HTML.\n *\n * The HTML includes an iframe that loads the Google Sign-In button.\n * This iframe can live on a different origin.\n */\nconst REGWALL_HTML = `\n<style>\n  .gaa-metering-regwall--dialog-spacer,\n  .gaa-metering-regwall--dialog,\n  .gaa-metering-regwall--logo,\n  .gaa-metering-regwall--title,\n  .gaa-metering-regwall--description,\n  .gaa-metering-regwall--description strong,\n  .gaa-metering-regwall--iframe,\n  .gaa-metering-regwall--casl,\n  .gaa-metering-regwall--publisher-no-thanks-button {\n    all: initial;\n    box-sizing: border-box;\n    font-family: Roboto, arial, sans-serif;\n  }\n\n  .gaa-metering-regwall--dialog-spacer {\n    background: linear-gradient(0, #808080, transparent);\n    bottom: 0;\n    display: block;\n    position: fixed;\n    width: 100%;\n  }\n\n  @keyframes slideUp {\n    from {transform: translate(0, 200px);}\n    to {transform: translate(0, 0);}\n  }\n\n  .gaa-metering-regwall--dialog {\n    animation: slideUp 0.5s;\n    background: white;\n    border-radius: 12px 12px 0 0;\n    box-shadow: 0px -2px 6px rgba(0, 0, 0, 0.3);\n    display: block;\n    margin: 0 auto;\n    max-width: 100%;\n    padding: 24px 20px;\n    pointer-events: auto;\n    width: 410px;\n  }\n\n  .gaa-metering-regwall--logo {\n    display: block;\n    margin: 0 auto 24px;\n  }\n\n  .gaa-metering-regwall--title {\n    color: #000;\n    display: block;\n    font-size: 16px;\n    margin: 0 0 8px;\n    outline: none !important;\n  }\n\n  .gaa-metering-regwall--description {\n    color: #646464;\n    display: block;\n    font-size: 14px;\n    line-height: 19px;\n    margin: 0 0 30px;\n  }\n\n  .gaa-metering-regwall--description strong {\n    color: #646464;\n    font-size: 14px;\n    line-height: 19px;\n    font-weight: bold;\n  }\n\n  .gaa-metering-regwall--iframe {\n    border: none;\n    display: block;\n    height: 36px;\n    margin: 0 0 30px;\n    width: 100%;\n  }\n\n  .gaa-metering-regwall--casl {\n    color: #646464;\n    display: block;\n    font-size: 12px;\n    text-align: center;\n    margin: -16px auto 32px;\n  }\n\n  .gaa-metering-regwall--casl a {\n    color: #1967d2;\n  }\n\n  .gaa-metering-regwall--line {\n    background-color: #ddd;\n    display: block;\n    height: 1px;\n    margin: 0 0 24px;\n  }\n\n  .gaa-metering-regwall--publisher-sign-in-button,\n  .gaa-metering-regwall--publisher-no-thanks-button {\n    color: #1967d2;\n    display: block;\n    cursor: pointer;\n    font-size: 12px;\n  }\n\n  .gaa-metering-regwall--publisher-sign-in-button {\n  }\n\n  .gaa-metering-regwall--publisher-no-thanks-button {\n    display: none;\n    float: right;\n  }\n\n  .gaa-metering-regwall--google-sign-in-button {\n    height: 36px;\n    margin: 0 auto 30px;\n  }\n\n  .gaa-metering-regwall--google-sign-in-button > div {\n    animation: swgGoogleSignInButtonfadeIn 0.32s;\n  }\n\n  @keyframes swgGoogleSignInButtonfadeIn {\n    from {\n      opacity: 0;\n    }\n    to {\n      opacity: 1;\n    }\n  }\n</style>\n\n<div class=\"gaa-metering-regwall--dialog-spacer\">\n  <div role=\"dialog\" aria-modal=\"true\" class=\"gaa-metering-regwall--dialog\" id=\"${REGWALL_DIALOG_ID}\" aria-labelledby=\"${REGWALL_TITLE_ID}\">\n    <img alt=\"Google\" class=\"gaa-metering-regwall--logo\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3NCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDc0IDI0Ij48cGF0aCBmaWxsPSIjNDI4NUY0IiBkPSJNOS4yNCA4LjE5djIuNDZoNS44OGMtLjE4IDEuMzgtLjY0IDIuMzktMS4zNCAzLjEtLjg2Ljg2LTIuMiAxLjgtNC41NCAxLjgtMy42MiAwLTYuNDUtMi45Mi02LjQ1LTYuNTRzMi44My02LjU0IDYuNDUtNi41NGMxLjk1IDAgMy4zOC43NyA0LjQzIDEuNzZMMTUuNCAyLjVDMTMuOTQgMS4wOCAxMS45OCAwIDkuMjQgMCA0LjI4IDAgLjExIDQuMDQuMTEgOXM0LjE3IDkgOS4xMyA5YzIuNjggMCA0LjctLjg4IDYuMjgtMi41MiAxLjYyLTEuNjIgMi4xMy0zLjkxIDIuMTMtNS43NSAwLS41Ny0uMDQtMS4xLS4xMy0xLjU0SDkuMjR6Ii8+PHBhdGggZmlsbD0iI0VBNDMzNSIgZD0iTTI1IDYuMTljLTMuMjEgMC01LjgzIDIuNDQtNS44MyA1LjgxIDAgMy4zNCAyLjYyIDUuODEgNS44MyA1LjgxczUuODMtMi40NiA1LjgzLTUuODFjMC0zLjM3LTIuNjItNS44MS01LjgzLTUuODF6bTAgOS4zM2MtMS43NiAwLTMuMjgtMS40NS0zLjI4LTMuNTIgMC0yLjA5IDEuNTItMy41MiAzLjI4LTMuNTJzMy4yOCAxLjQzIDMuMjggMy41MmMwIDIuMDctMS41MiAzLjUyLTMuMjggMy41MnoiLz48cGF0aCBmaWxsPSIjNDI4NUY0IiBkPSJNNTMuNTggNy40OWgtLjA5Yy0uNTctLjY4LTEuNjctMS4zLTMuMDYtMS4zQzQ3LjUzIDYuMTkgNDUgOC43MiA0NSAxMmMwIDMuMjYgMi41MyA1LjgxIDUuNDMgNS44MSAxLjM5IDAgMi40OS0uNjIgMy4wNi0xLjMyaC4wOXYuODFjMCAyLjIyLTEuMTkgMy40MS0zLjEgMy40MS0xLjU2IDAtMi41My0xLjEyLTIuOTMtMi4wN2wtMi4yMi45MmMuNjQgMS41NCAyLjMzIDMuNDMgNS4xNSAzLjQzIDIuOTkgMCA1LjUyLTEuNzYgNS41Mi02LjA1VjYuNDloLTIuNDJ2MXptLTIuOTMgOC4wM2MtMS43NiAwLTMuMS0xLjUtMy4xLTMuNTIgMC0yLjA1IDEuMzQtMy41MiAzLjEtMy41MiAxLjc0IDAgMy4xIDEuNSAzLjEgMy41NC4wMSAyLjAzLTEuMzYgMy41LTMuMSAzLjV6Ii8+PHBhdGggZmlsbD0iI0ZCQkMwNSIgZD0iTTM4IDYuMTljLTMuMjEgMC01LjgzIDIuNDQtNS44MyA1LjgxIDAgMy4zNCAyLjYyIDUuODEgNS44MyA1LjgxczUuODMtMi40NiA1LjgzLTUuODFjMC0zLjM3LTIuNjItNS44MS01LjgzLTUuODF6bTAgOS4zM2MtMS43NiAwLTMuMjgtMS40NS0zLjI4LTMuNTIgMC0yLjA5IDEuNTItMy41MiAzLjI4LTMuNTJzMy4yOCAxLjQzIDMuMjggMy41MmMwIDIuMDctMS41MiAzLjUyLTMuMjggMy41MnoiLz48cGF0aCBmaWxsPSIjMzRBODUzIiBkPSJNNTggLjI0aDIuNTF2MTcuNTdINTh6Ii8+PHBhdGggZmlsbD0iI0VBNDMzNSIgZD0iTTY4LjI2IDE1LjUyYy0xLjMgMC0yLjIyLS41OS0yLjgyLTEuNzZsNy43Ny0zLjIxLS4yNi0uNjZjLS40OC0xLjMtMS45Ni0zLjctNC45Ny0zLjctMi45OSAwLTUuNDggMi4zNS01LjQ4IDUuODEgMCAzLjI2IDIuNDYgNS44MSA1Ljc2IDUuODEgMi42NiAwIDQuMi0xLjYzIDQuODQtMi41N2wtMS45OC0xLjMyYy0uNjYuOTYtMS41NiAxLjYtMi44NiAxLjZ6bS0uMTgtNy4xNWMxLjAzIDAgMS45MS41MyAyLjIgMS4yOGwtNS4yNSAyLjE3YzAtMi40NCAxLjczLTMuNDUgMy4wNS0zLjQ1eiIvPjwvc3ZnPg==\" />\n\n    <div class=\"gaa-metering-regwall--title\" id=\"${REGWALL_TITLE_ID}\" tabindex=\"0\">$SHOWCASE_REGWALL_TITLE$</div>\n\n    <div class=\"gaa-metering-regwall--description\">\n      $SHOWCASE_REGWALL_DESCRIPTION$\n    </div>\n\n    <iframe\n        id=\"${GOOGLE_SIGN_IN_IFRAME_ID}\"\n        class=\"gaa-metering-regwall--iframe\"\n        src=\"$iframeUrl$\">\n    </iframe>\n\n    $SHOWCASE_REGWALL_CASL$\n\n    <div class=\"gaa-metering-regwall--line\"></div>\n\n    <a\n        id=\"${PUBLISHER_SIGN_IN_BUTTON_ID}\"\n        class=\"gaa-metering-regwall--publisher-sign-in-button\"\n        tabindex=\"0\"\n        href=\"#\">\n      $SHOWCASE_REGWALL_PUBLISHER_SIGN_IN_BUTTON$\n    </a>\n  </div>\n</div>\n`;\n\n/**\n * HTML for the CASL blurb.\n * CASL stands for Canadian Anti-Spam Law.\n */\nconst CASL_HTML = `\n<div class=\"gaa-metering-regwall--casl\">\n  $SHOWCASE_REGWALL_CASL$\n</div>\n`;\n\n/** Base styles for both the Google and Google 3p Sign-In button iframes. */\nconst GOOGLE_SIGN_IN_IFRAME_STYLES = `\n  body {\n    margin: 0;\n    overflow: hidden;\n  }\n  #${GOOGLE_3P_SIGN_IN_BUTTON_ID},\n  #${SIGN_IN_WITH_GOOGLE_BUTTON_ID},\n  #${GOOGLE_SIGN_IN_BUTTON_ID} {\n    margin: 0 auto;\n  }\n  #${GOOGLE_3P_SIGN_IN_BUTTON_ID} > div,\n  #${SIGN_IN_WITH_GOOGLE_BUTTON_ID} > div,\n  #${GOOGLE_SIGN_IN_BUTTON_ID} > div {\n    animation: fadeIn 0.32s;\n  }\n  @keyframes fadeIn {\n    from {\n      opacity: 0;\n    }\n    to {\n      opacity: 1;\n    }\n  }\n  #${GOOGLE_3P_SIGN_IN_BUTTON_ID} .abcRioButton.abcRioButtonBlue,\n  #${SIGN_IN_WITH_GOOGLE_BUTTON_ID} .abcRioButton.abcRioButtonBlue,\n  #${GOOGLE_SIGN_IN_BUTTON_ID} .abcRioButton.abcRioButtonBlue {\n    background-color: #1A73E8;\n    box-shadow: none;\n    -webkit-box-shadow: none;\n    border-radius: 4px;\n    width: 100% !important;\n  }\n  #${GOOGLE_3P_SIGN_IN_BUTTON_ID} .abcRioButton.abcRioButtonBlue .abcRioButtonIcon,\n  #${SIGN_IN_WITH_GOOGLE_BUTTON_ID} .abcRioButton.abcRioButtonBlue .abcRioButtonIcon,\n  #${GOOGLE_SIGN_IN_BUTTON_ID} .abcRioButton.abcRioButtonBlue .abcRioButtonIcon {\n    display: none;\n  }\n  /** Hides default \"Sign in with Google\" text. */\n  #${GOOGLE_3P_SIGN_IN_BUTTON_ID}  .abcRioButton.abcRioButtonBlue .abcRioButtonContents span[id^=not_signed_],\n  #${SIGN_IN_WITH_GOOGLE_BUTTON_ID}  .abcRioButton.abcRioButtonBlue .abcRioButtonContents span[id^=not_signed_],\n  #${GOOGLE_SIGN_IN_BUTTON_ID} .abcRioButton.abcRioButtonBlue .abcRioButtonContents span[id^=not_signed_] {\n    font-size: 0 !important;\n  }\n  /** Renders localized \"Sign in with Google\" text instead. */\n  #${GOOGLE_3P_SIGN_IN_BUTTON_ID} .abcRioButton.abcRioButtonBlue .abcRioButtonContents span[id^=not_signed_]::before,\n  #${SIGN_IN_WITH_GOOGLE_BUTTON_ID} .abcRioButton.abcRioButtonBlue .abcRioButtonContents span[id^=not_signed_]::before,\n  #${GOOGLE_SIGN_IN_BUTTON_ID} .abcRioButton.abcRioButtonBlue .abcRioButtonContents span[id^=not_signed_]::before {\n    content: '$SHOWCASE_REGWALL_GOOGLE_SIGN_IN_BUTTON$';\n    font-size: 15px;\n  }`;\n\n/**\n * User object that Publisher JS receives after users sign in.\n * @typedef {{\n *   idToken: string,\n *   name: string,\n *   givenName: string,\n *   familyName: string,\n *   imageUrl: string,\n *   email: string,\n *   authorizationData: {\n *     access_token: string,\n *     id_token: string,\n *     scope: string,\n *     expires_in: number,\n *     first_issued_at: number,\n *     expires_at: number,\n *   },\n * }} GaaUserDef\n */\nlet GaaUserDef;\n\n/**\n * GoogleUser object that Google Sign-In returns after users sign in.\n * https://developers.google.com/identity/sign-in/web/reference#googleusergetbasicprofile\n * @typedef {{\n *   getAuthResponse: function(boolean): {\n *     access_token: string,\n *     id_token: string,\n *     scope: string,\n *     expires_in: number,\n *     first_issued_at: number,\n *     expires_at: number,\n *   },\n *   getBasicProfile: function(): {\n *     getName: function(): string,\n *     getGivenName: function(): string,\n *     getFamilyName: function(): string,\n *     getImageUrl: function(): string,\n *     getEmail: function(): string,\n *   },\n * }} GoogleUserDef\n */\nlet GoogleUserDef;\n\n/**\n * Returns true if the query string contains fresh Google Article Access (GAA) params.\n * @param {string} queryString\n * @param {boolean} allowAllAccessTypes\n * @return {boolean}\n */\nfunction queryStringHasFreshGaaParams(\n  queryString,\n  allowAllAccessTypes = false\n) {\n  const params = parseQueryString(queryString);\n\n  // Verify GAA params exist.\n  if (\n    !params['gaa_at'] ||\n    !params['gaa_n'] ||\n    !params['gaa_sig'] ||\n    !params['gaa_ts']\n  ) {\n    return false;\n  }\n\n  if (!allowAllAccessTypes) {\n    // Verify access type.\n    const noAccess = params['gaa_at'] === 'na';\n    if (noAccess) {\n      return false;\n    }\n  }\n\n  // Verify timestamp isn't stale.\n  const expirationTimestamp = parseInt(params['gaa_ts'], 16);\n  const currentTimestamp = Date.now() / 1000;\n  if (expirationTimestamp < currentTimestamp) {\n    return false;\n  }\n\n  return true;\n}\n\n/** Renders Google Article Access (GAA) Metering Regwall. */\nclass GaaMeteringRegwall {\n  /**\n   * Returns a promise for a Google Sign-In user object.\n   * https://developers.google.com/identity/sign-in/web/reference#googleusergetbasicprofile\n   *\n   * This method opens a metering regwall dialog,\n   * where users can sign in with Google.\n   * @nocollapse\n   * @param {{ iframeUrl: string, caslUrl: string }} params\n   * @return {!Promise<!GaaUserDef>}\n   */\n  static show({iframeUrl, caslUrl}) {\n    const queryString = GaaUtils.getQueryString();\n    if (!queryStringHasFreshGaaParams(queryString)) {\n      const errorMessage =\n        '[swg-gaa.js:GaaMeteringRegwall.show]: URL needs fresh GAA params.';\n      warn(errorMessage);\n      return Promise.reject(errorMessage);\n    }\n\n    logEvent({\n      showcaseEvent: ShowcaseEvent.EVENT_SHOWCASE_NO_ENTITLEMENTS_REGWALL,\n      isFromUserAction: false,\n    });\n\n    GaaMeteringRegwall.render_({iframeUrl, caslUrl});\n    GaaMeteringRegwall.sendIntroMessageToGsiIframe_({iframeUrl});\n    GaaMeteringRegwall.logButtonClickEvents_();\n    return GaaMeteringRegwall.getGaaUser_()\n      .then((gaaUser) => {\n        GaaMeteringRegwall.remove();\n        return gaaUser;\n      })\n      .catch((err) => {\n        // Close the Regwall, since the flow failed.\n        GaaMeteringRegwall.remove();\n\n        // Rethrow error.\n        throw err;\n      });\n  }\n\n  /**\n   * Removes the Regwall.\n   * @nocollapse\n   */\n  static remove() {\n    const regwallContainer = self.document.getElementById(REGWALL_CONTAINER_ID);\n    if (regwallContainer) {\n      regwallContainer.remove();\n    }\n  }\n\n  /**\n   * Signs out of Google Sign-In.\n   * This is useful for developers who are testing their\n   * SwG integrations.\n   * @nocollapse\n   * @return {!Promise}\n   */\n  static signOut() {\n    return configureGoogleSignIn().then(() =>\n      self.gapi.auth2.getAuthInstance().signOut()\n    );\n  }\n\n  /**\n   * Renders the Regwall.\n   * @private\n   * @nocollapse\n   * @param {{ iframeUrl: string, caslUrl: string }} params\n   */\n  static render_({iframeUrl, caslUrl}) {\n    const languageCode = getLanguageCodeFromElement(self.document.body);\n    const publisherName = GaaMeteringRegwall.getPublisherNameFromPageConfig_();\n    const placeholderPatternForPublication = /<ph name=\"PUBLICATION\".+?\\/ph>/g;\n    const placeholderPatternForLinkStart = /<ph name=\"LINK_START\".+?\\/ph>/g;\n    const placeholderPatternForLinkEnd = /<ph name=\"LINK_END\".+?\\/ph>/g;\n\n    // Tell the iframe which language to render.\n    iframeUrl = addQueryParam(iframeUrl, 'lang', languageCode);\n\n    // Create and style container element.\n    const containerEl = /** @type {!HTMLDivElement} */ (\n      self.document.createElement('div')\n    );\n    containerEl.id = REGWALL_CONTAINER_ID;\n    setImportantStyles(containerEl, {\n      'all': 'unset',\n      'background-color': 'rgba(32, 33, 36, 0.6)',\n      'border': 'none',\n      'bottom': '0',\n      'height': '100%',\n      'left': '0',\n      'opacity': '0',\n      'pointer-events': 'none',\n      'position': 'fixed',\n      'right': '0',\n      'transition': 'opacity 0.5s',\n      'top': '0',\n      'width': '100%',\n      'z-index': 2147483646,\n    });\n\n    // Optionally include CASL HTML.\n    let caslHtml = '';\n    if (caslUrl) {\n      caslHtml = CASL_HTML.replace(\n        '$SHOWCASE_REGWALL_CASL$',\n        msg(I18N_STRINGS['SHOWCASE_REGWALL_CASL'], languageCode)\n      )\n        // Update link.\n        .replace(\n          placeholderPatternForLinkStart,\n          `<a href=\"${encodeURI(caslUrl)}\" target=\"_blank\">`\n        )\n        .replace(placeholderPatternForLinkEnd, '</a>')\n        // Update publisher name.\n        .replace(\n          placeholderPatternForPublication,\n          `<strong>${publisherName}</strong>`\n        );\n    }\n\n    // Prepare HTML.\n    containerEl./*OK*/ innerHTML = REGWALL_HTML.replace(\n      '$iframeUrl$',\n      iframeUrl\n    )\n      .replace(\n        '$SHOWCASE_REGWALL_TITLE$',\n        msg(I18N_STRINGS['SHOWCASE_REGWALL_TITLE'], languageCode)\n      )\n      .replace(\n        '$SHOWCASE_REGWALL_DESCRIPTION$',\n        msg(I18N_STRINGS['SHOWCASE_REGWALL_DESCRIPTION'], languageCode)\n          // Update publisher name.\n          .replace(placeholderPatternForPublication, publisherName)\n      )\n      .replace(\n        '$SHOWCASE_REGWALL_PUBLISHER_SIGN_IN_BUTTON$',\n        msg(\n          I18N_STRINGS['SHOWCASE_REGWALL_PUBLISHER_SIGN_IN_BUTTON'],\n          languageCode\n        )\n      )\n      .replace('$SHOWCASE_REGWALL_CASL$', caslHtml);\n\n    // Add container to DOM.\n    self.document.body.appendChild(containerEl);\n\n    // Trigger a fade-in transition.\n    /** @suppress {suspiciousCode} */\n    containerEl.offsetHeight; // Trigger a repaint (to prepare the CSS transition).\n    setImportantStyles(containerEl, {'opacity': 1});\n\n    // Listen for clicks.\n    GaaMeteringRegwall.addClickListenerOnPublisherSignInButton_();\n\n    // Focus on the title after the dialog animates in.\n    // This helps people using screenreaders.\n    const dialogEl = self.document.getElementById(REGWALL_DIALOG_ID);\n    dialogEl.addEventListener('animationend', () => {\n      const titleEl = self.document.getElementById(REGWALL_TITLE_ID);\n      titleEl.focus();\n    });\n  }\n\n  /**\n   * Gets publisher name from page config.\n   * @private\n   * @nocollapse\n   * @return {string}\n   */\n  static getPublisherNameFromPageConfig_() {\n    const jsonLdPageConfig =\n      GaaMeteringRegwall.getPublisherNameFromJsonLdPageConfig_();\n    if (jsonLdPageConfig) {\n      return jsonLdPageConfig;\n    }\n\n    const microdataPageConfig =\n      GaaMeteringRegwall.getPublisherNameFromMicrodataPageConfig_();\n    if (microdataPageConfig) {\n      return microdataPageConfig;\n    }\n\n    throw new Error(\n      'Showcase articles must define a publisher name with either JSON-LD or Microdata.'\n    );\n  }\n\n  /**\n   * Gets publisher name from JSON-LD page config.\n   * @private\n   * @nocollapse\n   * @return {string|undefined}\n   */\n  static getPublisherNameFromJsonLdPageConfig_() {\n    const ldJsonElements = self.document.querySelectorAll(\n      'script[type=\"application/ld+json\"]'\n    );\n\n    for (let i = 0; i < ldJsonElements.length; i++) {\n      const ldJsonElement = ldJsonElements[i];\n      let ldJson = /** @type {*} */ (parseJson(ldJsonElement.textContent));\n\n      if (!Array.isArray(ldJson)) {\n        ldJson = [ldJson];\n      }\n\n      const publisherName = findInArray(\n        ldJson,\n        (entry) => entry?.publisher?.name\n      )?.publisher.name;\n\n      if (publisherName) {\n        return publisherName;\n      }\n    }\n  }\n\n  /**\n   * Gets publisher name from Microdata page config.\n   * @private\n   * @nocollapse\n   * @return {string|undefined}\n   */\n  static getPublisherNameFromMicrodataPageConfig_() {\n    const publisherNameElements = self.document.querySelectorAll(\n      '[itemscope][itemtype][itemprop=\"publisher\"] [itemprop=\"name\"]'\n    );\n\n    for (let i = 0; i < publisherNameElements.length; i++) {\n      const publisherNameElement = publisherNameElements[i];\n      const publisherName = publisherNameElement.content;\n      if (publisherName) {\n        return publisherName;\n      }\n    }\n  }\n\n  /**\n   * Adds a click listener on the publisher sign-in button.\n   * @private\n   * @nocollapse\n   */\n  static addClickListenerOnPublisherSignInButton_() {\n    self.document\n      .getElementById(PUBLISHER_SIGN_IN_BUTTON_ID)\n      .addEventListener('click', (e) => {\n        e.preventDefault();\n\n        logEvent({\n          analyticsEvent:\n            AnalyticsEvent.ACTION_SHOWCASE_REGWALL_EXISTING_ACCOUNT_CLICK,\n          isFromUserAction: true,\n        });\n\n        callSwg((swg) => swg.triggerLoginRequest({linkRequested: false}));\n      });\n  }\n\n  /**\n   * Returns the GAA user, after the user signs in.\n   * @private\n   * @nocollapse\n   * @return {!Promise<!GoogleUserDef>}\n   */\n  static getGaaUser_() {\n    // Listen for GAA user.\n    return new Promise((resolve, reject) => {\n      self.addEventListener('message', (e) => {\n        if (e.data.stamp === POST_MESSAGE_STAMP) {\n          if (e.data.command === POST_MESSAGE_COMMAND_USER) {\n            // Pass along GAA user.\n            resolve(e.data.gaaUser);\n          }\n\n          if (e.data.command === POST_MESSAGE_COMMAND_ERROR) {\n            // Reject promise due to Google Sign-In error.\n            reject('Google Sign-In could not render');\n          }\n        }\n      });\n    });\n  }\n\n  /**\n   * Logs button click events.\n   * @private\n   * @nocollapse\n   */\n  static logButtonClickEvents_() {\n    // Listen for button event messages.\n    self.addEventListener('message', (e) => {\n      if (\n        e.data.stamp === POST_MESSAGE_STAMP &&\n        e.data.command === POST_MESSAGE_COMMAND_BUTTON_CLICK\n      ) {\n        // Log button click event.\n        logEvent({\n          analyticsEvent: AnalyticsEvent.ACTION_SHOWCASE_REGWALL_GSI_CLICK,\n          isFromUserAction: true,\n        });\n      }\n    });\n  }\n\n  /**\n   * Sends intro post message to Google Sign-In iframe.\n   * @private\n   * @nocollapse\n   * @param {{ iframeUrl: string }} params\n   */\n  static sendIntroMessageToGsiIframe_({iframeUrl}) {\n    // Introduce this window to the publisher's Google Sign-In iframe.\n    // This lets the iframe send post messages back to this window.\n    // Without the introduction, the iframe wouldn't have a reference to this window.\n    const googleSignInIframe = /** @type {!HTMLIFrameElement} */ (\n      self.document.getElementById(GOOGLE_SIGN_IN_IFRAME_ID)\n    );\n    googleSignInIframe.onload = () => {\n      googleSignInIframe.contentWindow.postMessage(\n        {\n          stamp: POST_MESSAGE_STAMP,\n          command: POST_MESSAGE_COMMAND_INTRODUCTION,\n        },\n        new URL(iframeUrl).origin\n      );\n    };\n  }\n}\n\nclass GaaGoogleSignInButton {\n  /**\n   * Renders the Google Sign-In button.\n   * @nocollapse\n   * @param {{ allowedOrigins: !Array<string> }} params\n   */\n  static show({allowedOrigins}) {\n    // Optionally grab language code from URL.\n    const queryString = GaaUtils.getQueryString();\n    const queryParams = parseQueryString(queryString);\n    const languageCode = queryParams['lang'] || 'en';\n\n    // Apply iframe styles.\n    const styleEl = self.document.createElement('style');\n    styleEl./*OK*/ innerText = GOOGLE_SIGN_IN_IFRAME_STYLES.replace(\n      '$SHOWCASE_REGWALL_GOOGLE_SIGN_IN_BUTTON$',\n      msg(I18N_STRINGS['SHOWCASE_REGWALL_GOOGLE_SIGN_IN_BUTTON'], languageCode)\n    );\n    self.document.head.appendChild(styleEl);\n\n    // Promise a function that sends messages to the parent frame.\n    // Note: A function is preferable to a reference to the parent frame\n    // because referencing the parent frame outside of the 'message' event\n    // handler throws an Error. A function defined within the handler can\n    // effectively save a reference to the parent frame though.\n    const sendMessageToParentFnPromise = new Promise((resolve) => {\n      self.addEventListener('message', (e) => {\n        if (\n          allowedOrigins.indexOf(e.origin) !== -1 &&\n          e.data.stamp === POST_MESSAGE_STAMP &&\n          e.data.command === POST_MESSAGE_COMMAND_INTRODUCTION\n        ) {\n          resolve((message) => {\n            e.source.postMessage(message, e.origin);\n          });\n        }\n      });\n    });\n\n    function sendErrorMessageToParent() {\n      sendMessageToParentFnPromise.then((sendMessageToParent) => {\n        sendMessageToParent({\n          stamp: POST_MESSAGE_STAMP,\n          command: POST_MESSAGE_COMMAND_ERROR,\n        });\n      });\n    }\n\n    // Validate origins.\n    for (let i = 0; i < allowedOrigins.length; i++) {\n      const allowedOrigin = allowedOrigins[i];\n      const url = new URL(allowedOrigin);\n\n      const isOrigin = url.origin === allowedOrigin;\n      const protocolIsValid =\n        url.protocol === 'http:' || url.protocol === 'https:';\n      const isValidOrigin = isOrigin && protocolIsValid;\n\n      if (!isValidOrigin) {\n        warn(\n          `[swg-gaa.js:GaaGoogleSignInButton.show]: You specified an invalid origin: ${allowedOrigin}`\n        );\n        sendErrorMessageToParent();\n        return;\n      }\n    }\n\n    // Render the Google Sign-In button.\n    configureGoogleSignIn()\n      .then(\n        // Promise credentials.\n        () =>\n          new Promise((resolve) => {\n            // Render the Google Sign-In button.\n            const buttonEl = self.document.createElement('div');\n            buttonEl.id = GOOGLE_SIGN_IN_BUTTON_ID;\n            buttonEl.tabIndex = 0;\n            self.document.body.appendChild(buttonEl);\n            self.gapi.signin2.render(GOOGLE_SIGN_IN_BUTTON_ID, {\n              'longtitle': true,\n              'onsuccess': resolve,\n              'prompt': 'select_account',\n              'scope': 'profile email',\n              'theme': 'dark',\n            });\n\n            // Track button clicks.\n            buttonEl.addEventListener('click', () => {\n              // Tell parent frame about button click.\n              sendMessageToParentFnPromise.then((sendMessageToParent) => {\n                sendMessageToParent({\n                  stamp: POST_MESSAGE_STAMP,\n                  command: POST_MESSAGE_COMMAND_BUTTON_CLICK,\n                });\n              });\n            });\n          })\n      )\n      .then((googleUser) => {\n        // Gather GAA user details.\n        const basicProfile = /** @type {!GoogleUserDef} */ (\n          googleUser\n        ).getBasicProfile();\n        // Gather authorization response.\n        const authorizationData = /** @type {!GoogleUserDef} */ (\n          googleUser\n        ).getAuthResponse(true);\n        /** @type {!GaaUserDef} */\n        const gaaUser = {\n          idToken: authorizationData.id_token,\n          name: basicProfile.getName(),\n          givenName: basicProfile.getGivenName(),\n          familyName: basicProfile.getFamilyName(),\n          imageUrl: basicProfile.getImageUrl(),\n          email: basicProfile.getEmail(),\n          authorizationData,\n        };\n\n        // Send GAA user to parent frame.\n        sendMessageToParentFnPromise.then((sendMessageToParent) => {\n          sendMessageToParent({\n            stamp: POST_MESSAGE_STAMP,\n            command: POST_MESSAGE_COMMAND_USER,\n            gaaUser,\n          });\n        });\n      })\n      .catch(sendErrorMessageToParent);\n  }\n}\n\n/**\n * Loads the Google Sign-In API.\n *\n * This function is used in two places.\n * 1. The publisher's Google Sign-In iframe.\n * 2. (Optional) Demos that allow users to sign out.\n *\n * @return {!Promise}\n */\nfunction configureGoogleSignIn() {\n  // Wait for Google Sign-In API.\n  return (\n    new Promise((resolve) => {\n      const apiCheckInterval = setInterval(() => {\n        if (!!self.gapi) {\n          clearInterval(apiCheckInterval);\n          resolve();\n        }\n      }, 50);\n    })\n      // Load Auth2 module.\n      .then(() => new Promise((resolve) => self.gapi.load('auth2', resolve)))\n      // Specify \"redirect\" mode. It plays nicer with webviews.\n      .then(\n        () =>\n          // Only initialize Google Sign-In once.\n          self.gapi.auth2.getAuthInstance() || self.gapi.auth2.init()\n      )\n  );\n}\n\n/**\n * Calls Swgjs.\n * @param { function(!SubscriptionsDef) } callback\n */\nfunction callSwg(callback) {\n  (self.SWG = self.SWG || []).push(callback);\n}\n\n/** Styles for the third party Google Sign-In button iframe. */\nconst GOOGLE_3P_SIGN_IN_IFRAME_STYLES =\n  GOOGLE_SIGN_IN_IFRAME_STYLES +\n  `\n  #${GOOGLE_3P_SIGN_IN_BUTTON_ID} .abcRioButtonContents {\n    font-family: Roboto,arial,sans-serif;\n    font-size: 14px;\n    font-weight: 500;\n    letter-spacing: .21px;\n    margin-left: 6px;\n    margin-right: 6px;\n    vertical-align: top;\n  }\n  #${GOOGLE_3P_SIGN_IN_BUTTON_ID} .abcRioButton {\n    border-radius: 1px;\n    box-shadow: 0 2px 4px 0 rgb(0 0 0 / 25%);\n    -moz-box-sizing: border-box;\n    box-sizing: border-box;\n    -webkit-transition: background-color .218s,border-color .218s,box-shadow .218s;\n    transition: background-color .218s,border-color .218s,box-shadow .218s;\n    -webkit-user-select: none;\n    -webkit-appearance: none;\n    background-color: #fff;\n    background-image: none;\n    color: #262626;\n    cursor: pointer;\n    outline: none;\n    overflow: hidden;\n    position: relative;\n    text-align: center;\n    vertical-align: middle;\n    white-space: nowrap;\n    width: auto;\n  }\n  #${GOOGLE_3P_SIGN_IN_BUTTON_ID} .abcRioButtonBlue {\n    border: none;\n    color: #fff;\n  }\n  `;\n\nconst GOOGLE_3P_SIGN_IN_BUTTON_HTML = `\n<div style=\"height:36px;width:180px;\" class=\"abcRioButton abcRioButtonBlue\">\n  <span style=\"font-size:15px;line-height:34px;\" class=\"abcRioButtonContents\">\n    <span id=\"not_signed_in\">Sign in with Google</span>\n  </span>\n</div>\n`;\n\nclass GaaGoogle3pSignInButton {\n  /**\n   * Renders the third party Google Sign-In button for external authentication.\n   * @nocollapse\n   * @param {{ allowedOrigins: !Array<string>, authorizationUrl: string }} params\n   */\n  static show({allowedOrigins, authorizationUrl}) {\n    // Optionally grab language code from URL.\n    const queryString = GaaUtils.getQueryString();\n    const queryParams = parseQueryString(queryString);\n    const languageCode = queryParams['lang'] || 'en';\n\n    // Apply iframe styles.\n    const styleEl = self.document.createElement('style');\n    styleEl./*OK*/ innerText = GOOGLE_3P_SIGN_IN_IFRAME_STYLES.replace(\n      '$SHOWCASE_REGWALL_GOOGLE_SIGN_IN_BUTTON$',\n      msg(I18N_STRINGS['SHOWCASE_REGWALL_GOOGLE_SIGN_IN_BUTTON'], languageCode)\n    );\n    self.document.head.appendChild(styleEl);\n\n    // Render the third party Google Sign-In button.\n    const buttonEl = self.document.createElement('div');\n    buttonEl.id = GOOGLE_3P_SIGN_IN_BUTTON_ID;\n    buttonEl.tabIndex = 0;\n    buttonEl./*OK*/ innerHTML = GOOGLE_3P_SIGN_IN_BUTTON_HTML;\n    buttonEl.onclick = () => {\n      self.open(authorizationUrl);\n    };\n    self.document.body.appendChild(buttonEl);\n\n    // Promise a function that sends messages to the parent frame.\n    // Note: A function is preferable to a reference to the parent frame\n    // because referencing the parent frame outside of the 'message' event\n    // handler throws an Error. A function defined within the handler can\n    // effectively save a reference to the parent frame though.\n    const sendMessageToParentFnPromise = new Promise((resolve) => {\n      self.addEventListener('message', (e) => {\n        if (\n          allowedOrigins.indexOf(e.origin) !== -1 &&\n          e.data.stamp === POST_MESSAGE_STAMP &&\n          e.data.command === POST_MESSAGE_COMMAND_INTRODUCTION\n        ) {\n          resolve((message) => {\n            e.source.postMessage(message, e.origin);\n          });\n        }\n      });\n    });\n\n    function sendErrorMessageToParent() {\n      sendMessageToParentFnPromise.then((sendMessageToParent) => {\n        sendMessageToParent({\n          stamp: POST_MESSAGE_STAMP,\n          command: POST_MESSAGE_COMMAND_ERROR,\n        });\n      });\n    }\n\n    // Validate origins.\n    for (let i = 0; i < allowedOrigins.length; i++) {\n      const allowedOrigin = allowedOrigins[i];\n      const url = new URL(allowedOrigin);\n\n      const isOrigin = url.origin === allowedOrigin;\n      const protocolIsValid =\n        url.protocol === 'http:' || url.protocol === 'https:';\n      const isValidOrigin = isOrigin && protocolIsValid;\n\n      if (!isValidOrigin) {\n        warn(\n          `[swg-gaa.js:GaaGoogle3pSignInButton.show]: You specified an invalid origin: ${allowedOrigin}`\n        );\n        sendErrorMessageToParent();\n        return;\n      }\n    }\n\n    // Relay message to the parent frame (GAA Intervention).\n    self.addEventListener('message', (e) => {\n      if (\n        allowedOrigins.indexOf(e.origin) !== -1 &&\n        e.data.stamp === POST_MESSAGE_STAMP &&\n        e.data.command === POST_MESSAGE_COMMAND_USER\n      ) {\n        self.parent.postMessage(e.data, e.origin);\n      }\n    });\n  }\n}\n\n/**\n * Logs Showcase events.\n * @param {{\n *   analyticsEvent: (AnalyticsEvent|undefined),\n *   showcaseEvent: (ShowcaseEvent|undefined),\n *   isFromUserAction: boolean,\n * }} params\n */\nfunction logEvent({analyticsEvent, showcaseEvent, isFromUserAction} = {}) {\n  callSwg((swg) => {\n    // Get reference to event manager.\n    swg.getEventManager().then((eventManager) => {\n      // Get list of analytics events.\n      const eventTypes = showcaseEvent\n        ? showcaseEventToAnalyticsEvents(showcaseEvent)\n        : [analyticsEvent];\n\n      // Log each analytics event.\n      eventTypes.forEach((eventType) => {\n        eventManager.logEvent({\n          eventType,\n          eventOriginator: EventOriginator.SWG_CLIENT,\n          isFromUserAction,\n          additionalParameters: null,\n        });\n      });\n    });\n  });\n}\n\nclass GaaUtils {\n  /**\n   * Returns query string from current URL.\n   * Tests can override this method to return different URLs.\n   * @return {string}\n   */\n  static getQueryString() {\n    return self.location.search;\n  }\n}\n\nexport { GaaGoogle3pSignInButton, GaaGoogleSignInButton, GaaMeteringRegwall, GaaUserDef, GoogleUserDef };\n", "export const CSS = \".swg-button,.swg-button-dark,.swg-button-light{border:0;border-radius:4px;box-sizing:border-box;outline:0;padding:11px 8px;width:240px;min-width:150px;height:40px;min-height:40px}.swg-button-dark:after,.swg-button-light:after,.swg-button:after{display:block;max-width:200px;max-height:40px;width:100%;height:100%;margin:auto;content:\\\"\\\";border:0;background-origin:content-box;background-position:50%;background-repeat:no-repeat;background-size:contain}.swg-button,.swg-button-light{background-color:#fff;box-shadow:0 1px 1px 0 rgba(60,64,67,0.3),0 1px 3px 1px rgba(60,64,67,0.15)}.swg-button-light:after,.swg-button:after{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg width='235' height='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cpath d='M169.367 19c-5.09 0-9.367-4.265-9.367-9.5s4.277-9.5 9.367-9.5c2.818 0 4.823 1.133 6.33 2.622l-1.775 1.827c-1.082-1.04-2.55-1.857-4.555-1.857-3.72 0-6.628 3.081-6.628 6.908 0 3.827 2.907 6.908 6.628 6.908 2.411 0 3.78-1 4.664-1.898.724-.745 1.19-1.806 1.37-3.265h-6.034V8.643h8.494c.09.459.139 1.02.139 1.622 0 1.95-.516 4.357-2.183 6.072-1.627 1.734-3.691 2.663-6.45 2.663z' fill='%234285F4' fill-rule='nonzero'/%3E%3Cpath d='M192 13c0 3.456-2.69 6-6 6s-6-2.544-6-6c0-3.476 2.69-6 6-6s6 2.524 6 6zm-2.63 0c0-2.164-1.563-3.636-3.37-3.636-1.807 0-3.37 1.482-3.37 3.636 0 2.134 1.563 3.636 3.37 3.636 1.807 0 3.37-1.492 3.37-3.636z' fill='%23E94235' fill-rule='nonzero'/%3E%3Cpath d='M205 13c0 3.456-2.69 6-6 6-3.3 0-6-2.544-6-6 0-3.476 2.69-6 6-6s6 2.524 6 6zm-2.62 0c0-2.164-1.563-3.636-3.37-3.636-1.807 0-3.37 1.482-3.37 3.636 0 2.134 1.563 3.636 3.37 3.636 1.807.01 3.37-1.492 3.37-3.636z' fill='%23FABB05' fill-rule='nonzero'/%3E%3Cpath d='M217 7.362v10.53c0 4.337-2.499 6.108-5.457 6.108-2.786 0-4.452-1.908-5.083-3.465l2.192-.93c.392.96 1.35 2.085 2.891 2.085 1.896 0 3.064-1.204 3.064-3.445v-.841h-.087c-.564.714-1.656 1.33-3.025 1.33-2.872 0-5.495-2.554-5.495-5.842C206 9.584 208.633 7 211.495 7c1.37 0 2.46.626 3.025 1.311h.087v-.949H217zm-2.221 5.54c0-2.066-1.35-3.582-3.064-3.582-1.742 0-3.197 1.507-3.197 3.582 0 2.045 1.455 3.533 3.197 3.533 1.714 0 3.064-1.488 3.064-3.533z' fill='%234285F4' fill-rule='nonzero'/%3E%3Cpath fill='%2334A853' fill-rule='nonzero' d='M223 1v18h-3V1z'/%3E%3Cpath d='m232.844 14.973 2.046 1.363c-.662.981-2.256 2.664-5.014 2.664-3.42 0-5.876-2.634-5.876-6 0-3.566 2.487-6 5.585-6 3.119 0 4.643 2.474 5.144 3.816l.271.681-8.032 3.326c.612 1.202 1.574 1.823 2.918 1.823s2.276-.671 2.958-1.673zm-6.307-2.163 5.375-2.224c-.301-.751-1.184-1.272-2.237-1.272-1.343 0-3.208 1.182-3.138 3.496z' fill='%23E94235' fill-rule='nonzero'/%3E%3Cpath d='M6.576 19.384c-1.248 0-2.468-.408-3.66-1.224-1.192-.816-1.972-1.96-2.34-3.432l2.016-.816c.24.944.732 1.74 1.476 2.388.744.648 1.58.972 2.508.972.96 0 1.78-.252 2.46-.756.68-.504 1.02-1.188 1.02-2.052 0-.96-.34-1.7-1.02-2.22-.68-.52-1.756-1.004-3.228-1.452-1.52-.48-2.672-1.1-3.456-1.86-.784-.76-1.176-1.732-1.176-2.916 0-1.232.488-2.304 1.464-3.216.976-.912 2.248-1.368 3.816-1.368 1.456 0 2.64.364 3.552 1.092.912.728 1.504 1.524 1.776 2.388l-2.016.84c-.144-.544-.5-1.048-1.068-1.512-.568-.464-1.3-.696-2.196-.696-.848 0-1.572.236-2.172.708-.6.472-.9 1.06-.9 1.764 0 .64.276 1.18.828 1.62.552.44 1.364.836 2.436 1.188.848.272 1.556.536 2.124.792a9.842 9.842 0 0 1 1.728 1.02 4.065 4.065 0 0 1 1.32 1.584c.296.632.444 1.364.444 2.196 0 .832-.172 1.576-.516 2.232a4.19 4.19 0 0 1-1.368 1.56 6.875 6.875 0 0 1-3.852 1.176zM24.936 19h-2.112v-1.632h-.096c-.336.56-.848 1.036-1.536 1.428a4.345 4.345 0 0 1-2.184.588c-1.472 0-2.588-.448-3.348-1.344-.76-.896-1.14-2.096-1.14-3.6v-7.2h2.208v6.84c0 2.192.968 3.288 2.904 3.288.912 0 1.656-.368 2.232-1.104.576-.736.864-1.584.864-2.544V7.24h2.208V19zm8.904.384c-.896 0-1.7-.192-2.412-.576-.712-.384-1.244-.864-1.596-1.44h-.096V19h-2.112V1.816h2.208V7.24l-.096 1.632h.096c.352-.576.884-1.056 1.596-1.44.712-.384 1.516-.576 2.412-.576 1.52 0 2.832.6 3.936 1.8 1.104 1.2 1.656 2.688 1.656 4.464 0 1.776-.552 3.264-1.656 4.464-1.104 1.2-2.416 1.8-3.936 1.8zm-.36-2.016c1.024 0 1.904-.388 2.64-1.164.736-.776 1.104-1.804 1.104-3.084s-.368-2.308-1.104-3.084c-.736-.776-1.616-1.164-2.64-1.164-1.04 0-1.924.384-2.652 1.152-.728.768-1.092 1.8-1.092 3.096s.364 2.328 1.092 3.096c.728.768 1.612 1.152 2.652 1.152zm12.336 2.016c-1.312 0-2.396-.32-3.252-.96a5.682 5.682 0 0 1-1.884-2.4l1.968-.816c.624 1.472 1.688 2.208 3.192 2.208.688 0 1.252-.152 1.692-.456.44-.304.66-.704.66-1.2 0-.768-.536-1.288-1.608-1.56l-2.376-.576c-.752-.192-1.464-.556-2.136-1.092-.672-.536-1.008-1.26-1.008-2.172 0-1.04.46-1.884 1.38-2.532.92-.648 2.012-.972 3.276-.972 1.04 0 1.968.236 2.784.708a3.99 3.99 0 0 1 1.752 2.028l-1.92.792c-.432-1.04-1.328-1.56-2.688-1.56-.656 0-1.208.136-1.656.408-.448.272-.672.64-.672 1.104 0 .672.52 1.128 1.56 1.368l2.328.552c1.104.256 1.92.696 2.448 1.32.528.624.792 1.328.792 2.112 0 1.056-.432 1.936-1.296 2.64-.864.704-1.976 1.056-3.336 1.056zm11.928 0c-1.76 0-3.208-.596-4.344-1.788-1.136-1.192-1.704-2.684-1.704-4.476 0-1.792.568-3.284 1.704-4.476 1.136-1.192 2.584-1.788 4.344-1.788 1.312 0 2.4.32 3.264.96a5.621 5.621 0 0 1 1.896 2.424l-2.016.84c-.608-1.472-1.704-2.208-3.288-2.208-.976 0-1.836.4-2.58 1.2-.744.8-1.116 1.816-1.116 3.048s.372 2.248 1.116 3.048c.744.8 1.604 1.2 2.58 1.2 1.648 0 2.784-.736 3.408-2.208l1.968.84c-.4.96-1.044 1.764-1.932 2.412-.888.648-1.988.972-3.3.972zm9.36-.384h-2.208V7.24h2.112v1.92h.096c.224-.64.684-1.168 1.38-1.584.696-.416 1.372-.624 2.028-.624.656 0 1.208.096 1.656.288l-.84 2.064c-.288-.112-.68-.168-1.176-.168-.8 0-1.508.316-2.124.948-.616.632-.924 1.46-.924 2.484V19zm8.904-14.712a1.504 1.504 0 0 1-1.104.456c-.432 0-.8-.152-1.104-.456a1.504 1.504 0 0 1-.456-1.104c0-.432.152-.8.456-1.104a1.504 1.504 0 0 1 1.104-.456c.432 0 .8.152 1.104.456.304.304.456.672.456 1.104 0 .432-.152.8-.456 1.104zm0 14.712H73.8V7.24h2.208V19zm9.096.384c-.896 0-1.7-.192-2.412-.576-.712-.384-1.244-.864-1.596-1.44H81V19h-2.112V1.816h2.208V7.24L81 8.872h.096c.352-.576.884-1.056 1.596-1.44.712-.384 1.516-.576 2.412-.576 1.52 0 2.832.6 3.936 1.8 1.104 1.2 1.656 2.688 1.656 4.464 0 1.776-.552 3.264-1.656 4.464-1.104 1.2-2.416 1.8-3.936 1.8zm-.36-2.016c1.024 0 1.904-.388 2.64-1.164.736-.776 1.104-1.804 1.104-3.084s-.368-2.308-1.104-3.084c-.736-.776-1.616-1.164-2.64-1.164-1.04 0-1.924.384-2.652 1.152-.728.768-1.092 1.8-1.092 3.096s.364 2.328 1.092 3.096c.728.768 1.612 1.152 2.652 1.152zm13.296 2.016c-1.776 0-3.22-.592-4.332-1.776-1.112-1.184-1.668-2.68-1.668-4.488 0-1.712.54-3.184 1.62-4.416 1.08-1.232 2.46-1.848 4.14-1.848 1.744 0 3.14.568 4.188 1.704 1.048 1.136 1.572 2.656 1.572 4.56l-.024.408h-9.288c.064 1.184.46 2.12 1.188 2.808.728.688 1.58 1.032 2.556 1.032 1.584 0 2.656-.672 3.216-2.016l1.968.816c-.384.912-1.016 1.676-1.896 2.292-.88.616-1.96.924-3.24.924zm3.168-7.68c-.048-.672-.356-1.312-.924-1.92-.568-.608-1.412-.912-2.532-.912-.816 0-1.524.256-2.124.768-.6.512-1.012 1.2-1.236 2.064h6.816zM123.72 19h-2.256l-2.928-9.024L115.632 19H113.4l-3.792-11.76h2.304l2.616 8.88h.024l2.904-8.88h2.28l2.904 8.88h.024l2.592-8.88h2.256L123.72 19zm7.632-14.712a1.504 1.504 0 0 1-1.104.456c-.432 0-.8-.152-1.104-.456a1.504 1.504 0 0 1-.456-1.104c0-.432.152-.8.456-1.104a1.504 1.504 0 0 1 1.104-.456c.432 0 .8.152 1.104.456.304.304.456.672.456 1.104 0 .432-.152.8-.456 1.104zm0 14.712h-2.208V7.24h2.208V19zm7.968.192c-1.232 0-2.172-.328-2.82-.984-.648-.656-.972-1.584-.972-2.784V9.256h-2.064V7.24h2.064v-3.6h2.208v3.6h2.88v2.016h-2.88v6c0 1.28.528 1.92 1.584 1.92.4 0 .736-.064 1.008-.192l.768 1.896c-.48.208-1.072.312-1.776.312zm5.616-17.376V7.24l-.096 1.632h.096c.32-.56.824-1.036 1.512-1.428a4.389 4.389 0 0 1 2.208-.588c1.456 0 2.568.448 3.336 1.344.768.896 1.152 2.096 1.152 3.6V19h-2.208v-6.864c0-2.176-.968-3.264-2.904-3.264-.912 0-1.656.364-2.232 1.092-.576.728-.864 1.572-.864 2.532V19h-2.208V1.816h2.208z' fill='%235F6368'/%3E%3C/g%3E%3C/svg%3E\\\")}.swg-button-dark{background-color:#000}.swg-button-dark:after{background-image:url(\\\"data:image/svg+xml;charset=utf-8,%3Csvg width='231' height='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23FFF' fill-rule='evenodd'%3E%3Cpath d='M6.302 19.368c-1.196 0-2.365-.391-3.507-1.173-1.143-.782-1.89-1.878-2.243-3.289l1.932-.782c.23.905.701 1.667 1.414 2.289.714.62 1.515.931 2.404.931.92 0 1.706-.241 2.357-.725.652-.483.978-1.138.978-1.966 0-.92-.326-1.63-.978-2.128-.651-.498-1.682-.962-3.093-1.391-1.457-.46-2.56-1.054-3.312-1.783-.751-.728-1.127-1.66-1.127-2.794 0-1.18.468-2.208 1.403-3.082.935-.874 2.154-1.311 3.657-1.311 1.395 0 2.53.349 3.404 1.046.874.698 1.441 1.461 1.702 2.289l-1.932.805c-.138-.521-.48-1.004-1.024-1.449-.544-.445-1.245-.667-2.104-.667-.813 0-1.506.226-2.081.679-.576.452-.863 1.015-.863 1.69 0 .613.264 1.13.793 1.553.53.421 1.308.8 2.335 1.138.813.26 1.491.514 2.036.759a9.431 9.431 0 0 1 1.655.978c.56.406.982.912 1.265 1.518.284.605.426 1.307.426 2.104 0 .797-.165 1.51-.494 2.139a4.015 4.015 0 0 1-1.312 1.495 6.589 6.589 0 0 1-3.691 1.127zM23.696 19h-2.024v-1.564h-.092c-.322.537-.813.993-1.472 1.369a4.164 4.164 0 0 1-2.093.563c-1.41 0-2.48-.43-3.209-1.288-.728-.859-1.092-2.009-1.092-3.45v-6.9h2.116v6.555c0 2.1.927 3.151 2.783 3.151.874 0 1.587-.353 2.139-1.058a3.845 3.845 0 0 0 .828-2.438V7.73h2.116V19zm8.677.368c-.86 0-1.63-.184-2.312-.552-.682-.368-1.192-.828-1.53-1.38h-.091V19h-2.024V2.532h2.116V7.73l-.093 1.564h.093c.337-.552.847-1.012 1.529-1.38.682-.368 1.453-.552 2.312-.552 1.456 0 2.713.575 3.772 1.725 1.058 1.15 1.586 2.576 1.586 4.278 0 1.702-.528 3.128-1.587 4.278-1.058 1.15-2.315 1.725-3.771 1.725zm-.345-1.932c.98 0 1.824-.372 2.53-1.116.705-.743 1.057-1.728 1.057-2.955s-.352-2.212-1.058-2.956c-.705-.743-1.548-1.115-2.53-1.115-.996 0-1.843.368-2.541 1.104-.698.736-1.047 1.725-1.047 2.967s.35 2.231 1.047 2.967c.698.736 1.545 1.104 2.542 1.104zm11.85 1.932c-1.257 0-2.296-.307-3.116-.92a5.446 5.446 0 0 1-1.806-2.3l1.886-.782c.598 1.41 1.618 2.116 3.06 2.116.659 0 1.2-.146 1.62-.437.422-.291.633-.675.633-1.15 0-.736-.513-1.234-1.54-1.495l-2.278-.552c-.72-.184-1.403-.533-2.047-1.046-.644-.514-.966-1.208-.966-2.082 0-.997.441-1.805 1.323-2.427.881-.62 1.928-.931 3.14-.931.996 0 1.885.226 2.667.678a3.824 3.824 0 0 1 1.68 1.944l-1.84.759c-.415-.997-1.273-1.495-2.577-1.495-.628 0-1.157.13-1.587.391-.43.26-.644.613-.644 1.058 0 .644.499 1.081 1.495 1.311l2.231.529c1.058.245 1.84.667 2.346 1.265.506.598.76 1.273.76 2.024 0 1.012-.415 1.855-1.243 2.53-.828.675-1.893 1.012-3.197 1.012zm11.69 0c-1.687 0-3.074-.571-4.163-1.713-1.089-1.143-1.633-2.573-1.633-4.29s.544-3.147 1.633-4.29c1.089-1.142 2.476-1.713 4.163-1.713 1.257 0 2.3.307 3.128.92a5.387 5.387 0 0 1 1.817 2.323l-1.932.805c-.583-1.41-1.633-2.116-3.151-2.116-.935 0-1.76.383-2.472 1.15-.714.767-1.07 1.74-1.07 2.921 0 1.18.356 2.154 1.07 2.921.713.767 1.537 1.15 2.472 1.15 1.58 0 2.668-.705 3.266-2.116l1.886.805c-.383.92-1 1.69-1.852 2.311-.85.622-1.905.932-3.162.932zM64.567 19H62.45V7.73h2.024v1.84h.092c.214-.613.655-1.12 1.322-1.518.667-.399 1.315-.598 1.944-.598.628 0 1.157.092 1.587.276l-.805 1.978c-.276-.107-.652-.161-1.127-.161-.767 0-1.445.303-2.036.909-.59.605-.885 1.399-.885 2.38V19zm8.677-14.099a1.441 1.441 0 0 1-1.058.437c-.415 0-.767-.146-1.059-.437a1.441 1.441 0 0 1-.436-1.058c0-.414.145-.767.436-1.058a1.441 1.441 0 0 1 1.059-.437c.414 0 .766.146 1.057.437.292.291.438.644.438 1.058 0 .414-.146.767-.438 1.058zm0 14.099h-2.117V7.73h2.117V19zm8.86.368c-.858 0-1.629-.184-2.311-.552-.683-.368-1.192-.828-1.53-1.38h-.092V19h-2.024V2.532h2.116V7.73l-.092 1.564h.092c.338-.552.847-1.012 1.53-1.38.682-.368 1.453-.552 2.311-.552 1.457 0 2.714.575 3.772 1.725 1.058 1.15 1.587 2.576 1.587 4.278 0 1.702-.529 3.128-1.587 4.278-1.058 1.15-2.315 1.725-3.772 1.725zm-.345-1.932c.982 0 1.825-.372 2.53-1.116.706-.743 1.058-1.728 1.058-2.955s-.352-2.212-1.058-2.956c-.705-.743-1.548-1.115-2.53-1.115-.996 0-1.844.368-2.541 1.104-.698.736-1.047 1.725-1.047 2.967s.35 2.231 1.047 2.967c.697.736 1.545 1.104 2.541 1.104zm12.886 1.932c-1.702 0-3.086-.567-4.151-1.702-1.066-1.135-1.599-2.568-1.599-4.301 0-1.64.517-3.051 1.553-4.232 1.035-1.18 2.357-1.771 3.967-1.771 1.671 0 3.01.544 4.013 1.633 1.005 1.089 1.507 2.545 1.507 4.37l-.023.391h-8.901c.061 1.135.44 2.032 1.139 2.691.697.66 1.514.989 2.449.989 1.518 0 2.545-.644 3.082-1.932l1.886.782c-.368.874-.974 1.606-1.817 2.197-.843.59-1.878.885-3.105.885zm3.036-7.36c-.046-.644-.341-1.257-.885-1.84-.545-.583-1.354-.874-2.427-.874-.782 0-1.46.245-2.035.736-.576.49-.97 1.15-1.185 1.978h6.532zM119.543 19h-2.163l-2.805-8.648L111.79 19h-2.138l-3.635-11.27h2.209l2.507 8.51h.023l2.782-8.51h2.186l2.782 8.51h.023l2.484-8.51h2.163L119.541 19zM127 4.901a1.441 1.441 0 0 1-1.058.437c-.414 0-.766-.146-1.058-.437a1.441 1.441 0 0 1-.437-1.058c0-.414.146-.767.437-1.058a1.441 1.441 0 0 1 1.058-.437c.414 0 .767.146 1.058.437.292.291.437.644.437 1.058 0 .414-.145.767-.437 1.058zM127 19h-2.116V7.73H127V19zm7.665.184c-1.18 0-2.081-.314-2.702-.943-.622-.629-.932-1.518-.932-2.668V9.662h-1.978V7.73h1.978V4.28h2.116v3.45h2.76v1.932h-2.76v5.75c0 1.227.506 1.84 1.518 1.84.383 0 .705-.061.966-.184l.736 1.817c-.46.2-1.027.299-1.702.299zm5.64-16.652V7.73l-.091 1.564h.092c.306-.537.79-.993 1.449-1.369a4.206 4.206 0 0 1 2.116-.563c1.395 0 2.46.43 3.197 1.288.736.859 1.104 2.009 1.104 3.45V19h-2.116v-6.578c0-2.085-.928-3.128-2.783-3.128-.874 0-1.587.349-2.14 1.046-.551.698-.827 1.507-.827 2.427V19h-2.116V2.532h2.116z'/%3E%3Cg fill-rule='nonzero'%3E%3Cpath d='M165.367 19c-5.09 0-9.367-4.265-9.367-9.5s4.277-9.5 9.367-9.5c2.818 0 4.823 1.133 6.33 2.622l-1.775 1.827c-1.082-1.04-2.55-1.857-4.555-1.857-3.72 0-6.628 3.081-6.628 6.908 0 3.827 2.907 6.908 6.628 6.908 2.411 0 3.78-1 4.664-1.898.724-.745 1.19-1.806 1.37-3.265h-6.034V8.643h8.494c.09.459.139 1.02.139 1.622 0 1.95-.516 4.357-2.183 6.072-1.627 1.734-3.691 2.663-6.45 2.663zM188 13c0 3.456-2.69 6-6 6s-6-2.544-6-6c0-3.476 2.69-6 6-6s6 2.524 6 6zm-2.63 0c0-2.164-1.563-3.636-3.37-3.636-1.807 0-3.37 1.482-3.37 3.636 0 2.134 1.563 3.636 3.37 3.636 1.807 0 3.37-1.492 3.37-3.636zM201 13c0 3.456-2.69 6-6 6-3.3 0-6-2.544-6-6 0-3.476 2.69-6 6-6s6 2.524 6 6zm-2.62 0c0-2.164-1.563-3.636-3.37-3.636-1.807 0-3.37 1.482-3.37 3.636 0 2.134 1.563 3.636 3.37 3.636 1.807.01 3.37-1.492 3.37-3.636zM213 7.362v10.53c0 4.337-2.499 6.108-5.457 6.108-2.786 0-4.452-1.908-5.083-3.465l2.192-.93c.392.96 1.35 2.085 2.891 2.085 1.896 0 3.064-1.204 3.064-3.445v-.841h-.087c-.564.714-1.656 1.33-3.025 1.33-2.872 0-5.495-2.554-5.495-5.842C202 9.584 204.633 7 207.495 7c1.37 0 2.46.626 3.025 1.311h.087v-.949H213zm-2.221 5.54c0-2.066-1.35-3.582-3.064-3.582-1.742 0-3.197 1.507-3.197 3.582 0 2.045 1.455 3.533 3.197 3.533 1.714 0 3.064-1.488 3.064-3.533zM219 1v18h-3V1zM228.844 14.973l2.046 1.363c-.662.981-2.256 2.664-5.014 2.664-3.42 0-5.876-2.634-5.876-6 0-3.566 2.487-6 5.585-6 3.119 0 4.643 2.474 5.144 3.816l.271.681-8.032 3.326c.612 1.202 1.574 1.823 2.918 1.823s2.276-.671 2.958-1.673zm-6.307-2.163 5.375-2.224c-.301-.751-1.184-1.272-2.237-1.272-1.343 0-3.208 1.182-3.138 3.496z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\\\")}.swg-button-light:hover,.swg-button:hover{background-color:#f8f8f8}.swg-button-light:focus,.swg-button:focus{box-shadow:#e8e8e8}.swg-button-light:active,.swg-button:active{background-color:#fff}.swg-button-dark:hover{background-color:#3c4043}.swg-button-dark:focus{box-shadow:#202124}.swg-button-dark:active{background-color:#5f6368}.swg-smart-button{border:none;padding:0;background:transparent;min-height:126px;position:relative;min-width:300px;width:300px;border-radius:0;overflow:hidden}.swg-smart-button:focus{outline:none}.swg-button-light:lang(ar):after,.swg-button:lang(ar):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-ar-lt.svg)}.swg-button-dark:lang(ar):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-ar-dk.svg)}.swg-button-light:lang(de):after,.swg-button:lang(de):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-de-lt.svg)}.swg-button-dark:lang(de):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-de-dk.svg)}.swg-button-light:lang(es):after,.swg-button:lang(es):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-es-lt.svg)}.swg-button-dark:lang(es):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-es-dk.svg)}.swg-button-light:lang(es-latam):after,.swg-button:lang(es-latam):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-es-latam-lt.svg)}.swg-button-dark:lang(es-latam):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-es-latam-dk.svg)}.swg-button-light:lang(es-latn):after,.swg-button:lang(es-latn):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-es-latam-lt.svg)}.swg-button-dark:lang(es-latn):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-es-latam-dk.svg)}.swg-button-light:lang(fr):after,.swg-button:lang(fr):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-fr-lt.svg)}.swg-button-dark:lang(fr):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-fr-dk.svg)}.swg-button-light:lang(hi):after,.swg-button:lang(hi):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-hi-lt.svg)}.swg-button-dark:lang(hi):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-hi-dk.svg)}.swg-button-light:lang(id):after,.swg-button:lang(id):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-id-lt.svg)}.swg-button-dark:lang(id):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-id-dk.svg)}.swg-button-light:lang(it):after,.swg-button:lang(it):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-it-lt.svg)}.swg-button-dark:lang(it):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-it-dk.svg)}.swg-button-light:lang(jp):after,.swg-button:lang(jp):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-jp-lt.svg)}.swg-button-dark:lang(jp):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-jp-dk.svg)}.swg-button-light:lang(ko):after,.swg-button:lang(ko):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-ko-lt.svg)}.swg-button-dark:lang(ko):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-ko-dk.svg)}.swg-button-light:lang(ms):after,.swg-button:lang(ms):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-ms-lt.svg)}.swg-button-dark:lang(ms):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-ms-dk.svg)}.swg-button-light:lang(nl):after,.swg-button:lang(nl):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-nl-lt.svg)}.swg-button-dark:lang(nl):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-nl-dk.svg)}.swg-button-light:lang(no):after,.swg-button:lang(no):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-no-lt.svg)}.swg-button-dark:lang(no):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-no-dk.svg)}.swg-button-light:lang(pl):after,.swg-button:lang(pl):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-pl-lt.svg)}.swg-button-dark:lang(pl):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-pl-dk.svg)}.swg-button-light:lang(pt):after,.swg-button:lang(pt):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-pt-lt.svg)}.swg-button-dark:lang(pt):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-pt-dk.svg)}.swg-button-light:lang(pt-br):after,.swg-button:lang(pt-br):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-pt-br-lt.svg)}.swg-button-dark:lang(pt-br):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-pt-br-dk.svg)}.swg-button-light:lang(ru):after,.swg-button:lang(ru):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-ru-lt.svg)}.swg-button-dark:lang(ru):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-ru-dk.svg)}.swg-button-light:lang(se):after,.swg-button:lang(se):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-se-lt.svg)}.swg-button-dark:lang(se):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-se-dk.svg)}.swg-button-light:lang(th):after,.swg-button:lang(th):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-th-lt.svg)}.swg-button-dark:lang(th):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-th-dk.svg)}.swg-button-light:lang(tr):after,.swg-button:lang(tr):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-tr-lt.svg)}.swg-button-dark:lang(tr):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-tr-dk.svg)}.swg-button-light:lang(uk):after,.swg-button:lang(uk):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-uk-lt.svg)}.swg-button-dark:lang(uk):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-uk-dk.svg)}.swg-button-light:lang(zh-tw):after,.swg-button:lang(zh-tw):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-zh-tw-lt.svg)}.swg-button-dark:lang(zh-tw):after{background-image:url(https://news.google.com/swg/js/v1/i18n/b-zh-tw-dk.svg)}.swg-button-v2-dark,.swg-button-v2-light{border:0;border-radius:4px;outline:0;width:237px;min-width:237px;height:44px;min-height:44px;display:-ms-inline-flexbox;display:inline-flex;-ms-flex-align:center;align-items:center;box-sizing:border-box;font-family:Google Sans,Roboto-Regular,sans-serif,arial;font-weight:500;font-size:14px;letter-spacing:0.001em;cursor:pointer}.swg-button-v2-light{color:#1a73e8;background-color:#fff;border:1px solid #dadce0}.swg-button-v2-light[disabled]{pointer-events:none;color:rgba(60,64,67,0.38);border:1px solid rgba(60,64,67,0.12)}.swg-button-v2-light:hover{box-shadow:0px 1px 2px rgba(60,64,67,0.3),0px 1px 3px 1px rgba(60,64,67,0.15);background:linear-gradient(0deg,rgba(26,115,232,0.04),rgba(26,115,232,0.04)),#fff;border:none}.swg-button-v2-light:focus{box-shadow:0px 1px 2px rgba(60,64,67,0.3),0px 2px 6px 2px rgba(60,64,67,0.15);background:linear-gradient(0deg,rgba(26,115,232,0.08),rgba(26,115,232,0.08)),#fff;border:none}.swg-button-v2-light:active{background-color:#fff;box-shadow:0px 6px 10px 4px rgba(60,64,67,0.15),0px 2px 3px rgba(60,64,67,0.3);border:none}.swg-button-v2-dark{color:#fff;background-color:#3c4043}.swg-button-v2-dark[disabled]{color:hsla(0,0%,100%,0.38);pointer-events:none}.swg-button-v2-dark:active,.swg-button-v2-dark:hover{box-shadow:0px 2px 6px 2px rgba(0,0,0,0.15),0px 1px 2px rgba(0,0,0,0.3);background-color:#202124}.swg-button-v2-dark:focus{box-shadow:0px 6px 10px 4px rgba(0,0,0,0.15),0px 2px 3px rgba(0,0,0,0.3);background-color:#202124}.swg-button-v2-icon-dark,.swg-button-v2-icon-light{background-size:contain;width:18px;height:18px;margin-left:16px;margin-right:8px}.swg-button-v2-icon-light{background-image:url(https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg)}.swg-button-v2-light[disabled] .swg-button-v2-icon-light{background-image:url(https://fonts.gstatic.com/s/i/googlematerialicons/google/v20/gm_grey-24dp/2x/gm_google_gm_grey_24dp.png);opacity:0.38}.swg-button-v2-icon-dark{background-image:url(https://fonts.gstatic.com/s/i/googlematerialicons/google/v13/white-24dp/2x/gm_google_white_24dp.png)}.swg-button-v2-dark[disabled] .swg-button-v2-icon-dark{background-image:url(https://fonts.gstatic.com/s/i/googlematerialicons/google/v20/gm_grey-24dp/2x/gm_google_gm_grey_24dp.png)}[subscriptions-action][subscriptions-google-rtc]{opacity:0.5;cursor:not-allowed}\\n/*# sourceURL=/extensions/amp-subscriptions-google/0.1/amp-subscriptions-google.css*/\";\n", "import {CommonSignals} from '#core/constants/common-signals';\nimport {TickLabel} from '#core/constants/enums';\nimport {insertAfterOrAtStart, waitForBodyOpenPromise} from '#core/dom';\nimport {setStyles} from '#core/dom/style';\nimport {rethrowAsync} from '#core/error';\nimport {map} from '#core/types/object';\n\nimport {Services} from '#service';\n\nimport {dev, devAssert} from '#utils/log';\n\nimport {waitForServices} from './render-delaying-services';\nimport {getAmpdoc} from './service-helpers';\n\nconst TRANSFORMER_PROP = '__AMP_CSS_TR';\nconst STYLE_MAP_PROP = '__AMP_CSS_SM';\n\n/**\n * Adds the given css text to the given ampdoc.\n *\n * The style tags will be at the beginning of the head before all author\n * styles. One element can be the main runtime CSS. This is guaranteed\n * to always be the first stylesheet in the doc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc The ampdoc that should get the new styles.\n * @param {string} cssText\n * @param {?function(!Element)|undefined} cb Called when the new styles are available.\n *     Not using a promise, because this is synchronous when possible.\n *     for better performance.\n * @param {boolean=} opt_isRuntimeCss If true, this style tag will be inserted\n *     as the first element in head and all style elements will be positioned\n *     after.\n * @param {string=} opt_ext\n * @return {!Element}\n */\nexport function installStylesForDoc(\n  ampdoc,\n  cssText,\n  cb,\n  opt_isRuntimeCss,\n  opt_ext\n) {\n  const cssRoot = ampdoc.getHeadNode();\n  const style = insertStyleElement(\n    cssRoot,\n    maybeTransform(cssRoot, cssText),\n    opt_isRuntimeCss || false,\n    opt_ext || null\n  );\n\n  if (cb) {\n    const rootNode = ampdoc.getRootNode();\n    // Styles aren't always available synchronously. E.g. if there is a\n    // pending style download, it will have to finish before the new\n    // style is visible.\n    // For this reason we poll until the style becomes available.\n    // Sync case.\n    if (styleLoaded(rootNode, style)) {\n      cb(style);\n      return style;\n    }\n    // Poll until styles are available.\n    const interval = setInterval(() => {\n      if (styleLoaded(rootNode, style)) {\n        clearInterval(interval);\n        cb(style);\n      }\n    }, 4);\n  }\n  return style;\n}\n\n/**\n * Creates the properly configured style element.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @param {boolean} isRuntimeCss\n * @param {?string} ext\n * @return {!Element}\n */\nfunction insertStyleElement(cssRoot, cssText, isRuntimeCss, ext) {\n  let styleMap = cssRoot[STYLE_MAP_PROP];\n  if (!styleMap) {\n    styleMap = cssRoot[STYLE_MAP_PROP] = map();\n  }\n\n  const isExtCss =\n    !isRuntimeCss && ext && ext != 'amp-custom' && ext != 'amp-keyframes';\n  const key = isRuntimeCss\n    ? 'amp-runtime'\n    : isExtCss\n    ? `amp-extension=${ext}`\n    : null;\n\n  // Check if it has already been created or discovered.\n  if (key) {\n    const existing = getExistingStyleElement(cssRoot, styleMap, key);\n    if (existing) {\n      if (existing.textContent !== cssText) {\n        existing.textContent = cssText;\n      }\n      return existing;\n    }\n  }\n\n  // Create the new style element and append to cssRoot.\n  const doc = cssRoot.ownerDocument || cssRoot;\n  const style = doc.createElement('style');\n  style./*OK*/ textContent = cssText;\n  let afterElement = null;\n  // Make sure that we place style tags after the main runtime CSS. Otherwise\n  // the order is random.\n  if (isRuntimeCss) {\n    style.setAttribute('amp-runtime', '');\n  } else if (isExtCss) {\n    style.setAttribute('amp-extension', ext || '');\n    afterElement = dev().assertElement(\n      getExistingStyleElement(cssRoot, styleMap, 'amp-runtime')\n    );\n  } else {\n    if (ext) {\n      style.setAttribute(ext, '');\n    }\n    afterElement = cssRoot.lastChild;\n  }\n  insertAfterOrAtStart(cssRoot, style, afterElement);\n  if (key) {\n    styleMap[key] = style;\n  }\n  return style;\n}\n\n/**\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {!Object<string, !Element>} styleMap\n * @param {string} key\n * @return {?Element}\n */\nfunction getExistingStyleElement(cssRoot, styleMap, key) {\n  // Already cached.\n  if (styleMap[key]) {\n    return styleMap[key];\n  }\n  // Check if the style has already been added by the server layout.\n  const existing = cssRoot./*OK*/ querySelector(`style[${key}]`);\n  if (existing) {\n    styleMap[key] = existing;\n    return existing;\n  }\n  // Nothing found.\n  return null;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {function(string):string} transformer\n */\nexport function installCssTransformer(cssRoot, transformer) {\n  cssRoot[TRANSFORMER_PROP] = transformer;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @return {string}\n */\nfunction maybeTransform(cssRoot, cssText) {\n  const transformer = cssRoot[TRANSFORMER_PROP];\n  return transformer ? transformer(cssText) : cssText;\n}\n\n/** @private {boolean} */\nlet bodyMadeVisible = false;\n\n/**\n * @param {boolean} value\n * @visibleForTesting\n */\nexport function setBodyMadeVisibleForTesting(value) {\n  bodyMadeVisible = value;\n}\n\n/**\n * Sets the document's body opacity to 1.\n * If the body is not yet available (because our script was loaded\n * synchronously), polls until it is.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisible(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  const win = /** @type {!Window} */ (doc.defaultView);\n  waitForBodyOpenPromise(doc)\n    .then(() => {\n      return waitForServices(win);\n    })\n    .catch((reason) => {\n      rethrowAsync(reason);\n      return [];\n    })\n    .then((services) => {\n      bodyMadeVisible = true;\n      if (INI_LOAD_INOB) {\n        // Force sync measurement to ensure that style recalc is complete\n        // before showing body, which would trigger FCP. This should reduce\n        // make it less likely that a CLS would be triggered after FCP.\n        doc.body./*OK*/ getBoundingClientRect();\n      }\n      setBodyVisibleStyles(doc);\n      const ampdoc = getAmpdoc(doc);\n      ampdoc.signals().signal(CommonSignals.RENDER_START);\n      if (services.length > 0) {\n        const resources = Services.resourcesForDoc(doc.documentElement);\n        resources./*OK*/ schedulePass(1, /* relayoutAll */ true);\n      }\n      try {\n        const perf = Services.performanceFor(win);\n        perf.tick(TickLabel.MAKE_BODY_VISIBLE);\n        perf.flush();\n      } catch (e) {}\n    });\n}\n\n/**\n * Set the document's body opacity to 1. Called in error cases.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisibleRecovery(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  if (bodyMadeVisible) {\n    return;\n  }\n  bodyMadeVisible = true;\n  setBodyVisibleStyles(doc);\n}\n\n/**\n * Make sure that body exists, and make it visible.\n * @param {!Document} doc\n */\nfunction setBodyVisibleStyles(doc) {\n  setStyles(dev().assertElement(doc.body), {\n    opacity: 1,\n    visibility: 'visible',\n    'animation': 'none',\n  });\n}\n\n/**\n * Indicates that the body is always visible. For instance, in case of PWA.\n * This check is on a module level variable, and could be problematic if you are\n * relying on this function across different binaries.\n * @param {!Window} unusedWin\n */\nexport function bodyAlwaysVisible(unusedWin) {\n  bodyMadeVisible = true;\n}\n\n/**\n * Checks whether a style element was registered in the DOM.\n * @param {!Document|!ShadowRoot} doc\n * @param {!Element} style\n * @return {boolean}\n */\nfunction styleLoaded(doc, style) {\n  const sheets = doc.styleSheets;\n  for (let i = 0; i < sheets.length; i++) {\n    const sheet = sheets[i];\n    if (sheet.ownerNode == style) {\n      return true;\n    }\n  }\n  return false;\n}\n", "import {map} from '#core/types/object';\n\n/**\n * @template T\n */\nexport class LruCache {\n  /**\n   * @param {number} capacity\n   */\n  constructor(capacity) {\n    /** @private @const {number} */\n    this.capacity_ = capacity;\n\n    /** @private {number} */\n    this.size_ = 0;\n\n    /**\n     * An incrementing counter to define the last access.\n     * @private {number}\n     */\n    this.access_ = 0;\n\n    /** @private {!Object<(number|string), {payload: T, access: number}>} */\n    this.cache_ = map();\n  }\n\n  /**\n   * Returns whether key is cached.\n   *\n   * @param {number|string} key\n   * @return {boolean}\n   */\n  has(key) {\n    return !!this.cache_[key];\n  }\n\n  /**\n   * @param {number|string} key\n   * @return {T} The cached payload.\n   */\n  get(key) {\n    const cacheable = this.cache_[key];\n    if (cacheable) {\n      cacheable.access = ++this.access_;\n      return cacheable.payload;\n    }\n    return undefined;\n  }\n\n  /**\n   * @param {number|string} key\n   * @param {T} payload The payload to cache.\n   */\n  put(key, payload) {\n    if (!this.has(key)) {\n      this.size_++;\n    }\n    this.cache_[key] = {payload, access: this.access_};\n    this.evict_();\n  }\n\n  /**\n   * Evicts the oldest cache entry, if we've exceeded capacity.\n   */\n  evict_() {\n    if (this.size_ <= this.capacity_) {\n      return;\n    }\n\n    const cache = this.cache_;\n    let oldest = this.access_ + 1;\n    let oldestKey;\n    for (const key in cache) {\n      const {access} = cache[key];\n      if (access < oldest) {\n        oldest = access;\n        oldestKey = key;\n      }\n    }\n\n    if (oldestKey !== undefined) {\n      delete cache[oldestKey];\n      this.size_--;\n    }\n  }\n}\n", "import {LruCache} from '#core/data-structures/lru-cache';\nimport * as mode from '#core/mode';\nimport {arrayOrSingleItemToArray} from '#core/types/array';\nimport {dict, hasOwn} from '#core/types/object';\nimport {endsWith} from '#core/types/string';\nimport {parseQueryString} from '#core/types/string/url';\n\nimport {userAssert} from '#utils/log';\n\nimport {urls} from './config';\n\nconst SERVING_TYPE_PREFIX = new Set([\n  // No viewer\n  'c',\n  // In viewer\n  'v',\n  // Ad landing page\n  'a',\n  // Ad\n  'ad',\n]);\n\n/**\n * Cached a-tag to avoid memory allocation during URL parsing.\n * @type {HTMLAnchorElement}\n */\nlet cachedAnchorEl;\n\n/**\n * We cached all parsed URLs. As of now there are no use cases\n * of AMP docs that would ever parse an actual large number of URLs,\n * but we often parse the same one over and over again.\n * @type {LruCache}\n */\nlet urlCache;\n\n// eslint-disable-next-line no-script-url\nconst INVALID_PROTOCOLS = ['javascript:', 'data:', 'vbscript:'];\n\n/** @const {string} */\nexport const SOURCE_ORIGIN_PARAM = '__amp_source_origin';\n\n/**\n * Coerces a url into a location;\n * @function\n * @param {string|!Location} url\n * @return {!Location}\n */\nconst urlAsLocation = (url) =>\n  typeof url == 'string' ? parseUrlDeprecated(url) : url;\n\n/**\n * Returns the correct origin for a given window.\n * TODO(rcebulko): This really belongs under #core/window somewhere, not in url\n * @param {!Window} win\n * @return {string} origin\n */\nexport function getWinOrigin(win) {\n  return win.origin || parseUrlDeprecated(win.location.href).origin;\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * TODO(#34453): The URL constructor isn't supported in IE11, but is supported\n * everywhere else. There's a lot of code paths (and all uses of the LruCache)\n * that are built around this polyfill. Once we can drop IE11 support and just\n * use the URL constructor, we can clear out all of parseWithA, all the URL\n * cache logic (incl. additional caches in other call-sites). Most is guarded by\n * isEsm() and is only included in nomodule builds, but still.\n * @param {string} url\n * @param {boolean=} opt_nocache\n *   Cache is always ignored on ESM builds, see https://go.amp.dev/pr/31594\n * @return {!Location}\n */\nexport function parseUrlDeprecated(url, opt_nocache) {\n  if (!cachedAnchorEl) {\n    cachedAnchorEl = /** @type {!HTMLAnchorElement} */ (\n      self.document.createElement('a')\n    );\n    urlCache = mode.isEsm()\n      ? null\n      : self.__AMP_URL_CACHE || (self.__AMP_URL_CACHE = new LruCache(100));\n  }\n\n  return parseUrlWithA(\n    cachedAnchorEl,\n    url,\n    mode.isEsm() || opt_nocache ? null : urlCache\n  );\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {!HTMLAnchorElement} anchorEl\n * @param {string} url\n * @param {LruCache=} opt_cache\n *   Cache is always ignored on ESM builds, see https://go.amp.dev/pr/31594\n * @return {!Location}\n * @restricted\n */\nexport function parseUrlWithA(anchorEl, url, opt_cache) {\n  if (mode.isEsm()) {\n    // Doing this causes the <a> to auto-set its own href to the resolved path,\n    // which would be the baseUrl for the URL constructor.\n    anchorEl.href = '';\n    return /** @type {?} */ (new URL(url, anchorEl.href));\n  }\n\n  if (opt_cache && opt_cache.has(url)) {\n    return opt_cache.get(url);\n  }\n\n  anchorEl.href = url;\n\n  // IE11 doesn't provide full URL components when parsing relative URLs.\n  // Assigning to itself again does the trick #3449.\n  if (!anchorEl.protocol) {\n    anchorEl.href = anchorEl.href;\n  }\n\n  const info = /** @type {!Location} */ ({\n    href: anchorEl.href,\n    protocol: anchorEl.protocol,\n    host: anchorEl.host,\n    hostname: anchorEl.hostname,\n    port: anchorEl.port == '0' ? '' : anchorEl.port,\n    pathname: anchorEl.pathname,\n    search: anchorEl.search,\n    hash: anchorEl.hash,\n    origin: null, // Set below.\n  });\n\n  // Some IE11 specific polyfills.\n  // 1) IE11 strips out the leading '/' in the pathname.\n  if (info.pathname[0] !== '/') {\n    info.pathname = '/' + info.pathname;\n  }\n\n  // 2) For URLs with implicit ports, IE11 parses to default ports while\n  // other browsers leave the port field empty.\n  if (\n    (info.protocol == 'http:' && info.port == 80) ||\n    (info.protocol == 'https:' && info.port == 443)\n  ) {\n    info.port = '';\n    info.host = info.hostname;\n  }\n\n  // For data URI anchorEl.origin is equal to the string 'null' which is not useful.\n  // We instead return the actual origin which is the full URL.\n  let origin;\n  if (anchorEl.origin && anchorEl.origin != 'null') {\n    origin = anchorEl.origin;\n  } else if (info.protocol == 'data:' || !info.host) {\n    origin = info.href;\n  } else {\n    origin = info.protocol + '//' + info.host;\n  }\n  info.origin = origin;\n\n  // Freeze during testing to avoid accidental mutation.\n  const frozen = mode.isTest() && Object.freeze ? Object.freeze(info) : info;\n\n  if (opt_cache) {\n    opt_cache.put(url, frozen);\n  }\n\n  return frozen;\n}\n\n/**\n * Appends the string just before the fragment part (or optionally\n * to the front of the query string) of the URL.\n * @param {string} url\n * @param {string} paramString\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function appendEncodedParamStringToUrl(\n  url,\n  paramString,\n  opt_addToFront\n) {\n  if (!paramString) {\n    return url;\n  }\n  const mainAndFragment = url.split('#', 2);\n  const mainAndQuery = mainAndFragment[0].split('?', 2);\n\n  let newUrl =\n    mainAndQuery[0] +\n    (mainAndQuery[1]\n      ? opt_addToFront\n        ? `?${paramString}&${mainAndQuery[1]}`\n        : `?${mainAndQuery[1]}&${paramString}`\n      : `?${paramString}`);\n  newUrl += mainAndFragment[1] ? `#${mainAndFragment[1]}` : '';\n  return newUrl;\n}\n\n/**\n * @param {string} key\n * @param {string} value\n * @return {string}\n */\nfunction urlEncodeKeyValue(key, value) {\n  return `${encodeURIComponent(key)}=${encodeURIComponent(value)}`;\n}\n\n/**\n * Appends a query string field and value to a url. `key` and `value`\n * will be ran through `encodeURIComponent` before appending.\n * @param {string} url\n * @param {string} key\n * @param {string} value\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function addParamToUrl(url, key, value, opt_addToFront) {\n  return appendEncodedParamStringToUrl(\n    url,\n    urlEncodeKeyValue(key, value),\n    opt_addToFront\n  );\n}\n\n/**\n * Appends query string fields and values to a url. The `params` objects'\n * `key`s and `value`s will be transformed into query string keys/values.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addParamsToUrl(url, params) {\n  return appendEncodedParamStringToUrl(url, serializeQueryString(params));\n}\n\n/**\n * Append query string fields and values to a url, only if the key does not\n * exist in current query string.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addMissingParamsToUrl(url, params) {\n  const location = parseUrlDeprecated(url);\n  const existingParams = parseQueryString(location.search);\n  const paramsToAdd = dict({});\n  const keys = Object.keys(params);\n  for (let i = 0; i < keys.length; i++) {\n    if (!hasOwn(existingParams, keys[i])) {\n      paramsToAdd[keys[i]] = params[keys[i]];\n    }\n  }\n  return addParamsToUrl(url, paramsToAdd);\n}\n\n/**\n * Serializes the passed parameter map into a query string with both keys\n * and values encoded.\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function serializeQueryString(params) {\n  const s = [];\n  for (const k in params) {\n    let v = params[k];\n    if (v == null) {\n      continue;\n    }\n\n    v = arrayOrSingleItemToArray(v);\n    for (let i = 0; i < v.length; i++) {\n      s.push(urlEncodeKeyValue(k, v[i]));\n    }\n  }\n  return s.join('&');\n}\n\n/**\n * Returns `true` if the URL is secure: either HTTPS or localhost (for testing).\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isSecureUrlDeprecated(url) {\n  url = urlAsLocation(url);\n  return (\n    url.protocol == 'https:' ||\n    url.hostname == 'localhost' ||\n    url.hostname == '127.0.0.1' ||\n    endsWith(url.hostname, '.localhost')\n  );\n}\n\n/**\n * Asserts that a given url is HTTPS or protocol relative. It's a user-level\n * assert.\n *\n * Provides an exception for localhost.\n *\n * @param {?string|undefined} urlString\n * @param {!Element|string} elementContext Element where the url was found.\n * @param {string=} sourceName Used for error messages.\n * @return {string}\n */\nexport function assertHttpsUrl(\n  urlString,\n  elementContext,\n  sourceName = 'source'\n) {\n  userAssert(\n    urlString != null,\n    '%s %s must be available',\n    elementContext,\n    sourceName\n  );\n  userAssert(\n    isSecureUrlDeprecated(urlString) || /^\\/\\//.test(urlString),\n    '%s %s must start with ' +\n      '\"https://\" or \"//\" or be relative and served from ' +\n      'either https or from localhost. Invalid value: %s',\n    elementContext,\n    sourceName,\n    urlString\n  );\n  return urlString;\n}\n\n/**\n * Asserts that a given url is an absolute HTTP or HTTPS URL.\n * @param {string} urlString\n * @return {string}\n */\nexport function assertAbsoluteHttpOrHttpsUrl(urlString) {\n  userAssert(\n    /^https?\\:/i.test(urlString),\n    'URL must start with \"http://\" or \"https://\". Invalid value: %s',\n    urlString\n  );\n  return parseUrlDeprecated(urlString).href;\n}\n\n/**\n * Returns the URL without fragment. If URL doesn't contain fragment, the same\n * string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function removeFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return url;\n  }\n  return url.substring(0, index);\n}\n\n/**\n * Returns the fragment from the URL. If the URL doesn't contain fragment,\n * the empty string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function getFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return '';\n  }\n  return url.substring(index);\n}\n\n/**\n * Returns whether the URL has the origin of a proxy.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isProxyOrigin(url) {\n  return urls.cdnProxyRegex.test(urlAsLocation(url).origin);\n}\n\n/**\n * Returns whether the URL origin is localhost.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isLocalhostOrigin(url) {\n  return urls.localhostRegex.test(urlAsLocation(url).origin);\n}\n\n/**\n * @param {string} uri\n * @return {boolean}\n */\nexport function isAmpScriptUri(uri) {\n  return uri.startsWith('amp-script:');\n}\n\n/**\n * For proxy-origin URLs, returns the serving type. Otherwise, returns null.\n * E.g., 'https://amp-com.cdn.ampproject.org/a/s/amp.com/amp_document.html'\n * returns 'a'.\n * @param {string|!Location} url URL of an AMP document.\n * @return {?string}\n */\nexport function getProxyServingType(url) {\n  url = urlAsLocation(url);\n  if (!isProxyOrigin(url)) {\n    return null;\n  }\n  const path = url.pathname.split('/', 2);\n  return path[1];\n}\n\n/**\n * Returns whether the URL has valid protocol.\n * Deep link protocol is valid, but not javascript etc.\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isProtocolValid(url) {\n  return !(url && INVALID_PROTOCOLS.includes(urlAsLocation(url).protocol));\n}\n\n/**\n * Returns a URL without AMP JS parameters.\n * @param {string} url\n * @return {string}\n */\nexport function removeAmpJsParamsFromUrl(url) {\n  const {hash, origin, pathname, search} = parseUrlDeprecated(url);\n  const searchRemoved = removeAmpJsParamsFromSearch(search);\n  return origin + pathname + searchRemoved + hash;\n}\n\n/**\n * Returns a URL without a query string.\n * @param {string} url\n * @return {string}\n */\nexport function removeSearch(url) {\n  const index = url.indexOf('?');\n  if (index == -1) {\n    return url;\n  }\n  const fragment = getFragment(url);\n  return url.substring(0, index) + fragment;\n}\n\n/**\n * Removes parameters that start with amp js parameter pattern and returns the\n * new search string.\n * @param {string} urlSearch\n * @return {string}\n */\nfunction removeAmpJsParamsFromSearch(urlSearch) {\n  // The below regex is a combo of these original patterns. Combining these,\n  // removing the corresponding `.replace` calls, and reusing\n  // removeParamsFromSearch saves ~175B. Matches params in query string:\n  // - /[?&]amp_js[^&]*/   amp_js_*\n  // - /[?&]amp_gsa[^&]*/  amp_gsa\n  // - /[?&]amp_r[^&]*/    amp_r\n  // - /[?&]amp_kit[^&]*/  amp_kit\n  // - /[?&]usqp[^&]*/     usqp (from goog experiment)\n  return removeParamsFromSearch(urlSearch, '(amp_(js[^&=]*|gsa|r|kit)|usqp)');\n}\n\n/**\n * Removes parameters with param name and returns the new search string.\n * @param {string} urlSearch\n * @param {string} paramName\n * @return {string}\n */\nexport function removeParamsFromSearch(urlSearch, paramName) {\n  // TODO: Accept paramNames as an array.\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n  const paramRegex = new RegExp(`[?&]${paramName}\\\\b[^&]*`, 'g');\n  const search = urlSearch.replace(paramRegex, '').replace(/^[?&]/, '');\n  return search ? '?' + search : '';\n}\n\n/**\n * Returns the source URL of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string}\n */\nexport function getSourceUrl(url) {\n  url = urlAsLocation(url);\n\n  // Not a proxy URL - return the URL itself.\n  if (!isProxyOrigin(url)) {\n    return url.href;\n  }\n\n  // A proxy URL.\n  // Example path that is being matched here.\n  // https://cdn.ampproject.org/c/s/www.origin.com/foo/\n  // The /s/ is optional and signals a secure origin.\n  const path = url.pathname.split('/');\n  const prefix = path[1];\n  userAssert(\n    SERVING_TYPE_PREFIX.has(prefix),\n    'Unknown path prefix in url %s',\n    url.href\n  );\n  const domainOrHttpsSignal = path[2];\n  const origin =\n    domainOrHttpsSignal == 's'\n      ? 'https://' + decodeURIComponent(path[3])\n      : 'http://' + decodeURIComponent(domainOrHttpsSignal);\n  // Sanity test that what we found looks like a domain.\n  userAssert(origin.indexOf('.') > 0, 'Expected a . in origin %s', origin);\n  path.splice(1, domainOrHttpsSignal == 's' ? 3 : 2);\n  return (\n    origin +\n    path.join('/') +\n    removeAmpJsParamsFromSearch(url.search) +\n    (url.hash || '')\n  );\n}\n\n/**\n * Returns the source origin of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string} The source origin of the URL.\n */\nexport function getSourceOrigin(url) {\n  return parseUrlDeprecated(getSourceUrl(url)).origin;\n}\n\n/**\n * Returns absolute URL resolved based on the relative URL and the base.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n */\nexport function resolveRelativeUrl(relativeUrlString, baseUrl) {\n  baseUrl = urlAsLocation(baseUrl);\n  if (mode.isEsm() || typeof URL == 'function') {\n    return new URL(relativeUrlString, baseUrl.href).toString();\n  }\n  return resolveRelativeUrlFallback_(relativeUrlString, baseUrl);\n}\n\n/**\n * Fallback for URL resolver when URL class is not available.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n * @private @visibleForTesting\n */\nexport function resolveRelativeUrlFallback_(relativeUrlString, baseUrl) {\n  baseUrl = urlAsLocation(baseUrl);\n  relativeUrlString = relativeUrlString.replace(/\\\\/g, '/');\n  const relativeUrl = parseUrlDeprecated(relativeUrlString);\n\n  // Absolute URL.\n  if (relativeUrlString.toLowerCase().startsWith(relativeUrl.protocol)) {\n    return relativeUrl.href;\n  }\n\n  // Protocol-relative URL.\n  if (relativeUrlString.startsWith('//')) {\n    return baseUrl.protocol + relativeUrlString;\n  }\n\n  // Absolute path.\n  if (relativeUrlString.startsWith('/')) {\n    return baseUrl.origin + relativeUrlString;\n  }\n\n  // Relative path.\n  return (\n    baseUrl.origin +\n    baseUrl.pathname.replace(/\\/[^/]*$/, '/') +\n    relativeUrlString\n  );\n}\n\n/**\n * Add \"__amp_source_origin\" query parameter to the URL.\n * @param {!Window} win\n * @param {string} url\n * @return {string}\n */\nexport function getCorsUrl(win, url) {\n  checkCorsUrl(url);\n  const sourceOrigin = getSourceOrigin(win.location.href);\n  return addParamToUrl(url, SOURCE_ORIGIN_PARAM, sourceOrigin);\n}\n\n/**\n * Checks if the url has __amp_source_origin and throws if it does.\n * @param {string} url\n */\nexport function checkCorsUrl(url) {\n  const parsedUrl = parseUrlDeprecated(url);\n  const query = parseQueryString(parsedUrl.search);\n  userAssert(\n    !(SOURCE_ORIGIN_PARAM in query),\n    'Source origin is not allowed in %s',\n    url\n  );\n}\n\n/**\n * Adds the path to the given url.\n *\n * @param {!Location} url\n * @param {string} path\n * @return {string}\n */\nexport function appendPathToUrl(url, path) {\n  const pathname = url.pathname.replace(/\\/?$/, '/') + path.replace(/^\\//, '');\n  return url.origin + pathname + url.search + url.hash;\n}\n", "import {dict} from '#core/types/object';\nimport {triggerAnalyticsEvent} from '#utils/analytics';\nimport {user} from '#utils/log';\n\nconst TAG = 'amp-subscriptions';\n\n/**\n * subscriptions-platform-* event names are deprecated in favor\n * of subscription-service-*  The DEPRECATED events are still triggered\n * for backward compatibility with existing publisher code.\n * @enum {string}\n */\nexport const SubscriptionAnalyticsEvents = {\n  PLATFORM_ACTIVATED: 'subscriptions-service-activated',\n  PLATFORM_ACTIVATED_DEPRECATED: 'subscriptions-platform-activated',\n  PAYWALL_ACTIVATED: 'subscriptions-paywall-activated',\n  PLATFORM_REGISTERED: 'subscriptions-service-registered',\n  PLATFORM_REGISTERED_DEPRECATED: 'subscriptions-platform-registered',\n  PLATFORM_REAUTHORIZED: 'subscriptions-service-re-authorized',\n  PLATFORM_REAUTHORIZED_DEPRECATED: 'subscriptions-platform-re-authorized',\n  ACTION_DELEGATED: 'subscriptions-action-delegated',\n  ENTITLEMENT_RESOLVED: 'subscriptions-entitlement-resolved',\n  STARTED: 'subscriptions-started',\n  ACCESS_GRANTED: 'subscriptions-access-granted',\n  ACCESS_DENIED: 'subscriptions-access-denied',\n  // common service adapter events\n  LINK_REQUESTED: 'subscriptions-link-requested',\n  LINK_COMPLETE: 'subscriptions-link-complete',\n  LINK_CANCELED: 'subscriptions-link-canceled',\n  SUBSCRIPTIONS_ACTION: 'subscriptions-action',\n};\n\n/** @enum {string} */\nexport const Action = {\n  LOGIN: 'login',\n  LOGOUT: 'logout',\n  LINK: 'link',\n  SUBSCRIBE: 'subscribe',\n  CONTRIBUTE: 'contribute',\n  SHOW_CONTRIBUTION_OPTIONS: 'showContributionOptions',\n  SHOW_OFFERS: 'showOffers',\n};\n\n/** @enum {string} */\nexport const ActionStatus = {\n  STARTED: 'started',\n  REJECTED: 'rejected',\n  FAILED: 'failed',\n  SUCCESS: 'success',\n};\n\nexport class SubscriptionAnalytics {\n  /**\n   * Creates an instance of SubscriptionAnalytics.\n   * @param {!Element} element\n   */\n  constructor(element) {\n    this.element_ = element;\n\n    /** @private @const {Array<function((!SubscriptionAnalyticsEvents|string),!JsonObject,!JsonObject)>} */\n    this.listeners_ = [];\n  }\n\n  /**\n   * Notified of any event sent to SubscriptionAnalytics.  The parameters\n   * passed to the listener are:\n   *  1) The type of event.  This should eventually always be an enum value but\n   *     may not be in some circumstances for historic reasons.\n   *  2) The optional parameters passed into the framework by the publisher\n   *  3) An internal variables object which be populated for the\n   *     SUBSCRIPTIONS_ACTION event type: {\n   *       action: (Action|undefined),\n   *       status: (ActionStatus|undefined),\n   *     }\n   * @param {function((!SubscriptionAnalyticsEvents|string),!JsonObject,!JsonObject)} listener\n   */\n  registerEventListener(listener) {\n    this.listeners_.push(listener);\n  }\n\n  /**\n   * @param {!SubscriptionAnalyticsEvents|string} eventType\n   * @param {string} platformKey\n   * @param {!JsonObject=} opt_vars\n   * @param {!JsonObject=} internalVars\n   */\n  serviceEvent(eventType, platformKey, opt_vars, internalVars) {\n    this.event(\n      eventType,\n      /** @type {!JsonObject} */ (\n        Object.assign(\n          dict({\n            'serviceId': platformKey,\n          }),\n          opt_vars\n        )\n      ),\n      internalVars\n    );\n  }\n\n  /**\n   * @param {!SubscriptionAnalyticsEvents|string} eventType\n   * @param {!JsonObject=} opt_vars\n   * @param {!JsonObject=} internalVars\n   */\n  event(eventType, opt_vars, internalVars) {\n    internalVars = internalVars || dict({});\n\n    const loggedString =\n      eventType !== SubscriptionAnalyticsEvents.SUBSCRIPTIONS_ACTION\n        ? eventType\n        : eventType + `-${internalVars['action']}-${internalVars['status']}`;\n\n    user().info(TAG, loggedString, opt_vars || '');\n\n    opt_vars = opt_vars || dict({});\n    triggerAnalyticsEvent(\n      this.element_,\n      loggedString,\n      opt_vars,\n      /** enableDataVars */ false\n    );\n\n    for (let l = 0; l < this.listeners_.length; l++) {\n      this.listeners_[l](eventType, opt_vars, internalVars);\n    }\n  }\n\n  /**\n   * @param {string} platformKey\n   * @param {!Action|string} action\n   * @param {!ActionStatus|string} status\n   * @param {!JsonObject=} opt_vars\n   */\n  actionEvent(platformKey, action, status, opt_vars) {\n    this.serviceEvent(\n      SubscriptionAnalyticsEvents.SUBSCRIPTIONS_ACTION,\n      platformKey,\n      opt_vars,\n      dict({\n        'action': action,\n        'status': status,\n      })\n    );\n  }\n}\n", "/** @fileoverview Shared constants. */\n\n/**\n * How long to wait before giving up on an entitlements request.\n * @const\n */\nexport const ENTITLEMENTS_REQUEST_TIMEOUT = 3000;\n\n/**\n * Possible score factors.\n * @const @enum {string}\n */\nexport const SubscriptionsScoreFactor = {\n  // User is known to platform and has a form of payment registered\n  IS_READY_TO_PAY: 'isReadyToPay',\n  // Platform supports the current viewer environment\n  SUPPORTS_VIEWER: 'supportsViewer',\n};\n\n/**\n * All other score factors are ignored if not specified in the publisher\n * config so adding a default here would be meaningless.\n */\nexport const DEFAULT_SCORE_CONFIG = {};\n", "/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/** Version: 0.1.22.190 */\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {!Document} doc\n * @return {string}\n */\nfunction getReadyState(doc) {\n  return /** @type {string} */ (doc['readyState']);\n}\n\n/**\n * Whether the document is ready.\n * @param {!Document} doc\n * @return {boolean}\n */\nfunction isDocumentReady(doc) {\n  const readyState = getReadyState(doc);\n  return readyState != 'loading' && readyState != 'uninitialized';\n}\n\n/**\n * Calls the callback when document is ready.\n * @param {!Document} doc\n * @param {function(!Document)} callback\n */\nfunction onDocumentReady(doc, callback) {\n  onDocumentState(doc, isDocumentReady, callback);\n}\n\n/**\n * Calls the callback once when document's state satisfies the condition.\n * @param {!Document} doc\n * @param {function(!Document):boolean} condition\n * @param {function(!Document)} callback\n */\nfunction onDocumentState(doc, condition, callback) {\n  if (condition(doc)) {\n    // Execute callback right now.\n    callback(doc);\n    return;\n  }\n\n  // Execute callback (once!) after condition is satisfied.\n  let callbackHasExecuted = false;\n  const readyListener = () => {\n    if (condition(doc) && !callbackHasExecuted) {\n      callback(doc);\n      callbackHasExecuted = true;\n      doc.removeEventListener('readystatechange', readyListener);\n    }\n  };\n  doc.addEventListener('readystatechange', readyListener);\n}\n\n/**\n * Returns a promise that is resolved when document is ready.\n * @param {!Document} doc\n * @return {!Promise<!Document>}\n */\nfunction whenDocumentReady(doc) {\n  return new Promise((resolve) => {\n    onDocumentReady(doc, resolve);\n  });\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @interface\n */\nclass Doc {\n  /**\n   * @return {!Window}\n   */\n  getWin() {}\n\n  /**\n   * The `Document` node or analog.\n   * @return {!Node}\n   */\n  getRootNode() {}\n\n  /**\n   * The `Document.documentElement` element or analog.\n   * @return {!Element}\n   */\n  getRootElement() {}\n\n  /**\n   * The `Document.head` element or analog. Returns `null` if not available\n   * yet.\n   * @return {!Element}\n   */\n  getHead() {}\n\n  /**\n   * The `Document.body` element or analog. Returns `null` if not available\n   * yet.\n   * @return {?Element}\n   */\n  getBody() {}\n\n  /**\n   * Whether the document has been fully constructed.\n   * @return {boolean}\n   */\n  isReady() {}\n\n  /**\n   * Resolved when document has been fully constructed.\n   * @return {!Promise}\n   */\n  whenReady() {}\n\n  /**\n   * Adds the element to the fixed layer.\n   * @param {!Element} unusedElement\n   * @return {!Promise}\n   *\n   * This is a no-op for except in AMP on iOS < 13.0.\n   */\n  addToFixedLayer(unusedElement) {}\n}\n\n/** @implements {Doc} */\nclass GlobalDoc {\n  /**\n   * @param {!Window|!Document} winOrDoc\n   */\n  constructor(winOrDoc) {\n    const isWin = !!winOrDoc.document;\n    /** @private @const {!Window} */\n    this.win_ = /** @type {!Window} */ (\n      isWin\n        ? /** @type {!Window} */ (winOrDoc)\n        : /** @type {!Document} */ (winOrDoc).defaultView\n    );\n    /** @private @const {!Document} */\n    this.doc_ = isWin\n      ? /** @type {!Window} */ (winOrDoc).document\n      : /** @type {!Document} */ (winOrDoc);\n  }\n\n  /** @override */\n  getWin() {\n    return this.win_;\n  }\n\n  /** @override */\n  getRootNode() {\n    return this.doc_;\n  }\n\n  /** @override */\n  getRootElement() {\n    return this.doc_.documentElement;\n  }\n\n  /** @override */\n  getHead() {\n    // `document.head` always has a chance to be parsed, at least partially.\n    return /** @type {!Element} */ (this.doc_.head);\n  }\n\n  /** @override */\n  getBody() {\n    return this.doc_.body;\n  }\n\n  /** @override */\n  isReady() {\n    return isDocumentReady(this.doc_);\n  }\n\n  /** @override */\n  whenReady() {\n    return whenDocumentReady(this.doc_);\n  }\n\n  /** @override */\n  addToFixedLayer(unusedElement) {\n    return Promise.resolve();\n  }\n}\n\n/**\n * @param {!Document|!Window|!Doc} input\n * @return {!Doc}\n */\nfunction resolveDoc(input) {\n  // Is it a `Document`\n  if (/** @type {!Document} */ (input).nodeType === /* DOCUMENT */ 9) {\n    return new GlobalDoc(/** @type {!Document} */ (input));\n  }\n  // Is it a `Window`?\n  if (/** @type {!Window} */ (input).document) {\n    return new GlobalDoc(/** @type {!Window} */ (input));\n  }\n  return /** @type {!Doc} */ (input);\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n */\nclass PageConfig {\n  /**\n   * @param {string} productOrPublicationId\n   * @param {boolean} locked\n   */\n  constructor(productOrPublicationId, locked) {\n    let publicationId, productId, label;\n    const div = productOrPublicationId.indexOf(':');\n    if (div != -1) {\n      // The argument is a product id.\n      productId = productOrPublicationId;\n      publicationId = productId.substring(0, div);\n      label = productId.substring(div + 1);\n    } else {\n      // The argument is a publication id.\n      publicationId = productOrPublicationId;\n      productId = null;\n      label = null;\n    }\n\n    /** @private @const {string} */\n    this.publicationId_ = publicationId;\n    /** @private @const {?string} */\n    this.productId_ = productId;\n    /** @private @const {?string} */\n    this.label_ = label;\n    /** @private @const {boolean} */\n    this.locked_ = locked;\n  }\n\n  /**\n   * @return {string}\n   */\n  getPublicationId() {\n    return this.publicationId_;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getProductId() {\n    return this.productId_;\n  }\n\n  /**\n   * @return {?string}\n   */\n  getLabel() {\n    return this.label_;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isLocked() {\n    return this.locked_;\n  }\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Debug logger, only log message if #swg.log=1\n * @param {...*} var_args [decription]\n */\n\n/* eslint-disable */\n\nfunction debugLog(var_args) {\n  if (/swg.debug=1/.test(self.location.hash)) {\n    const logArgs = Array.prototype.slice.call(arguments, 0);\n    logArgs.unshift('[Subscriptions]');\n    log.apply(log, logArgs);\n  }\n}\n\n/**\n * @param  {...*} var_args [description]\n */\nfunction log(var_args) {\n  console.log.apply(console, arguments);\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether the element have a next node in the document order.\n * This means either:\n *  a. The element itself has a nextSibling.\n *  b. Any of the element ancestors has a nextSibling.\n * @param {!Element} element\n * @param {?Node=} stopNode\n * @return {boolean}\n */\nfunction hasNextNodeInDocumentOrder(element, stopNode) {\n  let currentElement = element;\n  do {\n    if (currentElement.nextSibling) {\n      return true;\n    }\n  } while (\n    (currentElement = currentElement.parentNode) &&\n    currentElement != stopNode\n  );\n  return false;\n}\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview This module declares JSON types as defined in the\n * {@link http://json.org/}.\n */\n\n/**\n * Simple wrapper around JSON.parse that casts the return value\n * to JsonObject.\n * Create a new wrapper if an array return value is desired.\n * @param {*} json JSON string to parse\n * @return {?JsonObject|undefined} May be extend to parse arrays.\n */\nfunction parseJson(json) {\n  return /** @type {?JsonObject} */ (JSON.parse(/** @type {string} */ (json)));\n}\n\n/**\n * Parses the given `json` string without throwing an exception if not valid.\n * Returns `undefined` if parsing fails.\n * Returns the `Object` corresponding to the JSON string when parsing succeeds.\n * @param {*} json JSON string to parse\n * @param {function(!Error)=} onFailed Optional function that will be called\n *     with the error if parsing fails.\n * @return {?JsonObject|undefined} May be extend to parse arrays.\n */\nfunction tryParseJson(json, onFailed) {\n  try {\n    return parseJson(json);\n  } catch (e) {\n    if (onFailed) {\n      onFailed(e);\n    }\n    return undefined;\n  }\n}\n\n/**\n * Copyright 2020 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Triple zero width space.\n *\n * This is added to user error messages, so that we can later identify\n * them, when the only thing that we have is the message. This is the\n * case in many browsers when the global exception handler is invoked.\n *\n * @const {string}\n */\nconst AMP_USER_ERROR_SENTINEL = '\\u200B\\u200B\\u200B';\n\n/**\n * Some exceptions (DOMException, namely) have read-only message.\n * @param {!Error} error\n * @return {!Error}\n */\nfunction duplicateErrorIfNecessary(error) {\n  const messageProperty = Object.getOwnPropertyDescriptor(error, 'message');\n  if (messageProperty && messageProperty.writable) {\n    return error;\n  }\n\n  const {message, stack} = error;\n  const e = new Error(message);\n  // Copy all the extraneous things we attach.\n  for (const prop in error) {\n    e[prop] = error[prop];\n  }\n  // Ensure these are copied.\n  e.stack = stack;\n  return e;\n}\n\n/**\n * @param {...*} var_args\n * @return {!Error}\n */\nfunction createErrorVargs(var_args) {\n  let error = null;\n  let message = '';\n  for (let i = 0; i < arguments.length; i++) {\n    const arg = arguments[i];\n    if (arg instanceof Error && !error) {\n      error = duplicateErrorIfNecessary(arg);\n    } else {\n      if (message) {\n        message += ' ';\n      }\n      message += arg;\n    }\n  }\n\n  if (!error) {\n    error = new Error(message);\n  } else if (message) {\n    error.message = message + ': ' + error.message;\n  }\n  return error;\n}\n\n/** Helper class for throwing standardized errors. */\nclass ErrorLogger {\n  /**\n   * Constructor.\n   *\n   * opt_suffix will be appended to error message to identify the type of the\n   * error message. We can't rely on the error object to pass along the type\n   * because some browsers do not have this param in its window.onerror API.\n   * See:\n   * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n   *\n   * @param {string=} opt_suffix\n   */\n  constructor(opt_suffix = '') {\n    /** @private @const {string} */\n    this.suffix_ = opt_suffix;\n  }\n\n  /**\n   * Modifies an error before reporting, such as to add metadata.\n   * @param {!Error} error\n   * @private\n   */\n  prepareError_(error) {\n    if (this.suffix_) {\n      if (!error.message) {\n        error.message = this.suffix_;\n      } else if (error.message.indexOf(this.suffix_) === -1) {\n        error.message = this.suffix_;\n      }\n    }\n  }\n\n  /**\n   * Creates an error.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createError(var_args) {\n    const error = createErrorVargs.apply(\n      null,\n      Array.prototype.slice.call(arguments)\n    );\n    this.prepareError_(error);\n    return error;\n  }\n\n  /**\n   * Creates an error object with its expected property set to true. Used for\n   * expected failure states (ex. incorrect configuration, localStorage\n   * unavailable due to browser settings, etc.) as opposed to unexpected\n   * breakages/failures.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createExpectedError(var_args) {\n    const error = createErrorVargs.apply(\n      null,\n      Array.prototype.slice.call(arguments)\n    );\n    this.prepareError_(error);\n    error.expected = true;\n    return error;\n  }\n\n  /**\n   * Throws an error.\n   * @param {...*} var_args\n   * @throws {!Error}\n   */\n  error(var_args) {\n    throw this.createError.apply(this, arguments);\n  }\n\n  /**\n   * Throws an error and marks with an expected property.\n   * @param {...*} var_args\n   * @throws {!Error}\n   */\n  expectedError(var_args) {\n    throw this.createExpectedError.apply(this, arguments);\n  }\n}\n\nconst userLogger = new ErrorLogger(\n  self.__AMP_TOP ? AMP_USER_ERROR_SENTINEL : ''\n);\nnew ErrorLogger();\n\nconst user = () => userLogger;\n\n/**\n * Copyright 2018 The Subscribe with Google Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst ALREADY_SEEN = '__SWG-SEEN__';\n\nconst ALLOWED_TYPES = [\n  'CreativeWork',\n  'Article',\n  'NewsArticle',\n  'Blog',\n  'Comment',\n  'Course',\n  'HowTo',\n  'Message',\n  'Review',\n  'WebPage',\n];\n\n// RegExp for quickly scanning LD+JSON for allowed types\nconst RE_ALLOWED_TYPES = new RegExp(ALLOWED_TYPES.join('|'));\n\n/**\n */\nclass PageConfigResolver {\n  /**\n   * @param {!Window|!Document|!Doc} winOrDoc\n   */\n  constructor(winOrDoc) {\n    /** @private @const {!Doc} */\n    this.doc_ = resolveDoc(winOrDoc);\n\n    /** @private {?function((!PageConfig|!Promise))} */\n    this.configResolver_ = null;\n\n    /** @private @const {!Promise<!PageConfig>} */\n    this.configPromise_ = new Promise((resolve) => {\n      this.configResolver_ = resolve;\n    });\n\n    /** @private @const {!MetaParser} */\n    this.metaParser_ = new MetaParser(this.doc_);\n    /** @private @const {!JsonLdParser} */\n    this.ldParser_ = new JsonLdParser(this.doc_);\n    /** @private @const {!MicrodataParser} */\n    this.microdataParser_ = new MicrodataParser(this.doc_);\n  }\n\n  /**\n   * @return {!Promise<!PageConfig>}\n   */\n  resolveConfig() {\n    // Try resolve the config at different times.\n    Promise.resolve().then(this.check.bind(this));\n    this.doc_.whenReady().then(this.check.bind(this));\n    return this.configPromise_;\n  }\n\n  /**\n   * @return {?PageConfig}\n   */\n  check() {\n    // Already resolved.\n    if (!this.configResolver_) {\n      return null;\n    }\n    let config = this.metaParser_.check();\n    if (!config) {\n      config = this.ldParser_.check();\n    }\n    if (!config) {\n      config = this.microdataParser_.check();\n    }\n    if (config) {\n      // Product ID has been found: initialize the rest of the config.\n      this.configResolver_(config);\n      this.configResolver_ = null;\n    } else if (this.doc_.isReady()) {\n      this.configResolver_(\n        Promise.reject(\n          user().createError('No config could be discovered in the page')\n        )\n      );\n      this.configResolver_ = null;\n    }\n    debugLog(config);\n    return config;\n  }\n}\n\nclass TypeChecker {\n  constructor() {}\n\n  /**\n   * Check value from json\n   * @param {?Array|string} value\n   * @param {Array<string>} expectedTypes\n   * @return {boolean}\n   */\n  checkValue(value, expectedTypes) {\n    if (!value) {\n      return false;\n    }\n    return this.checkArray(this.toArray_(value), expectedTypes);\n  }\n\n  /**\n   * Checks space delimited list of types\n   * @param {?string} itemtype\n   * @param {Array<string>} expectedTypes\n   * @return {boolean}\n   */\n  checkString(itemtype, expectedTypes) {\n    if (!itemtype) {\n      return false;\n    }\n    return this.checkArray(itemtype.split(/\\s+/), expectedTypes);\n  }\n\n  /**\n   * @param {Array<?string>} typeArray\n   * @param {Array<string>} expectedTypes\n   * @return {boolean}\n   */\n  checkArray(typeArray, expectedTypes) {\n    let found = false;\n    typeArray.forEach((candidateType) => {\n      found =\n        found ||\n        expectedTypes.includes(\n          candidateType.replace(/^http:\\/\\/schema.org\\//i, '')\n        );\n    });\n    return found;\n  }\n\n  /*\n   * @param {?Array|string} value\n   * @return {Array}\n   * @private\n   */\n  toArray_(value) {\n    return Array.isArray(value) ? value : [value];\n  }\n}\n\nclass MetaParser {\n  /**\n   * @param {!Doc} doc\n   */\n  constructor(doc) {\n    /** @private @const {!Doc} */\n    this.doc_ = doc;\n  }\n\n  /**\n   * @return {?PageConfig}\n   */\n  check() {\n    if (!this.doc_.getBody()) {\n      // Wait until the whole `<head>` is parsed.\n      return null;\n    }\n\n    // Try to find product id.\n    const productId = getMetaTag(\n      this.doc_.getRootNode(),\n      'subscriptions-product-id'\n    );\n    if (!productId) {\n      return null;\n    }\n\n    // Is locked?\n    const accessibleForFree = getMetaTag(\n      this.doc_.getRootNode(),\n      'subscriptions-accessible-for-free'\n    );\n    const locked = !!(\n      accessibleForFree && accessibleForFree.toLowerCase() === 'false'\n    );\n\n    return new PageConfig(productId, locked);\n  }\n}\n\nclass JsonLdParser {\n  /**\n   * @param {!Doc} doc\n   */\n  constructor(doc) {\n    /** @private @const {!Doc} */\n    this.doc_ = doc;\n    /** @private @const @function */\n    this.checkType_ = new TypeChecker();\n  }\n\n  /**\n   * @return {?PageConfig}\n   */\n  check() {\n    if (!this.doc_.getBody()) {\n      // Wait until the whole `<head>` is parsed.\n      return null;\n    }\n\n    const domReady = this.doc_.isReady();\n\n    // type: 'application/ld+json'\n    const elements = this.doc_\n      .getRootNode()\n      .querySelectorAll('script[type=\"application/ld+json\"]');\n    for (let i = 0; i < elements.length; i++) {\n      const element = elements[i];\n      if (\n        element[ALREADY_SEEN] ||\n        !element.textContent ||\n        (!domReady && !hasNextNodeInDocumentOrder(element))\n      ) {\n        continue;\n      }\n      element[ALREADY_SEEN] = true;\n      if (!RE_ALLOWED_TYPES.test(element.textContent)) {\n        continue;\n      }\n      const possibleConfig = this.tryExtractConfig_(element);\n      if (possibleConfig) {\n        return possibleConfig;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {?PageConfig}\n   */\n  tryExtractConfig_(element) {\n    let possibleConfigs = tryParseJson(element.textContent);\n    if (!possibleConfigs) {\n      return null;\n    }\n\n    // Support arrays of JSON objects.\n    if (!Array.isArray(possibleConfigs)) {\n      possibleConfigs = [possibleConfigs];\n    }\n\n    let configs = /** @type {!Array<!JsonObject>} */ (possibleConfigs);\n    for (let i = 0; i < configs.length; i++) {\n      const config = configs[i];\n\n      if (config['@graph'] && Array.isArray(config['@graph'])) {\n        configs = configs.concat(config['@graph']);\n      }\n\n      // Must be an ALLOWED_TYPE\n      if (!this.checkType_.checkValue(config['@type'], ALLOWED_TYPES)) {\n        continue;\n      }\n\n      // Must have a isPartOf[@type=Product].\n      let productId = null;\n      const partOfArray = this.valueArray_(config, 'isPartOf');\n      if (partOfArray) {\n        for (let j = 0; j < partOfArray.length; j++) {\n          productId = this.discoverProductId_(partOfArray[j]);\n          if (productId) {\n            break;\n          }\n        }\n      }\n      if (!productId) {\n        continue;\n      }\n\n      // Found product id, just check for the access flag.\n      const isAccessibleForFree = this.bool_(\n        this.singleValue_(config, 'isAccessibleForFree'),\n        /* default */ true\n      );\n\n      return new PageConfig(productId, !isAccessibleForFree);\n    }\n\n    return null;\n  }\n\n  /**\n   * @param {*} value\n   * @param {boolean} def\n   * @return {boolean}\n   */\n  bool_(value, def) {\n    if (value == null || value === '') {\n      return def;\n    }\n    if (typeof value == 'boolean') {\n      return value;\n    }\n    if (typeof value == 'string') {\n      const lowercase = value.toLowerCase();\n      if (lowercase == 'false') {\n        return false;\n      }\n      if (lowercase == 'true') {\n        return true;\n      }\n    }\n    return def;\n  }\n\n  /**\n   * @param {!Object} json\n   * @return {?string}\n   */\n  discoverProductId_(json) {\n    // Must have type `Product`.\n    if (!this.checkType_.checkValue(json['@type'], ['Product'])) {\n      return null;\n    }\n    return /** @type {?string} */ (this.singleValue_(json, 'productID'));\n  }\n\n  /**\n   * @param {!Object} json\n   * @param {string} name\n   * @return {?Array}\n   */\n  valueArray_(json, name) {\n    const value = json[name];\n    if (value == null || value === '') {\n      return null;\n    }\n    return Array.isArray(value) ? value : [value];\n  }\n\n  /**\n   * @param {!Object} json\n   * @param {string} name\n   * @return {*}\n   */\n  singleValue_(json, name) {\n    const valueArray = this.valueArray_(json, name);\n    const value = valueArray && valueArray[0];\n    return value == null || value === '' ? null : value;\n  }\n}\n\nclass MicrodataParser {\n  /**\n   * @param {!Doc} doc\n   */\n  constructor(doc) {\n    /** @private @const {!Doc} */\n    this.doc_ = doc;\n    /** @private {?boolean} */\n    this.access_ = null;\n    /** @private {?string} */\n    this.productId_ = null;\n    /** @private @const @function */\n    this.checkType_ = new TypeChecker();\n  }\n\n  /**\n   * Returns false if access is restricted, otherwise true\n   * @param {!Element} root An element that is an item of type in ALLOWED_TYPES list\n   * @return {?boolean} locked access\n   * @private\n   */\n  discoverAccess_(root) {\n    const ALREADY_SEEN = 'alreadySeenForAccessInfo';\n    const nodeList = root.querySelectorAll(\"[itemprop='isAccessibleForFree']\");\n    for (let i = 0; nodeList[i]; i++) {\n      const element = nodeList[i];\n      const content = element.getAttribute('content') || element.textContent;\n      if (!content) {\n        continue;\n      }\n      if (this.isValidElement_(element, root, ALREADY_SEEN)) {\n        let accessForFree = null;\n        if (content.toLowerCase() == 'true') {\n          accessForFree = true;\n        } else if (content.toLowerCase() == 'false') {\n          accessForFree = false;\n        }\n        return accessForFree;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Verifies if an element is valid based on the following\n   * - child of an item of one the the ALLOWED_TYPES\n   * - not a child of an item of any other type\n   * - not seen before, marked using the alreadySeen tag\n   * @param {?Element} current the element to be verified\n   * @param {!Element} root the parent to track up to\n   * @param {!string} alreadySeen used to tag already visited nodes\n   * @return {!boolean} valid node\n   * @private\n   */\n  isValidElement_(current, root, alreadySeen) {\n    for (\n      let node = current;\n      node && !node[alreadySeen];\n      node = node.parentNode\n    ) {\n      node[alreadySeen] = true;\n      // document nodes don't have hasAttribute\n      if (node.hasAttribute && node.hasAttribute('itemscope')) {\n        /**{?string} */\n        const type = node.getAttribute('itemtype');\n        return this.checkType_.checkString(type, ALLOWED_TYPES);\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Obtains the product ID that meets the requirements\n   * - child of an item of one of ALLOWED_TYPES\n   * - Not a child of an item of type 'Section'\n   * - child of an item of type 'productID'\n   * @param {!Element} root An element that is an item of an ALLOWED_TYPES\n   * @return {?string} product ID, if found\n   * @private\n   */\n  discoverProductId_(root) {\n    const ALREADY_SEEN = 'alreadySeenForProductInfo';\n    const nodeList = root.querySelectorAll('[itemprop=\"productID\"]');\n    for (let i = 0; nodeList[i]; i++) {\n      const element = nodeList[i];\n      const content = element.getAttribute('content') || element.textContent;\n      const item = element.closest('[itemtype][itemscope]');\n      const type = item.getAttribute('itemtype');\n      if (type.indexOf('http://schema.org/Product') <= -1) {\n        continue;\n      }\n      if (this.isValidElement_(item.parentElement, root, ALREADY_SEEN)) {\n        return content;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Returns PageConfig if available\n   * @return {?PageConfig} PageConfig found so far\n   */\n  getPageConfig_() {\n    let locked = null;\n    if (this.access_ != null) {\n      locked = !this.access_;\n    } else if (this.doc_.isReady()) {\n      // Default to unlocked\n      locked = false;\n    }\n    if (this.productId_ != null && locked != null) {\n      return new PageConfig(this.productId_, locked);\n    }\n    return null;\n  }\n\n  /**\n   * Extracts page config from Microdata in the DOM\n   * @return {?PageConfig} PageConfig found\n   */\n  tryExtractConfig_() {\n    let config = this.getPageConfig_();\n    if (config) {\n      return config;\n    }\n\n    // Grab all the nodes with an itemtype and filter for our allowed types\n    const nodeList = Array.prototype.slice\n      .call(this.doc_.getRootNode().querySelectorAll('[itemscope][itemtype]'))\n      .filter((node) =>\n        this.checkType_.checkString(\n          node.getAttribute('itemtype'),\n          ALLOWED_TYPES\n        )\n      );\n\n    for (let i = 0; nodeList[i] && config == null; i++) {\n      const element = nodeList[i];\n      if (this.access_ == null) {\n        this.access_ = this.discoverAccess_(element);\n      }\n      if (!this.productId_) {\n        this.productId_ = this.discoverProductId_(element);\n      }\n      config = this.getPageConfig_();\n    }\n    return config;\n  }\n\n  /**\n   * @return {?PageConfig}\n   */\n  check() {\n    if (!this.doc_.getBody()) {\n      // Wait until the whole `<head>` is parsed.\n      return null;\n    }\n    return this.tryExtractConfig_();\n  }\n}\n\n/**\n * Returns the value from content attribute of a meta tag with given name.\n *\n * If multiple tags are found, the first value is returned.\n *\n * @param {!Node} rootNode\n * @param {string} name The tag name to look for.\n * @return {?string} attribute value or empty string.\n * @private\n */\nfunction getMetaTag(rootNode, name) {\n  const el = rootNode.querySelector(`meta[name=\"${name}\"]`);\n  if (el) {\n    return el.getAttribute('content');\n  }\n  return null;\n}\n\nexport { Doc, PageConfig, PageConfigResolver };\n", "import {Doc} from '#third_party/subscriptions-project/config';\nimport {Services} from '#service';\nimport {dev} from '#utils/log';\n\n/**\n * Adopts config document to ampdoc.\n * @implements {Doc}\n */\nexport class DocImpl {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @private @const {!../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    /** @private {!../../../src/service/viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = Services.viewportForDoc(this.ampdoc_);\n  }\n\n  /** @override */\n  getWin() {\n    return this.ampdoc_.win;\n  }\n\n  /** @override */\n  getRootNode() {\n    return this.ampdoc_.getRootNode();\n  }\n\n  /** @override */\n  getRootElement() {\n    const root = this.ampdoc_.getRootNode();\n    return dev().assertElement(root.documentElement || root.body || root);\n  }\n\n  /** @override */\n  getHead() {\n    return dev().assertElement(this.ampdoc_.getHeadNode());\n  }\n\n  /** @override */\n  getBody() {\n    return this.ampdoc_.isBodyAvailable() ? this.ampdoc_.getBody() : null;\n  }\n\n  /** @override */\n  isReady() {\n    return this.ampdoc_.isReady();\n  }\n\n  /** @override */\n  whenReady() {\n    return this.ampdoc_.whenReady();\n  }\n\n  /** @override */\n  addToFixedLayer(element) {\n    return this.viewport_.addToFixedLayer(element, /* Force Transfer */ true);\n  }\n}\n\n/**\n * @package Visible for testing only.\n * @return {typeof Doc}\n */\nexport function getDocClassForTesting() {\n  return Doc;\n}\n", "import {dict} from '#core/types/object';\n\n/** @enum {string} */\nexport const GrantReason = {\n  'SUBSCRIBER': 'SUBSCRIBER',\n  'METERING': 'METERING',\n  'FREE': 'UNLOCKED',\n  'LAA': 'LAA',\n};\n\n/**\n * The constructor arg for an {@link Entitlement}\n *\n * @typedef {{\n *   source: string,\n *   raw: string,\n *   service: string,\n *   granted: boolean,\n *   grantReason: ?GrantReason,\n *   dataObject: ?JsonObject,\n *   decryptedDocumentKey: ?string\n * }} EntitlementConstructorInputDef\n */\n\n/**\n * The single entitlement object.\n */\nexport class Entitlement {\n  /**\n   * @param {string} service\n   * @return {!Entitlement}\n   */\n  static empty(service) {\n    return new Entitlement({\n      source: '',\n      raw: '',\n      service,\n      granted: false,\n    });\n  }\n\n  /**\n   * @param {!EntitlementConstructorInputDef} input\n   */\n  constructor(input) {\n    const {\n      dataObject,\n      decryptedDocumentKey,\n      grantReason = '',\n      granted = false,\n      raw = '',\n      service,\n      source,\n    } = input;\n    /** @const {string} */\n    this.raw = raw;\n    /** @const {string} */\n    this.source = source;\n    /** @type {string} */\n    this.service = service;\n    /** @const {boolean} */\n    this.granted = granted;\n    /** @const {?string} */\n    this.grantReason = grantReason;\n    /** @const {?JsonObject} */\n    this.data = dataObject;\n    /** @const {?string} */\n    this.decryptedDocumentKey = decryptedDocumentKey;\n  }\n\n  /**\n   * Returns json format of entitlements\n   * @return {!JsonObject}\n   */\n  json() {\n    const entitlementJson = dict({\n      'source': this.source,\n      'service': this.service,\n      'granted': this.granted,\n      'grantReason': this.grantReason,\n      'data': this.data,\n    });\n    return entitlementJson;\n  }\n\n  /**\n   * Returns json to be used for pingback.\n   *\n   * @return {!JsonObject}\n   */\n  jsonForPingback() {\n    return /** @type {!JsonObject} */ ({'raw': this.raw, ...this.json()});\n  }\n\n  /**\n   * @param {?JsonObject} json\n   * @param {?string} rawData\n   * @return {!Entitlement}\n   */\n  static parseFromJson(json, rawData = null) {\n    if (!json) {\n      json = dict();\n    }\n    const raw = rawData || JSON.stringify(json);\n    const source = json['source'] || '';\n    const granted = json['granted'] || false;\n    const grantReason = json['grantReason'];\n    const dataObject = json['data'] || null;\n    const decryptedDocumentKey = json['decryptedDocumentKey'] || null;\n    return new Entitlement({\n      source,\n      raw,\n      service: '',\n      granted,\n      grantReason,\n      dataObject,\n      decryptedDocumentKey,\n    });\n  }\n\n  /**\n   * Returns true if the user is a subscriber.\n   * @return {boolean}\n   */\n  isSubscriber() {\n    return this.granted && this.grantReason === GrantReason.SUBSCRIBER;\n  }\n\n  /**\n   * Returns true if the article is free.\n   * @return {boolean}\n   */\n  isFree() {\n    return this.granted && this.grantReason === GrantReason.FREE;\n  }\n}\n", "import {Services} from '#service';\nimport {getValueForExpr} from '#core/types/object';\n\nexport class UrlBuilder {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {!Promise<string>} readerIdPromise\n   */\n  constructor(ampdoc, readerIdPromise) {\n    const headNode = ampdoc.getHeadNode();\n\n    /** @private @const {!../../../src/service/url-replacements-impl.UrlReplacements} */\n    this.urlReplacements_ = Services.urlReplacementsForDoc(headNode);\n\n    /** @private @const {!Promise<string>} */\n    this.readerIdPromise_ = readerIdPromise;\n\n    /** @private {?JsonObject} */\n    this.authResponse_ = null;\n  }\n\n  /**\n   * @param {!JsonObject} authResponse\n   */\n  setAuthResponse(authResponse) {\n    this.authResponse_ = authResponse;\n  }\n\n  /**\n   * @param {string} url\n   * @param {boolean} useAuthData Allows `AUTH(field)` URL var substitutions.\n   * @return {!Promise<string>}\n   */\n  buildUrl(url, useAuthData) {\n    return this.prepareUrlVars_(useAuthData).then((vars) => {\n      return this.urlReplacements_.expandUrlAsync(url, vars);\n    });\n  }\n\n  /**\n   * @param {string} url\n   * @param {boolean} useAuthData Allows `AUTH(field)` URL var substitutions.\n   * @return {!Promise<!Object<string, *>>}\n   */\n  collectUrlVars(url, useAuthData) {\n    return this.prepareUrlVars_(useAuthData).then((vars) => {\n      return this.urlReplacements_.collectVars(url, vars);\n    });\n  }\n\n  /**\n   * @param {boolean} useAuthData Allows `AUTH(field)` URL var substitutions.\n   * @return {!Promise<!Object<string, *>>}\n   * @private\n   */\n  prepareUrlVars_(useAuthData) {\n    return this.readerIdPromise_.then((readerId) => {\n      const vars = {\n        'READER_ID': readerId,\n        'ACCESS_READER_ID': readerId, // A synonym.\n      };\n      if (useAuthData) {\n        vars['AUTHDATA'] = (field) => {\n          if (this.authResponse_) {\n            return getValueForExpr(this.authResponse_, field);\n          }\n          return undefined;\n        };\n      }\n      return vars;\n    });\n  }\n}\n", "import {getValueForExpr} from '#core/types/object';\nimport {parseQueryString} from '#core/types/string/url';\nimport {WindowInterface} from '#core/window/interface';\n\nimport {experimentToggles, isExperimentOn} from '#experiments';\n\nimport {Services} from '#service';\n\nimport {getData} from '#utils/event-helper';\nimport {devAssert, user, userAssert} from '#utils/log';\n\nimport {\n  AnalyticsEvent,\n  ConfiguredRuntime,\n  EventOriginator,\n  Fetcher as FetcherInterface,\n  FilterResult,\n  SubscribeResponse as SubscribeResponseInterface,\n} from '#third_party/subscriptions-project/swg';\nimport {GaaMeteringRegwall} from '#third_party/subscriptions-project/swg-gaa';\n\nimport {CSS} from '../../../build/amp-subscriptions-google-0.1.css';\nimport {getMode} from '../../../src/mode';\nimport {installStylesForDoc} from '../../../src/style-installer';\nimport {assertHttpsUrl, parseUrlDeprecated} from '../../../src/url';\nimport {\n  Action,\n  ActionStatus,\n  SubscriptionAnalyticsEvents,\n} from '../../amp-subscriptions/0.1/analytics';\nimport {SubscriptionsScoreFactor} from '../../amp-subscriptions/0.1/constants';\nimport {DocImpl} from '../../amp-subscriptions/0.1/doc-impl';\nimport {\n  Entitlement,\n  GrantReason,\n} from '../../amp-subscriptions/0.1/entitlement';\nimport {UrlBuilder} from '../../amp-subscriptions/0.1/url-builder';\n\nconst TAG = 'amp-subscriptions-google';\nconst PLATFORM_KEY = 'subscribe.google.com';\nconst GOOGLE_DOMAIN_RE = /(^|\\.)google\\.(com?|[a-z]{2}|com?\\.[a-z]{2}|cat)$/;\n\n/** @enum {number} */\nconst ShowcaseStrategy = {\n  NONE: 1,\n  LEAD_ARTICLE: 2,\n  EXTENDED_ACCESS: 3,\n};\n\n/** @const */\nconst SERVICE_TIMEOUT = 3000;\n\nconst SWG_EVENTS_TO_SUPPRESS = {\n  [AnalyticsEvent.IMPRESSION_PAYWALL]: true,\n  [AnalyticsEvent.IMPRESSION_PAGE_LOAD]: true,\n};\n\nconst AMP_EVENT_TO_SWG_EVENT = {\n  [SubscriptionAnalyticsEvents.PAYWALL_ACTIVATED]:\n    AnalyticsEvent.IMPRESSION_PAYWALL,\n};\n\nconst AMP_ACTION_TO_SWG_EVENT = {\n  [Action.SHOW_OFFERS]: {\n    [ActionStatus.STARTED]: null, //ex: AnalyticsEvent.IMPRESSION_OFFERS\n  },\n};\n\n/**\n */\nexport class GoogleSubscriptionsPlatformService {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @private {!../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n  }\n\n  /**\n   * @param {!JsonObject} platformConfig\n   * @param {!../../amp-subscriptions/0.1/service-adapter.ServiceAdapter} serviceAdapter\n   * @return {!GoogleSubscriptionsPlatform}\n   */\n  createPlatform(platformConfig, serviceAdapter) {\n    return new GoogleSubscriptionsPlatform(\n      this.ampdoc_,\n      platformConfig,\n      serviceAdapter\n    );\n  }\n}\n\n/**\n * @implements {../../amp-subscriptions/0.1/subscription-platform.SubscriptionPlatform}\n */\nexport class GoogleSubscriptionsPlatform {\n  /**\n   * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {!JsonObject} platformConfig\n   * @param {!../../amp-subscriptions/0.1/service-adapter.ServiceAdapter} serviceAdapter\n   */\n  constructor(ampdoc, platformConfig, serviceAdapter) {\n    /**\n     * @private @const\n     * {!../../amp-subscriptions/0.1/service-adapter.ServiceAdapter}\n     */\n    this.serviceAdapter_ = serviceAdapter;\n\n    /** @private {!../../../src/service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    /** @private @const {!../../../src/service/vsync-impl.Vsync} */\n    this.vsync_ = Services.vsyncFor(ampdoc.win);\n\n    /** @private @const {boolean} */\n    this.isDev_ = getMode().development || getMode().localDev;\n\n    /**\n     * @private @const\n     * {!../../amp-subscriptions/0.1/analytics.SubscriptionAnalytics}\n     */\n    this.subscriptionAnalytics_ = serviceAdapter.getAnalytics();\n    this.subscriptionAnalytics_.registerEventListener(\n      this.handleAnalyticsEvent_.bind(this)\n    );\n\n    /** @private @const {!UrlBuilder} */\n    this.urlBuilder_ = new UrlBuilder(\n      this.ampdoc_,\n      this.serviceAdapter_.getReaderId('local')\n    );\n\n    /** @const @private {!../../../src/service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(this.ampdoc_.win);\n\n    //* @const @private */\n    this.fetcher_ = new AmpFetcher(ampdoc.win);\n\n    // Map AMP experiments prefixed with 'swg-' to SwG experiments.\n    const ampExperimentsForSwg = Object.keys(experimentToggles(ampdoc.win))\n      .filter(\n        (exp) =>\n          exp.startsWith('swg-') && isExperimentOn(ampdoc.win, /*OK*/ exp)\n      )\n      .map((exp) => exp.substring(4));\n\n    const swgConfig = {'experiments': ampExperimentsForSwg};\n    let resolver = null;\n    /** @private @const {!ConfiguredRuntime} */\n    this.runtime_ = new ConfiguredRuntime(\n      new DocImpl(ampdoc),\n      serviceAdapter.getPageConfig(),\n      {\n        fetcher: new AmpFetcher(ampdoc.win),\n        configPromise: new Promise((resolve) => (resolver = resolve)),\n      },\n      swgConfig\n    );\n\n    /** @private @const {!../../../third_party/subscriptions-project/swg.ClientEventManagerApi} */\n    this.eventManager_ = this.runtime_.eventManager();\n    this.eventManager_.registerEventFilterer(\n      GoogleSubscriptionsPlatform.filterSwgEvent_\n    );\n    this.eventManager_.logEvent({\n      eventType: AnalyticsEvent.IMPRESSION_PAGE_LOAD,\n      eventOriginator: EventOriginator.AMP_CLIENT,\n      isFromUserAction: false,\n      additionalParameters: null,\n    });\n    this.runtime_.analytics().setUrl(ampdoc.getUrl());\n    resolver();\n\n    this.runtime_.setOnLoginRequest((request) => {\n      this.onLoginRequest_(request && request.linkRequested);\n    });\n    this.runtime_.setOnLinkComplete(() => {\n      this.onLinkComplete_();\n      this.subscriptionAnalytics_.actionEvent(\n        this.getPlatformKey(),\n        Action.LINK,\n        ActionStatus.SUCCESS\n      );\n      // TODO(dvoytenko): deprecate separate \"link\" events.\n      this.subscriptionAnalytics_.serviceEvent(\n        SubscriptionAnalyticsEvents.LINK_COMPLETE,\n        this.getPlatformKey()\n      );\n    });\n    this.runtime_.setOnFlowStarted((e) => {\n      // This information is used by Propensity.\n      const params = /** @type {!JsonObject} */ ({});\n      const data = /** @type {!JsonObject} */ (getData(e) || {});\n      switch (e.flow) {\n        case Action.SUBSCRIBE:\n          params['product'] =\n            data['skuId'] || data['product'] || 'unknown productId';\n          params['active'] = true;\n          break;\n        case Action.SHOW_OFFERS:\n          params['skus'] = data['skus'] || '*';\n          params['source'] = data['source'] || 'unknown triggering source';\n          params['active'] = data['active'] || null;\n          break;\n      }\n      if (\n        e.flow == Action.SUBSCRIBE ||\n        e.flow == Action.CONTRIBUTE ||\n        e.flow == Action.SHOW_CONTRIBUTION_OPTIONS ||\n        e.flow == Action.SHOW_OFFERS\n      ) {\n        this.subscriptionAnalytics_.actionEvent(\n          this.getPlatformKey(),\n          e.flow,\n          ActionStatus.STARTED,\n          params\n        );\n      }\n    });\n    this.runtime_.setOnFlowCanceled((e) => {\n      if (e.flow == 'linkAccount') {\n        this.onLinkComplete_();\n        this.subscriptionAnalytics_.actionEvent(\n          this.getPlatformKey(),\n          Action.LINK,\n          ActionStatus.REJECTED\n        );\n        // TODO(dvoytenko): deprecate separate \"link\" events.\n        this.subscriptionAnalytics_.serviceEvent(\n          SubscriptionAnalyticsEvents.LINK_CANCELED,\n          this.getPlatformKey()\n        );\n      } else if (\n        e.flow == Action.SUBSCRIBE ||\n        e.flow == Action.CONTRIBUTE ||\n        e.flow == Action.SHOW_CONTRIBUTION_OPTIONS ||\n        e.flow == Action.SHOW_OFFERS\n      ) {\n        this.subscriptionAnalytics_.actionEvent(\n          this.getPlatformKey(),\n          e.flow,\n          ActionStatus.REJECTED\n        );\n      }\n    });\n    this.runtime_.setOnNativeSubscribeRequest(() => {\n      this.onNativeSubscribeRequest_();\n    });\n    this.runtime_.setOnPaymentResponse((promise) => {\n      promise.then((response) => {\n        this.onSubscribeResponse_(\n          response,\n          response.productType === 'CONTRIBUTION'\n            ? Action.CONTRIBUTE\n            : Action.SUBSCRIBE\n        );\n      });\n    });\n\n    /** @const @private {!JsonObject} */\n    this.serviceConfig_ = platformConfig;\n\n    /** @private viewer */\n    this.viewerPromise_ = Services.viewerForDoc(ampdoc);\n\n    /** @private {boolean} */\n    this.isGoogleViewer_ = false;\n    this.resolveGoogleViewer_(this.viewerPromise_);\n\n    /** @private {boolean} */\n    this.isReadyToPay_ = false;\n\n    // Install styles.\n    installStylesForDoc(ampdoc, CSS, () => {}, false, TAG);\n\n    /** @private @const {boolean} */\n    this.enableMetering_ = !!this.serviceConfig_['enableMetering'];\n\n    /** @private @const {boolean} */\n    this.enableLAA_ = !!this.serviceConfig_['enableLAA'];\n\n    /**\n     * Allows publishers to turn off SwG entitlement checks.\n     * Some publishers just use LAA entitlements.\n     * SwG entitlement checks are enabled by default, for backward compatibility.\n     * @private @const {boolean}\n     */\n    this.enableEntitlements_ =\n      this.serviceConfig_['enableEntitlements'] === false ? false : true;\n\n    userAssert(\n      !(this.enableLAA_ && this.enableMetering_),\n      'enableLAA and enableMetering are mutually exclusive.'\n    );\n\n    /** @private @const {string} */\n    this.skuMapUrl_ = this.serviceConfig_['skuMapUrl'] || null;\n\n    /** @private {JsonObject} */\n    this.skuMap_ = /** @type {!JsonObject} */ ({});\n\n    /** @private {!Promise} */\n    this.rtcPromise_ = this.maybeFetchRealTimeConfig();\n  }\n\n  /**\n   * Determines whether an event manager event should be canceled.\n   * @param {!../../../third_party/subscriptions-project/swg.ClientEvent} event\n   */\n  static filterSwgEvent_(event) {\n    if (event.eventOriginator !== EventOriginator.SWG_CLIENT) {\n      return FilterResult.PROCESS_EVENT;\n    }\n    return SWG_EVENTS_TO_SUPPRESS[event.eventType]\n      ? FilterResult.CANCEL_EVENT\n      : FilterResult.PROCESS_EVENT;\n  }\n\n  /**\n   * Listens for events from analytics and transmits them to the SwG event\n   * manager if appropriate.\n   * @param {!SubscriptionAnalyticsEvents|string} event\n   * @param {!JsonObject} optVarsUnused\n   * @param {!JsonObject} internalVars\n   */\n  handleAnalyticsEvent_(event, optVarsUnused, internalVars) {\n    let eventType = null;\n    const action = internalVars['action'];\n    const status = internalVars['status'];\n\n    if (AMP_EVENT_TO_SWG_EVENT[event]) {\n      eventType = AMP_EVENT_TO_SWG_EVENT[event];\n    } else if (action && AMP_ACTION_TO_SWG_EVENT[action]) {\n      eventType = AMP_ACTION_TO_SWG_EVENT[action][status];\n    }\n\n    if (!eventType) {\n      return;\n    }\n\n    this.eventManager_.logEvent({\n      eventType,\n      eventOriginator: EventOriginator.AMP_CLIENT,\n      isFromUserAction: null,\n      additionalParameters: null,\n    });\n  }\n\n  /**\n   * @param {boolean} linkRequested\n   * @private\n   */\n  onLoginRequest_(linkRequested) {\n    if (linkRequested && this.isGoogleViewer_) {\n      this.loginWithAmpReaderId_();\n      this.subscriptionAnalytics_.actionEvent(\n        this.getPlatformKey(),\n        Action.LINK,\n        ActionStatus.STARTED\n      );\n      // TODO(dvoytenko): deprecate separate \"link\" events.\n      this.subscriptionAnalytics_.serviceEvent(\n        SubscriptionAnalyticsEvents.LINK_REQUESTED,\n        this.getPlatformKey()\n      );\n    } else {\n      this.maybeComplete_(\n        this.serviceAdapter_.delegateActionToLocal('login', null)\n      );\n    }\n  }\n\n  /**\n   * Kicks off login flow for account linking, and passes AMP Reader ID to authorization URL.\n   * @private\n   */\n  loginWithAmpReaderId_() {\n    // Get local AMP reader ID, to match the ID sent to local entitlement endpoints.\n    this.serviceAdapter_.getReaderId('local').then((ampReaderId) => {\n      this.runtime_.linkAccount({ampReaderId});\n    });\n  }\n\n  /** @private */\n  onLinkComplete_() {\n    this.serviceAdapter_.resetPlatforms();\n  }\n\n  /* TODO(jpettitt): should local suppoort 'contribute' action? */\n  /** @private */\n  onNativeSubscribeRequest_() {\n    this.maybeComplete_(\n      this.serviceAdapter_.delegateActionToLocal(Action.SUBSCRIBE, null)\n    );\n  }\n\n  /**\n   * @param {!Promise<boolean>} promise\n   * @private\n   */\n  maybeComplete_(promise) {\n    promise.then((result) => {\n      if (result) {\n        this.runtime_.reset();\n      }\n    });\n  }\n\n  /**\n   * Fetch a real time config if appropriate.\n   *\n   * Note that we don't return the skuMap, instead we save it.\n   * The creates an intentional race condition.  If the server\n   * doesn't return a skuMap before the user clicks the subscribe button\n   * the button wil lbe disabled.\n   *\n   * We can't wait for the skumap in the button click becasue it will be popup blocked.\n   *\n   * @return {!Promise}\n   */\n  maybeFetchRealTimeConfig() {\n    let timeout = SERVICE_TIMEOUT;\n    if (this.isDev_) {\n      timeout = SERVICE_TIMEOUT * 2;\n    }\n\n    if (!this.skuMapUrl_) {\n      return Promise.resolve();\n    }\n\n    assertHttpsUrl(this.skuMapUrl_, 'skuMapUrl must be valid https Url');\n    // RTC is never pre-render safe\n    return this.ampdoc_\n      .whenFirstVisible()\n      .then(() =>\n        this.urlBuilder_.buildUrl(\n          /**  @type {string } */ (this.skuMapUrl_),\n          /* useAuthData */ false\n        )\n      )\n      .then((url) =>\n        this.timer_.timeoutPromise(\n          timeout,\n          this.fetcher_.fetchCredentialedJson(url)\n        )\n      )\n      .then((resJson) => {\n        userAssert(\n          resJson['subscribe.google.com'],\n          'skuMap does not contain subscribe.google.com section'\n        );\n        this.skuMap_ = resJson['subscribe.google.com'];\n      })\n      .catch((reason) => {\n        throw user().createError(\n          `fetch skuMap failed for ${PLATFORM_KEY}`,\n          reason\n        );\n      });\n  }\n\n  /**\n   * @param {!SubscribeResponseInterface} response\n   * @param {string} eventType\n   * @private\n   */\n  onSubscribeResponse_(response, eventType) {\n    response.complete().then(() => {\n      this.serviceAdapter_.resetPlatforms();\n    });\n    let product;\n    try {\n      const entitlement =\n        response.entitlements && response.entitlements.getEntitlementForThis();\n      if (entitlement) {\n        product = entitlement.getSku();\n      }\n    } catch (ex) {}\n    const params = /** @type {!JsonObject} */ ({\n      'active': true,\n      'product': product || 'unknown subscriptionToken',\n    });\n\n    this.subscriptionAnalytics_.actionEvent(\n      this.getPlatformKey(),\n      eventType,\n      ActionStatus.SUCCESS,\n      params\n    );\n  }\n\n  /**\n   * Returns URL params - in its own method so we can stub it for testing.\n   * @return {Object<string>}\n   * @private\n   */\n  getUrlParams_() {\n    return parseQueryString(this.ampdoc_.win.location.search);\n  }\n\n  /**\n   * Returns a LAA entitlement for this article, if it's appropriate.\n   * @return {!Promise<?Entitlement>}\n   * @private\n   */\n  maybeGetLAAEntitlement_() {\n    return this.getShowcaseStrategy_().then((strategy) => {\n      // Verify Google's Showcase strategy for this article.\n      if (strategy !== ShowcaseStrategy.LEAD_ARTICLE) {\n        return null;\n      }\n\n      // All the criteria are met to return an LAA entitlement\n      return new Entitlement({\n        source: 'google:laa',\n        raw: '',\n        service: PLATFORM_KEY,\n        granted: true,\n        grantReason: GrantReason.LAA,\n        dataObject: {},\n        decryptedDocumentKey: null,\n      });\n    });\n  }\n\n  /**\n   * Returns Google's Showcase strategy for this article.\n   * @private\n   * @return {!Promise<!ShowcaseStrategy>}\n   */\n  getShowcaseStrategy_() {\n    // Verify the service config enables a Google Showcase strategy.\n    if (!this.enableLAA_ && !this.enableMetering_) {\n      return Promise.resolve(ShowcaseStrategy.NONE);\n    }\n\n    return this.viewerPromise_.getReferrerUrl().then((referrer) => {\n      // Check referrer.\n      const parsedReferrer = parseUrlDeprecated(referrer);\n      if (\n        (parsedReferrer.protocol !== 'https:' ||\n          !GOOGLE_DOMAIN_RE.test(parsedReferrer.hostname)) &&\n        // Note we don't use the more generic this.isDev_ flag because that can be\n        // triggered by a hash value which would allow non google hostnames to\n        // construct LAA urls.\n        !getMode(this.ampdoc_.win).localDev\n      ) {\n        return ShowcaseStrategy.NONE;\n      }\n\n      // Parse URL params.\n      const urlParams = this.getUrlParams_();\n\n      // Verify timestamp.\n      if (parseInt(urlParams[`gaa_ts`], 16) < Date.now() / 1000) {\n        return ShowcaseStrategy.NONE;\n      }\n\n      // Verify a few params exist.\n      if (!urlParams[`gaa_n`] || !urlParams[`gaa_sig`]) {\n        return ShowcaseStrategy.NONE;\n      }\n\n      // Determine Google's Showcase strategy.\n      if (urlParams[`gaa_at`] === 'la' && this.enableLAA_) {\n        return ShowcaseStrategy.LEAD_ARTICLE;\n      } else if (\n        (urlParams[`gaa_at`] === 'la' || urlParams[`gaa_at`] === 'g') &&\n        this.enableMetering_\n      ) {\n        return ShowcaseStrategy.EXTENDED_ACCESS;\n      } else {\n        return ShowcaseStrategy.NONE;\n      }\n    });\n  }\n\n  /** @override */\n  isPrerenderSafe() {\n    /**\n     * If it's a google viewer then calling google for an\n     * entitlement at prerender time does not leak any private\n     * information.  If it's not a google viewer then we wait\n     * for the page to be visible to avoid leaking that the\n     * page was prerendered.\n     *\n     * If this article enables Showcase metering, then it's not prerender safe.\n     * This extension could load a publisher URL to render a Google Sign-In button.\n     */\n    return this.isGoogleViewer_ && !this.enableMetering_;\n  }\n\n  /** @override */\n  getEntitlements() {\n    const encryptedDocumentKey =\n      this.serviceAdapter_.getEncryptedDocumentKey('google.com');\n    userAssert(\n      !(this.enableLAA_ && encryptedDocumentKey),\n      `enableLAA cannot be used when the document is encrypted`\n    );\n\n    return this.maybeGetLAAEntitlement_().then((laaEntitlement) => {\n      if (laaEntitlement) {\n        return laaEntitlement;\n      }\n\n      // Allow publishers to disable SwG entitlement checks.\n      // Some publishers just want LAA entitlements.\n      if (!this.enableEntitlements_) {\n        return null;\n      }\n\n      const showcaseStrategyPromise = this.getShowcaseStrategy_();\n      const meteringStatePromise = this.serviceAdapter_.loadMeteringState();\n      const promises = Promise.all([\n        showcaseStrategyPromise,\n        meteringStatePromise,\n      ]);\n\n      return promises.then((results) => {\n        const showcaseStrategy = results[0];\n        const meteringState = results[1];\n\n        const entitlementsParams = {};\n\n        // Add encryption param.\n        if (encryptedDocumentKey) {\n          entitlementsParams.encryption = {encryptedDocumentKey};\n        }\n\n        // Add metering param.\n        if (\n          showcaseStrategy === ShowcaseStrategy.EXTENDED_ACCESS &&\n          meteringState\n        ) {\n          // Make sure SwG sends a fresh request, instead of using cache.\n          this.runtime_.clear();\n\n          entitlementsParams.metering = {state: meteringState};\n\n          // Remember we requested metering entitlements.\n          // This helps avoid redundant fetches for metering entitlements.\n          this.serviceAdapter_.rememberMeteringEntitlementsWereFetched();\n        }\n\n        return this.runtime_\n          .getEntitlements(entitlementsParams)\n          .then((swgEntitlements) =>\n            this.createAmpEntitlement(swgEntitlements)\n          );\n      });\n    });\n  }\n\n  /**\n   * Returns an AMP entitlement based on SwG entitlements.\n   * @param {!Entitlements} swgEntitlements\n   * @return {Entitlement}\n   */\n  createAmpEntitlement(swgEntitlements) {\n    // Get and store the isReadyToPay signal which is independent of\n    // any entitlments existing.\n    if (swgEntitlements.isReadyToPay) {\n      this.isReadyToPay_ = true;\n    }\n\n    let swgEntitlement = swgEntitlements.getEntitlementForThis();\n    let granted = false;\n    if (swgEntitlement && swgEntitlement.source) {\n      granted = true;\n    } else if (\n      swgEntitlements.entitlements.length &&\n      swgEntitlements.entitlements[0].products.length\n    ) {\n      // We didn't find a grant so see if there is a non granting\n      // and return that. Note if we start returning multiple non\n      // granting we'll need to refactor to handle returning an\n      // array of Entitlement objects.\n      // #TODO(jpettitt) - refactor to handle multi entitlement case\n      swgEntitlement = swgEntitlements.entitlements[0];\n    } else {\n      return null;\n    }\n    swgEntitlements.ack();\n\n    // Determine grant reason.\n    let grantReason;\n    if (granted) {\n      if (swgEntitlement.source === 'google:metering') {\n        grantReason = GrantReason.METERING;\n      } else {\n        grantReason = GrantReason.SUBSCRIBER;\n      }\n    } else {\n      grantReason = null;\n    }\n\n    return new Entitlement({\n      source: swgEntitlement.source,\n      raw: swgEntitlements.raw,\n      service: PLATFORM_KEY,\n      granted,\n      // if it's granted it must be a subscriber\n      grantReason,\n      dataObject: swgEntitlement.json(),\n      decryptedDocumentKey: swgEntitlements.decryptedDocumentKey,\n    });\n  }\n\n  /** @override */\n  getPlatformKey() {\n    return PLATFORM_KEY;\n  }\n\n  /** @override */\n  activate(entitlement, grantEntitlement, continueAuthorizationFlow) {\n    const best = grantEntitlement || entitlement;\n\n    const showcaseStrategyPromise = this.getShowcaseStrategy_();\n    const meteringStatePromise = this.serviceAdapter_.loadMeteringState();\n    const promises = Promise.all([\n      showcaseStrategyPromise,\n      meteringStatePromise,\n    ]);\n\n    promises.then((results) => {\n      const showcaseStrategy = results[0];\n      const meteringState = results[1];\n\n      if (showcaseStrategy === ShowcaseStrategy.EXTENDED_ACCESS) {\n        // Show the Regwall, so the user can get\n        // a metering state that leads to a\n        // granting entitlement.\n        // After the Regwall flow completes, then continue authorization flow.\n        if (!best.granted && !meteringState) {\n          this.showMeteringRegwall_().then(continueAuthorizationFlow);\n          return;\n        }\n\n        // Consume the metering entitlement.\n        if (best.granted && !best.isSubscriber()) {\n          this.runtime_.consumeShowcaseEntitlementJwt(\n            best.raw,\n            continueAuthorizationFlow\n          );\n          return;\n        }\n      }\n\n      // Offers or abbreviated offers may need to be shown depending on\n      // whether the access has been granted and whether user is a subscriber.\n      if (!best.granted) {\n        this.runtime_.showOffers({list: 'amp'});\n      } else if (!best.isSubscriber()) {\n        this.runtime_.showAbbrvOffer({list: 'amp'});\n      }\n    });\n  }\n\n  /**\n   * Asks user to register an account with the publisher.\n   * Returns a promise that resolves when the process completes.\n   * @return {!Promise}\n   */\n  showMeteringRegwall_() {\n    // Show the Showcase Regwall.\n    const googleSignInDetailsPromise = GaaMeteringRegwall.show({\n      // Specify a URL that renders a Google Sign-In button.\n      iframeUrl: this.serviceConfig_['googleSignInHelperUrl'],\n    });\n    const ampReaderIdPromise = this.serviceAdapter_.getReaderId('local');\n\n    // Register the user with the publisher.\n    const registerUserPromise = Promise.all([\n      googleSignInDetailsPromise,\n      ampReaderIdPromise,\n    ]).then((results) => {\n      const googleSignInDetails = results[0];\n      const ampReaderId = results[1];\n\n      const url = this.serviceConfig_['extendedAccessRegistrationUrl'];\n      const postBody = {\n        googleSignInDetails,\n        ampReaderId,\n      };\n\n      return this.fetcher_.sendPostToPublisher(url, postBody);\n    });\n\n    // The publisher responds with a metering state.\n    // Let's save it.\n    const saveMeteringStatePromise = registerUserPromise.then(\n      (publisherResponse) => {\n        const meteringState =\n          publisherResponse &&\n          publisherResponse['metering'] &&\n          publisherResponse['metering']['state'];\n\n        return this.serviceAdapter_.saveMeteringState(meteringState);\n      }\n    );\n\n    // That's all.\n    return saveMeteringStatePromise;\n  }\n\n  /** @override */\n  reset() {\n    this.runtime_.reset();\n  }\n\n  /**\n   * Returns if pingback is enabled for this platform\n   * @return {boolean}\n   */\n  isPingbackEnabled() {\n    return false;\n  }\n\n  /** @override */\n  pingbackReturnsAllEntitlements() {\n    return false;\n  }\n\n  /**\n   * Performs the pingback to the subscription platform\n   */\n  pingback() {}\n\n  /** @override */\n  getSupportedScoreFactor(factorName) {\n    switch (factorName) {\n      case SubscriptionsScoreFactor.SUPPORTS_VIEWER:\n        return this.isGoogleViewer_ ? 1 : 0;\n      case SubscriptionsScoreFactor.IS_READY_TO_PAY:\n        return this.isReadyToPay_ ? 1 : 0;\n      default:\n        return 0;\n    }\n  }\n\n  /**\n   * @param {!../../../src/service/viewer-interface.ViewerInterface} viewer\n   * @private\n   */\n  resolveGoogleViewer_(viewer) {\n    // This is a very light veiwer resolution since there's no real security\n    // implication - this only affects on-platform preferences.\n    const viewerUrl = viewer.getParam('viewerUrl');\n    if (viewerUrl) {\n      this.isGoogleViewer_ = GOOGLE_DOMAIN_RE.test(\n        parseUrlDeprecated(viewerUrl).hostname\n      );\n    } else {\n      // This can only be resolved asynchronously in this case. However, the\n      // action execution must be done synchronously. Thus we have to allow\n      // a minimal race condition here.\n      viewer.getViewerOrigin().then((origin) => {\n        if (origin) {\n          this.isGoogleViewer_ = GOOGLE_DOMAIN_RE.test(\n            parseUrlDeprecated(origin).hostname\n          );\n        }\n      });\n    }\n  }\n\n  /** @override */\n  getBaseScore() {\n    return this.serviceConfig_['baseScore'] || 0;\n  }\n\n  /** @override */\n  executeAction(action, sourceId) {\n    /**\n     * Note: we do handle events form the contribute and\n     * subscribe flows elsewhere since they are invoked after\n     * offer selection.\n     */\n    let mappedSku, carouselOptions;\n    /*\n     * If the id of the source element (sourceId) is in a map supplied via\n     * the skuMap Url we use that to lookup which sku to associate this button\n     * with.\n     */\n    const rtcPending = sourceId\n      ? this.ampdoc_\n          .getElementById(sourceId)\n          .hasAttribute('subscriptions-google-rtc')\n      : false;\n    // if subscriptions-google-rtc is set then this element is configured by the\n    // rtc url but has not yet been configured so we ignore it.\n    // Once the rtc resolves the attribute is changed to subscriptions-google-rtc-set.\n    if (rtcPending) {\n      return;\n    }\n    if (sourceId && this.skuMap_) {\n      mappedSku = getValueForExpr(this.skuMap_, `${sourceId}.sku`);\n      carouselOptions = getValueForExpr(\n        this.skuMap_,\n        `${sourceId}.carouselOptions`\n      );\n    }\n    if (action == Action.SUBSCRIBE) {\n      if (mappedSku) {\n        // publisher provided single sku\n        this.runtime_.subscribe(mappedSku);\n      } else if (carouselOptions) {\n        // publisher provided carousel options, must always be closable\n        carouselOptions.isClosable = true;\n        this.runtime_.showOffers(carouselOptions);\n      } else {\n        // no mapping just use the amp carousel\n        this.runtime_.showOffers({\n          list: 'amp',\n          isClosable: true,\n        });\n      }\n      return Promise.resolve(true);\n    }\n    // Same idea as above but it's contribute instead of subscribe\n    if (action == Action.CONTRIBUTE) {\n      if (mappedSku) {\n        // publisher provided single sku\n        this.runtime_.contribute(mappedSku);\n      } else if (carouselOptions) {\n        // publisher provided carousel options, must always be closable\n        carouselOptions.isClosable = true;\n        this.runtime_.showContributionOptions(carouselOptions);\n      } else {\n        // no mapping just use the amp carousel\n        this.runtime_.showContributionOptions({\n          list: 'amp',\n          isClosable: true,\n        });\n      }\n      return Promise.resolve(true);\n    }\n    if (action == Action.LOGIN) {\n      this.loginWithAmpReaderId_();\n      return Promise.resolve(true);\n    }\n    return Promise.resolve(false);\n  }\n\n  /** @override */\n  decorateUI(element, action, options) {\n    const opts = options ? options : {};\n\n    switch (action) {\n      case Action.SUBSCRIBE:\n        element.textContent = '';\n        this.runtime_.attachButton(element, options, () => {});\n        break;\n      case 'subscribe-smartbutton':\n      case 'subscribe-smartbutton-light':\n      case 'subscribe-smartbutton-dark':\n        element.textContent = '';\n        opts.theme = action === 'subscribe-smartbutton-dark' ? 'dark' : 'light';\n        opts.lang = userAssert(\n          element.getAttribute('subscriptions-lang'),\n          'subscribe-smartbutton must have a language attribute'\n        );\n        const messageTextColor = element.getAttribute(\n          'subscriptions-message-text-color'\n        );\n        if (messageTextColor) {\n          opts.messageTextColor = messageTextColor;\n        }\n        const messageNumber = element.getAttribute(\n          'subscriptions-message-number'\n        );\n        if (messageNumber) {\n          opts.messageNumber = messageNumber;\n        }\n        this.runtime_.attachSmartButton(element, opts, () => {});\n        break;\n      default:\n      // do nothing\n    }\n    // enable any real time buttons once it's resolved.\n    this.rtcPromise_.then(() => {\n      this.vsync_.mutate(() =>\n        Object.keys(/** @type {!Object} */ (this.skuMap_)).forEach(\n          (elementId) => {\n            const element = this.ampdoc_.getElementById(elementId);\n            if (element) {\n              devAssert(\n                element.hasAttribute('subscriptions-google-rtc'),\n                `Trying to set real time config on element '${elementId}' with missing 'subscriptions-google-rtc' attrbute`\n              );\n              element.setAttribute('subscriptions-google-rtc-set', '');\n              element.removeAttribute('subscriptions-google-rtc');\n            } else {\n              user().warn(\n                TAG,\n                `Element \"{elemendId}\" in real time config not found`\n              );\n            }\n          }\n        )\n      );\n    });\n  }\n}\n\n/**\n * Adopts fetcher protocol required for SwG to AMP fetching rules.\n * @implements {FetcherInterface}\n * @visibleForTesting\n */\nexport class AmpFetcher {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const @private {!../../../src/service/xhr-impl.Xhr} */\n    this.xhr_ = Services.xhrFor(win);\n\n    /** @private @const {!Window} */\n    this.win_ = win;\n  }\n\n  /** @override */\n  fetchCredentialedJson(url) {\n    return this.xhr_\n      .fetchJson(url, {\n        credentials: 'include',\n        prerenderSafe: true,\n      })\n      .then((response) => response.json());\n  }\n\n  /** @override */\n  fetch(input, opt_init) {\n    return this.xhr_.fetch(input, opt_init); //needed to kepp closure happy\n  }\n\n  /** @override */\n  sendPost(url, message) {\n    const init = {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',\n      },\n      credentials: 'include',\n      body:\n        'f.req=' +\n        JSON.stringify(/** @type {JsonObject} */ (message.toArray(false))),\n    };\n    return this.fetch(url, init).then(\n      (response) => (response && response.json()) || {}\n    );\n  }\n\n  /**\n   * POST data to a URL endpoint, do not wait for a response.\n   * @param {string} url\n   * @param {string|!Object} data\n   */\n  sendBeacon(url, data) {\n    const contentType = 'application/x-www-form-urlencoded;charset=UTF-8';\n    const body =\n      'f.req=' +\n      JSON.stringify(/** @type {JsonObject} */ (data.toArray(false)));\n    const sendBeacon = WindowInterface.getSendBeacon(this.win_);\n\n    if (sendBeacon) {\n      const blob = new Blob([body], {type: contentType});\n      sendBeacon(url, blob);\n      return;\n    }\n\n    // Only newer browsers support beacon.  Fallback to standard XHR POST.\n    const init = {\n      method: 'POST',\n      headers: {'Content-Type': contentType},\n      credentials: 'include',\n      body,\n    };\n    this.fetch(url, init);\n  }\n\n  /**\n   * Sends POST request, with a JSON payload, to a publisher URL.\n   * @param {string} url\n   * @param {!JsonObject} payload\n   * @return {!Promise<!JsonObject>}\n   */\n  sendPostToPublisher(url, payload) {\n    const init = {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      ampCors: true,\n      credentials: 'include',\n      body: JSON.stringify(payload),\n    };\n\n    const fetchPromise = this.fetch(url, init);\n    const responsePromise = fetchPromise.then(\n      (response) => (response && response.json()) || {}\n    );\n\n    return responsePromise;\n  }\n}\n\n// Register the extension services.\nAMP.extension(TAG, '0.1', function (AMP) {\n  AMP.registerServiceForDoc(\n    'subscriptions-google',\n    /**\n     * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampdoc\n     * @return {!GoogleSubscriptionsPlatformService}\n     */\n    function (ampdoc) {\n      const platformService = new GoogleSubscriptionsPlatformService(ampdoc);\n      const element = ampdoc.getHeadNode();\n      Services.subscriptionsServiceForDoc(element).then((service) => {\n        service.registerPlatform(\n          PLATFORM_KEY,\n          (platformConfig, serviceAdapter) => {\n            return platformService.createPlatform(\n              platformConfig,\n              serviceAdapter\n            );\n          }\n        );\n      });\n      return platformService;\n    }\n  );\n});\n"],
  "mappings": "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B,WAAK;;;;;;;ACrziBT,MAAM,eAAe;IACnB,0BAA0B;MACxB,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,SAAS;MACT,MAAM;MACN,SAAS;MACT,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,SAAS;MACT,SAAS;MACT,MAAM;MACN,MAAM;;IAER,gCAAgC;MAC9B,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,SACE;MACF,MAAM;MACN,SACE;MACF,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,SACE;MACF,SACE;MACF,MAAM;MACN,MAAM;;IAER,6CAA6C;MAC3C,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,SAAS;MACT,MAAM;MACN,SAAS;MACT,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,SAAS;MACT,SAAS;MACT,MAAM;MACN,MAAM;;IAER,0CAA0C;MACxC,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,SAAS;MACT,MAAM;MACN,SAAS;MACT,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,SAAS;MACT,SAAS;MACT,MAAM;MACN,MAAM;;IAER,yBAAyB;MACvB,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,SACE;MACF,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,MAAM;MACN,SACE;MACF,SACE;MACF,MAAM;MACN,MAAM;;;AAoBV,MAAM,kBAAiB;IACrB,SAAS;IACT,oBAAoB;IACpB,eAAe;IACf,mBAAmB;IACnB,6BAA6B;IAC7B,qBAAqB;IACrB,uBAAuB;IACvB,iCAAiC;IACjC,uDAAuD;IACvD,kCAAkC;IAClC,4BAA4B;IA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",
  "names": []
}
